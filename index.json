[{"authors":["admin"],"categories":null,"content":"My research focuses on machine learning applications applied to economics but in my spare time I generally enjoy playing around with different R packages and finding applications to finance and economics. I set up this blog as a way to highlight my research results, organise my code and publish it along with comments.\nNothing in life is to be feared, it is only to be understood. Now is the time to understand more, so that we may fear less. - Marie Skłodowska Curie\n","date":1582848000,"expirydate":-62135596800,"kind":"taxonomy","lang":"en","lastmod":1582848000,"objectID":"2525497d367e79493fd32b198b28f040","permalink":"/authors/admin/","publishdate":"0001-01-01T00:00:00Z","relpermalink":"/authors/admin/","section":"authors","summary":"My research focuses on machine learning applications applied to economics but in my spare time I generally enjoy playing around with different R packages and finding applications to finance and economics. I set up this blog as a way to highlight my research results, organise my code and publish it along with comments.\nNothing in life is to be feared, it is only to be understood. Now is the time to understand more, so that we may fear less.","tags":null,"title":"Matthew Smith","type":"authors"},{"authors":null,"categories":null,"content":" Flexibility The parts of the course are:\n Market Efficiency The Capital Asset Pricing Model (CAPM) Applications of the CAPM (CAPM in Practise)  Credits https://www.youtube.com/watch?v=Eu7qcQZdvKI\u0026amp;list=PLlIJjE1EmA8Y6egvj9yRgJbbxf_iEmPYv\u0026amp;index=1\nSome credits\nNotes Some notes\n","date":1536451200,"expirydate":-62135596800,"kind":"section","lang":"en","lastmod":1536451200,"objectID":"4e944a9f37dc310da83eb694acaeecc4","permalink":"/courses/portfolio_theory/","publishdate":"2018-09-09T00:00:00Z","relpermalink":"/courses/portfolio_theory/","section":"courses","summary":"A course on Portfolio Theory in R","tags":null,"title":"Overview","type":"docs"},{"authors":null,"categories":null,"content":"\rtrue\r\rIntroduction to efficient markets\rEach market participant participant has differing views on what data is telling them. The market is thus a weighted average of investor views. In efficient markets all relevant information is reflected in the current share price of a stock.\nFama (1970) suggested 3 types of market efficiency\n\rWeak form: In which the current market price reflects all information contained in past prices\rSemi-strong form: In which the current price reflects all publically avalable information\rStrong form: In which the current price relects all information, regardless of whether the information is public or not\r\r\rRandom Walk\rA random walk in the context of finance suggests that changes in stock prices have the same distribution and are independent of each other and thus past stock prices cannot be used to predict the future price or movement. That is, stock prices take a random and unpredictable path.\nLet \\(\\epsilon_{t+1}\\) be a sequence of independently and identically distributed (i.i.d) random variables with an expected value of 0. Then, \\(P_{t+1} = P_{t} + \\epsilon_{t+1}\\) is a random walk and \\(P_{t+1} = P_{t} + \\mu + \\epsilon_{t+1}\\) is a random walk with a drift component \\(\\mu \u0026gt; 0\\).\nMarket efficiency implies that prices reflect all current available information. As new information is made public then prices will adjust accordingly. We cannot predict this new information but we can take expectations such that, \\(E(P_{t+1}) = P_{t} + E(\\epsilon_{t+1})\\) where \\(\\epsilon_{t+1}\\) is expected news about a given stock. The \\(E(\\epsilon_{t+1}) = 0\\) so \\(E(P_{t+1}) = P_{t}\\) but investors should obtain some compensation for bearing risk which is reflected in \\(\\mu\\), therefore \\(E(P_{t+1}) = P_{t} + \\mu + E(\\epsilon_{t+1})\\) becomes \\(E(P_{t+1}) = P_{t} + \\mu\\) with \\(E(\\epsilon_{t+1})\\) = 0.\nThere are a few market phenomena that researchers and academics try to answer, the value premium and momentum premium.\n\rValue: Fama and Blume (1966) and Alexander (1961) studied that some strategies can make money when transaction costs are not accounted for. Empirical findings have found that value stocks (stocks with a high book-to-market ratio) outperform growth stocks (stocks with a low book-to-market ratio) Fama and French (1992). Tech stocks are usually growth stocks and have a low book value since much of their value is in interlectual property and not in industrial/manufacturing plants, thus they have a lower relative book value compared to their market value. Value stocks have a high book value relative to market value and would be manufacturing plants with large fixed assets pushing the book value up.\n\rMomentum: Past winners outperform past losers over a time period of 3 - 12 months Wermers (1997).\n\r\rBoth premiums imply that markets are inefficient. Not all stocks are correctly priced all the time. Some stocks are overpriced whilst other stocks are underpriced, however on average stocks are correctly priced.\nAlexander, Sidney S. 1961. “Price Movements in Speculative Markets: Trends or Random Walks.” Industrial Management Review (Pre-1986) 2 (2): 7.\n\rFama, Eugene F. 1970. “Efficient Capital Markets: A Review of Theory and Empirical Work.” The Journal of Finance 25 (2): 383–417.\n\rFama, Eugene F, and Marshall E Blume. 1966. “Filter Rules and Stock-Market Trading.” The Journal of Business 39 (1): 226–41.\n\rFama, Eugene F, and Kenneth R French. 1992. “The Cross-Section of Expected Stock Returns.” The Journal of Finance 47 (2): 427–65.\n\rWermers, Russ. 1997. “Momentum Investment Strategies of Mutual Funds, Performance Persistence, and Survivorship Bias.” Unpublished Working Paper, University of Colorado,[downloaded from Http://Bus. Colorado. Edu/Faculty/Wermers/.].\n\r\r\r","date":1557010800,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1557010800,"objectID":"09021c759360047473645402c493662a","permalink":"/courses/portfolio_theory/chap1/","publishdate":"2019-05-05T00:00:00+01:00","relpermalink":"/courses/portfolio_theory/chap1/","section":"courses","summary":"true\r\rIntroduction to efficient markets\rEach market participant participant has differing views on what data is telling them. The market is thus a weighted average of investor views. In efficient markets all relevant information is reflected in the current share price of a stock.\nFama (1970) suggested 3 types of market efficiency\n\rWeak form: In which the current market price reflects all information contained in past prices\rSemi-strong form: In which the current price reflects all publically avalable information\rStrong form: In which the current price relects all information, regardless of whether the information is public or not\r\r\rRandom Walk\rA random walk in the context of finance suggests that changes in stock prices have the same distribution and are independent of each other and thus past stock prices cannot be used to predict the future price or movement.","tags":null,"title":"Market Efficiency","type":"docs"},{"authors":[],"categories":null,"content":" Click on the Slides button above to view the built-in slides feature.   Slides can be added in a few ways:\n Create slides using Academic\u0026rsquo;s Slides feature and link using slides parameter in the front matter of the talk file Upload an existing slide deck to static/ and link using url_slides parameter in the front matter of the talk file Embed your slides (e.g. Google Slides) or presentation video on this page using shortcodes.  Further talk details can easily be added to this page using Markdown and $\\rm \\LaTeX$ math code.\n","date":1906549200,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1906549200,"objectID":"96344c08df50a1b693cc40432115cbe3","permalink":"/talk/example/","publishdate":"2017-01-01T00:00:00Z","relpermalink":"/talk/example/","section":"talk","summary":"An example talk using Academic's Markdown slides feature.","tags":[],"title":"Example Talk","type":"talk"},{"authors":["Matthew Smith"],"categories":["Machine Learning","Decision Boundary","Misc"],"content":"\r\rMachine Learning at the Boundary:\rThere is nothing new in the fact that machine learning models can outperform traditional econometric models but I want to show as part of my research why and how some models make given predictions or in this instance classifications.\nI wanted to show the decision boundary in which my binary classification model was making. That is, I wanted to show the partition space that splits my classification into each class. The problem and code can be split into a multi-classification problem with some tweeks.\nInitialisation:\rI first load in a series of packages and initialise a logistic function to convert log-odds to a logistic probability function later on.\nlibrary(dplyr)\rlibrary(patchwork)\rlibrary(ggplot2)\rlibrary(knitr)\rlibrary(kableExtra)\rlibrary(purrr)\rlibrary(stringr)\rlibrary(tidyr)\rlibrary(xgboost)\rlibrary(lightgbm)\rlibrary(keras)\rlibrary(tidyquant)\r##################### Pre-define some functions ###################################\r###################################################################################\rlogit2prob \u0026lt;- function(logit){\rodds \u0026lt;- exp(logit)\rprob \u0026lt;- odds / (1 + odds)\rreturn(prob)\r}\r\r\rThe data:\rI use the iris dataset which contains information on 3 different plant variables collected by British statistican Ronald Fisher in 1936. The dataset consists of \\(4\\) different characteristics of plant species which should uniquely distinguish the \\(3\\) different species (Setosa, Virginica and Versicolor). However, my problem required a binary classification problem and not a multi-classifciation problem. In the following code I import the iris data and remove a type of plant Species virginica to bring it from a multi-classification to a binary classification problem.\n###################################################################################\r###################################################################################\rdata(iris)\rdf \u0026lt;- iris %\u0026gt;% filter(Species != \u0026quot;virginica\u0026quot;) %\u0026gt;% mutate(Species = +(Species == \u0026quot;versicolor\u0026quot;))\rstr(df)\r## \u0026#39;data.frame\u0026#39;: 100 obs. of 5 variables:\r## $ Sepal.Length: num 5.1 4.9 4.7 4.6 5 5.4 4.6 5 4.4 4.9 ...\r## $ Sepal.Width : num 3.5 3 3.2 3.1 3.6 3.9 3.4 3.4 2.9 3.1 ...\r## $ Petal.Length: num 1.4 1.4 1.3 1.5 1.4 1.7 1.4 1.5 1.4 1.5 ...\r## $ Petal.Width : num 0.2 0.2 0.2 0.2 0.2 0.4 0.3 0.2 0.2 0.1 ...\r## $ Species : int 0 0 0 0 0 0 0 0 0 0 ...\r###################################################################################\r###################################################################################\rI plot the data by first storing the ggplot objects changing only the x and y variables in each of the plt’s.\nplt1 \u0026lt;- df %\u0026gt;% ggplot(aes(x = Sepal.Width, y = Sepal.Length, color = factor(Species))) +\rgeom_point(size = 4) +\rtheme_bw(base_size = 15) +\rtheme(legend.position = \u0026quot;none\u0026quot;)\rplt2 \u0026lt;- df %\u0026gt;% ggplot(aes(x = Petal.Length, y = Sepal.Length, color = factor(Species))) +\rgeom_point(size = 4) +\rtheme_bw(base_size = 15) +\rtheme(legend.position = \u0026quot;none\u0026quot;)\rplt3 \u0026lt;- df %\u0026gt;% ggplot(aes(x = Petal.Width, y = Sepal.Length, color = factor(Species))) +\rgeom_point(size = 4) +\rtheme_bw(base_size = 15) +\rtheme(legend.position = \u0026quot;none\u0026quot;)\rplt3 \u0026lt;- df %\u0026gt;% ggplot(aes(x = Sepal.Length, y = Sepal.Width, color = factor(Species))) +\rgeom_point(size = 4) +\rtheme_bw(base_size = 15) +\rtheme(legend.position = \u0026quot;none\u0026quot;)\rplt4 \u0026lt;- df %\u0026gt;% ggplot(aes(x = Petal.Length, y = Sepal.Width, color = factor(Species))) +\rgeom_point(size = 4) +\rtheme_bw(base_size = 15) +\rtheme(legend.position = \u0026quot;none\u0026quot;)\rplt5 \u0026lt;- df %\u0026gt;% ggplot(aes(x = Petal.Width, y = Sepal.Width, color = factor(Species))) +\rgeom_point(size = 4) +\rtheme_bw(base_size = 15) +\rtheme(legend.position = \u0026quot;none\u0026quot;)\rplt6 \u0026lt;- df %\u0026gt;% ggplot(aes(x = Petal.Width, y = Sepal.Length, color = factor(Species))) +\rgeom_point(size = 4) +\rtheme_bw(base_size = 15) +\rtheme(legend.position = \u0026quot;none\u0026quot;)\rI also wanted to use the new patchwork package which makes displaying ggplot plots very easy. i.e the below code plots our graphics as its written (1 top plot stretching the length of the grid space, 2 middle plots, another single plot and a further 2 more plots at the bottom.)\n (plt1) /\r(plt2 + plt3)\rAlternatively, we can re-arrange the plots into any way we wish and plot them in the following way:\n (plt1 + plt2) / (plt5 + plt6)\rWhich I think looks awesome.\nObjective\rThe objective is to build a classification algorithm to distinguish between the two classes and then compute the decision boundaries in order to better see how the models made such predictions.\nIn order to create the decision boundary plots for each variable combination we need the different combinatons of variables in the data.\n###################################################################################\r###################################################################################\rvar_combos \u0026lt;- expand.grid(colnames(df[,1:4]), colnames(df[,1:4])) %\u0026gt;% filter(!Var1 == Var2)\r###################################################################################\r###################################################################################\rvar_combos %\u0026gt;% head() %\u0026gt;% kable(caption = \u0026quot;Variable Combinations\u0026quot;, escape = F, align = \u0026quot;c\u0026quot;, digits = 2) %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;), font_size = 9, fixed_thead = T, full_width = F) %\u0026gt;% scroll_box(width = \u0026quot;100%\u0026quot;, height = \u0026quot;200px\u0026quot;)\rTable 1: Variable Combinations\r\r\r\rVar1\r\rVar2\r\r\r\r\r\rSepal.Width\r\rSepal.Length\r\r\r\rPetal.Length\r\rSepal.Length\r\r\r\rPetal.Width\r\rSepal.Length\r\r\r\rSepal.Length\r\rSepal.Width\r\r\r\rPetal.Length\r\rSepal.Width\r\r\r\rPetal.Width\r\rSepal.Width\r\r\r\r\r\rNext, I want to use the different variable combinations previously and create lists (one for each variable combination) and populate these lists with synthetic data - or data from the minimum to maximum value of each variable combination. This will act as our synthetically created test data in which we make predictions on and build the decision boundary.\nIt’s important to note that the plots will eventually be 2 dimensional for illustrative purposes, therefore we only train the Machine Learning models on two variables, but for each combination of the two variables, these variables are the first two variables in the boundary_lists data frames.\nboundary_lists \u0026lt;- map2(\r.x = var_combos$Var1,\r.y = var_combos$Var2,\r~select(df, .x, .y) %\u0026gt;% summarise(\rminX = min(.[[1]], na.rm = TRUE),\rmaxX = max(.[[1]], na.rm = TRUE),\rminY = min(.[[2]], na.rm = TRUE),\rmaxY = max(.[[2]], na.rm = TRUE)\r)\r) %\u0026gt;% map(.,\r~tibble(\rx = seq(.x$minX, .x$maxX, length.out = 200),\ry = seq(.x$minY, .x$maxY, length.out = 200),\r)\r) %\u0026gt;% map(.,\r~tibble(\rxx = rep(.x$x, each = 200),\ryy = rep(.x$y, time = 200)\r)\r) %\u0026gt;% map2(.,\rasplit(var_combos, 1), ~ .x %\u0026gt;% set_names(.y))\r###################################################################################\r###################################################################################\rWe can see how the first 4 observations of the first and last two lists look like:\nboundary_lists %\u0026gt;% map(., ~head(., 4)) %\u0026gt;% head(2)\r## [[1]]\r## # A tibble: 4 x 2\r## Sepal.Width Sepal.Length\r## \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\r## 1 2 4.3 ## 2 2 4.31\r## 3 2 4.33\r## 4 2 4.34\r## ## [[2]]\r## # A tibble: 4 x 2\r## Petal.Length Sepal.Length\r## \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\r## 1 1 4.3 ## 2 1 4.31\r## 3 1 4.33\r## 4 1 4.34\rboundary_lists %\u0026gt;% map(., ~head(., 4)) %\u0026gt;% tail(2)\r## [[1]]\r## # A tibble: 4 x 2\r## Sepal.Width Petal.Width\r## \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\r## 1 2 0.1 ## 2 2 0.109\r## 3 2 0.117\r## 4 2 0.126\r## ## [[2]]\r## # A tibble: 4 x 2\r## Petal.Length Petal.Width\r## \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\r## 1 1 0.1 ## 2 1 0.109\r## 3 1 0.117\r## 4 1 0.126\r\rTraining time:\rNow that we have the synthetically created testing data set up, I want to train the models on the actual observed observations. I use each data point in the plots above as my training data. I apply the following models:\n\rLogistic Model\rSupport Vector Machine with a linear kernel\rSupport Vector Machine with a polynomial kernel\rSupport Vector Machine with a radial kernel\rSupport Vector Machine with a sigmoid kernel\rRandom Forest\rExtreme Gradiant Boosting (XGBoost) model with default parameters\rSingle layer Keras Neural Network (with linear components)\rDeeper layer Keras Neural Network (with linear components)\rDeeper’er layer Keras Neural Network (with linear components)\rLight Gradient Boosting model (LightGBM) with default parameters\r\rSide note: I am not an expert in Deep learning/Keras/Tensorflow, so I am sure better models will yield better decision boundaries but it was a fun task getting the different Machine Learning models to fit inside a purrr, map call.\n###################################################################################\r###################################################################################\r# params_lightGBM \u0026lt;- list(\r# objective = \u0026quot;binary\u0026quot;,\r# metric = \u0026quot;auc\u0026quot;,\r# min_data = 1\r# )\r# To install Light GBM try the following in your RStudio terinal\r# git clone --recursive https://github.com/microsoft/LightGBM\r# cd LightGBM\r# Rscript build_r.R\rmodels_list \u0026lt;- var_combos %\u0026gt;%\rmutate(modeln = str_c(\u0026#39;mod\u0026#39;, row_number())) %\u0026gt;%\rpmap(~ {\rxname = ..1\ryname = ..2\rmodelname = ..3\rdf %\u0026gt;%\rselect(Species, xname, yname) %\u0026gt;%\rgroup_by(grp = \u0026#39;grp\u0026#39;) %\u0026gt;%\rnest() %\u0026gt;%\rmutate(models = map(data, ~{\rlist(\r# Logistic Model\rModel_GLM = {\rglm(Species ~ ., data = .x, family = binomial(link=\u0026#39;logit\u0026#39;))\r},\r# Support Vector Machine (linear)\rModel_SVM_Linear = {\re1071::svm(Species ~ ., data = .x, type = \u0026#39;C-classification\u0026#39;, kernel = \u0026#39;linear\u0026#39;)\r},\r# Support Vector Machine (polynomial)\rModel_SVM_Polynomial = {\re1071::svm(Species ~ ., data = .x, type = \u0026#39;C-classification\u0026#39;, kernel = \u0026#39;polynomial\u0026#39;)\r},\r# Support Vector Machine (sigmoid)\rModel_SVM_radial = {\re1071::svm(Species ~ ., data = .x, type = \u0026#39;C-classification\u0026#39;, kernel = \u0026#39;sigmoid\u0026#39;)\r},\r# Support Vector Machine (radial)\rModel_SVM_radial_Sigmoid = {\re1071::svm(Species ~ ., data = .x, type = \u0026#39;C-classification\u0026#39;, kernel = \u0026#39;radial\u0026#39;)\r},\r# Random Forest\rModel_RF = {\rrandomForest::randomForest(formula = as.factor(Species) ~ ., data = .)\r},\r# Extreme Gradient Boosting\rModel_XGB = {\rxgboost(\robjective = \u0026#39;binary:logistic\u0026#39;,\reval_metric = \u0026#39;auc\u0026#39;,\rdata = as.matrix(.x[, 2:3]),\rlabel = as.matrix(.x$Species), # binary variable\rnrounds = 10)\r},\r# Kera Neural Network\rModel_Keras = {\rmod \u0026lt;- keras_model_sequential() %\u0026gt;% layer_dense(units = 2, activation = \u0026#39;relu\u0026#39;, input_shape = 2) %\u0026gt;% layer_dense(units = 2, activation = \u0026#39;sigmoid\u0026#39;)\rmod %\u0026gt;% compile(\rloss = \u0026#39;binary_crossentropy\u0026#39;,\roptimizer_sgd(lr = 0.01, momentum = 0.9),\rmetrics = c(\u0026#39;accuracy\u0026#39;)\r)\rfit(mod, x = as.matrix(.x[, 2:3]),\ry = to_categorical(.x$Species, 2),\repochs = 5,\rbatch_size = 5,\rvalidation_split = 0\r)\rprint(modelname) assign(modelname, mod) },\r# Kera Neural Network\rModel_Keras_2 = {\rmod \u0026lt;- keras_model_sequential() %\u0026gt;% layer_dense(units = 2, activation = \u0026#39;relu\u0026#39;, input_shape = 2) %\u0026gt;%\rlayer_dense(units = 2, activation = \u0026#39;linear\u0026#39;, input_shape = 2) %\u0026gt;%\rlayer_dense(units = 2, activation = \u0026#39;sigmoid\u0026#39;)\rmod %\u0026gt;% compile(\rloss = \u0026#39;binary_crossentropy\u0026#39;,\roptimizer_sgd(lr = 0.01, momentum = 0.9),\rmetrics = c(\u0026#39;accuracy\u0026#39;)\r)\rfit(mod, x = as.matrix(.x[, 2:3]),\ry = to_categorical(.x$Species, 2),\repochs = 5,\rbatch_size = 5,\rvalidation_split = 0\r)\rprint(modelname) assign(modelname, mod) },\r# Kera Neural Network Model_Keras_3 = {\rmod \u0026lt;- keras_model_sequential() %\u0026gt;% layer_dense(units = 2, activation = \u0026#39;relu\u0026#39;, input_shape = 2) %\u0026gt;% layer_dense(units = 2, activation = \u0026#39;relu\u0026#39;, input_shape = 2) %\u0026gt;%\rlayer_dense(units = 2, activation = \u0026#39;linear\u0026#39;, input_shape = 2) %\u0026gt;%\rlayer_dense(units = 2, activation = \u0026#39;sigmoid\u0026#39;)\rmod %\u0026gt;% compile(\rloss = \u0026#39;binary_crossentropy\u0026#39;,\roptimizer_sgd(lr = 0.01, momentum = 0.9),\rmetrics = c(\u0026#39;accuracy\u0026#39;)\r)\rfit(mod, x = as.matrix(.x[, 2:3]),\ry = to_categorical(.x$Species, 2),\repochs = 5,\rbatch_size = 5,\rvalidation_split = 0\r)\rprint(modelname) assign(modelname, mod) },\r# LightGBM model\rModel_LightGBM = {\rlgb.train(\rdata = lgb.Dataset(data = as.matrix(.x[, 2:3]), label = .x$Species),\robjective = \u0026#39;binary\u0026#39;,\rmetric = \u0026#39;auc\u0026#39;,\rmin_data = 1\r#params = params_lightGBM,\r#learning_rate = 0.1\r)\r}\r) } )) }) %\u0026gt;% map(\r., ~unlist(., recursive = FALSE)\r)\r\rTesting time:\rNow that the models have been trained, we can begin makign the predictions on the synthetically created data we created in the boundary_lists data.\nmodels_predict \u0026lt;- map2(models_list, boundary_lists, ~{\rmods \u0026lt;- purrr::pluck(.x, \u0026quot;models\u0026quot;)\rdat \u0026lt;- .y\rmap(mods, function(x)\rtryCatch({\rif(attr(x, \u0026quot;class\u0026quot;)[1] == \u0026quot;glm\u0026quot;){ # predict the logistic model\rtibble(\rmodelname = attr(x, \u0026quot;class\u0026quot;)[1],\rprediction = predict(x, newdata = dat)\r) %\u0026gt;% mutate(\rprediction = logit2prob(prediction),\rprediction = case_when(\rprediction \u0026gt; 0.5 ~ 1,\rTRUE ~ 0\r)\r)\r} else if(attr(x, \u0026quot;class\u0026quot;)[1] == \u0026quot;svm.formula\u0026quot;){ # predict the SVM model\rtibble(\rmodelname = attr(x, \u0026quot;class\u0026quot;)[1],\rprediction = as.numeric(as.character(predict(x, newdata = dat)))\r)\r}\relse if(attr(x, \u0026quot;class\u0026quot;)[1] == \u0026quot;randomForest.formula\u0026quot;){ # predict the RF model\rtibble(\rmodelname = attr(x, \u0026quot;class\u0026quot;)[1],\rprediction = as.numeric(as.character(predict(x, newdata = dat)))\r)\r} else if(attr(x, \u0026quot;class\u0026quot;)[1] == \u0026quot;xgb.Booster\u0026quot;){ # predict the XGBoost model\rtibble(\rmodelname = attr(x, \u0026quot;class\u0026quot;)[1], prediction = predict(x, newdata = as.matrix(dat), type = \u0026#39;prob\u0026#39;)\r) %\u0026gt;% mutate(\rprediction = case_when(\rprediction \u0026gt; 0.5 ~ 1,\rTRUE ~ 0\r)\r)\r}\relse if(attr(x, \u0026quot;class\u0026quot;)[1] == \u0026quot;keras.engine.sequential.Sequential\u0026quot;){\r# Keras Single Layer Neural Network\rtibble(\rmodelname = attr(x, \u0026quot;class\u0026quot;)[1],\rprediction = predict_classes(object = x, x = as.matrix(dat))\r)\r}\relse if(attr(x, \u0026quot;class\u0026quot;)[2] == \u0026quot;keras.engine.training.Model\u0026quot;){\r# NOTE:::: This is a very crude hack to have multiple keras NN models\r# Needs fixing such that the models are named better - (not like) - (..., \u0026quot;class\u0026quot;)[2], ..., \u0026quot;class\u0026quot;)[3]... and so on. # Keras Single Layer Neural Network\rtibble(\rmodelname = attr(x, \u0026quot;class\u0026quot;)[2], # needs changing also.\rprediction = predict_classes(object = x, x = as.matrix(dat))\r)\r}\relse if(attr(x, \u0026quot;class\u0026quot;)[1] == \u0026quot;lgb.Booster\u0026quot;){\r# Light GBM model\rtibble(\rmodelname = attr(x, \u0026quot;class\u0026quot;)[1],\rprediction = predict(object = x, data = as.matrix(dat), rawscore = FALSE)\r) %\u0026gt;% mutate(\rprediction = case_when(\rprediction \u0026gt; 0.5 ~ 1,\rTRUE ~ 0\r)\r)\r}\r}, error = function(e){\rprint(\u0026#39;skipping\\n\u0026#39;)\r}\r)\r)\r}\r) %\u0026gt;% map(.,\r~setNames(.,\rmap(.,\r~c(.x$modelname[1]\r)\r)\r)\r) %\u0026gt;%\rmap(.,\r~map(.,\r~setNames(.,\rc(\rpaste0(.x$modelname[1], \u0026quot;_Model\u0026quot;),\rpaste0(.x$modelname[1], \u0026quot;_Prediction\u0026quot;)\r)\r)\r)\r)\r\rCalibrating the data\rNow we have our trained models, along with predictions we can map these predictions into data which we can plot using ggplot and then arrange using patchwork!.\nplot_data \u0026lt;- map2(\r.x = boundary_lists,\r.y = map(\rmodels_predict,\r~map(.,\r~tibble(.)\r)\r),\r~bind_cols(.x, .y)\r)\rnames(plot_data) \u0026lt;- map_chr(\rplot_data, ~c(\rpaste(\rcolnames(.)[1],\r\u0026quot;and\u0026quot;,\rcolnames(.)[2],\rsep = \u0026quot;_\u0026quot;)\r)\r)\rNow that we have our predictions we can create the ggplots.\nggplot_lists \u0026lt;- plot_data %\u0026gt;%\rmap(\r.,\r~select(\r.,\r-contains(\u0026quot;Model\u0026quot;)\r) %\u0026gt;%\rpivot_longer(cols = contains(\u0026quot;Prediction\u0026quot;), names_to = \u0026quot;Model\u0026quot;, values_to = \u0026quot;Prediction\u0026quot;)\r) %\u0026gt;%\rmap(\r.x = .,\r~ggplot() +\rgeom_point(aes(\rx = !!rlang::sym(colnames(.x)[1]),\ry = !!rlang::sym(colnames(.x)[2]),\rcolor = factor(!!rlang::sym(colnames(.x)[4]))\r), data = .x) +\rgeom_contour(aes(\rx = !!rlang::sym(colnames(.x)[1]),\ry = !!rlang::sym(colnames(.x)[2]),\rz = !!rlang::sym(colnames(.x)[4])\r), data = .x) +\rgeom_point(aes(\rx = !!rlang::sym(colnames(.x)[1]),\ry = !!rlang::sym(colnames(.x)[2]),\rcolor = factor(!!rlang::sym(colnames(df)[5])) # this is the status variable\r), size = 8, data = df) +\rgeom_point(aes(\rx = !!rlang::sym(colnames(.x)[1]),\ry = !!rlang::sym(colnames(.x)[2])\r), size = 8, shape = 1, data = df) +\rfacet_wrap(~Model) +\rtheme_bw(base_size = 25) +\rtheme(legend.position = \u0026quot;none\u0026quot;)\r)\rPlot all the different combinations of the decision boundaries. Note: The above code will work better in your console, when I ran the code to compile the blog post the plots were too small. Therefore, I provide individual plots for a sample of the models \u0026amp; variable combinations.\nI first needed to select the first two columns which are the variables of interest (Petal.Width, Petal.Length, Sepal.Width and Sepal.Length). Then I wanted to take a random sample of the columns thereafter (which are the different Machine Learning Model predictions).\nplot_data_sampled \u0026lt;- plot_data %\u0026gt;% map(\r.,\r~select(\r.,\r-contains(\u0026quot;Model\u0026quot;)\r) %\u0026gt;% select(.,\rc(1:2), sample(colnames(.), 2)\r) %\u0026gt;% pivot_longer(\rcols = contains(\u0026quot;Prediction\u0026quot;),\rnames_to = \u0026quot;Model\u0026quot;,\rvalues_to = \u0026quot;Prediction\u0026quot;)\r) \rNext I can make the plots by taking a random sample of the lists.\nplot_data_sampled %\u0026gt;% rlist::list.sample(1) %\u0026gt;% map(\r.x = .,\r~ggplot() +\rgeom_point(aes(\rx = !!rlang::sym(colnames(.x)[1]),\ry = !!rlang::sym(colnames(.x)[2]),\rcolor = factor(!!rlang::sym(colnames(.x)[4]))\r), data = .x) + geom_contour(aes(\rx = !!rlang::sym(colnames(.x)[1]),\ry = !!rlang::sym(colnames(.x)[2]),\rz = !!rlang::sym(colnames(.x)[4])\r), data = .x) +\rgeom_point(aes(\rx = !!rlang::sym(colnames(.x)[1]),\ry = !!rlang::sym(colnames(.x)[2]),\rcolor = factor(!!rlang::sym(colnames(df)[5])) # this is the status variable\r), size = 3, data = df) +\rgeom_point(aes(\rx = !!rlang::sym(colnames(.x)[1]),\ry = !!rlang::sym(colnames(.x)[2])\r), size = 3, shape = 1, data = df) +\rfacet_wrap(~Model) +\r#coord_flip() +\rtheme_tq(base_family = \u0026quot;serif\u0026quot;) +\rtheme(\r#aspect.ratio = 1,\raxis.line.y = element_blank(),\raxis.ticks.y = element_blank(),\rlegend.position = \u0026quot;bottom\u0026quot;,\r#legend.title = element_text(size = 20),\r#legend.text = element_text(size = 10),\raxis.title = element_text(size = 20),\raxis.text = element_text(size = \u0026quot;15\u0026quot;),\rstrip.text.x = element_text(size = 15),\rplot.title = element_text(size = 30, hjust = 0.5),\rstrip.background = element_rect(fill = \u0026#39;darkred\u0026#39;),\rpanel.background = element_blank(),\rpanel.grid.major = element_blank(),\rpanel.grid.minor = element_blank(),\r#axis.text.x = element_text(angle = 90),\raxis.text.y = element_text(angle = 90, hjust = 0.5),\r#axis.title.x = element_blank()\rlegend.title = element_blank(),\rlegend.text = element_text(size = 20)\r)\r)\r## $Sepal.Width_and_Petal.Length\r## Warning: Row indexes must be between 0 and the number of rows (0). Use `NA` as row index to obtain a row full of `NA` values.\r## This warning is displayed once per session.\rSome other random models:\n## $Sepal.Width_and_Sepal.Length\r## $Sepal.Width_and_Sepal.Length\r## $Petal.Length_and_Sepal.Length\r## $Petal.Width_and_Petal.Length\r## $Petal.Length_and_Petal.Width\r## Warning in grDevices::contourLines(x = sort(unique(data$x)), y =\r## sort(unique(data$y)), : todos los valores de z son iguales\r## Warning: Not possible to generate contour data\rNatually the linear models made a linear decision boundary. It looks like the random forest model overfit a little the data, where as the XGBoost and LightGBM models were able to make better, more generalisable decision boundaries. The Keras Neural Networks performed poorly because they should be trained better.\n\rglm = Logistic Model\rkeras.engine.sequential.Sequential Prediction...18 = Single layer Neural Network\rkeras.engine.sequential.Sequential Prediction...18 = Deeper layer Neural Network\rkeras.engine.sequential.Sequential Prediction...22 = Deeper’er layer Neural Network\rlgb.Booster Prediction = Light Gradient Boosted Model\rrandomForest.formula Prediction = Random Forest Model\rsvm.formula Prediction...10 = Support Vector Machine with a Sigmoid Kernel\rsvm.formula Prediction...12 = Support Vector Machine with a Radial Kernel\rsvm.formula Prediction...6 = Support Vector Machine with a Linear Kernel\rsvm.formula Prediction...8 = Support Vector Machine with a Polynomial Kernel\rxgb.Booster Prediction = Extreme Gradient Boosting Model\r\rIn many of the combinations the Keras Neural Network model just predicted all observations to be of a specific class (again by my poor tuning of the models and the fact that the Neural Networks only had 100 observations to learn from and 40,000 observation to predict on). That is, it coloured the whole background blue or red and made many mis-classifications. In some of the plots the Neural Networks managed to mae perfect classifications, in other it made strange decision boundaries. - Neural Networks are fun.\nAs some brief analysis of the plots, it looks like the simple logistic model made near-perfect classifications. Which isn’t suprising given that each of the variable ralationships are linearly seperable. However, I have a preferece for XGBoost and LightGBM models since they can handle non-linear relationships through the incorporation of regularisation in its objective functions which allows them to make more robust decision boundaries. Random Forest models fail here which is why their decision boundary appears to do a good job but is also slightly erratic and sharpe in it’s decision boundaries.\nOf course it goes without saying that these decision boundaries can become significantly more complex and non-linear with the inclusion of more variables and higher dimensions.\nfor(i in 1:length(plot_data)){\rprint(ggplot_lists[[i]])\r}\r\rEnd note:\rI wrote this model on an Amazon Ubuntu EC2 Instance however, when I went to compile the blog post in R on my Windows system I ran into some problems. These problems were mostly down to installing the lightgbm package and package versions. The code was working without error using the following package versions (i.e. using the most up-to-date package versions)\nsessionInfo()\r## R version 3.6.1 (2019-07-05)\r## Platform: x86_64-w64-mingw32/x64 (64-bit)\r## Running under: Windows 10 x64 (build 17763)\r## ## Matrix products: default\r## ## locale:\r## [1] LC_COLLATE=Spanish_Spain.1252 LC_CTYPE=Spanish_Spain.1252 ## [3] LC_MONETARY=Spanish_Spain.1252 LC_NUMERIC=C ## [5] LC_TIME=Spanish_Spain.1252 ## ## attached base packages:\r## [1] stats graphics grDevices utils datasets methods base ## ## other attached packages:\r## [1] tidyquant_0.5.7 quantmod_0.4-15 ## [3] TTR_0.23-6 PerformanceAnalytics_1.5.3\r## [5] xts_0.11-2 zoo_1.8-6 ## [7] lubridate_1.7.4 keras_2.2.5.0 ## [9] lightgbm_2.3.2 R6_2.4.1 ## [11] xgboost_0.90.0.1 tidyr_1.0.0 ## [13] stringr_1.4.0 purrr_0.3.2 ## [15] kableExtra_1.1.0.9000 knitr_1.25.4 ## [17] ggplot2_3.2.1 patchwork_1.0.0 ## [19] dplyr_0.8.99.9000 ## ## loaded via a namespace (and not attached):\r## [1] Rcpp_1.0.3 lattice_0.20-38 class_7.3-15 ## [4] utf8_1.1.4 assertthat_0.2.1 zeallot_0.1.0 ## [7] digest_0.6.24 e1071_1.7-2 evaluate_0.14 ## [10] httr_1.4.1 blogdown_0.15 pillar_1.4.3.9000 ## [13] tfruns_1.4 rlang_0.4.4 lazyeval_0.2.2 ## [16] curl_4.0 rstudioapi_0.10 data.table_1.12.8 ## [19] whisker_0.3-2 Matrix_1.2-17 reticulate_1.14-9001\r## [22] rmarkdown_1.14 lobstr_1.1.1 labeling_0.3 ## [25] webshot_0.5.1 readr_1.3.1 munsell_0.5.0 ## [28] compiler_3.6.1 xfun_0.8 pkgconfig_2.0.3 ## [31] base64enc_0.1-3 tensorflow_2.0.0 htmltools_0.3.6 ## [34] tidyselect_1.0.0 tibble_2.99.99.9014 bookdown_0.13 ## [37] quadprog_1.5-7 randomForest_4.6-14 fansi_0.4.1 ## [40] viridisLite_0.3.0 crayon_1.3.4 withr_2.1.2 ## [43] rappdirs_0.3.1 grid_3.6.1 Quandl_2.10.0 ## [46] jsonlite_1.6.1 gtable_0.3.0 lifecycle_0.1.0 ## [49] magrittr_1.5 scales_1.0.0 rlist_0.4.6.1 ## [52] cli_2.0.1 stringi_1.4.3 xml2_1.2.2 ## [55] ellipsis_0.3.0 generics_0.0.2 vctrs_0.2.99.9005 ## [58] tools_3.6.1 glue_1.3.1 hms_0.5.1 ## [61] yaml_2.2.0 colorspace_1.4-1 rvest_0.3.4\r\r\r","date":1582848000,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1582848000,"objectID":"2b3eb72899172ebe41d3a4f617b213bd","permalink":"/post/machine-learning-boundary-conditions/machine-learning-boundary-conditions/","publishdate":"2020-02-28T00:00:00Z","relpermalink":"/post/machine-learning-boundary-conditions/machine-learning-boundary-conditions/","section":"post","summary":"I train a series of Machine Learning models using the iris dataset, construct synthetic data from the extreme points within the data and test a number of Machine Learning models in order to draw the decision boundaries from which the models make predictions in a 2D space, which is useful for illustrative purposes and understanding on how different Machine Learning models make predictions.","tags":["Machine Learning","iris","Misc","xgboost"],"title":"Decision Boundary for a Series of Machine Learning Models","type":"post"},{"authors":["Matthew Smith"],"categories":["Quantitative Finance","Machine Learning","Time Series","Algo Trading"],"content":"\r\rIntroduction\rUsing Machine Learning (ML) and past price data to predict the next periods price or direction in the stock market is not new, neither does it produce any meaningful predictions. In this post I collapse down a series of asset time series data into a simple classification problem and see if a Machine Learning model can do a better job at predicting the next periods direction. I apply a similar method here Time Series Classification Synthetic vs Real Financial Time Series. The objective and strategy is to invest in a single asset each day. The asset we invest in will be the asset which the Machine Learning model is most confident will go up in share value in the next period \\(t+1\\). Alternatively speaking, we invest in the asset in which the Machine Learning model gives the highest predicted probability that, a given asset will go up in value tomorrow. That is, if the model predicts on day \\(t\\) that asset GOOG was going to be higher than it’s previous close with a predicted probability of 0.78 and it also predicts that AMZN would go up with 0.53 probability then we would invest in GOOG today. -we only invest in one asset each day- . The model can be expanded to short selling and multi-asset purchasing and multi-periods.\nLoad in the packages.\rrequire(PerformanceAnalytics)\rlibrary(data.table)\rlibrary(dplyr)\rlibrary(tibble)\rlibrary(TTR)\rlibrary(tidyr)\rlibrary(tidyquant)\rlibrary(tsfeatures)\rlibrary(rsample)\rlibrary(purrr)\rlibrary(stringr)\rlibrary(tibbletime) # tsibble clashes with the base R index() function\rlibrary(xgboost)\rlibrary(rvest)\rPre-define a few intialisation objects and set the ticker symbols of the companies we want to download. For this task I am not really interested in which companies I apply the strategy to. For this reason, I scrape the Wikipedia page for the S\u0026amp;P 500 and take a random sample of 30 tickers.\nset.seed(1234)\r###################### Pre-define functions for later ##########################\rScale_Me \u0026lt;- function(x){\r(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)\r} # Note: I don\u0026#39;t actually use this function but I leave it in here.\r#################################################################################\rstart_date \u0026lt;- \u0026quot;2017-01-01\u0026quot;\rend_date \u0026lt;- \u0026quot;2020-01-01\u0026quot;\rurl \u0026lt;- \u0026quot;https://en.wikipedia.org/wiki/List_of_S%26P_500_companies\u0026quot;\rsymbols \u0026lt;- url %\u0026gt;%\rread_html() %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;constituents\u0026quot;]\u0026#39;) %\u0026gt;% html_table() %\u0026gt;% .[[1]] %\u0026gt;% filter(!str_detect(Security, \u0026quot;Class A|Class B|Class C\u0026quot;)) %\u0026gt;% # Removes firms with Class A, B \u0026amp; C shares\rsample_n(30) %\u0026gt;% pull(Symbol)\r#symbols \u0026lt;- c(\r#\u0026#39;GOOG\u0026#39;, \u0026#39;MSFT\u0026#39;, \u0026#39;HOG\u0026#39;, \u0026#39;AAPL\u0026#39;, \u0026#39;FB\u0026#39; #\u0026#39;AMZN\u0026#39;, \u0026#39;EBAY\u0026#39;, \u0026#39;IBM\u0026#39;, \u0026#39;NFLX\u0026#39;, \u0026#39;NVDA\u0026#39;,\r#\u0026#39;TWTR\u0026#39;, \u0026#39;WMT\u0026#39;, \u0026#39;XRX\u0026#39;, \u0026#39;INTC\u0026#39;, \u0026#39;HPE\u0026#39;\r# )\r\rThe data\rDownload the data and store it into a new environment.\ndataEnv \u0026lt;- new.env()\rgetSymbols(symbols, from = start_date, to = end_date, #src = \u0026quot;yahoo\u0026quot;, #adjust = TRUE, env = dataEnv)\r## [1] \u0026quot;LEG\u0026quot; \u0026quot;NLSN\u0026quot; \u0026quot;SLB\u0026quot; \u0026quot;CHTR\u0026quot; \u0026quot;C\u0026quot; \u0026quot;REGN\u0026quot; \u0026quot;CCI\u0026quot; \u0026quot;SYK\u0026quot; \u0026quot;ROP\u0026quot; \u0026quot;RL\u0026quot; ## [11] \u0026quot;CERN\u0026quot; \u0026quot;CMG\u0026quot; \u0026quot;GS\u0026quot; \u0026quot;CAT\u0026quot; \u0026quot;MSI\u0026quot; \u0026quot;BR\u0026quot; \u0026quot;VRSK\u0026quot; \u0026quot;PNC\u0026quot; \u0026quot;KEYS\u0026quot; \u0026quot;PHM\u0026quot; ## [21] \u0026quot;FB\u0026quot; \u0026quot;BKR\u0026quot; \u0026quot;ABMD\u0026quot; \u0026quot;WYNN\u0026quot; \u0026quot;DG\u0026quot; \u0026quot;ADI\u0026quot; \u0026quot;GL\u0026quot; \u0026quot;TSCO\u0026quot; \u0026quot;FLS\u0026quot; \u0026quot;CDW\u0026quot;\rOnce the data has been downloaded and stored into a new environment I clean the data up a little, put all the lists into a single data frame, compute the daily returns for each asset and create the up or down direction which will be what the classification model will try to predict.\ndf \u0026lt;- eapply(dataEnv, function(x){\ras.data.frame(x) %\u0026gt;% rename_all(function(n){\rgsub(\u0026quot;^(\\\\w+)\\\\.\u0026quot;, \u0026quot;\u0026quot;, n, perl = TRUE)\r}\r) %\u0026gt;%\rrownames_to_column(\u0026quot;date\u0026quot;) }) %\u0026gt;% rbindlist(idcol = TRUE) %\u0026gt;% mutate(date = as.Date(date)) %\u0026gt;% group_by(.id) %\u0026gt;% tq_mutate(\rselect = Adjusted,\rmutate_fun = periodReturn,\rperiod = \u0026quot;daily\u0026quot;,\rtype = \u0026quot;arithmetic\u0026quot;\r) %\u0026gt;% mutate(\rAdj_lag = lag(Adjusted),\rchng_Adj = ifelse(Adjusted \u0026gt; Adj_lag, 1, 0) # more simply we could have just done if ret were pos/neg\r) %\u0026gt;% select(\u0026quot;date\u0026quot;, \u0026quot;.id\u0026quot;, \u0026quot;Adjusted\u0026quot;, \u0026quot;daily.returns\u0026quot;, \u0026quot;chng_Adj\u0026quot;, \u0026quot;Open\u0026quot;, \u0026quot;High\u0026quot;, \u0026quot;Low\u0026quot;, \u0026quot;Close\u0026quot;) %\u0026gt;% as_tibble() %\u0026gt;% as_tbl_time(index = date) %\u0026gt;% setNames(c(\u0026quot;date\u0026quot;, \u0026quot;ID\u0026quot;, \u0026quot;prc\u0026quot;, \u0026quot;ret\u0026quot;, \u0026quot;chng\u0026quot;, \u0026quot;open\u0026quot;, \u0026quot;high\u0026quot;, \u0026quot;low\u0026quot;, \u0026quot;close\u0026quot;)) %\u0026gt;% drop_na(chng)\rThe first few observations of the data looks like:\n\r\rdate\r\rID\r\rprc\r\rret\r\rchng\r\ropen\r\rhigh\r\rlow\r\rclose\r\r\r\r\r\r2017-01-04\r\rCDW\r\r50.63446\r\r0.0162981\r\r1\r\r51.79\r\r52.60\r\r51.79\r\r52.38\r\r\r\r2017-01-05\r\rCDW\r\r50.14147\r\r-0.0097364\r\r0\r\r52.10\r\r52.66\r\r51.84\r\r51.87\r\r\r\r2017-01-06\r\rCDW\r\r49.96746\r\r-0.0034704\r\r0\r\r51.89\r\r51.95\r\r51.46\r\r51.69\r\r\r\r\rWe can use the nest() function to put the data into convenient nested tibbles that we can simply map() over and apply the rolling_origin() function from the rsample package such that, each of our assets will have their own rolling_origin() function applied to it without any overlap or mixing of the asset classes, I do this in order to create the time series features for each period.\nnested_df \u0026lt;- df %\u0026gt;%\rmutate(duplicate_ID = ID) %\u0026gt;% nest(-ID)\rI split the time series data into a number of lists such that the analysis() list contains 100 observations in each list and has a corresponding assessment() list which contains 1 observation. Usually the analysis() will become our training data set and the assessment() will become our testing data set, however, here I am using the rolling_origin() function to help create the time series features.\n# First we set the number of days we want to construct the ts features\rrolled_df \u0026lt;- map(nested_df$data, ~ rolling_origin(.,\rinitial = 100,\rassess = 1,\rcumulative = FALSE,\rskip = 0))\r\rTime-Series Functions\rIn order to create the time series variables I use the tsfeatures package but there is also the feasts packages here. For this model I simply select a few functions of interest from the tsfeatures package.\nfunctions \u0026lt;- c(\r\u0026quot;entropy\u0026quot;, # Measures the \u0026quot;forecastability\u0026quot; of a series - low values = high sig-to-noise, large vals = difficult to forecast\r\u0026quot;stability\u0026quot;, # means/variances are computed for all tiled windows - stability is the variance of the means\r\u0026quot;lumpiness\u0026quot;, # Lumpiness is the variance of the variances\r\u0026quot;max_level_shift\u0026quot;, # Finds the largest mean shift between two consecutive windows (returns two values, size of shift and time index of shift)\r\u0026quot;max_var_shift\u0026quot;, # Finds the max variance shift between two consecutive windows (returns two values, size of shift and time index of shift)\r\u0026quot;max_kl_shift\u0026quot;, # Finds the largest shift in the Kulback-Leibler divergence between two consecutive windows (returns two values, size of shift and time index of shift)\r\u0026quot;crossing_points\u0026quot; # Number of times a series crosses the mean line\r)\rI wrote this code a little while ago and at the time I wrapped the model into a function. I think it would be more fun to exclusively stick to using just map() functions instead of function(SYMB). The function does the following for each asset in our data:\nUsing the out-of-sample t+1 (assessment) data, bind these lists together into a single data frame. Next apply the functions character string to call the functions from the tsfeatures package, apply these functions to the in-sample (analysis) data (which consists of 100 observations each), such that, we obtain a single collapsed down observation that we can just bind together. Finally we bind the columns of these two data sets together using bind_cols(). After this I rename the chng variable and rename the time series feature variables to something more dynamic using ~str_c(\"X\", seq_along(.)) so we can just add functions to the functions character string and not have to worry about renaming the variables individually in order for the model to work.\nOnce this is done, I create the Machine Learning data set again using the rolling_origin() function. The first rolling_origin() function was used to help collapse the time series data down on a rolling basis by taking the previous 100 days of data and calculating the tsfeatures function on it - a similar method to calculating a rolling mean/sd using the rollapply() function from the zoo package.\nI next split the data into X variables with X_train and X_test and the corresponding Y variable with Y_train and Y_test. The package xgboost expects a certain type of xgb.DMatrix() which is what dtrain and dtest are doing.\nThen, I set the XGBoost parameters and apply the XGBoost model. - Suitable cross validation should be performed at this point, however I will leave this for another post since time series cross validation is quite tricky and there is no function in R which helps with this type of cross validation (that I have found as of 2020-02-02) -\nOnce the model has been trained, I make the predictions.\n\rApply the model\rThe function to compute all this is the following:\nPrediction_Model \u0026lt;- function(SYMB){\rdata \u0026lt;- bind_cols(\rmap(rolled_df[[SYMB]]$splits, ~ assessment(.x)) %\u0026gt;%\rbind_rows(),\rmap(rolled_df[[SYMB]]$splits, ~ analysis(.x)) %\u0026gt;%\rmap(., ~tsfeatures(.x[[\u0026quot;ret\u0026quot;]], functions)) %\u0026gt;% # Compute the TSFeatures\rbind_rows()\r) %\u0026gt;%\rrename(Y = chng) %\u0026gt;%\rrename_at(vars(-c(1:9)), ~str_c(\u0026quot;X\u0026quot;, seq_along(.))) ml_data \u0026lt;- data %\u0026gt;% as_tibble() %\u0026gt;% rolling_origin(\rinitial = 200,\rassess = 1,\rcumulative = FALSE,\rskip = 0)\rX_train \u0026lt;- map(\rml_data$splits, ~ analysis(.x) %\u0026gt;%\ras_tibble(., .name_repair = \u0026quot;universal\u0026quot;) %\u0026gt;%\rselect(starts_with(\u0026quot;X\u0026quot;)) %\u0026gt;% as.matrix()\r)\rY_train \u0026lt;- map(\rml_data$splits, ~ analysis(.x) %\u0026gt;%\ras_tibble(., .name_repair = \u0026quot;universal\u0026quot;) %\u0026gt;%\rselect(starts_with(\u0026quot;Y\u0026quot;)) %\u0026gt;% as.matrix()\r)\rX_test \u0026lt;- map(\rml_data$splits, ~ assessment(.x) %\u0026gt;%\ras_tibble(., .name_repair = \u0026quot;universal\u0026quot;) %\u0026gt;%\rselect(starts_with(\u0026quot;X\u0026quot;)) %\u0026gt;% as.matrix()\r)\rY_test \u0026lt;- map(\rml_data$splits, ~ assessment(.x) %\u0026gt;%\ras_tibble(., .name_repair = \u0026quot;universal\u0026quot;) %\u0026gt;%\rselect(starts_with(\u0026quot;Y\u0026quot;)) %\u0026gt;% as.matrix()\r)\r#############################################################\rdtrain \u0026lt;- map2(\rX_train, Y_train, ~ xgb.DMatrix(data = .x, label = .y, missing = \u0026quot;NaN\u0026quot;)\r)\rdtest \u0026lt;- map(\rX_test, ~ xgb.DMatrix(data = .x, missing = \u0026quot;NaN\u0026quot;)\r)\r# Parameters:\rwatchlist \u0026lt;- list(\u0026quot;train\u0026quot; = dtrain)\rparams \u0026lt;- list(\u0026quot;eta\u0026quot; = 0.1, \u0026quot;max_depth\u0026quot; = 5, \u0026quot;colsample_bytree\u0026quot; = 1, \u0026quot;min_child_weight\u0026quot; = 1, \u0026quot;subsample\u0026quot;= 1,\r\u0026quot;objective\u0026quot;=\u0026quot;binary:logistic\u0026quot;, \u0026quot;gamma\u0026quot; = 1, \u0026quot;lambda\u0026quot; = 1, \u0026quot;alpha\u0026quot; = 0, \u0026quot;max_delta_step\u0026quot; = 0,\r\u0026quot;colsample_bylevel\u0026quot; = 1, \u0026quot;eval_metric\u0026quot;= \u0026quot;auc\u0026quot;,\r\u0026quot;set.seed\u0026quot; = 176)\r# Train the XGBoost model\rxgb.model \u0026lt;- map(\rdtrain, ~ xgboost(params = params, data = .x, nrounds = 10, watchlist)\r)\rxgb.pred \u0026lt;- map2(\r.x = xgb.model, .y = dtest, .f = ~ predict(.x, newdata = .y, type = \u0026#39;prob\u0026#39;)\r)\rpreds \u0026lt;- cbind(plyr::ldply(xgb.pred, data.frame),\rplyr::ldply(Y_test, data.frame)) %\u0026gt;% setNames(c(\u0026quot;pred_probs\u0026quot;, \u0026quot;actual\u0026quot;)) %\u0026gt;% bind_cols(plyr::ldply(map(ml_data$splits, ~assessment(.x)))) %\u0026gt;% rename(ID = duplicate_ID) %\u0026gt;% #select(pred_probs, actual, date, ID, prc, ret) %\u0026gt;% as_tibble()\rreturn(preds)\r}\rWe can apply the above model to create the time series features, train and test on each of our assets by running the following.\nSys_t_start \u0026lt;- Sys.time()\rResultados \u0026lt;- lapply(seq(1:length(rolled_df)), Prediction_Model)\rSys_t_end \u0026lt;- Sys.time()\rround(Sys_t_end - Sys_t_start, 2)\rThe Resultados output will give us a list the length of the number of assets we have in our data. The first few observations of the first asset in the list looks like:\n\r\rpred_probs\r\ractual\r\rdate\r\rprc\r\rret\r\rY\r\ropen\r\rhigh\r\rlow\r\rclose\r\rID\r\rX1\r\rX2\r\rX3\r\rX4\r\rX5\r\rX6\r\rX7\r\rX8\r\rX9\r\rX10\r\r\r\r\r\r0.7304490\r\r0\r\r2018-03-15\r\r73.17622\r\r-0.0106061\r\r0\r\r75.36\r\r75.51\r\r74.18\r\r74.63\r\rCDW\r\r0.9870653\r\r0.1149955\r\r0.7047308\r\r1.277064\r\r71\r\r3.161538\r\r63\r\r3.245055\r\r76\r\r56\r\r\r\r0.5149571\r\r1\r\r2018-03-16\r\r74.35286\r\r0.0160795\r\r1\r\r74.78\r\r75.99\r\r73.04\r\r75.83\r\rCDW\r\r0.9886519\r\r0.0745409\r\r0.8408280\r\r1.273320\r\r70\r\r3.143027\r\r62\r\r3.227452\r\r75\r\r55\r\r\r\r0.6207952\r\r0\r\r2018-03-19\r\r72.53889\r\r-0.0243967\r\r0\r\r75.35\r\r75.35\r\r73.45\r\r73.98\r\rCDW\r\r0.9902178\r\r0.0901013\r\r0.7192391\r\r1.275344\r\r69\r\r3.153024\r\r61\r\r3.227452\r\r74\r\r55\r\r\r\r\rWhich consist of the XGBoost predicted probabilities, the actual observed result, the date of the result (of the out-of-sample testing data), the observed share price, the calculated daily returns, (a duplicate of the observed result), the OHLC data we collected from Yahoo and finally the time series features we constructed and then reneamed to \\(X_{n}\\)\nThe objective of this strategy was to invest every day in the asset which obtained the highest predicted probability that the market was going to go up. That is, if the model predicts on day \\(t\\) that asset GOOG was going to be higher than it’s previous close with a predicted probability of 0.78 and it also predicts that AMZN would go up with 0.53 probability then we would invest in GOOG today. That is, we only invest in the asset with the highest predicted probability that the market is going to go up.\nTherefore, I create a new data frame called top_assets which basically gives me the highest predicted probability across all assets each day.\ntop_assets \u0026lt;- plyr::ldply(Resultados) %\u0026gt;% #select(pred_probs, actual, date, open, high, low, close, prc, ret) %\u0026gt;% group_by(date) %\u0026gt;%\rarrange(desc(pred_probs)) %\u0026gt;%\rdplyr::slice(1) %\u0026gt;% ungroup() %\u0026gt;% select(date, everything()) %\u0026gt;% rename(score = pred_probs) %\u0026gt;% select(-actual)\r\rStrategy Assessment\rThe first 10 days of the strategy investments look like:\n\r\rdate\r\rscore\r\rprc\r\rret\r\rY\r\ropen\r\rhigh\r\rlow\r\rclose\r\rID\r\rX1\r\rX2\r\rX3\r\rX4\r\rX5\r\rX6\r\rX7\r\rX8\r\rX9\r\rX10\r\r\r\r\r\r2018-03-15\r\r0.7304490\r\r73.17622\r\r-0.0106061\r\r0\r\r75.36\r\r75.51\r\r74.18\r\r74.63\r\rCDW\r\r0.9870653\r\r0.1149955\r\r0.7047308\r\r1.2770644\r\r71\r\r3.161538\r\r63\r\r3.245055\r\r76\r\r56\r\r\r\r2018-03-16\r\r0.6899720\r\r293.04999\r\r-0.0051601\r\r0\r\r295.13\r\r297.61\r\r289.27\r\r293.05\r\rABMD\r\r0.9918187\r\r0.0769474\r\r2.4417643\r\r1.0584676\r\r69\r\r4.917599\r\r62\r\r7.861935\r\r80\r\r39\r\r\r\r2018-03-19\r\r0.7299674\r\r101.46883\r\r-0.0081591\r\r0\r\r108.98\r\r109.06\r\r107.40\r\r108.19\r\rCCI\r\r0.9894902\r\r0.0705445\r\r0.3788407\r\r0.9924987\r\r68\r\r1.786445\r\r5\r\r1.402126\r\r89\r\r46\r\r\r\r2018-03-20\r\r0.7370850\r\r60.44966\r\r0.0132920\r\r1\r\r65.13\r\r66.10\r\r65.13\r\r65.56\r\rSLB\r\r0.9830999\r\r0.1717591\r\r0.1725298\r\r1.1379607\r\r53\r\r1.853699\r\r9\r\r1.739650\r\r10\r\r47\r\r\r\r2018-03-21\r\r0.7003193\r\r334.51999\r\r0.0448199\r\r1\r\r320.94\r\r339.20\r\r320.32\r\r334.52\r\rCMG\r\r0.9532525\r\r0.0669860\r\r2.4899030\r\r1.6249110\r\r67\r\r4.775679\r\r73\r\r12.454513\r\r10\r\r57\r\r\r\r2018-03-22\r\r0.7438304\r\r87.40306\r\r-0.0243534\r\r0\r\r91.53\r\r92.43\r\r90.48\r\r90.54\r\rADI\r\r0.9796797\r\r0.0855250\r\r0.8606480\r\r1.4206984\r\r65\r\r2.718067\r\r64\r\r8.589078\r\r72\r\r49\r\r\r\r2018-03-23\r\r0.6494384\r\r237.70613\r\r-0.0290578\r\r0\r\r253.63\r\r253.99\r\r244.93\r\r245.26\r\rGS\r\r0.9685330\r\r0.0615987\r\r0.7610257\r\r1.1137175\r\r63\r\r3.588928\r\r58\r\r4.667287\r\r71\r\r50\r\r\r\r2018-03-26\r\r0.6868502\r\r70.18565\r\r0.0238877\r\r1\r\r70.74\r\r71.71\r\r69.71\r\r71.58\r\rCDW\r\r0.9885363\r\r0.1109430\r\r0.5278402\r\r1.1776141\r\r64\r\r2.688307\r\r56\r\r3.038961\r\r69\r\r56\r\r\r\r2018-03-27\r\r0.7274348\r\r57.21453\r\r-0.0020772\r\r0\r\r58.13\r\r58.41\r\r57.16\r\r57.65\r\rCERN\r\r0.9787359\r\r0.1971365\r\r0.2600627\r\r1.0608221\r\r62\r\r2.325379\r\r56\r\r2.115355\r\r69\r\r52\r\r\r\r2018-03-28\r\r0.7031060\r\r68.56778\r\r-0.0039882\r\r0\r\r70.36\r\r70.39\r\r69.26\r\r69.93\r\rCDW\r\r0.9869206\r\r0.1328377\r\r0.5033828\r\r1.1567020\r\r62\r\r2.593677\r\r54\r\r3.010604\r\r67\r\r56\r\r\r\r\rWe can see that the column score is the probability for the asset with the highest predicted probability that it’s price was going to be greater than it’s previous close. The ID column gives us the asset ticker we invest in.\nNext I want to analyse the strategy of picking the best predicted winners against the S\u0026amp;P500 bench mark and therefore download the S\u0026amp;P 500 index.\ntop_assets \u0026lt;- xts(top_assets[,c(2:ncol(top_assets))], order.by = top_assets$date) # put top_assets into xts format\r# Analyse strategy\rgetSymbols(\u0026quot;SPY\u0026quot;, from = start_date, to = end_date, src = \u0026quot;yahoo\u0026quot;) \r## [1] \u0026quot;SPY\u0026quot;\r#detach(\u0026quot;package:tsibble\u0026quot;, unload = TRUE) # tsibble clashes with the base R index() function\rSPY$ret_Rb \u0026lt;- Delt(SPY$SPY.Adjusted)\rSPY \u0026lt;- SPY[index(SPY) \u0026gt;= min(index(top_assets))]\rRaRb \u0026lt;- cbind(top_assets, SPY)\rFrom here we can see how the strategy compares with the S\u0026amp;P 500. I show a number of statistics for analysing asset returns from the PerformanceAnalytics package. I have not expanded the model to include short selling or construct multi-asset portfolios of the top \\(N\\) assets.\nWe can plot the performance of our strategy:\ncharts.PerformanceSummary(RaRb[, c(\u0026quot;ret\u0026quot;, \u0026quot;ret_Rb\u0026quot;)], geometric = FALSE, wealth.index = FALSE, main = \u0026quot;Strategy vs. Market\u0026quot;)\rTake a look at the drawdown and risk metrics.\n## ret ret_Rb\r## Sterling ratio 0.1870 0.3879\r## Calmar ratio 0.2551 0.5884\r## Burke ratio 0.2251 0.5344\r## Pain index 0.0955 0.0283\r## Ulcer index 0.1189 0.0455\r## Pain ratio 0.7337 4.0290\r## Martin ratio 0.5891 2.5027\r## daily downside risk 0.0111 0.0066\r## Annualised downside risk 0.1768 0.1044\r## Downside potential 0.0054 0.0029\r## Omega 1.0722 1.1601\r## Sortino ratio 0.0351 0.0714\r## Upside potential 0.0058 0.0034\r## Upside potential ratio 0.7027 0.6124\r## Omega-sharpe ratio 0.0722 0.1601\rTake a closer look at the drawdown information.\n## $ret\r## From Trough To Depth Length To Trough Recovery\r## 1 2018-08-31 2019-01-03 2019-09-16 -0.2746 261 85 176\r## 2 2019-11-06 2019-12-03 \u0026lt;NA\u0026gt; -0.1300 39 19 NA\r## 3 2019-10-01 2019-10-18 2019-10-29 -0.0810 21 14 7\r## 4 2018-03-22 2018-04-20 2018-05-09 -0.0773 34 21 13\r## 5 2018-08-10 2018-08-15 2018-08-20 -0.0474 7 4 3\r## ## $ret_Rb\r## From Trough To Depth Length To Trough Recovery\r## 1 2018-09-21 2018-12-24 2019-04-12 -0.1935 140 65 75\r## 2 2019-05-06 2019-06-03 2019-06-20 -0.0662 33 20 13\r## 3 2018-03-15 2018-04-02 2018-06-04 -0.0610 56 12 44\r## 4 2019-07-29 2019-08-05 2019-10-25 -0.0602 64 6 58\r## 5 2018-06-13 2018-06-27 2018-07-09 -0.0300 18 11 7\rCompare the returns.\nchart.Boxplot(RaRb[,c(\u0026quot;ret\u0026quot;, \u0026quot;ret_Rb\u0026quot;)], main = \u0026quot;Returns\u0026quot;)\rCompare return statistics.\ntable.Stats(RaRb[, c(\u0026quot;ret\u0026quot;, \u0026quot;ret_Rb\u0026quot;)]) %\u0026gt;% t() %\u0026gt;% kable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\r\rObservations\r\rNAs\r\rMinimum\r\rQuartile 1\r\rMedian\r\rArithmetic Mean\r\rGeometric Mean\r\rQuartile 3\r\rMaximum\r\rSE Mean\r\rLCL Mean (0.95)\r\rUCL Mean (0.95)\r\rVariance\r\rStdev\r\rSkewness\r\rKurtosis\r\r\r\r\r\rret\r\r453\r\r0\r\r-0.0669\r\r-0.0068\r\r0.0006\r\r0.0004\r\r0.0003\r\r0.0087\r\r0.0642\r\r0.0007\r\r-0.0011\r\r0.0018\r\r0.0002\r\r0.0156\r\r-0.2542\r\r2.8842\r\r\r\rret_Rb\r\r453\r\r0\r\r-0.0324\r\r-0.0030\r\r0.0006\r\r0.0005\r\r0.0004\r\r0.0054\r\r0.0505\r\r0.0004\r\r-0.0004\r\r0.0013\r\r0.0001\r\r0.0091\r\r-0.2949\r\r3.6264\r\r\r\r\rCompare Sharpe Information.\nlapply(RaRb[, c(\u0026quot;ret\u0026quot;, \u0026quot;ret_Rb\u0026quot;)], function(x){SharpeRatio(x)})\r## $ret\r## ret\r## StdDev Sharpe (Rf=0%, p=95%): 0.025027498\r## VaR Sharpe (Rf=0%, p=95%): 0.015346462\r## ES Sharpe (Rf=0%, p=95%): 0.009618405\r## ## $ret_Rb\r## ret_Rb\r## StdDev Sharpe (Rf=0%, p=95%): 0.05152014\r## VaR Sharpe (Rf=0%, p=95%): 0.03218952\r## ES Sharpe (Rf=0%, p=95%): 0.01913213\rPlot the Risk - Return scatter plot.\nchart.RiskReturnScatter(RaRb[, c(\u0026quot;ret\u0026quot;, \u0026quot;ret_Rb\u0026quot;)], # check this plot a little more\rRf=.03/252, scale = 252, # for daily data\rmain = \u0026quot;Risk - Return over the period\u0026quot;)\rPlot the rolling return, risk and Sharpe performance.\ncharts.RollingPerformance(RaRb[, c(\u0026quot;ret\u0026quot;, \u0026quot;ret_Rb\u0026quot;)], Rf=.03/12, colorset = c(\u0026quot;red\u0026quot;, rep(\u0026quot;darkgray\u0026quot;,5), \u0026quot;orange\u0026quot;, \u0026quot;green\u0026quot;), lwd = 2)\rCompute the yearly returns.\nlapply(RaRb[, c(\u0026quot;ret\u0026quot;)],function(x){periodReturn(\rx, period = \u0026#39;yearly\u0026#39;, type = \u0026#39;arithmetic\u0026#39;)}) # change type to log for continuous\r## $ret\r## yearly.returns\r## 2018-12-31 -1.855083\r## 2019-12-31 -1.475181\rlapply(RaRb[, c(\u0026quot;ret_Rb\u0026quot;)],function(x){periodReturn(\rx, period = \u0026#39;yearly\u0026#39;, type = \u0026#39;arithmetic\u0026#39;)})\r## $ret_Rb\r## yearly.returns\r## 2018-12-31 -9.0376638\r## 2019-12-31 -0.7226497\r\r\r","date":1580601600,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1580601600,"objectID":"0cd31baa37c921bd7890810bc8e41e87","permalink":"/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/","publishdate":"2020-02-02T00:00:00Z","relpermalink":"/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/","section":"post","summary":"I construct a series of time-series features from the literature and apply a novel XGBoost model to predict the next days price of a number of assets. The concept is simple and can be expanded to many variables, incorporate many assets and be applied to different Machine Learning models.","tags":["time-series","machine learning","financial markets","quant finance","algo trading","quant analytics"],"title":"Machine Learning (XGBoost) Time-Series Classification Trading Strategy","type":"post"},{"authors":["Matthew Smith"],"categories":["Portfolio Optimisation","Econometrics"],"content":"\r\rIntroduction:\rThe literature in portfolio optimisation has been around for decades. In this post I cover a number of traditional portfolio optimisation models. The general aim is to select a portfolio of assets out of a set of all possible portfolios being considered with a defined objective function.\nThe data:\rThe data is collected using the tidyquant() package’s tq_get() function. I then convert the daily asset prices to daily log returns using the periodReturn function from the quantmod() package. Next I construct lists of 6 months worth of daily returns using the rolling_origin() function from the rsample() package. The objective is to compute on a rolling basis the 6 month mean returns mus and the 6 month covariance matrices Sigmas on the training sets (i.e. 6 months) and apply them on the test sets (i.e. 1 month later) - monthly rebalancing.\nJust as with the returns data, the same is applied to the monthly prices data.\nstart_date \u0026lt;- \u0026quot;2013-01-01\u0026quot;\rend_date \u0026lt;- \u0026quot;2017-08-31\u0026quot;\rsymbols \u0026lt;- c(\u0026quot;AAPL\u0026quot;, \u0026quot;ABBV\u0026quot;, \u0026quot;A\u0026quot;, \u0026quot;APD\u0026quot;, \u0026quot;AA\u0026quot;, \u0026quot;CF\u0026quot;, \u0026quot;NVDA\u0026quot;, \u0026quot;HOG\u0026quot;, \u0026quot;WMT\u0026quot;, \u0026quot;AMZN\u0026quot;\r#,\u0026quot;MSFT\u0026quot;, \u0026quot;F\u0026quot;, \u0026quot;INTC\u0026quot;, \u0026quot;ADBE\u0026quot;, \u0026quot;AMG\u0026quot;, \u0026quot;AKAM\u0026quot;, \u0026quot;ALB\u0026quot;, \u0026quot;ALK\u0026quot;\r)\rportfolio_prices \u0026lt;- tq_get(\rsymbols,\rfrom = start_date,\rto = end_date,\r) %\u0026gt;% select(symbol, date, adjusted)\rportfolio_monthly_returns \u0026lt;- portfolio_prices %\u0026gt;% group_by(symbol) %\u0026gt;% tq_transmute(\rselect = adjusted,\rmutate_fun = periodReturn,\rperiod = \u0026quot;daily\u0026quot;, type = \u0026quot;log\u0026quot;,\r) %\u0026gt;% pivot_wider(names_from = symbol, values_from = daily.returns) %\u0026gt;% mutate(year_month = yearmonth(date)) %\u0026gt;% nest(-year_month) %\u0026gt;% rolling_origin(\rinitial = 6,\rassess = 1,\rskip = 0,\rcumulative = FALSE)\rportfolio_monthly_prices \u0026lt;- portfolio_prices %\u0026gt;%\rpivot_wider(names_from = symbol, values_from = adjusted) %\u0026gt;% mutate(year_month = yearmonth(date)) %\u0026gt;% nest(-year_month) %\u0026gt;% rolling_origin(\rinitial = 6,\rassess = 1,\rskip = 0,\rcumulative = FALSE)\rListNamesDates \u0026lt;- map(portfolio_monthly_returns$splits, ~assessment(.x) %\u0026gt;%\rselect(year_month)) %\u0026gt;%\rplyr::ldply(., data.frame) %\u0026gt;% pull(year_month)\r#########\r# Goal is to define the mean and covariance matrix on the training sets and apply them on the test sets - monthly rebalancing\rmus \u0026lt;- map(portfolio_monthly_returns$splits, ~ analysis(.x) %\u0026gt;% unnest(data) %\u0026gt;%\rselect(-year_month, -date) %\u0026gt;%\rcolMeans) %\u0026gt;%\rsetNames(c(ListNamesDates))\rSigmas \u0026lt;- map(portfolio_monthly_returns$splits, ~ analysis(.x) %\u0026gt;%\runnest() %\u0026gt;%\rtk_xts(., date_var = date) %\u0026gt;%\rcov(.)) %\u0026gt;% setNames(c(ListNamesDates))\r\rPrice and Returns data\rThe returns data for the first split looks like the following:\n\r\rAAPL\r\rABBV\r\rA\r\rAPD\r\rAA\r\rCF\r\rNVDA\r\rHOG\r\rWMT\r\rAMZN\r\r\r\r\r\r0.000000000\r\r0.000000000\r\r0.000000000\r\r0.0000000000\r\r0.000000000\r\r0.000000000\r\r0.0000000000\r\r0.000000000\r\r0.0000000000\r\r0.0000000000\r\r\r\r-0.012702708\r\r-0.008291331\r\r0.003575412\r\r-0.0035002417\r\r0.008859253\r\r-0.004740037\r\r0.0007860485\r\r-0.020819530\r\r-0.0063746748\r\r0.0045367882\r\r\r\r-0.028249939\r\r-0.012713395\r\r0.019555411\r\r0.0133515376\r\r0.020731797\r\r0.022152033\r\r0.0324601827\r\r-0.005529864\r\r0.0037720098\r\r0.0025886574\r\r\r\r-0.005899428\r\r0.002033327\r\r-0.007259372\r\r-0.0009230752\r\r-0.017429792\r\r-0.003753345\r\r-0.0293228286\r\r0.006958715\r\r-0.0096029606\r\r0.0352948721\r\r\r\r0.002687379\r\r-0.022004791\r\r-0.008022622\r\r0.0018451781\r\r0.000000000\r\r-0.014769161\r\r-0.0221704307\r\r-0.003063936\r\r0.0027737202\r\r-0.0077780140\r\r\r\r-0.015752246\r\r0.005620792\r\r0.026649604\r\r0.0133906716\r\r-0.002200109\r\r0.034376623\r\r-0.0226730363\r\r0.038724890\r\r-0.0002916231\r\r-0.0001126237\r\r\r\r\r\rThe statistics\rThe Mus (mean returns) data looks like:\n\r\r\r\r\r\r\rx\r\r\r\r\r\rAAPL\r\r-0.0025241\r\r\r\rABBV\r\r0.0014847\r\r\r\rA\r\r0.0002314\r\r\r\rAPD\r\r0.0006546\r\r\r\rAA\r\r-0.0010700\r\r\r\rCF\r\r-0.0013681\r\r\r\rNVDA\r\r0.0008864\r\r\r\rHOG\r\r0.0008061\r\r\r\rWMT\r\r0.0006895\r\r\r\rAMZN\r\r0.0006147\r\r\r\r\r\r\r\r\rThe Sigmas (covariance matrix) data looks like:\n\r\r\r\r\r\r\rAAPL\r\rABBV\r\rA\r\rAPD\r\rAA\r\rCF\r\rNVDA\r\rHOG\r\rWMT\r\rAMZN\r\r\r\r\r\rAAPL\r\r0.0004166\r\r0.0000220\r\r0.0000112\r\r0.0000388\r\r0.0000528\r\r0.0000277\r\r0.0000408\r\r0.0000116\r\r-0.0000038\r\r-0.0000366\r\r\r\rABBV\r\r0.0000220\r\r0.0003128\r\r0.0000490\r\r0.0000393\r\r0.0000137\r\r0.0000472\r\r0.0000511\r\r0.0000732\r\r0.0000258\r\r0.0000295\r\r\r\rA\r\r0.0000112\r\r0.0000490\r\r0.0002061\r\r0.0000720\r\r0.0000741\r\r0.0000885\r\r0.0000930\r\r0.0001175\r\r0.0000371\r\r0.0001139\r\r\r\rAPD\r\r0.0000388\r\r0.0000393\r\r0.0000720\r\r0.0000993\r\r0.0000523\r\r0.0000687\r\r0.0000578\r\r0.0000744\r\r0.0000107\r\r0.0000511\r\r\r\rAA\r\r0.0000528\r\r0.0000137\r\r0.0000741\r\r0.0000523\r\r0.0001485\r\r0.0000874\r\r0.0000685\r\r0.0000674\r\r-0.0000012\r\r0.0000383\r\r\r\rCF\r\r0.0000277\r\r0.0000472\r\r0.0000885\r\r0.0000687\r\r0.0000874\r\r0.0002271\r\r0.0000706\r\r0.0000900\r\r-0.0000112\r\r0.0000606\r\r\r\rNVDA\r\r0.0000408\r\r0.0000511\r\r0.0000930\r\r0.0000578\r\r0.0000685\r\r0.0000706\r\r0.0002092\r\r0.0000706\r\r0.0000127\r\r0.0000853\r\r\r\rHOG\r\r0.0000116\r\r0.0000732\r\r0.0001175\r\r0.0000744\r\r0.0000674\r\r0.0000900\r\r0.0000706\r\r0.0002393\r\r0.0000214\r\r0.0000895\r\r\r\rWMT\r\r-0.0000038\r\r0.0000258\r\r0.0000371\r\r0.0000107\r\r-0.0000012\r\r-0.0000112\r\r0.0000127\r\r0.0000214\r\r0.0000682\r\r0.0000236\r\r\r\rAMZN\r\r-0.0000366\r\r0.0000295\r\r0.0001139\r\r0.0000511\r\r0.0000383\r\r0.0000606\r\r0.0000853\r\r0.0000895\r\r0.0000236\r\r0.0003118\r\r\r\r\r\r\r\r\r\r\rComparing Portfolio Optimisation\rGlobal Minimum Variance Portfolio\rThe global minimum-variance portfolio \\(w^{gmv}\\) is a portfolio of assets with gives us the lowest possible return variance or portfolio volatility. Volatility here is used as a replacement for risk, thus with less variance in volatility correlates to less risk in an asset. The portfolio focuses only on risk and ignores expected returns.\nThe objective function is;\n\\[\\begin{eqnarray} \\min_{w} w^{T} \\Sigma w \\\\\r\\text{subject to } 1^{T}w = 1 \\\\\rw \\ge 0 \\end{eqnarray}\\]\nSince \\(\\Sigma\\) is unknown we can estimate it as \\(\\hat{\\Sigma}\\) with the covariance matrix. In which the convex solution becomes:\n\\[W = \\dfrac{1}{1^{T}\\hat{\\Sigma}^{-1}1}\\hat{\\Sigma}^{-1}1\\]\rThe objective is that we want to find the optimial weights from the model such that our risk is minimised.\nThe below problem consists of our \\(Minimisation\\) problem \\(\\min_{w} w^{T} \\Sigma w\\). The quad_form function takes the quadratic form \\(x^T Px\\) where \\(x\\) is a vector and \\(P\\) is a matrix or in our case \\(w\\) is our weights vector and \\(\\Sigma\\) is the covariance matrix for \\(A_{1}, \\dots, A_{5}\\). The constraints correspond to \\(1^{T}w = 1\\) in which we cannot assign negative weights to our assets and that we invest all our capital in the portfolio.\nWe can use the Disciplined Convex Programming (CVXR) package in R, which;\n\rAnalyses the problem,\n\rVerifies the convexity,\n\rConverts the problem into canonical form,\n\rSolves the problem.\n\r\rWe want to find the optimial weights from the model such that our risk is minimised. We can do this by solving the optimisation problem, bind the lists into a single data frame and use ggplot2 to plot the rolling one month out of sample optimal portfolio weights - based on the previous 6 months rolled mus and Sigmas.\n# 1) Function: Global Minimum Variance Portfolio\rGMVPportolioFunction \u0026lt;- function(Sigma) {\rw \u0026lt;- Variable(nrow(Sigma))\rproblem \u0026lt;- Problem( # Initialise the problem\rMinimize( # minimse or maximise objective function\rquad_form(\rw, Sigma # Model inputs, the number of weights to consider and the covariance matrix\r)\r), constraints = list(\rw \u0026gt;= 0, # First model constraint\rsum(w) == 1)) # Second model constrain\rSolution \u0026lt;- solve(problem, solver=\u0026quot;SCS\u0026quot;) # Solves the problem\rreturn(as.vector(Solution$getValue(w)))\r}\r# 1a) Portfolio GMVP\rGMVPPortfolio \u0026lt;- map(\r.x = Sigmas,\rGMVPportolioFunction)\r# 1b) Portfolio GMVP\rGMVPPortfolioWeights \u0026lt;- setNames(GMVPPortfolio, ListNamesDates) %\u0026gt;% map(., ~setNames(., c(symbols))) %\u0026gt;% map_dfr(., ~bind_rows(.), .id = \u0026quot;date\u0026quot;) %\u0026gt;% mutate(date = as.Date(paste(date, \u0026quot;01\u0026quot;), format = \u0026quot;%Y %b %d\u0026quot;))\rGMVPPortfolioWeights %\u0026gt;%\rhead() %\u0026gt;% kable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rdate\r\rAAPL\r\rABBV\r\rA\r\rAPD\r\rAA\r\rCF\r\rNVDA\r\rHOG\r\rWMT\r\rAMZN\r\r\r\r\r\r2013-07-01\r\r0.0600841\r\r0.0335474\r\r0.0000000\r\r0.1487694\r\r0.1258906\r\r0.0727919\r\r0.0095632\r\r0.0000000\r\r0.5208891\r\r0.0284642\r\r\r\r2013-08-01\r\r0.1046817\r\r0.0404000\r\r-0.0000009\r\r0.0917764\r\r0.1592917\r\r0.0299732\r\r0.0364528\r\r0.0000000\r\r0.5374240\r\r0.0000007\r\r\r\r2013-09-01\r\r0.1183895\r\r0.0000005\r\r0.0000006\r\r0.0844453\r\r0.1683525\r\r0.0246108\r\r0.0635568\r\r0.0000002\r\r0.5406430\r\r0.0000004\r\r\r\r2013-10-01\r\r0.0975699\r\r0.0000000\r\r0.0024138\r\r0.0742436\r\r0.1166938\r\r0.0431301\r\r0.0968247\r\r0.0000000\r\r0.5691240\r\r0.0000000\r\r\r\r2013-11-01\r\r0.1480922\r\r0.0000003\r\r0.0620406\r\r0.0449223\r\r-0.0000003\r\r0.0279872\r\r0.1613034\r\r0.0376023\r\r0.5014186\r\r0.0166322\r\r\r\r2013-12-01\r\r0.1135468\r\r0.0000007\r\r0.0678773\r\r0.0560224\r\r-0.0000005\r\r0.0062812\r\r0.1195510\r\r0.0779063\r\r0.5588149\r\r0.0000001\r\r\r\r\r# 1c) Portfolio GMVP\rGMVPPortfolioWeights %\u0026gt;% select(date, everything()) %\u0026gt;% pivot_longer(cols = 2:ncol(.), values_to = \u0026quot;weights\u0026quot;) %\u0026gt;% ggplot(aes(fill = name, y = weights, x = date)) + geom_bar(position = \u0026quot;stack\u0026quot;, stat = \u0026quot;identity\u0026quot;, width = 100) +\rscale_fill_viridis(option = \u0026quot;magma\u0026quot;, discrete = TRUE, name = \u0026quot;Asset\u0026quot;) +\rtheme_bw() +\rggtitle(\u0026quot;GMVP Rolling Portfolio Adjustments\u0026quot;) +\rxlab(\u0026quot;Date\u0026quot;) +\rylab(\u0026quot;Weights\u0026quot;)\r\rMarkowitz Portfolio\rThe Markowitz Mean-Variance Portfolio is constructed as follows:\n\\[\\begin{eqnarray} \\max_{w} \\mu^{T}w - \\lambda w^{T}\\Sigma w \\\\\r\\text{subject to } 1^{T}w = 1 \\\\\rw \\ge 0 \\end{eqnarray}\\]\nWe can set different risk parameters by adjusting \\(\\lambda\\) and see how the returns are affected. This can be done by running multiple optimisation problems on the data with different \\(\\lambda\\) values. Higher \\(\\lambda\\) values places emphasis on the right hand side of the equation and thus the more risk adverse the investor is.\n# 2) Function: Markowitz Portfolio\rMarkowitzportolioFunction \u0026lt;- function(mu, Sigma, lmd) {\rw \u0026lt;- Variable(nrow(Sigma))\rproblem \u0026lt;- Problem(\rMaximize(t(mu) %*% w - lmd*quad_form(w, Sigma)),\rconstraints = list(\rw \u0026gt;= 0, sum(w) == 1)\r)\rSolution \u0026lt;- solve(problem)\rreturn(as.vector(Solution$getValue(w)))\r}\r# 2a) Portfolio Markowitz\rlmd \u0026lt;- c(0.25, 0.5, 0.75)\rMarkowitzPortfolio \u0026lt;- map(lmd,\r~map2(\r.x = mus,\r.y = Sigmas,\rMarkowitzportolioFunction, lmd = .x))\r# 2b) Portfolio Markowitz\rMarkowitzPortfolioWeights \u0026lt;- setNames(MarkowitzPortfolio, lmd) %\u0026gt;% map(., ~setNames(., c(ListNamesDates))) %\u0026gt;% map(., ~map(., ~setNames(., c(symbols)))) %\u0026gt;% map(., ~map_dfr(., ~bind_rows(.), .id = \u0026quot;date\u0026quot;)) %\u0026gt;% map_dfr(., ~bind_rows(.), .id = \u0026quot;lambda\u0026quot;) %\u0026gt;% mutate(date = as.Date(paste(date, \u0026quot;01\u0026quot;), format = \u0026quot;%Y %b %d\u0026quot;))\rMarkowitzPortfolioWeights %\u0026gt;%\rhead() %\u0026gt;% kable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rlambda\r\rdate\r\rAAPL\r\rABBV\r\rA\r\rAPD\r\rAA\r\rCF\r\rNVDA\r\rHOG\r\rWMT\r\rAMZN\r\r\r\r\r\r0.25\r\r2013-07-01\r\r0\r\r1.0000000\r\r0.000000\r\r0.0000000\r\r0\r\r0\r\r0.0000000\r\r0.0000000\r\r0\r\r0\r\r\r\r0.25\r\r2013-08-01\r\r0\r\r0.2938168\r\r0.000000\r\r0.7061832\r\r0\r\r0\r\r0.0000000\r\r0.0000000\r\r0\r\r0\r\r\r\r0.25\r\r2013-09-01\r\r0\r\r0.0000000\r\r0.000000\r\r1.0000000\r\r0\r\r0\r\r0.0000000\r\r0.0000000\r\r0\r\r0\r\r\r\r0.25\r\r2013-10-01\r\r0\r\r0.0000000\r\r0.000001\r\r0.9999984\r\r0\r\r0\r\r0.0000004\r\r0.0000001\r\r0\r\r0\r\r\r\r0.25\r\r2013-11-01\r\r0\r\r0.0000000\r\r0.000000\r\r0.0000000\r\r0\r\r0\r\r0.0000000\r\r0.0000000\r\r0\r\r1\r\r\r\r0.25\r\r2013-12-01\r\r0\r\r0.0000000\r\r0.000000\r\r0.0000000\r\r0\r\r0\r\r0.0000000\r\r0.0000000\r\r0\r\r1\r\r\r\r\rWe can see how the risk and return is affected by the changes in the \\(\\lambda\\) values in the following plot. As the \\(\\lambda\\) values increase the less risk we take on but also we assume less returns. Low values of \\(\\lambda\\) makes us invest in a signle asset with the weight on asset \\(A_{5}\\), increasing the \\(\\lambda\\) values increases the weights in other assets \\(A_{i}\\) spreading our risk.\n# 2c) Portfolio Markowitz\rMarkowitzPortfolioWeights %\u0026gt;% select(date, lambda, everything()) %\u0026gt;% pivot_longer(cols = 3:ncol(.), values_to = \u0026quot;weights\u0026quot;) %\u0026gt;% ggplot(aes(fill = name, y = weights, x = date)) + geom_bar(position = \u0026quot;stack\u0026quot;, stat = \u0026quot;identity\u0026quot;, width = 100) +\rfacet_wrap(~lambda, ncol = 1) +\rscale_fill_viridis(option = \u0026quot;magma\u0026quot;, discrete = TRUE, name = \u0026quot;Asset\u0026quot;) +\rtheme_bw() +\rggtitle(\u0026quot;Markowitz Rolling Portfolio Adjustments\u0026quot;,\rsubtitle = \u0026quot;For different Lambda Risk Values\u0026quot;) +\rxlab(\u0026quot;Date\u0026quot;) +\rylab(\u0026quot;Weights\u0026quot;)\r\rMax Sharpe Ratio\rNote: I originally made this post a few months back and when I went back to it some of the parts for the Max-Sharpe Ratio portfolio did not work as before - I think this is due to the recent update in the tidyr package. I made some minor adjustments, however this part of the post is incorrect (just look at the portfolio weights plot). I hightlight in the code when I made the minor adjustments - when I have the opportunity to go back through the code more carefully I will -\n# 2) Function: Max Sharpe Ratio #NOTE::: When we have all negative mus for a given month we obtain an NA value - the function # cannot find a maximum when all mus are negative compare the MaxSharpePortfolio$`2015 Sep` and\r# MaxSharpePortfolio$`2015 Oct` along with the mus$`2015 Sep` and mus$`2015 Oct` we invests 99% of the portfolio\r# in Sept in ABBV since its positive. In Oct ABBV mu is negative and we cannot invest at all.\r# Increasing the universe of Assets may overcome this problem.\rMaxSharpeportolioFunction \u0026lt;- function(mu, Sigma) {\rw \u0026lt;- Variable(nrow(Sigma))\rproblem \u0026lt;- Problem(\rMinimize(quad_form(w, Sigma)),\rconstraints = list(\rw \u0026gt;= 0, t(mu) %*% w == 1)\r)\rSolution \u0026lt;- solve(problem, solver=\u0026quot;SCS\u0026quot;)\rreturn(as.vector(Solution$getValue(w)/sum(Solution$getValue(w))))\r}\r# 3a) Portfolio Max Sharpe Ratio MaxSharpePortfolio \u0026lt;- purrr::map2(.x = mus,\r.y = Sigmas,\r.f = ~MaxSharpeportolioFunction(.x, .y))\r# 3b) Portfolio Max Sharpe Ratio\rMaxSharpePortfolioWeights \u0026lt;- setNames(MaxSharpePortfolio, ListNamesDates) %\u0026gt;%\ras_tibble(.) %\u0026gt;% # Made an adjustment here\rmap(., ~setNames(., c(symbols))) %\u0026gt;% map_dfr(., ~bind_rows(.), .id = \u0026quot;date\u0026quot;) %\u0026gt;% mutate(date = as.Date(paste(date, \u0026quot;01\u0026quot;), format = \u0026quot;%Y %b %d\u0026quot;))\rMaxSharpePortfolioWeights %\u0026gt;%\rhead() %\u0026gt;% kable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rdate\r\rAAPL\r\rABBV\r\rA\r\rAPD\r\rAA\r\rCF\r\rNVDA\r\rHOG\r\rWMT\r\rAMZN\r\r\r\r\r\r2013-07-01\r\r0.0009088\r\r0.1532283\r\r0.0371040\r\r0.2332344\r\r-0.1010233\r\r0.0126946\r\r0.2083815\r\r-0.0262255\r\r0.5086221\r\r-0.0269248\r\r\r\r2013-08-01\r\r0.0109744\r\r0.1485344\r\r-0.0156878\r\r0.3292178\r\r-0.0080488\r\r0.0051372\r\r0.1146053\r\r0.0091278\r\r0.4086911\r\r-0.0025515\r\r\r\r2013-09-01\r\r0.1217206\r\r0.1246626\r\r0.0087004\r\r0.3421645\r\r0.0000000\r\r0.0000000\r\r0.2414533\r\r0.0002820\r\r0.1610166\r\r0.0000000\r\r\r\r2013-10-01\r\r0.0270424\r\r0.0000000\r\r0.2268394\r\r0.3427932\r\r0.0000000\r\r0.0000000\r\r0.2653166\r\r0.1283026\r\r0.0000000\r\r0.0097059\r\r\r\r2013-11-01\r\r0.2061379\r\r0.0000000\r\r0.1890218\r\r0.2234739\r\r0.0000000\r\r0.0533254\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.3280410\r\r\r\r2013-12-01\r\r0.2252115\r\r0.0000000\r\r0.0306323\r\r0.0724210\r\r0.0000000\r\r0.0325004\r\r0.0000000\r\r0.1907158\r\r0.1192395\r\r0.3292796\r\r\r\r\r# 3c) Portfolio Max Sharpe Ratio\rMaxSharpePortfolioWeights %\u0026gt;% select(date, everything()) %\u0026gt;% # Made an adjustment here\rpivot_longer(cols = 2:ncol(.), values_to = \u0026quot;weights\u0026quot;) %\u0026gt;% ggplot(aes(fill = name, y = weights, x = date)) + geom_bar(position = \u0026quot;stack\u0026quot;, stat = \u0026quot;identity\u0026quot;, width = 100) +\rscale_fill_viridis(option = \u0026quot;magma\u0026quot;, discrete = TRUE, name = \u0026quot;Asset\u0026quot;) +\rtheme_bw() +\rggtitle(\u0026quot;Maximum Sharpe Ratio Rolling Portfolio Adjustments\u0026quot;) +\rxlab(\u0026quot;Date\u0026quot;) +\rylab(\u0026quot;Weights\u0026quot;)\r\rMu Quintile Portfolio\r# 1a)\rmu_quintiles \u0026lt;- map(mus, ~ntile(., 5) %\u0026gt;% setNames(c(symbols))) %\u0026gt;% map(., ~sort(., decreasing = TRUE))\r# 2) mu_diag_sigma \u0026lt;- map2(\r.x = mus,\r.y = Sigmas,\r~.x / diag(.y)) mu_diag_sigma_quintiles \u0026lt;- mu_diag_sigma %\u0026gt;% map(., ~ntile(., 5)) %\u0026gt;% map(., ~setNames(., c(symbols))) %\u0026gt;% map(., ~sort(., decreasing = TRUE))\r# 1b) rank the quintiles by mu\rquintiles_mu \u0026lt;- map2(\r.x = mus,\r.y = mu_quintiles,\r~bind_rows(.x, .y))\rquintiles_mu_weights \u0026lt;- map(quintiles_mu, ~ .x %\u0026gt;%\rmutate_all(~ case_when(. %in% c(5, 1) ~ .5, TRUE ~ 0)) %\u0026gt;%\rpmap_dfr(., ~ {v1 \u0026lt;- c(...)\rv2 \u0026lt;- if(sum(v1) \u0026gt; 1) replace(v1, v1 != 0, 1/sum(v1!=0)) else v1\ras.list(v2)}))\rquintiles_mu_weights \u0026lt;- map(quintiles_mu_weights, ~.x[-1,]) %\u0026gt;% map2(.x = quintiles_mu, .y = ., ~bind_rows(.x, .y))\rQuintileMuWeights \u0026lt;- map(quintiles_mu_weights, ~.x[3, ]) %\u0026gt;% # The weights are stored in row 3.\rmap_dfr(., ~bind_rows(.), .id = \u0026quot;date\u0026quot;) %\u0026gt;% mutate(date = as.Date(paste(date, \u0026quot;01\u0026quot;), format = \u0026quot;%Y %b %d\u0026quot;))\rQuintileMuWeights %\u0026gt;%\rhead() %\u0026gt;% kable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rdate\r\rAAPL\r\rABBV\r\rA\r\rAPD\r\rAA\r\rCF\r\rNVDA\r\rHOG\r\rWMT\r\rAMZN\r\r\r\r\r\r2013-07-01\r\r0.25\r\r0.25\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r0\r\r0.00\r\r0.00\r\r\r\r2013-08-01\r\r0.00\r\r0.25\r\r0.00\r\r0.25\r\r0.25\r\r0.25\r\r0.00\r\r0\r\r0.00\r\r0.00\r\r\r\r2013-09-01\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r0.25\r\r0.25\r\r0\r\r0.00\r\r0.00\r\r\r\r2013-10-01\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r0.25\r\r0.00\r\r0.00\r\r0\r\r0.25\r\r0.00\r\r\r\r2013-11-01\r\r0.00\r\r0.25\r\r0.00\r\r0.25\r\r0.00\r\r0.00\r\r0.00\r\r0\r\r0.25\r\r0.25\r\r\r\r2013-12-01\r\r0.25\r\r0.00\r\r0.00\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0\r\r0.25\r\r0.25\r\r\r\r\rQuintileMuWeights %\u0026gt;% select(date, everything()) %\u0026gt;%\rpivot_longer(cols = 2:ncol(.), values_to = \u0026quot;weights\u0026quot;) %\u0026gt;% ggplot(aes(fill = name, y = weights, x = date)) + geom_bar(position = \u0026quot;stack\u0026quot;, stat = \u0026quot;identity\u0026quot;, width = 100) +\rscale_fill_viridis(option = \u0026quot;magma\u0026quot;, discrete = TRUE, name = \u0026quot;Asset\u0026quot;) +\rtheme_bw() +\rggtitle(\u0026quot;Quintile MU Rolling Portfolio Adjustments\u0026quot;) +\rxlab(\u0026quot;Date\u0026quot;) +\rylab(\u0026quot;Weights\u0026quot;)\r\rMu / Diag(Sigma) Portfolio\r# 2a) mu_diag_sigma \u0026lt;- map2(\r.x = mus,\r.y = Sigmas,\r~.x / diag(.y)) mu_diag_sigma_quintiles \u0026lt;- mu_diag_sigma %\u0026gt;% map(., ~ntile(., 5)) %\u0026gt;% map(., ~setNames(., c(symbols))) %\u0026gt;% map(., ~sort(., decreasing = TRUE))\r# 2b) rank the quintiles by mu / diag(Sigma)\rquintiles_mu_diag_sigma \u0026lt;- map2(\r.x = mu_diag_sigma,\r.y = mu_diag_sigma_quintiles,\r~bind_rows(.x, .y))\rquintiles_mu_diag_sigma_weights \u0026lt;- map(quintiles_mu_diag_sigma, ~ .x %\u0026gt;%\rmutate_all(~ case_when(. %in% c(5, 1) ~ .5, TRUE ~ 0)) %\u0026gt;%\rpmap_dfr(., ~ {v1 \u0026lt;- c(...)\rv2 \u0026lt;- if(sum(v1) \u0026gt; 1) replace(v1, v1 != 0, 1/sum(v1!=0)) else v1\ras.list(v2)}))\rquintiles_mu_diag_sigma_weights \u0026lt;- map(quintiles_mu_diag_sigma_weights, ~.x[-1,]) %\u0026gt;% map2(.x = quintiles_mu_diag_sigma, .y = ., ~bind_rows(.x, .y))\rQuintileMuDiagSigmaWeights \u0026lt;- map(quintiles_mu_diag_sigma_weights, ~.x[3, ]) %\u0026gt;% # The weights are stored in row 3.\rmap_dfr(., ~bind_rows(.), .id = \u0026quot;date\u0026quot;) %\u0026gt;% mutate(date = as.Date(paste(date, \u0026quot;01\u0026quot;), format = \u0026quot;%Y %b %d\u0026quot;))\rQuintileMuDiagSigmaWeights %\u0026gt;%\rhead() %\u0026gt;% kable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rdate\r\rAAPL\r\rABBV\r\rA\r\rAPD\r\rAA\r\rCF\r\rNVDA\r\rHOG\r\rWMT\r\rAMZN\r\r\r\r\r\r2013-07-01\r\r0.25\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.00\r\r\r\r2013-08-01\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r0.25\r\r0.00\r\r0.00\r\r0.25\r\r0.00\r\r\r\r2013-09-01\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r0.25\r\r0.25\r\r0.00\r\r0.00\r\r0.00\r\r\r\r2013-10-01\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r0.00\r\r0.25\r\r0.00\r\r0.25\r\r0.00\r\r\r\r2013-11-01\r\r0.00\r\r0.25\r\r0.25\r\r0.00\r\r0.00\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r\r\r2013-12-01\r\r0.00\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.00\r\r0.25\r\r0.25\r\r0.25\r\r0.00\r\r\r\r\rQuintileMuDiagSigmaWeights %\u0026gt;% select(date, everything()) %\u0026gt;%\rpivot_longer(cols = 2:ncol(.), values_to = \u0026quot;weights\u0026quot;) %\u0026gt;% ggplot(aes(fill = name, y = weights, x = date)) + geom_bar(position = \u0026quot;stack\u0026quot;, stat = \u0026quot;identity\u0026quot;, width = 100) +\rscale_fill_viridis(option = \u0026quot;magma\u0026quot;, discrete = TRUE, name = \u0026quot;Asset\u0026quot;) +\rtheme_bw() +\rggtitle(\u0026quot;Quintile MU Diag Sigma Rolling Portfolio Adjustments\u0026quot;) +\rxlab(\u0026quot;Date\u0026quot;) +\rylab(\u0026quot;Weights\u0026quot;)\r\rMu / Diag(sqrt(Sigma)) Portfolio\r# 3a)\rmu_diag_sqrt_sigma \u0026lt;- map2(\r.x = mus,\r.y = Sigmas,\r~.x / sqrt(diag(.y))) mu_diag_sqrt_sigma_quintiles \u0026lt;- mu_diag_sqrt_sigma %\u0026gt;% map(., ~ntile(., 5)) %\u0026gt;% map(., ~setNames(., c(symbols))) %\u0026gt;% map(., ~sort(., decreasing = TRUE))\r# 3b) rank the quintiles by mu / sqrt(diag(sigma))\rquintiles_mu_diag_sqrt_sigma \u0026lt;- map2(\r.x = mu_diag_sqrt_sigma,\r.y = mu_diag_sqrt_sigma_quintiles,\r~bind_rows(.x, .y))\rquintiles_mu_diag_sqrt_sigma_weights \u0026lt;- map(quintiles_mu_diag_sqrt_sigma, ~ .x %\u0026gt;%\rmutate_all(~ case_when(. %in% c(5, 1) ~ .5, TRUE ~ 0)) %\u0026gt;%\rpmap_dfr(., ~ {v1 \u0026lt;- c(...)\rv2 \u0026lt;- if(sum(v1) \u0026gt; 1) replace(v1, v1 != 0, 1/sum(v1!=0)) else v1\ras.list(v2)}))\rquintiles_mu_diag_sqrt_sigma_weights \u0026lt;- map(quintiles_mu_diag_sqrt_sigma_weights, ~.x[-1,]) %\u0026gt;% map2(.x = quintiles_mu_diag_sqrt_sigma, .y = ., ~bind_rows(.x, .y))\rQuintileMuDiagSqrtSigmaWeights \u0026lt;- map(quintiles_mu_diag_sqrt_sigma_weights, ~.x[3, ]) %\u0026gt;% # The weights are stored in row 3.\rmap_dfr(., ~bind_rows(.), .id = \u0026quot;date\u0026quot;) %\u0026gt;% mutate(date = as.Date(paste(date, \u0026quot;01\u0026quot;), format = \u0026quot;%Y %b %d\u0026quot;))\rQuintileMuDiagSqrtSigmaWeights %\u0026gt;%\rhead() %\u0026gt;% kable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rdate\r\rAAPL\r\rABBV\r\rA\r\rAPD\r\rAA\r\rCF\r\rNVDA\r\rHOG\r\rWMT\r\rAMZN\r\r\r\r\r\r2013-07-01\r\r0.25\r\r0.25\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.00\r\r0.00\r\r0.25\r\r0.00\r\r\r\r2013-08-01\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r0.25\r\r0.00\r\r0.00\r\r0.25\r\r0.00\r\r\r\r2013-09-01\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r0.25\r\r0.25\r\r0.00\r\r0.00\r\r0.00\r\r\r\r2013-10-01\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r0.25\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.00\r\r\r\r2013-11-01\r\r0.00\r\r0.25\r\r0.00\r\r0.25\r\r0.00\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.25\r\r\r\r2013-12-01\r\r0.00\r\r0.00\r\r0.00\r\r0.00\r\r0.25\r\r0.00\r\r0.25\r\r0.25\r\r0.00\r\r0.25\r\r\r\r\rQuintileMuDiagSqrtSigmaWeights %\u0026gt;% select(date, everything()) %\u0026gt;%\rpivot_longer(cols = 2:ncol(.), values_to = \u0026quot;weights\u0026quot;) %\u0026gt;% ggplot(aes(fill = name, y = weights, x = date)) + geom_bar(position = \u0026quot;stack\u0026quot;, stat = \u0026quot;identity\u0026quot;, width = 100) +\rscale_fill_viridis(option = \u0026quot;magma\u0026quot;, discrete = TRUE, name = \u0026quot;Asset\u0026quot;) +\rtheme_bw() +\rggtitle(\u0026quot;Quintile MU Diag Sqrt(Sigma) Rolling Portfolio Adjustments\u0026quot;) +\rxlab(\u0026quot;Date\u0026quot;) +\rylab(\u0026quot;Weights\u0026quot;)\r\r\rAnalysis of Results\rThere are 8 different portfolio optimisation models. Putting all the data together, it’s easier to inspect the results.\n############################# Assess the Returns ##################################\rMonthlyReturns \u0026lt;- map(portfolio_monthly_prices$splits, ~assessment(.x)) %\u0026gt;% map(., ~unnest(.x, data) %\u0026gt;% select(-year_month) %\u0026gt;% tk_xts(date_var = date) %\u0026gt;% lapply(., periodReturn, period = \u0026quot;monthly\u0026quot;)) %\u0026gt;% setNames(., ListNamesDates) %\u0026gt;% map(., ~data.frame(.)) %\u0026gt;% bind_rows(., .id = \u0026quot;date\u0026quot;) %\u0026gt;% mutate(date = as.Date(paste(date, \u0026quot;01\u0026quot;), format = \u0026quot;%Y %b %d\u0026quot;)) %\u0026gt;% tk_xts(., date_var = date)\r############# Assess the Monthly Portfolio Returns Depeninding on Weights #########\r# 1d)\rTS_GMVPPortfolioWeights \u0026lt;- GMVPPortfolioWeights %\u0026gt;% tk_xts(., date_var = date)\rPortRets_GMVP \u0026lt;- Return.portfolio(MonthlyReturns, weights = TS_GMVPPortfolioWeights) %\u0026gt;% setNames(c(\u0026quot;GMVP\u0026quot;))\r# 2d)\rTS_MarkowitzPortfolioWeights \u0026lt;- MarkowitzPortfolioWeights %\u0026gt;% group_split(lambda) %\u0026gt;% setNames(c(lmd)) %\u0026gt;% map(., ~tk_xts(., select = -lambda, date_var = date))\rMarkowitzWeightedPortfolioReturnsFunction \u0026lt;- function(lmd){\rWeightedReturns = Return.portfolio(MonthlyReturns, weights = TS_MarkowitzPortfolioWeights[[lmd]])\rreturn(fortify.zoo(WeightedReturns))\r}\rPortRets_Markowitz \u0026lt;- lapply(seq(1:length(lmd)), MarkowitzWeightedPortfolioReturnsFunction) %\u0026gt;% setNames(c(lmd)) %\u0026gt;%\rbind_rows(., .id = \u0026quot;lmd\u0026quot;) %\u0026gt;% #column_to_rownames(\u0026quot;Index\u0026quot;) %\u0026gt;% #select(-matches(\u0026quot;Index\u0026quot;)) %\u0026gt;% #rownames_to_column(\u0026quot;Index\u0026quot;) %\u0026gt;% mutate(Index = as.Date(Index),\rlmd = as.numeric(lmd)) %\u0026gt;% pivot_wider(names_from = lmd, values_from = portfolio.returns) %\u0026gt;% tk_xts(date_var = Index) %\u0026gt;% setNames(c(paste(\u0026quot;Markowitz Lambda\u0026quot;, lmd)))\r# 3d)\rTS_MaxSharpePortfolioWeights \u0026lt;- MaxSharpePortfolioWeights %\u0026gt;% tk_xts(., date_var = date)\rPortRets_MaxSharpe \u0026lt;- Return.portfolio(MonthlyReturns, weights = TS_MaxSharpePortfolioWeights) %\u0026gt;% setNames(c(\u0026quot;MaxSharpe\u0026quot;))\r# 4) quintile mu\rTS_QuintileMuWeights \u0026lt;- QuintileMuWeights %\u0026gt;% tk_xts(., date_var = date)\rPortRets_Mu_Quintiles \u0026lt;- Return.portfolio(MonthlyReturns, weights = TS_QuintileMuWeights) %\u0026gt;% setNames(c(\u0026quot;Mu_Quintiles\u0026quot;))\r# 4) quintile mu diag sigma\rTS_QuintileMuDiagSigmaWeights \u0026lt;- QuintileMuDiagSigmaWeights %\u0026gt;% tk_xts(., date_var = date)\rPortRets_MuDiagSigma_Quintiles \u0026lt;- Return.portfolio(MonthlyReturns, weights = TS_QuintileMuDiagSigmaWeights) %\u0026gt;% setNames(c(\u0026quot;MuDiagSigma_Quintiles\u0026quot;))\r# 4) Quintile mu diga sqrt sigma\rTS_QuintileMuDiagSqrtSigmaWeights \u0026lt;- QuintileMuDiagSqrtSigmaWeights %\u0026gt;% tk_xts(., date_var = date)\rPortRets_MuDiagSqrtSigma_Quintiles \u0026lt;- Return.portfolio(MonthlyReturns, weights = TS_QuintileMuDiagSqrtSigmaWeights) %\u0026gt;% setNames(c(\u0026quot;MuDiagSqrtSigma_Quintiles\u0026quot;))\r#####################################################################################\rLooking at the plots the Global Minimum Variance Portfolio shows the lowest volatility in the portfolio returns. The Max Sharpe portfolio is clearly wrong here (see, previous point on Max Sharpe Ratio section). The annaulised performance metrics are also displayed at the bottom for each portfolio over the period.\n########## Assess the Annualised Returns based on portfolio weights ##################\rAllReturns \u0026lt;- cbind(PortRets_GMVP, PortRets_Markowitz, PortRets_MaxSharpe, PortRets_Mu_Quintiles,\rPortRets_MuDiagSigma_Quintiles, PortRets_MuDiagSqrtSigma_Quintiles)\rlibrary(data.table)\rAllReturns %\u0026gt;%\rdata.table(keep.rownames = TRUE) %\u0026gt;%\ras_tibble() %\u0026gt;% pivot_longer(cols = 2:ncol(.)) %\u0026gt;% ggplot(aes(x = index, y = value, color = name)) +\rgeom_line() +\rfacet_wrap(~name, ncol = 2) +\rggtitle(\u0026quot;Portfolio Returns\u0026quot;, subtitle = \u0026quot;With portfolio optimised weights\u0026quot;) +\rxlab(\u0026quot;Returns\u0026quot;) +\rylab(\u0026quot;Date\u0026quot;) +\rtheme_tq()\rAnnualMetrics \u0026lt;- bind_cols(table.AnnualizedReturns(PortRets_GMVP) %\u0026gt;% rownames_to_column(\u0026quot;Metric\u0026quot;),\rtable.AnnualizedReturns(PortRets_Markowitz),\rtable.AnnualizedReturns(PortRets_MaxSharpe),\rtable.AnnualizedReturns(PortRets_Mu_Quintiles),\rtable.AnnualizedReturns(PortRets_MuDiagSigma_Quintiles),\rtable.AnnualizedReturns(PortRets_MuDiagSqrtSigma_Quintiles)\r)\rAnnualMetrics %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rMetric\r\rGMVP\r\rMarkowitz Lambda 0.25\r\rMarkowitz Lambda 0.5\r\rMarkowitz Lambda 0.75\r\rMaxSharpe\r\rMu_Quintiles\r\rMuDiagSigma_Quintiles\r\rMuDiagSqrtSigma_Quintiles\r\r\r\r\r\rAnnualized Return\r\r0.1009\r\r0.8441\r\r0.8142\r\r0.7712\r\r0.1450\r\r0.1939\r\r0.2590\r\r0.2691\r\r\r\rAnnualized Std Dev\r\r0.1127\r\r0.3617\r\r0.3516\r\r0.3353\r\r0.1473\r\r0.1800\r\r0.1485\r\r0.1535\r\r\r\rAnnualized Sharpe (Rf=0%)\r\r0.8951\r\r2.3340\r\r2.3157\r\r2.2999\r\r0.9845\r\r1.0774\r\r1.7437\r\r1.7529\r\r\r\r\rPlotting the cumulative returns shows that the Markowitz lambda portfolios have the highest returns over the period, however they also have the highest standard deviation over the same period.\nchart.CumReturns(AllReturns, main = \u0026quot;Weighted Returns by Objective Function and Risk Tolerance\u0026quot;,\rwealth.index = TRUE, legend.loc = \u0026quot;topleft\u0026quot;, colorset = rich6equal)\rcharts.PerformanceSummary(AllReturns, main = \u0026quot;Performance for Different Weighted Assets\u0026quot;, wealth.index = TRUE, colorset = rich6equal)\rAdditional\r(Some additional test data I leave here for future reference)\ndata \u0026lt;- data.frame(\rA_1 = c(2.3, 0.93, 0.62, 0.74, -0.23),\rA_2 = c(0.93, 1.40, 0.2, 0.56, 0.26),\rA_3 = c(0.62, 0.2, 1.80, 0.78, -0.27),\rA_4 = c(0.74, 0.56, 0.78, 3.4, -0.56),\rA_5 = c(-0.23, 0.26, -0.27, -0.56, 2.60),\rSecurity = c(1, 2, 3, 4, 5),\rR_i = c(15.1, 12.5, 14.7, 9.02, 17.68)\r)\rSigma \u0026lt;- data[, 1:5]\rw \u0026lt;- Variable(nrow(data))\rmu \u0026lt;- data[, 7]\rn_samples = 10\rlambdas \u0026lt;- 10^seq(-2, 3, length.out = n_samples)\rret_data \u0026lt;- rep(0, n_samples)\rrisk_data \u0026lt;- rep(0, n_samples)\rw_data \u0026lt;- matrix(0, nrow = n_samples, ncol = nrow(data))\rfor(i in seq_along(lambdas)) {\rlambda \u0026lt;- lambdas[i]\rproblem \u0026lt;- Problem(\rMaximize(\rt(mu) %*% w - lambda*quad_form(w, Sigma)\r),\rconstraints = list(w \u0026gt;= 0, sum(w) == 1))\rsolution \u0026lt;- solve(problem)\rw_data[i,] \u0026lt;- solution$getValue(w)\rrisk_data[i] \u0026lt;- solution$getValue(sqrt(quad_form(w, Sigma)))\rret_data[i] \u0026lt;- solution$getValue(t(mu) %*% w)\r}\rggplot() +\rgeom_line(mapping = aes(x = risk_data, y = ret_data), color = \u0026quot;blue\u0026quot;) +\rgeom_point(mapping = aes(x = sqrt(diag(as.matrix(Sigma))), y = mu), color = \u0026quot;red\u0026quot;)\r\r\r","date":1577750400,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1577750400,"objectID":"0a96163958c1e51950b801f07aec0564","permalink":"/post/portfolio-optimisation-model/portfolio-optimisation-r/","publishdate":"2019-12-31T00:00:00Z","relpermalink":"/post/portfolio-optimisation-model/portfolio-optimisation-r/","section":"post","summary":"I cover a number of portfolio optimisation models using R from the literature, the portfolio allocation models might be extended to the Black-Litterman model etc.","tags":["finance","quant finance","yahoo-finance","portfolio optimisation","asset pricing","quantstrat"],"title":"Quantitative Analytics: Optimal Portfolio Allocation","type":"post"},{"authors":["Matthew Smith"],"categories":["trading","technical trading","algorithmic trading","systematic trading"],"content":"\r\rStrategies\rIntroduction:\rNote: This post is unfinished.\nThis post goes through a number of the technical trading functions in the TTR package here. I add definitions and show examples of how the functions work.\nlibrary(dplyr)\rlibrary(quantmod)\rlibrary(tidyquant)\rlibrary(TTR)\rlibrary(timetk)\rlibrary(tidyr)\rlibrary(ggplot2) library(directlabels)\rlibrary(data.table)\rlibrary(quantstrat)\rlibrary(purrr)\rlibrary(quantstrat)\rWe can download some data using the quantmod package which stores the different assets into our Global Environment.\nstart_date \u0026lt;- \u0026quot;2013-01-01\u0026quot;\rend_date \u0026lt;- \u0026quot;2017-08-31\u0026quot;\rsymbols \u0026lt;- c(\u0026quot;AAPL\u0026quot;, \u0026quot;AMD\u0026quot;, \u0026quot;ADI\u0026quot;, \u0026quot;ABBV\u0026quot;, \u0026quot;A\u0026quot;, \u0026quot;APD\u0026quot;, \u0026quot;AA\u0026quot;, \u0026quot;CF\u0026quot;, \u0026quot;NVDA\u0026quot;, \u0026quot;HOG\u0026quot;, \u0026quot;WMT\u0026quot;, \u0026quot;AMZN\u0026quot;\r#,\u0026quot;MSFT\u0026quot;, \u0026quot;F\u0026quot;, \u0026quot;INTC\u0026quot;, \u0026quot;ADBE\u0026quot;, \u0026quot;AMG\u0026quot;, \u0026quot;AKAM\u0026quot;, \u0026quot;ALB\u0026quot;, \u0026quot;ALK\u0026quot;\r)\rgetSymbols(symbols, from = start_date,\rto = end_date)\r## [1] \u0026quot;AAPL\u0026quot; \u0026quot;AMD\u0026quot; \u0026quot;ADI\u0026quot; \u0026quot;ABBV\u0026quot; \u0026quot;A\u0026quot; \u0026quot;APD\u0026quot; \u0026quot;AA\u0026quot; \u0026quot;CF\u0026quot; \u0026quot;NVDA\u0026quot; \u0026quot;HOG\u0026quot; ## [11] \u0026quot;WMT\u0026quot; \u0026quot;AMZN\u0026quot;\rThe first few observations for AAPL looks like:\n\r\r\rAAPL.Open\r\rAAPL.High\r\rAAPL.Low\r\rAAPL.Close\r\rAAPL.Volume\r\rAAPL.Adjusted\r\r\r\r\r\r2013-01-02\r\r79.11714\r\r79.28571\r\r77.37572\r\r78.43285\r\r140129500\r\r68.85055\r\r\r\r2013-01-03\r\r78.26857\r\r78.52428\r\r77.28571\r\r77.44286\r\r88241300\r\r67.98149\r\r\r\r2013-01-04\r\r76.71000\r\r76.94714\r\r75.11857\r\r75.28571\r\r148583400\r\r66.08789\r\r\r\r2013-01-07\r\r74.57143\r\r75.61429\r\r73.60000\r\r74.84286\r\r121039100\r\r65.69916\r\r\r\r2013-01-08\r\r75.60143\r\r75.98428\r\r74.46429\r\r75.04429\r\r114676800\r\r65.87595\r\r\r\r2013-01-09\r\r74.64286\r\r75.00143\r\r73.71286\r\r73.87143\r\r101901100\r\r64.84639\r\r\r\r\r\rBollinger Bands Strategy\rThe idea of this strategy is\nDefinition: A Bollinger Band consists of 3 lines. A simple moving average (SMA) and two additional lines plotted 2 standard deviations above and below the SMA. The standard deviation measures a stocks volatility and so when the markers are more volatile then the Bollinger Bands become wider. When the market is flat the Bollinger Banks contract.\nchartSeries(NVDA,\rtheme = chartTheme(\u0026quot;white\u0026quot;),\rTA = c(addBBands(n = 20, sd = 2, ma = \u0026quot;SMA\u0026quot;, draw = \u0026#39;bands\u0026#39;, on = -1))) \rchartSeries(AMZN,\rtheme = chartTheme(\u0026quot;white\u0026quot;),\rTA = c(addBBands(n = 20, sd = 2, ma = \u0026quot;SMA\u0026quot;, draw = \u0026#39;bands\u0026#39;, on = -1))) \rWe set the initial quantstrat parameters and initialise the strategy.\nrm.strat(\u0026quot;BollingerBandsStrat\u0026quot;)\rcurrency(\u0026#39;USD\u0026#39;)\r## [1] \u0026quot;USD\u0026quot;\rstock(symbols, currency = \u0026#39;USD\u0026#39;, multiplier = 1)\r## [1] \u0026quot;AAPL\u0026quot; \u0026quot;AMD\u0026quot; \u0026quot;ADI\u0026quot; \u0026quot;ABBV\u0026quot; \u0026quot;A\u0026quot; \u0026quot;APD\u0026quot; \u0026quot;AA\u0026quot; \u0026quot;CF\u0026quot; \u0026quot;NVDA\u0026quot; \u0026quot;HOG\u0026quot; ## [11] \u0026quot;WMT\u0026quot; \u0026quot;AMZN\u0026quot;\rinit_date = as.Date(start_date) - 1\rinit_equity = 1000\rportfolio.st \u0026lt;- account.st \u0026lt;- \u0026#39;BollingerBandsStrat\u0026#39;\rinitPortf(portfolio.st,\rsymbols = symbols,\rinitDate = init_date)\r## [1] \u0026quot;BollingerBandsStrat\u0026quot;\rinitAcct(account.st,\rportfolios = \u0026#39;BollingerBandsStrat\u0026#39;,\rinitDate = init_date)\r## [1] \u0026quot;BollingerBandsStrat\u0026quot;\rinitOrders(portfolio = portfolio.st,\rinitDate = init_date)\rBBands_Strategy \u0026lt;- strategy(\u0026quot;BollingerBandsStrat\u0026quot;)\rAdding indicators:\rWe add the Bollinger Bands indicator from the TTR package to the strategy. It takes a Simple Moving Average (SMA) and the High Low Close data from each of our stocks, add the indicator to the defined BBands_Strategy and creates a new column in our data alled BollingerBands_Label.\n# Add indicators\rBBands_Strategy \u0026lt;- add.indicator(\rstrategy = BBands_Strategy,\rname = \u0026quot;BBands\u0026quot;,\rarguments = list(\rHLC = quote(HLC(mktdata)),\rmaType = \u0026#39;SMA\u0026#39;),\rlabel = \u0026#39;BollingerBands_Label\u0026#39;)\r\rAdding signals:\r\rThe first signal states that when the close is greater than the upper Bollinger Band, add a value of 1 into a column called Close.gt.LowerBBand. The sigCrossover function only returns the first occurence of the relationship switching from false to true. Replacing with sigComparison here would return all occurences of the relationship being greater than the upper band.\n\rThe second signal states that when the close is less than the lower Bollinger Band add a value of 1 into a column called Close.lt.LowerBBand. Again using the sigCrossover function to only return the first occurence.\n\rThe third signal\n\r\rThe below code creates 3 new columns in our mktdata. dn.BollingerBands_Label, mavg.BollingerBands_Label, up.BollingerBands_Label. Which are the lower, middle and upper Bollinger Band values. It also creates the following: Close.gt.UpperBBand, Close.lt.LowerBBand, Cross.MiddleBBand. Which takes on the values according to whether the `sigCrossover’ has occured.\n# Add Signals\rBBands_Strategy \u0026lt;- add.signal(\rBBands_Strategy, name = \u0026quot;sigCrossover\u0026quot;,\rarguments = list(\rcolumns = c(\u0026quot;Close\u0026quot;,\u0026quot;up\u0026quot;),\rrelationship = \u0026quot;gt\u0026quot;),\rlabel = \u0026quot;Close.gt.UpperBBand\u0026quot;)\rBBands_Strategy \u0026lt;- add.signal(\rBBands_Strategy,\rname = \u0026quot;sigCrossover\u0026quot;,\rarguments = list(\rcolumns = c(\u0026quot;Close\u0026quot;,\u0026quot;dn\u0026quot;),\rrelationship = \u0026quot;lt\u0026quot;),\rlabel = \u0026quot;Close.lt.LowerBBand\u0026quot;)\rBBands_Strategy \u0026lt;- add.signal(\rBBands_Strategy,\rname = \u0026quot;sigCrossover\u0026quot;,\rarguments = list(\rcolumns = c(\u0026quot;High\u0026quot;,\u0026quot;Low\u0026quot;,\u0026quot;mavg\u0026quot;),\rrelationship = \u0026quot;op\u0026quot;),\rlabel = \u0026quot;Cross.MiddleBBand\u0026quot;)\rThe mktdata (which gets presented after running applyStrategy and updatePortf) would look like:\n\r\rindex\r\rWMT.Open\r\rWMT.High\r\rWMT.Low\r\rWMT.Close\r\rWMT.Volume\r\rWMT.Adjusted\r\rdn.BollingerBands_Label\r\rmavg.BollingerBands_Label\r\rup.BollingerBands_Label\r\rpctB.BollingerBands_Label\r\rClose.gt.UpperBBand\r\rClose.lt.LowerBBand\r\rCross.MiddleBBand\r\r\r\r\r\r2013-02-13\r\r71.29\r\r71.70\r\r71.21\r\r71.39\r\r3968600\r\r59.98333\r\r68.71632\r\r70.09250\r\r71.46868\r\r0.9871567\r\rNA\r\rNA\r\rNA\r\r\r\r2013-02-14\r\r71.10\r\r71.23\r\r70.75\r\r70.82\r\r6821000\r\r59.50441\r\r68.82043\r\r70.18133\r\r71.54224\r\r0.7762866\r\rNA\r\rNA\r\rNA\r\r\r\r2013-02-15\r\r69.54\r\r70.00\r\r68.13\r\r69.30\r\r25683700\r\r58.22726\r\r68.84929\r\r70.19050\r\r71.53171\r\r0.1096177\r\rNA\r\rNA\r\r1\r\r\r\r2013-02-19\r\r69.19\r\r69.45\r\r68.54\r\r68.76\r\r14682300\r\r57.77356\r\r68.82222\r\r70.18217\r\r71.54211\r\r0.0347239\r\rNA\r\r1\r\rNA\r\r\r\r2013-02-20\r\r68.72\r\r69.85\r\r68.30\r\r69.21\r\r11973600\r\r58.15165\r\r68.78472\r\r70.16833\r\r71.55195\r\r0.1211618\r\rNA\r\rNA\r\rNA\r\r\r\r2013-02-21\r\r70.00\r\r71.47\r\r69.72\r\r70.26\r\r20413100\r\r59.03389\r\r68.86119\r\r70.22117\r\r71.58114\r\r0.5963869\r\rNA\r\rNA\r\r1\r\r\r\r2013-02-22\r\r70.22\r\r70.54\r\r69.89\r\r70.40\r\r9165200\r\r59.15152\r\r68.90249\r\r70.24950\r\r71.59651\r\r0.5100843\r\rNA\r\rNA\r\rNA\r\r\r\r2013-02-25\r\r70.50\r\r71.34\r\r70.44\r\r70.44\r\r11817600\r\r59.18514\r\r69.00983\r\r70.32100\r\r71.63217\r\r0.6597812\r\rNA\r\rNA\r\rNA\r\r\r\r2013-02-26\r\r70.69\r\r71.39\r\r70.61\r\r71.11\r\r10557600\r\r59.74808\r\r69.14416\r\r70.41200\r\r71.67984\r\r0.7463509\r\rNA\r\rNA\r\rNA\r\r\r\r2013-02-27\r\r70.92\r\r71.96\r\r70.58\r\r71.66\r\r8819000\r\r60.21020\r\r69.20490\r\r70.49383\r\r71.78277\r\r0.8515172\r\rNA\r\rNA\r\rNA\r\r\r\r2013-02-28\r\r71.59\r\r71.88\r\r70.78\r\r70.78\r\r18883600\r\r59.47081\r\r69.28076\r\r70.56167\r\r71.84258\r\r0.7283528\r\rNA\r\rNA\r\rNA\r\r\r\r2013-03-01\r\r70.78\r\r71.90\r\r70.78\r\r71.74\r\r8902300\r\r60.27741\r\r69.33128\r\r70.63400\r\r71.93672\r\r0.8221462\r\rNA\r\rNA\r\rNA\r\r\r\r2013-03-04\r\r71.52\r\r73.26\r\r71.51\r\r73.26\r\r10567200\r\r61.55456\r\r69.27376\r\r70.75150\r\r72.22924\r\r1.1513879\r\r1\r\rNA\r\rNA\r\r\r\r2013-03-05\r\r73.47\r\r74.04\r\r72.99\r\r73.72\r\r9142000\r\r61.94105\r\r69.24347\r\r70.95300\r\r72.66253\r\r1.2693145\r\rNA\r\rNA\r\rNA\r\r\r\r2013-03-06\r\r73.75\r\r74.13\r\r73.25\r\r73.38\r\r7149600\r\r61.65540\r\r69.17483\r\r71.10567\r\r73.03650\r\r1.1424682\r\rNA\r\rNA\r\rNA\r\r\r\r2013-03-07\r\r73.49\r\r73.61\r\r73.20\r\r73.32\r\r6680000\r\r61.60497\r\r69.14018\r\r71.22567\r\r73.31116\r\r1.0157056\r\rNA\r\rNA\r\rNA\r\r\r\r\rIn row 4 of the below table, the close is 68.76 which is less than the lower Bollinger Band dn.BollingerBands_Label column 68.822 and a 1 is indicated in the Close.lt.LowerBBand column. In row 13 of the same data, there is a 1 in the column Close.gt.UpperBBand. The close is 73.26 and the up.BollingerBands_Label is 72.23 so the close is gt then Upper Bollinger Band.\n\rAdd the rules\r\rWhen the close is greater than the upper Bollinger Band we go short by a quantity of 100 at the market price\rWhen the close is lower than the lower Bollinger Band we go long by a quantity of 100 at the market price.\rWhen the Close crosses the middle Bollinger Band we exit all our positions.\r\r# Add rules\rBBands_Strategy \u0026lt;- add.rule(\rBBands_Strategy,\rname = \u0026#39;ruleSignal\u0026#39;,\rarguments = list(\rsigcol = \u0026quot;Close.gt.UpperBBand\u0026quot;, sigval = TRUE, orderqty = -100, ordertype = \u0026#39;market\u0026#39;,\rorderside = NULL,\rthreshold = NULL),\rtype = \u0026#39;enter\u0026#39;)\rBBands_Strategy \u0026lt;- add.rule(\rBBands_Strategy, name = \u0026#39;ruleSignal\u0026#39;,\rarguments = list(\rsigcol = \u0026quot;Close.lt.LowerBBand\u0026quot;,\rsigval = TRUE,\rorderqty = 100,\rordertype = \u0026#39;market\u0026#39;,\rorderside = NULL,\rthreshold = NULL),\rtype = \u0026#39;enter\u0026#39;)\rBBands_Strategy \u0026lt;- add.rule(\rBBands_Strategy,\rname = \u0026#39;ruleSignal\u0026#39;,\rarguments = list(\rsigcol = \u0026quot;Cross.MiddleBBand\u0026quot;,\rsigval = TRUE,\rorderqty = \u0026#39;all\u0026#39;,\rordertype = \u0026#39;market\u0026#39;,\rorderside = NULL,\rthreshold = NULL),\rtype = \u0026#39;exit\u0026#39;)\rApply the strategy and update the portfolio\nout \u0026lt;- applyStrategy(\rstrategy = BBands_Strategy,\rportfolios = \u0026#39;BollingerBandsStrat\u0026#39;,\rparameters = list( sd = 1.6, # number of standard deviations\rn = 20) # MA periods\r)\rupdatePortf(Portfolio = \u0026#39;BollingerBandsStrat\u0026#39;, Dates = paste(\u0026#39;::\u0026#39;,as.Date(Sys.time()),sep=\u0026#39;\u0026#39;))\rFind the best performance stocks:\ntradeStats(portfolio.st) %\u0026gt;% tibble::rownames_to_column(\u0026quot;ticker\u0026quot;) %\u0026gt;%\rt() %\u0026gt;% kable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rticker\r\rA\r\rAA\r\rAAPL\r\rABBV\r\rADI\r\rAMD\r\rAMZN\r\rAPD\r\rCF\r\rHOG\r\rNVDA\r\rWMT\r\r\r\rPortfolio\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\rBollingerBandsStrat\r\r\r\rSymbol\r\rA\r\rAA\r\rAAPL\r\rABBV\r\rADI\r\rAMD\r\rAMZN\r\rAPD\r\rCF\r\rHOG\r\rNVDA\r\rWMT\r\r\r\rNum.Txns\r\r181\r\r188\r\r163\r\r182\r\r172\r\r165\r\r176\r\r171\r\r175\r\r182\r\r201\r\r184\r\r\r\rNum.Trades\r\r70\r\r68\r\r57\r\r63\r\r67\r\r64\r\r62\r\r71\r\r71\r\r68\r\r73\r\r66\r\r\r\rNet.Trading.PL\r\r3302.7855\r\r-663.6981\r\r-5547.4283\r\r-288.0025\r\r1756.0009\r\r966.0000\r\r34942.0472\r\r8510.1655\r\r7601.2010\r\r4524.0020\r\r-2515.9992\r\r3987.0002\r\r\r\rAvg.Trade.PL\r\r48.525511\r\r-6.774974\r\r-97.323304\r\r-2.285762\r\r26.208969\r\r16.046875\r\r529.436174\r\r119.861486\r\r107.059169\r\r66.529441\r\r-34.465742\r\r60.545452\r\r\r\rMed.Trade.PL\r\r66.88130\r\r76.89585\r\r159.99990\r\r77.00000\r\r84.99980\r\r18.50000\r\r1180.00030\r\r148.01180\r\r129.00010\r\r122.99995\r\r35.00000\r\r42.00020\r\r\r\rLargest.Winner\r\r711.7301\r\r995.0003\r\r965.1434\r\r920.9999\r\r1265.0001\r\r152.0000\r\r9117.9932\r\r1882.5164\r\r939.4002\r\r1174.0003\r\r1655.0003\r\r1356.0006\r\r\r\rLargest.Loser\r\r-528.0000\r\r-3104.6764\r\r-11317.0036\r\r-1817.0016\r\r-2617.0005\r\r-414.0000\r\r-13718.9819\r\r-1626.9989\r\r-903.9999\r\r-1227.0002\r\r-4844.0012\r\r-1395.0009\r\r\r\rGross.Profits\r\r6415.110\r\r8216.008\r\r15231.716\r\r8640.999\r\r9168.000\r\r2080.000\r\r96296.006\r\r16046.256\r\r11782.200\r\r11733.502\r\r11577.998\r\r9388.999\r\r\r\rGross.Losses\r\r-3018.324\r\r-8676.707\r\r-20779.144\r\r-8785.002\r\r-7411.999\r\r-1053.000\r\r-63470.963\r\r-7536.091\r\r-4180.999\r\r-7209.500\r\r-14093.998\r\r-5392.999\r\r\r\rStd.Dev.Trade.PL\r\r175.69143\r\r525.90402\r\r1607.09458\r\r413.50580\r\r444.63931\r\r80.12096\r\r3565.68276\r\r463.03163\r\r276.80923\r\r404.27517\r\r794.13687\r\r370.13593\r\r\r\rStd.Err.Trade.PL\r\r20.99914\r\r63.77523\r\r212.86488\r\r52.09683\r\r54.32134\r\r10.01512\r\r452.84216\r\r54.95174\r\r32.85121\r\r49.02557\r\r92.94669\r\r45.56058\r\r\r\rPercent.Positive\r\r65.71429\r\r72.05882\r\r68.42105\r\r66.66667\r\r71.64179\r\r78.12500\r\r67.74194\r\r67.60563\r\r76.05634\r\r64.70588\r\r61.64384\r\r72.72727\r\r\r\rPercent.Negative\r\r34.28571\r\r27.94118\r\r31.57895\r\r33.33333\r\r28.35821\r\r20.31250\r\r32.25806\r\r32.39437\r\r23.94366\r\r35.29412\r\r38.35616\r\r25.75758\r\r\r\rProfit.Factor\r\r2.1253880\r\r0.9469040\r\r0.7330290\r\r0.9836081\r\r1.2369133\r\r1.9753086\r\r1.5171663\r\r2.1292547\r\r2.8180346\r\r1.6275056\r\r0.8214843\r\r1.7409606\r\r\r\rAvg.Win.Trade\r\r139.4589\r\r167.6736\r\r390.5568\r\r205.7381\r\r191.0000\r\r41.6000\r\r2292.7620\r\r334.2970\r\r218.1889\r\r266.6705\r\r257.2889\r\r195.6041\r\r\r\rMed.Win.Trade\r\r111.23030\r\r93.71700\r\r410.00060\r\r189.00015\r\r132.49990\r\r31.00000\r\r1834.00115\r\r223.84460\r\r179.20000\r\r180.99995\r\r91.99980\r\r98.99985\r\r\r\rAvg.Losing.Trade\r\r-125.7635\r\r-456.6688\r\r-1154.3969\r\r-418.3334\r\r-390.1052\r\r-81.0000\r\r-3173.5481\r\r-327.6561\r\r-245.9411\r\r-300.3958\r\r-503.3571\r\r-317.2352\r\r\r\rMed.Losing.Trade\r\r-93.50035\r\r-129.76180\r\r-400.99975\r\r-288.99940\r\r-142.00030\r\r-33.00000\r\r-1961.00005\r\r-205.00030\r\r-166.99940\r\r-155.50005\r\r-138.99980\r\r-136.00040\r\r\r\rAvg.Daily.PL\r\r48.525511\r\r-6.774974\r\r-97.323304\r\r-2.285762\r\r26.208969\r\r16.046875\r\r529.436174\r\r119.861486\r\r107.059169\r\r66.529441\r\r-34.465742\r\r60.545452\r\r\r\rMed.Daily.PL\r\r66.88130\r\r76.89585\r\r159.99990\r\r77.00000\r\r84.99980\r\r18.50000\r\r1180.00030\r\r148.01180\r\r129.00010\r\r122.99995\r\r35.00000\r\r42.00020\r\r\r\rStd.Dev.Daily.PL\r\r175.69143\r\r525.90402\r\r1607.09458\r\r413.50580\r\r444.63931\r\r80.12096\r\r3565.68276\r\r463.03163\r\r276.80923\r\r404.27517\r\r794.13687\r\r370.13593\r\r\r\rStd.Err.Daily.PL\r\r20.99914\r\r63.77523\r\r212.86488\r\r52.09683\r\r54.32134\r\r10.01512\r\r452.84216\r\r54.95174\r\r32.85121\r\r49.02557\r\r92.94669\r\r45.56058\r\r\r\rAnn.Sharpe\r\r4.38449749\r\r-0.20450380\r\r-0.96133704\r\r-0.08775051\r\r0.93571231\r\r3.17939560\r\r2.35706295\r\r4.10931348\r\r6.13964943\r\r2.61238437\r\r-0.68895769\r\r2.59669262\r\r\r\rMax.Drawdown\r\r-1221.745\r\r-4652.209\r\r-12870.005\r\r-4976.003\r\r-3965.999\r\r-669.000\r\r-48292.017\r\r-2705.000\r\r-1757.999\r\r-3237.000\r\r-14917.000\r\r-3010.999\r\r\r\rProfit.To.Max.Draw\r\r2.70333546\r\r-0.14266301\r\r-0.43103544\r\r-0.05787828\r\r0.44276383\r\r1.44394619\r\r0.72355742\r\r3.14608694\r\r4.32378029\r\r1.39759098\r\r-0.16866657\r\r1.32414540\r\r\r\rAvg.WinLoss.Ratio\r\r1.1088981\r\r0.3671669\r\r0.3383211\r\r0.4918040\r\r0.4896115\r\r0.5135802\r\r0.7224601\r\r1.0202679\r\r0.8871590\r\r0.8877303\r\r0.5111458\r\r0.6165902\r\r\r\rMed.WinLoss.Ratio\r\r1.1896244\r\r0.7222233\r\r1.0224460\r\r0.6539811\r\r0.9330959\r\r0.9393939\r\r0.9352377\r\r1.0919233\r\r1.0730577\r\r1.1639864\r\r0.6618700\r\r0.7279379\r\r\r\rMax.Equity\r\r3659.7860\r\r1090.9615\r\r6834.5749\r\r607.9984\r\r2919.9995\r\r1058.0000\r\r37225.0306\r\r9494.1666\r\r7601.2010\r\r6193.0030\r\r2511.9993\r\r4036.9994\r\r\r\rMin.Equity\r\r-555.0795\r\r-3561.2473\r\r-6035.4303\r\r-4687.0026\r\r-1045.9995\r\r-101.0000\r\r-11066.9863\r\r-848.2877\r\r-1744.5987\r\r-847.9955\r\r-12405.0003\r\r-2489.9988\r\r\r\rEnd.Equity\r\r3302.7855\r\r-663.6981\r\r-5547.4283\r\r-288.0025\r\r1756.0009\r\r966.0000\r\r34942.0472\r\r8510.1655\r\r7601.2010\r\r4524.0020\r\r-2515.9992\r\r3987.0002\r\r\r\r\rPerformance plots and trade statistics\nfor(sym in symbols){\rchart.Posn(Portfolio = \u0026#39;BollingerBandsStrat\u0026#39;, Symbol = sym)\rplot(add_BBands(on = 1, sd = 1.6, n = 20))\rperf \u0026lt;- tradeStats(portfolio.st) %\u0026gt;% tibble::rownames_to_column(\u0026quot;ticker\u0026quot;) %\u0026gt;% filter(ticker == sym) %\u0026gt;% t() %\u0026gt;% kable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r}\rZooming in one some of the charts, it’s possible to see when we entered and exited each trade.\nHere - everything works. chart.posn plots each plot in sequence find a way to plot it in one instance.\nchart.Posn(Portfolio = \u0026#39;BollingerBandsStrat\u0026#39;, Symbol = \u0026quot;AMD\u0026quot;)\rplot(add_BBands(on = 1, sd = 1.6, n = 20))\rzoom_Chart(\u0026#39;2017-01::2017-03\u0026#39;)\rchart.Posn(Portfolio = \u0026#39;BollingerBandsStrat\u0026#39;, Symbol = \u0026quot;WMT\u0026quot;)\rplot(add_BBands(on = 1, sd = 1.6, n = 20))\rzoom_Chart(\u0026#39;2017-01::2017-03\u0026#39;)\rchart.Posn(Portfolio = \u0026#39;BollingerBandsStrat\u0026#39;, Symbol = \u0026quot;AMZN\u0026quot;)\rplot(add_BBands(on = 1, sd = 1.6, n = 20))\rzoom_Chart(\u0026#39;2017-01::2017-03\u0026#39;)\r\r\r\rADX: Directional Movement Index\rThe Directional Movement Index (DMI) Wilder (1978) tries to identify the direction an asset is moving towards through comparing previous highs and lows. It trys to determine if an asset is trending and to measure the strength of that trend. It has four components:\n\rPositive Direction Indicator (+DI): Computes the difference between todays high and the previous days high. - Helps identify the presence of an uptrend.\n\rNegative Direction Indicator (-DI): Computes the difference between todays low and the previous days low. - Helps identify the presence of a downtrend.\n\rAverage Directional Index (ADX): A smoothed average of the difference of the +DI and -DI.\n\rAverage Directional Rating (ADXR): Simple average of todays ADX and the ADX from 14 or n periods previously.\n\r\rThe ADX is relative to its own asset price. An ADX of 60 for \\(Asset_{i}\\) is different to an ADX for \\(Asset_{j}\\).\nUsing the TTR package along with the tidyquant package in R we can calculate the ADX using:\n# adx_calc \u0026lt;- asset_prices %\u0026gt;% # group_by(symbol) %\u0026gt;% # tq_mutate(\r# select = c(\u0026quot;high\u0026quot;, \u0026quot;low\u0026quot;, \u0026quot;close\u0026quot;),\r# mutate_fun = ADX,\r# n = 14,\r# maType = \u0026quot;SMA\u0026quot;\r# )\r# adx_calc %\u0026gt;% # group_by(symbol) %\u0026gt;% # drop_na() %\u0026gt;% # slice(1:5)\rThe first few observations of each of the assets looks like:\nWhere the newely created columns are defined as:\n\rDIp: Directional Index positive\rDIn: Directional Index negative\rDX: Directional Index\rADX: Average Directional Index which takes on values between 0 and 100\r\rAs defined previously.\n\r\rADX Trend Strength\r\r\rADX Value\rStrength\r\r\r\r0-25\rWeak Trend\r\r26-50\rStrong Trend\r\r51-75\rVery Strong\r\r76-100\rStrongestng\r\r\r\rWe can plot the ADX using the following, where I first put the Directional Index columns to longer format using the pivot_longer function and then take a random sample of the grouped data using a combination of group_by, nest and sample_n. Finally I filter the data between a period of 3 months and use ggplot to plot the data.\n# adx_calc %\u0026gt;% # pivot_longer(\r# cols = c(\u0026quot;DIp\u0026quot;, \u0026quot;DIn\u0026quot;, \u0026quot;ADX\u0026quot;),\r# names_to = \u0026quot;Indicator\u0026quot;,\r# values_to = \u0026quot;Indicator_value\u0026quot;\r# ) %\u0026gt;% # group_by(symbol) %\u0026gt;%\r# nest() %\u0026gt;%\r# ungroup() %\u0026gt;% # sample_n(2) %\u0026gt;%\r# unnest() %\u0026gt;% # filter(date \u0026gt; \u0026quot;2014-09-01\u0026quot; \u0026amp; date \u0026lt; \u0026quot;2015-01-01\u0026quot;) %\u0026gt;% # ggplot(aes(x = date, y = Indicator_value, color = Indicator)) +\r# geom_line() +\r# geom_dl(aes(label = Indicator), method = list(dl.combine(\u0026quot;first.points\u0026quot;, \u0026quot;last.points\u0026quot;))) +\r# facet_wrap(~symbol, scales = \u0026quot;free\u0026quot;) +\r# theme_tq()\rWe can create a simple trading strategy based on the ADX by:\n\rAdding a buy signal when the DIp is greater than the DIn and also when the ADX is greater than 30.\rWe will hold the asset until the DIp is less than the DIn.\rThis creates multiple consecutive rows of 1’s followed by consecutive rows of -1’s. Since we cannot “buy”, “buy” and “buy” and then followed by “sell”, “sell” and “sell” we will only take the first occurrence of the first “buy” and the first “sell”. I call this buy_here and sell_here.\r\r# adx_signals \u0026lt;- adx_calc %\u0026gt;% # mutate(\r# adx_signal_buy = case_when(\r# DIp \u0026gt; DIn \u0026amp; ADX \u0026gt; 30 ~ 1,\r# TRUE ~ 0\r# ),\r# adx_signal_buy_hold_until = case_when(\r# DIp \u0026lt; DIn ~ -1,\r# TRUE ~ 0\r# )\r# ) %\u0026gt;% # group_by(grp = rleid(adx_signal_buy)) %\u0026gt;% # mutate(buy_here = +(all(adx_signal_buy == 1) * row_number() == 1)) %\u0026gt;%\r# ungroup %\u0026gt;%\r# group_by(grp = rleid(adx_signal_buy_hold_until)) %\u0026gt;%\r# mutate(sell_here = -1 *(all(adx_signal_buy_hold_until == -1) * row_number() == 1)) %\u0026gt;%\r# ungroup %\u0026gt;%\r# select(-grp)\rWilder, J Welles. 1978. New Concepts in Technical Trading Systems. Trend Research.\n\r\r\r","date":1577577600,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1577577600,"objectID":"ccc056cf27b51a2495719a38d6661183","permalink":"/post/understanding-ttr-package/technical-trading-rules/","publishdate":"2019-12-29T00:00:00Z","relpermalink":"/post/understanding-ttr-package/technical-trading-rules/","section":"post","summary":"A simple backtested Bollinger-Band strategy and Directional Movement Index (ADX) strategy.","tags":["time-series","finance","quant finance","yahoo-finance","systematic trading","algo trading","technical analysis"],"title":"Quantitative Trading Strategies using quantmod","type":"post"},{"authors":["Matthew Smith"],"categories":["Mathematical Finance","Econometrics"],"content":"\r\r\r\r\r\r\r\r\r\r\r\r\r\r\rThe most popular models for analysing the risk of portfolios are factor models, since stocks have a tendency to move together. The principal component of securities often explains a large share of it’s variance. Since we are mostly concerned with multiple assets which form a portfolio we need to account for this. Some questions might be why do stocks with low Price to Book ratios outperform stocks with higher Price to Book ratios? Here the “Price” part of the ratio is simply the share price (per share) and the “Book” part of the ratio is the “Shareholders Equity” / “Shares Outstanding” which are items found on a companies Balance Sheet.\nAnother important reason Factor models are popular are dimensionality. Assume \\(N\\) assets which subsequently has \\(N\\) variances and \\(N(N-1)/2\\) correlations. If we have a factor model with \\(F\\) factors, it has \\(N\\) idiosyncratic variances, \\(F\\) factor variances and \\(NF\\) betas. As long as:\n\\[2F \u0026lt; N(N-1)/(N+1)\\]\nWe have fewer parameters with factor models.\nThe Capital Asset Pricing Model Sharpe (1964) is the simplest factor model consisting of a single factor.\n\\[r_i = a_i + b_if + e_i\\]\nThe mean-variance parameters are:\n\\[\\overline{r}_i = a_{i} + b_{i}\\overline{y}\\]\r\\[\\sigma_{i}^2 = b_{i}^2\\sigma_{\\epsilon_{i}}^2\\]\n\\[\\sigma_{ij} = b_{i}b_{j}\\sigma_{y}^2\\]\nThe \\(Cov(r_{i}, y) = Cov(a_{i} + b_{i}y + e_{i}, y) = b_{i}\\sigma_{y}^2\\) and therefore \\(b_{i}\\) is;\n\\[b_{i} = \\dfrac{Cov(r_{i}, y)}{\\sigma_{y}^2}\\]\nThis is alternatively expressed as;\n\\[b_{i} = Cov(r_{i}, y) / Var(y)\\]\nWhere \\(b\\) is the slope of the regression line which minimises the squared distance of returns and \\(a\\) is the intercept or \\(alpha\\) which are expressed on a line \\(a + bf\\).\nI will go through these calculations using Base R functions, however first we need some data and for this I like the tidy functions which require a few packages.\nI download daily price data from Yahoo Finance using quantmod or tidyquant’s wrapper to the quantmod package. The difference here being that quantmod collects data and stores it as an xts object and tidyquant collects the data and stores it as a tibble, from here we are able to more easily use functions from the tidyverse way of handling data, we convert the data back to an xts object using the tk_xts function from the timetk package.\nThe firms are Apple, Harley Davidson, Nvidia, Microsoft, AMD, Ford, General Electric, 3M, Intel and Amazon.\nlibrary(quantmod)\rlibrary(ggplot2)\rlibrary(tidyquant)\rlibrary(tidyr)\rlibrary(dplyr)\rlibrary(timetk)\rlibrary(tibble)\rlibrary(rvest)\rlibrary(corrplot) library(stringr)\rstart_date \u0026lt;- \u0026quot;2017-01-01\u0026quot;\rend_date \u0026lt;- \u0026quot;2019-01-01\u0026quot;\rsymbols \u0026lt;- c(\u0026quot;AAPL\u0026quot;, \u0026quot;HOG\u0026quot;, \u0026quot;NVDA\u0026quot;, \u0026quot;MSFT\u0026quot;, \u0026quot;AMD\u0026quot;, \u0026quot;F\u0026quot;, \u0026quot;GE\u0026quot;, \u0026quot;MMM\u0026quot;, \u0026quot;INTL\u0026quot;, \u0026quot;AMZN\u0026quot;)\rportfolio_prices \u0026lt;- tq_get(\rsymbols,\rfrom = start_date,\rto = end_date\r) %\u0026gt;%\rselect(symbol, date, adjusted) %\u0026gt;% pivot_wider(names_from = symbol, values_from = adjusted) %\u0026gt;% tk_xts(date_var = date)\rThe data looks like the following, I removed the Open, High, Low, Close and Volume data and kept just the Adjusted prices, where each asset is it’s own column, the data has been converted into a time series object or an xts object where the date is stored as the index (or rownames) and is not visable in the table below.\n\r\rAAPL\r\rHOG\r\rNVDA\r\rMSFT\r\rAMD\r\rF\r\rGE\r\rMMM\r\rINTL\r\rAMZN\r\r\r\r\r\r110.9539\r\r53.59669\r\r101.0116\r\r59.49657\r\r11.43\r\r10.43042\r\r28.13062\r\r165.3643\r\r40.41\r\r753.67\r\r\r\r110.8297\r\r54.18777\r\r103.3683\r\r59.23036\r\r11.43\r\r10.91093\r\r28.13950\r\r165.6151\r\r40.86\r\r757.18\r\r\r\r111.3933\r\r54.24233\r\r100.7443\r\r59.23036\r\r11.24\r\r10.57954\r\r27.97971\r\r165.0485\r\r38.77\r\r780.45\r\r\r\r112.6351\r\r53.74219\r\r102.0910\r\r59.74376\r\r11.32\r\r10.57126\r\r28.05961\r\r165.5315\r\r38.71\r\r795.99\r\r\r\r113.6668\r\r52.87832\r\r106.2301\r\r59.55362\r\r11.49\r\r10.46355\r\r27.92646\r\r164.6399\r\r38.33\r\r796.92\r\r\r\r113.7815\r\r53.19659\r\r105.4280\r\r59.53460\r\r11.44\r\r10.64582\r\r27.84656\r\r163.9991\r\r38.46\r\r795.90\r\r\r\r\rI also collect the S\u0026amp;P500 data using the same method:\nSPY \u0026lt;- tq_get(\r\u0026quot;^GSPC\u0026quot;,\rfrom = start_date,\rto = end_date\r) %\u0026gt;% select(date, adjusted) %\u0026gt;% tk_xts(date_var = date)\rWhich looks similar to the individual asset prices.\n\r\radjusted\r\r\r\r\r\r2257.83\r\r\r\r2270.75\r\r\r\r2269.00\r\r\r\r2276.98\r\r\r\r2268.90\r\r\r\r2268.90\r\r\r\r\rWe can plot the data using the chartSeries function.\nchartSeries(SPY)\rI compute the daily log returns for all the assets in the portfolio_returns and the SPY returns\nportfolio_returns \u0026lt;- diff(log(portfolio_prices), na.pad = FALSE)\rSPY_returns \u0026lt;- diff(log(SPY), na.pad = FALSE)\rThe returns data for each asset looks like:\n\r\rAAPL\r\rHOG\r\rNVDA\r\rMSFT\r\rAMD\r\rF\r\rGE\r\rMMM\r\rINTL\r\rAMZN\r\r\r\r\r\r-0.001119731\r\r0.010967925\r\r0.023062871\r\r-0.0044844490\r\r0.000000000\r\r0.0450387901\r\r0.0003155849\r\r0.001515279\r\r0.011074335\r\r0.004646413\r\r\r\r0.005072384\r\r0.001006252\r\r-0.025713094\r\r0.0000000000\r\r-0.016762633\r\r-0.0308429974\r\r-0.0056944999\r\r-0.003426713\r\r-0.052504862\r\r0.030269695\r\r\r\r0.011086527\r\r-0.009263191\r\r0.013278832\r\r0.0086305184\r\r0.007092228\r\r-0.0007833275\r\r0.0028513212\r\r0.002921873\r\r-0.001548813\r\r0.019715919\r\r\r\r0.009117836\r\r-0.016204986\r\r0.039742771\r\r-0.0031877844\r\r0.014906019\r\r-0.0102405428\r\r-0.0047565496\r\r-0.005400948\r\r-0.009865007\r\r0.001167666\r\r\r\r0.001008053\r\r0.006000910\r\r-0.007578959\r\r-0.0003193095\r\r-0.004361106\r\r0.0172690614\r\r-0.0028650791\r\r-0.003899774\r\r0.003385783\r\r-0.001280696\r\r\r\r0.005358706\r\r-0.008411454\r\r-0.012380417\r\r0.0090613598\r\r-0.021202208\r\r-0.0141067872\r\r0.0031828276\r\r0.007391130\r\r0.009059257\r\r0.003912422\r\r\r\r\rWe can use the autoplot to plot xts or time series data with ggplot functionality, (I only plot the first 3 assets):\nautoplot(portfolio_returns[,1:3]) +\rxlab(\u0026quot;Date\u0026quot;) +\rggtitle(\u0026quot;Asset Log Returns\u0026quot;) +\rtheme_tq()\rTechnical R:\rFrom here I will talk a little more technically but will keep it as simple as possible.\rNext I compute the calculations described at the begining of the post. We first need to define a few things:\n\rThe number of assets we have in the portfolio, denoted previously as \\(N\\)\rThe number of days we apply our model which is usually denoted as \\(T\\).\r\rN_portfolio \u0026lt;- ncol(portfolio_prices)\rdays \u0026lt;- nrow(portfolio_prices)\r\r(a) We can compute \\(\\beta\\) as the following:\rbeta \u0026lt;- cov(portfolio_returns, SPY_returns) / as.numeric(var(SPY_returns))\rWhich returns:\n\r\r\radjusted\r\r\r\r\r\rAAPL\r\r1.2722563\r\r\r\rHOG\r\r0.8957108\r\r\r\rNVDA\r\r1.9681667\r\r\r\rMSFT\r\r1.4221581\r\r\r\rAMD\r\r1.8544079\r\r\r\rF\r\r0.8626349\r\r\r\r\rHowever, in order to understand it better we can break it down each of the computations:\nThe \\(cov\\) covariance matrix part of the \\(beta\\) formula looks like:\r\r\r\radjusted\r\r\r\r\r\rAAPL\r\r0.0000852\r\r\r\rHOG\r\r0.0000600\r\r\r\rNVDA\r\r0.0001318\r\r\r\rMSFT\r\r0.0000953\r\r\r\rAMD\r\r0.0001242\r\r\r\rF\r\r0.0000578\r\r\r\rGE\r\r0.0000548\r\r\r\rMMM\r\r0.0000714\r\r\r\rINTL\r\r0.0000576\r\r\r\rAMZN\r\r0.0001056\r\r\r\r\rWe can compute the covariances using base R as follows:\n\\[Cov(x, y) = \\sum_{i=1}^N \\dfrac{((x_i - \\overline{x}) (y_{i} - \\overline{y}))}{(n-1)}\\]\rWhere \\(x_{i}\\) is our asset and \\(y_{i}\\) is the SPY500. In R we can compute this as:\nx = portfolio_returns[,1] # which takes the first Asset in the portfolio_returns data\rx_bar = colMeans(x)\ry = SPY_returns[,1]\ry_bar = colMeans(y)\rn = length(x)\rsum(((x - x_bar)*(y - y_bar))) / (n-1)\r## [1] 0.00008521578\rWhich corresponds to the first result, AAPL in the cov(portfolio_returns, SPY_returns) calculation. We can change the \\(1\\) in x = portfolio_returns[,1] to \\(2\\), \\(3\\), \\(4\\) … \\(N\\) to compute the covariances for each of the assets (HOG, NVDA and MSFT, respectively), or we can wrap the above into a for loop to compute for all assets. Note: I only changed the \\(1\\) to an \\(i\\) from the above equation in the for loop, everything else is constant.\nfor(i in 1:ncol(portfolio_returns)){\rx = portfolio_returns[,i]\rx_bar = colMeans(x)\ry = SPY_returns[,1]\ry_bar = colMeans(y)\rcov_x_y = sum(((x - x_bar)*(y - y_bar))) / (n-1)\rprint(cov_x_y)\r}\r## [1] 0.00008521578\r## [1] 0.00005999475\r## [1] 0.0001318279\r## [1] 0.00009525621\r## [1] 0.0001242083\r## [1] 0.00005777932\r## [1] 0.00005477266\r## [1] 0.00007136762\r## [1] 0.0000575575\r## [1] 0.0001056044\rThe variance of the SPY returns is.\n\r\rx\r\r\r\r\r\r0.000067\r\r\r\r\rWhich is calculated as:\n\\[Var = \\sum(\\dfrac{((y - \\overline{y})^2)} {(n-1)})\\]\rIn base R we can simply calculate it as:\nn = length(SPY_returns)\ry = SPY_returns[,1]\ry_bar = colMeans(y)\rsum(((y - y_bar)**2) / (n-1))\r## [1] 0.00006698004\rPutting all this together, we can compute \\(beta\\). Recall, that \\(\\beta = \\dfrac{Cov(r_{i}, y)}{Var(y)}\\) where here \\(r_{i}\\) is each of our assets in our portfolio and \\(y\\) is the market returns or SPY500 returns.\nTo compute \\(beta\\) for each of our assets using base R we can wrap the above code into a function:\nmyBetaComputation \u0026lt;- function(ASSET){\rx = ASSET # which Asset in the portfolio_returns data we want to compute beta for.\rx_bar = colMeans(x)\ry = SPY_returns[,1]\ry_bar = colMeans(y)\rcov_x_y \u0026lt;- sum(((x - x_bar)*(y - y_bar))) / (n-1)\rn = length(SPY_returns)\ry = SPY_returns[,1]\ry_bar = colMeans(y)\rvar_y \u0026lt;- sum(((y - y_bar)**2) / (n-1))\rreturn(cov_x_y / var_y)\r}\rWe can apply this function to individual assets in our data and then all of them:\nmyBetaComputation(portfolio_returns[,1]) # Computes for the first asset\r## [1] 1.272256\rmyBetaComputation(portfolio_returns[,2]) # Computes for the second asset\r## [1] 0.8957108\rsapply(portfolio_returns, myBetaComputation) # Computes for all assets\r## AAPL HOG NVDA MSFT AMD F GE MMM ## 1.2722563 0.8957108 1.9681667 1.4221581 1.8544079 0.8626349 0.8177459 1.0655057 ## INTL AMZN ## 0.8593232 1.5766544\rThe interpretation here is that a value of 1 indicates that the asset moves in perfect correlation with the market, values \\(\u0026gt;\\) 1 indicate that an asset moves more than when the market moves or moves with more volatility when the market moves and values \\(\u0026lt;\\) 1 indicates that an asset moves less than the market.\nTypically Tech stocks have a higher market \\(\\beta\\) whereas mature non-tech stocks have a lower market \\(\\beta\\). That is, AAPL, NVDA, MSFT and AMD all have betas above 1 whereas HOG and Ford (F) have \\(\\beta\\)’s less than 1.\n\r(b) We can compute \\(\\alpha\\) as the following:\rNow that we have \\(\\beta\\) we can estimate \\(\\alpha\\) for each of our assets in our portfolio.\nRecall, that alpha is defined as;\n\\[\\alpha = \\overline{r_{i}} - \\beta_{i}*\\overline{f}\\]\nWhere \\(\\overline{r_{i}}\\) is the average returns of our individual assets in our portfolio, \\(\\beta_{i}\\) is the beta of each asset over our sample period and \\(\\overline{f}\\) is the average returns of SPY. Therefore, we can compute \\(\\alpha\\) as;\nalpha \u0026lt;- colMeans(portfolio_returns) - beta*colMeans(SPY_returns)\rThe alpha or \\(\\alpha\\) for our assests, looks like:\n\r\r\radjusted\r\r\r\r\r\rAAPL\r\r0.0004068\r\r\r\rHOG\r\r-0.0011516\r\r\r\rNVDA\r\r0.0001393\r\r\r\rMSFT\r\r0.0007480\r\r\r\rAMD\r\r0.0005696\r\r\r\rF\r\r-0.0009272\r\r\r\r\rThere are other ways to calculate \\(\\beta\\) and \\(\\alpha\\) but for a single factor model we can use the CAPM.beta and CAPM.alpha from the PerformanceAnalytics package.\nlibrary(PerformanceAnalytics)\rCAPM.beta(Ra = portfolio_returns, Rb = SPY_returns, Rf = 0)\r## AAPL HOG NVDA MSFT AMD F\r## Beta: adjusted 1.272256 0.8957108 1.968167 1.422158 1.854408 0.8626349\r## GE MMM INTL AMZN\r## Beta: adjusted 0.8177459 1.065506 0.8593232 1.576654\rCAPM.alpha(Ra = portfolio_returns, Rb = SPY_returns, Rf = 0)\r## AAPL HOG NVDA MSFT AMD\r## Alpha: adjusted 0.000406813 -0.001151611 0.0001393021 0.0007480208 0.0005695635\r## F GE MMM INTL\r## Alpha: adjusted -0.0009272497 -0.002875334 0.00001141014 -0.0003782044\r## AMZN\r## Alpha: adjusted 0.001047154\rWhich is much simpler than what we just did. The Ra is the asset returns, Rb is the market returns and Rf is the risk-free rate of return.\nUpon investigating the CAPM.beta functions from the PerformanceAnalytics package I noticed they had functions for CAPM.beta.bull and CAPM.beta.bear, so I wanted to see how these would look like plotted for each asset.\nrbind(\rCAPM.beta.bull(Ra = portfolio_returns, Rb = SPY_returns, Rf = 0),\rCAPM.beta(Ra = portfolio_returns, Rb = SPY_returns, Rf = 0),\rCAPM.beta.bear(Ra = portfolio_returns, Rb = SPY_returns, Rf = 0)\r) %\u0026gt;% as_tibble(rownames = NA) %\u0026gt;% rownames_to_column(\u0026quot;betas\u0026quot;) %\u0026gt;% pivot_longer(2:ncol(.)) %\u0026gt;% ggplot(aes(x = name, y = value, color = betas)) +\rgeom_point(size = 5, shape = 19) +\rscale_color_brewer(type=\u0026#39;seq\u0026#39;, palette=\u0026#39;Reds\u0026#39;) +\rtheme_tq() +\rggtitle(\u0026quot;Asset Betas:\u0026quot;, subtitle = \u0026quot;Bear, Beta, Bull\u0026quot;)\rInteresting…\n\r\rVisualising the covariance matrix of the returns\rIn order to visualise the the covariance matrix some further formulas are needed.\nUltimately we want to compute the following;\n\\[\\hat{\\Sigma} = var(y)\\hat{\\beta} \\hat{\\beta}^T + \\hat{\\psi}\\]\rWhere;\r\\[\\hat{\\psi} = diag(\\hat{\\sigma}_{1}^2, ... \\hat{\\sigma}_{i}^2, ... \\hat{\\sigma}_{N}^2)\\]\nWe use our \\(\\beta\\) and \\(\\alpha\\) results from before as well as \\(N\\). I created a function which takes in the \\(asset\\) and computes the residules and Sigma values. What we are calculating here is the following;\nerr\r\\[\\hat{\\epsilon_{i}} = x_{i} - \\alpha_{i} - \\beta_{i}*y\\]\nWhere \\(i = 1.,..., N\\)\nSigma\r\\[\\hat{\\sigma}_{i}^2 = \\dfrac{1} {N-2}\\hat{\\epsilon}_{i}^N\\epsilon_{i}\\]\nThe code in base R for the above equations is:\nbeta \u0026lt;- cov(portfolio_returns, SPY_returns) / as.numeric(var(SPY_returns))\ralpha \u0026lt;- colMeans(portfolio_returns) - beta*colMeans(SPY_returns)\rN = length(SPY_returns)\rmySigmaFunction \u0026lt;- function(ASSET){\rerr = portfolio_returns[, ASSET] - alpha[ASSET ,] - beta[ASSET ,] * SPY_returns\rSigma = (1 / (N - 2)) %*% t(err) %*% err\rreturn(Sigma)\r}\rmySigmaFunction(\u0026quot;AAPL\u0026quot;) # For Apple\r## AAPL\r## [1,] 0.0001178595\rmySigmaFunction(\u0026quot;F\u0026quot;) # For Ford\r## F\r## [1,] 0.0001599711\rsapply(colnames(portfolio_returns), mySigmaFunction) # For all assets in the portfolio\r## AAPL HOG NVDA MSFT AMD ## 0.00011785947 0.00021461371 0.00056144410 0.00006590872 0.00126760753 ## F GE MMM INTL AMZN ## 0.00015997110 0.00035027461 0.00007165307 0.00019184188 0.00017665040\rNow that we have the \\(\\sigma\\) values. we want to create a matrix with the Sigma values down the digaonal.\nSigma2 \u0026lt;- sapply(colnames(portfolio_returns), mySigmaFunction)\rdiag_Sigma2 \u0026lt;- diag(Sigma2)\rcolnames(diag_Sigma2) = colnames(portfolio_returns)\rrownames(diag_Sigma2) = colnames(portfolio_returns)\rWhich creates our diagonal matrix as follows:\n\r\r\rAAPL\r\rHOG\r\rNVDA\r\rMSFT\r\rAMD\r\rF\r\rGE\r\rMMM\r\rINTL\r\rAMZN\r\r\r\r\r\rAAPL\r\r0.0001179\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.00000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r\r\rHOG\r\r0.0000000\r\r0.0002146\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.00000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r\r\rNVDA\r\r0.0000000\r\r0.0000000\r\r0.0005614\r\r0.0000000\r\r0.0000000\r\r0.00000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r\r\rMSFT\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000659\r\r0.0000000\r\r0.00000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r\r\rAMD\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0012676\r\r0.00000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r\r\rF\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.00016\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r\r\rGE\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.00000\r\r0.0003503\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r\r\rMMM\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.00000\r\r0.0000000\r\r0.0000717\r\r0.0000000\r\r0.0000000\r\r\r\rINTL\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.00000\r\r0.0000000\r\r0.0000000\r\r0.0001918\r\r0.0000000\r\r\r\rAMZN\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.00000\r\r0.0000000\r\r0.0000000\r\r0.0000000\r\r0.0001767\r\r\r\r\rNow that we have our diagonal matrix \\(Diag(\\psi)\\) we can compute the covariance matrix of the returns using: \\[\\Sigma = var(y)\\beta \\beta^T + \\psi\\]\nThen use the cov2cor function from the stats package.\nSigma \u0026lt;- as.numeric(var(SPY_returns)) * beta %*% t(beta) + diag_Sigma2\rcorrplot(cov2cor(Sigma), main = \u0026quot;Covariance matrix of Portfolio Assets\u0026quot;)\rThe correlation table looks like:\n\r\r\rAAPL\r\rHOG\r\rNVDA\r\rMSFT\r\rAMD\r\rF\r\rGE\r\rMMM\r\rINTL\r\rAMZN\r\r\r\r\r\rAAPL\r\r1.0000000\r\r0.3097538\r\r0.3891498\r\r0.5677312\r\r0.2714307\r\r0.3373737\r\r0.2330694\r\r0.4966757\r\r0.3133839\r\r0.4821634\r\r\r\rHOG\r\r0.3097538\r\r1.0000000\r\r0.2515805\r\r0.3670311\r\r0.1754765\r\r0.2181079\r\r0.1506764\r\r0.3210946\r\r0.2025988\r\r0.3117126\r\r\r\rNVDA\r\r0.3891498\r\r0.2515805\r\r1.0000000\r\r0.4611084\r\r0.2204547\r\r0.2740132\r\r0.1892978\r\r0.4033975\r\r0.2545288\r\r0.3916107\r\r\r\rMSFT\r\r0.5677312\r\r0.3670311\r\r0.4611084\r\r1.0000000\r\r0.3216216\r\r0.3997582\r\r0.2761668\r\r0.5885171\r\r0.3713324\r\r0.5713213\r\r\r\rAMD\r\r0.2714307\r\r0.1754765\r\r0.2204547\r\r0.3216216\r\r1.0000000\r\r0.1911233\r\r0.1320346\r\r0.2813684\r\r0.1775330\r\r0.2731471\r\r\r\rF\r\r0.3373737\r\r0.2181079\r\r0.2740132\r\r0.3997582\r\r0.1911233\r\r1.0000000\r\r0.1641118\r\r0.3497257\r\r0.2206640\r\r0.3395071\r\r\r\rGE\r\r0.2330694\r\r0.1506764\r\r0.1892978\r\r0.2761668\r\r0.1320346\r\r0.1641118\r\r1.0000000\r\r0.2416026\r\r0.1524423\r\r0.2345432\r\r\r\rMMM\r\r0.4966757\r\r0.3210946\r\r0.4033975\r\r0.5885171\r\r0.2813684\r\r0.3497257\r\r0.2416026\r\r1.0000000\r\r0.3248576\r\r0.4998164\r\r\r\rINTL\r\r0.3133839\r\r0.2025988\r\r0.2545288\r\r0.3713324\r\r0.1775330\r\r0.2206640\r\r0.1524423\r\r0.3248576\r\r1.0000000\r\r0.3153656\r\r\r\rAMZN\r\r0.4821634\r\r0.3117126\r\r0.3916107\r\r0.5713213\r\r0.2731471\r\r0.3395071\r\r0.2345432\r\r0.4998164\r\r0.3153656\r\r1.0000000\r\r\r\r\r\rETF analysis and a randomly sampled portfolio\rAnalysing my randomly selected portfolio and a series of U.S. funds\rSince factor modelling is all about risk and portfolio analysis I thought it would be interesting to compare the performance of a number of U.S. Exchnage Traded Funds (ETFs) and a randomly selected portfolio of assets from the SP500.\nIn order to construct the randomly created portfolio I first scraped the wikipedia page which contains the list of SP500 firms along with their ticker symbol, I filter out all Class A, B and C shares since a few firms have multiple asset classes and I don’t want to sample two of the same asset.\nJust as before I collect the data and put it into time series format.\nstart_date \u0026lt;- \u0026quot;2016-01-01\u0026quot;\rend_date \u0026lt;- \u0026quot;2017-12-31\u0026quot;\rset.seed(4746)\rurl \u0026lt;- \u0026quot;https://en.wikipedia.org/wiki/List_of_S%26P_500_companies\u0026quot;\rsymbols \u0026lt;- url %\u0026gt;%\rread_html() %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;constituents\u0026quot;]\u0026#39;) %\u0026gt;% html_table() %\u0026gt;% .[[1]] %\u0026gt;% filter(!str_detect(Security, \u0026quot;Class A|Class B|Class C\u0026quot;)) %\u0026gt;% # Removes firms with Class A shares\rsample_n(20) %\u0026gt;% pull(Symbol)\rasset_prices \u0026lt;- tq_get(\rsymbols,\rfrom = start_date,\rto = end_date\r) %\u0026gt;%\rselect(symbol, date, adjusted) %\u0026gt;% pivot_wider(names_from = symbol, values_from = adjusted) %\u0026gt;% tk_xts(date_var = date)\rWhich looks like:\n\r\rMMM\r\rMNST\r\rTJX\r\rTMUS\r\rNWL\r\rINTC\r\rEIX\r\rXRX\r\rGPN\r\rHES\r\rTIF\r\rIR\r\rGRMN\r\rDRI\r\rGLW\r\rZTS\r\rCCI\r\rBK\r\r\r\r\r\r132.8015\r\r48.11333\r\r33.27088\r\r38.95\r\r38.54331\r\r30.45350\r\r51.77293\r\r24.64223\r\r62.47044\r\r44.85172\r\r68.47929\r\r51.15904\r\r30.85206\r\r55.28202\r\r16.24429\r\r45.97239\r\r73.96610\r\r36.90321\r\r\r\r133.3804\r\r48.69000\r\r33.79228\r\r40.22\r\r38.52557\r\r30.31014\r\r51.79048\r\r24.59438\r\r63.43876\r\r44.74931\r\r68.27712\r\r50.61163\r\r30.96944\r\r56.28635\r\r16.23521\r\r46.69207\r\r75.48198\r\r36.76471\r\r\r\r130.6940\r\r48.76667\r\r32.92327\r\r40.05\r\r37.46084\r\r29.63818\r\r51.44798\r\r24.28336\r\r63.63840\r\r41.95655\r\r67.00899\r\r49.53537\r\r30.12268\r\r55.86901\r\r15.87241\r\r46.70180\r\r74.84963\r\r35.84144\r\r\r\r127.5101\r\r48.40000\r\r32.87630\r\r40.51\r\r35.78388\r\r28.52719\r\r51.19327\r\r23.61348\r\r61.25259\r\r40.60672\r\r65.17110\r\r48.06017\r\r29.25916\r\r55.47833\r\r15.50961\r\r45.28187\r\r72.98727\r\r34.93664\r\r\r\r127.0759\r\r48.08333\r\r31.43894\r\r39.88\r\r34.94097\r\r28.23153\r\r51.18450\r\r22.94359\r\r60.07465\r\r40.56948\r\r62.72673\r\r47.60556\r\r28.12736\r\r55.06099\r\r15.55497\r\r44.62054\r\r71.96515\r\r34.29958\r\r\r\r127.0488\r\r48.68000\r\r31.84760\r\r39.68\r\r34.91435\r\r28.72431\r\r51.99249\r\r22.48903\r\r58.41755\r\r38.81003\r\r62.34076\r\r47.76327\r\r27.83393\r\r55.01660\r\r15.70009\r\r43.35622\r\r72.49354\r\r34.54886\r\r\r\r\rNext, I collect the U.S. ETFs. I scraped a website (which I cannot remember the name) for the symbols of the ETFs.\nmyETFs \u0026lt;- c(\u0026quot;SPY\u0026quot;, \u0026quot;IVV\u0026quot;, \u0026quot;VTI\u0026quot;, \u0026quot;VOO\u0026quot;, \u0026quot;QQQ\u0026quot;, \u0026quot;VEA\u0026quot;, \u0026quot;IEFA\u0026quot;, \u0026quot;AGG\u0026quot;, \u0026quot;VWO\u0026quot;,\r\u0026quot;EFA\u0026quot;,\u0026quot;IEMG\u0026quot;,\u0026quot;VTV\u0026quot;, \u0026quot;IJH\u0026quot;, \u0026quot;IWF\u0026quot;,\u0026quot;BND\u0026quot;, \u0026quot;IJR\u0026quot;, \u0026quot;IWM\u0026quot;, \u0026quot;VUG\u0026quot;,\r\u0026quot;GLD\u0026quot;, \u0026quot;IWD\u0026quot;, \u0026quot;VIG\u0026quot;, \u0026quot;VNQ\u0026quot;, \u0026quot;USMV\u0026quot;, \u0026quot;LQD\u0026quot;, \u0026quot;VO\u0026quot;, \u0026quot;VYM\u0026quot;, \u0026quot;EEM\u0026quot;,\r\u0026quot;VB\u0026quot;, \u0026quot;VCSH\u0026quot;, \u0026quot;XLF\u0026quot;, \u0026quot;VCIT\u0026quot;, \u0026quot;VEU\u0026quot;, \u0026quot;XLK\u0026quot;, \u0026quot;ITOT\u0026quot;, \u0026quot;IVW\u0026quot;, \u0026quot;BNDX\u0026quot;,\r\u0026quot;VGT\u0026quot;, \u0026quot;DIA\u0026quot;, \u0026quot;BSV\u0026quot;, \u0026quot;SHV\u0026quot;, \u0026quot;IWB\u0026quot;, \u0026quot;IWR\u0026quot;, \u0026quot;TIP\u0026quot;, \u0026quot;SCHF\u0026quot;, \u0026quot;MBB\u0026quot;, \u0026quot;SDY\u0026quot;,\r\u0026quot;MDY\u0026quot;, \u0026quot;SCHX\u0026quot;, \u0026quot;IEF\u0026quot;, \u0026quot;HYG\u0026quot;, \u0026quot;DVY\u0026quot;, \u0026quot;XLV\u0026quot;, \u0026quot;SHY\u0026quot;, \u0026quot;IXUS\u0026quot;, \u0026quot;TLT\u0026quot;, \u0026quot;IVE\u0026quot;,\r\u0026quot;PFF\u0026quot;, \u0026quot;IAU\u0026quot;, \u0026quot;VXUS\u0026quot;, \u0026quot;RSP\u0026quot;, \u0026quot;SCHB\u0026quot;, \u0026quot;VV\u0026quot;, \u0026quot;GOVT\u0026quot;, \u0026quot;EMB\u0026quot;, \u0026quot;MUB\u0026quot;, \u0026quot;QUAL\u0026quot;,\r\u0026quot;XLY\u0026quot;, \u0026quot;VBR\u0026quot;, \u0026quot;EWJ\u0026quot;, \u0026quot;XLP\u0026quot;, \u0026quot;VGK\u0026quot;, \u0026quot;SPLV\u0026quot;, \u0026quot;MINT\u0026quot;, \u0026quot;BIV\u0026quot;, \u0026quot;IGSB\u0026quot;, \u0026quot;EFAV\u0026quot;,\r\u0026quot;VT\u0026quot;, \u0026quot;GDX\u0026quot;, \u0026quot;XLU\u0026quot;, \u0026quot;IWS\u0026quot;, \u0026quot;XLI\u0026quot;, \u0026quot;SCHD\u0026quot;, \u0026quot;IWP\u0026quot;, \u0026quot;ACWI\u0026quot;, \u0026quot;VMBS\u0026quot;, \u0026quot;XLE\u0026quot;, \u0026quot;JNK\u0026quot;,\r\u0026quot;VOE\u0026quot;, \u0026quot;FLOT\u0026quot;, \u0026quot;IWV\u0026quot;, \u0026quot;JPST\u0026quot;, \u0026quot;SCZ\u0026quot;, \u0026quot;IEI\u0026quot;, \u0026quot;IWN\u0026quot;, \u0026quot;DGRO\u0026quot;, \u0026quot;VBK\u0026quot;, \u0026quot;IGIB\u0026quot;, \u0026quot;IWO\u0026quot;)\retf_prices \u0026lt;- tq_get(\rmyETFs,\rfrom = start_date,\rto = end_date\r) %\u0026gt;% select(symbol, date, adjusted) %\u0026gt;% pivot_wider(names_from = symbol, values_from = adjusted) %\u0026gt;% tk_xts(date_var = date)\rThe data looks like:\n\r\rSPY\r\rIVV\r\rVTI\r\rVOO\r\rQQQ\r\rVEA\r\rIEFA\r\rAGG\r\rVWO\r\rEFA\r\rIEMG\r\rVTV\r\rIJH\r\rIWF\r\rBND\r\rIJR\r\rIWM\r\rVUG\r\rGLD\r\rIWD\r\rVIG\r\rVNQ\r\rUSMV\r\rLQD\r\rVO\r\rVYM\r\rEEM\r\rVB\r\rVCSH\r\rXLF\r\rVCIT\r\rVEU\r\rXLK\r\rITOT\r\rIVW\r\rBNDX\r\rVGT\r\rDIA\r\rBSV\r\rSHV\r\rIWB\r\rIWR\r\rTIP\r\rSCHF\r\rMBB\r\rSDY\r\rMDY\r\rSCHX\r\rIEF\r\rHYG\r\rDVY\r\rXLV\r\rSHY\r\rIXUS\r\rTLT\r\rIVE\r\rPFF\r\rIAU\r\rVXUS\r\rRSP\r\rSCHB\r\rVV\r\rGOVT\r\rEMB\r\rMUB\r\rQUAL\r\rXLY\r\rVBR\r\rEWJ\r\rXLP\r\rVGK\r\rSPLV\r\rMINT\r\rBIV\r\rIGSB\r\rEFAV\r\rVT\r\rGDX\r\rXLU\r\rIWS\r\rXLI\r\rSCHD\r\rIWP\r\rACWI\r\rVMBS\r\rXLE\r\rJNK\r\rVOE\r\rFLOT\r\rIWV\r\rJPST\r\rSCZ\r\rIEI\r\rIWN\r\rDGRO\r\rVBK\r\rIGIB\r\rIWO\r\r\r\r\r\r186.8362\r\r187.3943\r\r95.69553\r\r171.0293\r\r105.7754\r\r32.31758\r\r48.12894\r\r97.70714\r\r28.82161\r\r51.85117\r\r35.29821\r\r73.21329\r\r129.8436\r\r93.32362\r\r72.46418\r\r51.13569\r\r104.60918\r\r99.84885\r\r102.89\r\r88.57166\r\r71.16028\r\r67.15640\r\r38.30936\r\r100.1451\r\r112.0916\r\r58.70417\r\r29.25530\r\r103.10962\r\r71.86420\r\r13.61419\r\r73.99710\r\r38.23042\r\r39.89517\r\r42.61963\r\r107.9444\r\r48.90886\r\r101.77430\r\r156.9451\r\r74.18727\r\r105.2681\r\r104.11566\r\r37.17856\r\r101.8868\r\r24.86581\r\r97.72220\r\r63.99211\r\r238.7614\r\r44.54472\r\r98.23306\r\r65.49518\r\r65.93277\r\r66.68895\r\r80.17432\r\r44.14714\r\r110.3894\r\r80.04479\r\r31.46391\r\r10.38\r\r39.78462\r\r71.26929\r\r45.05346\r\r85.64318\r\r23.57018\r\r87.65514\r\r101.0075\r\r59.58526\r\r72.85894\r\r90.46735\r\r45.07748\r\r45.11800\r\r43.21453\r\r34.96312\r\r93.40020\r\r75.13937\r\r48.21395\r\r57.09138\r\r51.90483\r\r13.86359\r\r38.17657\r\r62.81808\r\r48.48287\r\r34.12284\r\r87.50332\r\r50.81642\r\r48.00686\r\r53.82844\r\r80.80476\r\r78.58987\r\r46.91737\r\r110.6951\r\rNA\r\r45.01355\r\r115.1113\r\r84.09489\r\r23.20199\r\r115.5700\r\r47.86354\r\r131.6090\r\r\r\r187.1522\r\r187.7839\r\r95.90974\r\r171.3355\r\r105.5919\r\r32.28184\r\r48.04810\r\r97.75242\r\r28.88509\r\r51.77047\r\r35.38096\r\r73.44967\r\r129.9475\r\r93.46677\r\r72.55397\r\r51.29261\r\r104.83739\r\r99.86796\r\r103.18\r\r88.74566\r\r71.39217\r\r68.45230\r\r38.56908\r\r100.1978\r\r112.2051\r\r58.99791\r\r29.32071\r\r103.16643\r\r71.84602\r\r13.66662\r\r74.01466\r\r38.14082\r\r39.79135\r\r42.69417\r\r108.1532\r\r48.88116\r\r101.28743\r\r157.0367\r\r74.17794\r\r105.2777\r\r104.32082\r\r37.26314\r\r101.8220\r\r24.83831\r\r97.79476\r\r64.25666\r\r238.8375\r\r44.63781\r\r98.20529\r\r65.61782\r\r66.33069\r\r67.00954\r\r80.12685\r\r44.10166\r\r109.9440\r\r80.26437\r\r31.49616\r\r10.40\r\r39.71283\r\r71.43853\r\r45.09076\r\r85.81048\r\r23.54203\r\r87.88744\r\r101.1264\r\r59.74447\r\r72.76409\r\r90.67188\r\r45.64425\r\r45.40763\r\r42.95955\r\r35.24865\r\r93.40020\r\r75.22964\r\r48.19091\r\r57.19847\r\r51.91398\r\r13.79471\r\r38.45059\r\r62.96579\r\r48.61266\r\r34.31977\r\r87.66763\r\r50.86277\r\r48.09793\r\r54.03376\r\r80.97237\r\r78.76543\r\r46.90808\r\r110.9662\r\rNA\r\r44.89528\r\r115.1582\r\r84.47743\r\r23.28449\r\r115.6185\r\r47.92159\r\r131.6866\r\r\r\r184.7914\r\r185.3255\r\r94.62438\r\r169.1641\r\r104.5776\r\r31.69214\r\r47.20373\r\r98.12343\r\r28.36815\r\r50.91853\r\r34.74654\r\r72.40415\r\r128.1251\r\r92.48373\r\r72.87716\r\r50.70773\r\r103.23986\r\r98.76987\r\r104.67\r\r87.39035\r\r70.52956\r\r68.26473\r\r38.32790\r\r100.5933\r\r110.1342\r\r58.22349\r\r28.76008\r\r101.62282\r\r71.87331\r\r13.45691\r\r74.25190\r\r37.48678\r\r39.30056\r\r42.08852\r\r106.9669\r\r49.06577\r\r99.91275\r\r154.7919\r\r74.26179\r\r105.2586\r\r102.94081\r\r36.64525\r\r102.1459\r\r24.37987\r\r98.11230\r\r63.51594\r\r235.4678\r\r44.06064\r\r98.79820\r\r65.61782\r\r65.65863\r\r66.46268\r\r80.17432\r\r43.33769\r\r111.4255\r\r79.06572\r\r31.42361\r\r10.57\r\r39.03973\r\r70.13145\r\r44.53121\r\r84.68593\r\r23.63587\r\r87.87912\r\r101.5744\r\r59.03268\r\r72.05276\r\r89.25890\r\r44.85076\r\r45.25377\r\r42.24736\r\r34.93548\r\r93.40947\r\r75.53665\r\r48.22778\r\r56.64514\r\r51.14435\r\r14.02101\r\r38.37987\r\r61.87635\r\r47.86177\r\r33.90801\r\r86.25658\r\r50.09352\r\r48.20723\r\r51.95383\r\r80.90055\r\r77.24093\r\r46.90808\r\r109.4701\r\rNA\r\r44.14021\r\r115.4954\r\r83.48843\r\r22.96364\r\r113.8152\r\r47.99304\r\r129.3380\r\r\r\r180.3579\r\r180.8912\r\r92.30511\r\r165.0441\r\r101.3029\r\r31.09350\r\r46.30547\r\r98.11440\r\r27.45217\r\r49.86035\r\r33.69835\r\r70.71315\r\r124.8108\r\r90.12631\r\r72.88611\r\r49.40485\r\r100.48224\r\r96.22995\r\r106.15\r\r85.32989\r\r69.23102\r\r66.93474\r\r37.70643\r\r100.6724\r\r107.6568\r\r56.96841\r\r27.87242\r\r98.88598\r\r71.90975\r\r13.07825\r\r74.29585\r\r36.68042\r\r38.13966\r\r41.07753\r\r104.2529\r\r48.99192\r\r96.69561\r\r151.1452\r\r74.37366\r\r105.2681\r\r100.43254\r\r35.80653\r\r102.0626\r\r23.93059\r\r98.23930\r\r62.23734\r\r229.4516\r\r43.00870\r\r99.01125\r\r65.19263\r\r64.49137\r\r65.11437\r\r80.20277\r\r42.43728\r\r111.6255\r\r77.26316\r\r31.22207\r\r10.72\r\r38.23201\r\r68.54225\r\r43.44009\r\r82.62268\r\r23.68278\r\r87.46435\r\r101.7207\r\r57.62780\r\r70.57320\r\r87.00002\r\r44.17064\r\r44.71072\r\r41.46484\r\r34.35522\r\r93.40020\r\r75.63598\r\r48.24622\r\r55.87762\r\r49.95324\r\r14.64089\r\r38.12353\r\r60.51917\r\r46.56396\r\r33.20084\r\r84.22703\r\r48.92575\r\r48.27098\r\r50.68622\r\r80.46945\r\r75.47622\r\r46.91737\r\r106.8519\r\rNA\r\r43.46700\r\r115.7578\r\r81.26778\r\r22.53279\r\r110.6160\r\r48.06894\r\r125.7083\r\r\r\r178.3782\r\r178.8873\r\r91.25257\r\r163.2903\r\r100.4722\r\r30.70930\r\r45.71261\r\r98.33157\r\r27.20731\r\r49.25951\r\r33.37653\r\r69.87674\r\r123.1961\r\r89.22913\r\r72.97586\r\r48.58223\r\r98.75159\r\r95.33240\r\r105.68\r\r84.23099\r\r68.51684\r\r66.03955\r\r37.32612\r\r100.7515\r\r106.2667\r\r56.32751\r\r27.57342\r\r97.51283\r\r71.91882\r\r12.87435\r\r74.32222\r\r36.24140\r\r37.83765\r\r40.59300\r\r103.2470\r\r48.98268\r\r95.86506\r\r149.5692\r\r74.45753\r\r105.2777\r\r99.38823\r\r35.36956\r\r102.1459\r\r23.63719\r\r98.34815\r\r61.63771\r\r226.3864\r\r42.52462\r\r99.26135\r\r65.02093\r\r64.04923\r\r64.13377\r\r80.25970\r\r41.90978\r\r112.1254\r\r76.28411\r\r31.31075\r\r10.66\r\r37.78327\r\r67.70534\r\r42.94580\r\r81.73975\r\r23.71093\r\r87.38972\r\r101.7664\r\r56.97219\r\r69.81445\r\r85.77296\r\r43.22602\r\r44.36678\r\r41.10435\r\r34.02365\r\r93.39094\r\r75.83461\r\r48.27848\r\r55.38676\r\r49.36685\r\r14.28668\r\r38.10586\r\r59.79903\r\r46.09118\r\r32.84278\r\r83.17358\r\r48.36041\r\r48.30741\r\r50.03457\r\r80.18208\r\r74.31207\r\r46.88947\r\r105.6269\r\rNA\r\r42.88478\r\r115.9920\r\r79.95219\r\r22.25777\r\r108.9970\r\r48.12699\r\r123.5344\r\r\r\r178.5548\r\r179.0729\r\r91.19671\r\r163.3088\r\r100.7813\r\r30.84332\r\r45.87430\r\r98.05104\r\r27.08941\r\r49.46577\r\r33.33975\r\r69.83128\r\r122.7901\r\r89.27684\r\r72.67066\r\r48.58699\r\r98.32368\r\r95.42790\r\r104.74\r\r84.19437\r\r68.66522\r\r66.41467\r\r37.38177\r\r100.4263\r\r105.7561\r\r56.38982\r\r27.56408\r\r97.03933\r\r71.98254\r\r12.89183\r\r74.19040\r\r36.31308\r\r38.08304\r\r40.58370\r\r103.5317\r\r48.92731\r\r96.33284\r\r150.1098\r\r74.44821\r\r105.2681\r\r99.32295\r\r35.24034\r\r101.6092\r\r23.71054\r\r98.25743\r\r61.62007\r\r225.7010\r\r42.51531\r\r98.94638\r\r64.92279\r\r64.19955\r\r63.37006\r\r80.28816\r\r41.99163\r\r110.8984\r\r76.18345\r\r31.14146\r\r10.57\r\r37.86405\r\r67.48906\r\r42.91782\r\r81.75836\r\r23.67340\r\r87.24041\r\r101.6019\r\r57.05649\r\r70.36455\r\r85.55912\r\r43.52830\r\r44.78313\r\r41.22744\r\r34.09733\r\r93.41876\r\r75.65400\r\r48.26467\r\r55.53847\r\r49.39434\r\r13.69632\r\r38.30916\r\r59.57745\r\r46.11899\r\r32.90544\r\r82.78702\r\r48.41602\r\r48.23457\r\r48.96336\r\r80.06235\r\r74.02564\r\r46.90808\r\r105.5428\r\rNA\r\r42.95756\r\r115.8515\r\r79.92420\r\r22.32194\r\r108.0954\r\r48.04214\r\r122.4960\r\r\r\r\rI also collect the SPY500.\nSPY_prices \u0026lt;- tq_get(\r\u0026quot;^GSPC\u0026quot;,\rfrom = start_date,\rto = end_date\r) %\u0026gt;% select(date, adjusted) %\u0026gt;% tk_xts(date_var = date)\rWhich looks like:\n\r\radjusted\r\r\r\r\r\r2012.66\r\r\r\r2016.71\r\r\r\r1990.26\r\r\r\r1943.09\r\r\r\r1922.03\r\r\r\r1923.67\r\r\r\r\rNow, we have a series of 3 data sets, the daily prices of the adjusted close for the randomly selected assets from the SPY500 wikipedia page, the ETFs and the SPY500. Next I calculate the daily returns.\nasset_returns \u0026lt;- diff(log(asset_prices), na.pad = FALSE)\retf_returns \u0026lt;- diff(log(etf_prices), na.pad = FALSE)\rSPY_returns \u0026lt;- diff(log(SPY_prices), na.pad = FALSE)\rThe asset_returns looks like:\n\r\rMMM\r\rMNST\r\rTJX\r\rTMUS\r\rNWL\r\rINTC\r\rEIX\r\rXRX\r\rGPN\r\rHES\r\rTIF\r\rIR\r\rGRMN\r\rDRI\r\rGLW\r\rZTS\r\rCCI\r\rBK\r\r\r\r\r\r0.0043496940\r\r0.011914276\r\r0.015549833\r\r0.032085611\r\r-0.0004605231\r\r-0.004718686\r\r0.0003390193\r\r-0.001943595\r\r0.015381467\r\r-0.0022860685\r\r-0.002956558\r\r-0.010757820\r\r0.003797292\r\r0.0180042454\r\r-0.0005589373\r\r0.0155331932\r\r0.020287018\r\r-0.003760040\r\r\r\r-0.0203468502\r\r0.001573356\r\r-0.026052579\r\r-0.004235761\r\r-0.0280260856\r\r-0.022418948\r\r-0.0066352645\r\r-0.012726538\r\r0.003142188\r\r-0.0644414487\r\r-0.018747883\r\r-0.021494331\r\r-0.027722605\r\r-0.0074420504\r\r-0.0225996450\r\r0.0002084719\r\r-0.008412745\r\r-0.025433678\r\r\r\r-0.0246630740\r\r-0.007547151\r\r-0.001427791\r\r0.011420159\r\r-0.0457985304\r\r-0.038205692\r\r-0.0049630049\r\r-0.027973817\r\r-0.038210941\r\r-0.0327010158\r\r-0.027810684\r\r-0.030233211\r\r-0.029085489\r\r-0.0070174571\r\r-0.0231226086\r\r-0.0308759534\r\r-0.025196097\r\r-0.025568744\r\r\r\r-0.0034106468\r\r-0.006564266\r\r-0.044704812\r\r-0.015673838\r\r-0.0238374478\r\r-0.010418300\r\r-0.0001713849\r\r-0.028779059\r\r-0.019418177\r\r-0.0009174858\r\r-0.038228556\r\r-0.009504269\r\r-0.039450060\r\r-0.0075510143\r\r0.0029199836\r\r-0.0147124623\r\r-0.014103137\r\r-0.018403085\r\r\r\r-0.0002136353\r\r0.012332679\r\r0.012914805\r\r-0.005027688\r\r-0.0007621181\r\r0.017304330\r\r0.0156624749\r\r-0.020011095\r\r-0.027971612\r\r-0.0443372159\r\r-0.006172111\r\r0.003307394\r\r-0.010486917\r\r-0.0008065403\r\r0.0092862449\r\r-0.0287440451\r\r0.007315467\r\r0.007241532\r\r\r\r0.0028436862\r\r0.008590726\r\r0.016384277\r\r0.009531073\r\r0.0156331210\r\r0.019154091\r\r0.0033726404\r\r0.013734922\r\r0.000000000\r\r-0.0514319659\r\r0.008367407\r\r0.016185405\r\r-0.001507319\r\r0.0088375907\r\r0.0017316113\r\r0.0087102953\r\r0.004411381\r\r0.007985230\r\r\r\r\rHowever, I want to assume that I own all of these assets in a single portfolio. So I average over the rows and join the data to the ETFs and call it all_returns.\nportfolio_returns \u0026lt;- xts(rowMeans(asset_returns), index(asset_returns))\rcolnames(portfolio_returns) \u0026lt;- c(\u0026quot;myPortfolio\u0026quot;)\rall_returns \u0026lt;- cbind(portfolio_returns, etf_returns)\rThe all_returns data looks like the following, where we can now see myPortfolio has been joined with the ETF dataset.\n\r\rmyPortfolio\r\rSPY\r\rIVV\r\rVTI\r\rVOO\r\rQQQ\r\rVEA\r\rIEFA\r\rAGG\r\rVWO\r\rEFA\r\rIEMG\r\rVTV\r\rIJH\r\rIWF\r\rBND\r\rIJR\r\rIWM\r\rVUG\r\rGLD\r\rIWD\r\rVIG\r\rVNQ\r\rUSMV\r\rLQD\r\rVO\r\rVYM\r\rEEM\r\rVB\r\rVCSH\r\rXLF\r\rVCIT\r\rVEU\r\rXLK\r\rITOT\r\rIVW\r\rBNDX\r\rVGT\r\rDIA\r\rBSV\r\rSHV\r\rIWB\r\rIWR\r\rTIP\r\rSCHF\r\rMBB\r\rSDY\r\rMDY\r\rSCHX\r\rIEF\r\rHYG\r\rDVY\r\rXLV\r\rSHY\r\rIXUS\r\rTLT\r\rIVE\r\rPFF\r\rIAU\r\rVXUS\r\rRSP\r\rSCHB\r\rVV\r\rGOVT\r\rEMB\r\rMUB\r\rQUAL\r\rXLY\r\rVBR\r\rEWJ\r\rXLP\r\rVGK\r\rSPLV\r\rMINT\r\rBIV\r\rIGSB\r\rEFAV\r\rVT\r\rGDX\r\rXLU\r\rIWS\r\rXLI\r\rSCHD\r\rIWP\r\rACWI\r\rVMBS\r\rXLE\r\rJNK\r\rVOE\r\rFLOT\r\rIWV\r\rJPST\r\rSCZ\r\rIEI\r\rIWN\r\rDGRO\r\rVBK\r\rIGIB\r\rIWO\r\r\r\r\r\r0.006099968\r\r0.0016898660\r\r0.002077056\r\r0.0022360355\r\r0.0017890863\r\r-0.001736693\r\r-0.001106388\r\r-0.001681088\r\r0.00046332859\r\r0.002200231\r\r-0.001557725\r\r0.0023415111\r\r0.0032234753\r\r0.0007997348\r\r0.0015327343\r\r0.0012383279\r\r0.003064097\r\r0.002179106\r\r0.000191391\r\r0.002814589\r\r0.0019626291\r\r0.003253374\r\r0.019113014\r\r0.006756640\r\r0.0005267369\r\r0.001011874\r\r0.004991256\r\r0.0022334070\r\r0.0005508056\r\r-0.0002531205\r\r0.003843879\r\r0.0002372109\r\r-0.002346225\r\r-0.002605712\r\r0.0017475020\r\r0.001932397\r\r-0.0005666427\r\r-0.004795300\r\r0.0005836581\r\r-0.0001257842\r\r0.00009081159\r\r0.0019685044\r\r0.002272383\r\r-0.0006361631\r\r-0.001106790\r\r0.0007422784\r\r0.0041255033\r\r0.0003189161\r\r0.0020875396\r\r-0.0002827452\r\r0.001870799\r\r0.0060170694\r\r0.004795681\r\r-0.0005922602\r\r-0.001030700\r\r-0.004042725\r\r0.002739571\r\r0.0010243955\r\r0.001924928\r\r-0.001806146\r\r0.002371882\r\r0.0008275628\r\r0.0019515134\r\r-0.001194977\r\r0.00264674400\r\r0.0011761117\r\r0.002668490\r\r-0.001302665\r\r0.002258164\r\r0.012494986\r\r0.006398807\r\r-0.005917852\r\r0.008133639\r\r0.00000000000\r\r0.001200660\r\r-0.0004779842\r\r0.001874008\r\r0.0001763650\r\r-0.00498036\r\r0.0071519848\r\r0.0023486170\r\r0.0026733893\r\r0.005754619\r\r0.001875951\r\r0.0009116517\r\r0.0018953483\r\r0.003807047\r\r0.0020722096\r\r0.002231295\r\r-0.0001980912\r\r0.002446725\r\rNA\r\r-0.002630911\r\r0.0004069319\r\r0.0045386533\r\r0.003549552\r\r0.0004194414\r\r0.001211963\r\r0.0005894971\r\r\r\r-0.017322911\r\r-0.0126945384\r\r-0.013178202\r\r-0.0134924019\r\r-0.0127544774\r\r-0.009652265\r\r-0.018436329\r\r-0.017729720\r\r0.00378821023\r\r-0.018058472\r\r-0.016592869\r\r-0.0180938802\r\r-0.0143367503\r\r-0.0141237737\r\r-0.0105732344\r\r0.0044445716\r\r-0.011468264\r\r-0.015355426\r\r-0.011056244\r\r0.014337489\r\r-0.0153896498\r\r-0.012156174\r\r-0.002743903\r\r-0.006272724\r\r0.0039388941\r\r-0.018628687\r\r-0.013212984\r\r-0.0193056059\r\r-0.0150753935\r\r0.0003798793\r\r-0.015464153\r\r0.0032002389\r\r-0.017296894\r\r-0.012410734\r\r-0.0142874994\r\r-0.011028538\r\r0.0037696378\r\r-0.013665012\r\r-0.0143976824\r\r0.0011297112\r\r-0.00018126091\r\r-0.0133167477\r\r-0.016720820\r\r0.0031757481\r\r-0.018629431\r\r0.0032416931\r\r-0.0115945095\r\r-0.0142095765\r\r-0.0130144362\r\r0.0060192314\r\r0.000000000\r\r-0.0101836091\r\r-0.008194411\r\r0.0005922602\r\r-0.017474795\r\r0.013385186\r\r-0.015046456\r\r-0.0023059217\r\r0.016213994\r\r-0.017094464\r\r-0.018466064\r\r-0.0124870774\r\r-0.0131916717\r\r0.003978224\r\r-0.00009471654\r\r0.0044202968\r\r-0.011985546\r\r-0.009823880\r\r-0.015706040\r\r-0.017537150\r\r-0.003394215\r\r-0.016716991\r\r-0.008924441\r\r0.00009924540\r\r0.004072733\r\r0.0007647688\r\r-0.009721009\r\r-0.0149360906\r\r0.01627195\r\r-0.0018408588\r\r-0.0174535242\r\r-0.0155668847\r\r-0.012070245\r\r-0.016226286\r\r-0.0152395434\r\r0.0022698272\r\r-0.039253655\r\r-0.0008873999\r\r-0.019544672\r\r0.0000000000\r\r-0.013574412\r\rNA\r\r-0.016961509\r\r0.0029245001\r\r-0.0117764103\r\r-0.013875422\r\r-0.0157191560\r\r0.001489930\r\r-0.0179955058\r\r\r\r-0.022721172\r\r-0.0242840940\r\r-0.024218220\r\r-0.0248157103\r\r-0.0246568769\r\r-0.031814151\r\r-0.019069875\r\r-0.019212776\r\r-0.00009198023\r\r-0.032821816\r\r-0.021000906\r\r-0.0306311536\r\r-0.0236320930\r\r-0.0262082119\r\r-0.0258207050\r\r0.0001227881\r\r-0.026029826\r\r-0.027074043\r\r-0.026052010\r\r0.014040682\r\r-0.0238600026\r\r-0.018582970\r\r-0.019675179\r\r-0.016347691\r\r0.0007861946\r\r-0.022751878\r\r-0.021792064\r\r-0.0313506787\r\r-0.0273006374\r\r0.0005068469\r\r-0.028542194\r\r0.0005917693\r\r-0.021745295\r\r-0.029984083\r\r-0.0243136677\r\r-0.025700013\r\r-0.0015062361\r\r-0.032729302\r\r-0.0238405527\r\r0.0015052940\r\r0.00009044932\r\r-0.0246679043\r\r-0.023153370\r\r-0.0008155098\r\r-0.018599946\r\r0.0012935879\r\r-0.0203358057\r\r-0.0258820165\r\r-0.0241643775\r\r0.0021541043\r\r-0.006500818\r\r-0.0179376149\r\r-0.020495249\r\r0.0003548886\r\r-0.020995449\r\r0.001793079\r\r-0.023062135\r\r-0.0064343040\r\r0.014091356\r\r-0.020906723\r\r-0.022920923\r\r-0.0248076812\r\r-0.0246652173\r\r0.001982686\r\r-0.00473089487\r\r0.0014396023\r\r-0.024085978\r\r-0.020748172\r\r-0.025632797\r\r-0.015280173\r\r-0.012072667\r\r-0.018696026\r\r-0.016748990\r\r-0.00009924540\r\r0.001314087\r\r0.0003822792\r\r-0.013642270\r\r-0.0235646381\r\r0.04326116\r\r-0.0067016093\r\r-0.0221778810\r\r-0.0274902986\r\r-0.021075943\r\r-0.023810522\r\r-0.0235878969\r\r0.0013215006\r\r-0.024701342\r\r-0.0053430008\r\r-0.023111858\r\r0.0001980912\r\r-0.024207994\r\rNA\r\r-0.015369037\r\r0.0022689596\r\r-0.0269583342\r\r-0.018940649\r\r-0.0285117041\r\r0.001580334\r\r-0.0284649716\r\r\r\r-0.016273779\r\r-0.0110371371\r\r-0.011139358\r\r-0.0114683030\r\r-0.0106831096\r\r-0.008234532\r\r-0.012433352\r\r-0.012885863\r\r0.00221091926\r\r-0.008959566\r\r-0.012123531\r\r-0.0095957668\r\r-0.0118987200\r\r-0.0130211706\r\r-0.0100044748\r\r0.0012306568\r\r-0.016790854\r\r-0.017373511\r\r-0.009370855\r\r-0.004437547\r\r-0.0129618969\r\r-0.010369474\r\r-0.013464265\r\r-0.010137208\r\r0.0007854976\r\r-0.012995981\r\r-0.011313767\r\r-0.0107854401\r\r-0.0139835513\r\r0.0001261363\r\r-0.015713048\r\r0.0003548290\r\r-0.012040822\r\r-0.007949941\r\r-0.0118655695\r\r-0.009695182\r\r-0.0001885182\r\r-0.008626436\r\r-0.0104818256\r\r0.0011270489\r\r0.00009081159\r\r-0.0104525822\r\r-0.012278941\r\r0.0008155098\r\r-0.012336194\r\r0.0011074564\r\r-0.0096812509\r\r-0.0134486432\r\r-0.0113193358\r\r0.0025227807\r\r-0.002637331\r\r-0.0068795036\r\r-0.015174172\r\r0.0007095865\r\r-0.012508199\r\r0.004468584\r\r-0.012752597\r\r0.0028360806\r\r-0.005612737\r\r-0.011806658\r\r-0.012285245\r\r-0.0114437766\r\r-0.0107437626\r\r0.001188048\r\r-0.00085371766\r\r0.0004493159\r\r-0.011441888\r\r-0.010809474\r\r-0.014204613\r\r-0.021617824\r\r-0.007722146\r\r-0.008731859\r\r-0.009698102\r\r-0.00009916959\r\r0.002622702\r\r0.0006684507\r\r-0.008823294\r\r-0.0118083221\r\r-0.02449108\r\r-0.0004634958\r\r-0.0119706508\r\r-0.0102051133\r\r-0.010843211\r\r-0.012586070\r\r-0.0116223810\r\r0.0007544131\r\r-0.012939813\r\r-0.0035775482\r\r-0.015544198\r\r-0.0005950313\r\r-0.011530313\r\rNA\r\r-0.013485184\r\r0.0020213357\r\r-0.0163207962\r\r-0.012280109\r\r-0.0147442744\r\r0.001206870\r\r-0.0174444534\r\r\r\r-0.003287114\r\r0.0009894013\r\r0.001036607\r\r-0.0006123565\r\r0.0001135276\r\r0.003072098\r\r0.004354785\r\r0.003530857\r\r-0.00285692501\r\r-0.004342847\r\r0.004178409\r\r-0.0011027594\r\r-0.0006508431\r\r-0.0033014245\r\r0.0005345031\r\r-0.0041909610\r\r0.000097994\r\r-0.004342530\r\r0.001001152\r\r-0.008934590\r\r-0.0004349583\r\r0.002163316\r\r0.005664191\r\r0.001489776\r\r-0.0032326845\r\r-0.004816595\r\r0.001105438\r\r-0.0003388982\r\r-0.0048675476\r\r0.0008856206\r\r0.001356817\r\r-0.0017752166\r\r0.001975840\r\r0.006464163\r\r-0.0002292283\r\r0.002753215\r\r-0.0011312023\r\r0.004867711\r\r0.0036078899\r\r-0.0001251127\r\r-0.00009081159\r\r-0.0006570038\r\r-0.003659859\r\r-0.0052679258\r\r0.003098229\r\r-0.0009228731\r\r-0.0002861645\r\r-0.0030322035\r\r-0.0002189089\r\r-0.0031781230\r\r-0.001510439\r\r0.0023442262\r\r-0.011979547\r\r0.0003544986\r\r0.001951243\r\r-0.011003744\r\r-0.001320438\r\r-0.0054213750\r\r-0.008478619\r\r0.002135701\r\r-0.003199632\r\r-0.0006516613\r\r0.0002276234\r\r-0.001584279\r\r-0.00170998028\r\r-0.0016183255\r\r0.001478523\r\r0.007848505\r\r-0.002496171\r\r0.006968673\r\r0.009340380\r\r0.002990074\r\r0.002163358\r\r0.00029781110\r\r-0.002384484\r\r-0.0002860690\r\r0.002735430\r\r0.0005566762\r\r-0.04220025\r\r0.0053208513\r\r-0.0037123602\r\r0.0006030788\r\r0.001905938\r\r-0.004658536\r\r0.0011492677\r\r-0.0015090848\r\r-0.021642045\r\r-0.0014944173\r\r-0.003861882\r\r0.0003969400\r\r-0.000796942\r\rNA\r\r0.001695691\r\r-0.0012123094\r\r-0.0003501705\r\r0.002878845\r\r-0.0083062241\r\r-0.001764683\r\r-0.0084416475\r\r\r\r0.005140787\r\r0.0080360599\r\r0.007689359\r\r0.0068197139\r\r0.0082617000\r\r0.011531038\r\r0.004047425\r\r0.004688442\r\r0.00221249905\r\r0.003675782\r\r0.004702448\r\r0.0008273783\r\r0.0061003752\r\r0.0038377668\r\r0.0097876198\r\r0.0025911534\r\r0.002638930\r\r0.002993541\r\r0.009163331\r\r-0.005072985\r\r0.0057480147\r\r0.008340049\r\r-0.006697424\r\r0.005197513\r\r0.0022727943\r\r0.004549844\r\r0.005352840\r\r0.0020317774\r\r0.0028262158\r\r0.0000000000\r\r0.007652486\r\r0.0005922597\r\r0.004185365\r\r0.011825830\r\r0.0070922542\r\r0.010122713\r\r0.0013197206\r\r0.011331708\r\r0.0068127609\r\r0.0001251127\r\r0.00009081159\r\r0.0077616649\r\r0.004124727\r\r0.0027283407\r\r0.004244698\r\r0.0015682489\r\r0.0052809133\r\r0.0041247242\r\r0.0078515507\r\r0.0044839921\r\r0.001007182\r\r0.0009635456\r\r0.012714693\r\r0.0001185908\r\r0.003891078\r\r0.014321948\r\r0.006106584\r\r-0.0007773691\r\r-0.004741593\r\r0.002367465\r\r0.004726248\r\r0.0064978364\r\r0.0075872456\r\r0.003165548\r\r-0.00467027771\r\r0.0003596236\r\r0.010125999\r\r0.010992048\r\r0.001411921\r\r-0.005221970\r\r0.005441886\r\r0.008282949\r\r0.005119095\r\r-0.00019864151\r\r0.001431193\r\r-0.0003823817\r\r0.003208727\r\r0.0055494219\r\r-0.02252194\r\r-0.0039301169\r\r0.0004647994\r\r0.0080082458\r\r0.005967129\r\r0.008138341\r\r0.0064871928\r\r0.0001887472\r\r0.002367193\r\r0.0023899644\r\r0.002866649\r\r0.0001980912\r\r0.007238678\r\rNA\r\r0.000000000\r\r0.0018584037\r\r-0.0026886552\r\r0.008587052\r\r0.0051881359\r\r0.001579281\r\r0.0088344163\r\r\r\r\rNext, I compute (just as before) the \\(\\beta\\) and \\(\\alpha\\) of the portfolios. This time using just the CAPM.beta and CAPM.alpha functions in the PerformanceAnalytics package.\nlibrary(PerformanceAnalytics)\rbetas \u0026lt;- CAPM.beta(Ra = all_returns, Rb = SPY_returns, Rf = 0)\ralphas \u0026lt;- CAPM.alpha(Ra = all_returns, Rb = SPY_returns, Rf = 0)\rbeta_alphas \u0026lt;- cbind(t(betas), t(alphas))\rcolnames(beta_alphas) \u0026lt;- c(\u0026quot;beta\u0026quot;, \u0026quot;alpha\u0026quot;)\rI rank the ETF’s by their \\(\\alpha\\) value. We can see the GDX has the highest \\(\\alpha\\) and a negative \\(\\beta\\) which makes sense since its a Goldminers ETF whihc tracks the Arca Gold Miners Index (GDMNTR) which tracks the performance of companies involved in the gold mining industry. As far as I know there are very few Gold mining companies listed in the SPY500. However, this is a nice way to present and rank ETFs by their \\(\\alpha\\) values and see their corresponding \\(\\beta\\) values.\nbeta_alphas %\u0026gt;% as_tibble(rownames = NA) %\u0026gt;% rownames_to_column(\u0026quot;ETFs\u0026quot;) %\u0026gt;% arrange(desc(alpha)) %\u0026gt;% head(10) %\u0026gt;% # I only take the top 10 observations since there are many ETF\u0026#39;s in the data\rpivot_longer(cols = c(\u0026quot;beta\u0026quot;, \u0026quot;alpha\u0026quot;)) %\u0026gt;% ggplot(aes(x = reorder(ETFs, if_else(name == \u0026quot;alpha\u0026quot;, value, -Inf), FUN = max), y = value)) +\rgeom_bar(color = \u0026quot;black\u0026quot;, fill = \u0026quot;darkred\u0026quot;, stat = \u0026quot;identity\u0026quot;) +\rscale_color_brewer(type=\u0026#39;seq\u0026#39;, palette=\u0026#39;Reds\u0026#39;) + facet_wrap(~name, scales = \u0026quot;free\u0026quot;) +\rtheme_tq() +\rcoord_flip() +\rggtitle(\u0026quot;Highest ranked alpha stocks\u0026quot;, subtitle = \u0026quot;With corresponding beta values\u0026quot;) +\rylab(\u0026quot;Alpha / Beta value\u0026quot;) +\rxlab(\u0026quot;ETF\u0026quot;)\rWe can also rank the \\(alpha\\) and \\(beta\\) values by taking their ratio of \\(\\dfrac{\\alpha}{\\beta}\\) and plot the results.\nbeta_alphas %\u0026gt;% as_tibble(rownames = NA) %\u0026gt;% rownames_to_column(\u0026quot;ETFs\u0026quot;) %\u0026gt;% mutate(alpha_divided_beta = alpha/beta) %\u0026gt;% arrange(desc(alpha_divided_beta )) %\u0026gt;% head(10) %\u0026gt;% ggplot(aes(x = ETFs, y = alpha_divided_beta )) +\rgeom_bar(color = \u0026quot;black\u0026quot;, fill = \u0026quot;darkred\u0026quot;, stat = \u0026quot;identity\u0026quot;) +\rscale_color_brewer(type=\u0026#39;seq\u0026#39;, palette=\u0026#39;Reds\u0026#39;) + theme_tq() +\rcoord_flip() +\rggtitle(\u0026quot;Best Performers: Alpha over Beta ranked ETFs\u0026quot;) +\rylab(\u0026quot;Alpha / Beta value\u0026quot;) +\rxlab(\u0026quot;ETF\u0026quot;)\rChanging a few lines of code and we can plot and see the worst performers with negative \\(\\alpha\\) to \\(\\beta\\) ratios.\nbeta_alphas %\u0026gt;% as_tibble(rownames = NA) %\u0026gt;% rownames_to_column(\u0026quot;ETFs\u0026quot;) %\u0026gt;% mutate(alpha_divided_beta = alpha/beta) %\u0026gt;% arrange(alpha_divided_beta) %\u0026gt;% head(10) %\u0026gt;% ggplot(aes(x = ETFs, y = alpha_divided_beta )) +\rgeom_bar(color = \u0026quot;black\u0026quot;, fill = \u0026quot;darkblue\u0026quot;, stat = \u0026quot;identity\u0026quot;) +\rscale_color_brewer(type=\u0026#39;seq\u0026#39;, palette=\u0026#39;Reds\u0026#39;) + theme_tq() +\rcoord_flip() +\rggtitle(\u0026quot;Worst Performers: Alpha over Beta ranked ETFs\u0026quot;) +\rylab(\u0026quot;Alpha / Beta value\u0026quot;) +\rxlab(\u0026quot;ETF\u0026quot;)\rWe can take our ETF \\(\\beta\\) and \\(\\alpha\\) values before and compute \\(\\sigma\\).\nbeta \u0026lt;- cov(all_returns, SPY_returns) / as.numeric(var(SPY_returns))\ralpha \u0026lt;- colMeans(all_returns) - beta*colMeans(SPY_returns)\rN = length(SPY_returns)\rmySigmaFunction \u0026lt;- function(ASSET){\rerr = all_returns[, ASSET] - alpha[ASSET ,] - beta[ASSET ,] * SPY_returns\rSigma = (1 / (N - 2)) %*% t(err) %*% err\rreturn(Sigma)\r}\rSigma2 \u0026lt;- sapply(colnames(all_returns), mySigmaFunction)\rdiag_Sigma2 \u0026lt;- diag(Sigma2)\rcolnames(diag_Sigma2) = colnames(all_returns)\rrownames(diag_Sigma2) = colnames(all_returns)\rSigma \u0026lt;- as.numeric(var(SPY_returns)) * beta %*% t(beta) + diag_Sigma2\rFinally, I take a random sample of the ETF’s (since there are too many to analyse) and plot the correlations between the ETF’s.\nset.seed(1234)\rSigma_subsample \u0026lt;- sample(colnames(Sigma), size = 10)\rSigma_sampled \u0026lt;- Sigma[ncol = Sigma_subsample, nrow = Sigma_subsample, drop = FALSE]\rcol \u0026lt;- colorRampPalette(c(\u0026quot;#BB4444\u0026quot;, \u0026quot;#EE9988\u0026quot;, \u0026quot;#FFFFFF\u0026quot;, \u0026quot;#77AADD\u0026quot;, \u0026quot;#4477AA\u0026quot;))\rcorrplot(cov2cor(Sigma_sampled), method = \u0026quot;color\u0026quot;, col = col(200),\rmain = \u0026quot;Covariance matrix of ETFs\u0026quot;,\rtype = \u0026quot;upper\u0026quot;, order = \u0026quot;hclust\u0026quot;, number.cex = .7,\raddCoef.col = \u0026quot;black\u0026quot;,\rtl.col = \u0026quot;black\u0026quot;, tl.srt = 90,\rdiag = FALSE)\r\r\rSharpe Ratio, CAPM and Fama-French Factor Analysis\rUsing simple plots still doesn’t give us enough information about an ETF, Portfolio or Asset. The Sharpe ratio Sharpe (1966) is a better measure. The Sharpe ratio is a reward-to-variability ratio which allows us to compare the performance of a portfolio compared to a risk-free asset, after adjusting for it’s risk. It takes the differenece between the portfolio’s return and the risk-free return, this is then divided by the standard deviation (which measures the portfolios volatility).\nThe Sharpe ratio tells us what the additional unit of return we can expect per unit of risk increase. The Sharpe ratio is defined as:\n\\[S = \\dfrac{\\overline{d}}{\\sigma_{d}}\\]\nWhere \\[\\widetilde{d} = \\widetilde{R}_{F} - \\widetilde{R}_{B}\\]\nThe single asset model with just the market factor looks like:\n\\[ x_t = \\alpha + \\beta y_{t} + \\epsilon_{t}\\]\nTaking the expected value of \\(x\\) and \\(y\\) at time \\(t\\) we have:\n\\[E[x_{t}] = \\alpha + \\beta E[y_{t}]\\]\rWith variance:\n\\[var[x_{t}] = \\beta^2var[y_t] + \\sigma^2\\]\nThus, the Sharpe ratio becomes:\n\\[\\dfrac{E[x_{t}]}{\\sqrt{var[x_{t}]}}\\]\nRecall that \\(\\sigma = \\sqrt{var[x_t]}\\), we just plug in the values for \\(E[x_{t}]\\) and \\(var[x_t]\\) defined previously and the equation becomes:\n\\[\\dfrac{\\alpha + \\beta E[y_{t}]}{\\sqrt{\\beta^2 var[y_t] + \\sigma^2}}\\]\rWhich after some algebra we obtain:\n\\[\\dfrac{\\dfrac{\\alpha}{\\beta} + E[y_{t}]}{\\sqrt{var[y_{t}] + \\dfrac{\\sigma^{2}}{\\beta^{2}}}}\\]\nFinally we end up with:\n\\[\\dfrac{\\dfrac{\\alpha}{\\beta} + E[y_t]}{\\sqrt{(var[y_t])}}\\]\rWe can represent the Sharpe ratio as \\(\\dfrac{\\overline{x}}{\\sqrt(Diag(\\sigma^{2}))}\\) where \\(\\overline{x}\\) is the average value of \\(x\\) over the historic period from \\(t=1\\) to \\(T\\) - simply computed as \\(\\overline{x} = \\dfrac{1}{T}\\sum_{t=1}^{T} D_{t}\\). In R we can simply take colMeans(all_returns) / sqrt(diag(var(all_returns))).\nMachine Learning and Clustering\rWe can cluster our ETF’s based on their \\(\\beta\\), \\(\\alpha\\) and \\(sharpe\\) values. Why would we want to do this? Perhaps with more variables than the 3 here the model can cluster these firms in a higher dimensional space and thus we can select our ETF’s based on the clusters and use it as a portfolio diversification tool, that is one cluster might contain riskier ETF’s whereas another might contain value stocks or growth stocks. With such few variables here it doesn’t quite work but with more variables we can better classifiy ETFs.\nbetas \u0026lt;- CAPM.beta(Ra = all_returns, Rb = SPY_returns, Rf = 0)\ralphas \u0026lt;- CAPM.alpha(Ra = all_returns, Rb = SPY_returns, Rf = 0)\rsharpe \u0026lt;- colMeans(all_returns) / sqrt(diag(var(all_returns)))\rbeta_alphas_sharpe \u0026lt;- cbind(t(betas), t(alphas), sharpe)\rcolnames(beta_alphas_sharpe) \u0026lt;- c(\u0026quot;beta\u0026quot;, \u0026quot;alpha\u0026quot;, \u0026quot;sharpe\u0026quot;)\rbeta_alphas_sharpe \u0026lt;- na.omit(beta_alphas_sharpe)\rlibrary(factoextra)\rkmeans_model \u0026lt;- kmeans(beta_alphas_sharpe, centers = 5, iter.max = 10, nstart = 1)\rfviz_cluster(kmeans_model, data = beta_alphas_sharpe)\rThe beta_alphas_sharpe data looks like:\n\r\r\rbeta\r\ralpha\r\rsharpe\r\r\r\r\r\rmyPortfolio\r\r1.0977199\r\r0.0000345\r\r0.0834437\r\r\r\rSPY\r\r0.9990763\r\r0.0000799\r\r0.0988232\r\r\r\rIVV\r\r0.9923880\r\r0.0000872\r\r0.1000217\r\r\r\rVTI\r\r1.0282825\r\r0.0000718\r\r0.0969068\r\r\r\rVOO\r\r0.9978598\r\r0.0000848\r\r0.0995858\r\r\r\rQQQ\r\r1.1472461\r\r0.0000931\r\r0.0870931\r\r\r\r\rWe can plot the \\(\\beta\\), \\(\\alpha\\), and \\(sharpe\\) values in a 3D plot and colour them according to the clusters from the kmeans model. It also gives me the opportunity to use the threejs package which we can interact with.\n#library(rgl)\r#options(rgl.printRglwidget = TRUE)\r#plot3d(beta_alphas_sharpe, col = kmeans_model$cluster, size=2, type=\u0026#39;s\u0026#39;)\rlibrary(threejs)\rscatterplot3js(beta_alphas_sharpe, color = factor(kmeans_model$cluster), size = 0.5, bg = \u0026quot;black\u0026quot;)\r\r{\"x\":{\"NROW\":98,\"height\":null,\"width\":null,\"axis\":true,\"numticks\":[6,6,6],\"xticklabs\":null,\"yticklabs\":null,\"zticklabs\":null,\"color\":[[\"#0000FF\",\"#00CD00\",\"#00CD00\",\"#00CD00\",\"#00CD00\",\"#0000FF\",\"#0000FF\",\"#0000FF\",\"#FF0000\",\"#0000FF\",\"#0000FF\",\"#0000FF\",\"#00CD00\",\"#0000FF\",\"#00CD00\",\"#FF0000\",\"#0000FF\",\"#0000FF\",\"#00CD00\",\"#00FFFF\",\"#00CD00\",\"#00CD00\",\"#000000\",\"#000000\",\"#FF0000\",\"#0000FF\",\"#00CD00\",\"#0000FF\",\"#0000FF\",\"#FF0000\",\"#0000FF\",\"#FF0000\",\"#0000FF\",\"#0000FF\",\"#00CD00\",\"#00CD00\",\"#FF0000\",\"#0000FF\",\"#00CD00\",\"#FF0000\",\"#FF0000\",\"#00CD00\",\"#0000FF\",\"#FF0000\",\"#0000FF\",\"#FF0000\",\"#00CD00\",\"#0000FF\",\"#00CD00\",\"#FF0000\",\"#000000\",\"#00CD00\",\"#00CD00\",\"#FF0000\",\"#0000FF\",\"#00FFFF\",\"#00CD00\",\"#000000\",\"#00FFFF\",\"#0000FF\",\"#0000FF\",\"#00CD00\",\"#00CD00\",\"#FF0000\",\"#000000\",\"#FF0000\",\"#00CD00\",\"#00CD00\",\"#0000FF\",\"#00CD00\",\"#000000\",\"#0000FF\",\"#000000\",\"#FF0000\",\"#FF0000\",\"#FF0000\",\"#00CD00\",\"#0000FF\",\"#FF0000\",\"#000000\",\"#0000FF\",\"#00CD00\",\"#00CD00\",\"#0000FF\",\"#00CD00\",\"#FF0000\",\"#0000FF\",\"#000000\",\"#0000FF\",\"#FF0000\",\"#00CD00\",\"#00CD00\",\"#FF0000\",\"#0000FF\",\"#00CD00\",\"#0000FF\",\"#FF0000\",\"#0000FF\"]],\"size\":0.5,\"stroke\":\"black\",\"flipy\":true,\"grid\":true,\"renderer\":\"auto\",\"signif\":8,\"bg\":\"black\",\"cexsymbols\":1,\"xlim\":{},\"ylim\":{},\"zlim\":{},\"pch\":[\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\",\"@\"],\"axisLabels\":[\"beta\",\"sharpe\",\"alpha\"],\"linealpha\":1,\"alpha\":[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],\"vertices\":[[0.86842037,0.19768058,0.79896455,0.8122099,0.24570882,0.76546812,0.80839869,0.24945155,0.76008965,0.82885256,0.23972431,0.77143559,0.8115167,0.24809052,0.76186757,0.89664204,0.20907696,0.75569795,0.87545316,0.13300382,0.88279977,0.87892383,0.12345017,0.89921062,0.21245747,0.1353452,0.71519514,0.96224679,0.17917625,0.73777743,0.8840305,0.11368051,0.92247267,0.9567801,0.19368915,0.69889475,0.8030793,0.24426172,0.75214024,0.90077996,0.20228446,0.78891538,0.80846652,0.25685801,0.72872393,0.20738798,0.14629668,0.7034228,0.93980694,0.18609032,0.77202964,0.96776678,0.16660805,0.83350105,0.82469874,0.22492581,0.77612462,0.0072680562,0.072944981,0.3815712,0.8238163,0.20278562,0.81329857,0.71997998,0.28505182,0.69305727,0.64956127,0.038009408,0.91332596,0.63627089,0.27495944,0.69195384,0.22303675,0.21506997,0.62037529,0.87677485,0.17855466,0.85353738,0.74885905,0.26866605,0.72260875,0.98475726,0.18641981,0.70987767,0.92873432,0.17647001,0.83318765,0.23662141,0.24538331,0.74954408,0.95349741,0.20807217,0.33941353,0.21914287,0.2132234,0.65780069,0.89471618,0.15197604,0.85062954,0.87138986,0.27506301,0.62683163,0.82597919,0.24004032,0.77034434,0.80559384,0.23720957,0.7596557,0.22235117,0.17512233,0.71131769,0.91812957,0.25946954,0.64274803,0.76340472,0.35044209,0.59597513,0.22073833,0.11710243,0.77175807,0.24069479,0.35835152,0.80696572,0.81858223,0.24136177,0.77105671,0.86650082,0.19227675,0.82847854,0.22134258,0.10882134,0.70481383,0.86976802,0.13628746,0.87610547,0.21684798,0.081724253,0.75359276,0.72569943,0.28425152,0.67061056,0.90492964,0.19742584,0.79969008,0.81035901,0.24835885,0.76135119,0.14360957,0,0.70622799,0.50727275,0.23155018,0.73759234,0.69507419,0.28304457,0.65302193,0.75321769,0.086311,0.92312075,0.23036576,0.040832626,0.80126956,0.88121801,0.15984125,0.83184111,0.021569341,0.016758407,0.52655437,0.81060701,0.22243558,0.77961659,0.40021893,0.086042066,0.81301106,0,0.073658157,0.37205153,0.89758197,0.14935085,0.8532154,0.85487073,0.20812666,0.80752296,0.82133194,0.24192055,0.76812712,0.81048037,0.24753617,0.76279233,0.170983,0.0087811686,0.73450521,0.37935598,0.2400784,0.64866877,0.1996185,0.10274521,0.7241423,0.77047125,0.23734123,0.77137957,0.80442396,0.17443686,0.82295812,0.91473618,0.18557293,0.80403361,0.77729792,0.11576565,0.83330271,0.57265433,0.11995578,0.79637196,0.94172922,0.087313513,0.96968996,0.63234826,0.23587091,0.71002534,0.24128725,1,0.76734876,0.18793973,0.0833462,0.70033351,0.2410368,0.27075425,0.77846917,0.68230063,0.11677763,0.85991714,0.86080815,0.20196789,0.81016103,0.14373956,0.06352858,0,0.43246144,0.13590547,0.57383405,0.85764927,0.19124094,0.81461577,0.83311762,0.26908846,0.65291322,0.71347671,0.31790239,0.6500643,0.87192721,0.18532454,0.8333257,0.84539964,0.20738937,0.80081765,0.21427724,0.091387259,0.74892751,0.96104965,0.056055458,1,0.51241777,0.24790322,0.71644714,0.86561388,0.18999103,0.82323629,0.2457111,0.3520244,0.77946229,0.83226163,0.23529644,0.77766867,0.80587032,0.17269504,0.76881137,0.19005408,0.01666762,0.75302567,0.93855143,0.17765193,0.78812958,0.75957138,0.30953111,0.66859364,0.94591256,0.15700728,0.86976113,0.22767177,0.22204563,0.71347953,1,0.14382141,0.88218506]],\"xticklab\":[\"-0.43\",\"-0.08\",\"0.28\",\"0.63\",\"0.98\",\"1.33\"],\"yticklab\":[\"0.02\",\"0.08\",\"0.15\",\"0.21\",\"0.28\",\"0.34\"],\"zticklab\":[\"1.12e-03\",\"8.46e-04\",\"5.75e-04\",\"3.04e-04\",\"3.31e-05\",\"-2.38e-04\"],\"xtick\":[0,0.2,0.4,0.6,0.8,1],\"ytick\":[0,0.2,0.4,0.6,0.8,1],\"ztick\":[0,0.2,0.4,0.6,0.8,1]},\"evals\":[],\"jsHooks\":[]}\r\r\rFactor Modelling Fama and French\rFinally, I analyse the performance of the various ETF’s. The CAPM formula tries to explain the performance of a portfolio through a sigle factor, the market as a whole. CAPM is defined as follows:\n\\[R_{a} = R_{rf} + \\beta_{a}(R_{m} - R_{rf})\\]\nWe can take the model further by adding Factors to the model. Thus, the 3 Factor model looks like:\n\\[R_{a} = R_{rf} + \\beta_{a}(R_{m} - R_{rf}) + \\beta_{b}(SMB) + \\beta_{c} HML\\]\nWhich takes the market factor from the CAPM and adds 2 new factors, the \\(SMB\\) and \\(HML\\) or Small-minus-Big and High-minus-Low. The \\(SMB\\) tries to caputre the size effect, small market cap companies should outperform the market over the long run. The \\(HML\\) aims to capture the value verses growth effect by sorting assests based on high book-to-market ratios (defined at the begining of the post). Firms which typically have a high book-to-market ratio are value stocks and low book-to-market ratios are growth stocks, the literature also shows that value stocks outperform growth stocks over the long term horizon.\nThe Fama French factor model allows us to analyse fund managers performance, since, if an asset managers portfolio can be explained by the Fama French factors then that fund manager has not added any value through portfolio selection and skill and subseuently obtained no alpha.\nMore formally, our equation becomes:\n\\[X^T = a^T + B F^T + E^T\\]\nWhere \\(F\\) is a matrix of factors and \\(B\\) is a scalar of \\(\\beta\\)’s such that \\(B = [{b_{1}, b_{2}, b_{3}]}\\), in which \\(b_{1}\\) is the market \\(\\beta\\), \\(b_{2}\\) is the \\(SMB\\) \\(\\beta\\) and \\(b_{3}\\) is the \\(HML\\) \\(\\beta\\). More formally extending to include more factors up to \\(N\\) we have; \\(B = [\\beta_{1}, ... , \\beta_{N}]^T\\)\nWe want to fit a line which minimises the squared errors such that; \\(minimise, \\beta\\) \\(|X^T - a^T-BF^T|_{F}^2\\)\nThe solution becomes \\([a, B] = X^T \\widetilde{F}(\\widetilde{F}^T\\widetilde{F})^{-1}\\) which we can solve in R using the following:\n(For completness I re-download the data)\nI download the data as before randomly selecting from Wikipedia and convert the daily prices to daily returns - (I set a seed such that we collect the same data using set.seed).\r\rlibrary(quantmod)\rlibrary(tidyquant)\rlibrary(timetk)\rlibrary(rvest)\rstart_date \u0026lt;- \u0026quot;2016-01-01\u0026quot;\rend_date \u0026lt;- \u0026quot;2019-11-15\u0026quot;\rset.seed(4746)\rurl \u0026lt;- \u0026quot;https://en.wikipedia.org/wiki/List_of_S%26P_500_companies\u0026quot;\rsymbols \u0026lt;- url %\u0026gt;%\rread_html() %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;constituents\u0026quot;]\u0026#39;) %\u0026gt;% html_table() %\u0026gt;% .[[1]] %\u0026gt;% filter(!str_detect(Security, \u0026quot;Class A|Class B|Class C\u0026quot;)) %\u0026gt;% # Removes firms with Class A shares\rsample_n(20) %\u0026gt;% pull(Symbol)\rasset_returns \u0026lt;- tq_get(\rsymbols,\rfrom = start_date,\rto = end_date\r) %\u0026gt;% group_by(symbol) %\u0026gt;% tq_transmute(\rselect = adjusted,\rmutate_fun = periodReturn,\rperiod = \u0026quot;daily\u0026quot;,\rtype = \u0026quot;arithmetic\u0026quot;\r) %\u0026gt;% select(symbol, date, daily.returns) %\u0026gt;% pivot_wider(names_from = symbol, values_from = daily.returns) %\u0026gt;% .[-1, ]\rI download the ETFs just as before and convert to daily returns.\r\rmyETFs \u0026lt;- c(\u0026quot;SPY\u0026quot;, \u0026quot;IVV\u0026quot;, \u0026quot;VTI\u0026quot;, \u0026quot;VOO\u0026quot;, \u0026quot;QQQ\u0026quot;, \u0026quot;VEA\u0026quot;, \u0026quot;IEFA\u0026quot;, \u0026quot;AGG\u0026quot;, \u0026quot;VWO\u0026quot;,\r\u0026quot;EFA\u0026quot;,\u0026quot;IEMG\u0026quot;,\u0026quot;VTV\u0026quot;, \u0026quot;IJH\u0026quot;, \u0026quot;IWF\u0026quot;,\u0026quot;BND\u0026quot;, \u0026quot;IJR\u0026quot;, \u0026quot;IWM\u0026quot;, \u0026quot;VUG\u0026quot;, \u0026quot;GLD\u0026quot;, \u0026quot;IWD\u0026quot;, \u0026quot;VIG\u0026quot;, \u0026quot;VNQ\u0026quot;, \u0026quot;USMV\u0026quot;, \u0026quot;LQD\u0026quot;, \u0026quot;VO\u0026quot;, \u0026quot;VYM\u0026quot;, \u0026quot;EEM\u0026quot;,\r\u0026quot;VB\u0026quot;, \u0026quot;VCSH\u0026quot;, \u0026quot;XLF\u0026quot;, \u0026quot;VCIT\u0026quot;, \u0026quot;VEU\u0026quot;, \u0026quot;XLK\u0026quot;, \u0026quot;ITOT\u0026quot;, \u0026quot;IVW\u0026quot;, \u0026quot;BNDX\u0026quot;,\r\u0026quot;VGT\u0026quot;, \u0026quot;DIA\u0026quot;, \u0026quot;BSV\u0026quot;, \u0026quot;SHV\u0026quot;, \u0026quot;IWB\u0026quot;, \u0026quot;IWR\u0026quot;, \u0026quot;TIP\u0026quot;, \u0026quot;SCHF\u0026quot;, \u0026quot;MBB\u0026quot;, \u0026quot;SDY\u0026quot;,\r\u0026quot;MDY\u0026quot;, \u0026quot;SCHX\u0026quot;, \u0026quot;IEF\u0026quot;, \u0026quot;HYG\u0026quot;, \u0026quot;DVY\u0026quot;, \u0026quot;XLV\u0026quot;, \u0026quot;SHY\u0026quot;, \u0026quot;IXUS\u0026quot;, \u0026quot;TLT\u0026quot;, \u0026quot;IVE\u0026quot;,\r\u0026quot;PFF\u0026quot;, \u0026quot;IAU\u0026quot;, \u0026quot;VXUS\u0026quot;, \u0026quot;RSP\u0026quot;, \u0026quot;SCHB\u0026quot;, \u0026quot;VV\u0026quot;, \u0026quot;GOVT\u0026quot;, \u0026quot;EMB\u0026quot;, \u0026quot;MUB\u0026quot;, \u0026quot;QUAL\u0026quot;,\r\u0026quot;XLY\u0026quot;, \u0026quot;VBR\u0026quot;, \u0026quot;EWJ\u0026quot;, \u0026quot;XLP\u0026quot;, \u0026quot;VGK\u0026quot;, \u0026quot;SPLV\u0026quot;, \u0026quot;MINT\u0026quot;, \u0026quot;BIV\u0026quot;, \u0026quot;IGSB\u0026quot;, \u0026quot;EFAV\u0026quot;,\r\u0026quot;VT\u0026quot;, \u0026quot;GDX\u0026quot;, \u0026quot;XLU\u0026quot;, \u0026quot;IWS\u0026quot;, \u0026quot;XLI\u0026quot;, \u0026quot;SCHD\u0026quot;, \u0026quot;IWP\u0026quot;, \u0026quot;ACWI\u0026quot;, \u0026quot;VMBS\u0026quot;, \u0026quot;XLE\u0026quot;, \u0026quot;JNK\u0026quot;,\r\u0026quot;VOE\u0026quot;, \u0026quot;FLOT\u0026quot;, \u0026quot;IWV\u0026quot;, \u0026quot;JPST\u0026quot;, \u0026quot;SCZ\u0026quot;, \u0026quot;IEI\u0026quot;, \u0026quot;IWN\u0026quot;, \u0026quot;DGRO\u0026quot;, \u0026quot;VBK\u0026quot;, \u0026quot;IGIB\u0026quot;, \u0026quot;IWO\u0026quot;)\retf_returns \u0026lt;- tq_get(\rmyETFs,\rfrom = start_date,\rto = end_date\r) %\u0026gt;% group_by(symbol) %\u0026gt;% tq_transmute(\rselect = adjusted,\rmutate_fun = periodReturn,\rperiod = \u0026quot;daily\u0026quot;,\rtype = \u0026quot;arithmetic\u0026quot;\r) %\u0026gt;% select(symbol, date, daily.returns) %\u0026gt;% pivot_wider(names_from = symbol, values_from = daily.returns) %\u0026gt;% .[-1, ]\rI take the average daily return of the randomly selected stocks and join the data with the ETFs and set the data as a time series object. I also download the daily Fama French 3 factors from Kenneth French’s website and clean the data up a little.\r\rportfolio_and_etfs \u0026lt;- asset_returns %\u0026gt;% mutate(myPortfolio = rowMeans(select(., -date), na.rm = TRUE)) %\u0026gt;% select(date, myPortfolio) %\u0026gt;% inner_join(etf_returns, by = c(\u0026quot;date\u0026quot;)) %\u0026gt;% tk_xts(date_var = date)\r# Daily fama french\rlibrary(glue)\rlibrary(readr)\rtemp \u0026lt;- tempfile()\rbase \u0026lt;- \u0026quot;http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/ftp/\u0026quot;\rfactor \u0026lt;- \u0026quot;F-F_Research_Data_Factors_daily\u0026quot;\rformat\u0026lt;-\u0026quot;_CSV.zip\u0026quot;\rfull_url \u0026lt;-glue(base,factor,format,sep =\u0026quot;\u0026quot;)\rdownload.file(full_url,temp,quiet = TRUE)\rNorth_America_3_Factors \u0026lt;- read_csv(unz(temp, \u0026quot;F-F_Research_Data_Factors_daily.CSV\u0026quot;), skip = 4) %\u0026gt;%\rrename(date = X1) %\u0026gt;% mutate(date = ymd(date)) %\u0026gt;% drop_na(date) %\u0026gt;%\rrename(Mkt_Rf_3 = `Mkt-RF`,\rSMB_3 = SMB,\rHML_3 = HML,\rRF_3 = RF) %\u0026gt;% select(-RF_3) %\u0026gt;% mutate_at(vars(c(\u0026quot;Mkt_Rf_3\u0026quot;, \u0026quot;SMB_3\u0026quot;, \u0026quot;HML_3\u0026quot;)), funs(./100)) %\u0026gt;% tk_xts(date_var = date)\rFinally we can compute the solution \\([a, B] = X^T \\widetilde{F}(\\widetilde{F}^T\\widetilde{F})^{-1}\\)\nthree_factors \u0026lt;- North_America_3_Factors[index(North_America_3_Factors) %in% c(min(index(portfolio_and_etfs)):max(index(North_America_3_Factors)))] # this ensures that the dates from the both time series match\rportfolio_and_etfs_new \u0026lt;- portfolio_and_etfs[index(portfolio_and_etfs) %in% c(min(index(three_factors))):max(index(three_factors))] # There is probably a much nicer way to go about doing this but this works...\rFF_3Factors \u0026lt;- cbind(alpha = 1, three_factors)\rGamma \u0026lt;- t(solve(t(FF_3Factors) %*% FF_3Factors, t(FF_3Factors) %*% portfolio_and_etfs_new))\rWhich we can see as:\n\r\r\ralpha\r\rMkt_Rf_3\r\rSMB_3\r\rHML_3\r\r\r\r\r\rmyPortfolio\r\r0.0001697\r\r0.9844870\r\r0.0155642\r\r0.0629606\r\r\r\rSPY\r\r0.0000391\r\r0.9784199\r\r-0.1331473\r\r-0.0085326\r\r\r\rIVV\r\r0.0000423\r\r0.9771912\r\r-0.1341942\r\r-0.0113980\r\r\r\rVTI\r\r0.0000440\r\r0.9727841\r\r-0.0164012\r\r-0.0019078\r\r\r\rVOO\r\r0.0000430\r\r0.9769683\r\r-0.1356460\r\r-0.0099922\r\r\r\rQQQ\r\r0.0000440\r\r1.1645777\r\r-0.1440829\r\r-0.4955734\r\r\r\r\rInstead, we can estimate these using linear regression models. For my random portfolio myPortfolio we can use the lm function to fit a linear model and then use the tidy function from the broom package to tidy the output up a little:\nlibrary(broom)\rregdata \u0026lt;- cbind(FF_3Factors, portfolio_and_etfs_new)\r#sapply(regdata, function(x) sum(is.na(x))) # One column was causing problems since it consisted of just NA values. I remove it below.\rregdata$JPST \u0026lt;- NULL # This ETF failed to download or does not exist on the Yahoo Finance site\rmyPortfolioReg \u0026lt;- lm(myPortfolio ~ Mkt_Rf_3 + SMB_3 + HML_3, data = regdata, na.action = na.exclude)\rtidy(myPortfolioReg)\r## # A tibble: 4 x 5\r## term estimate std.error statistic p.value\r## \u0026lt;chr\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\r## 1 (Intercept) 0.000170 0.000112 1.51 0.131 ## 2 Mkt_Rf_3 0.984 0.0136 72.6 0 ## 3 SMB_3 0.0156 0.0226 0.690 0.490 ## 4 HML_3 0.0630 0.0200 3.15 0.00167\rWe can apply this to all our ETFs in the data using the apply command and applying our own custom lm function.\nregressionLists \u0026lt;- apply(regdata, 2, function(y) lm(y ~ Mkt_Rf_3 + SMB_3 + HML_3, data = regdata, na.action = na.exclude))\rWe can also apply the tidy command to individual ETFs and then use the stars.pval to make the data even more tidy awesome.\nlibrary(gtools)\rtidy(regressionLists$myPortfolio) %\u0026gt;% mutate(p.value = stars.pval(p.value))\r## # A tibble: 4 x 5\r## term estimate std.error statistic p.value\r## \u0026lt;chr\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt; ## 1 (Intercept) 0.000170 0.000112 1.51 \u0026quot; \u0026quot; ## 2 Mkt_Rf_3 0.984 0.0136 72.6 *** ## 3 SMB_3 0.0156 0.0226 0.690 \u0026quot; \u0026quot; ## 4 HML_3 0.0630 0.0200 3.15 **\rtidy(regressionLists$VTV)%\u0026gt;% mutate(p.value = stars.pval(p.value))\r## # A tibble: 4 x 5\r## term estimate std.error statistic p.value\r## \u0026lt;chr\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt; ## 1 (Intercept) 0.0000514 0.0000446 1.15 \u0026quot; \u0026quot; ## 2 Mkt_Rf_3 0.918 0.00539 170. *** ## 3 SMB_3 -0.131 0.00897 -14.7 *** ## 4 HML_3 0.265 0.00794 33.4 ***\rtidy(regressionLists$LQD) %\u0026gt;% mutate(p.value = stars.pval(p.value))\r## # A tibble: 4 x 5\r## term estimate std.error statistic p.value\r## \u0026lt;chr\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt; ## 1 (Intercept) 0.000241 0.0000882 2.74 ** ## 2 Mkt_Rf_3 -0.0119 0.0106 -1.12 \u0026quot; \u0026quot; ## 3 SMB_3 -0.0325 0.0177 -1.84 . ## 4 HML_3 -0.157 0.0157 -10.0 ***\rFinally, we can apply this same method to all our ETFs using the lapply function to tidy the data and the map function to mutate or convert the p-value to stars. Then take a random sample of 5 ETFs regressions.\nlibrary(purrr)\rmyTidyRegressions \u0026lt;- lapply(regressionLists[4:length(regressionLists)], tidy)\rmyTidiedRegressions \u0026lt;- map(myTidyRegressions, ~mutate(., p.value = stars.pval(p.value)))\rlibrary(rlist)\rlist.sample(myTidiedRegressions, 5)\r## $DGRO\r## # A tibble: 4 x 5\r## term estimate std.error statistic p.value\r## \u0026lt;chr\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt; ## 1 (Intercept) 0.000154 0.0000507 3.04 ** ## 2 Mkt_Rf_3 0.890 0.00612 146. *** ## 3 SMB_3 -0.145 0.0102 -14.2 *** ## 4 HML_3 0.121 0.00902 13.4 *** ## ## $EFAV\r## # A tibble: 4 x 5\r## term estimate std.error statistic p.value\r## \u0026lt;chr\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt; ## 1 (Intercept) -0.00000220 0.000142 -0.0155 \u0026quot; \u0026quot; ## 2 Mkt_Rf_3 0.572 0.0171 33.5 *** ## 3 SMB_3 -0.112 0.0285 -3.94 *** ## 4 HML_3 -0.0172 0.0252 -0.684 \u0026quot; \u0026quot; ## ## $XLE\r## # A tibble: 4 x 5\r## term estimate std.error statistic p.value\r## \u0026lt;chr\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt; ## 1 (Intercept) -0.000264 0.000270 -0.978 \u0026quot; \u0026quot; ## 2 Mkt_Rf_3 1.09 0.0326 33.5 *** ## 3 SMB_3 0.0920 0.0543 1.69 . ## 4 HML_3 0.716 0.0481 14.9 *** ## ## $IVW\r## # A tibble: 4 x 5\r## term estimate std.error statistic p.value\r## \u0026lt;chr\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt; ## 1 (Intercept) 0.0000434 0.0000407 1.07 \u0026quot; \u0026quot; ## 2 Mkt_Rf_3 1.01 0.00491 206. *** ## 3 SMB_3 -0.180 0.00817 -22.0 *** ## 4 HML_3 -0.312 0.00724 -43.1 *** ## ## $VEA\r## # A tibble: 4 x 5\r## term estimate std.error statistic p.value\r## \u0026lt;chr\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt; ## 1 (Intercept) -0.000113 0.000154 -0.730 \u0026quot; \u0026quot; ## 2 Mkt_Rf_3 0.852 0.0186 45.8 *** ## 3 SMB_3 -0.0850 0.0310 -2.74 ** ## 4 HML_3 0.150 0.0274 5.45 ***\rA few notes here: We should be modelling the excess returns on the ETFs and not just the ETF returns. This is simple enough by replacing for example myPortfolio in the lm regressions with \\((myPortfolio - RF_3)\\) where \\(RF_3\\) is the risk free rate which comes with the Fama and French data. We should also probably use \\(NeweyWest\\) adjusted standard errors by running coeftest(myPortfolioReg, NeweyWest(myPortfolioReg, lag = N, prewhite = FALSE)). Literature suggests that lags of \\(4(N/100)^{2/9}\\) should be used, where \\(N\\) is the number of observations.\rWe could rank the ETFs based on their alphas as before and go long on the high alphas and short on the low alphas. Run our hedge portfolio through a Fama French regression here and see if we are able to obtain better performances.\nFinally, here I only used the 3 Factor model. There are more factors from the literature we could use. On the Kenneth French website we can collect data on \\(Market\\), \\(SMB\\), \\(HML\\), \\(RMW\\), \\(CMA\\) and \\(MOM\\). Where the \\(RMW\\) factor is a profitability factor, the \\(CMA\\) is an investment factor and the \\(MOM\\) is a momentum factor.\nBelow I pull in the daily Fama and French 5 Factor model and plot them.\nlibrary(glue)\rlibrary(timetk)\rlibrary(plotly)\rlibrary(pipeR)\rtemp \u0026lt;- tempfile()\rbase \u0026lt;- \u0026quot;http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/ftp/\u0026quot;\rfactor \u0026lt;- \u0026quot;North_America_5_Factors\u0026quot;\rformat\u0026lt;-\u0026quot;_CSV.zip\u0026quot;\rfull_url \u0026lt;-glue(base,factor,format,sep =\u0026quot;\u0026quot;)\rdownload.file(full_url,temp,quiet = TRUE)\rNorth_America_Factors \u0026lt;- read_csv(unz(temp, \u0026quot;North_America_5_Factors.csv\u0026quot;), skip = 6) %\u0026gt;%\rrename(date = X1) %\u0026gt;%\rmutate_at(vars(-date), as.numeric) %\u0026gt;%\rmutate(date = rollback(ymd(parse_date_time(date, \u0026quot;%Y%m\u0026quot;) + months(1)))) %\u0026gt;%\rdrop_na(date) %\u0026gt;%\rrename(Mkt_Rf = `Mkt-RF`) %\u0026gt;% select(-RF) %\u0026gt;% mutate_at(vars(c(\u0026quot;Mkt_Rf\u0026quot;, \u0026quot;SMB\u0026quot;, \u0026quot;HML\u0026quot;, \u0026quot;RMW\u0026quot;, \u0026quot;CMA\u0026quot;)), funs(./100)) %\u0026gt;% tk_xts(date_var = date)\rax \u0026lt;- list(\rzeroline = TRUE,\rshowline = TRUE,\rmirror = \u0026quot;ticks\u0026quot;,\rgridcolor = toRGB(\u0026#39;white\u0026#39;),\rgridwidth = 2,\rzerolinecolor = toRGB(\u0026#39;white\u0026#39;),\rzerolinewidth = 4,\rlinecolor = toRGB(\u0026#39;white\u0026#39;),\rlinewidth = 6,\rcolor = \u0026#39;white\u0026#39;\r)\rNorth_America_Factors %\u0026gt;\u0026gt;% (cumprod(1+.)) %\u0026gt;\u0026gt;%\rROC(36, type = \u0026quot;discrete\u0026quot;) %\u0026gt;\u0026gt;%\rna.omit() %\u0026gt;\u0026gt;% (\rplot_ly(\rx = colnames(.),\ry = as.Date(index(.)),\rz = data.matrix(.),\rtype = \u0026quot;surface\u0026quot;,\rcolors = c(\u0026quot;darkblue\u0026quot;, \u0026quot;yellow\u0026quot;, \u0026quot;darkred\u0026quot;)\r)\r) %\u0026gt;%\rplotly::layout(\rxaxis = ax, yaxis = ax,\rpaper_bgcolor =\u0026#39;rgb(0,0,0)\u0026#39;,\r#plot_bgcolor =\u0026#39;rgb(0,0,0)\u0026#39;,\rtitle = \u0026quot;Fama French Factors\u0026quot;,\rscene = list(\rxaxis = c(ax, title = \u0026quot;Factors\u0026quot;, tickangle = -45),\ryaxis = c(ax, title = \u0026quot;Date\u0026quot;, tickangle = -45),\rzaxis = c(ax, title = \u0026quot;Fama French Factor\u0026quot;)\r),\rtitlefont = list(\rfamily = \u0026quot;Agency FB\u0026quot;,\rsize = 50,\rcolor = \u0026#39;white\u0026#39;)\r)\r\r{\"x\":{\"visdat\":{\"1b9c64f422fb\":[\"function () \",\"plotlyVisDat\"]},\"cur_data\":\"1b9c64f422fb\",\"attrs\":{\"1b9c64f422fb\":{\"x\":[\"Mkt_Rf\",\"SMB\",\"HML\",\"RMW\",\"CMA\"],\"y\":[\"1993-07-31\",\"1993-08-31\",\"1993-09-30\",\"1993-10-31\",\"1993-11-30\",\"1993-12-31\",\"1994-01-31\",\"1994-02-28\",\"1994-03-31\",\"1994-04-30\",\"1994-05-31\",\"1994-06-30\",\"1994-07-31\",\"1994-08-31\",\"1994-09-30\",\"1994-10-31\",\"1994-11-30\",\"1994-12-31\",\"1995-01-31\",\"1995-02-28\",\"1995-03-31\",\"1995-04-30\",\"1995-05-31\",\"1995-06-30\",\"1995-07-31\",\"1995-08-31\",\"1995-09-30\",\"1995-10-31\",\"1995-11-30\",\"1995-12-31\",\"1996-01-31\",\"1996-02-29\",\"1996-03-31\",\"1996-04-30\",\"1996-05-31\",\"1996-06-30\",\"1996-07-31\",\"1996-08-31\",\"1996-09-30\",\"1996-10-31\",\"1996-11-30\",\"1996-12-31\",\"1997-01-31\",\"1997-02-28\",\"1997-03-31\",\"1997-04-30\",\"1997-05-31\",\"1997-06-30\",\"1997-07-31\",\"1997-08-31\",\"1997-09-30\",\"1997-10-31\",\"1997-11-30\",\"1997-12-31\",\"1998-01-31\",\"1998-02-28\",\"1998-03-31\",\"1998-04-30\",\"1998-05-31\",\"1998-06-30\",\"1998-07-31\",\"1998-08-31\",\"1998-09-30\",\"1998-10-31\",\"1998-11-30\",\"1998-12-31\",\"1999-01-31\",\"1999-02-28\",\"1999-03-31\",\"1999-04-30\",\"1999-05-31\",\"1999-06-30\",\"1999-07-31\",\"1999-08-31\",\"1999-09-30\",\"1999-10-31\",\"1999-11-30\",\"1999-12-31\",\"2000-01-31\",\"2000-02-29\",\"2000-03-31\",\"2000-04-30\",\"2000-05-31\",\"2000-06-30\",\"2000-07-31\",\"2000-08-31\",\"2000-09-30\",\"2000-10-31\",\"2000-11-30\",\"2000-12-31\",\"2001-01-31\",\"2001-02-28\",\"2001-03-31\",\"2001-04-30\",\"2001-05-31\",\"2001-06-30\",\"2001-07-31\",\"2001-08-31\",\"2001-09-30\",\"2001-10-31\",\"2001-11-30\",\"2001-12-31\",\"2002-01-31\",\"2002-02-28\",\"2002-03-31\",\"2002-04-30\",\"2002-05-31\",\"2002-06-30\",\"2002-07-31\",\"2002-08-31\",\"2002-09-30\",\"2002-10-31\",\"2002-11-30\",\"2002-12-31\",\"2003-01-31\",\"2003-02-28\",\"2003-03-31\",\"2003-04-30\",\"2003-05-31\",\"2003-06-30\",\"2003-07-31\",\"2003-08-31\",\"2003-09-30\",\"2003-10-31\",\"2003-11-30\",\"2003-12-31\",\"2004-01-31\",\"2004-02-29\",\"2004-03-31\",\"2004-04-30\",\"2004-05-31\",\"2004-06-30\",\"2004-07-31\",\"2004-08-31\",\"2004-09-30\",\"2004-10-31\",\"2004-11-30\",\"2004-12-31\",\"2005-01-31\",\"2005-02-28\",\"2005-03-31\",\"2005-04-30\",\"2005-05-31\",\"2005-06-30\",\"2005-07-31\",\"2005-08-31\",\"2005-09-30\",\"2005-10-31\",\"2005-11-30\",\"2005-12-31\",\"2006-01-31\",\"2006-02-28\",\"2006-03-31\",\"2006-04-30\",\"2006-05-31\",\"2006-06-30\",\"2006-07-31\",\"2006-08-31\",\"2006-09-30\",\"2006-10-31\",\"2006-11-30\",\"2006-12-31\",\"2007-01-31\",\"2007-02-28\",\"2007-03-31\",\"2007-04-30\",\"2007-05-31\",\"2007-06-30\",\"2007-07-31\",\"2007-08-31\",\"2007-09-30\",\"2007-10-31\",\"2007-11-30\",\"2007-12-31\",\"2008-01-31\",\"2008-02-29\",\"2008-03-31\",\"2008-04-30\",\"2008-05-31\",\"2008-06-30\",\"2008-07-31\",\"2008-08-31\",\"2008-09-30\",\"2008-10-31\",\"2008-11-30\",\"2008-12-31\",\"2009-01-31\",\"2009-02-28\",\"2009-03-31\",\"2009-04-30\",\"2009-05-31\",\"2009-06-30\",\"2009-07-31\",\"2009-08-31\",\"2009-09-30\",\"2009-10-31\",\"2009-11-30\",\"2009-12-31\",\"2010-01-31\",\"2010-02-28\",\"2010-03-31\",\"2010-04-30\",\"2010-05-31\",\"2010-06-30\",\"2010-07-31\",\"2010-08-31\",\"2010-09-30\",\"2010-10-31\",\"2010-11-30\",\"2010-12-31\",\"2011-01-31\",\"2011-02-28\",\"2011-03-31\",\"2011-04-30\",\"2011-05-31\",\"2011-06-30\",\"2011-07-31\",\"2011-08-31\",\"2011-09-30\",\"2011-10-31\",\"2011-11-30\",\"2011-12-31\",\"2012-01-31\",\"2012-02-29\",\"2012-03-31\",\"2012-04-30\",\"2012-05-31\",\"2012-06-30\",\"2012-07-31\",\"2012-08-31\",\"2012-09-30\",\"2012-10-31\",\"2012-11-30\",\"2012-12-31\",\"2013-01-31\",\"2013-02-28\",\"2013-03-31\",\"2013-04-30\",\"2013-05-31\",\"2013-06-30\",\"2013-07-31\",\"2013-08-31\",\"2013-09-30\",\"2013-10-31\",\"2013-11-30\",\"2013-12-31\",\"2014-01-31\",\"2014-02-28\",\"2014-03-31\",\"2014-04-30\",\"2014-05-31\",\"2014-06-30\",\"2014-07-31\",\"2014-08-31\",\"2014-09-30\",\"2014-10-31\",\"2014-11-30\",\"2014-12-31\",\"2015-01-31\",\"2015-02-28\",\"2015-03-31\",\"2015-04-30\",\"2015-05-31\",\"2015-06-30\",\"2015-07-31\",\"2015-08-31\",\"2015-09-30\",\"2015-10-31\",\"2015-11-30\",\"2015-12-31\",\"2016-01-31\",\"2016-02-29\",\"2016-03-31\",\"2016-04-30\",\"2016-05-31\",\"2016-06-30\",\"2016-07-31\",\"2016-08-31\",\"2016-09-30\",\"2016-10-31\",\"2016-11-30\",\"2016-12-31\",\"2017-01-31\",\"2017-02-28\",\"2017-03-31\",\"2017-04-30\",\"2017-05-31\",\"2017-06-30\",\"2017-07-31\",\"2017-08-31\",\"2017-09-30\",\"2017-10-31\",\"2017-11-30\",\"2017-12-31\",\"2018-01-31\",\"2018-02-28\",\"2018-03-31\",\"2018-04-30\",\"2018-05-31\",\"2018-06-30\",\"2018-07-31\",\"2018-08-31\",\"2018-09-30\",\"2018-10-31\",\"2018-11-30\",\"2018-12-31\",\"2019-01-31\",\"2019-02-28\",\"2019-03-31\",\"2019-04-30\",\"2019-05-31\",\"2019-06-30\",\"2019-07-31\",\"2019-08-31\",\"2019-09-30\"],\"z\":[[0.235656331824658,0.12719361125789,0.161546203443221,0.0304390482130936,0.0440128290737087],[0.416750972441865,0.168795189900192,0.152453640019518,0.0469779927089966,0.0104393828074874],[0.502715210710106,0.236251162933698,0.153373120334683,0.033770819843445,-0.030401149082101],[0.560093004360497,0.315955130282715,0.135474135913219,0.00331619536480243,-0.0335757459746789],[0.445501580890665,0.297007271192553,0.147597868297894,0.0124536827325159,0.00387471213061752],[0.433515663967857,0.292403873601807,0.172888642184766,-0.000455927336921125,0.0277961309077646],[0.414680750189819,0.257035205070242,0.194923524240401,-0.030846803386302,0.0913122279704728],[0.285437333389163,0.231085846540227,0.195646624708927,-0.00117080011257586,0.0815771584817113],[0.196963905678594,0.176869191257498,0.250480392793265,-0.00696748748434617,0.116952257012042],[0.206316122912184,0.164401858229985,0.255915652823187,-0.00209236544113756,0.132129148505063],[0.173240840144559,0.137403933873663,0.27084611862598,-0.0132756409134801,0.158457733354018],[0.192197832000845,0.121393688174807,0.291192799721722,-0.0234861521684404,0.169586821215297],[0.178556337576989,0.111213596190166,0.331600536630724,-0.0457818627558735,0.190034974625445],[0.200011899756623,0.104833001340247,0.320491446794146,-0.0486116911581397,0.184263942216673],[0.195251400917186,0.116459391106515,0.315437188637601,-0.047945586120943,0.189233378281525],[0.191952530614014,0.0854067246806089,0.298557393134282,-0.0224544740251954,0.189353188212845],[0.192698666783412,0.09064707096754,0.312498960238484,-0.0332841450482498,0.191021452378257],[0.0935238866937333,0.122519553524729,0.38232894820008,-0.0598284071391612,0.2507033517076],[0.116314809422852,0.012975203797587,0.351441890896562,-0.0305858683034936,0.227075146257368],[0.145383204955348,-0.00769368404727278,0.297172810768038,-0.0155752051975765,0.200554919569283],[0.204147981767266,-0.00298463751559075,0.2243748354899,-0.0139877433232731,0.174302345823063],[0.216173982573999,0.0518785863811539,0.200701694819175,-0.0225403920102994,0.151263457623384],[0.247936102134843,0.0360576911683621,0.204270255433855,-0.00513371332929846,0.146701740109274],[0.307373778299483,0.0932451049461138,0.137411887339277,0.00893226123481994,0.102296433544678],[0.306491014100766,0.126781584452029,0.11828128151939,-0.000410624446992025,0.0781126107690535],[0.344075368621888,0.146884533437943,0.146221482111235,-0.0507962731179592,0.0981855782968859],[0.377173441446655,0.125421832633012,0.147147160675428,-0.0573470234760132,0.118573646746753],[0.34252585288411,0.0567636068466464,0.177923990907149,-0.0606662240975765,0.144058109683463],[0.347973257562028,0.015993090589461,0.211250029744542,-0.0781897093423642,0.191187177023668],[0.340937352238925,0.00479867581857851,0.180283602301764,-0.0753131118981941,0.211623636183806],[0.363698945174488,-0.0434551990962814,0.122246069261056,-0.0522054100652527,0.205826393905415],[0.374287091473872,0.00300864221549735,0.0265709543179899,-0.027429641696892,0.129189274109536],[0.354009843983882,0.00958052451334535,0.013306725072691,-0.00471526492904928,0.0984404624529147],[0.417672353843713,0.0626683513919197,-0.0455355182360554,0.0309918575250425,0.0484722747166004],[0.408570566357946,0.0766604472046852,-0.0318064493521603,0.0307864192750624,0.0566584808769306],[0.39002935028702,0.0272743146978776,-0.0316164025270259,0.0683509152732753,0.0596804824494583],[0.314402377002984,-0.020985530963431,-0.00233727298283182,0.101119753015762,0.0765288717081505],[0.305265770404778,-0.00288086887943817,-0.00811620418896331,0.0909914769432321,0.0550887950998713],[0.37377781355228,-0.0462127535603084,-0.0375712486485237,0.098722826864678,0.0269038317890493],[0.368644215665075,-0.0881580452462788,0.0438375711391912,0.0917702600346066,0.0546054979661184],[0.482721143361634,-0.112487398406493,0.0749247953123675,0.0959931143578587,0.0602411191994521],[0.433715211414997,-0.0938713232568118,0.0698212948004988,0.0963223073237252,0.079280360806264],[0.4625567127525,-0.107299484281944,0.0335134803815706,0.129249927020376,0.0530448895850839],[0.496503289427253,-0.147471007489256,0.0944554606278381,0.109186262341304,0.120244659541414],[0.491953216519579,-0.145924079881878,0.11716021947087,0.124145094784313,0.130712176277564],[0.540740872640734,-0.191043444146704,0.0971618758155439,0.157880655455308,0.101399480135523],[0.630976837983005,-0.134348616976711,0.0438689897555926,0.172761331759985,0.056715509998446],[0.749363695711662,-0.121554453161668,0.0329368196563609,0.175797758231381,0.0425140164856161],[0.825763296856934,-0.130853958136341,0.0246124855212335,0.178273866627175,0.0176228226854103],[0.68360543177435,-0.0703607705168348,0.0539411900929401,0.160399991791368,0.0214453652680864],[0.813073864181017,-0.0718988597529627,0.0667291519545328,0.140103140360734,0.00345752031211677],[0.724902238088593,-0.0619771920960762,0.111577925074181,0.136499495507757,0.0288295196672432],[0.843960238465473,-0.115498012967471,0.134742826699399,0.159934797883648,0.0619744026420159],[0.8532814766617,-0.12872072753232,0.176825100517058,0.152208818019029,0.081229168659235],[0.827691240274222,-0.124987435403811,0.136248922290186,0.154601893400139,0.0696865645440461],[0.887303286902871,-0.12155359660131,0.121118508339388,0.143785411640161,0.0501572859297159],[0.935108817593125,-0.123583972169411,0.153935067989936,0.14113829305818,0.0534209326328559],[0.9102900144695,-0.121916947989936,0.141876992555499,0.125988916141387,0.032236205675334],[0.803028733299559,-0.131034780760477,0.160938352861888,0.138259741162324,0.0555397977875467],[0.809889037748211,-0.188802751954098,0.166913946607316,0.132932295650013,0.0542347825831937],[0.698780019600734,-0.246620609461188,0.174325200929141,0.144310058587335,0.0940803868824052],[0.414607543439043,-0.290243167968015,0.170876375082066,0.214962314879126,0.150848708843285],[0.452992087693615,-0.283403352686716,0.139697096988293,0.189029931507835,0.113228097261483],[0.580398323385506,-0.277350132493539,0.129961969539393,0.178876260125701,0.111671290412851],[0.609138367946255,-0.270808999226358,0.0838364584266291,0.19888971295085,0.0904494744831099],[0.687834967665635,-0.284445516499356,0.0367699777229393,0.212244129221552,0.0115937835210702],[0.702826962009956,-0.279676620628594,-0.00917271509803308,0.188382009571607,-0.0674121673897199],[0.612000553526612,-0.323578948490959,0.0294217605655285,0.165825308091227,-0.0076345512976107],[0.652128703773085,-0.356135756177754,-0.00273490886903516,0.137020932052855,-0.0273199800957551],[0.690196185426843,-0.361046533135117,0.0626527816422324,0.108618040537601,-0.00169952656337924],[0.619702395041897,-0.358815680181268,0.0931126962785895,0.112263720192583,0.0305425955790051],[0.713977716337787,-0.323253636220458,0.0355127043345604,0.091246951738569,-0.0171892917764586],[0.758191791185991,-0.283221939732876,-0.00713124401207743,0.0886661548483718,-0.0330456716695445],[0.685888162207606,-0.311140179292285,-0.024385517722365,0.10349662214449,-0.0114217568421809],[0.564353743343398,-0.277037513216707,-0.0399159937163092,0.0837014894776758,-0.00339362349416816],[0.631059973441547,-0.308438389272701,-0.116069707523365,0.0530774871879585,-0.0400044422104336],[0.577673134581722,-0.247744739467366,-0.208478638930302,0.0229063281991708,-0.0820782621637022],[0.719069882452169,-0.24570353903177,-0.282108532983297,-0.0352470893183078,-0.161594691409598],[0.567584730383172,-0.212201399236759,-0.270810616708794,-0.103333832248695,-0.115233611959491],[0.59921019769292,-0.0563562186936151,-0.403169664294586,-0.23732464638257,-0.195728091791677],[0.796651860548267,-0.181979153154105,-0.369999648526716,-0.159693838293407,-0.218299745422938],[0.645172839389433,-0.155284647540919,-0.323877439520509,-0.13472297471351,-0.148134988712772],[0.487968120396763,-0.209881413796043,-0.261646380980994,-0.108960905222514,-0.0905179370402545],[0.484816859456377,-0.159936337208494,-0.345560160234489,-0.161442647694013,-0.142697627835499],[0.352664007566271,-0.148787344152928,-0.282741812525804,-0.113863140162991,-0.0808413007066509],[0.510448957474189,-0.210437264675086,-0.298194412615014,-0.14678214764108,-0.0753562836885152],[0.3556082440527,-0.22398406145976,-0.231168824049575,-0.0999115840323502,0.0200672474965569],[0.36772069173982,-0.245012397056348,-0.198575357375914,-0.0207123655048754,0.0845104819375362],[0.196438787107622,-0.204457861271901,-0.0788898022838032,0.0839225444460361,0.204451013089104],[0.197618707016012,-0.150330528956728,-0.0110550704137208,0.0921669513093166,0.275044570509885],[0.236664981492182,-0.107691691218474,-0.0763389566949494,0.0129384959981884,0.148131602469016],[0.0427462973557569,-0.0844381921422784,0.0910158843671702,0.119735230787535,0.334276847377688],[-0.0781979507923356,-0.0646108564563991,0.192177523097374,0.174620891116606,0.445088766243454],[-0.0157571296469586,-0.0656389620298383,0.0886131875583314,0.150675913211874,0.359168498552319],[0.0215217275257378,-0.00508475424039256,0.0784599896563007,0.132467215148983,0.344759884825204],[-0.026630477533061,0.0831429934083177,0.106073160223084,0.142551215363916,0.359603015388057],[-0.0207245949923834,0.104381091318285,0.161354300458175,0.205426400379512,0.421195769440871],[0.0965356769743508,0.179299386318344,0.185071698052216,0.199527086837687,0.436464595439161],[-0.0623735408605962,0.120292946613076,0.248193651710127,0.263287706994205,0.557383581353241],[-0.103014239323061,0.221316260930201,0.175574235930518,0.235147945181147,0.45674641084667],[-0.0867393134064126,0.216690524070304,0.216529883661904,0.200948027066875,0.413118934389933],[-0.123631769646343,0.29846100734031,0.298603463454983,0.198206680835976,0.491379439638278],[-0.165771379793959,0.332450055912979,0.403263780271012,0.28113220690749,0.648040945270779],[-0.148971909458007,0.384255179324311,0.446371206242631,0.397503890060391,0.696651997860647],[-0.141395503000695,0.489390299668806,0.496118439869156,0.412290786445199,0.744410642550786],[-0.220063885129441,0.513715052377395,0.556044236512522,0.493161984893271,0.860425969886399],[-0.212254962034088,0.426669487850039,0.576574950149059,0.501170601022019,0.895059630729313],[-0.302824578698618,0.439047178368702,0.67129356120007,0.54558128692538,1.0130856172173],[-0.33882691081384,0.332874091428508,0.59654079824355,0.57764095407812,0.960505022737744],[-0.325687914009573,0.347089609925205,0.653665034533189,0.590205541069284,0.934265742569261],[-0.377174285388762,0.348789325049832,0.738747153300134,0.643645690950813,0.938604872408816],[-0.365853397648029,0.389617855498958,0.679903873658941,0.631359582468384,0.948748508287792],[-0.347046054812814,0.359258247310594,0.807110997316257,0.537612820457131,1.12637200878098],[-0.423796033058605,0.32483999460011,1.06512826988946,0.713190809930958,1.2562302907156],[-0.412900408527014,0.29957056691019,1.05542604790978,0.797365451448357,1.17373281079596],[-0.432135371529818,0.103543467341974,1.39222047766962,1.14307799338573,1.24693318363389],[-0.464028919885347,0.283133477929722,1.14053417319356,0.95571560910595,1.24468039319512],[-0.390849769888612,0.338524347884759,0.99231876105194,0.769299400454565,1.09564645493395],[-0.328513712126047,0.426226904053024,0.904288713171937,0.645360895833609,1.06525998920943],[-0.342440931100859,0.346748412894352,1.12636010088142,0.750073573425975,1.16133379250493],[-0.312842364316652,0.421134760403188,0.926119912009178,0.590147342521044,1.08417277318488],[-0.342478924033391,0.464065467235922,0.990127566577475,0.624730220735638,1.13844592301948],[-0.312673710425014,0.459563778138093,0.816812608882647,0.585091190277961,0.961567214065054],[-0.249468852368124,0.552656684260796,0.753794894045749,0.420663242579728,0.847001972471013],[-0.150809445181372,0.600678606693605,0.524401304265839,0.241381650405121,0.628579239646941],[-0.12554288877199,0.490465946572226,0.396098556989886,0.228681778534667,0.520950608872603],[-0.135367297963511,0.466677314227051,0.544950664442598,0.266077009849014,0.736428548196585],[-0.0272762320323171,0.430859269042255,0.329042228305028,0.172054545338931,0.516285454030384],[0.0371661928200955,0.444825064924655,0.205938280716681,0.142981372307737,0.390919414830308],[-0.0577259398129899,0.416497995531313,0.278826106105841,0.236931563143562,0.467093416369843],[-0.0538013552703623,0.365727948546277,0.261017602912055,0.222636805856705,0.446759181462919],[-0.0151967594021603,0.328950324263422,0.275750882275018,0.219120694455492,0.47746277392739],[-0.0317057782571175,0.339392861964417,0.286139934539788,0.178054857868906,0.389018680010861],[0.0338116749536603,0.296258538199118,0.255573537558038,0.142951776761723,0.277578785912568],[0.164421226738052,0.423210987313067,0.235684976012698,0.0953930050837164,0.187435085801423],[0.155893583733916,0.35759909774428,0.330502387538424,0.112030201394222,0.284070536586888],[0.122527804585852,0.41695585669518,0.356251450980353,0.146327421546198,0.32571606750322],[0.1407452814971,0.341720453589879,0.332619190021156,0.135836809511755,0.319284375690581],[0.128571457474619,0.322943025901922,0.314160787834695,0.117321261901983,0.265537164776865],[0.17970750694391,0.336385404736539,0.272866457232386,0.0630823656931492,0.181011054608512],[0.112496087499762,0.270235356774811,0.279542550476653,0.0840593256927322,0.19446381842],[0.13996222850788,0.153405883087138,0.187772568484328,0.0550687451543186,0.110135567569],[0.193351112970671,0.209112832526642,0.144717255749182,0.0351598209965953,0.0580863447091007],[0.29944965818947,0.220576418173703,0.146395070761516,0.0105060290974381,0.0234741239590555],[0.475139108920238,0.324776689988596,0.169619198293223,-0.0197094114861801,0.0224421879599033],[0.456074780044641,0.327040127549381,0.174121285613933,-0.0343290538432751,0.035277056486632],[0.634925086805798,0.289734811827267,0.178200118864204,-0.0479061497470602,0.0372783042303748],[0.481845629584651,0.317684889016272,0.252686926891501,-0.034547564826561,0.0337480277194804],[0.453717291540783,0.305421951667473,0.257769336575613,0.0379629450343124,-0.0160364346363264],[0.540306673167684,0.297137667591447,0.209166302474551,-0.0106776654006702,0.000973307697599068],[0.634433893223865,0.360707708046822,0.218031336127323,0.00145695218539332,-0.0141823793997248],[0.653552995829983,0.367849088831888,0.22557709380517,-0.0236489345469594,0.0176342758988879],[0.662900662274723,0.406083864201053,0.251198479102953,-0.0337740567072131,0.0160001783061157],[0.555711005231767,0.394251656651594,0.287954159309205,0.0180310749157169,0.00316627909735545],[0.413923574450204,0.307846575090108,0.309464875957375,0.0709240822509309,0.00504839219134667],[0.385230021466583,0.281645760450485,0.316662614132236,0.0790001122421069,0.0129501938838097],[0.346039470687939,0.20074903969079,0.362821628792156,0.139837950774987,0.00753549278801402],[0.341180596501066,0.175599400768869,0.333645198893981,0.145320184062586,0.00802914075116345],[0.373717071095249,0.144604092719545,0.342437585581326,0.130942832735518,0.0209422442355658],[0.337832534251286,0.137585399139505,0.289520191166643,0.15657033519462,-0.00430826568173326],[0.34126016983372,0.110126824568269,0.281973153047524,0.154827987597159,-0.0266800387877657],[0.291598125657902,0.132070134394331,0.288903418765788,0.145325138125712,-0.0173360130318683],[0.280717780980992,0.111371712591781,0.262819983341604,0.187078703524697,-0.0303495149193215],[0.239587449328957,0.130734752342554,0.256060911173852,0.163505178346562,-0.0242628155090754],[0.265678745570651,0.103244715891344,0.256936563636577,0.154672495833234,-0.0279926226724045],[0.343966818474265,0.110336279721683,0.276980305134897,0.12591947435253,-0.0122212830139099],[0.376218836733128,0.112450146386484,0.273805316807858,0.163121978334288,-0.0303384365152497],[0.325237778296718,0.0984762878253973,0.249287299161275,0.165204145973275,-0.0324697737514034],[0.330473149496976,0.0975747890253764,0.165552973984296,0.136287820604877,-0.0478227692065888],[0.33885177888705,0.0953545507548688,0.136833454617444,0.113586910959555,-0.0425600069019322],[0.361804273137171,0.0382707619138725,0.109557634452675,0.114818012067149,-0.0612417628648212],[0.370645418329681,0.0394064996208188,0.0638667053777624,0.111371038361376,-0.0764668766791181],[0.23846714946849,-0.0396051332587163,0.042616722733017,0.128550903819241,-0.0584276674640306],[0.19207857157028,-0.0308383629835175,0.0372892552588777,0.153249638588099,-0.0737911002106129],[0.146398963269919,-0.0341554050268595,0.069077316121344,0.114692498815554,-0.0475671132888651],[0.0967067185802344,-0.0338668347863537,0.0455349135642085,0.115895561755798,-0.0668398282013811],[0.100945414197205,-0.0221205349053366,0.0348304805054689,0.113582025691342,-0.0616771163242104],[0.187098473792538,-0.000742782701518285,0.0384600091974914,0.131587567818878,-0.0773693990856632],[0.17482486893257,0.00502423048645118,0.0161556851116724,0.161441151825378,-0.0819079895328878],[0.072149924977108,-0.0175518366584808,-0.0370861533998864,0.208476994599815,-0.0916739456903903],[0.0147446084134004,-0.0177433470217051,-0.00957711634779113,0.169178889837766,-0.0491362701555037],[0.0321186222547014,0.00719002643103983,-0.015127613286949,0.196491771463212,-0.0282214510627434],[-0.0792544633215342,-0.0026548391774025,0.0124410202877092,0.166632796774291,0.0378926459912741],[-0.229343164366065,-0.0206570922332457,0.00979704012223293,0.213872582420457,0.0768813813870892],[-0.315474526146099,-0.0758558915437424,-0.01152305093601,0.251276866552052,0.116032794970138],[-0.306247273128598,-0.0371231776876773,-0.0293680866212863,0.25002646496661,0.100860817749433],[-0.379919535843031,-0.103415434794105,-0.102431605524669,0.281571294645318,0.0814869144128898],[-0.438149492963744,-0.10980675046977,-0.157159211702211,0.317391205817944,0.0363322123115577],[-0.397035777360105,-0.13280290511433,-0.151434191863609,0.290701543664147,0.0202892729573176],[-0.341483913431637,-0.0803347102759999,-0.137466370535563,0.292101712991593,0.0181309094303606],[-0.272858672908575,-0.0748795469702124,-0.15635827754642,0.260065074268208,-0.0303371793982284],[-0.270518952197975,-0.0539176031704436,-0.187383765798862,0.234253223229426,-0.0267490681508772],[-0.20518461293785,-0.00776487250452607,-0.170488962686628,0.206246293341623,-0.015416428916567],[-0.19825828674099,-0.010331848953768,-0.118472039084559,0.20415787425752,-0.00982329991335051],[-0.172860172662618,0.0441777702383348,-0.113485724330944,0.225251730913683,-0.0329143771090472],[-0.221157385394722,-0.0134969200382707,-0.127072150011696,0.262992990510587,-0.036709922977292],[-0.190306827729504,-0.0323655449404027,-0.131601410458652,0.276585854117973,-0.033198537520344],[-0.171160580834285,0.0252629809057698,-0.147052436296615,0.303582357559303,-0.0556602517255865],[-0.210952733132471,0.0321411845425663,-0.132958390911491,0.283449309988389,-0.0440191215152251],[-0.167103388836322,0.0290938235016966,-0.115678039958058,0.285122814605224,-0.0355548577757483],[-0.122775789213438,0.0474245250511114,-0.106877065037258,0.260993248545182,-0.020069976667634],[-0.139161452307275,0.105508589852709,-0.0783875739473077,0.257263234992001,-0.00901997241291308],[-0.235050016545398,0.109378256883897,-0.102461597439412,0.241177788623636,0.00848921978856465],[-0.264321459022391,0.0829172370417046,-0.130374174572184,0.230950670937171,0.00495491292037586],[-0.18524572892663,0.113270050769876,-0.0944310745931531,0.220346382555001,0.047310906290732],[-0.226602581267794,0.107403014929191,-0.106418698807815,0.246337532690554,0.0136077170217317],[-0.184591973142496,0.164461280027677,-0.10165927776285,0.24883996725072,0.0497479590050935],[-0.17208033707754,0.166312018130433,-0.0780606264542125,0.259835256607204,0.0566069876877766],[-0.117171766244837,0.255609483570858,-0.0679212468036735,0.235212666147095,0.0498245015926055],[-0.051658720844001,0.264096704732172,-0.0311261943109282,0.170048190096305,0.0887934094599552],[0.0331358150660057,0.249668126183209,-0.063812873736634,0.175444442025764,0.0762492166932811],[0.0990739094304516,0.266589160149848,-0.0551549308721156,0.130398987077997,0.0922358262809522],[0.11833832547214,0.294355228825805,-0.076017831742057,0.143259679946415,0.0815044858773271],[0.0977272390687673,0.319408966955074,-0.0976087871417335,0.128751308373491,0.101117835672438],[0.0559274320743501,0.27128813806885,-0.0829161025135795,0.137610339538985,0.102228729372673],[0.125061443099413,0.253659340591667,-0.0565707146018506,0.109099884855266,0.118775017226122],[0.116605771071244,0.213206889652318,-0.0864913518418985,0.166161524461698,0.0572920091448565],[0.0400941170875524,0.151952999724667,-0.112413537131732,0.159877711015495,0.0277101744143315],[0.0561524401215596,0.11401095390376,-0.147428494292897,0.209707923463144,-0.0207538155561487],[0.444103030027715,0.194996276131678,-0.142277004832431,0.169963925977702,-0.0527949782223657],[0.557884638657838,0.243582523133574,-0.116430243780942,0.159597157013343,-0.0662710972225153],[0.539926756616166,0.183910571779305,-0.0739794063313113,0.160525113125787,-0.0255836805023775],[0.752519888313339,0.230444533924196,-0.0368387420892894,0.115750018411518,-0.0122410087744682],[1.02866039446125,0.227831596800887,0.0214235505846665,0.106483358183461,0.0123089999058841],[0.90897651528057,0.209715847989548,0.0216262340950513,0.118881562258044,0.0475548002906001],[0.716834780578181,0.128286095465304,-0.0235030964835055,0.114913506279195,0.062253984344748],[0.501224789390293,0.142739536704489,-0.0192077986973689,0.157546220441809,0.127332568504128],[0.560960806368137,0.129686086556018,0.0137855206323865,0.151494299723633,0.132050381166262],[0.45790708322927,0.0818967808967739,-0.0236328395668965,0.172999089290449,0.114677055100159],[0.454227643881186,0.0872933131239129,-0.0691120422775174,0.183410323810778,0.0742933518962967],[0.430022974851596,0.0628621219718795,-0.0746235162723219,0.143943909666966,0.0955966194976399],[0.446640888895018,0.0972368480064212,-0.0193814017921629,0.0917860660895147,0.132455952119656],[0.376613458138258,0.119640867363367,-0.0233156790166676,0.0945022220903349,0.15210712481584],[0.353498430645496,0.0816473668405155,0.00302864774619538,0.0676060121142743,0.164826091468765],[0.479339936701153,0.0803563614295262,0.0105844191039821,0.0716037271682393,0.168944105736945],[0.440113393205558,0.0573224088020681,-0.0129152478961886,0.0760047842466622,0.179203114543652],[0.405421661892805,0.0479664932783059,-0.0313963380518569,0.0970302903071669,0.194672684322997],[0.396458513538897,-0.019978697670004,-0.0490764441482607,0.0894361328386639,0.190192956475722],[0.553927625278306,-0.00825829142328305,-0.0140301214510221,0.0722762376150063,0.176773299313304],[0.619373466004313,0.0192059464847671,0.0288826633326094,0.0712028880278039,0.183158524209096],[0.600295293333294,0.0357974344780776,0.0197171244134828,0.0571869493210877,0.15627909044328],[0.632281103403058,0.0581702369344557,0.023058747350629,0.0580268197872813,0.166905777664413],[0.548035298760441,0.0433413315168953,0.0295212682202917,0.0617369629285052,0.152658129058022],[0.551015441793958,0.0188176881994795,0.0521090380461506,0.0702662393340601,0.158644169476579],[0.581478794385487,-0.00985097952281477,0.043288962278099,0.0757338921644755,0.157838035972322],[0.519451310078876,-0.0283282864807718,0.0105408878954112,0.108311603895654,0.124640807322442],[0.438993994189232,-0.00112505264974405,-0.0165689968572815,0.0723633732303763,0.0976467618681403],[0.44881695098064,-0.0175113116092227,-0.0247969056485153,0.0923636277453741,0.0936853299456086],[0.451557917033476,-0.0460938505897358,0.0383849872625808,0.0868072442334149,0.109095462596162],[0.415689086317793,-0.076505209940313,0.0796868032181168,0.105826908286145,0.126841882899351],[0.465407765151122,-0.0854539835191694,0.0903063144645331,0.077301245802369,0.123775491966245],[0.535445087260149,-0.0543138570038015,0.0956536279875801,0.0265306710245361,0.0980590347202901],[0.538901881357541,-0.0864178390920175,0.115157176446316,0.0143508111310304,0.120015734455566],[0.702329433124968,-0.0545968611049092,0.12287374182724,0.00435917587560253,0.121142964462063],[0.816476003077452,-0.0534152302678359,0.0950915306450977,-0.0106049836247348,0.108613727581226],[0.661303752187096,-0.0639542222824739,0.0590269547109399,0.00309910263989055,0.104841423063836],[0.706032444731414,-0.0788465023025495,0.0294268224364107,-0.00153255644489902,0.0938104835888018],[0.697020213138594,-0.0554006436589423,0.00598087329194885,-0.0187974107912291,0.0713989461992857],[0.556125782979657,-0.0880780766839334,0.00243538249771991,0.0178867863873573,0.0761868350508768],[0.583423618321421,-0.0709818509225358,-0.0135587999114977,0.00479532123840753,0.0526653862608426],[0.527756381739808,-0.0364832512350493,-0.0305849648569793,0.0121842663830034,0.0324118341818227],[0.554664329284541,-0.050974418648593,0.0038183356383219,-0.00522750448705533,0.0244978758710217],[0.682969959890018,-0.0432579890070085,-0.0190615686974176,-0.0391368813543788,-0.0075707558359116],[0.594554823188643,-0.0226726444134747,-0.0330651821222224,-0.032241663907053,-0.0249023242991862],[0.59518626753007,-0.0497540056981319,-0.0870184553199301,-0.03157034210023,-0.0474068265558438],[0.460287779160701,-0.0539043753377273,-0.0608554020992473,-0.0187415135852265,-0.0280584809755815],[0.372926204823753,-0.0901809042928746,-0.0606689529037142,0.0132147977981161,-0.0384721401079861],[0.500770100688199,-0.105894217322458,-0.0843587203490838,0.0246762721293343,-0.0591481374861739],[0.497787944502033,-0.0860351394080596,-0.0897990864618133,-0.00410905495152758,-0.0742629730402438],[0.442341697790457,-0.131051854480387,-0.135847242777663,0.00570417358054276,-0.0773873584796554],[0.290891026779706,-0.161683963971917,-0.112043723641189,0.0417018527115263,-0.0727828722561955],[0.281940712608293,-0.141222795972038,-0.105382053067326,0.0566664443705907,-0.0598577496648088],[0.322607812641861,-0.135344844669793,-0.0838206645089966,0.0506853135533987,-0.073691508498464],[0.320648780629456,-0.0891635915091824,-0.0498440018273528,0.00851979061354413,-0.0587362505631677],[0.30596488703814,-0.108987783578955,-0.085868873795984,0.0214927485197449,-0.0725099152789151],[0.324663206399673,-0.112695185311636,-0.0915105351362836,0.0271222175747132,-0.0522100623352892],[0.302478951736721,-0.109992114433556,-0.119455681963211,0.0545648109802113,-0.0659805574216004],[0.34203304732655,-0.101293523350928,-0.086110582239658,0.0383455665168322,-0.0466751315134004],[0.297048699371471,-0.107371816517835,-0.0850002579495777,0.0193741968410555,-0.0353743200024649],[0.22053914980724,-0.122511863911856,-0.0638100243845494,0.00372854801114531,-0.0376744706552161],[0.241318831801234,-0.083531726582407,0.00421827295787769,-0.0261812422873728,-0.0129798230949463],[0.230676191777997,-0.0768004473833441,0.0361588021437755,-0.0192211927808703,-0.00386276925204809],[0.301652236385612,-0.0906562402911183,0.0295430116770625,0.0111278162099226,-0.00940750639314081],[0.283504678468089,-0.10891031955822,0.00100204429830897,0.0164894744649628,-0.0182778889196537],[0.27814717533793,-0.0968637076555565,-0.0731002180315402,0.0148904348826759,-0.0507458021823892],[0.285669438015729,-0.0692670995690533,-0.117398899714761,0.00404232023520801,-0.0752857532155109],[0.272432009991445,-0.0769512668236559,-0.151784804615923,0.0267155380982336,-0.0825750620835444],[0.249661392423032,-0.0808066427854418,-0.141731257977406,0.0226237839611161,-0.0692518527171977],[0.301082011286262,-0.0530103890219149,-0.134955000669812,0.00750311870258624,-0.0703689739181772],[0.251194280890028,-0.0709279379251053,-0.146757029463099,0.0145191571336625,-0.0882213292350511],[0.314427369611584,-0.00221159171317864,-0.10293806014629,-0.00814605930684842,-0.0641157781008013],[0.313783231921879,-0.0390400849503172,-0.08631720441357,0.00471203924621411,-0.093250555042833],[0.322265886324818,-0.0175062446355847,-0.0684258583184014,0.0207763257008022,-0.0940654072649614],[0.340549723229911,-0.0392901736763341,-0.0774801344152769,0.0461088545322705,-0.0921793532898015],[0.461370013213338,-0.0550442977642412,-0.0677875819941745,0.0259263607174771,-0.0918121861930534],[0.322323031268404,-0.0618121094185707,-0.0789348322297531,0.0451993940568822,-0.0988545567521113],[0.30934071001,-0.0576932357526032,-0.0713111980562231,0.039868877147192,-0.0921458281001653],[0.299498963994694,-0.0306543042103539,-0.087674966277132,0.0254335180237324,-0.0794861441220276],[0.318927116822733,-0.0064279007807807,-0.102542760674734,0.0261614395962064,-0.0907910253800416],[0.347106452923331,-0.0296806851603626,-0.0989980136285842,0.0408870879516761,-0.0738960090873662],[0.374568494417859,-0.00172112135070224,-0.0461316510213025,0.0415055591863474,-0.046050378761296],[0.506370427230116,0.00345440224747962,-0.130464759066043,0.0471184633975312,-0.088849148536589],[0.559518106038752,0.0113116590546927,-0.144617575611614,0.0367979581403115,-0.0785242341547834],[0.337040585843138,-0.00584147626798848,-0.124013102066176,0.0376263196368782,-0.053211494607542],[0.352613880869882,-0.042330606775917,-0.111500271288274,0.0527811111503163,-0.0360353274063081],[0.254443647383888,-0.0340288287541604,-0.0984394341165215,0.0575467433806518,-0.0444844201541413],[0.445131856432483,0.0266933474729989,-0.146257964848876,0.0221339058723342,-0.0799324664950635],[0.490679598965165,0.0300290647582806,-0.177620609110782,0.00403948188954328,-0.112317838920501],[0.406532825341337,-0.0192905535148742,-0.221086238811634,0.0179775112496399,-0.133263744155052],[0.445201350405111,-0.0534279630697875,-0.241356765608826,0.0660301897036897,-0.165621672412058],[0.328176958583177,-0.0589551127870885,-0.233026015805885,0.0611264508310527,-0.137250758364619],[0.422581367492382,-0.0594232011710984,-0.242167632804993,0.0619723912004249,-0.163829341358765],[0.383567155624086,-0.0874368532573123,-0.226706446951865,0.0494108646411293,-0.150481217982387],[0.34333997157129,-0.128806382576314,-0.257963690293995,0.0724655425098955,-0.153632315218944],[0.359137671057578,-0.13774787435684,-0.204012420531773,0.106058483330912,-0.125581078244624]],\"colors\":[\"darkblue\",\"yellow\",\"darkred\"],\"alpha_stroke\":1,\"sizes\":[10,100],\"spans\":[1,20],\"type\":\"surface\"}},\"layout\":{\"margin\":{\"b\":40,\"l\":60,\"t\":25,\"r\":10},\"xaxis\":{\"zeroline\":true,\"showline\":true,\"mirror\":\"ticks\",\"gridcolor\":\"rgba(255,255,255,1)\",\"gridwidth\":2,\"zerolinecolor\":\"rgba(255,255,255,1)\",\"zerolinewidth\":4,\"linecolor\":\"rgba(255,255,255,1)\",\"linewidth\":6,\"color\":\"white\"},\"yaxis\":{\"zeroline\":true,\"showline\":true,\"mirror\":\"ticks\",\"gridcolor\":\"rgba(255,255,255,1)\",\"gridwidth\":2,\"zerolinecolor\":\"rgba(255,255,255,1)\",\"zerolinewidth\":4,\"linecolor\":\"rgba(255,255,255,1)\",\"linewidth\":6,\"color\":\"white\"},\"paper_bgcolor\":\"rgb(0,0,0)\",\"title\":\"Fama French Factors\",\"scene\":{\"xaxis\":{\"zeroline\":true,\"showline\":true,\"mirror\":\"ticks\",\"gridcolor\":\"rgba(255,255,255,1)\",\"gridwidth\":2,\"zerolinecolor\":\"rgba(255,255,255,1)\",\"zerolinewidth\":4,\"linecolor\":\"rgba(255,255,255,1)\",\"linewidth\":6,\"color\":\"white\",\"title\":\"Factors\",\"tickangle\":-45},\"yaxis\":{\"zeroline\":true,\"showline\":true,\"mirror\":\"ticks\",\"gridcolor\":\"rgba(255,255,255,1)\",\"gridwidth\":2,\"zerolinecolor\":\"rgba(255,255,255,1)\",\"zerolinewidth\":4,\"linecolor\":\"rgba(255,255,255,1)\",\"linewidth\":6,\"color\":\"white\",\"title\":\"Date\",\"tickangle\":-45},\"zaxis\":{\"zeroline\":true,\"showline\":true,\"mirror\":\"ticks\",\"gridcolor\":\"rgba(255,255,255,1)\",\"gridwidth\":2,\"zerolinecolor\":\"rgba(255,255,255,1)\",\"zerolinewidth\":4,\"linecolor\":\"rgba(255,255,255,1)\",\"linewidth\":6,\"color\":\"white\",\"title\":\"Fama French Factor\"}},\"titlefont\":{\"family\":\"Agency FB\",\"size\":50,\"color\":\"white\"},\"hovermode\":\"closest\",\"showlegend\":false,\"legend\":{\"yanchor\":\"top\",\"y\":0.5}},\"source\":\"A\",\"config\":{\"showSendToCloud\":false},\"data\":[{\"colorbar\":{\"title\":\"\",\"ticklen\":2,\"len\":0.5,\"lenmode\":\"fraction\",\"y\":1,\"yanchor\":\"top\"},\"colorscale\":[[\"0\",\"rgba(0,0,139,1)\"],[\"0.0416666666666667\",\"rgba(61,23,136,1)\"],[\"0.0833333333333334\",\"rgba(89,44,132,1)\"],[\"0.125\",\"rgba(112,64,128,1)\"],[\"0.166666666666667\",\"rgba(131,84,124,1)\"],[\"0.208333333333333\",\"rgba(149,104,118,1)\"],[\"0.25\",\"rgba(166,124,112,1)\"],[\"0.291666666666667\",\"rgba(182,145,105,1)\"],[\"0.333333333333333\",\"rgba(197,167,97,1)\"],[\"0.375\",\"rgba(212,188,86,1)\"],[\"0.416666666666667\",\"rgba(227,210,72,1)\"],[\"0.458333333333333\",\"rgba(241,232,52,1)\"],[\"0.5\",\"rgba(255,255,0,1)\"],[\"0.541666666666667\",\"rgba(247,235,0,1)\"],[\"0.583333333333333\",\"rgba(238,216,0,1)\"],[\"0.625\",\"rgba(229,197,0,1)\"],[\"0.666666666666667\",\"rgba(220,177,0,1)\"],[\"0.708333333333333\",\"rgba(211,158,0,1)\"],[\"0.75\",\"rgba(202,140,0,1)\"],[\"0.791666666666667\",\"rgba(192,121,0,1)\"],[\"0.833333333333333\",\"rgba(182,102,0,1)\"],[\"0.875\",\"rgba(172,82,1,1)\"],[\"0.916666666666667\",\"rgba(161,62,1,1)\"],[\"0.958333333333333\",\"rgba(150,39,2,1)\"],[\"1\",\"rgba(139,0,0,1)\"]],\"showscale\":true,\"x\":[\"Mkt_Rf\",\"SMB\",\"HML\",\"RMW\",\"CMA\"],\"y\":[\"1993-07-31\",\"1993-08-31\",\"1993-09-30\",\"1993-10-31\",\"1993-11-30\",\"1993-12-31\",\"1994-01-31\",\"1994-02-28\",\"1994-03-31\",\"1994-04-30\",\"1994-05-31\",\"1994-06-30\",\"1994-07-31\",\"1994-08-31\",\"1994-09-30\",\"1994-10-31\",\"1994-11-30\",\"1994-12-31\",\"1995-01-31\",\"1995-02-28\",\"1995-03-31\",\"1995-04-30\",\"1995-05-31\",\"1995-06-30\",\"1995-07-31\",\"1995-08-31\",\"1995-09-30\",\"1995-10-31\",\"1995-11-30\",\"1995-12-31\",\"1996-01-31\",\"1996-02-29\",\"1996-03-31\",\"1996-04-30\",\"1996-05-31\",\"1996-06-30\",\"1996-07-31\",\"1996-08-31\",\"1996-09-30\",\"1996-10-31\",\"1996-11-30\",\"1996-12-31\",\"1997-01-31\",\"1997-02-28\",\"1997-03-31\",\"1997-04-30\",\"1997-05-31\",\"1997-06-30\",\"1997-07-31\",\"1997-08-31\",\"1997-09-30\",\"1997-10-31\",\"1997-11-30\",\"1997-12-31\",\"1998-01-31\",\"1998-02-28\",\"1998-03-31\",\"1998-04-30\",\"1998-05-31\",\"1998-06-30\",\"1998-07-31\",\"1998-08-31\",\"1998-09-30\",\"1998-10-31\",\"1998-11-30\",\"1998-12-31\",\"1999-01-31\",\"1999-02-28\",\"1999-03-31\",\"1999-04-30\",\"1999-05-31\",\"1999-06-30\",\"1999-07-31\",\"1999-08-31\",\"1999-09-30\",\"1999-10-31\",\"1999-11-30\",\"1999-12-31\",\"2000-01-31\",\"2000-02-29\",\"2000-03-31\",\"2000-04-30\",\"2000-05-31\",\"2000-06-30\",\"2000-07-31\",\"2000-08-31\",\"2000-09-30\",\"2000-10-31\",\"2000-11-30\",\"2000-12-31\",\"2001-01-31\",\"2001-02-28\",\"2001-03-31\",\"2001-04-30\",\"2001-05-31\",\"2001-06-30\",\"2001-07-31\",\"2001-08-31\",\"2001-09-30\",\"2001-10-31\",\"2001-11-30\",\"2001-12-31\",\"2002-01-31\",\"2002-02-28\",\"2002-03-31\",\"2002-04-30\",\"2002-05-31\",\"2002-06-30\",\"2002-07-31\",\"2002-08-31\",\"2002-09-30\",\"2002-10-31\",\"2002-11-30\",\"2002-12-31\",\"2003-01-31\",\"2003-02-28\",\"2003-03-31\",\"2003-04-30\",\"2003-05-31\",\"2003-06-30\",\"2003-07-31\",\"2003-08-31\",\"2003-09-30\",\"2003-10-31\",\"2003-11-30\",\"2003-12-31\",\"2004-01-31\",\"2004-02-29\",\"2004-03-31\",\"2004-04-30\",\"2004-05-31\",\"2004-06-30\",\"2004-07-31\",\"2004-08-31\",\"2004-09-30\",\"2004-10-31\",\"2004-11-30\",\"2004-12-31\",\"2005-01-31\",\"2005-02-28\",\"2005-03-31\",\"2005-04-30\",\"2005-05-31\",\"2005-06-30\",\"2005-07-31\",\"2005-08-31\",\"2005-09-30\",\"2005-10-31\",\"2005-11-30\",\"2005-12-31\",\"2006-01-31\",\"2006-02-28\",\"2006-03-31\",\"2006-04-30\",\"2006-05-31\",\"2006-06-30\",\"2006-07-31\",\"2006-08-31\",\"2006-09-30\",\"2006-10-31\",\"2006-11-30\",\"2006-12-31\",\"2007-01-31\",\"2007-02-28\",\"2007-03-31\",\"2007-04-30\",\"2007-05-31\",\"2007-06-30\",\"2007-07-31\",\"2007-08-31\",\"2007-09-30\",\"2007-10-31\",\"2007-11-30\",\"2007-12-31\",\"2008-01-31\",\"2008-02-29\",\"2008-03-31\",\"2008-04-30\",\"2008-05-31\",\"2008-06-30\",\"2008-07-31\",\"2008-08-31\",\"2008-09-30\",\"2008-10-31\",\"2008-11-30\",\"2008-12-31\",\"2009-01-31\",\"2009-02-28\",\"2009-03-31\",\"2009-04-30\",\"2009-05-31\",\"2009-06-30\",\"2009-07-31\",\"2009-08-31\",\"2009-09-30\",\"2009-10-31\",\"2009-11-30\",\"2009-12-31\",\"2010-01-31\",\"2010-02-28\",\"2010-03-31\",\"2010-04-30\",\"2010-05-31\",\"2010-06-30\",\"2010-07-31\",\"2010-08-31\",\"2010-09-30\",\"2010-10-31\",\"2010-11-30\",\"2010-12-31\",\"2011-01-31\",\"2011-02-28\",\"2011-03-31\",\"2011-04-30\",\"2011-05-31\",\"2011-06-30\",\"2011-07-31\",\"2011-08-31\",\"2011-09-30\",\"2011-10-31\",\"2011-11-30\",\"2011-12-31\",\"2012-01-31\",\"2012-02-29\",\"2012-03-31\",\"2012-04-30\",\"2012-05-31\",\"2012-06-30\",\"2012-07-31\",\"2012-08-31\",\"2012-09-30\",\"2012-10-31\",\"2012-11-30\",\"2012-12-31\",\"2013-01-31\",\"2013-02-28\",\"2013-03-31\",\"2013-04-30\",\"2013-05-31\",\"2013-06-30\",\"2013-07-31\",\"2013-08-31\",\"2013-09-30\",\"2013-10-31\",\"2013-11-30\",\"2013-12-31\",\"2014-01-31\",\"2014-02-28\",\"2014-03-31\",\"2014-04-30\",\"2014-05-31\",\"2014-06-30\",\"2014-07-31\",\"2014-08-31\",\"2014-09-30\",\"2014-10-31\",\"2014-11-30\",\"2014-12-31\",\"2015-01-31\",\"2015-02-28\",\"2015-03-31\",\"2015-04-30\",\"2015-05-31\",\"2015-06-30\",\"2015-07-31\",\"2015-08-31\",\"2015-09-30\",\"2015-10-31\",\"2015-11-30\",\"2015-12-31\",\"2016-01-31\",\"2016-02-29\",\"2016-03-31\",\"2016-04-30\",\"2016-05-31\",\"2016-06-30\",\"2016-07-31\",\"2016-08-31\",\"2016-09-30\",\"2016-10-31\",\"2016-11-30\",\"2016-12-31\",\"2017-01-31\",\"2017-02-28\",\"2017-03-31\",\"2017-04-30\",\"2017-05-31\",\"2017-06-30\",\"2017-07-31\",\"2017-08-31\",\"2017-09-30\",\"2017-10-31\",\"2017-11-30\",\"2017-12-31\",\"2018-01-31\",\"2018-02-28\",\"2018-03-31\",\"2018-04-30\",\"2018-05-31\",\"2018-06-30\",\"2018-07-31\",\"2018-08-31\",\"2018-09-30\",\"2018-10-31\",\"2018-11-30\",\"2018-12-31\",\"2019-01-31\",\"2019-02-28\",\"2019-03-31\",\"2019-04-30\",\"2019-05-31\",\"2019-06-30\",\"2019-07-31\",\"2019-08-31\",\"2019-09-30\"],\"z\":[[0.235656331824658,0.12719361125789,0.161546203443221,0.0304390482130936,0.0440128290737087],[0.416750972441865,0.168795189900192,0.152453640019518,0.0469779927089966,0.0104393828074874],[0.502715210710106,0.236251162933698,0.153373120334683,0.033770819843445,-0.030401149082101],[0.560093004360497,0.315955130282715,0.135474135913219,0.00331619536480243,-0.0335757459746789],[0.445501580890665,0.297007271192553,0.147597868297894,0.0124536827325159,0.00387471213061752],[0.433515663967857,0.292403873601807,0.172888642184766,-0.000455927336921125,0.0277961309077646],[0.414680750189819,0.257035205070242,0.194923524240401,-0.030846803386302,0.0913122279704728],[0.285437333389163,0.231085846540227,0.195646624708927,-0.00117080011257586,0.0815771584817113],[0.196963905678594,0.176869191257498,0.250480392793265,-0.00696748748434617,0.116952257012042],[0.206316122912184,0.164401858229985,0.255915652823187,-0.00209236544113756,0.132129148505063],[0.173240840144559,0.137403933873663,0.27084611862598,-0.0132756409134801,0.158457733354018],[0.192197832000845,0.121393688174807,0.291192799721722,-0.0234861521684404,0.169586821215297],[0.178556337576989,0.111213596190166,0.331600536630724,-0.0457818627558735,0.190034974625445],[0.200011899756623,0.104833001340247,0.320491446794146,-0.0486116911581397,0.184263942216673],[0.195251400917186,0.116459391106515,0.315437188637601,-0.047945586120943,0.189233378281525],[0.191952530614014,0.0854067246806089,0.298557393134282,-0.0224544740251954,0.189353188212845],[0.192698666783412,0.09064707096754,0.312498960238484,-0.0332841450482498,0.191021452378257],[0.0935238866937333,0.122519553524729,0.38232894820008,-0.0598284071391612,0.2507033517076],[0.116314809422852,0.012975203797587,0.351441890896562,-0.0305858683034936,0.227075146257368],[0.145383204955348,-0.00769368404727278,0.297172810768038,-0.0155752051975765,0.200554919569283],[0.204147981767266,-0.00298463751559075,0.2243748354899,-0.0139877433232731,0.174302345823063],[0.216173982573999,0.0518785863811539,0.200701694819175,-0.0225403920102994,0.151263457623384],[0.247936102134843,0.0360576911683621,0.204270255433855,-0.00513371332929846,0.146701740109274],[0.307373778299483,0.0932451049461138,0.137411887339277,0.00893226123481994,0.102296433544678],[0.306491014100766,0.126781584452029,0.11828128151939,-0.000410624446992025,0.0781126107690535],[0.344075368621888,0.146884533437943,0.146221482111235,-0.0507962731179592,0.0981855782968859],[0.377173441446655,0.125421832633012,0.147147160675428,-0.0573470234760132,0.118573646746753],[0.34252585288411,0.0567636068466464,0.177923990907149,-0.0606662240975765,0.144058109683463],[0.347973257562028,0.015993090589461,0.211250029744542,-0.0781897093423642,0.191187177023668],[0.340937352238925,0.00479867581857851,0.180283602301764,-0.0753131118981941,0.211623636183806],[0.363698945174488,-0.0434551990962814,0.122246069261056,-0.0522054100652527,0.205826393905415],[0.374287091473872,0.00300864221549735,0.0265709543179899,-0.027429641696892,0.129189274109536],[0.354009843983882,0.00958052451334535,0.013306725072691,-0.00471526492904928,0.0984404624529147],[0.417672353843713,0.0626683513919197,-0.0455355182360554,0.0309918575250425,0.0484722747166004],[0.408570566357946,0.0766604472046852,-0.0318064493521603,0.0307864192750624,0.0566584808769306],[0.39002935028702,0.0272743146978776,-0.0316164025270259,0.0683509152732753,0.0596804824494583],[0.314402377002984,-0.020985530963431,-0.00233727298283182,0.101119753015762,0.0765288717081505],[0.305265770404778,-0.00288086887943817,-0.00811620418896331,0.0909914769432321,0.0550887950998713],[0.37377781355228,-0.0462127535603084,-0.0375712486485237,0.098722826864678,0.0269038317890493],[0.368644215665075,-0.0881580452462788,0.0438375711391912,0.0917702600346066,0.0546054979661184],[0.482721143361634,-0.112487398406493,0.0749247953123675,0.0959931143578587,0.0602411191994521],[0.433715211414997,-0.0938713232568118,0.0698212948004988,0.0963223073237252,0.079280360806264],[0.4625567127525,-0.107299484281944,0.0335134803815706,0.129249927020376,0.0530448895850839],[0.496503289427253,-0.147471007489256,0.0944554606278381,0.109186262341304,0.120244659541414],[0.491953216519579,-0.145924079881878,0.11716021947087,0.124145094784313,0.130712176277564],[0.540740872640734,-0.191043444146704,0.0971618758155439,0.157880655455308,0.101399480135523],[0.630976837983005,-0.134348616976711,0.0438689897555926,0.172761331759985,0.056715509998446],[0.749363695711662,-0.121554453161668,0.0329368196563609,0.175797758231381,0.0425140164856161],[0.825763296856934,-0.130853958136341,0.0246124855212335,0.178273866627175,0.0176228226854103],[0.68360543177435,-0.0703607705168348,0.0539411900929401,0.160399991791368,0.0214453652680864],[0.813073864181017,-0.0718988597529627,0.0667291519545328,0.140103140360734,0.00345752031211677],[0.724902238088593,-0.0619771920960762,0.111577925074181,0.136499495507757,0.0288295196672432],[0.843960238465473,-0.115498012967471,0.134742826699399,0.159934797883648,0.0619744026420159],[0.8532814766617,-0.12872072753232,0.176825100517058,0.152208818019029,0.081229168659235],[0.827691240274222,-0.124987435403811,0.136248922290186,0.154601893400139,0.0696865645440461],[0.887303286902871,-0.12155359660131,0.121118508339388,0.143785411640161,0.0501572859297159],[0.935108817593125,-0.123583972169411,0.153935067989936,0.14113829305818,0.0534209326328559],[0.9102900144695,-0.121916947989936,0.141876992555499,0.125988916141387,0.032236205675334],[0.803028733299559,-0.131034780760477,0.160938352861888,0.138259741162324,0.0555397977875467],[0.809889037748211,-0.188802751954098,0.166913946607316,0.132932295650013,0.0542347825831937],[0.698780019600734,-0.246620609461188,0.174325200929141,0.144310058587335,0.0940803868824052],[0.414607543439043,-0.290243167968015,0.170876375082066,0.214962314879126,0.150848708843285],[0.452992087693615,-0.283403352686716,0.139697096988293,0.189029931507835,0.113228097261483],[0.580398323385506,-0.277350132493539,0.129961969539393,0.178876260125701,0.111671290412851],[0.609138367946255,-0.270808999226358,0.0838364584266291,0.19888971295085,0.0904494744831099],[0.687834967665635,-0.284445516499356,0.0367699777229393,0.212244129221552,0.0115937835210702],[0.702826962009956,-0.279676620628594,-0.00917271509803308,0.188382009571607,-0.0674121673897199],[0.612000553526612,-0.323578948490959,0.0294217605655285,0.165825308091227,-0.0076345512976107],[0.652128703773085,-0.356135756177754,-0.00273490886903516,0.137020932052855,-0.0273199800957551],[0.690196185426843,-0.361046533135117,0.0626527816422324,0.108618040537601,-0.00169952656337924],[0.619702395041897,-0.358815680181268,0.0931126962785895,0.112263720192583,0.0305425955790051],[0.713977716337787,-0.323253636220458,0.0355127043345604,0.091246951738569,-0.0171892917764586],[0.758191791185991,-0.283221939732876,-0.00713124401207743,0.0886661548483718,-0.0330456716695445],[0.685888162207606,-0.311140179292285,-0.024385517722365,0.10349662214449,-0.0114217568421809],[0.564353743343398,-0.277037513216707,-0.0399159937163092,0.0837014894776758,-0.00339362349416816],[0.631059973441547,-0.308438389272701,-0.116069707523365,0.0530774871879585,-0.0400044422104336],[0.577673134581722,-0.247744739467366,-0.208478638930302,0.0229063281991708,-0.0820782621637022],[0.719069882452169,-0.24570353903177,-0.282108532983297,-0.0352470893183078,-0.161594691409598],[0.567584730383172,-0.212201399236759,-0.270810616708794,-0.103333832248695,-0.115233611959491],[0.59921019769292,-0.0563562186936151,-0.403169664294586,-0.23732464638257,-0.195728091791677],[0.796651860548267,-0.181979153154105,-0.369999648526716,-0.159693838293407,-0.218299745422938],[0.645172839389433,-0.155284647540919,-0.323877439520509,-0.13472297471351,-0.148134988712772],[0.487968120396763,-0.209881413796043,-0.261646380980994,-0.108960905222514,-0.0905179370402545],[0.484816859456377,-0.159936337208494,-0.345560160234489,-0.161442647694013,-0.142697627835499],[0.352664007566271,-0.148787344152928,-0.282741812525804,-0.113863140162991,-0.0808413007066509],[0.510448957474189,-0.210437264675086,-0.298194412615014,-0.14678214764108,-0.0753562836885152],[0.3556082440527,-0.22398406145976,-0.231168824049575,-0.0999115840323502,0.0200672474965569],[0.36772069173982,-0.245012397056348,-0.198575357375914,-0.0207123655048754,0.0845104819375362],[0.196438787107622,-0.204457861271901,-0.0788898022838032,0.0839225444460361,0.204451013089104],[0.197618707016012,-0.150330528956728,-0.0110550704137208,0.0921669513093166,0.275044570509885],[0.236664981492182,-0.107691691218474,-0.0763389566949494,0.0129384959981884,0.148131602469016],[0.0427462973557569,-0.0844381921422784,0.0910158843671702,0.119735230787535,0.334276847377688],[-0.0781979507923356,-0.0646108564563991,0.192177523097374,0.174620891116606,0.445088766243454],[-0.0157571296469586,-0.0656389620298383,0.0886131875583314,0.150675913211874,0.359168498552319],[0.0215217275257378,-0.00508475424039256,0.0784599896563007,0.132467215148983,0.344759884825204],[-0.026630477533061,0.0831429934083177,0.106073160223084,0.142551215363916,0.359603015388057],[-0.0207245949923834,0.104381091318285,0.161354300458175,0.205426400379512,0.421195769440871],[0.0965356769743508,0.179299386318344,0.185071698052216,0.199527086837687,0.436464595439161],[-0.0623735408605962,0.120292946613076,0.248193651710127,0.263287706994205,0.557383581353241],[-0.103014239323061,0.221316260930201,0.175574235930518,0.235147945181147,0.45674641084667],[-0.0867393134064126,0.216690524070304,0.216529883661904,0.200948027066875,0.413118934389933],[-0.123631769646343,0.29846100734031,0.298603463454983,0.198206680835976,0.491379439638278],[-0.165771379793959,0.332450055912979,0.403263780271012,0.28113220690749,0.648040945270779],[-0.148971909458007,0.384255179324311,0.446371206242631,0.397503890060391,0.696651997860647],[-0.141395503000695,0.489390299668806,0.496118439869156,0.412290786445199,0.744410642550786],[-0.220063885129441,0.513715052377395,0.556044236512522,0.493161984893271,0.860425969886399],[-0.212254962034088,0.426669487850039,0.576574950149059,0.501170601022019,0.895059630729313],[-0.302824578698618,0.439047178368702,0.67129356120007,0.54558128692538,1.0130856172173],[-0.33882691081384,0.332874091428508,0.59654079824355,0.57764095407812,0.960505022737744],[-0.325687914009573,0.347089609925205,0.653665034533189,0.590205541069284,0.934265742569261],[-0.377174285388762,0.348789325049832,0.738747153300134,0.643645690950813,0.938604872408816],[-0.365853397648029,0.389617855498958,0.679903873658941,0.631359582468384,0.948748508287792],[-0.347046054812814,0.359258247310594,0.807110997316257,0.537612820457131,1.12637200878098],[-0.423796033058605,0.32483999460011,1.06512826988946,0.713190809930958,1.2562302907156],[-0.412900408527014,0.29957056691019,1.05542604790978,0.797365451448357,1.17373281079596],[-0.432135371529818,0.103543467341974,1.39222047766962,1.14307799338573,1.24693318363389],[-0.464028919885347,0.283133477929722,1.14053417319356,0.95571560910595,1.24468039319512],[-0.390849769888612,0.338524347884759,0.99231876105194,0.769299400454565,1.09564645493395],[-0.328513712126047,0.426226904053024,0.904288713171937,0.645360895833609,1.06525998920943],[-0.342440931100859,0.346748412894352,1.12636010088142,0.750073573425975,1.16133379250493],[-0.312842364316652,0.421134760403188,0.926119912009178,0.590147342521044,1.08417277318488],[-0.342478924033391,0.464065467235922,0.990127566577475,0.624730220735638,1.13844592301948],[-0.312673710425014,0.459563778138093,0.816812608882647,0.585091190277961,0.961567214065054],[-0.249468852368124,0.552656684260796,0.753794894045749,0.420663242579728,0.847001972471013],[-0.150809445181372,0.600678606693605,0.524401304265839,0.241381650405121,0.628579239646941],[-0.12554288877199,0.490465946572226,0.396098556989886,0.228681778534667,0.520950608872603],[-0.135367297963511,0.466677314227051,0.544950664442598,0.266077009849014,0.736428548196585],[-0.0272762320323171,0.430859269042255,0.329042228305028,0.172054545338931,0.516285454030384],[0.0371661928200955,0.444825064924655,0.205938280716681,0.142981372307737,0.390919414830308],[-0.0577259398129899,0.416497995531313,0.278826106105841,0.236931563143562,0.467093416369843],[-0.0538013552703623,0.365727948546277,0.261017602912055,0.222636805856705,0.446759181462919],[-0.0151967594021603,0.328950324263422,0.275750882275018,0.219120694455492,0.47746277392739],[-0.0317057782571175,0.339392861964417,0.286139934539788,0.178054857868906,0.389018680010861],[0.0338116749536603,0.296258538199118,0.255573537558038,0.142951776761723,0.277578785912568],[0.164421226738052,0.423210987313067,0.235684976012698,0.0953930050837164,0.187435085801423],[0.155893583733916,0.35759909774428,0.330502387538424,0.112030201394222,0.284070536586888],[0.122527804585852,0.41695585669518,0.356251450980353,0.146327421546198,0.32571606750322],[0.1407452814971,0.341720453589879,0.332619190021156,0.135836809511755,0.319284375690581],[0.128571457474619,0.322943025901922,0.314160787834695,0.117321261901983,0.265537164776865],[0.17970750694391,0.336385404736539,0.272866457232386,0.0630823656931492,0.181011054608512],[0.112496087499762,0.270235356774811,0.279542550476653,0.0840593256927322,0.19446381842],[0.13996222850788,0.153405883087138,0.187772568484328,0.0550687451543186,0.110135567569],[0.193351112970671,0.209112832526642,0.144717255749182,0.0351598209965953,0.0580863447091007],[0.29944965818947,0.220576418173703,0.146395070761516,0.0105060290974381,0.0234741239590555],[0.475139108920238,0.324776689988596,0.169619198293223,-0.0197094114861801,0.0224421879599033],[0.456074780044641,0.327040127549381,0.174121285613933,-0.0343290538432751,0.035277056486632],[0.634925086805798,0.289734811827267,0.178200118864204,-0.0479061497470602,0.0372783042303748],[0.481845629584651,0.317684889016272,0.252686926891501,-0.034547564826561,0.0337480277194804],[0.453717291540783,0.305421951667473,0.257769336575613,0.0379629450343124,-0.0160364346363264],[0.540306673167684,0.297137667591447,0.209166302474551,-0.0106776654006702,0.000973307697599068],[0.634433893223865,0.360707708046822,0.218031336127323,0.00145695218539332,-0.0141823793997248],[0.653552995829983,0.367849088831888,0.22557709380517,-0.0236489345469594,0.0176342758988879],[0.662900662274723,0.406083864201053,0.251198479102953,-0.0337740567072131,0.0160001783061157],[0.555711005231767,0.394251656651594,0.287954159309205,0.0180310749157169,0.00316627909735545],[0.413923574450204,0.307846575090108,0.309464875957375,0.0709240822509309,0.00504839219134667],[0.385230021466583,0.281645760450485,0.316662614132236,0.0790001122421069,0.0129501938838097],[0.346039470687939,0.20074903969079,0.362821628792156,0.139837950774987,0.00753549278801402],[0.341180596501066,0.175599400768869,0.333645198893981,0.145320184062586,0.00802914075116345],[0.373717071095249,0.144604092719545,0.342437585581326,0.130942832735518,0.0209422442355658],[0.337832534251286,0.137585399139505,0.289520191166643,0.15657033519462,-0.00430826568173326],[0.34126016983372,0.110126824568269,0.281973153047524,0.154827987597159,-0.0266800387877657],[0.291598125657902,0.132070134394331,0.288903418765788,0.145325138125712,-0.0173360130318683],[0.280717780980992,0.111371712591781,0.262819983341604,0.187078703524697,-0.0303495149193215],[0.239587449328957,0.130734752342554,0.256060911173852,0.163505178346562,-0.0242628155090754],[0.265678745570651,0.103244715891344,0.256936563636577,0.154672495833234,-0.0279926226724045],[0.343966818474265,0.110336279721683,0.276980305134897,0.12591947435253,-0.0122212830139099],[0.376218836733128,0.112450146386484,0.273805316807858,0.163121978334288,-0.0303384365152497],[0.325237778296718,0.0984762878253973,0.249287299161275,0.165204145973275,-0.0324697737514034],[0.330473149496976,0.0975747890253764,0.165552973984296,0.136287820604877,-0.0478227692065888],[0.33885177888705,0.0953545507548688,0.136833454617444,0.113586910959555,-0.0425600069019322],[0.361804273137171,0.0382707619138725,0.109557634452675,0.114818012067149,-0.0612417628648212],[0.370645418329681,0.0394064996208188,0.0638667053777624,0.111371038361376,-0.0764668766791181],[0.23846714946849,-0.0396051332587163,0.042616722733017,0.128550903819241,-0.0584276674640306],[0.19207857157028,-0.0308383629835175,0.0372892552588777,0.153249638588099,-0.0737911002106129],[0.146398963269919,-0.0341554050268595,0.069077316121344,0.114692498815554,-0.0475671132888651],[0.0967067185802344,-0.0338668347863537,0.0455349135642085,0.115895561755798,-0.0668398282013811],[0.100945414197205,-0.0221205349053366,0.0348304805054689,0.113582025691342,-0.0616771163242104],[0.187098473792538,-0.000742782701518285,0.0384600091974914,0.131587567818878,-0.0773693990856632],[0.17482486893257,0.00502423048645118,0.0161556851116724,0.161441151825378,-0.0819079895328878],[0.072149924977108,-0.0175518366584808,-0.0370861533998864,0.208476994599815,-0.0916739456903903],[0.0147446084134004,-0.0177433470217051,-0.00957711634779113,0.169178889837766,-0.0491362701555037],[0.0321186222547014,0.00719002643103983,-0.015127613286949,0.196491771463212,-0.0282214510627434],[-0.0792544633215342,-0.0026548391774025,0.0124410202877092,0.166632796774291,0.0378926459912741],[-0.229343164366065,-0.0206570922332457,0.00979704012223293,0.213872582420457,0.0768813813870892],[-0.315474526146099,-0.0758558915437424,-0.01152305093601,0.251276866552052,0.116032794970138],[-0.306247273128598,-0.0371231776876773,-0.0293680866212863,0.25002646496661,0.100860817749433],[-0.379919535843031,-0.103415434794105,-0.102431605524669,0.281571294645318,0.0814869144128898],[-0.438149492963744,-0.10980675046977,-0.157159211702211,0.317391205817944,0.0363322123115577],[-0.397035777360105,-0.13280290511433,-0.151434191863609,0.290701543664147,0.0202892729573176],[-0.341483913431637,-0.0803347102759999,-0.137466370535563,0.292101712991593,0.0181309094303606],[-0.272858672908575,-0.0748795469702124,-0.15635827754642,0.260065074268208,-0.0303371793982284],[-0.270518952197975,-0.0539176031704436,-0.187383765798862,0.234253223229426,-0.0267490681508772],[-0.20518461293785,-0.00776487250452607,-0.170488962686628,0.206246293341623,-0.015416428916567],[-0.19825828674099,-0.010331848953768,-0.118472039084559,0.20415787425752,-0.00982329991335051],[-0.172860172662618,0.0441777702383348,-0.113485724330944,0.225251730913683,-0.0329143771090472],[-0.221157385394722,-0.0134969200382707,-0.127072150011696,0.262992990510587,-0.036709922977292],[-0.190306827729504,-0.0323655449404027,-0.131601410458652,0.276585854117973,-0.033198537520344],[-0.171160580834285,0.0252629809057698,-0.147052436296615,0.303582357559303,-0.0556602517255865],[-0.210952733132471,0.0321411845425663,-0.132958390911491,0.283449309988389,-0.0440191215152251],[-0.167103388836322,0.0290938235016966,-0.115678039958058,0.285122814605224,-0.0355548577757483],[-0.122775789213438,0.0474245250511114,-0.106877065037258,0.260993248545182,-0.020069976667634],[-0.139161452307275,0.105508589852709,-0.0783875739473077,0.257263234992001,-0.00901997241291308],[-0.235050016545398,0.109378256883897,-0.102461597439412,0.241177788623636,0.00848921978856465],[-0.264321459022391,0.0829172370417046,-0.130374174572184,0.230950670937171,0.00495491292037586],[-0.18524572892663,0.113270050769876,-0.0944310745931531,0.220346382555001,0.047310906290732],[-0.226602581267794,0.107403014929191,-0.106418698807815,0.246337532690554,0.0136077170217317],[-0.184591973142496,0.164461280027677,-0.10165927776285,0.24883996725072,0.0497479590050935],[-0.17208033707754,0.166312018130433,-0.0780606264542125,0.259835256607204,0.0566069876877766],[-0.117171766244837,0.255609483570858,-0.0679212468036735,0.235212666147095,0.0498245015926055],[-0.051658720844001,0.264096704732172,-0.0311261943109282,0.170048190096305,0.0887934094599552],[0.0331358150660057,0.249668126183209,-0.063812873736634,0.175444442025764,0.0762492166932811],[0.0990739094304516,0.266589160149848,-0.0551549308721156,0.130398987077997,0.0922358262809522],[0.11833832547214,0.294355228825805,-0.076017831742057,0.143259679946415,0.0815044858773271],[0.0977272390687673,0.319408966955074,-0.0976087871417335,0.128751308373491,0.101117835672438],[0.0559274320743501,0.27128813806885,-0.0829161025135795,0.137610339538985,0.102228729372673],[0.125061443099413,0.253659340591667,-0.0565707146018506,0.109099884855266,0.118775017226122],[0.116605771071244,0.213206889652318,-0.0864913518418985,0.166161524461698,0.0572920091448565],[0.0400941170875524,0.151952999724667,-0.112413537131732,0.159877711015495,0.0277101744143315],[0.0561524401215596,0.11401095390376,-0.147428494292897,0.209707923463144,-0.0207538155561487],[0.444103030027715,0.194996276131678,-0.142277004832431,0.169963925977702,-0.0527949782223657],[0.557884638657838,0.243582523133574,-0.116430243780942,0.159597157013343,-0.0662710972225153],[0.539926756616166,0.183910571779305,-0.0739794063313113,0.160525113125787,-0.0255836805023775],[0.752519888313339,0.230444533924196,-0.0368387420892894,0.115750018411518,-0.0122410087744682],[1.02866039446125,0.227831596800887,0.0214235505846665,0.106483358183461,0.0123089999058841],[0.90897651528057,0.209715847989548,0.0216262340950513,0.118881562258044,0.0475548002906001],[0.716834780578181,0.128286095465304,-0.0235030964835055,0.114913506279195,0.062253984344748],[0.501224789390293,0.142739536704489,-0.0192077986973689,0.157546220441809,0.127332568504128],[0.560960806368137,0.129686086556018,0.0137855206323865,0.151494299723633,0.132050381166262],[0.45790708322927,0.0818967808967739,-0.0236328395668965,0.172999089290449,0.114677055100159],[0.454227643881186,0.0872933131239129,-0.0691120422775174,0.183410323810778,0.0742933518962967],[0.430022974851596,0.0628621219718795,-0.0746235162723219,0.143943909666966,0.0955966194976399],[0.446640888895018,0.0972368480064212,-0.0193814017921629,0.0917860660895147,0.132455952119656],[0.376613458138258,0.119640867363367,-0.0233156790166676,0.0945022220903349,0.15210712481584],[0.353498430645496,0.0816473668405155,0.00302864774619538,0.0676060121142743,0.164826091468765],[0.479339936701153,0.0803563614295262,0.0105844191039821,0.0716037271682393,0.168944105736945],[0.440113393205558,0.0573224088020681,-0.0129152478961886,0.0760047842466622,0.179203114543652],[0.405421661892805,0.0479664932783059,-0.0313963380518569,0.0970302903071669,0.194672684322997],[0.396458513538897,-0.019978697670004,-0.0490764441482607,0.0894361328386639,0.190192956475722],[0.553927625278306,-0.00825829142328305,-0.0140301214510221,0.0722762376150063,0.176773299313304],[0.619373466004313,0.0192059464847671,0.0288826633326094,0.0712028880278039,0.183158524209096],[0.600295293333294,0.0357974344780776,0.0197171244134828,0.0571869493210877,0.15627909044328],[0.632281103403058,0.0581702369344557,0.023058747350629,0.0580268197872813,0.166905777664413],[0.548035298760441,0.0433413315168953,0.0295212682202917,0.0617369629285052,0.152658129058022],[0.551015441793958,0.0188176881994795,0.0521090380461506,0.0702662393340601,0.158644169476579],[0.581478794385487,-0.00985097952281477,0.043288962278099,0.0757338921644755,0.157838035972322],[0.519451310078876,-0.0283282864807718,0.0105408878954112,0.108311603895654,0.124640807322442],[0.438993994189232,-0.00112505264974405,-0.0165689968572815,0.0723633732303763,0.0976467618681403],[0.44881695098064,-0.0175113116092227,-0.0247969056485153,0.0923636277453741,0.0936853299456086],[0.451557917033476,-0.0460938505897358,0.0383849872625808,0.0868072442334149,0.109095462596162],[0.415689086317793,-0.076505209940313,0.0796868032181168,0.105826908286145,0.126841882899351],[0.465407765151122,-0.0854539835191694,0.0903063144645331,0.077301245802369,0.123775491966245],[0.535445087260149,-0.0543138570038015,0.0956536279875801,0.0265306710245361,0.0980590347202901],[0.538901881357541,-0.0864178390920175,0.115157176446316,0.0143508111310304,0.120015734455566],[0.702329433124968,-0.0545968611049092,0.12287374182724,0.00435917587560253,0.121142964462063],[0.816476003077452,-0.0534152302678359,0.0950915306450977,-0.0106049836247348,0.108613727581226],[0.661303752187096,-0.0639542222824739,0.0590269547109399,0.00309910263989055,0.104841423063836],[0.706032444731414,-0.0788465023025495,0.0294268224364107,-0.00153255644489902,0.0938104835888018],[0.697020213138594,-0.0554006436589423,0.00598087329194885,-0.0187974107912291,0.0713989461992857],[0.556125782979657,-0.0880780766839334,0.00243538249771991,0.0178867863873573,0.0761868350508768],[0.583423618321421,-0.0709818509225358,-0.0135587999114977,0.00479532123840753,0.0526653862608426],[0.527756381739808,-0.0364832512350493,-0.0305849648569793,0.0121842663830034,0.0324118341818227],[0.554664329284541,-0.050974418648593,0.0038183356383219,-0.00522750448705533,0.0244978758710217],[0.682969959890018,-0.0432579890070085,-0.0190615686974176,-0.0391368813543788,-0.0075707558359116],[0.594554823188643,-0.0226726444134747,-0.0330651821222224,-0.032241663907053,-0.0249023242991862],[0.59518626753007,-0.0497540056981319,-0.0870184553199301,-0.03157034210023,-0.0474068265558438],[0.460287779160701,-0.0539043753377273,-0.0608554020992473,-0.0187415135852265,-0.0280584809755815],[0.372926204823753,-0.0901809042928746,-0.0606689529037142,0.0132147977981161,-0.0384721401079861],[0.500770100688199,-0.105894217322458,-0.0843587203490838,0.0246762721293343,-0.0591481374861739],[0.497787944502033,-0.0860351394080596,-0.0897990864618133,-0.00410905495152758,-0.0742629730402438],[0.442341697790457,-0.131051854480387,-0.135847242777663,0.00570417358054276,-0.0773873584796554],[0.290891026779706,-0.161683963971917,-0.112043723641189,0.0417018527115263,-0.0727828722561955],[0.281940712608293,-0.141222795972038,-0.105382053067326,0.0566664443705907,-0.0598577496648088],[0.322607812641861,-0.135344844669793,-0.0838206645089966,0.0506853135533987,-0.073691508498464],[0.320648780629456,-0.0891635915091824,-0.0498440018273528,0.00851979061354413,-0.0587362505631677],[0.30596488703814,-0.108987783578955,-0.085868873795984,0.0214927485197449,-0.0725099152789151],[0.324663206399673,-0.112695185311636,-0.0915105351362836,0.0271222175747132,-0.0522100623352892],[0.302478951736721,-0.109992114433556,-0.119455681963211,0.0545648109802113,-0.0659805574216004],[0.34203304732655,-0.101293523350928,-0.086110582239658,0.0383455665168322,-0.0466751315134004],[0.297048699371471,-0.107371816517835,-0.0850002579495777,0.0193741968410555,-0.0353743200024649],[0.22053914980724,-0.122511863911856,-0.0638100243845494,0.00372854801114531,-0.0376744706552161],[0.241318831801234,-0.083531726582407,0.00421827295787769,-0.0261812422873728,-0.0129798230949463],[0.230676191777997,-0.0768004473833441,0.0361588021437755,-0.0192211927808703,-0.00386276925204809],[0.301652236385612,-0.0906562402911183,0.0295430116770625,0.0111278162099226,-0.00940750639314081],[0.283504678468089,-0.10891031955822,0.00100204429830897,0.0164894744649628,-0.0182778889196537],[0.27814717533793,-0.0968637076555565,-0.0731002180315402,0.0148904348826759,-0.0507458021823892],[0.285669438015729,-0.0692670995690533,-0.117398899714761,0.00404232023520801,-0.0752857532155109],[0.272432009991445,-0.0769512668236559,-0.151784804615923,0.0267155380982336,-0.0825750620835444],[0.249661392423032,-0.0808066427854418,-0.141731257977406,0.0226237839611161,-0.0692518527171977],[0.301082011286262,-0.0530103890219149,-0.134955000669812,0.00750311870258624,-0.0703689739181772],[0.251194280890028,-0.0709279379251053,-0.146757029463099,0.0145191571336625,-0.0882213292350511],[0.314427369611584,-0.00221159171317864,-0.10293806014629,-0.00814605930684842,-0.0641157781008013],[0.313783231921879,-0.0390400849503172,-0.08631720441357,0.00471203924621411,-0.093250555042833],[0.322265886324818,-0.0175062446355847,-0.0684258583184014,0.0207763257008022,-0.0940654072649614],[0.340549723229911,-0.0392901736763341,-0.0774801344152769,0.0461088545322705,-0.0921793532898015],[0.461370013213338,-0.0550442977642412,-0.0677875819941745,0.0259263607174771,-0.0918121861930534],[0.322323031268404,-0.0618121094185707,-0.0789348322297531,0.0451993940568822,-0.0988545567521113],[0.30934071001,-0.0576932357526032,-0.0713111980562231,0.039868877147192,-0.0921458281001653],[0.299498963994694,-0.0306543042103539,-0.087674966277132,0.0254335180237324,-0.0794861441220276],[0.318927116822733,-0.0064279007807807,-0.102542760674734,0.0261614395962064,-0.0907910253800416],[0.347106452923331,-0.0296806851603626,-0.0989980136285842,0.0408870879516761,-0.0738960090873662],[0.374568494417859,-0.00172112135070224,-0.0461316510213025,0.0415055591863474,-0.046050378761296],[0.506370427230116,0.00345440224747962,-0.130464759066043,0.0471184633975312,-0.088849148536589],[0.559518106038752,0.0113116590546927,-0.144617575611614,0.0367979581403115,-0.0785242341547834],[0.337040585843138,-0.00584147626798848,-0.124013102066176,0.0376263196368782,-0.053211494607542],[0.352613880869882,-0.042330606775917,-0.111500271288274,0.0527811111503163,-0.0360353274063081],[0.254443647383888,-0.0340288287541604,-0.0984394341165215,0.0575467433806518,-0.0444844201541413],[0.445131856432483,0.0266933474729989,-0.146257964848876,0.0221339058723342,-0.0799324664950635],[0.490679598965165,0.0300290647582806,-0.177620609110782,0.00403948188954328,-0.112317838920501],[0.406532825341337,-0.0192905535148742,-0.221086238811634,0.0179775112496399,-0.133263744155052],[0.445201350405111,-0.0534279630697875,-0.241356765608826,0.0660301897036897,-0.165621672412058],[0.328176958583177,-0.0589551127870885,-0.233026015805885,0.0611264508310527,-0.137250758364619],[0.422581367492382,-0.0594232011710984,-0.242167632804993,0.0619723912004249,-0.163829341358765],[0.383567155624086,-0.0874368532573123,-0.226706446951865,0.0494108646411293,-0.150481217982387],[0.34333997157129,-0.128806382576314,-0.257963690293995,0.0724655425098955,-0.153632315218944],[0.359137671057578,-0.13774787435684,-0.204012420531773,0.106058483330912,-0.125581078244624]],\"type\":\"surface\",\"frame\":null}],\"highlight\":{\"on\":\"plotly_click\",\"persistent\":false,\"dynamic\":false,\"selectize\":false,\"opacityDim\":0.2,\"selected\":{\"opacity\":1},\"debounce\":0},\"shinyEvents\":[\"plotly_hover\",\"plotly_click\",\"plotly_selected\",\"plotly_relayout\",\"plotly_brushed\",\"plotly_brushing\",\"plotly_clickannotation\",\"plotly_doubleclick\",\"plotly_deselect\",\"plotly_afterplot\"],\"base_url\":\"https://plot.ly\"},\"evals\":[],\"jsHooks\":[]}\rSharpe, William F. 1964. “Capital Asset Prices: A Theory of Market Equilibrium Under Conditions of Risk.” The Journal of Finance 19 (3): 425–42.\n\r———. 1966. “Mutual Fund Performance.” The Journal of Business 39 (1): 119–38.\n\r\r\r","date":1573689600,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1573689600,"objectID":"3440ad19b8394bc6235c57492278d827","permalink":"/post/factor-modeling-for-portfolio-optimisation/factor-modeling-portfolio-optimisation/","publishdate":"2019-11-14T00:00:00Z","relpermalink":"/post/factor-modeling-for-portfolio-optimisation/factor-modeling-portfolio-optimisation/","section":"post","summary":"I break down some popular and fundamental models from quantitative finance \u0026 engineering, construct some factor analysis on a series of Assets and EFTs along with a randomly generated portfolio constructed from scraping tickers from the SPY500 wikipedia page.","tags":["time-series","finance","quant finance","yahoo-finance","factor models","asset pricing"],"title":"Factor Modeling in R","type":"post"},{"authors":null,"categories":["financial time series"],"content":"\r\r::Note:: This is a long post but I talk about the procedure I took when dealing with a specific time series classification task.\nI was given a “Data Science” challenge as part of an interview in which I had to distinguish between real financial time series and synthetic time series. I document the results here, the data was anonymous and I have no idea which assets were which or from what time series the assets came from.\nTo conclude I obtained an in-sample-test-accuracy of 67% and an out-of-sample-test-accuracy of 65% (based on what the interviewers told me)\nAll I knew was that I had 12,000 real time series and 12,000 synthetically created time series. (apologies for no data but this was the companies data and not mine, I have uploaded the train and test data sets discussed later here where you should be able to run the final XGBoost model). In total there were 24,000 observations. I show the code here for methodological purposes and if you are interested in visualising time series in R and ggplot2. The time series features used here are taken from the following papers:\n\rLarge Scale Unusual Time Series Detection by R.Hyndman, E.Wang and N.Laptev\rVisualising forecasting algorithm performance using time series instance spaces by Y.Kang, Rob.Hyndman and Kate Smith-Miles\r\rYou can check out my Jupyter Notebook version here.\nI added a lot of notes to the code throughout the document which might be of additional interest.\nA brief overview of the notebook:\r\rPart 1 of the notebook:\r\rCleans the data and puts it into a better format for analysis. The data I recieved removed all dates, assest names etc. for anonymity.\rSimple plot of some returns for the Synthetic and Real financial time series.\rBox-plots of average returns and standard deviations.\rComputes the Durbin-Watson test statistics for both Synthetic and Real time series and box-plots.\rPlot the 10 day rolling mean and standard deviations for a random time series for Synthetic and real data.\rDickey Fuller test on both the Synthetic and real time series.\rJarque-Bera Test For Normality on the Synthetic and real time series.\rACF Plots for both the Synthetic and real time series.\r\r\rPart 2 of the notebook:\r\rCreates the time series features.\rSplits the train.csv into “train” and “validation” data sets.\rPuts the data into the correct format for XGBoost.\rSets up and searches over a parameter space to find the most optimal parameters for this data set (on the train data).\rOutputs these parameters into a data frame.\rTrain the model using the optimal parameters found from the grid-search.\rPlot the feature importance scores - i.e. the most “important” variables that the model found when making its predictions.\rAssign a cut-off on the probability scores (\u0026gt; 0.5 then assign a 1 - real time series, \u0026lt;= 0.5 then assign a 0 for Synthetic).\rCompute the Confusion Matrix and analyse the ‘in-sample’ validation results.\r\r\rPart 3 of the notebook:\r\rCreate the “test.csv” features just as before and save as “TSfeatures_test.csv”.\rLoad in the “TSfeatures_train_val.csv” and “TSfeatures_test.csv” which were created from “train.csv” and “test.csv”.\rSet up and run the XGBoost model using the optimal parameters found from the cross-validation grid search in “Part 2”.\rPlot the predicted probability density plot as before in “Part 2”.\rSet the cut-off threshold as the mean prediction score (0.465) which is close to the (0.500) score from “Part 2”.\rSave the results as “submission.csv”.\r\rLets get started…\nI often remove all other data in my environment before hand and turn scientific notation off which is what the first 2 lines does. The shhh command is useful for Jupyter Notebooks which outputs all the warning messages, adding shhh suppresses these warning messaged when loading in the packages. (In R markdown I can set warning = FALSE but there is no option on Notebooks. - that I know of - )\nrm(list = ls())\roptions(scipen=999)\rsetwd(\u0026#39;C:/Users/Matt/Desktop/Data Science Challenge\u0026#39;)\rshhh \u0026lt;- suppressPackageStartupMessages\rshhh(library(dplyr))\rlibrary(readr)\rlibrary(TSrepr)\rlibrary(ggplot2)\rlibrary(data.table)\rlibrary(cluster)\rlibrary(clusterCrit)\rlibrary(fractalrock)\rlibrary(cowplot)\rlibrary(tidyr)\rlibrary(tidyquant)\rlibrary(lmtest)\rlibrary(aTSA)\rlibrary(tsoutliers)\rlibrary(tsfeatures)\rlibrary(xgboost)\rlibrary(caret)\rlibrary(purrr)\rtrain_val \u0026lt;- read_csv(\u0026quot;train.csv\u0026quot;)\rtest \u0026lt;- read_csv(\u0026quot;test.csv\u0026quot;)\r\rNOTE:\rI have 2 data sets, the train_Val.csv for training and validation data set and the test.csv data set. I do not touch the test.csv data set until the very end in part 3. All the analysis and optimisation is performed only on the train_val.csv data set. The train_val.csv contains 12,000 observations and the test.csv contains 12,000 observations.\n\rPart 1\rThe data was given to me in this format:\nhead(train_val[, 1:5], 1)\r## # A tibble: 1 x 5\r## feature1 feature2 feature3 feature4 feature5\r## \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\r## 1 0.00629 0.00441 -0.0381 0.0253 -0.00658\rThe names of the columns are as follows:\ncolnames(train_val) %\u0026gt;%\rdata.frame() %\u0026gt;%\rsetNames(c(\u0026quot;features\u0026quot;)) %\u0026gt;%\rsplit(as.integer(gl(nrow(.), 20, nrow(.)))) %\u0026gt;%\rkable(caption = \u0026quot;Time series variables\u0026quot;) %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;), font_size = 12)\rTable 1: Time series variables\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\rfeature1\r\r\r\rfeature2\r\r\r\rfeature3\r\r\r\rfeature4\r\r\r\rfeature5\r\r\r\rfeature6\r\r\r\rfeature7\r\r\r\rfeature8\r\r\r\rfeature9\r\r\r\rfeature10\r\r\r\rfeature11\r\r\r\rfeature12\r\r\r\rfeature13\r\r\r\rfeature14\r\r\r\rfeature15\r\r\r\rfeature16\r\r\r\rfeature17\r\r\r\rfeature18\r\r\r\rfeature19\r\r\r\rfeature20\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r21\r\rfeature21\r\r\r\r22\r\rfeature22\r\r\r\r23\r\rfeature23\r\r\r\r24\r\rfeature24\r\r\r\r25\r\rfeature25\r\r\r\r26\r\rfeature26\r\r\r\r27\r\rfeature27\r\r\r\r28\r\rfeature28\r\r\r\r29\r\rfeature29\r\r\r\r30\r\rfeature30\r\r\r\r31\r\rfeature31\r\r\r\r32\r\rfeature32\r\r\r\r33\r\rfeature33\r\r\r\r34\r\rfeature34\r\r\r\r35\r\rfeature35\r\r\r\r36\r\rfeature36\r\r\r\r37\r\rfeature37\r\r\r\r38\r\rfeature38\r\r\r\r39\r\rfeature39\r\r\r\r40\r\rfeature40\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r41\r\rfeature41\r\r\r\r42\r\rfeature42\r\r\r\r43\r\rfeature43\r\r\r\r44\r\rfeature44\r\r\r\r45\r\rfeature45\r\r\r\r46\r\rfeature46\r\r\r\r47\r\rfeature47\r\r\r\r48\r\rfeature48\r\r\r\r49\r\rfeature49\r\r\r\r50\r\rfeature50\r\r\r\r51\r\rfeature51\r\r\r\r52\r\rfeature52\r\r\r\r53\r\rfeature53\r\r\r\r54\r\rfeature54\r\r\r\r55\r\rfeature55\r\r\r\r56\r\rfeature56\r\r\r\r57\r\rfeature57\r\r\r\r58\r\rfeature58\r\r\r\r59\r\rfeature59\r\r\r\r60\r\rfeature60\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r61\r\rfeature61\r\r\r\r62\r\rfeature62\r\r\r\r63\r\rfeature63\r\r\r\r64\r\rfeature64\r\r\r\r65\r\rfeature65\r\r\r\r66\r\rfeature66\r\r\r\r67\r\rfeature67\r\r\r\r68\r\rfeature68\r\r\r\r69\r\rfeature69\r\r\r\r70\r\rfeature70\r\r\r\r71\r\rfeature71\r\r\r\r72\r\rfeature72\r\r\r\r73\r\rfeature73\r\r\r\r74\r\rfeature74\r\r\r\r75\r\rfeature75\r\r\r\r76\r\rfeature76\r\r\r\r77\r\rfeature77\r\r\r\r78\r\rfeature78\r\r\r\r79\r\rfeature79\r\r\r\r80\r\rfeature80\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r81\r\rfeature81\r\r\r\r82\r\rfeature82\r\r\r\r83\r\rfeature83\r\r\r\r84\r\rfeature84\r\r\r\r85\r\rfeature85\r\r\r\r86\r\rfeature86\r\r\r\r87\r\rfeature87\r\r\r\r88\r\rfeature88\r\r\r\r89\r\rfeature89\r\r\r\r90\r\rfeature90\r\r\r\r91\r\rfeature91\r\r\r\r92\r\rfeature92\r\r\r\r93\r\rfeature93\r\r\r\r94\r\rfeature94\r\r\r\r95\r\rfeature95\r\r\r\r96\r\rfeature96\r\r\r\r97\r\rfeature97\r\r\r\r98\r\rfeature98\r\r\r\r99\r\rfeature99\r\r\r\r100\r\rfeature100\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r101\r\rfeature101\r\r\r\r102\r\rfeature102\r\r\r\r103\r\rfeature103\r\r\r\r104\r\rfeature104\r\r\r\r105\r\rfeature105\r\r\r\r106\r\rfeature106\r\r\r\r107\r\rfeature107\r\r\r\r108\r\rfeature108\r\r\r\r109\r\rfeature109\r\r\r\r110\r\rfeature110\r\r\r\r111\r\rfeature111\r\r\r\r112\r\rfeature112\r\r\r\r113\r\rfeature113\r\r\r\r114\r\rfeature114\r\r\r\r115\r\rfeature115\r\r\r\r116\r\rfeature116\r\r\r\r117\r\rfeature117\r\r\r\r118\r\rfeature118\r\r\r\r119\r\rfeature119\r\r\r\r120\r\rfeature120\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r121\r\rfeature121\r\r\r\r122\r\rfeature122\r\r\r\r123\r\rfeature123\r\r\r\r124\r\rfeature124\r\r\r\r125\r\rfeature125\r\r\r\r126\r\rfeature126\r\r\r\r127\r\rfeature127\r\r\r\r128\r\rfeature128\r\r\r\r129\r\rfeature129\r\r\r\r130\r\rfeature130\r\r\r\r131\r\rfeature131\r\r\r\r132\r\rfeature132\r\r\r\r133\r\rfeature133\r\r\r\r134\r\rfeature134\r\r\r\r135\r\rfeature135\r\r\r\r136\r\rfeature136\r\r\r\r137\r\rfeature137\r\r\r\r138\r\rfeature138\r\r\r\r139\r\rfeature139\r\r\r\r140\r\rfeature140\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r141\r\rfeature141\r\r\r\r142\r\rfeature142\r\r\r\r143\r\rfeature143\r\r\r\r144\r\rfeature144\r\r\r\r145\r\rfeature145\r\r\r\r146\r\rfeature146\r\r\r\r147\r\rfeature147\r\r\r\r148\r\rfeature148\r\r\r\r149\r\rfeature149\r\r\r\r150\r\rfeature150\r\r\r\r151\r\rfeature151\r\r\r\r152\r\rfeature152\r\r\r\r153\r\rfeature153\r\r\r\r154\r\rfeature154\r\r\r\r155\r\rfeature155\r\r\r\r156\r\rfeature156\r\r\r\r157\r\rfeature157\r\r\r\r158\r\rfeature158\r\r\r\r159\r\rfeature159\r\r\r\r160\r\rfeature160\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r161\r\rfeature161\r\r\r\r162\r\rfeature162\r\r\r\r163\r\rfeature163\r\r\r\r164\r\rfeature164\r\r\r\r165\r\rfeature165\r\r\r\r166\r\rfeature166\r\r\r\r167\r\rfeature167\r\r\r\r168\r\rfeature168\r\r\r\r169\r\rfeature169\r\r\r\r170\r\rfeature170\r\r\r\r171\r\rfeature171\r\r\r\r172\r\rfeature172\r\r\r\r173\r\rfeature173\r\r\r\r174\r\rfeature174\r\r\r\r175\r\rfeature175\r\r\r\r176\r\rfeature176\r\r\r\r177\r\rfeature177\r\r\r\r178\r\rfeature178\r\r\r\r179\r\rfeature179\r\r\r\r180\r\rfeature180\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r181\r\rfeature181\r\r\r\r182\r\rfeature182\r\r\r\r183\r\rfeature183\r\r\r\r184\r\rfeature184\r\r\r\r185\r\rfeature185\r\r\r\r186\r\rfeature186\r\r\r\r187\r\rfeature187\r\r\r\r188\r\rfeature188\r\r\r\r189\r\rfeature189\r\r\r\r190\r\rfeature190\r\r\r\r191\r\rfeature191\r\r\r\r192\r\rfeature192\r\r\r\r193\r\rfeature193\r\r\r\r194\r\rfeature194\r\r\r\r195\r\rfeature195\r\r\r\r196\r\rfeature196\r\r\r\r197\r\rfeature197\r\r\r\r198\r\rfeature198\r\r\r\r199\r\rfeature199\r\r\r\r200\r\rfeature200\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r201\r\rfeature201\r\r\r\r202\r\rfeature202\r\r\r\r203\r\rfeature203\r\r\r\r204\r\rfeature204\r\r\r\r205\r\rfeature205\r\r\r\r206\r\rfeature206\r\r\r\r207\r\rfeature207\r\r\r\r208\r\rfeature208\r\r\r\r209\r\rfeature209\r\r\r\r210\r\rfeature210\r\r\r\r211\r\rfeature211\r\r\r\r212\r\rfeature212\r\r\r\r213\r\rfeature213\r\r\r\r214\r\rfeature214\r\r\r\r215\r\rfeature215\r\r\r\r216\r\rfeature216\r\r\r\r217\r\rfeature217\r\r\r\r218\r\rfeature218\r\r\r\r219\r\rfeature219\r\r\r\r220\r\rfeature220\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r221\r\rfeature221\r\r\r\r222\r\rfeature222\r\r\r\r223\r\rfeature223\r\r\r\r224\r\rfeature224\r\r\r\r225\r\rfeature225\r\r\r\r226\r\rfeature226\r\r\r\r227\r\rfeature227\r\r\r\r228\r\rfeature228\r\r\r\r229\r\rfeature229\r\r\r\r230\r\rfeature230\r\r\r\r231\r\rfeature231\r\r\r\r232\r\rfeature232\r\r\r\r233\r\rfeature233\r\r\r\r234\r\rfeature234\r\r\r\r235\r\rfeature235\r\r\r\r236\r\rfeature236\r\r\r\r237\r\rfeature237\r\r\r\r238\r\rfeature238\r\r\r\r239\r\rfeature239\r\r\r\r240\r\rfeature240\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r241\r\rfeature241\r\r\r\r242\r\rfeature242\r\r\r\r243\r\rfeature243\r\r\r\r244\r\rfeature244\r\r\r\r245\r\rfeature245\r\r\r\r246\r\rfeature246\r\r\r\r247\r\rfeature247\r\r\r\r248\r\rfeature248\r\r\r\r249\r\rfeature249\r\r\r\r250\r\rfeature250\r\r\r\r251\r\rfeature251\r\r\r\r252\r\rfeature252\r\r\r\r253\r\rfeature253\r\r\r\r254\r\rfeature254\r\r\r\r255\r\rfeature255\r\r\r\r256\r\rfeature256\r\r\r\r257\r\rfeature257\r\r\r\r258\r\rfeature258\r\r\r\r259\r\rfeature259\r\r\r\r260\r\rfeature260\r\r\r\r\r\r\r\r\r\r\rfeatures\r\r\r\r\r\r261\r\rclass\r\r\r\r\r\r\r\r\rThere are 260 “features” in the train data along with a class variable which is excluded from the testing data. With ~253 trading days in a year the feature1, feature2, … featureN were daily time series. From my initial observation (and plots) I believed this data to be “returns” data. I firstly clean a little the data since time series does not do so well with feature1, feature2, … featureN as its input. I chose a year at random and renamed the columns with the function getTradingDates (there is always an R package for everything…).\n######################################################################\r################# Clean the data #####################################\r# Since the \u0026quot;features\u0026quot; are daily time series, I just choose a random year and rename the feautres into more meaningful names\r# Such as \u0026quot;2010-01-01\u0026quot;, \u0026quot;2010-01-02\u0026quot;, \u0026quot;2010-01-03\u0026quot; instead of \u0026quot;feature1\u0026quot;, \u0026quot;feature2\u0026quot;, \u0026quot;feature3\u0026quot; etc.\r# Theres a \u0026quot;trading dates\u0026quot; package in R to get only the dates which are trading dates.\rcolnames(train_val) \u0026lt;- getTradingDates(\u0026#39;2010-01-01\u0026#39;, obs = 260)\rcolnames(train_val)[ncol(train_val)] \u0026lt;- \u0026quot;class\u0026quot;\rcolnames(test) \u0026lt;- getTradingDates(\u0026#39;2010-01-01\u0026#39;, obs = 260)\rtest$dataset \u0026lt;- \u0026quot;test\u0026quot;\rtrain_val$dataset \u0026lt;- \u0026quot;train\u0026quot;\rHere (if I were to do things differently) I would keep to tidy data principles and use test %\u0026gt;% add_column(dataset = \"test) and train %\u0026gt;% add_colum(dataset = \"train\") instead of test$dataset \u0026lt;- \"test and train_val$dataset \u0026lt;- \"train\". But that doesn’t matter much.\n\rHow the training data looks after cleaning:\rTable 2: How the training set looks now (cleaned)\r\r\r\r2009-01-05\r\r2009-01-06\r\r2009-01-07\r\r2009-01-08\r\r2009-01-09\r\r\r\r\r\r0.0062865\r\r0.0044074\r\r-0.0380887\r\r0.0252850\r\r-0.0065788\r\r\r\r0.0008491\r\r0.0025729\r\r0.0013584\r\r-0.0054742\r\r-0.0098234\r\r\r\r0.0142292\r\r-0.0252533\r\r-0.0100752\r\r-0.0319871\r\r-0.0065087\r\r\r\r-0.0215930\r\r-0.0102866\r\r-0.0210674\r\r-0.0086876\r\r0.0371876\r\r\r\r0.0092523\r\r-0.0235778\r\r0.0170582\r\r0.0037303\r\r0.0171185\r\r\r\r0.0143528\r\r0.0094828\r\r0.0042109\r\r-0.0038064\r\r0.0084914\r\r\r\r\r\rHow the testing data looks after cleaning:\rTable 3: How the testing data looks (cleaned)\r\r\r\r2009-01-05\r\r2009-01-06\r\r2009-01-07\r\r2009-01-08\r\r2009-01-09\r\r\r\r\r\r0.0331039\r\r0.0086225\r\r0.0040622\r\r0.0082554\r\r0.0558741\r\r\r\r0.0020681\r\r-0.0034293\r\r0.0134305\r\r-0.0109182\r\r-0.0184851\r\r\r\r0.0147834\r\r-0.0113800\r\r-0.0046055\r\r-0.0008757\r\r-0.0011536\r\r\r\r-0.0094855\r\r0.0113410\r\r-0.0213286\r\r0.0033220\r\r-0.0111519\r\r\r\r0.0381690\r\r-0.0037092\r\r-0.0010865\r\r-0.0062307\r\r0.0232117\r\r\r\r0.0004257\r\r-0.0042553\r\r0.0029915\r\r0.0017043\r\r0.0012760\r\r\r\r\rThe goal: Was to classify which financial time series were real vs which were synthetically created (by some algorithm I have no knowledge of how it generated the synthetic time series)\nI re-arranged the data using the melt function in R, however I suggest anybody reading this to use the pivol_longer function from the tidyverse packages. The pivot_longer package was released a few weeks after writing the code for this problem.\n######################################################################\r################# Rearrange the data #################################\r# I melt the data for easier analysis, now the data is in a long format.\r# \u0026quot;Class\u0026quot; corresponds to whether the asset is Synthetic or Real\r# \u0026quot;Dataset\u0026quot; tells me where the data came from\r# \u0026quot;row_id\u0026quot; - corresponds to a unique ID assigned to each asset both \u0026quot;(Synthetic \u0026amp; Real)\u0026quot;\r# \u0026quot;Variable\u0026quot; is the column names of the original dataset (feature1, feature2, ... , featureN) converted to some date\r# \u0026quot;Value\u0026quot; is the daily returns\rdf \u0026lt;- train_val %\u0026gt;%\rmutate(row_id = row_number()) %\u0026gt;%\rmelt(., measure.vars = 1:260) %\u0026gt;%\rarrange(row_id)\rhead(df)\r## class dataset row_id variable value\r## 1 0 train 1 2009-01-05 0.006286455\r## 2 0 train 1 2009-01-06 0.004407363\r## 3 0 train 1 2009-01-07 -0.038088652\r## 4 0 train 1 2009-01-08 0.025285012\r## 5 0 train 1 2009-01-09 -0.006578773\r## 6 0 train 1 2009-01-12 0.005713677\rdim(df)\r## [1] 3120000 5\rNote: I call the training data df which in hindsight is probably bad practice and it should be called something related to the train_Val named data set. Just keep in mind that df refers to the train_Val data set. (and does not include the test.csv data set data)\nAs we can see the data has 3,120,000 rows which is 12,000 assets * 260 trading days. Next I plot the returns series using ggplot.\n# Plot some returns - I only plot a random sample of 20 assets for each Synthetic vs Real.\rret_plot0 \u0026lt;- df %\u0026gt;%\rfilter(class == 0) %\u0026gt;%\rgroup_by(row_id) %\u0026gt;%\rnest() %\u0026gt;%\rungroup() %\u0026gt;% sample_n(20) %\u0026gt;%\runnest() %\u0026gt;% ggplot(aes(x = variable, y = value)) +\rgeom_line(aes(group = factor(row_id), color = factor(row_id))) +\rggtitle(\u0026quot;Synthetic Financial Time Series\u0026quot;) +\rtheme_classic() +\rtheme(axis.text.x = element_blank(), legend.position = \u0026quot;bottom\u0026quot;, legend.title = element_blank())\rret_plot1 \u0026lt;- df %\u0026gt;%\rfilter(class == 1) %\u0026gt;%\rgroup_by(row_id) %\u0026gt;%\rnest() %\u0026gt;%\rungroup() %\u0026gt;%\rsample_n(20) %\u0026gt;%\runnest() %\u0026gt;%\rggplot(aes(x = variable, y = value)) +\rgeom_line(aes(group = factor(row_id), color = factor(row_id))) +\rggtitle(\u0026quot;Real Financial Time Series\u0026quot;) +\rtheme_classic() +\rtheme(axis.text.x = element_blank(), legend.position = \u0026quot;bottom\u0026quot;, legend.title = element_blank())\rplot_grid(ret_plot0, ret_plot1)\rNext I plot boxplots for the Average returns and secondly the standard deviations.\nave_box \u0026lt;- df %\u0026gt;%\rgroup_by(class, row_id) %\u0026gt;%\rsummarise(mean = mean(value)) %\u0026gt;%\rggplot(aes(x = factor(class), y = mean, color = factor(class))) +\rgeom_boxplot(show.legend = FALSE) +\rggtitle(\u0026quot;Syn vs Real Average Returns\u0026quot;) +\rxlab(\u0026quot;Class\u0026quot;) +\rylab(\u0026quot;Average Returns\u0026quot;) +\rtheme_tq()\rsd_box \u0026lt;- df %\u0026gt;%\rgroup_by(class, row_id) %\u0026gt;%\rsummarise(sd = sd(value)) %\u0026gt;%\rggplot(aes(x = factor(class), y = sd, color = factor(class))) +\rgeom_boxplot(show.legend = FALSE) +\rggtitle(\u0026quot;Syn vs Real Standard Deviations\u0026quot;) +\rxlab(\u0026quot;Class\u0026quot;) +\rylab(\u0026quot;Standard Deviation\u0026quot;) +\rtheme_tq()\rplot_grid(ave_box, sd_box)\rI next calculate the Durbin-Watson statistic. I mostly code using R’s tidy data principles and therefore use the tidy function from the broom package to tidy the output of the DW statistic up a little. I do this for both the synthetic time series and real time series.\n# I calculate the Durbin-Watson statistic and use the \u0026quot;tidy()\u0026quot; function to summarise the key information from the calculation.\rdw_test_class_zero \u0026lt;- df %\u0026gt;%\rdplyr::filter(class == 0) %\u0026gt;%\rnest(-row_id) %\u0026gt;%\rmutate(dw_res = map(data, ~ broom::tidy(lmtest::dwtest(value ~ 1, data = .x)))) %\u0026gt;%\runnest(dw_res) %\u0026gt;%\rmutate(class = \u0026quot;0\u0026quot;)\rdw_test_class_zero %\u0026gt;% head()\r## # A tibble: 6 x 7\r## row_id data statistic p.value method alternative class\r## \u0026lt;int\u0026gt; \u0026lt;list\u0026lt;df[,4\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt; \u0026lt;chr\u0026gt; \u0026lt;chr\u0026gt;\r## 1 1 [260 x 4] 1.98 0.426 Durbin-Wat~ true autocorrelation ~ 0 ## 2 2 [260 x 4] 2.01 0.521 Durbin-Wat~ true autocorrelation ~ 0 ## 3 4 [260 x 4] 2.08 0.747 Durbin-Wat~ true autocorrelation ~ 0 ## 4 5 [260 x 4] 2.49 1.000 Durbin-Wat~ true autocorrelation ~ 0 ## 5 6 [260 x 4] 1.90 0.214 Durbin-Wat~ true autocorrelation ~ 0 ## 6 9 [260 x 4] 1.87 0.138 Durbin-Wat~ true autocorrelation ~ 0\r# Here I do the exact same thing as above but this time for the class == 1 data.\rdw_test_class_one \u0026lt;- df %\u0026gt;%\rfilter(class == 1) %\u0026gt;%\rnest(-row_id) %\u0026gt;%\rmutate(dw_res = map(data, ~ broom::tidy(lmtest::dwtest(value ~ 1, data = .x)))) %\u0026gt;%\runnest(dw_res) %\u0026gt;%\rmutate(class = \u0026quot;1\u0026quot;)\rdw_test_class_one %\u0026gt;%\rhead()\r## # A tibble: 6 x 7\r## row_id data statistic p.value method alternative class\r## \u0026lt;int\u0026gt; \u0026lt;list\u0026lt;df[,4\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt; \u0026lt;chr\u0026gt; \u0026lt;chr\u0026gt;\r## 1 3 [260 x 4] 2.08 0.728 Durbin-Wat~ true autocorrelation ~ 1 ## 2 7 [260 x 4] 1.81 0.0654 Durbin-Wat~ true autocorrelation ~ 1 ## 3 8 [260 x 4] 1.93 0.296 Durbin-Wat~ true autocorrelation ~ 1 ## 4 13 [260 x 4] 2.05 0.644 Durbin-Wat~ true autocorrelation ~ 1 ## 5 15 [260 x 4] 2.07 0.715 Durbin-Wat~ true autocorrelation ~ 1 ## 6 16 [260 x 4] 2.07 0.709 Durbin-Wat~ true autocorrelation ~ 1\rNext I plot the boxplot statistics for each of the Durbin Watson tests.\n# I bind the rows together and plot a box-plot.\rbind_rows(dw_test_class_zero, dw_test_class_one) %\u0026gt;%\rgroup_by(class) %\u0026gt;%\rggplot(aes(x = factor(class), y = statistic, color = factor(class))) +\rgeom_boxplot(show.legend = FALSE) +\rggtitle(\u0026quot;Durbin Watson Box Plot Statistics\u0026quot;) +\rxlab(\u0026quot;Class\u0026quot;) +\rylab(\u0026quot;Durbin Watson\u0026quot;) +\rtheme_tq()\rI compute the 10 day rolling mean and standard deviation using the tq_mutate function from the tidyquant package. value corresponds to the returns of the financial time series and is plotted in blue with the 10 day rolling average and standard deviation plotted over the returns. (I use melt again here but look into the pivot_longer function for a more intuitive application)\n# Rolling mean and standard deviations\r# I only use a random sample of 1 of each class of the grouped observations to save on memory and to make the plot more readable.\r# The rollowing window is 10 days\r# I use the tq_mutate functionality from the \u0026quot;tidyquant\u0026quot; package to keep things in a \u0026quot;tidy\u0026quot; format as per the \u0026quot;tidyverse\u0026quot; \u0026#39;rules\u0026#39;.\r# In the plot \u0026quot;value\u0026quot; is the returns, \u0026quot;mean_10\u0026quot; is the 10 day rolling mean and \u0026quot;sd_10\u0026quot; is the 10 day rolling standard deviation.\rplot0 \u0026lt;- df %\u0026gt;%\rfilter(class == 0) %\u0026gt;%\ras_tibble() %\u0026gt;%\rgroup_by(row_id) %\u0026gt;%\rnest() %\u0026gt;%\rungroup() %\u0026gt;% sample_n(1) %\u0026gt;%\runnest() %\u0026gt;%\rmutate(variable = as.Date(variable)) %\u0026gt;%\rtq_mutate(\rselect = value,\rmutate_fun = rollapply,\rwidth = 10,\ralign = \u0026quot;right\u0026quot;,\rFUN = mean,\rna.rm = TRUE,\rcol_rename = \u0026quot;mean_10\u0026quot;\r) %\u0026gt;%\rtq_mutate(\rselect = value,\rmutate_fun = rollapply,\rwidth = 10,\ralign = \u0026quot;right\u0026quot;,\rFUN = sd,\rna.rm = TRUE,\rcol_rename = \u0026quot;sd_10\u0026quot;\r) %\u0026gt;%\rmelt(measure.vars = 5:7) %\u0026gt;%\rsetNames(c(\u0026quot;row_id\u0026quot;, \u0026quot;class\u0026quot;, \u0026quot;data set\u0026quot;, \u0026quot;date\u0026quot;, \u0026quot;variable\u0026quot;, \u0026quot;value\u0026quot;)) %\u0026gt;%\rggplot(aes(x = date)) +\rgeom_line(aes(y = value, colour = variable)) +\rggtitle(\u0026quot;Synthetic Financial Time Series Rolling Mean and Standard Deviation\u0026quot;) +\rtheme_classic() +\rscale_colour_manual(values = c(\u0026quot;#1f77b4\u0026quot;, \u0026quot;red\u0026quot;, \u0026quot;black\u0026quot;)) +\rtheme(axis.text.x = element_blank(), legend.position = \u0026quot;bottom\u0026quot;, legend.title = element_blank())\rplot1 \u0026lt;- df %\u0026gt;%\rfilter(class == 1) %\u0026gt;%\ras_tibble() %\u0026gt;%\rgroup_by(row_id) %\u0026gt;%\rnest() %\u0026gt;%\rungroup() %\u0026gt;% sample_n(1) %\u0026gt;%\runnest() %\u0026gt;%\rmutate(variable = as.Date(variable)) %\u0026gt;%\rtq_mutate(\rselect = value,\rmutate_fun = rollapply,\rwidth = 10,\ralign = \u0026quot;right\u0026quot;,\rFUN = mean,\rna.rm = TRUE,\rcol_rename = \u0026quot;mean_10\u0026quot;\r) %\u0026gt;%\rtq_mutate(\rselect = value,\rmutate_fun = rollapply,\rwidth = 10,\ralign = \u0026quot;right\u0026quot;,\rFUN = sd,\rna.rm = TRUE,\rcol_rename = \u0026quot;sd_10\u0026quot;\r) %\u0026gt;%\rmelt(measure.vars = 5:7) %\u0026gt;%\rsetNames(c(\u0026quot;row_id\u0026quot;, \u0026quot;class\u0026quot;, \u0026quot;data set\u0026quot;, \u0026quot;date\u0026quot;, \u0026quot;variable\u0026quot;, \u0026quot;value\u0026quot;)) %\u0026gt;%\rggplot(aes(x = date)) +\rgeom_line(aes(y = value, colour = variable)) +\rggtitle(\u0026quot;Real Financial Time Series Rolling Mean and Standard Deviation\u0026quot;) +\rtheme_classic() +\rscale_colour_manual(values = c(\u0026quot;#1f77b4\u0026quot;, \u0026quot;red\u0026quot;, \u0026quot;black\u0026quot;)) +\rtheme(axis.text.x = element_blank(), legend.position = \u0026quot;bottom\u0026quot;, legend.title = element_blank()) plot_grid(plot0, plot1)\rAn important note in the code here is that I randomly sample by group, that is, I do not take a random sample from all observations across all groups. Instead I group_by each time series (each of the 6,000 observations after I filtered by the class == 0, likewise when I filter by the class == 1), I then nest() the data to collapse the daily time series for each asset into a list. From here I will have 6,000 observations, each of which has their time series nested inside a list. Thus, I can sample 1 of the 6,000 observations and then unnest() and obtain a full time series set of one of the random assets selected, - instead of sampling randomly over all assets time series data (which would be completely wrong).\nFor example the following commented out code group_by() the ID variable and nest() the data, takes a random sample_n() of the grouped data and then unnest() the data to its original form, this time with a random sample of the IDs.\n# group_by(row_id) %\u0026gt;%\r# nest() %\u0026gt;%\r# ungroup() %\u0026gt;% # sample_n(1) %\u0026gt;%\r# unnest() %\u0026gt;%\rNext I compute the Dickey Fuller test on both series for a single random observation, hence the sample_n(1) argument (it’s too computationally expensive to compute it on all 12,000 observations).\nFor the synthetically created series.\n# Dickey Fuller test on the 0 class\r# I only randomly sample 1 of the assets for the 0 class to save on output space\rdf %\u0026gt;%\rfilter(class == 0) %\u0026gt;%\rgroup_by(row_id) %\u0026gt;%\rnest() %\u0026gt;%\rungroup() %\u0026gt;% sample_n(1) %\u0026gt;%\runnest() %\u0026gt;%\rnest(-row_id) %\u0026gt;%\rmutate(adf_res = map(data, ~ adf.test(.x$value))) %\u0026gt;%\runnest(adf_res)\r## Augmented Dickey-Fuller Test ## alternative: stationary ## ## Type 1: no drift no trend ## lag ADF p.value\r## [1,] 0 -17.94 0.01\r## [2,] 1 -11.75 0.01\r## [3,] 2 -8.66 0.01\r## [4,] 3 -7.62 0.01\r## [5,] 4 -7.13 0.01\r## Type 2: with drift no trend ## lag ADF p.value\r## [1,] 0 -17.94 0.01\r## [2,] 1 -11.76 0.01\r## [3,] 2 -8.67 0.01\r## [4,] 3 -7.64 0.01\r## [5,] 4 -7.15 0.01\r## Type 3: with drift and trend ## lag ADF p.value\r## [1,] 0 -18.00 0.01\r## [2,] 1 -11.83 0.01\r## [3,] 2 -8.77 0.01\r## [4,] 3 -7.74 0.01\r## [5,] 4 -7.26 0.01\r## ---- ## Note: in fact, p.value = 0.01 means p.value \u0026lt;= 0.01\r## # A tibble: 3 x 3\r## row_id data adf_res ## \u0026lt;int\u0026gt; \u0026lt;list\u0026lt;df[,4]\u0026gt;\u0026gt; \u0026lt;named list\u0026gt; ## 1 7807 [260 x 4] \u0026lt;dbl[,3] [5 x 3]\u0026gt;\r## 2 7807 [260 x 4] \u0026lt;dbl[,3] [5 x 3]\u0026gt;\r## 3 7807 [260 x 4] \u0026lt;dbl[,3] [5 x 3]\u0026gt;\rThe same but on the real financial series.\n# Dickey Fuller test on the 1 class\r# I only randomly sample 1 of the assets for the 1 class to save on output space\rdf %\u0026gt;%\rfilter(class == 1) %\u0026gt;%\rgroup_by(row_id) %\u0026gt;%\rnest() %\u0026gt;%\rungroup() %\u0026gt;% sample_n(1) %\u0026gt;%\runnest() %\u0026gt;%\rnest(-row_id) %\u0026gt;%\rmutate(adf_res = map(data, ~ adf.test(.x$value))) %\u0026gt;%\runnest(adf_res)\r## Augmented Dickey-Fuller Test ## alternative: stationary ## ## Type 1: no drift no trend ## lag ADF p.value\r## [1,] 0 -15.99 0.01\r## [2,] 1 -10.71 0.01\r## [3,] 2 -9.12 0.01\r## [4,] 3 -8.74 0.01\r## [5,] 4 -7.58 0.01\r## Type 2: with drift no trend ## lag ADF p.value\r## [1,] 0 -16.10 0.01\r## [2,] 1 -10.84 0.01\r## [3,] 2 -9.27 0.01\r## [4,] 3 -8.93 0.01\r## [5,] 4 -7.81 0.01\r## Type 3: with drift and trend ## lag ADF p.value\r## [1,] 0 -16.27 0.01\r## [2,] 1 -10.99 0.01\r## [3,] 2 -9.46 0.01\r## [4,] 3 -9.18 0.01\r## [5,] 4 -8.06 0.01\r## ---- ## Note: in fact, p.value = 0.01 means p.value \u0026lt;= 0.01\r## # A tibble: 3 x 3\r## row_id data adf_res ## \u0026lt;int\u0026gt; \u0026lt;list\u0026lt;df[,4]\u0026gt;\u0026gt; \u0026lt;named list\u0026gt; ## 1 10833 [260 x 4] \u0026lt;dbl[,3] [5 x 3]\u0026gt;\r## 2 10833 [260 x 4] \u0026lt;dbl[,3] [5 x 3]\u0026gt;\r## 3 10833 [260 x 4] \u0026lt;dbl[,3] [5 x 3]\u0026gt;\rNext the Jarque-Bera tests for normality. Firstly on the synthetically created series.\n# For both classes I take a random sample of 1 observation from each class (Synthetic and Real financial series)\rjb_zero \u0026lt;- df %\u0026gt;%\rfilter(class == 0) %\u0026gt;%\rgroup_by(row_id) %\u0026gt;%\rnest() %\u0026gt;%\rungroup() %\u0026gt;% sample_n(1) %\u0026gt;%\runnest() %\u0026gt;%\rnest(-row_id) %\u0026gt;%\rmutate(JarqueBeraTest = map(data, ~ JarqueBera.test(.x$value)))\rprint(\u0026quot;Jarque-Bera Test on the 0 - Synthetic class\u0026quot;)\r## [1] \u0026quot;Jarque-Bera Test on the 0 - Synthetic class\u0026quot;\rjb_zero$JarqueBeraTest\r## [[1]]\r## ## Jarque Bera Test\r## ## data: .x$value\r## X-squared = 0.3088, df = 2, p-value = 0.8569\r## ## ## Skewness\r## ## data: .x$value\r## statistic = 0.045794, p-value = 0.7631\r## ## ## Kurtosis\r## ## data: .x$value\r## statistic = 2.8582, p-value = 0.6406\rAlso on the real financial series.\njb_one \u0026lt;- df %\u0026gt;%\rfilter(class == 0) %\u0026gt;%\rgroup_by(row_id) %\u0026gt;%\rnest() %\u0026gt;%\rungroup() %\u0026gt;% sample_n(1) %\u0026gt;%\runnest() %\u0026gt;%\rnest(-row_id) %\u0026gt;%\rmutate(JarqueBeraTest = map(data, ~ JarqueBera.test(.x$value)))\rprint(\u0026quot;Jarque-Bera Test on the 1 - Real class\u0026quot;)\r## [1] \u0026quot;Jarque-Bera Test on the 1 - Real class\u0026quot;\rjb_one$JarqueBeraTest\r## [[1]]\r## ## Jarque Bera Test\r## ## data: .x$value\r## X-squared = 25.14, df = 2, p-value = 0.000003474\r## ## ## Skewness\r## ## data: .x$value\r## statistic = 0.084191, p-value = 0.5794\r## ## ## Kurtosis\r## ## data: .x$value\r## statistic = 4.514, p-value = 0.0000006251\r\rAutocorrelation plots:\rI plot the Autocorrelation Function for a “random” sample of observations time series. I selected 4 observations and filtered the data by them.\n######################################################################\r################# ACF plots ##########################################\r# I only use 4 observations for these plots, 2 from the \u0026quot;synthetic\u0026quot; class and 2 from the \u0026quot;real\u0026quot; class.\rdf %\u0026gt;%\rfilter(row_id == 6422 | row_id == 8967 | row_id == 6080 | row_id == 5734) %\u0026gt;%\rmutate(date = as.Date(variable)) %\u0026gt;%\rggplot(aes(x = date)) +\rgeom_line(aes(y = value), color = \u0026quot;red\u0026quot;, alpha = 0.4) +\rgeom_hline(yintercept = 0) +\rfacet_wrap(~ row_id + class) +\rtheme_tq()\racf_data \u0026lt;- df %\u0026gt;%\rdplyr::filter(row_id == 6422 | row_id == 8967 | row_id == 6080 | row_id == 5734) %\u0026gt;%\rmutate(date = as.Date(variable))\rdf_acf \u0026lt;- acf_data %\u0026gt;%\rgroup_by(row_id) %\u0026gt;% summarise(list_acf = list(acf(value, plot=FALSE))) %\u0026gt;%\rmutate(acf_vals = purrr::map(list_acf, ~as.numeric(.x$acf))) %\u0026gt;% select(-list_acf) %\u0026gt;% unnest() %\u0026gt;% group_by(row_id) %\u0026gt;% mutate(lag = row_number() - 1)\rdf_ci \u0026lt;- acf_data %\u0026gt;% group_by(row_id) %\u0026gt;% summarise(ci = qnorm((1 + 0.95)/2)/sqrt(n()))\rggplot(df_acf, aes(x = lag, y = acf_vals)) +\rgeom_bar(stat=\u0026quot;identity\u0026quot;, width=.05) +\rgeom_hline(yintercept = 0) +\rgeom_hline(data = df_ci, aes(yintercept = -ci), color=\u0026quot;blue\u0026quot;, linetype=\u0026quot;dotted\u0026quot;) +\rgeom_hline(data = df_ci, aes(yintercept = ci), color=\u0026quot;blue\u0026quot;, linetype=\u0026quot;dotted\u0026quot;) +\rlabs(x=\u0026quot;Lag\u0026quot;, y=\u0026quot;ACF\u0026quot;) +\rfacet_wrap(~ row_id) +\rtheme_tq()\rThats enough data analysis I could probably fit the PACF plots also along with a few more exploratory data analysis but I move on to generating the financial time series features using the tsfeatures package.\nWhat I do in the below code is to take a random sample of 5 groups (Using the whole data set takes too long to calculate the time series features) and then apply all the functions in the tsfeatures package to each of the time series assets data which is does by mapping over each assets data and computing the time series features.\nThis section takes some time to process and compute (especially on the whole sample) and I already saved the results as a csv which I will just work from and load in the pre-computed time series features.\n################# Generate Time Series Features ######################\r# I create some time series features from the package \u0026quot;tsfeatures\u0026quot;. There are 40+ functions in the \u0026quot;tsfeatures\u0026quot; package\r# which can generate approximately 106 time series features.\r# Due to memory issues I am only able to create a few of the features, therefore I randomly sample 10 features from the\r# \u0026quot;tsfeatures\u0026quot; package. We could also add in technical indicators from the \u0026quot;PerformanceAnalytics\u0026quot; or \u0026quot;TTR\u0026quot; packages (I omit these\r# here, however creating \u0026#39;functions2 \u0026lt;- ls(\u0026quot;package:TTR\u0026quot;)\u0026#39; and adding it to the \u0026#39;summarise\u0026#39; command will work.)\rfunctions \u0026lt;- ls(\u0026quot;package:tsfeatures\u0026quot;)[1:42]\r# functions \u0026lt;- sample(functions, 20)\rStats \u0026lt;- df %\u0026gt;%\rgroup_by(row_id, class) %\u0026gt;%\rnest() %\u0026gt;%\rungroup() %\u0026gt;%\rsample_n(5) %\u0026gt;%\runnest() %\u0026gt;%\rnest(-row_id, -class) %\u0026gt;%\rgroup_by(row_id, class) %T\u0026gt;%\r{options(warn = -1)} %\u0026gt;%\rsummarise(Statistics = map(data, ~ data.frame(\rbind_cols(\rtsfeatures(.x$value, functions))))) %\u0026gt;%\runnest(Statistics)\r# I saved to whole dataset as \u0026quot;Stats\u0026quot; next I split it between training and test.\rStats \u0026lt;- read.csv(\u0026quot;C:/Users/Matt/Desktop/Data Science Challenge/TSfeatures_train_val.csv\u0026quot;)\rNote: Again, bad practice by me. I just called the df data Stats which consists of only the time series features. This still only refers to the train_val.csv data and not the test.csv data.\nThe training data looks like: (after computing the time series features). Now each asset has been collapsed from ~260 days down to 1 signal time series feature observation.\nRecall the goal here was to classify synthetic time series vs real time series and not what the next days price is going to be. For each asset I have a signal observation and based on this I can train a classifying algorithm to distinguish between real vs synthetic time series.\n\rHow the training data looks:\rTable 4: tsfeatures package features\r\r\r\rX\r\rrow_id\r\rclass\r\rac_9_ac_9\r\racf_features_x_acf1\r\racf_features_x_acf10\r\racf_features_diff1_acf1\r\racf_features_diff1_acf10\r\racf_features_diff2_acf1\r\racf_features_diff2_acf10\r\rARCH.LM\r\rautocorr_features_embed2_incircle_1\r\rautocorr_features_embed2_incircle_2\r\rautocorr_features_ac_9\r\rautocorr_features_firstmin_ac\r\rautocorr_features_trev_num\r\rautocorr_features_motiftwo_entro3\r\rautocorr_features_walker_propcross\r\rbinarize_mean_binarize_mean\r\rbinarize_mean_NA\r\rcompengine_embed2_incircle_1\r\rcompengine_embed2_incircle_2\r\rcompengine_ac_9\r\rcompengine_firstmin_ac\r\rcompengine_trev_num\r\rcompengine_motiftwo_entro3\r\rcompengine_walker_propcross\r\rcompengine_localsimple_mean1\r\rcompengine_localsimple_lfitac\r\rcompengine_sampen_first\r\rcompengine_std1st_der\r\rcompengine_spreadrandomlocal_meantaul_50\r\rcompengine_spreadrandomlocal_meantaul_ac2\r\rcompengine_histogram_mode_10\r\rcompengine_outlierinclude_mdrmd\r\rcompengine_fluctanal_prop_r1\r\rcrossing_points\r\rdist_features_histogram_mode_10\r\rdist_features_outlierinclude_mdrmd\r\rembed2_incircle\r\rentropy\r\rfirstmin_ac\r\rfirstzero_ac\r\rflat_spots\r\rfluctanal_prop_r1_fluctanal_prop_r1\r\rarch_acf\r\rgarch_acf\r\rarch_r2\r\rgarch_r2\r\rhistogram_mode\r\ralpha\r\rbeta\r\rhurst\r\rhw_parameters_hw_parameters\r\rhw_parameters_NA\r\rlocalsimple_taures\r\rlumpiness\r\rmax_kl_shift\r\rtime_kl_shift\r\rmax_level_shift\r\rtime_level_shift\r\rmax_var_shift\r\rtime_var_shift\r\rmotiftwo_entro3\r\rnonlinearity\r\routlierinclude_mdrmd\r\rx_pacf5\r\rdiff1x_pacf5\r\rdiff2x_pacf5\r\rpred_features_localsimple_mean1\r\rpred_features_localsimple_lfitac\r\rpred_features_sampen_first\r\rsampen_first_sampen_first\r\rsampenc\r\rscal_features_fluctanal_prop_r1\r\rspreadrandomlocal_meantaul\r\rstability\r\rstation_features_std1st_der\r\rstation_features_spreadrandomlocal_meantaul_50\r\rstation_features_spreadrandomlocal_meantaul_ac2\r\rstd1st_der_std1st_der\r\rnperiods\r\rseasonal_period\r\rtrend\r\rspike\r\rlinearity\r\rcurvature\r\re_acf1\r\re_acf10\r\rtrev_num\r\rtsfeatures_frequency\r\rtsfeatures_nperiods\r\rtsfeatures_seasonal_period\r\rtsfeatures_trend\r\rtsfeatures_spike\r\rtsfeatures_linearity\r\rtsfeatures_curvature\r\rtsfeatures_e_acf1\r\rtsfeatures_e_acf10\r\rtsfeatures_entropy\r\rtsfeatures_x_acf1\r\rtsfeatures_x_acf10\r\rtsfeatures_diff1_acf1\r\rtsfeatures_diff1_acf10\r\rtsfeatures_diff2_acf1\r\rtsfeatures_diff2_acf10\r\runitroot_kpss\r\runitroot_pp\r\rwalker_propcross\r\r\r\r\r\r1\r\r1\r\r0\r\r-0.0675275\r\r0.0097094\r\r0.0526897\r\r-0.5005299\r\r0.3297018\r\r-0.6772403\r\r0.6124739\r\r0.0627825\r\r0.3929961\r\r0.6147860\r\r-0.0675275\r\r1\r\r0.1208750\r\r2.071663\r\r0.5405405\r\r1\r\r1\r\r0.3929961\r\r0.6147860\r\r-0.0675275\r\r1\r\r0.1208750\r\r2.071663\r\r0.5405405\r\r1\r\r1\r\r1.788841\r\r1.408737\r\r1.68\r\r1.43\r\r-0.25\r\r-0.2865385\r\r0.1627907\r\r132\r\r-0.25\r\r-0.2865385\r\r0.3929961\r\r0.9840151\r\r1\r\r3\r\r4\r\r0.1627907\r\r0.0652585\r\r0.0154406\r\r0.0627825\r\r0.0253367\r\r-0.25\r\r0.0013330\r\r0.0013330\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r0.3556536\r\r1.783636\r\r103\r\r1.297736\r\r97\r\r2.819828\r\r46\r\r2.071663\r\r0.0752319\r\r-0.2865385\r\r0.0108653\r\r0.4457792\r\r1.0525222\r\r1\r\r1\r\r1.788841\r\r1.788841\r\r1.788841\r\r0.1627907\r\r1.76\r\r0.0562693\r\r1.408737\r\r1.74\r\r1.36\r\r1.408737\r\r0\r\r1\r\r0.0043052\r\r0.0000261\r\r0.8421403\r\r-0.7069160\r\r0.0052389\r\r0.0588324\r\r0.1208750\r\r1\r\r0\r\r1\r\r0.0043052\r\r0.0000261\r\r0.8421403\r\r-0.7069160\r\r0.0052389\r\r0.0588324\r\r0.9840151\r\r0.0097094\r\r0.0526897\r\r-0.5005299\r\r0.3297018\r\r-0.6772403\r\r0.6124739\r\r0.0993829\r\r-249.7732\r\r0.5405405\r\r\r\r2\r\r2\r\r0\r\r-0.0421577\r\r-0.0075902\r\r0.0387481\r\r-0.5171529\r\r0.3129147\r\r-0.6727897\r\r0.5379301\r\r0.0558032\r\r0.4285714\r\r0.6563707\r\r-0.0421577\r\r1\r\r-0.4765229\r\r2.077581\r\r0.5019305\r\r1\r\r1\r\r0.4285714\r\r0.6563707\r\r-0.0421577\r\r1\r\r-0.4765229\r\r2.077581\r\r0.5019305\r\r1\r\r1\r\r1.780390\r\r1.419266\r\r1.95\r\r1.00\r\r0.50\r\r0.2615385\r\r0.1627907\r\r123\r\r0.50\r\r0.2615385\r\r0.4285714\r\r0.9864332\r\r1\r\r1\r\r4\r\r0.1627907\r\r0.0664358\r\r0.0657859\r\r0.0558032\r\r0.0554355\r\r0.50\r\r0.0001000\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r0.4636768\r\r1.733008\r\r247\r\r1.311861\r\r141\r\r2.625772\r\r221\r\r2.077581\r\r0.0273335\r\r0.2615385\r\r0.0256032\r\r0.4606850\r\r1.0171377\r\r1\r\r1\r\r1.780390\r\r1.780390\r\r1.780390\r\r0.1627907\r\r2.05\r\r0.0892206\r\r1.419266\r\r2.12\r\r1.00\r\r1.419266\r\r0\r\r1\r\r0.0177460\r\r0.0000399\r\r0.9249561\r\r0.7665407\r\r-0.0218053\r\r0.0411861\r\r-0.4765229\r\r1\r\r0\r\r1\r\r0.0177460\r\r0.0000399\r\r0.9249561\r\r0.7665407\r\r-0.0218053\r\r0.0411861\r\r0.9864332\r\r-0.0075902\r\r0.0387481\r\r-0.5171529\r\r0.3129147\r\r-0.6727897\r\r0.5379301\r\r0.0414599\r\r-256.0485\r\r0.5019305\r\r\r\r3\r\r3\r\r1\r\r0.0099598\r\r-0.0405929\r\r0.0449036\r\r-0.5026683\r\r0.3471209\r\r-0.6718885\r\r0.6109006\r\r0.0325470\r\r0.4671815\r\r0.7065637\r\r0.0099598\r\r1\r\r-0.8755173\r\r2.069233\r\r0.5328185\r\r1\r\r0\r\r0.4671815\r\r0.7065637\r\r0.0099598\r\r1\r\r-0.8755173\r\r2.069233\r\r0.5328185\r\r1\r\r1\r\r1.706841\r\r1.443315\r\r1.38\r\r1.00\r\r-0.50\r\r-0.2538462\r\r0.1395349\r\r132\r\r-0.50\r\r-0.2538462\r\r0.4671815\r\r0.9868568\r\r1\r\r1\r\r6\r\r0.1395349\r\r0.0388513\r\r0.0039162\r\r0.0325470\r\r0.0041902\r\r-0.50\r\r0.0014557\r\r0.0014557\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r1.2670493\r\r7.746711\r\r95\r\r1.403784\r\r87\r\r5.235499\r\r84\r\r2.069233\r\r0.2436499\r\r-0.2538462\r\r0.0223069\r\r0.5356408\r\r0.9954919\r\r1\r\r1\r\r1.706841\r\r1.706841\r\r1.706841\r\r0.1395349\r\r1.42\r\r0.0716499\r\r1.443315\r\r1.42\r\r1.00\r\r1.443315\r\r0\r\r1\r\r0.0141368\r\r0.0000929\r\r0.8414359\r\r-0.0259311\r\r-0.0547484\r\r0.0492987\r\r-0.8755173\r\r1\r\r0\r\r1\r\r0.0141368\r\r0.0000929\r\r0.8414359\r\r-0.0259311\r\r-0.0547484\r\r0.0492987\r\r0.9868568\r\r-0.0405929\r\r0.0449036\r\r-0.5026683\r\r0.3471209\r\r-0.6718885\r\r0.6109006\r\r0.0775698\r\r-258.1295\r\r0.5328185\r\r\r\r4\r\r4\r\r0\r\r-0.0428748\r\r-0.0443619\r\r0.0615867\r\r-0.4571442\r\r0.3184053\r\r-0.5906478\r\r0.4361178\r\r0.1275576\r\r0.4555985\r\r0.7027027\r\r-0.0428748\r\r2\r\r-0.9943808\r\r2.068744\r\r0.4903475\r\r0\r\r0\r\r0.4555985\r\r0.7027027\r\r-0.0428748\r\r2\r\r-0.9943808\r\r2.068744\r\r0.4903475\r\r1\r\r1\r\r1.660825\r\r1.445807\r\r1.24\r\r1.00\r\r0.25\r\r0.0153846\r\r0.1395349\r\r127\r\r0.25\r\r0.0153846\r\r0.4555985\r\r0.9790521\r\r2\r\r1\r\r7\r\r0.1395349\r\r0.0694296\r\r0.0112709\r\r0.0579144\r\r0.0123884\r\r0.25\r\r0.0480021\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r1.0068624\r\r4.994753\r\r132\r\r1.258758\r\r173\r\r5.886911\r\r156\r\r2.068744\r\r0.3840091\r\r0.0153846\r\r0.0503205\r\r0.5402603\r\r1.1070217\r\r1\r\r1\r\r1.660825\r\r1.660825\r\r1.660825\r\r0.1395349\r\r1.10\r\r0.1065111\r\r1.445807\r\r1.14\r\r1.00\r\r1.445807\r\r0\r\r1\r\r0.0283540\r\r0.0000482\r\r-1.2297854\r\r0.2921899\r\r-0.0728152\r\r0.0752389\r\r-0.9943808\r\r1\r\r0\r\r1\r\r0.0283540\r\r0.0000482\r\r-1.2297854\r\r0.2921899\r\r-0.0728152\r\r0.0752389\r\r0.9790521\r\r-0.0443619\r\r0.0615867\r\r-0.4571442\r\r0.3184053\r\r-0.5906478\r\r0.4361178\r\r0.2129633\r\r-262.0781\r\r0.4903475\r\r\r\r5\r\r5\r\r0\r\r0.0259312\r\r-0.2447835\r\r0.1469130\r\r-0.5810073\r\r0.4796508\r\r-0.6799229\r\r0.6232529\r\r0.2014861\r\r0.6563707\r\r0.7992278\r\r0.0259312\r\r1\r\r-0.7167079\r\r2.059764\r\r0.5289575\r\r1\r\r0\r\r0.6563707\r\r0.7992278\r\r0.0259312\r\r1\r\r-0.7167079\r\r2.059764\r\r0.5289575\r\r1\r\r1\r\r1.347789\r\r1.580825\r\r1.08\r\r0.98\r\r-0.50\r\r0.7961538\r\r0.1627907\r\r133\r\r-0.50\r\r0.7961538\r\r0.6563707\r\r0.9723766\r\r1\r\r1\r\r9\r\r0.1627907\r\r0.2718058\r\r0.2229375\r\r0.1765130\r\r0.1330761\r\r-0.50\r\r0.0001000\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r2.8846415\r\r11.474426\r\r80\r\r1.772392\r\r229\r\r8.468236\r\r236\r\r2.059764\r\r0.2143595\r\r0.7961538\r\r0.1008392\r\r0.7538746\r\r1.2926800\r\r1\r\r1\r\r1.347789\r\r1.347789\r\r1.347789\r\r0.1627907\r\r1.08\r\r0.0797924\r\r1.580825\r\r1.06\r\r0.98\r\r1.580825\r\r0\r\r1\r\r0.0121072\r\r0.0001568\r\r-0.5488436\r\r0.2255538\r\r-0.2599764\r\r0.1558209\r\r-0.7167079\r\r1\r\r0\r\r1\r\r0.0121072\r\r0.0001568\r\r-0.5488436\r\r0.2255538\r\r-0.2599764\r\r0.1558209\r\r0.9723766\r\r-0.2447835\r\r0.1469130\r\r-0.5810073\r\r0.4796508\r\r-0.6799229\r\r0.6232529\r\r0.1506344\r\r-323.5672\r\r0.5289575\r\r\r\r6\r\r6\r\r0\r\r-0.0761166\r\r0.0468556\r\r0.0858348\r\r-0.5253131\r\r0.3438031\r\r-0.6901570\r\r0.6130725\r\r0.0432628\r\r0.4352941\r\r0.6627451\r\r-0.0761166\r\r1\r\r0.0898648\r\r2.068914\r\r0.5250965\r\r1\r\r1\r\r0.4352941\r\r0.6627451\r\r-0.0761166\r\r1\r\r0.0898648\r\r2.068914\r\r0.5250965\r\r1\r\r1\r\r1.751575\r\r1.381854\r\r2.69\r\r1.71\r\r-0.25\r\r-0.0846154\r\r0.3488372\r\r134\r\r-0.25\r\r-0.0846154\r\r0.4352941\r\r0.9806218\r\r1\r\r5\r\r5\r\r0.3488372\r\r0.0500806\r\r0.0502154\r\r0.0627968\r\r0.0620877\r\r-0.25\r\r0.0286244\r\r0.0001000\r\r0.5188805\r\rNA\r\rNA\r\r1\r\r0.2189481\r\r3.145763\r\r141\r\r1.447883\r\r80\r\r2.077936\r\r84\r\r2.068914\r\r0.0137733\r\r-0.0846154\r\r0.0172321\r\r0.4345976\r\r1.0881798\r\r1\r\r1\r\r1.751575\r\r1.751575\r\r1.751575\r\r0.3488372\r\r2.61\r\r0.1479673\r\r1.381854\r\r2.63\r\r1.81\r\r1.381854\r\r0\r\r1\r\r0.0077481\r\r0.0000329\r\r-0.5473782\r\r0.4505809\r\r0.0410068\r\r0.0873468\r\r0.0898648\r\r1\r\r0\r\r1\r\r0.0077481\r\r0.0000329\r\r-0.5473782\r\r0.4505809\r\r0.0410068\r\r0.0873468\r\r0.9806218\r\r0.0468556\r\r0.0858348\r\r-0.5253131\r\r0.3438031\r\r-0.6901570\r\r0.6130725\r\r0.0259414\r\r-262.3484\r\r0.5250965\r\r\r\r\r## [1] 12000 109\rThe dimensions of the data as still 12,000 with 109 features (created from the tsfeatures package). That is we have 6,000 synthetic and 6,000 real financial time series (12,000 * ~260 = 3,120,000 but we applied tsfeatures to collapse the ~260 down to 1 single observation for each asset)\nI collapsed this problem down from a time series prediction problem to a pure classification problem. I split the data between training and validation set next… I also split the data into X_train, Y_train… etc.\nI split the df/Stats data set into a train set of 75% of the observations and an in-sample test data set of 25% of the observations.\n######################################################################\r################# Train and XGBoost model on the TS Features #########\r#Stats \u0026lt;- Stats %\u0026gt;%\r# select_if(~sum(!is.na(.)) \u0026gt; 0)\r# Split the training set up between train and a small validation set\rsmp_size \u0026lt;- floor(0.75 * nrow(Stats))\r#set.seed(123)\rtrain_ind \u0026lt;- sample(seq_len(nrow(Stats)), size = smp_size)\rtrain \u0026lt;- Stats[train_ind, ]\rval \u0026lt;- Stats[-train_ind, ]\r# We have 106 time series features for the model to learn from.\rx_train \u0026lt;- train %\u0026gt;%\rungroup() %\u0026gt;%\rselect(-class, -row_id, -X) %\u0026gt;%\ras.matrix()\rx_val \u0026lt;- val %\u0026gt;%\rungroup() %\u0026gt;%\rselect(-class, -row_id, -X) %\u0026gt;%\ras.matrix()\ry_train \u0026lt;- train %\u0026gt;%\rungroup() %\u0026gt;%\rpull(class)\ry_val \u0026lt;- val %\u0026gt;%\rungroup() %\u0026gt;%\rpull(class)\r\rHow the training X (input variables) data looks:\rTable 5: How the X_train data look\r\r\r\r\rac_9_ac_9\r\racf_features_x_acf1\r\racf_features_x_acf10\r\racf_features_diff1_acf1\r\racf_features_diff1_acf10\r\racf_features_diff2_acf1\r\racf_features_diff2_acf10\r\rARCH.LM\r\rautocorr_features_embed2_incircle_1\r\rautocorr_features_embed2_incircle_2\r\rautocorr_features_ac_9\r\rautocorr_features_firstmin_ac\r\rautocorr_features_trev_num\r\rautocorr_features_motiftwo_entro3\r\rautocorr_features_walker_propcross\r\rbinarize_mean_binarize_mean\r\rbinarize_mean_NA\r\rcompengine_embed2_incircle_1\r\rcompengine_embed2_incircle_2\r\rcompengine_ac_9\r\rcompengine_firstmin_ac\r\rcompengine_trev_num\r\rcompengine_motiftwo_entro3\r\rcompengine_walker_propcross\r\rcompengine_localsimple_mean1\r\rcompengine_localsimple_lfitac\r\rcompengine_sampen_first\r\rcompengine_std1st_der\r\rcompengine_spreadrandomlocal_meantaul_50\r\rcompengine_spreadrandomlocal_meantaul_ac2\r\rcompengine_histogram_mode_10\r\rcompengine_outlierinclude_mdrmd\r\rcompengine_fluctanal_prop_r1\r\rcrossing_points\r\rdist_features_histogram_mode_10\r\rdist_features_outlierinclude_mdrmd\r\rembed2_incircle\r\rentropy\r\rfirstmin_ac\r\rfirstzero_ac\r\rflat_spots\r\rfluctanal_prop_r1_fluctanal_prop_r1\r\rarch_acf\r\rgarch_acf\r\rarch_r2\r\rgarch_r2\r\rhistogram_mode\r\ralpha\r\rbeta\r\rhurst\r\rhw_parameters_hw_parameters\r\rhw_parameters_NA\r\rlocalsimple_taures\r\rlumpiness\r\rmax_kl_shift\r\rtime_kl_shift\r\rmax_level_shift\r\rtime_level_shift\r\rmax_var_shift\r\rtime_var_shift\r\rmotiftwo_entro3\r\rnonlinearity\r\routlierinclude_mdrmd\r\rx_pacf5\r\rdiff1x_pacf5\r\rdiff2x_pacf5\r\rpred_features_localsimple_mean1\r\rpred_features_localsimple_lfitac\r\rpred_features_sampen_first\r\rsampen_first_sampen_first\r\rsampenc\r\rscal_features_fluctanal_prop_r1\r\rspreadrandomlocal_meantaul\r\rstability\r\rstation_features_std1st_der\r\rstation_features_spreadrandomlocal_meantaul_50\r\rstation_features_spreadrandomlocal_meantaul_ac2\r\rstd1st_der_std1st_der\r\rnperiods\r\rseasonal_period\r\rtrend\r\rspike\r\rlinearity\r\rcurvature\r\re_acf1\r\re_acf10\r\rtrev_num\r\rtsfeatures_frequency\r\rtsfeatures_nperiods\r\rtsfeatures_seasonal_period\r\rtsfeatures_trend\r\rtsfeatures_spike\r\rtsfeatures_linearity\r\rtsfeatures_curvature\r\rtsfeatures_e_acf1\r\rtsfeatures_e_acf10\r\rtsfeatures_entropy\r\rtsfeatures_x_acf1\r\rtsfeatures_x_acf10\r\rtsfeatures_diff1_acf1\r\rtsfeatures_diff1_acf10\r\rtsfeatures_diff2_acf1\r\rtsfeatures_diff2_acf10\r\runitroot_kpss\r\runitroot_pp\r\rwalker_propcross\r\r\r\r\r\r6801\r\r0.0498492\r\r-0.0642025\r\r0.0542648\r\r-0.4423482\r\r0.2575236\r\r-0.5981303\r\r0.4149592\r\r0.0271444\r\r0.4710425\r\r0.7181467\r\r0.0498492\r\r2\r\r0.8754566\r\r2.057333\r\r0.5598456\r\r0\r\r1\r\r0.4710425\r\r0.7181467\r\r0.0498492\r\r2\r\r0.8754566\r\r2.057333\r\r0.5598456\r\r1\r\r1\r\r1.704503\r\r1.460466\r\r1.33\r\r1.00\r\r-0.50\r\r0.1115385\r\r0.8604651\r\r139\r\r-0.50\r\r0.1115385\r\r0.4710425\r\r0.9888208\r\r2\r\r1\r\r3\r\r0.8604651\r\r0.0332257\r\r0.0244434\r\r0.0370423\r\r0.0287773\r\r-0.50\r\r0.0001000\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r0.7769640\r\r3.827223\r\r209\r\r1.027671\r\r131\r\r3.254518\r\r195\r\r2.057333\r\r0.0695918\r\r0.1115385\r\r0.0474059\r\r0.5669070\r\r1.0663179\r\r1\r\r1\r\r1.704503\r\r1.704503\r\r1.704503\r\r0.8604651\r\r1.41\r\r0.0639649\r\r1.460466\r\r1.42\r\r1.00\r\r1.460466\r\r0\r\r1\r\r0.0069481\r\r0.0000643\r\r-0.8628963\r\r0.2636951\r\r-0.0719026\r\r0.0587799\r\r0.8754566\r\r1\r\r0\r\r1\r\r0.0069481\r\r0.0000643\r\r-0.8628963\r\r0.2636951\r\r-0.0719026\r\r0.0587799\r\r0.9888208\r\r-0.0642025\r\r0.0542648\r\r-0.4423482\r\r0.2575236\r\r-0.5981303\r\r0.4149592\r\r0.1777957\r\r-246.9618\r\r0.5598456\r\r\r\r4209\r\r-0.0037257\r\r-0.0166400\r\r0.0302609\r\r-0.5444182\r\r0.3391695\r\r-0.7025401\r\r0.5898760\r\r0.0369855\r\r0.3976834\r\r0.6409266\r\r-0.0037257\r\r1\r\r0.0772589\r\r2.065480\r\r0.5598456\r\r1\r\r1\r\r0.3976834\r\r0.6409266\r\r-0.0037257\r\r1\r\r0.0772589\r\r2.065480\r\r0.5598456\r\r1\r\r1\r\r1.752028\r\r1.427591\r\r1.39\r\r1.00\r\r-0.25\r\r-0.1000000\r\r0.4651163\r\r137\r\r-0.25\r\r-0.1000000\r\r0.3976834\r\r0.9866480\r\r1\r\r1\r\r4\r\r0.4651163\r\r0.0328564\r\r0.0286941\r\r0.0369855\r\r0.0347972\r\r-0.25\r\r0.0008843\r\r0.0008843\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r0.2267605\r\r3.549229\r\r215\r\r1.390319\r\r3\r\r2.017745\r\r143\r\r2.065480\r\r0.0236440\r\r-0.1000000\r\r0.0060988\r\r0.4859730\r\r1.0685267\r\r1\r\r1\r\r1.752028\r\r1.752028\r\r1.752028\r\r0.4651163\r\r1.49\r\r0.0831999\r\r1.427591\r\r1.53\r\r1.00\r\r1.427591\r\r0\r\r1\r\r0.0431696\r\r0.0000288\r\r-0.6356332\r\r1.0362897\r\r-0.0608160\r\r0.0358936\r\r0.0772589\r\r1\r\r0\r\r1\r\r0.0431696\r\r0.0000288\r\r-0.6356332\r\r1.0362897\r\r-0.0608160\r\r0.0358936\r\r0.9866480\r\r-0.0166400\r\r0.0302609\r\r-0.5444182\r\r0.3391695\r\r-0.7025401\r\r0.5898760\r\r0.0372919\r\r-268.4757\r\r0.5598456\r\r\r\r11168\r\r0.0236704\r\r-0.0269749\r\r0.0299079\r\r-0.4943006\r\r0.2640054\r\r-0.6626027\r\r0.4906038\r\r0.1265569\r\r0.4401544\r\r0.6640927\r\r0.0236704\r\r2\r\r-0.4569401\r\r2.075666\r\r0.4633205\r\r1\r\r1\r\r0.4401544\r\r0.6640927\r\r0.0236704\r\r2\r\r-0.4569401\r\r2.075666\r\r0.4633205\r\r1\r\r1\r\r1.709466\r\r1.431144\r\r1.52\r\r1.00\r\r0.25\r\r-0.0961538\r\r0.1627907\r\r122\r\r0.25\r\r-0.0961538\r\r0.4401544\r\r0.9882937\r\r2\r\r1\r\r4\r\r0.1627907\r\r0.1453674\r\r0.1490540\r\r0.1265569\r\r0.1247021\r\r0.25\r\r0.0411075\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r0.3863291\r\r2.834691\r\r227\r\r1.096209\r\r123\r\r2.760158\r\r197\r\r2.075666\r\r0.1218026\r\r-0.0961538\r\r0.0088598\r\r0.4643608\r\r1.0505751\r\r1\r\r1\r\r1.709466\r\r1.709466\r\r1.709466\r\r0.1627907\r\r1.61\r\r0.0691848\r\r1.431144\r\r1.50\r\r1.00\r\r1.431144\r\r0\r\r1\r\r0.0134781\r\r0.0000342\r\r-0.6468298\r\r-1.1770328\r\r-0.0419291\r\r0.0376999\r\r-0.4569401\r\r1\r\r0\r\r1\r\r0.0134781\r\r0.0000342\r\r-0.6468298\r\r-1.1770328\r\r-0.0419291\r\r0.0376999\r\r0.9882937\r\r-0.0269749\r\r0.0299079\r\r-0.4943006\r\r0.2640054\r\r-0.6626027\r\r0.4906038\r\r0.1743418\r\r-260.0758\r\r0.4633205\r\r\r\r5794\r\r-0.0007087\r\r0.1194830\r\r0.0616705\r\r-0.4062897\r\r0.2206195\r\r-0.6016700\r\r0.4137913\r\r0.1556551\r\r0.4806202\r\r0.6782946\r\r-0.0007087\r\r2\r\r-0.5797405\r\r2.066637\r\r0.4787645\r\r1\r\r0\r\r0.4806202\r\r0.6782946\r\r-0.0007087\r\r2\r\r-0.5797405\r\r2.066637\r\r0.4787645\r\r1\r\r1\r\r1.558307\r\r1.328565\r\r2.03\r\r1.18\r\r-0.25\r\r-0.3000000\r\r0.2325581\r\r120\r\r-0.25\r\r-0.3000000\r\r0.4806202\r\r0.9815963\r\r2\r\r2\r\r5\r\r0.2325581\r\r0.2198692\r\r0.0941053\r\r0.1406280\r\r0.0756639\r\r-0.25\r\r0.0125856\r\r0.0001000\r\r0.5477543\r\rNA\r\rNA\r\r1\r\r0.7772726\r\r8.411092\r\r48\r\r1.573682\r\r146\r\r3.802986\r\r149\r\r2.066637\r\r0.1381103\r\r-0.3000000\r\r0.0193037\r\r0.3959500\r\r0.9255264\r\r1\r\r1\r\r1.558307\r\r1.558307\r\r1.558307\r\r0.2325581\r\r1.98\r\r0.1331827\r\r1.328565\r\r2.01\r\r1.27\r\r1.328565\r\r0\r\r1\r\r0.0139233\r\r0.0000358\r\r-0.8988748\r\r0.9389128\r\r0.1079346\r\r0.0661260\r\r-0.5797405\r\r1\r\r0\r\r1\r\r0.0139233\r\r0.0000358\r\r-0.8988748\r\r0.9389128\r\r0.1079346\r\r0.0661260\r\r0.9815963\r\r0.1194830\r\r0.0616705\r\r-0.4062897\r\r0.2206195\r\r-0.6016700\r\r0.4137913\r\r0.1182423\r\r-224.0670\r\r0.4787645\r\r\r\r8693\r\r-0.0814496\r\r-0.0984498\r\r0.1142883\r\r-0.4688008\r\r0.3181153\r\r-0.6166136\r\r0.4555893\r\r0.1508792\r\r0.4054054\r\r0.6602317\r\r-0.0814496\r\r2\r\r0.3988370\r\r2.060571\r\r0.5250965\r\r0\r\r1\r\r0.4054054\r\r0.6602317\r\r-0.0814496\r\r2\r\r0.3988370\r\r2.060571\r\r0.5250965\r\r1\r\r1\r\r1.651243\r\r1.484233\r\r1.19\r\r1.00\r\r-0.50\r\r-0.0576923\r\r0.3488372\r\r136\r\r-0.50\r\r-0.0576923\r\r0.4054054\r\r0.9745764\r\r2\r\r1\r\r6\r\r0.3488372\r\r0.0946062\r\r0.0937635\r\r0.1057152\r\r0.1052409\r\r-0.50\r\r0.0269522\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r0.5495742\r\r7.853783\r\r195\r\r1.039641\r\r191\r\r4.458772\r\r187\r\r2.060571\r\r0.1164590\r\r-0.0576923\r\r0.0467339\r\r0.5896074\r\r1.1095330\r\r1\r\r1\r\r1.651243\r\r1.651243\r\r1.651243\r\r0.3488372\r\r1.24\r\r0.0998210\r\r1.484233\r\r1.35\r\r1.00\r\r1.484233\r\r0\r\r1\r\r0.0033231\r\r0.0000574\r\r0.1887497\r\r0.4564879\r\r-0.1022983\r\r0.1171558\r\r0.3988370\r\r1\r\r0\r\r1\r\r0.0033231\r\r0.0000574\r\r0.1887497\r\r0.4564879\r\r-0.1022983\r\r0.1171558\r\r0.9745764\r\r-0.0984498\r\r0.1142883\r\r-0.4688008\r\r0.3181153\r\r-0.6166136\r\r0.4555893\r\r0.0391658\r\r-262.9010\r\r0.5250965\r\r\r\r1073\r\r-0.1253873\r\r0.1511912\r\r0.0608605\r\r-0.3832523\r\r0.2048003\r\r-0.5832067\r\r0.3861283\r\r0.0876692\r\r0.4031008\r\r0.6356589\r\r-0.1253873\r\r2\r\r0.2463431\r\r2.061698\r\r0.4594595\r\r1\r\r1\r\r0.4031008\r\r0.6356589\r\r-0.1253873\r\r2\r\r0.2463431\r\r2.061698\r\r0.4594595\r\r1\r\r1\r\r1.763381\r\r1.304792\r\r2.44\r\r1.13\r\r-0.25\r\r0.1230769\r\r0.1395349\r\r121\r\r-0.25\r\r0.1230769\r\r0.4031008\r\r0.9867903\r\r2\r\r2\r\r4\r\r0.1395349\r\r0.0779468\r\r0.0618625\r\r0.0695878\r\r0.0601294\r\r-0.25\r\r0.0778294\r\r0.0001000\r\r0.5663347\r\rNA\r\rNA\r\r1\r\r0.3151884\r\r7.528904\r\r185\r\r2.069230\r\r177\r\r2.340804\r\r169\r\r2.061698\r\r0.0279574\r\r0.1230769\r\r0.0310540\r\r0.3527793\r\r0.8978003\r\r1\r\r1\r\r1.763381\r\r1.763381\r\r1.763381\r\r0.1395349\r\r2.45\r\r0.0816322\r\r1.304792\r\r2.35\r\r1.23\r\r1.304792\r\r0\r\r1\r\r0.0213244\r\r0.0000306\r\r-0.5577693\r\r0.6111726\r\r0.1329904\r\r0.0758345\r\r0.2463431\r\r1\r\r0\r\r1\r\r0.0213244\r\r0.0000306\r\r-0.5577693\r\r0.6111726\r\r0.1329904\r\r0.0758345\r\r0.9867903\r\r0.1511912\r\r0.0608605\r\r-0.3832523\r\r0.2048003\r\r-0.5832067\r\r0.3861283\r\r0.0849681\r\r-208.4546\r\r0.4594595\r\r\r\r\r\rHow the training Y (predictor variable) data looks:\rTable 6: Y_train\r\r\r\r.\r\r\r\r\r\r1\r\r\r\r0\r\r\r\r1\r\r\r\r0\r\r\r\r0\r\r\r\r1\r\r\r\r\rI set the data up for an XGBoost model:\nI create a grid search in order search over a parameter space to locate the optimal parameters for the data set. It needs a little more work but it’s a pretty good starting point. I can just add code to the expand.grid function. That is, say I want to increase the depth of the tree I can add to max_depth = c(5, 8, 14) more parameters such as max_depth = c(5, 8, 14, 1, 2, 3, 4, 6, 7). Note Adding parameters to the grid search increases computational time exponentially. Every parameter you add a value to, the model has to search all possible combinations associated with that parameter. That is, adding an eta = c(0.1) and max_depth = c(5) would give me the optimal parameter for one iteration/loop through the training model, i.e. an eta = c(0.1) mapped onto a max_depth = c(5). Adding an additional value to the eta = c(0.1, 0.3) and max_depth = c(5) would map eta = 0.1 onto max_depth = 5 and eta = 0.3 on to max_depth = 5. If I add another value such that eta = c(0.1, 0.3, 0.4) then all 3 of these values will be mapped to max_depth = c(5). Adding values to the max_depth = c(5) parameter would add an extra layer of complexity to the grid search. This added into the fact that there are many parameters to optimize in an XGBoost model can drastically increase computational complexity. Thus, understanding the statistics behind the models in Machine Learning is important when trying to avoid getting stuck in a local minimum (which any greedy algorithm using gradient descent optimisation can do: greedy algorithm).\n######################################################################\r################# XGBoost Grid Search to locate Optimal Parameters ###\r##############################################################################################################################\r# NOTE: This section was taken from the first chapter of my PhD where I needed to search over a parameter space to locate the\r# most optimal parameters - I have just adapted it for this problem of Time Series Classification.\r# Its simple enough to add parameters and different values - I just optimise a few important parameters from domain knowledge\r# of the XGBoost model for this task, i.e depth and eta are quite important in gradient boosting.\r# 1) I create a \u0026quot;grid\u0026quot; with different parameter values or combinations of parameter values\r# 2) I apply cross validation over the parameter space to fine the most optimal values for the XGBoost model.\r# 3) I print the model parameters which give the best train / (in-sample test) results in a data table.\r##############################################################################################################################\r# Grid Search Parameters:\r# 1)\rsearchGridSubCol \u0026lt;- expand.grid(subsample = c(1), #Range (0,1], default = 1, set to 0.5 will prevent overfitting\rcolsample_bytree = c(1), #Range (0,1], default = 1\rmax_depth = c(5, 8, 14), #Range (0, inf], default = 6\rmin_child = c(1), #Range (0, inf], default = 1\reta = c(0.1, 0.05, 0.3), #Range (0,1], default = 0.3\rgamma = c(0), #Range (0, inf], default = 0\rlambda = c(1), #Default = 1, L2 regularisation on weights, higher the more conservative the model\ralpha = c(0), #Default = 0, L1 regularisation on weights, higher the more conservative the model\rmax_delta_step = c(0), #Range (0, inf], default = 0 (Helpful for logisitc regression when class is extremely imbalanced, set to value 1-10 may help control the update)\rcolsample_bylevel = c(1) #Range (0,1], default = 1\r)\rntrees = 200\rnfold \u0026lt;- 10 # I use nfold = 10 which is probably too many folds, 5 should be sufficient.\rwatchlist \u0026lt;- list(train = dtrain, test = dval)\r# 2)\rsystem.time(\rAUCHyperparameters \u0026lt;- apply(searchGridSubCol, 1, function(parameterList){\r#Extract Parameters to test\rcurrentSubsampleRate \u0026lt;- parameterList[[\u0026quot;sub_sample\u0026quot;]]\rcurrentColsampleRate \u0026lt;- parameterList[[\u0026quot;colsample_bytree\u0026quot;]]\rcurrentDepth \u0026lt;- parameterList[[\u0026quot;max_depth\u0026quot;]]\rcurrentEta \u0026lt;- parameterList[[\u0026quot;eta\u0026quot;]]\rcurrentMinChild \u0026lt;- parameterList[[\u0026quot;min_child\u0026quot;]]\rgamma \u0026lt;- parameterList[[\u0026quot;gamma\u0026quot;]]\rlambda \u0026lt;- parameterList[[\u0026quot;lambda\u0026quot;]]\ralpha \u0026lt;- parameterList[[\u0026quot;alpha\u0026quot;]]\rmax_delta_step \u0026lt;- parameterList[[\u0026quot;max_delta_step\u0026quot;]]\rcolsample_bylevel \u0026lt;- parameterList[[\u0026quot;colsample_bylevel\u0026quot;]]\rxgboostModelCV \u0026lt;- xgb.cv(data = dtrain,\rnrounds = ntrees,\rnfold = nfold,\rshowsd = TRUE,\rmetrics = c(\u0026quot;auc\u0026quot;, \u0026quot;logloss\u0026quot;, \u0026quot;error\u0026quot;),\rverbose = TRUE,\r\u0026quot;eval_metric\u0026quot; = c(\u0026quot;auc\u0026quot;, \u0026quot;logloss\u0026quot;, \u0026quot;error\u0026quot;),\r\u0026quot;objective\u0026quot; = \u0026quot;binary:logistic\u0026quot;, #Outputs a probability \u0026quot;binary:logitraw\u0026quot; - outputs score before logistic transformation\r\u0026quot;max.depth\u0026quot; = currentDepth,\r\u0026quot;eta\u0026quot; = currentEta,\r\u0026quot;gamma\u0026quot; = gamma,\r\u0026quot;lambda\u0026quot; = lambda,\r\u0026quot;alpha\u0026quot; = alpha,\r\u0026quot;subsample\u0026quot; = currentSubsampleRate,\r\u0026quot;colsample_bytree\u0026quot; = currentColsampleRate,\rprint_every_n = 50, # print ever 50 trees to reduce the outputs printed.\r\u0026quot;min_child_weight\u0026quot; = currentMinChild,\rbooster = \u0026quot;gbtree\u0026quot;, #booster = \u0026quot;dart\u0026quot; #using dart can help improve accuracy.\rearly_stopping_rounds = 10,\rwatchlist = watchlist,\rseed = 1234)\rxvalidationScores \u0026lt;\u0026lt;- as.data.frame(xgboostModelCV$evaluation_log)\rtrain_auc_mean \u0026lt;- tail(xvalidationScores$train_auc_mean, 1)\rtest_auc_mean \u0026lt;- tail(xvalidationScores$test_auc_mean, 1)\rtrain_logloss_mean \u0026lt;- tail(xvalidationScores$train_logloss_mean, 1)\rtest_logloss_mean \u0026lt;- tail(xvalidationScores$test_logloss_mean, 1)\rtrain_error_mean \u0026lt;- tail(xvalidationScores$train_error_mean, 1)\rtest_error_mean \u0026lt;- tail(xvalidationScores$test_error_mean, 1)\routput \u0026lt;- return(c(train_auc_mean, test_auc_mean, train_logloss_mean, test_logloss_mean, train_error_mean, test_error_mean, xvalidationScores, currentSubsampleRate, currentColsampleRate, currentDepth, currentEta, gamma, lambda, alpha, max_delta_step, colsample_bylevel, currentMinChild))\rhypemeans \u0026lt;- which.max(AUCHyperparameters[[1]]$test_auc_mean)\routput2 \u0026lt;- return(hypemeans)\r}))\rThe output of the grid search can be set into a nice data frame using the following code. However I did not save this output to file and therefore cannot read it in. You can view the output on the original Jupyter Notebook In [49] here\n# 3)\routput \u0026lt;- as.data.frame(t(sapply(AUCHyperparameters, \u0026#39;[\u0026#39;, c(1:6, 20:29))))\rvarnames \u0026lt;- c(\u0026quot;TrainAUC\u0026quot;, \u0026quot;TestAUC\u0026quot;, \u0026quot;TrainLogloss\u0026quot;, \u0026quot;TestLogloss\u0026quot;, \u0026quot;TrainError\u0026quot;, \u0026quot;TestError\u0026quot;, \u0026quot;SubSampRate\u0026quot;, \u0026quot;ColSampRate\u0026quot;, \u0026quot;Depth\u0026quot;, \u0026quot;eta\u0026quot;, \u0026quot;gamma\u0026quot;, \u0026quot;lambda\u0026quot;, \u0026quot;alpha\u0026quot;, \u0026quot;max_delta_step\u0026quot;, \u0026quot;col_sample_bylevel\u0026quot;, \u0026quot;currentMinChild\u0026quot;)\rcolnames(output) \u0026lt;- varnames\rdata.table(output)\rAccording to the results at the time the optimal parameters were:\n\rntrees = 95,\reta = 0.1,\rmax_depth = 5,\r\rWith the other parameters left to default settings for simplicity.\n\rPlug the optimal parameters into the model.\r#################################################################################\r################# XGBoost Optimal Parameters from Cross Validation ##############\r# This is the final training model where I use the most optimal parameters found over the grid space and plug them in here.\rwatchlist \u0026lt;- list(\u0026quot;train\u0026quot; = dtrain)\rparams \u0026lt;- list(\u0026quot;eta\u0026quot; = 0.1, \u0026quot;max_depth\u0026quot; = 5, \u0026quot;colsample_bytree\u0026quot; = 1, \u0026quot;min_child_weight\u0026quot; = 1, \u0026quot;subsample\u0026quot;= 1,\r\u0026quot;objective\u0026quot;=\u0026quot;binary:logistic\u0026quot;, \u0026quot;gamma\u0026quot; = 1, \u0026quot;lambda\u0026quot; = 1, \u0026quot;alpha\u0026quot; = 0, \u0026quot;max_delta_step\u0026quot; = 0,\r\u0026quot;colsample_bylevel\u0026quot; = 1, \u0026quot;eval_metric\u0026quot;= \u0026quot;auc\u0026quot;,\r\u0026quot;set.seed\u0026quot; = 176)\rnround \u0026lt;- 95\rNow that I have the optimal parameters from the cross validation grid search I can train the final XGBoost model on the whole train_val.csv data set. (Whereas before the optimal parameters were obtained from different folds in the model. More info on k-fold cross validation here)\n# Train the XGBoost model\rxgb.model \u0026lt;- xgb.train(params, dtrain, nround, watchlist)\r## [1] train-auc:0.700790 ## [2] train-auc:0.720114 ## [3] train-auc:0.735281 ## [4] train-auc:0.741159 ## [5] train-auc:0.748016 ## [6] train-auc:0.752070 ## [7] train-auc:0.754637 ## [8] train-auc:0.759151 ## [9] train-auc:0.762538 ## [10] train-auc:0.769652 ## [11] train-auc:0.776582 ## [12] train-auc:0.780015 ## [13] train-auc:0.782065 ## [14] train-auc:0.782815 ## [15] train-auc:0.788966 ## [16] train-auc:0.791026 ## [17] train-auc:0.793545 ## [18] train-auc:0.797363 ## [19] train-auc:0.799069 ## [20] train-auc:0.802015 ## [21] train-auc:0.802583 ## [22] train-auc:0.806938 ## [23] train-auc:0.808239 ## [24] train-auc:0.811255 ## [25] train-auc:0.813142 ## [26] train-auc:0.816767 ## [27] train-auc:0.817697 ## [28] train-auc:0.820239 ## [29] train-auc:0.821589 ## [30] train-auc:0.823343 ## [31] train-auc:0.823939 ## [32] train-auc:0.825701 ## [33] train-auc:0.827316 ## [34] train-auc:0.829365 ## [35] train-auc:0.832646 ## [36] train-auc:0.833297 ## [37] train-auc:0.837006 ## [38] train-auc:0.838857 ## [39] train-auc:0.839923 ## [40] train-auc:0.842968 ## [41] train-auc:0.844877 ## [42] train-auc:0.845940 ## [43] train-auc:0.846583 ## [44] train-auc:0.847330 ## [45] train-auc:0.848292 ## [46] train-auc:0.850215 ## [47] train-auc:0.851641 ## [48] train-auc:0.852670 ## [49] train-auc:0.854706 ## [50] train-auc:0.855752 ## [51] train-auc:0.856772 ## [52] train-auc:0.857806 ## [53] train-auc:0.860245 ## [54] train-auc:0.861337 ## [55] train-auc:0.864178 ## [56] train-auc:0.865290 ## [57] train-auc:0.865808 ## [58] train-auc:0.866386 ## [59] train-auc:0.867751 ## [60] train-auc:0.870032 ## [61] train-auc:0.870500 ## [62] train-auc:0.872442 ## [63] train-auc:0.873391 ## [64] train-auc:0.875188 ## [65] train-auc:0.877767 ## [66] train-auc:0.879196 ## [67] train-auc:0.880079 ## [68] train-auc:0.879969 ## [69] train-auc:0.880638 ## [70] train-auc:0.881389 ## [71] train-auc:0.882066 ## [72] train-auc:0.882515 ## [73] train-auc:0.883854 ## [74] train-auc:0.884654 ## [75] train-auc:0.885104 ## [76] train-auc:0.885922 ## [77] train-auc:0.887100 ## [78] train-auc:0.888646 ## [79] train-auc:0.889833 ## [80] train-auc:0.890387 ## [81] train-auc:0.891815 ## [82] train-auc:0.892281 ## [83] train-auc:0.894417 ## [84] train-auc:0.895006 ## [85] train-auc:0.897079 ## [86] train-auc:0.899254 ## [87] train-auc:0.901114 ## [88] train-auc:0.902460 ## [89] train-auc:0.902939 ## [90] train-auc:0.903763 ## [91] train-auc:0.903792 ## [92] train-auc:0.904433 ## [93] train-auc:0.904986 ## [94] train-auc:0.907339 ## [95] train-auc:0.907761\r# Note: Plot AUC on for the in-sample train / validation scores - this was a note for me at the time of writing this R file - I never did get around to plotting the AUC for the in-sample train / validation scores...\rWhat is nice about tree based models is that we can obtain importance scores from the model and find which variables contributed most to the gain in the model. The original paper explains more about the gain in Algorithm 1 and Algorithm 3 here.\n# We can obtain \u0026quot;feature\u0026quot; importance results from the model.\rxgb.imp \u0026lt;- xgb.importance(model = xgb.model)\rxgb.plot.importance(xgb.imp, top_n = 10)\rThat is, the XGBoost model found that the spike was the most important variable. The spike comes from the stl_features function of the tsfeatures package in R. It computes various measures of trend and seasonality based on Seasonal and Trend Decomposition (STL) and measures the spikiness of a time series based on the variance of the leave-one-out variances of component e_t.\nThe second variable is interesting also and comes from the compengine feature set from the CompEngine database. It groups variables as autocorrelation, prediction, stationarity, distribution and scaling.\nThe ARCH.LM comes from the arch_stat function of the tsfeatures package and is based on the Lagrange Multiplier for Autoregressive Conditional Heteroscedasticity (ARCH) Engle 1982.\nThese are just a few of the variables the XGBoost model found to be the most important. A full overview and more information of the variables used in the model can be found here.\nPredictions using the in-sample test set\rNow that I have trained the model using the optimal parameters I want to see if it scores the same or better based on the cross validation phase using the validation data. I use the dval which is the validation data set from the training split to test the model.\n# I next make the predictions on the \u0026#39;in-sample\u0026#39; held out test set, that is, originally I took the 12,000 training samples\r# and split them between 75% training and 25% \u0026#39;in-sample\u0026#39; testing (9000 training vs 3000 in-sample testing)\r# I plot the probabilities from the model - the \u0026quot;dashed\u0026quot; line is the average predicted probability.\rxgb.pred \u0026lt;- predict(xgb.model, dval, type = \u0026#39;prob\u0026#39;)\rresults \u0026lt;- cbind(y_val, xgb.pred)\rresults %\u0026gt;%\ras.tibble() %\u0026gt;%\rggplot(aes(x = xgb.pred)) + geom_density(color = \u0026quot;darkblue\u0026quot;, fill = \u0026quot;lightblue\u0026quot;) +\rgeom_vline(aes(xintercept = mean(xgb.pred)),\rcolor = \u0026quot;blue\u0026quot;, linetype = \u0026quot;dashed\u0026quot;, size = 1) +\rgeom_histogram(aes(y = ..density..), colour = \u0026quot;black\u0026quot;, fill = \u0026quot;white\u0026quot;, alpha = 0.1, position = \u0026quot;identity\u0026quot;) +\rggtitle(\u0026quot;Predicted probability density plot\u0026quot;) +\rtheme_tq()\r# The average predicted probability sits around 0.48 / 0.49, for simplicity I will just select 0.50 as the cut off threshold.\r# That is, all observations \u0026lt;= 0.50 are assigned a \u0026quot;0\u0026quot; class or \u0026quot;synthetic\u0026quot; data and all observations \u0026gt;= are assigned a \u0026quot;1\u0026quot; or\r# \u0026quot;real\u0026quot; data.\r# Finally I output the confusion matrix on the \u0026#39;in-sample\u0026#39; testing data.\rresults \u0026lt;- results %\u0026gt;%\ras_tibble() %\u0026gt;%\rmutate(pred = case_when(\rxgb.pred \u0026gt; 0.5 ~ 1,\rxgb.pred \u0026lt;= 0.5 ~ 0\r))\rconfusionMatrix(factor(results$pred), factor(results$y_val))\r## Confusion Matrix and Statistics\r## ## Reference\r## Prediction 0 1\r## 0 1041 537\r## 1 465 957\r## ## Accuracy : 0.666 ## 95% CI : (0.6488, 0.6829) ## No Information Rate : 0.502 ## P-Value [Acc \u0026gt; NIR] : \u0026lt;0.0000000000000002\r## ## Kappa : 0.3319 ## ## Mcnemar\u0026#39;s Test P-Value : 0.0249 ## ## Sensitivity : 0.6912 ## Specificity : 0.6406 ## Pos Pred Value : 0.6597 ## Neg Pred Value : 0.6730 ## Prevalence : 0.5020 ## Detection Rate : 0.3470 ## Detection Prevalence : 0.5260 ## Balanced Accuracy : 0.6659 ## ## \u0026#39;Positive\u0026#39; Class : 0 ## \rA balanced accuracy score of 67% isn’t so bad considering I threw the kitchen sink at the classification problem and that this is a time series (stock market) classification problem. By kitchen sink I refer to all the time series functions found in the tsfeatures package.\nFrom here I end the training and validation model. I have obtained the optimal values based on the training and validation data sets and now I want to test it on the unknown data the test.csv data.\nI read in the test data and compute the time series features from the tsfeatures package just as I did with the training data.\n test_final \u0026lt;- read.csv(\u0026quot;C:/Users/Matt/Desktop/Data Science Challenge/test.csv\u0026quot;) %\u0026gt;%\rmutate(row_id = row_number()) %\u0026gt;%\rmelt(., measure.vars = 1:260) %\u0026gt;%\rarrange(row_id)\r\rHow the test features look - (they look similar to the train data set):\rTable 7: Test feature data set\r\r\r\rrow_id\r\rvariable\r\rvalue\r\r\r\r\r\r1\r\rfeature1\r\r0.0331039\r\r\r\r1\r\rfeature2\r\r0.0086225\r\r\r\r1\r\rfeature3\r\r0.0040622\r\r\r\r1\r\rfeature4\r\r0.0082554\r\r\r\r1\r\rfeature5\r\r0.0558741\r\r\r\r1\r\rfeature6\r\r-0.0061266\r\r\r\r\rI call this test_final and not test for no reason what so ever - its the same test.csv from the beginning.\nNext I create the same time series features on the test data set as I do on the training data set. I save this as TSfeatures_test.csv.\nfunctions \u0026lt;- sample(functions, 20)\rtest_final \u0026lt;- test_final %\u0026gt;%\rgroup_by(row_id) %\u0026gt;%\r# nest() %\u0026gt;%\r# sample_n(5) %\u0026gt;%\r# ungroup() %\u0026gt;%\r# unnest() %\u0026gt;%\rnest(-row_id) %\u0026gt;%\rgroup_by(row_id) %T\u0026gt;%\r{options(warn = -1)} %\u0026gt;%\rsummarise(Statistics = map(data, ~ data.frame(\rbind_cols(\rtsfeatures(.x$value, functions))))) %\u0026gt;%\runnest(Statistics)\r#print(\u0026quot;Generated 106 Time Series features\u0026quot;)\r#write.csv(test_final, \u0026quot;TSfeatures_test.csv\u0026quot;)\rI have computed all the tsfeatures for the train data set and also for the test data set. I saved these two as TSfeatures_train_val.csv and TSfeatures_test.csv.\nLoad in the train and test features data sets\rI uploaded these files here\n# I have already created the features for the training dataset so I can just load them right back in as train_final \u0026lt;- read.csv(\u0026quot;C:/Users/Matt/Desktop/Data Science Challenge/TSfeatures_train_val.csv\u0026quot;)\rtest_final \u0026lt;- read.csv(\u0026quot;C:/Users/Matt/Desktop/Data Science Challenge/TSfeatures_test.csv\u0026quot;)\rThe final data for the training and test looks like:\ntrain_final %\u0026gt;%\rhead() %\u0026gt;%\rkable(caption = \u0026quot;Final training data set\u0026quot;) %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;), font_size = 12)\rTable 8: Final training data set\r\r\r\rX\r\rrow_id\r\rclass\r\rac_9_ac_9\r\racf_features_x_acf1\r\racf_features_x_acf10\r\racf_features_diff1_acf1\r\racf_features_diff1_acf10\r\racf_features_diff2_acf1\r\racf_features_diff2_acf10\r\rARCH.LM\r\rautocorr_features_embed2_incircle_1\r\rautocorr_features_embed2_incircle_2\r\rautocorr_features_ac_9\r\rautocorr_features_firstmin_ac\r\rautocorr_features_trev_num\r\rautocorr_features_motiftwo_entro3\r\rautocorr_features_walker_propcross\r\rbinarize_mean_binarize_mean\r\rbinarize_mean_NA\r\rcompengine_embed2_incircle_1\r\rcompengine_embed2_incircle_2\r\rcompengine_ac_9\r\rcompengine_firstmin_ac\r\rcompengine_trev_num\r\rcompengine_motiftwo_entro3\r\rcompengine_walker_propcross\r\rcompengine_localsimple_mean1\r\rcompengine_localsimple_lfitac\r\rcompengine_sampen_first\r\rcompengine_std1st_der\r\rcompengine_spreadrandomlocal_meantaul_50\r\rcompengine_spreadrandomlocal_meantaul_ac2\r\rcompengine_histogram_mode_10\r\rcompengine_outlierinclude_mdrmd\r\rcompengine_fluctanal_prop_r1\r\rcrossing_points\r\rdist_features_histogram_mode_10\r\rdist_features_outlierinclude_mdrmd\r\rembed2_incircle\r\rentropy\r\rfirstmin_ac\r\rfirstzero_ac\r\rflat_spots\r\rfluctanal_prop_r1_fluctanal_prop_r1\r\rarch_acf\r\rgarch_acf\r\rarch_r2\r\rgarch_r2\r\rhistogram_mode\r\ralpha\r\rbeta\r\rhurst\r\rhw_parameters_hw_parameters\r\rhw_parameters_NA\r\rlocalsimple_taures\r\rlumpiness\r\rmax_kl_shift\r\rtime_kl_shift\r\rmax_level_shift\r\rtime_level_shift\r\rmax_var_shift\r\rtime_var_shift\r\rmotiftwo_entro3\r\rnonlinearity\r\routlierinclude_mdrmd\r\rx_pacf5\r\rdiff1x_pacf5\r\rdiff2x_pacf5\r\rpred_features_localsimple_mean1\r\rpred_features_localsimple_lfitac\r\rpred_features_sampen_first\r\rsampen_first_sampen_first\r\rsampenc\r\rscal_features_fluctanal_prop_r1\r\rspreadrandomlocal_meantaul\r\rstability\r\rstation_features_std1st_der\r\rstation_features_spreadrandomlocal_meantaul_50\r\rstation_features_spreadrandomlocal_meantaul_ac2\r\rstd1st_der_std1st_der\r\rnperiods\r\rseasonal_period\r\rtrend\r\rspike\r\rlinearity\r\rcurvature\r\re_acf1\r\re_acf10\r\rtrev_num\r\rtsfeatures_frequency\r\rtsfeatures_nperiods\r\rtsfeatures_seasonal_period\r\rtsfeatures_trend\r\rtsfeatures_spike\r\rtsfeatures_linearity\r\rtsfeatures_curvature\r\rtsfeatures_e_acf1\r\rtsfeatures_e_acf10\r\rtsfeatures_entropy\r\rtsfeatures_x_acf1\r\rtsfeatures_x_acf10\r\rtsfeatures_diff1_acf1\r\rtsfeatures_diff1_acf10\r\rtsfeatures_diff2_acf1\r\rtsfeatures_diff2_acf10\r\runitroot_kpss\r\runitroot_pp\r\rwalker_propcross\r\r\r\r\r\r1\r\r1\r\r0\r\r-0.0675275\r\r0.0097094\r\r0.0526897\r\r-0.5005299\r\r0.3297018\r\r-0.6772403\r\r0.6124739\r\r0.0627825\r\r0.3929961\r\r0.6147860\r\r-0.0675275\r\r1\r\r0.1208750\r\r2.071663\r\r0.5405405\r\r1\r\r1\r\r0.3929961\r\r0.6147860\r\r-0.0675275\r\r1\r\r0.1208750\r\r2.071663\r\r0.5405405\r\r1\r\r1\r\r1.788841\r\r1.408737\r\r1.68\r\r1.43\r\r-0.25\r\r-0.2865385\r\r0.1627907\r\r132\r\r-0.25\r\r-0.2865385\r\r0.3929961\r\r0.9840151\r\r1\r\r3\r\r4\r\r0.1627907\r\r0.0652585\r\r0.0154406\r\r0.0627825\r\r0.0253367\r\r-0.25\r\r0.0013330\r\r0.0013330\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r0.3556536\r\r1.783636\r\r103\r\r1.297736\r\r97\r\r2.819828\r\r46\r\r2.071663\r\r0.0752319\r\r-0.2865385\r\r0.0108653\r\r0.4457792\r\r1.0525222\r\r1\r\r1\r\r1.788841\r\r1.788841\r\r1.788841\r\r0.1627907\r\r1.76\r\r0.0562693\r\r1.408737\r\r1.74\r\r1.36\r\r1.408737\r\r0\r\r1\r\r0.0043052\r\r0.0000261\r\r0.8421403\r\r-0.7069160\r\r0.0052389\r\r0.0588324\r\r0.1208750\r\r1\r\r0\r\r1\r\r0.0043052\r\r0.0000261\r\r0.8421403\r\r-0.7069160\r\r0.0052389\r\r0.0588324\r\r0.9840151\r\r0.0097094\r\r0.0526897\r\r-0.5005299\r\r0.3297018\r\r-0.6772403\r\r0.6124739\r\r0.0993829\r\r-249.7732\r\r0.5405405\r\r\r\r2\r\r2\r\r0\r\r-0.0421577\r\r-0.0075902\r\r0.0387481\r\r-0.5171529\r\r0.3129147\r\r-0.6727897\r\r0.5379301\r\r0.0558032\r\r0.4285714\r\r0.6563707\r\r-0.0421577\r\r1\r\r-0.4765229\r\r2.077581\r\r0.5019305\r\r1\r\r1\r\r0.4285714\r\r0.6563707\r\r-0.0421577\r\r1\r\r-0.4765229\r\r2.077581\r\r0.5019305\r\r1\r\r1\r\r1.780390\r\r1.419266\r\r1.95\r\r1.00\r\r0.50\r\r0.2615385\r\r0.1627907\r\r123\r\r0.50\r\r0.2615385\r\r0.4285714\r\r0.9864332\r\r1\r\r1\r\r4\r\r0.1627907\r\r0.0664358\r\r0.0657859\r\r0.0558032\r\r0.0554355\r\r0.50\r\r0.0001000\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r0.4636768\r\r1.733008\r\r247\r\r1.311861\r\r141\r\r2.625772\r\r221\r\r2.077581\r\r0.0273335\r\r0.2615385\r\r0.0256032\r\r0.4606850\r\r1.0171377\r\r1\r\r1\r\r1.780390\r\r1.780390\r\r1.780390\r\r0.1627907\r\r2.05\r\r0.0892206\r\r1.419266\r\r2.12\r\r1.00\r\r1.419266\r\r0\r\r1\r\r0.0177460\r\r0.0000399\r\r0.9249561\r\r0.7665407\r\r-0.0218053\r\r0.0411861\r\r-0.4765229\r\r1\r\r0\r\r1\r\r0.0177460\r\r0.0000399\r\r0.9249561\r\r0.7665407\r\r-0.0218053\r\r0.0411861\r\r0.9864332\r\r-0.0075902\r\r0.0387481\r\r-0.5171529\r\r0.3129147\r\r-0.6727897\r\r0.5379301\r\r0.0414599\r\r-256.0485\r\r0.5019305\r\r\r\r3\r\r3\r\r1\r\r0.0099598\r\r-0.0405929\r\r0.0449036\r\r-0.5026683\r\r0.3471209\r\r-0.6718885\r\r0.6109006\r\r0.0325470\r\r0.4671815\r\r0.7065637\r\r0.0099598\r\r1\r\r-0.8755173\r\r2.069233\r\r0.5328185\r\r1\r\r0\r\r0.4671815\r\r0.7065637\r\r0.0099598\r\r1\r\r-0.8755173\r\r2.069233\r\r0.5328185\r\r1\r\r1\r\r1.706841\r\r1.443315\r\r1.38\r\r1.00\r\r-0.50\r\r-0.2538462\r\r0.1395349\r\r132\r\r-0.50\r\r-0.2538462\r\r0.4671815\r\r0.9868568\r\r1\r\r1\r\r6\r\r0.1395349\r\r0.0388513\r\r0.0039162\r\r0.0325470\r\r0.0041902\r\r-0.50\r\r0.0014557\r\r0.0014557\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r1.2670493\r\r7.746711\r\r95\r\r1.403784\r\r87\r\r5.235499\r\r84\r\r2.069233\r\r0.2436499\r\r-0.2538462\r\r0.0223069\r\r0.5356408\r\r0.9954919\r\r1\r\r1\r\r1.706841\r\r1.706841\r\r1.706841\r\r0.1395349\r\r1.42\r\r0.0716499\r\r1.443315\r\r1.42\r\r1.00\r\r1.443315\r\r0\r\r1\r\r0.0141368\r\r0.0000929\r\r0.8414359\r\r-0.0259311\r\r-0.0547484\r\r0.0492987\r\r-0.8755173\r\r1\r\r0\r\r1\r\r0.0141368\r\r0.0000929\r\r0.8414359\r\r-0.0259311\r\r-0.0547484\r\r0.0492987\r\r0.9868568\r\r-0.0405929\r\r0.0449036\r\r-0.5026683\r\r0.3471209\r\r-0.6718885\r\r0.6109006\r\r0.0775698\r\r-258.1295\r\r0.5328185\r\r\r\r4\r\r4\r\r0\r\r-0.0428748\r\r-0.0443619\r\r0.0615867\r\r-0.4571442\r\r0.3184053\r\r-0.5906478\r\r0.4361178\r\r0.1275576\r\r0.4555985\r\r0.7027027\r\r-0.0428748\r\r2\r\r-0.9943808\r\r2.068744\r\r0.4903475\r\r0\r\r0\r\r0.4555985\r\r0.7027027\r\r-0.0428748\r\r2\r\r-0.9943808\r\r2.068744\r\r0.4903475\r\r1\r\r1\r\r1.660825\r\r1.445807\r\r1.24\r\r1.00\r\r0.25\r\r0.0153846\r\r0.1395349\r\r127\r\r0.25\r\r0.0153846\r\r0.4555985\r\r0.9790521\r\r2\r\r1\r\r7\r\r0.1395349\r\r0.0694296\r\r0.0112709\r\r0.0579144\r\r0.0123884\r\r0.25\r\r0.0480021\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r1.0068624\r\r4.994753\r\r132\r\r1.258758\r\r173\r\r5.886911\r\r156\r\r2.068744\r\r0.3840091\r\r0.0153846\r\r0.0503205\r\r0.5402603\r\r1.1070217\r\r1\r\r1\r\r1.660825\r\r1.660825\r\r1.660825\r\r0.1395349\r\r1.10\r\r0.1065111\r\r1.445807\r\r1.14\r\r1.00\r\r1.445807\r\r0\r\r1\r\r0.0283540\r\r0.0000482\r\r-1.2297854\r\r0.2921899\r\r-0.0728152\r\r0.0752389\r\r-0.9943808\r\r1\r\r0\r\r1\r\r0.0283540\r\r0.0000482\r\r-1.2297854\r\r0.2921899\r\r-0.0728152\r\r0.0752389\r\r0.9790521\r\r-0.0443619\r\r0.0615867\r\r-0.4571442\r\r0.3184053\r\r-0.5906478\r\r0.4361178\r\r0.2129633\r\r-262.0781\r\r0.4903475\r\r\r\r5\r\r5\r\r0\r\r0.0259312\r\r-0.2447835\r\r0.1469130\r\r-0.5810073\r\r0.4796508\r\r-0.6799229\r\r0.6232529\r\r0.2014861\r\r0.6563707\r\r0.7992278\r\r0.0259312\r\r1\r\r-0.7167079\r\r2.059764\r\r0.5289575\r\r1\r\r0\r\r0.6563707\r\r0.7992278\r\r0.0259312\r\r1\r\r-0.7167079\r\r2.059764\r\r0.5289575\r\r1\r\r1\r\r1.347789\r\r1.580825\r\r1.08\r\r0.98\r\r-0.50\r\r0.7961538\r\r0.1627907\r\r133\r\r-0.50\r\r0.7961538\r\r0.6563707\r\r0.9723766\r\r1\r\r1\r\r9\r\r0.1627907\r\r0.2718058\r\r0.2229375\r\r0.1765130\r\r0.1330761\r\r-0.50\r\r0.0001000\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r2.8846415\r\r11.474426\r\r80\r\r1.772392\r\r229\r\r8.468236\r\r236\r\r2.059764\r\r0.2143595\r\r0.7961538\r\r0.1008392\r\r0.7538746\r\r1.2926800\r\r1\r\r1\r\r1.347789\r\r1.347789\r\r1.347789\r\r0.1627907\r\r1.08\r\r0.0797924\r\r1.580825\r\r1.06\r\r0.98\r\r1.580825\r\r0\r\r1\r\r0.0121072\r\r0.0001568\r\r-0.5488436\r\r0.2255538\r\r-0.2599764\r\r0.1558209\r\r-0.7167079\r\r1\r\r0\r\r1\r\r0.0121072\r\r0.0001568\r\r-0.5488436\r\r0.2255538\r\r-0.2599764\r\r0.1558209\r\r0.9723766\r\r-0.2447835\r\r0.1469130\r\r-0.5810073\r\r0.4796508\r\r-0.6799229\r\r0.6232529\r\r0.1506344\r\r-323.5672\r\r0.5289575\r\r\r\r6\r\r6\r\r0\r\r-0.0761166\r\r0.0468556\r\r0.0858348\r\r-0.5253131\r\r0.3438031\r\r-0.6901570\r\r0.6130725\r\r0.0432628\r\r0.4352941\r\r0.6627451\r\r-0.0761166\r\r1\r\r0.0898648\r\r2.068914\r\r0.5250965\r\r1\r\r1\r\r0.4352941\r\r0.6627451\r\r-0.0761166\r\r1\r\r0.0898648\r\r2.068914\r\r0.5250965\r\r1\r\r1\r\r1.751575\r\r1.381854\r\r2.69\r\r1.71\r\r-0.25\r\r-0.0846154\r\r0.3488372\r\r134\r\r-0.25\r\r-0.0846154\r\r0.4352941\r\r0.9806218\r\r1\r\r5\r\r5\r\r0.3488372\r\r0.0500806\r\r0.0502154\r\r0.0627968\r\r0.0620877\r\r-0.25\r\r0.0286244\r\r0.0001000\r\r0.5188805\r\rNA\r\rNA\r\r1\r\r0.2189481\r\r3.145763\r\r141\r\r1.447883\r\r80\r\r2.077936\r\r84\r\r2.068914\r\r0.0137733\r\r-0.0846154\r\r0.0172321\r\r0.4345976\r\r1.0881798\r\r1\r\r1\r\r1.751575\r\r1.751575\r\r1.751575\r\r0.3488372\r\r2.61\r\r0.1479673\r\r1.381854\r\r2.63\r\r1.81\r\r1.381854\r\r0\r\r1\r\r0.0077481\r\r0.0000329\r\r-0.5473782\r\r0.4505809\r\r0.0410068\r\r0.0873468\r\r0.0898648\r\r1\r\r0\r\r1\r\r0.0077481\r\r0.0000329\r\r-0.5473782\r\r0.4505809\r\r0.0410068\r\r0.0873468\r\r0.9806218\r\r0.0468556\r\r0.0858348\r\r-0.5253131\r\r0.3438031\r\r-0.6901570\r\r0.6130725\r\r0.0259414\r\r-262.3484\r\r0.5250965\r\r\r\r\rtest_final %\u0026gt;%\rhead() %\u0026gt;%\rkable(caption = \u0026quot;Final testing data set\u0026quot;) %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;), font_size = 12)\rTable 9: Final testing data set\r\r\r\rX\r\rrow_id\r\rac_9_ac_9\r\racf_features_x_acf1\r\racf_features_x_acf10\r\racf_features_diff1_acf1\r\racf_features_diff1_acf10\r\racf_features_diff2_acf1\r\racf_features_diff2_acf10\r\rARCH.LM\r\rautocorr_features_embed2_incircle_1\r\rautocorr_features_embed2_incircle_2\r\rautocorr_features_ac_9\r\rautocorr_features_firstmin_ac\r\rautocorr_features_trev_num\r\rautocorr_features_motiftwo_entro3\r\rautocorr_features_walker_propcross\r\rbinarize_mean_binarize_mean\r\rbinarize_mean_NA\r\rcompengine_embed2_incircle_1\r\rcompengine_embed2_incircle_2\r\rcompengine_ac_9\r\rcompengine_firstmin_ac\r\rcompengine_trev_num\r\rcompengine_motiftwo_entro3\r\rcompengine_walker_propcross\r\rcompengine_localsimple_mean1\r\rcompengine_localsimple_lfitac\r\rcompengine_sampen_first\r\rcompengine_std1st_der\r\rcompengine_spreadrandomlocal_meantaul_50\r\rcompengine_spreadrandomlocal_meantaul_ac2\r\rcompengine_histogram_mode_10\r\rcompengine_outlierinclude_mdrmd\r\rcompengine_fluctanal_prop_r1\r\rcrossing_points\r\rdist_features_histogram_mode_10\r\rdist_features_outlierinclude_mdrmd\r\rembed2_incircle\r\rentropy\r\rfirstmin_ac\r\rfirstzero_ac\r\rflat_spots\r\rfluctanal_prop_r1_fluctanal_prop_r1\r\rarch_acf\r\rgarch_acf\r\rarch_r2\r\rgarch_r2\r\rhistogram_mode\r\ralpha\r\rbeta\r\rhurst\r\rhw_parameters_hw_parameters\r\rhw_parameters_NA\r\rlocalsimple_taures\r\rlumpiness\r\rmax_kl_shift\r\rtime_kl_shift\r\rmax_level_shift\r\rtime_level_shift\r\rmax_var_shift\r\rtime_var_shift\r\rmotiftwo_entro3\r\rnonlinearity\r\routlierinclude_mdrmd\r\rx_pacf5\r\rdiff1x_pacf5\r\rdiff2x_pacf5\r\rpred_features_localsimple_mean1\r\rpred_features_localsimple_lfitac\r\rpred_features_sampen_first\r\rsampen_first_sampen_first\r\rsampenc\r\rscal_features_fluctanal_prop_r1\r\rspreadrandomlocal_meantaul\r\rstability\r\rstation_features_std1st_der\r\rstation_features_spreadrandomlocal_meantaul_50\r\rstation_features_spreadrandomlocal_meantaul_ac2\r\rstd1st_der_std1st_der\r\rnperiods\r\rseasonal_period\r\rtrend\r\rspike\r\rlinearity\r\rcurvature\r\re_acf1\r\re_acf10\r\rtrev_num\r\rtsfeatures_frequency\r\rtsfeatures_nperiods\r\rtsfeatures_seasonal_period\r\rtsfeatures_trend\r\rtsfeatures_spike\r\rtsfeatures_linearity\r\rtsfeatures_curvature\r\rtsfeatures_e_acf1\r\rtsfeatures_e_acf10\r\rtsfeatures_entropy\r\rtsfeatures_x_acf1\r\rtsfeatures_x_acf10\r\rtsfeatures_diff1_acf1\r\rtsfeatures_diff1_acf10\r\rtsfeatures_diff2_acf1\r\rtsfeatures_diff2_acf10\r\runitroot_kpss\r\runitroot_pp\r\rwalker_propcross\r\r\r\r\r\r1\r\r1\r\r-0.0262073\r\r-0.0396281\r\r0.0429784\r\r-0.4964245\r\r0.3379915\r\r-0.6704837\r\r0.6178088\r\r0.1425744\r\r0.5482625\r\r0.7528958\r\r-0.0262073\r\r1\r\r-0.5824739\r\r2.063564\r\r0.4826255\r\r1\r\r1\r\r0.5482625\r\r0.7528958\r\r-0.0262073\r\r1\r\r-0.5824739\r\r2.063564\r\r0.4826255\r\r1\r\r1\r\r1.383933\r\r1.437946\r\r1.91\r\r1.00\r\r0.50\r\r0.4307692\r\r0.1395349\r\r117\r\r0.50\r\r0.4307692\r\r0.5482625\r\r0.9817288\r\r1\r\r1\r\r7\r\r0.1395349\r\r0.1906443\r\r0.0422059\r\r0.1425744\r\r0.0417531\r\r0.50\r\r0.0440489\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r1.1617874\r\r4.857530\r\r130\r\r1.031623\r\r230\r\r3.967385\r\r214\r\r2.063564\r\r0.0716802\r\r0.4307692\r\r0.0271516\r\r0.5270423\r\r0.9564642\r\r1\r\r1\r\r1.383933\r\r1.383933\r\r1.383933\r\r0.1395349\r\r1.80\r\r0.0804590\r\r1.437946\r\r1.89\r\r1.00\r\r1.437946\r\r0\r\r1\r\r0.0355541\r\r0.0000573\r\r-2.6210355\r\r-0.0981868\r\r-0.0740868\r\r0.0651438\r\r-0.5824739\r\r1\r\r0\r\r1\r\r0.0355541\r\r0.0000573\r\r-2.6210355\r\r-0.0981868\r\r-0.0740868\r\r0.0651438\r\r0.9817288\r\r-0.0396281\r\r0.0429784\r\r-0.4964245\r\r0.3379915\r\r-0.6704837\r\r0.6178088\r\r0.8820380\r\r-252.2509\r\r0.4826255\r\r\r\r2\r\r2\r\r-0.0047799\r\r0.0544155\r\r0.0423445\r\r-0.4931653\r\r0.3114689\r\r-0.6980787\r\r0.6597427\r\r0.1111625\r\r0.4513619\r\r0.6964981\r\r-0.0047799\r\r3\r\r0.2147570\r\r2.068849\r\r0.5250965\r\r1\r\r0\r\r0.4513619\r\r0.6964981\r\r-0.0047799\r\r3\r\r0.2147570\r\r2.068849\r\r0.5250965\r\r1\r\r1\r\r1.611106\r\r1.375120\r\r2.15\r\r1.40\r\r0.25\r\r0.1211538\r\r0.1627907\r\r142\r\r0.25\r\r0.1211538\r\r0.4513619\r\r0.9856808\r\r3\r\r3\r\r6\r\r0.1627907\r\r0.1313081\r\r0.0468159\r\r0.0939769\r\r0.0402163\r\r0.25\r\r0.0063703\r\r0.0001000\r\r0.5012778\r\rNA\r\rNA\r\r1\r\r0.5347516\r\r6.848494\r\r91\r\r1.360520\r\r80\r\r3.586240\r\r75\r\r2.068849\r\r0.0618461\r\r0.1211538\r\r0.0344415\r\r0.4336405\r\r0.9510320\r\r1\r\r1\r\r1.611106\r\r1.611106\r\r1.611106\r\r0.1627907\r\r2.14\r\r0.0796936\r\r1.375120\r\r1.82\r\r1.34\r\r1.375120\r\r0\r\r1\r\r0.0216068\r\r0.0000391\r\r0.1351482\r\r-0.3430376\r\r0.0339344\r\r0.0578569\r\r0.2147570\r\r1\r\r0\r\r1\r\r0.0216068\r\r0.0000391\r\r0.1351482\r\r-0.3430376\r\r0.0339344\r\r0.0578569\r\r0.9856808\r\r0.0544155\r\r0.0423445\r\r-0.4931653\r\r0.3114689\r\r-0.6980787\r\r0.6597427\r\r0.0722224\r\r-226.9463\r\r0.5250965\r\r\r\r3\r\r3\r\r0.0370364\r\r-0.0041963\r\r0.1781209\r\r-0.3838557\r\r0.3158431\r\r-0.5535087\r\r0.3948373\r\r0.3450202\r\r0.6138996\r\r0.7915058\r\r0.0370364\r\r2\r\r2.9002534\r\r2.067845\r\r0.5598456\r\r1\r\r0\r\r0.6138996\r\r0.7915058\r\r0.0370364\r\r2\r\r2.9002534\r\r2.067845\r\r0.5598456\r\r1\r\r1\r\r1.436472\r\r1.414575\r\r1.24\r\r1.00\r\r0.50\r\r0.7230769\r\r0.1627907\r\r139\r\r0.50\r\r0.7230769\r\r0.6138996\r\r0.9627133\r\r2\r\r1\r\r6\r\r0.1627907\r\r0.4731295\r\r0.0342727\r\r0.2247245\r\r0.0323111\r\r0.50\r\r0.0001000\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r3.9022555\r\r33.656077\r\r240\r\r1.695947\r\r222\r\r9.122984\r\r232\r\r2.067845\r\r0.7040489\r\r0.7230769\r\r0.0685939\r\r0.5171369\r\r1.0433489\r\r1\r\r1\r\r1.436472\r\r1.436472\r\r1.436472\r\r0.1627907\r\r1.39\r\r0.1088905\r\r1.414575\r\r1.43\r\r1.00\r\r1.414575\r\r0\r\r1\r\r0.0058644\r\r0.0001243\r\r-1.1897947\r\r-0.4762066\r\r-0.0084531\r\r0.1814633\r\r2.9002534\r\r1\r\r0\r\r1\r\r0.0058644\r\r0.0001243\r\r-1.1897947\r\r-0.4762066\r\r-0.0084531\r\r0.1814633\r\r0.9627133\r\r-0.0041963\r\r0.1781209\r\r-0.3838557\r\r0.3158431\r\r-0.5535087\r\r0.3948373\r\r0.1757311\r\r-235.0780\r\r0.5598456\r\r\r\r4\r\r4\r\r-0.0576029\r\r-0.0338906\r\r0.0251717\r\r-0.4963752\r\r0.2570591\r\r-0.6694337\r\r0.4910006\r\r0.0471296\r\r0.3899614\r\r0.6332046\r\r-0.0576029\r\r3\r\r-0.1053821\r\r2.075447\r\r0.5366795\r\r0\r\r1\r\r0.3899614\r\r0.6332046\r\r-0.0576029\r\r3\r\r-0.1053821\r\r2.075447\r\r0.5366795\r\r1\r\r1\r\r1.785628\r\r1.436827\r\r1.52\r\r1.00\r\r-0.25\r\r0.0769231\r\r0.1860465\r\r137\r\r-0.25\r\r0.0769231\r\r0.3899614\r\r0.9886539\r\r3\r\r1\r\r3\r\r0.1860465\r\r0.0511246\r\r0.0516446\r\r0.0471296\r\r0.0470911\r\r-0.25\r\r0.0025845\r\r0.0025845\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r0.2161135\r\r2.534373\r\r34\r\r1.404765\r\r154\r\r2.213233\r\r205\r\r2.075447\r\r0.0681473\r\r0.0769231\r\r0.0179401\r\r0.4720756\r\r0.9626432\r\r1\r\r1\r\r1.785628\r\r1.785628\r\r1.785628\r\r0.1860465\r\r1.44\r\r0.0499953\r\r1.436827\r\r1.42\r\r1.00\r\r1.436827\r\r0\r\r1\r\r0.0042080\r\r0.0000286\r\r0.9969942\r\r0.1863847\r\r-0.0370368\r\r0.0269840\r\r-0.1053821\r\r1\r\r0\r\r1\r\r0.0042080\r\r0.0000286\r\r0.9969942\r\r0.1863847\r\r-0.0370368\r\r0.0269840\r\r0.9886539\r\r-0.0338906\r\r0.0251717\r\r-0.4963752\r\r0.2570591\r\r-0.6694337\r\r0.4910006\r\r0.0860264\r\r-241.6752\r\r0.5366795\r\r\r\r5\r\r5\r\r-0.1236994\r\r0.0086381\r\r0.0308039\r\r-0.5025363\r\r0.3330186\r\r-0.6693011\r\r0.5835466\r\r0.1157603\r\r0.4202335\r\r0.7003891\r\r-0.1236994\r\r1\r\r-0.0489352\r\r2.058889\r\r0.4864865\r\r1\r\r0\r\r0.4202335\r\r0.7003891\r\r-0.1236994\r\r1\r\r-0.0489352\r\r2.058889\r\r0.4864865\r\r1\r\r1\r\r1.722492\r\r1.396172\r\r1.69\r\r1.32\r\r-0.50\r\r-0.0076923\r\r0.8139535\r\r120\r\r-0.50\r\r-0.0076923\r\r0.4202335\r\r0.9908616\r\r1\r\r3\r\r6\r\r0.8139535\r\r0.0537820\r\r0.0583484\r\r0.1157603\r\r0.1120523\r\r-0.50\r\r0.0001609\r\r0.0001609\r\r0.5090878\r\rNA\r\rNA\r\r1\r\r0.6488028\r\r3.045684\r\r97\r\r1.287940\r\r14\r\r4.338131\r\r240\r\r2.058889\r\r0.0094165\r\r-0.0076923\r\r0.0059114\r\r0.4457371\r\r0.9190563\r\r1\r\r1\r\r1.722492\r\r1.722492\r\r1.722492\r\r0.8139535\r\r1.63\r\r0.1107442\r\r1.396172\r\r1.75\r\r1.35\r\r1.396172\r\r0\r\r1\r\r0.0229286\r\r0.0000550\r\r-0.6149100\r\r0.2128084\r\r-0.0125452\r\r0.0317617\r\r-0.0489352\r\r1\r\r0\r\r1\r\r0.0229286\r\r0.0000550\r\r-0.6149100\r\r0.2128084\r\r-0.0125452\r\r0.0317617\r\r0.9908616\r\r0.0086381\r\r0.0308039\r\r-0.5025363\r\r0.3330186\r\r-0.6693011\r\r0.5835466\r\r0.1169027\r\r-266.1451\r\r0.4864865\r\r\r\r6\r\r6\r\r0.0137566\r\r-0.0889224\r\r0.0668615\r\r-0.5649436\r\r0.4404459\r\r-0.7097820\r\r0.7128451\r\r0.0752299\r\r0.5366795\r\r0.6447876\r\r0.0137566\r\r1\r\r0.3033072\r\r2.064104\r\r0.5328185\r\r1\r\r0\r\r0.5366795\r\r0.6447876\r\r0.0137566\r\r1\r\r0.3033072\r\r2.064104\r\r0.5328185\r\r1\r\r1\r\r1.464977\r\r1.477767\r\r1.53\r\r1.00\r\r0.25\r\r0.3269231\r\r0.1627907\r\r136\r\r0.25\r\r0.3269231\r\r0.5366795\r\r0.9835850\r\r1\r\r1\r\r6\r\r0.1627907\r\r0.1033936\r\r0.0236197\r\r0.0740159\r\r0.0248339\r\r0.25\r\r0.0001000\r\r0.0001000\r\r0.5000458\r\rNA\r\rNA\r\r1\r\r0.7510236\r\r12.688453\r\r197\r\r1.217490\r\r189\r\r2.987989\r\r194\r\r2.064104\r\r0.0649001\r\r0.3269231\r\r0.0200688\r\r0.5201834\r\r1.0761503\r\r1\r\r1\r\r1.464977\r\r1.464977\r\r1.464977\r\r0.1627907\r\r1.35\r\r0.0814814\r\r1.477767\r\r1.36\r\r1.00\r\r1.477767\r\r0\r\r1\r\r0.0081147\r\r0.0000469\r\r0.6555116\r\r-0.0489727\r\r-0.0976177\r\r0.0700199\r\r0.3033072\r\r1\r\r0\r\r1\r\r0.0081147\r\r0.0000469\r\r0.6555116\r\r-0.0489727\r\r-0.0976177\r\r0.0700199\r\r0.9835850\r\r-0.0889224\r\r0.0668615\r\r-0.5649436\r\r0.4404459\r\r-0.7097820\r\r0.7128451\r\r0.0869913\r\r-279.8920\r\r0.5328185\r\r\r\r\rFinally we can run the final model on the held-out-test-set and obtain our predictions based on the training data and the optimal parameters.\n# previously and run the final training model (to make predictions on the out-of-sample test data)\rx_train_final \u0026lt;- train_final %\u0026gt;%\rungroup() %\u0026gt;%\rselect(-class, -row_id, -X) %\u0026gt;%\ras.matrix()\rx_test_final \u0026lt;- test_final %\u0026gt;%\rungroup() %\u0026gt;%\rselect(-row_id, -X) %\u0026gt;%\ras.matrix()\ry_train_final \u0026lt;- train_final %\u0026gt;%\rungroup() %\u0026gt;%\rpull(class)\rdtrain_final \u0026lt;- xgb.DMatrix(data = as.matrix(x_train_final), label = y_train_final, missing = \u0026quot;NaN\u0026quot;)\rdtest_final \u0026lt;- xgb.DMatrix(data = as.matrix(x_test_final), missing = \u0026quot;NaN\u0026quot;)\rwatchlist \u0026lt;- list(\u0026quot;train\u0026quot; = dtrain_final)\rparams \u0026lt;- list(\u0026quot;eta\u0026quot; = 0.1, \u0026quot;max_depth\u0026quot; = 5, \u0026quot;colsample_bytree\u0026quot; = 1, \u0026quot;min_child_weight\u0026quot; = 1, \u0026quot;subsample\u0026quot;= 1,\r\u0026quot;objective\u0026quot;=\u0026quot;binary:logistic\u0026quot;, \u0026quot;gamma\u0026quot; = 1, \u0026quot;lambda\u0026quot; = 1, \u0026quot;alpha\u0026quot; = 0, \u0026quot;max_delta_step\u0026quot; = 0,\r\u0026quot;colsample_bylevel\u0026quot; = 1, \u0026quot;eval_metric\u0026quot;= \u0026quot;auc\u0026quot;,\r\u0026quot;set.seed\u0026quot; = 176)\rnround \u0026lt;- 95\rxgb.model_final \u0026lt;- xgb.train(params, dtrain_final, nround, watchlist)\r## [1] train-auc:0.708604 ## [2] train-auc:0.721700 ## [3] train-auc:0.723230 ## [4] train-auc:0.729888 ## [5] train-auc:0.735542 ## [6] train-auc:0.738081 ## [7] train-auc:0.740926 ## [8] train-auc:0.744105 ## [9] train-auc:0.746320 ## [10] train-auc:0.748644 ## [11] train-auc:0.754211 ## [12] train-auc:0.756892 ## [13] train-auc:0.761524 ## [14] train-auc:0.763882 ## [15] train-auc:0.767216 ## [16] train-auc:0.772009 ## [17] train-auc:0.772943 ## [18] train-auc:0.774261 ## [19] train-auc:0.775471 ## [20] train-auc:0.777801 ## [21] train-auc:0.780629 ## [22] train-auc:0.784384 ## [23] train-auc:0.787112 ## [24] train-auc:0.788946 ## [25] train-auc:0.791835 ## [26] train-auc:0.793142 ## [27] train-auc:0.795289 ## [28] train-auc:0.798502 ## [29] train-auc:0.799893 ## [30] train-auc:0.802186 ## [31] train-auc:0.804981 ## [32] train-auc:0.805649 ## [33] train-auc:0.807120 ## [34] train-auc:0.809020 ## [35] train-auc:0.810318 ## [36] train-auc:0.812637 ## [37] train-auc:0.814760 ## [38] train-auc:0.816024 ## [39] train-auc:0.817956 ## [40] train-auc:0.819350 ## [41] train-auc:0.821653 ## [42] train-auc:0.822729 ## [43] train-auc:0.824029 ## [44] train-auc:0.824765 ## [45] train-auc:0.826924 ## [46] train-auc:0.827804 ## [47] train-auc:0.828475 ## [48] train-auc:0.831018 ## [49] train-auc:0.832247 ## [50] train-auc:0.833265 ## [51] train-auc:0.834168 ## [52] train-auc:0.835535 ## [53] train-auc:0.836093 ## [54] train-auc:0.837008 ## [55] train-auc:0.837715 ## [56] train-auc:0.839537 ## [57] train-auc:0.840310 ## [58] train-auc:0.841701 ## [59] train-auc:0.842480 ## [60] train-auc:0.843106 ## [61] train-auc:0.844495 ## [62] train-auc:0.845348 ## [63] train-auc:0.845932 ## [64] train-auc:0.847843 ## [65] train-auc:0.849445 ## [66] train-auc:0.850345 ## [67] train-auc:0.851337 ## [68] train-auc:0.852121 ## [69] train-auc:0.852663 ## [70] train-auc:0.854132 ## [71] train-auc:0.855949 ## [72] train-auc:0.856758 ## [73] train-auc:0.857115 ## [74] train-auc:0.857954 ## [75] train-auc:0.858849 ## [76] train-auc:0.859527 ## [77] train-auc:0.859917 ## [78] train-auc:0.860590 ## [79] train-auc:0.861264 ## [80] train-auc:0.862359 ## [81] train-auc:0.863101 ## [82] train-auc:0.863794 ## [83] train-auc:0.864911 ## [84] train-auc:0.866293 ## [85] train-auc:0.866976 ## [86] train-auc:0.867436 ## [87] train-auc:0.869036 ## [88] train-auc:0.869469 ## [89] train-auc:0.869931 ## [90] train-auc:0.870681 ## [91] train-auc:0.872326 ## [92] train-auc:0.873706 ## [93] train-auc:0.875704 ## [94] train-auc:0.876178 ## [95] train-auc:0.876789\rI make the final predictions based on the test.csv data. The predict function in R is great, it can take any model and make predictions, we just need to provide the testing data along with the model. I “ask” for probability scores from the predictions. I plot the density of predicted probabilities also.\n# Make the final predictions on the \u0026#39;test.csv\u0026#39; data and plot the probability density function.\rxgb.pred_final \u0026lt;- predict(xgb.model_final, dtest_final, type = \u0026#39;prob\u0026#39;)\rxgb.pred_final %\u0026gt;%\ras_tibble() %\u0026gt;%\rsetNames(c(\u0026quot;Prediction\u0026quot;)) %\u0026gt;%\rggplot(aes(x = Prediction)) + geom_density(color = \u0026quot;darkblue\u0026quot;, fill = \u0026quot;lightblue\u0026quot;) +\rgeom_vline(aes(xintercept = mean(Prediction)),\rcolor = \u0026quot;blue\u0026quot;, linetype = \u0026quot;dashed\u0026quot;, size = 1) +\rgeom_histogram(aes(y = ..density..), colour = \u0026quot;black\u0026quot;, fill = \u0026quot;white\u0026quot;, alpha = 0.1, position = \u0026quot;identity\u0026quot;) +\rggtitle(\u0026quot;(Out of sample) - Predicted probability density plot\u0026quot;) +\rtheme_tq()\r\r\rFinally! I make the submission file based on the predicted probabilities.\r# Convert the probabilities into a binary class of 0 or 1 by a decision threshold of 0.465.\r# Write the predictions to \u0026quot;submission.csv\u0026quot;\rxgb.pred_final %\u0026gt;%\ras_tibble() %\u0026gt;%\rsetNames(c(\u0026quot;Prediction\u0026quot;)) %\u0026gt;%\rsummarise(mean = mean(Prediction))\r## # A tibble: 1 x 1\r## mean\r## \u0026lt;dbl\u0026gt;\r## 1 0.465\rxgb.pred_final %\u0026gt;%\ras_tibble() %\u0026gt;%\rsetNames(c(\u0026quot;Prediction\u0026quot;)) %\u0026gt;%\rmutate(pred = case_when(\rPrediction \u0026gt; 0.465 ~ 1,\rPrediction \u0026lt;= 0.465 ~ 0\r)) %\u0026gt;%\rwrite.csv(\u0026quot;submission.csv\u0026quot;)\rI make the final remark in the Jupyter Notebook I sent as part of the interview process\nQuote::\rFinal footnote: Hopefully the out-of-sample predictions will obtain a 67% accuracy (the predictions in the “submission.csv” file).\nI was told after I sent my scores as part of the interview process how the scores were evaluated (In Spanish):\n*Para que sepas cómo es la valoración:\nObtener entre 0.4-0.6 se considera un resultado aleatorio.\nA partir 0.6 el algoritmo clasifica correctamente y más de un 0.7 el algoritmo es genial.\nPor debajo de 0.4 son capaces de diferenciar series sintéticas de las reales, pero están intercambiadas.*\nI was informed that based on the held out test set I obtained a result of 0.649636 ~0.65% (a little lower than my 0.67% in-sample training set!) but still consistent with the correct methodology I was using (i.e. no leaking test data to the training data) along with the fact that I was just throwing the time series features book/kitchen sink at the problem. Further reading into time series features will strengthen this classification problem and will certainly improve the prediction accuracy! Recall, that my feature selection consisted of applying every feature in the tsfeatures package… Using functions \u0026lt;- ls(\"package:tsfeatures\")[1:42] and then mapping over the data using summarise(Statistics = map(data, ~ data.frame( bind_cols(tsfeatures(.x$value, functions))))) %\u0026gt;%. So there is plenty of improvements to the current model.\nConclusion: A combination of time series feature selection and classifciation models can do pretty well on time series classification models such as this one I faced.\nAny errors are my own!\n\r\r","date":1572739200,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1572739200,"objectID":"da93c9229b29ae9edd520b798a0c9a6f","permalink":"/post/synth-real-time-series/financial-time-series/","publishdate":"2019-11-03T00:00:00Z","relpermalink":"/post/synth-real-time-series/financial-time-series/","section":"post","summary":"I analyse the difference between two time series and obtain a 67% accuracy (on anonymous data)","tags":["asset pricing","xgboost","time series","synthetic data"],"title":"Time Series Classification Synthetic vs Real Financial Time Series","type":"post"},{"authors":null,"categories":["Trading"],"content":"\r\rLoad packages:\nlibrary(knitr)\rlibrary(kableExtra)\rlibrary(dplyr)\rlibrary(ggplot2)\rlibrary(quantstrat)\r::: Note ::: This post is mostly for my future reference/documentation for learning the quantstrat package. An example of a strategy I developed can be found below in which it uses a naive rolling logistic regression model trained on t days to predict t+1 market movement. ::: END Note :::\nI have been playing around with backtesting trading models using the quantstrat package for a while but the most difficult thing about it was understanding the syntax of blotter and quantstrat, it didn’t seem very intuitive to me at first and there does not seem to be much detailed information online, despite the package being around since 2010. In this post I will give my comments and observations what certain functions do, I will update this post over time.\nBackgorund\rThe quantstrat package is built on the blotter package which was developed in 2008. It works best with time series xts objects which can be easily collected using the quantmod package. The blotter package is the accounting package behind the quantstrat system, it can support multiple accounts or multiple portfolios and computes the P\u0026amp;L of trading systems.\nThe main blotter functions are the following:\n\rInitialisation\r\rinitPortf - which initialises a portfolio\rinitAcct - which initialises an account\r\r\rPerformance\r\raddTxn - which adds transactions to the portfolio\rupdatePortf - which computes the P\u0026amp;L for each symbol in a given period\rupdateAcct - which computes the equity from the assets\rupdateEndEq - which updates the final equity for an account\rgetEndEq - which provides us with the latest value of our account\rgetPosQty - which gets a position at a given date.\rchart.Posn- which plots a chart of the position size, and cumulative P\u0026amp;L\rPortfReturns- which calcualtes the portfolio returns\rgetAccount - which gets our account info!\rgetPortfolio - \"\"\rgetTxns - \"\"\rtradeStats - which collects trade statistics\rperTradeStats - which calculates per trade statistics\r\rThe blotter package loads in a number of additional packages as we can see by running the below.\nThe packages are: xts and zoo for time series, FinancialInstrument, quantmod, TTR, PerformanceAnalytics for finance, where TTR stands for Technical Trading Rules.\nThe blotter package creates a new environment .blotter.\n\rDownload Financial Data\rLets first download some data for the S\u0026amp;P500 from 2018 to 2019 in order to gather some data. For the quantstrat package its quite usual to find the initiation date, start date, end date set outside the parameters of the model. Therefore I first set these parameters as initDate, startDate and endDate.\ninitDate \u0026lt;- \u0026#39;2010-01-01\u0026#39; # this is used for later but is must be before the startDate\rstartDate \u0026lt;- \u0026#39;2018-01-01\u0026#39;\rendDate \u0026lt;- \u0026#39;2019-01-01\u0026#39;\rsymbols \u0026lt;- c(\u0026#39;SPY\u0026#39;)\rgetSymbols(symbols, from = startDate, to = endDate, src = \u0026quot;yahoo\u0026quot;, adjust=TRUE) \r## [1] \u0026quot;SPY\u0026quot;\rTable 1: SPY stocks\r\r\r\r\rSPY.Open\r\rSPY.High\r\rSPY.Low\r\rSPY.Close\r\rSPY.Volume\r\rSPY.Adjusted\r\r\r\r\r\r2018-01-02\r\r262.8473\r\r263.7992\r\r262.4155\r\r263.7599\r\r86655700\r\r260.1310\r\r\r\r2018-01-03\r\r263.9464\r\r265.5951\r\r263.9464\r\r265.4283\r\r90070400\r\r261.7763\r\r\r\r2018-01-04\r\r266.1447\r\r267.0868\r\r265.4970\r\r266.5470\r\r80636400\r\r262.8796\r\r\r\r2018-01-05\r\r267.4302\r\r268.4606\r\r266.8807\r\r268.3233\r\r83524000\r\r264.6314\r\r\r\r2018-01-08\r\r268.2153\r\r268.9906\r\r267.8915\r\r268.8140\r\r57319200\r\r265.1154\r\r\r\r2018-01-09\r\r269.2850\r\r270.1191\r\r268.9709\r\r269.4224\r\r57254000\r\r265.7154\r\r\r\r\r\rPlot the data\rchartSeries(SPY, name = \u0026quot;Daily time series for SPY\u0026quot;, type = \u0026quot;candlesticks\u0026quot;, theme = chartTheme(\u0026quot;white\u0026quot;))\rOnce we have the data and after loading the blotter package we must define a few initialisation parameters, namely the currency() and stocks parameter from the FinancialInstrument package.\ncurrency(\u0026quot;USD\u0026quot;)\r## [1] \u0026quot;USD\u0026quot;\rstock(\u0026quot;SPY\u0026quot;, currency = \u0026quot;USD\u0026quot;, multiplier = 1)\r## [1] \u0026quot;SPY\u0026quot;\rls(all = TRUE)\r## [1] \u0026quot;.blotter\u0026quot; \u0026quot;.getSymbols\u0026quot; \u0026quot;.Random.seed\u0026quot; \u0026quot;.strategy\u0026quot; ## [5] \u0026quot;endDate\u0026quot; \u0026quot;initDate\u0026quot; \u0026quot;SPY\u0026quot; \u0026quot;startDate\u0026quot; ## [9] \u0026quot;symbols\u0026quot;\rls(envir = FinancialInstrument:::.instrument)\r## [1] \u0026quot;SPY\u0026quot; \u0026quot;USD\u0026quot;\rWe can see that we have the SPY index and the USD currency set. We can convert the data from daily time series to monthly time series using the to.period fucntion.\nSPY_monthly \u0026lt;- to.period(SPY, period = \u0026quot;months\u0026quot;)\rchartSeries(SPY_monthly, name = \u0026quot;Monthly time series for SPY\u0026quot;, type = \u0026quot;candlesticks\u0026quot;, theme = chartTheme(\u0026quot;white\u0026quot;))\rhead(SPY_monthly)\r## SPY.Open SPY.High SPY.Low SPY.Close SPY.Volume SPY.Adjusted\r## 2018-01-31 262.8473 281.2870 262.4155 276.6452 1985506700 272.8389\r## 2018-02-28 275.8307 277.7836 248.2054 266.5862 2923722000 262.9184\r## 2018-03-29 266.3507 275.1830 254.0372 259.2790 2323561800 255.7117\r## 2018-04-30 258.6878 267.3091 250.9237 260.6190 1998466500 257.0332\r## 2018-05-31 259.9884 270.2157 255.2393 266.9544 1606397200 263.2814\r## 2018-06-29 268.4028 275.3688 265.7283 268.4896 1599001000 264.7955\r\rPortfolio parameters\rNow that we have our data we should initialise the portfolio with initPortf, which will consist of the transactions over the period of analysis.\n\rname - “MyFirstPortfolio” - the initial name of the portfolio\rsymbols - “SPY” - since we are using the SPY500\rinitPosQty - 100 - the initial quantity of our position\rinitDate - “initDate” - the initial account equity and position (prior to the closing price of our first position)\rcurrency the currency we are using\r\rinitDate \u0026lt;- \u0026#39;2010-01-01\u0026#39; # NOTE: We already created this parameter --\u0026gt; which was quoted as \u0026quot;this is used for later but is must be before the startDate\u0026quot;\rinitPortf(\u0026quot;MyFirstPortfolio\u0026quot;, \u0026quot;SPY\u0026quot;, initDate = initDate)\r## [1] \u0026quot;MyFirstPortfolio\u0026quot;\r\rAccount parameters\rWe also need to initialise the account using initAcct\n\rname - “MyFirstPortfolio” - the initial name of the portfolio\rportfolios - the name of our previous portfolio created\rinitDate - “initDate” - the initial account equity and position (prior to the closing price of our first position)\rinitEq - the initial equity we began with\rcurrency the currency we are using\r\rinitEq = 1000000\rinitAcct(\u0026quot;MyFirstPortfolio\u0026quot;, portfolios = \u0026quot;MyFirstPortfolio\u0026quot;, initDate = initDate, initEQ = initEq)\r## [1] \u0026quot;MyFirstPortfolio\u0026quot;\rfirst(SPY) # print the first observation in our data\r## SPY.Open SPY.High SPY.Low SPY.Close SPY.Volume SPY.Adjusted\r## 2018-01-02 262.8473 263.7992 262.4155 263.7599 86655700 260.131\rlast(SPY) # print the last observation in our data\r## SPY.Open SPY.High SPY.Low SPY.Close SPY.Volume SPY.Adjusted\r## 2018-12-31 249.56 250.19 247.47 249.92 144299400 246.4814\r\rA simple Strategy\rA trading strategy can be broken down into the following blocks:\n\rAssets - which are the stocks we want to trade, SPY, MSFT, AAPL, MSFT etc.\rIndicators - which are the variables, Open, High, Low, Close, SMA, EMA, RSI, Momentum etc.\rSignals - we can create signals based on the interaction between the indicators and the time-series data.\rRules - Create buy and sell rules based on the signals created.\rOrders - Once a rule is activated, push an order through.\rAnalysis - Analyse the performance of the strategy.\r\rI wanted to test a basic backtesting concept. What happens if I trained a machine learning model each day on the last 100 days of data to predict the next days stock market direction but test this over many periods?. That is to continuously train a machine learning model at every step to predict the next price. One method is to use the rolling_origin fucntion from the rsample package but I write a more simple function for this.\nI load in the parameters of the model and download data for MSFT.\nlibrary(quantstrat)\rlibrary(PerformanceAnalytics)\rlibrary(e1071)\rinitDate = \u0026quot;2010-01-01\u0026quot;\rfrom \u0026lt;- \u0026quot;2018-01-01\u0026quot;\rto \u0026lt;- \u0026quot;2019-09-20\u0026quot;\rinit_equity \u0026lt;- 1000\radjustment \u0026lt;- TRUE\r.orderqty \u0026lt;- 10 # The profitability of the strategy depends heavily on this value\r.txnfees \u0026lt;- -10\r.stoploss \u0026lt;- 3e-3 # 0.003 or 0.3%\rcurrency(\u0026#39;USD\u0026#39;)\r## [1] \u0026quot;USD\u0026quot;\rSys.setenv(TZ=\u0026quot;UTC\u0026quot;)\rsymbols \u0026lt;- c(\u0026#39;MSFT\u0026#39;)\rgetSymbols(symbols, from = from, to = to, src = \u0026quot;yahoo\u0026quot;, adjust = TRUE) \r## [1] \u0026quot;MSFT\u0026quot;\rI created a simple time series pre-processing function to clean up the data, create some features and set the data to xts. Ignore the Scale_Me function.\nScale_Me \u0026lt;- function(x){\r(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)\r}\rTS_preprocess \u0026lt;- function(dat){\rdat = data.frame(dat)\rcolnames(dat) = c(\u0026quot;open\u0026quot;, \u0026quot;high\u0026quot;, \u0026quot;low\u0026quot;, \u0026quot;close\u0026quot;, \u0026quot;volume\u0026quot;, \u0026quot;adjusted\u0026quot;)\rdat$Y = with(dat, ifelse(close \u0026gt;= open, 1, 0))\rdat$X1 = SMA(lag(dat$close), n = 10)\rdat$X2 = RSI(lag(dat$close), nFast = 14, nSlow = 26, nSig = 9, maType = SMA)\rdat$X3 = momentum(lag(dat$close), n = 12)\rdat = dat[complete.cases(dat), ]\r#dat = cbind(dat[, \u0026#39;Y\u0026#39;], apply(dat[, 8:ncol(dat)], 2, Scale_Me))\r#colnames(dat)[1] = \u0026quot;Y\u0026quot; dat = dat[, c(\u0026quot;Y\u0026quot;, \u0026quot;X1\u0026quot;, \u0026quot;X2\u0026quot;, \u0026quot;X3\u0026quot;)]\rdat = as.xts(dat)\rreturn(dat)\r}\rI next set the training period n_train = 100 periods and n_test = 1 period, or train on t days of data and test of t+1 days of data. This can be quite computationally expensive depending on the machine learning model you input but for a simple binary logistic regression classifier its relatively fast. I create the logistic function which returns the predicted probabilities.\nThe RollingBacktest function, runs the model on n_train periods of data and makes a prediction on n_test. That is, say we have 1000 days of data, the model will train on the first 100 days and predict on day 101, then retrain on days 2 to 101 days and predict on day 102 and so on, continuing until all 1000 days have passed.\ndf \u0026lt;- TS_preprocess(MSFT)\rn_train \u0026lt;- 100\rn_test \u0026lt;- 1\rLogistFun \u0026lt;- function(frm, dat, trainIndex, testIndex){\rLogitModel \u0026lt;- glm(frm, data = dat[trainIndex, ])\rpred \u0026lt;- predict(LogitModel, newdata = dat[testIndex, ], type = \u0026#39;response\u0026#39;)\rreturn(pred)\r}\rRollingBacktest \u0026lt;- function(dat, ntrain = n_train, ntest = n_test){\rstopifnot(\u0026#39;Y\u0026#39; %in% names(dat))\rfrm_ \u0026lt;- formula(reformulate(paste0(\u0026quot;X\u0026quot;, seq(2:ncol(dat))), \u0026quot;Y\u0026quot;))\rstride \u0026lt;- ntrain + ntest\rstartPosn \u0026lt;- seq(1, dim(dat)[1] - stride)\rtrain_index_list \u0026lt;- lapply(startPosn, function(i) seq(i, i + ntrain))\rtest_index_list \u0026lt;- lapply(startPosn, function(i) seq((i + ntrain + 1), (i + ntrain + ntest))) mapply(LogistFun, trainIndex = train_index_list, testIndex = test_index_list, MoreArgs = list(frm = frm_, dat = dat), SIMPLIFY = FALSE\r)\r}\rNow that I have the pre-process function, the logistic function and the backtest function, we can run the model through the TS_postprocess function, which applies everything.\nTS_postprocess \u0026lt;- function(dat, ntrain){\rresults = tail(dat, -(ntrain + 1))\rresults$probs \u0026lt;- RollingBacktest(dat)\rresults$predictions \u0026lt;- ifelse(results$probs \u0026gt; 0.6, 1, 0)\rprint(paste0(\u0026quot;Model Accuracy at the 0.60 prob cut-off \u0026quot;, mean(results$Y == results$predictions)))\rreturn(results)\r}\rout \u0026lt;- TS_postprocess(df, ntrain = n_train)\r## [1] \u0026quot;Model Accuracy at the 0.60 prob cut-off 0.518987341772152\u0026quot;\rout \u0026lt;- na.omit(cbind(MSFT, out))\rThe model is not very accurate…\nThe na.omit removes the NA values which were created from the SMA, RSI and momentum calculations which are the first few observations of the time series data.\nThe data looks like:\nout %\u0026gt;%\rhead() %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rMSFT.Open\r\rMSFT.High\r\rMSFT.Low\r\rMSFT.Close\r\rMSFT.Volume\r\rMSFT.Adjusted\r\rY\r\rX1\r\rX2\r\rX3\r\rprobs\r\rpredictions\r\r\r\r\r\r97.73225\r\r99.05627\r\r97.58513\r\r98.91896\r\r28653100\r\r98.91896\r\r1\r\r99.33186\r\r63.01370\r\r1.98113024\r\r0.6709360\r\r1\r\r\r\r99.41915\r\r100.54701\r\r99.17396\r\r99.90953\r\r26180800\r\r99.90952\r\r1\r\r99.20142\r\r59.54048\r\r0.06865286\r\r0.7426882\r\r1\r\r\r\r100.11548\r\r100.48817\r\r98.93857\r\r99.19357\r\r23198200\r\r99.19357\r\r0\r\r99.14061\r\r63.88638\r\r0.19615593\r\r0.7523711\r\r1\r\r\r\r98.47763\r\r98.83069\r\r97.71263\r\r98.47763\r\r38923100\r\r98.47763\r\r1\r\r99.16611\r\r51.80598\r\r-1.02979581\r\r0.7586200\r\r1\r\r\r\r98.07551\r\r98.18340\r\r95.42748\r\r96.49649\r\r35433300\r\r96.49649\r\r0\r\r99.04646\r\r43.39626\r\r-2.03996476\r\r0.7851164\r\r1\r\r\r\r96.91822\r\r98.15397\r\r96.84957\r\r97.17322\r\r26897200\r\r97.17323\r\r1\r\r98.78558\r\r32.78984\r\r-2.44207828\r\r0.6282847\r\r1\r\r\r\r\rWe can see that the model outputs predicted probabilities, I simply set the predictions column to give a 1 if the models predicted probability is \u0026gt; 0.5 or a 0 if it is \u0026lt; 0.5. The Y variable is the observed and the X1, X2 and X3 variables are the SMA, RSI and momentum.\nWe can now use the quantstrat package to backtest the model and see how the performance went.\nMSFT \u0026lt;- out\rstock(\u0026quot;MSFT\u0026quot;, currency = \u0026quot;USD\u0026quot;, multiplier = 1)\r## [1] \u0026quot;MSFT\u0026quot;\rstrategy.st \u0026lt;- portfolio.st \u0026lt;- account.st \u0026lt;- \u0026quot;RollingLogitStrategy\u0026quot;\rrm.strat(strategy.st)\rrm.strat(portfolio.st)\rrm.strat(account.st)\rinitPortf(name = portfolio.st,\rsymbols = symbols,\rinitDate = initDate,\rcurrency = \u0026#39;USD\u0026#39;)\r## [1] \u0026quot;RollingLogitStrategy\u0026quot;\rinitAcct(name = account.st,\rportfolios = portfolio.st,\rinitDate = initDate,\rcurrency = \u0026#39;USD\u0026#39;,\rinitEq = init_equity)\r## [1] \u0026quot;RollingLogitStrategy\u0026quot;\rinitOrders(portfolio.st,\rsymbols = symbols,\rinitDate = initDate)\rstrategy(strategy.st, store = TRUE)\rI add the signals to the strategy and give it some rules.\n\r1a)\r\rThe signal is that the first time the Logistic model produces a probability greater than 0.6 then assign the signal. The sigThreshold is a quantstrat function, the others are sigComparison, sigCrossover and sigFormula. It calls upon the threshold value in the list of arguments, the column it looks for is the probs column which the predicted probabilities are output to, gt means greater than. It basically creates a new column called logSig and it would be similar to ifelse(df$probs \u0026gt; 0.6, 1, 0) as far as I understand.\n\r1b)\rThe rule for the strategy is to take sigcol which is the label we gave our signal in the previous lines which is called longSig. If longSig = 1, execute a market order going long, buying at the next days open price, the transaction fees were set at the start of the strategy. We call this rule, EnterLONG.\r\rnMult_orderqty \u0026lt;- 2\raddPosLimit(portfolio.st, symbol = \u0026quot;MSFT\u0026quot;, timestamp = initDate, maxpos = nMult_orderqty * .orderqty)\r# Objective: Buy when the probability is gt 0.60, using cross = TRUE\r# 1.a)\radd.signal(strategy = strategy.st,\rname = \u0026quot;sigThreshold\u0026quot;,\rarguments = list(threshold = 0.6,\rcolumn = \u0026quot;probs\u0026quot;,\rrelationship = \u0026quot;gt\u0026quot;,\rcross = TRUE),\rlabel = \u0026quot;longSig\u0026quot;)\r## [1] \u0026quot;RollingLogitStrategy\u0026quot;\r# 1.b)\r# # Adding the rules, enter at the open price when prob \u0026gt; 0.60 for the first time, taking transaction fees into account\radd.rule(strategy = strategy.st,\rname = \u0026quot;ruleSignal\u0026quot;,\rarguments = list(sigcol = \u0026quot;longSig\u0026quot;, # check the ifelse predictions statement\rsigval = 1,\rorderqty = .orderqty,\rordertype = \u0026quot;market\u0026quot;,\rorderside = \u0026quot;long\u0026quot;,\rosFUN = osMaxPos,\rprefer = \u0026quot;Open\u0026quot;,\rreplace = TRUE,\rTxnFees = .txnfees),\rtype = \u0026quot;enter\u0026quot;,\rlabel = \u0026quot;EnterLONG\u0026quot;)\r## [1] \u0026quot;RollingLogitStrategy\u0026quot;\rFrom the Logistic model we have added our signal to buy when the probability of the next days price is greater than 0.60. So far we just keep buying when the probability of the logistic model passes over 0.60 but we have no position to sell when the model predicts something different.\nI thought it might be interesting to exit the strategy when the model is undecided or makes a very low predicted probability. I set this threshold to be less than 0.4 based on the probability density plot below. So we are making trades at the tail ends of the distribution, buying when the model is confident and selling when it is unsure.\nplot(density(out$probs))\rAdd the signals and rules for exiting the strategy. Using a similar principle as before, I create a signal when the probability is less than 0.4 and call it exitlongSig.\n\rCareful here when setting type = \"exit\" and orderside = \"long\". Previously had it set to type = exit and orderside = short! which is completely wrong.\r\r# 2.a) # create the signal of when we should be looking to exit\r# #exit when prob drops below 0.4 for the first time\radd.signal(strategy = strategy.st,\rname = \u0026quot;sigThreshold\u0026quot;,\rarguments = list(threshold = 0.4,\rcolumn = \u0026quot;probs\u0026quot;,\rrelationship = \u0026quot;lt\u0026quot;,\rcross = TRUE),\rlabel = \u0026quot;exitlongSig\u0026quot;)\r## [1] \u0026quot;RollingLogitStrategy\u0026quot;\r# 2.b) # Add that signal to the rule of exiting\radd.rule(strategy.st,\rname = \u0026quot;ruleSignal\u0026quot;,\rarguments = list(sigcol = \u0026quot;exitlongSig\u0026quot;,\rsigval = 1,\rorderqty = \u0026quot;all\u0026quot;,\rordertype = \u0026quot;market\u0026quot;,\rorderside = \u0026quot;long\u0026quot;,\rosFUN = osMaxPos,\rprefer = \u0026quot;Open\u0026quot;,\rreplace = TRUE,\rTxnFees = .txnfees),\rtype = \u0026quot;exit\u0026quot;,\rlabel = \u0026quot;ExitLong\u0026quot;)\r## [1] \u0026quot;RollingLogitStrategy\u0026quot;\rWe can finally apply the strategy and see how it performs. It doesn’t make many transactions due to the backtesting being quite restrictive.\napplyStrategy(strategy.st, portfolios = portfolio.st)\r## [1] \u0026quot;2018-07-05 00:00:00 MSFT 10 @ 97.5851340312762\u0026quot;\r## [1] \u0026quot;2018-07-11 00:00:00 MSFT 10 @ 99.2033819340086\u0026quot;\r## [1] \u0026quot;2018-12-06 00:00:00 MSFT -20 @ 104.632969498356\u0026quot;\r## [1] \u0026quot;2018-12-19 00:00:00 MSFT 10 @ 102.487313341245\u0026quot;\r## [1] \u0026quot;2019-01-09 00:00:00 MSFT 10 @ 102.694956688076\u0026quot;\r## [1] \u0026quot;2019-02-21 00:00:00 MSFT -20 @ 106.15227613615\u0026quot;\r## [1] \u0026quot;2019-04-11 00:00:00 MSFT 10 @ 119.69686840234\u0026quot;\r## [1] \u0026quot;2019-04-24 00:00:00 MSFT 10 @ 124.91014659961\u0026quot;\r## [1] \u0026quot;2019-06-13 00:00:00 MSFT -20 @ 131.541967172209\u0026quot;\r## [1] \u0026quot;2019-06-27 00:00:00 MSFT 10 @ 133.694801331394\u0026quot;\r## [1] \u0026quot;2019-07-09 00:00:00 MSFT 10 @ 135.548629168169\u0026quot;\r## [1] \u0026quot;2019-08-23 00:00:00 MSFT -20 @ 137.190002\u0026quot;\r## [1] \u0026quot;2019-08-28 00:00:00 MSFT 10 @ 134.880005\u0026quot;\r## [1] \u0026quot;2019-09-05 00:00:00 MSFT -10 @ 139.110001\u0026quot;\rupdatePortf(portfolio.st)\r## [1] \u0026quot;RollingLogitStrategy\u0026quot;\rupdateAcct(account.st)\r## [1] \u0026quot;RollingLogitStrategy\u0026quot;\rupdateEndEq(account.st)\r## [1] \u0026quot;RollingLogitStrategy\u0026quot;\rchart.Posn(portfolio.st, Symbol = \u0026quot;MSFT\u0026quot;)\r #TA=\u0026quot;add_SMA(n = 10, col = 2); add_SMA(n = 30, col = 4)\u0026quot;)\rLook at the mktdata which is where our signals and predictions are stored.\nmktdata %\u0026gt;%\rdata.frame() %\u0026gt;%\rhead(10) %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\r\rMSFT.Open\r\rMSFT.High\r\rMSFT.Low\r\rMSFT.Close\r\rMSFT.Volume\r\rMSFT.Adjusted\r\rY\r\rX1\r\rX2\r\rX3\r\rprobs\r\rpredictions\r\rlongSig\r\rexitlongSig\r\r\r\r\r\r2018-06-19\r\r97.73225\r\r99.05627\r\r97.58513\r\r98.91896\r\r28653100\r\r98.91896\r\r1\r\r99.33186\r\r63.01370\r\r1.9811302\r\r0.6709360\r\r1\r\rNA\r\rNA\r\r\r\r2018-06-20\r\r99.41915\r\r100.54701\r\r99.17396\r\r99.90953\r\r26180800\r\r99.90952\r\r1\r\r99.20142\r\r59.54048\r\r0.0686529\r\r0.7426882\r\r1\r\r0\r\r0\r\r\r\r2018-06-21\r\r100.11548\r\r100.48817\r\r98.93857\r\r99.19357\r\r23198200\r\r99.19357\r\r0\r\r99.14061\r\r63.88638\r\r0.1961559\r\r0.7523711\r\r1\r\r0\r\r0\r\r\r\r2018-06-22\r\r98.47763\r\r98.83069\r\r97.71263\r\r98.47763\r\r38923100\r\r98.47763\r\r1\r\r99.16611\r\r51.80598\r\r-1.0297958\r\r0.7586200\r\r1\r\r0\r\r0\r\r\r\r2018-06-25\r\r98.07551\r\r98.18340\r\r95.42748\r\r96.49649\r\r35433300\r\r96.49649\r\r0\r\r99.04646\r\r43.39626\r\r-2.0399648\r\r0.7851164\r\r1\r\r0\r\r0\r\r\r\r2018-06-26\r\r96.91822\r\r98.15397\r\r96.84957\r\r97.17322\r\r26897200\r\r97.17323\r\r1\r\r98.78558\r\r32.78984\r\r-2.4420783\r\r0.6282847\r\r1\r\r0\r\r0\r\r\r\r2018-06-27\r\r97.66360\r\r98.09512\r\r95.52555\r\r95.66285\r\r31298400\r\r95.66285\r\r0\r\r98.56687\r\r35.08314\r\r-2.5009206\r\r0.7361390\r\r1\r\r0\r\r0\r\r\r\r2018-06-28\r\r95.50593\r\r97.20264\r\r95.38824\r\r96.73187\r\r26650700\r\r96.73187\r\r1\r\r98.24224\r\r35.29932\r\r-3.4424524\r\r0.6387378\r\r1\r\r0\r\r0\r\r\r\r2018-06-29\r\r97.02610\r\r97.98725\r\r96.43765\r\r96.71226\r\r28053200\r\r96.71226\r\r0\r\r97.96861\r\r37.17949\r\r-2.6284247\r\r0.6327528\r\r1\r\r0\r\r0\r\r\r\r2018-07-02\r\r96.21207\r\r98.13435\r\r96.11400\r\r98.08532\r\r19564500\r\r98.08531\r\r1\r\r97.81954\r\r39.04847\r\r-2.1968885\r\r0.5659825\r\r0\r\r0\r\r0\r\r\r\r\rSo if we trained a simple logistic model on 100 days of data to give us the next days prediction everyday since June 2018 and only invest if the logistic models prediction is greater than 0.60 and only sell if the logistic models prediction is less than 0.40 then out cumulative P\u0026amp;L would be $334 with a max drawdown of $61.\nI have probably (almost certainly) gone wrong at somepoint using the quantstrat package so the results will probably not generalise well to other assets, especially using a logistic model with 3 regressors! But it was a fun exercise using the quantstrat package.\nI will revist and modify this markdown file.\n\r","date":1569715200,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1569715200,"objectID":"45851fe316f0807f4675db63d5389cff","permalink":"/post/quantstrat-rolling-logistic/quantstrat/","publishdate":"2019-09-29T00:00:00Z","relpermalink":"/post/quantstrat-rolling-logistic/quantstrat/","section":"post","summary":"I generate a rolling logistic backtesting function which outputs predicted probabilities, based on these probabilities I construct investment criteria and test whether positive returns can be made (lots of work still to do)","tags":["trading","finance","yahoo finance","quantstrat","technical analysis","backtesting"],"title":"Learning the Quantstrat and Blotter packages","type":"post"},{"authors":null,"categories":["Finance"],"content":"\r\rCorporate Finance and Managerial Finance\rI created a script to download any company from Yahoo Finance and compute the DuPont, Need for Funds and Working Capital based on companies fundamentals and plot these for each company. I suggest you first watch these two short videos from IESE Business School - part 1 here and part 2 here.\nFirstly load in some packages:\nlibrary(knitr)\rlibrary(kableExtra)\rlibrary(tidyquant)\rlibrary(quantmod)\rlibrary(tibble)\rlibrary(tidyr)\rlibrary(reshape2)\rlibrary(ggplot2)\rlibrary(rvest)\rI first define the function to scrape Yahoo Finance and collect the Balance Sheet, Income Statement and Cash Flows (it looks complicated but it works):\ngetFin \u0026lt;- function(stock){\rfor (i in 1:length(stock)) {\rtryCatch(\r{\r# Collect the Income Statement data\rlink \u0026lt;- \u0026quot;https://finance.yahoo.com/quote/\u0026quot;\rlink \u0026lt;- paste0(link, stock[i], \u0026quot;/financials?p=\u0026quot;, stock[i])\rwahis.session \u0026lt;- html_session(link)\rp \u0026lt;- wahis.session %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;Col1-1-Financials-Proxy\u0026quot;]/section/div[3]/table\u0026#39;)%\u0026gt;%\rhtml_table(fill = TRUE)\rIncomeStatement \u0026lt;- p[[1]]\rcolnames(IncomeStatement) \u0026lt;- paste(IncomeStatement[1,])\rIncomeStatement \u0026lt;- IncomeStatement[-c(1,5,12,20,25),]\rnames_row \u0026lt;- paste(IncomeStatement[,1])\rIncomeStatement \u0026lt;- IncomeStatement[,-1]\rIncomeStatement \u0026lt;- apply(IncomeStatement, 2, function(x){gsub(\u0026quot;,\u0026quot;,\u0026quot;\u0026quot;,x)})\rIncomeStatement \u0026lt;- as.data.frame(apply(IncomeStatement, 2, as.numeric))\rrownames(IncomeStatement) \u0026lt;- paste(names_row)\rtemp1 \u0026lt;- IncomeStatement\r# Collect the Balance Sheet data\rlink \u0026lt;- \u0026quot;https://finance.yahoo.com/quote/\u0026quot;\rlink \u0026lt;- paste0(link, stock[i],\u0026quot;/balance-sheet?p=\u0026quot;, stock[i])\rwahis.session \u0026lt;- html_session(link)\rp \u0026lt;- wahis.session %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;Col1-1-Financials-Proxy\u0026quot;]/section/div[3]/table\u0026#39;)%\u0026gt;%\rhtml_table(fill = TRUE)\rBalanceSheet \u0026lt;- p[[1]]\rcolnames(BalanceSheet) \u0026lt;- BalanceSheet[1,]\rBalanceSheet \u0026lt;- BalanceSheet[-c(1,2,17,28),]\rnames_row \u0026lt;- BalanceSheet[,1]\rBalanceSheet \u0026lt;- BalanceSheet[,-1]\rBalanceSheet \u0026lt;- apply(BalanceSheet, 2, function(x){gsub(\u0026quot;,\u0026quot;,\u0026quot;\u0026quot;,x)})\rBalanceSheet \u0026lt;- as.data.frame(apply(BalanceSheet, 2, as.numeric))\rrownames(BalanceSheet) \u0026lt;- paste(names_row)\rtemp2 \u0026lt;- BalanceSheet\r# Collect the Cash Flow data\rlink \u0026lt;- \u0026quot;https://finance.yahoo.com/quote/\u0026quot;\rlink \u0026lt;- paste0(link, stock[i], \u0026quot;/cash-flow?p=\u0026quot;, stock[i])\rwahis.session \u0026lt;- html_session(link)\rp \u0026lt;- wahis.session %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;Col1-1-Financials-Proxy\u0026quot;]/section/div[3]/table\u0026#39;)%\u0026gt;%\rhtml_table(fill = TRUE)\rCashFlow \u0026lt;- p[[1]]\rcolnames(CashFlow) \u0026lt;- CashFlow[1,]\rCashFlow \u0026lt;- CashFlow[-c(1,3,11,16),]\rnames_row \u0026lt;- CashFlow[,1]\rCashFlow \u0026lt;- CashFlow[,-1]\rCashFlow \u0026lt;- apply(CashFlow, 2, function(x){gsub(\u0026quot;,\u0026quot;,\u0026quot;\u0026quot;,x)})\rCashFlow \u0026lt;- as.data.frame(apply(CashFlow, 2, as.numeric))\rrownames(CashFlow) \u0026lt;- paste(names_row)\rtemp3 \u0026lt;- CashFlow\rassign(paste0(stock[i],\u0026#39;.f\u0026#39;),value = list(IncomeStatement = temp1, BalanceSheet = temp2, CashFlow = temp3), envir = parent.frame())\r},\rerror = function(cond){\rmessage(stock[i], \u0026quot;Give error \u0026quot;,cond)\r}\r)\r}\r}\rNext I collect some tickers, I choose Ford, General Electric, International Business Machine and Unilever but feel free to add in more tickers - what ever financial data can be found on Yahoo Finance will work- just add to the symbols part of the code.\nsymbols \u0026lt;- c(\u0026quot;F\u0026quot;, \u0026quot;GE\u0026quot;, \u0026quot;IBM\u0026quot;, \u0026quot;UN\u0026quot;)\rgetFin(symbols)\rsymbols.f \u0026lt;- sapply(symbols, function(x) { paste0(x, \u0026quot;.f\u0026quot;) })\rtickers \u0026lt;- list2env(mget(symbols.f))\rIS \u0026lt;- lapply(tickers, \u0026quot;[[\u0026quot;, \u0026quot;IncomeStatement\u0026quot;)\rBS \u0026lt;- lapply(tickers, \u0026quot;[[\u0026quot;, \u0026quot;BalanceSheet\u0026quot;)\rCF \u0026lt;- lapply(tickers, \u0026quot;[[\u0026quot;, \u0026quot;CashFlow\u0026quot;)\rIS \u0026lt;- as.data.frame(IS)\rBS \u0026lt;- as.data.frame(BS)\rCF \u0026lt;- as.data.frame(CF)\rWhere IS is Income Statement, BS is Balance SheetandCF` is Cash Flow.\n\rHow the Income Statement looks:\rTable 1: Income Statement\r\r\r\r\rUN.f.12.31.2018\r\rUN.f.12.31.2017\r\rUN.f.12.31.2016\r\rUN.f.12.31.2015\r\rIBM.f.12.31.2018\r\rIBM.f.12.31.2017\r\rIBM.f.12.31.2016\r\rIBM.f.12.31.2015\r\rGE.f.12.31.2018\r\rGE.f.12.31.2017\r\rGE.f.12.31.2016\r\rGE.f.12.31.2015\r\rF.f.12.31.2018\r\rF.f.12.31.2017\r\rF.f.12.31.2016\r\rF.f.12.31.2015\r\r\r\r\r\rTotal Revenue\r\r50982000\r\r53715000\r\r52713000\r\r53272000\r\r79591000\r\r79139000\r\r79919000\r\r81741000\r\r121615000\r\r118243000\r\r119468000\r\r115834000\r\r160338000\r\r156776000\r\r151800000\r\r149558000\r\r\r\rCost of Revenue\r\r28769000\r\r30547000\r\r30229000\r\r30808000\r\r42655000\r\r42196000\r\r41402000\r\r41057000\r\r98396000\r\r106858000\r\r94886000\r\r90111000\r\r145459000\r\r140218000\r\r134933000\r\r131410000\r\r\r\rGross Profit\r\r22213000\r\r23168000\r\r22484000\r\r22464000\r\r36936000\r\r36943000\r\r38517000\r\r40684000\r\r23219000\r\r11385000\r\r24582000\r\r25723000\r\r14879000\r\r16558000\r\r16867000\r\r18148000\r\r\r\rResearch Development\r\r900000\r\r900000\r\r978000\r\r1005000\r\r5379000\r\r5590000\r\r5726000\r\r5247000\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rSelling General and Administrative\r\r8803000\r\r13507000\r\r13799000\r\r14065000\r\r20325000\r\r20900000\r\r20225000\r\r19589000\r\r15134000\r\r15389000\r\r14707000\r\r16327000\r\r10460000\r\r9676000\r\r12504000\r\r10097000\r\r\r\rNon Recurring\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rOthers\r\r41427000\r\r44031000\r\r44031000\r\r44031000\r\r-998000\r\r-1445000\r\r-1604000\r\r-669000\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rTotal Operating Expenses\r\r38472000\r\r44954000\r\r45006000\r\r45878000\r\r67361000\r\r67241000\r\r65749000\r\r65224000\r\r113530000\r\r122247000\r\r109593000\r\r106438000\r\r155919000\r\r149894000\r\r147437000\r\r141507000\r\r\r\rOperating Income or Loss\r\r12510000\r\r8761000\r\r7707000\r\r7394000\r\r12230000\r\r11898000\r\r14170000\r\r16517000\r\r8085000\r\r-4004000\r\r9875000\r\r9396000\r\r4419000\r\r6882000\r\r4363000\r\r8051000\r\r\r\rTotal Other Income/Expenses Net\r\r-127000\r\r-608000\r\r-238000\r\r-174000\r\r-888000\r\r-498000\r\r-1840000\r\r-572000\r\r-28220000\r\r-7147000\r\r-2843000\r\r-1211000\r\r-74000\r\r1277000\r\r2421000\r\r2201000\r\r\r\rEarnings Before Interest and Taxes\r\r12510000\r\r8761000\r\r7707000\r\r7394000\r\r12230000\r\r11898000\r\r14170000\r\r16517000\r\r8085000\r\r-4004000\r\r9875000\r\r9396000\r\r4419000\r\r6882000\r\r4363000\r\r8051000\r\r\r\rInterest Expense\r\r-627000\r\r-608000\r\r-572000\r\r-552000\r\r-723000\r\r-615000\r\r-630000\r\r-468000\r\r-2708000\r\r-2753000\r\r-2026000\r\r-1706000\r\r-1228000\r\r-1190000\r\r-951000\r\r-773000\r\r\r\rIncome Before Tax\r\r12383000\r\r8153000\r\r7469000\r\r7220000\r\r11342000\r\r11400000\r\r12330000\r\r15945000\r\r-20135000\r\r-11151000\r\r7032000\r\r8185000\r\r4345000\r\r8159000\r\r6784000\r\r10252000\r\r\r\rIncome Tax Expense\r\r2575000\r\r1667000\r\r1922000\r\r1961000\r\r2619000\r\r5642000\r\r449000\r\r2581000\r\r583000\r\r-2611000\r\r-1133000\r\r6485000\r\r650000\r\r402000\r\r2184000\r\r2881000\r\r\r\rMinority Interest\r\r720000\r\r758000\r\r626000\r\r643000\r\r134000\r\r131000\r\r146000\r\r162000\r\r20882000\r\r20859000\r\r4688000\r\r4836000\r\r134000\r\r126000\r\r113000\r\r109000\r\r\r\rNet Income From Continuing Ops\r\r9808000\r\r6486000\r\r5547000\r\r5259000\r\r8723000\r\r5758000\r\r11881000\r\r13364000\r\r-20718000\r\r-8540000\r\r8165000\r\r1700000\r\r3695000\r\r7757000\r\r4600000\r\r7371000\r\r\r\rDiscontinued Operations\r\rNA\r\rNA\r\rNA\r\rNA\r\r5000\r\r-5000\r\r-9000\r\r-174000\r\r-1726000\r\r-309000\r\r-954000\r\r-7807000\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rExtraordinary Items\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rEffect Of Accounting Changes\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rOther Items\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Income\r\r9389000\r\r6053000\r\r5184000\r\r4909000\r\r8728000\r\r5753000\r\r11872000\r\r13190000\r\r-22355000\r\r-8484000\r\r7500000\r\r-6126000\r\r3677000\r\r7731000\r\r4589000\r\r7373000\r\r\r\rPreferred Stock And Other Adjustments\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Income Applicable To Common Shares\r\r9389000\r\r6053000\r\r5184000\r\r4909000\r\r8728000\r\r5753000\r\r11872000\r\r13190000\r\r-22809000\r\r-8944000\r\r6829000\r\r-6135000\r\r3677000\r\r7731000\r\r4589000\r\r7373000\r\r\r\r\r\rHow the Balance Sheet looks:\rTable 2: Balance Sheet\r\r\r\r\rUN.f.12.31.2018\r\rUN.f.12.31.2017\r\rUN.f.12.31.2016\r\rUN.f.12.31.2015\r\rIBM.f.12.31.2018\r\rIBM.f.12.31.2017\r\rIBM.f.12.31.2016\r\rIBM.f.12.31.2015\r\rGE.f.12.31.2018\r\rGE.f.12.31.2017\r\rGE.f.12.31.2016\r\rGE.f.12.31.2015\r\rF.f.12.31.2018\r\rF.f.12.31.2017\r\rF.f.12.31.2016\r\rF.f.12.31.2015\r\r\r\r\r\rCash And Cash Equivalents\r\r3230000\r\r3317000\r\r3382000\r\r2302000\r\r11379000\r\r11972000\r\r7826000\r\r7686000\r\r16369000\r\r18211000\r\r10525000\r\r10372000\r\r7111000\r\r8934000\r\r7828000\r\r5386000\r\r\r\rShort Term Investments\r\r681000\r\r521000\r\r565000\r\r596000\r\r618000\r\r608000\r\r701000\r\r508000\r\rNA\r\rNA\r\rNA\r\rNA\r\r15925000\r\r17554000\r\r19642000\r\r18181000\r\r\r\rNet Receivables\r\r4822000\r\r4204000\r\r3854000\r\r3416000\r\r8596000\r\r10380000\r\r10239000\r\r9534000\r\r19874000\r\r24209000\r\r24076000\r\r43013000\r\r3698000\r\r10599000\r\r11102000\r\r11042000\r\r\r\rInventory\r\r4301000\r\r3962000\r\r4278000\r\r4335000\r\r1682000\r\r1583000\r\r1553000\r\r1551000\r\r19271000\r\r19419000\r\r22354000\r\r22515000\r\r11220000\r\r11176000\r\r8898000\r\r8319000\r\r\r\rOther Current Assets\r\r1387000\r\r4356000\r\r1120000\r\r1352000\r\r2902000\r\r2266000\r\r532000\r\r293000\r\r7441000\r\r6720000\r\r3885000\r\r5109000\r\r2567000\r\r3649000\r\r3145000\r\r2704000\r\r\r\rTotal Current Assets\r\r15481000\r\r16983000\r\r13884000\r\r12686000\r\r49146000\r\r49735000\r\r43889000\r\r42504000\r\r95974000\r\r116253000\r\r131436000\r\r280896000\r\r114649000\r\r116801000\r\r108461000\r\r102587000\r\r\r\rLong Term Investments\r\r637000\r\r565000\r\r491000\r\r592000\r\r439000\r\r581000\r\r659000\r\r1131000\r\r34920000\r\r38696000\r\r44313000\r\r31973000\r\r2595000\r\r3448000\r\r3523000\r\r3244000\r\r\r\rProperty, plant and equipment\r\r10347000\r\r10411000\r\r11673000\r\r11058000\r\r10792000\r\r11116000\r\r10830000\r\r10727000\r\r50749000\r\r53874000\r\r50518000\r\r54095000\r\r37883000\r\r36901000\r\r33692000\r\r32177000\r\r\r\rGoodwill\r\r17341000\r\r16881000\r\r17624000\r\r16213000\r\r36265000\r\r36788000\r\r36199000\r\r32021000\r\r58710000\r\r83968000\r\r68070000\r\r65526000\r\r264000\r\r75000\r\r50000\r\r6000\r\r\r\rIntangible Assets\r\r12152000\r\r11520000\r\r9809000\r\r8846000\r\r3087000\r\r3742000\r\r4688000\r\r3487000\r\r18159000\r\r20273000\r\r16436000\r\r17797000\r\r178000\r\r213000\r\r198000\r\r124000\r\r\r\rAccumulated Amortization\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rOther Assets\r\r3498000\r\r3925000\r\r2948000\r\r2903000\r\r14505000\r\r13844000\r\r12184000\r\r10612000\r\r49713000\r\r56181000\r\r52042000\r\r42784000\r\r16755000\r\r18215000\r\r14894000\r\r16154000\r\r\r\rDeferred Long Term Asset Charges\r\r1117000\r\r1085000\r\r1354000\r\r1185000\r\r5216000\r\r4862000\r\r5224000\r\r4822000\r\r12432000\r\r8819000\r\r1833000\r\r3105000\r\r10412000\r\r10762000\r\r9705000\r\r11509000\r\r\r\rTotal Assets\r\r59456000\r\r60285000\r\r56429000\r\r52298000\r\r123382000\r\r125356000\r\r117470000\r\r110495000\r\r309129000\r\r369245000\r\r365183000\r\r493071000\r\r256540000\r\r258496000\r\r237951000\r\r224925000\r\r\r\rAccounts Payable\r\r9121000\r\r8217000\r\r8591000\r\r8296000\r\r6558000\r\r6451000\r\r6209000\r\r6028000\r\r17153000\r\r15172000\r\r14435000\r\r13680000\r\r20426000\r\r23282000\r\r21296000\r\r20272000\r\r\r\rShort/Current Long Term Debt\r\r2012000\r\r1537000\r\r2173000\r\r1495000\r\r7055000\r\r5215000\r\r6239000\r\r5271000\r\rNA\r\rNA\r\rNA\r\rNA\r\r1700000\r\r1960000\r\r1361000\r\r961000\r\r\r\rOther Current Liabilities\r\r3194000\r\r2787000\r\r2392000\r\r2759000\r\r14680000\r\r16451000\r\r14693000\r\r14281000\r\r19710000\r\r19531000\r\r20772000\r\r27453000\r\r18868000\r\r16402000\r\r16277000\r\r16084000\r\r\r\rTotal Current Liabilities\r\r19772000\r\r23177000\r\r20556000\r\r20019000\r\r38227000\r\r37363000\r\r36275000\r\r34269000\r\r49937000\r\r60043000\r\r70364000\r\r138270000\r\r95569000\r\r94600000\r\r90281000\r\r82336000\r\r\r\rLong Term Debt\r\r21535000\r\r16342000\r\r11011000\r\r9696000\r\r35681000\r\r39871000\r\r34663000\r\r33431000\r\r95234000\r\r108575000\r\r105080000\r\r144659000\r\r11833000\r\r13174000\r\r13222000\r\r11060000\r\r\r\rOther Liabilities\r\r5742000\r\r6259000\r\r7748000\r\r6343000\r\r32544000\r\r30397000\r\r28140000\r\r28371000\r\r74883000\r\r84243000\r\r83040000\r\r79175000\r\r23088000\r\r25526000\r\r25086000\r\r23959000\r\r\r\rDeferred Long Term Liability Charges\r\rNA\r\rNA\r\rNA\r\rNA\r\r2676000\r\r2136000\r\r1496000\r\r1626000\r\r5739000\r\r5484000\r\r5534000\r\rNA\r\rNA\r\r232000\r\rNA\r\rNA\r\r\r\rMinority Interest\r\r720000\r\r758000\r\r626000\r\r643000\r\r134000\r\r131000\r\r146000\r\r162000\r\r20882000\r\r20859000\r\r4688000\r\r4836000\r\r134000\r\r126000\r\r113000\r\r109000\r\r\r\rNegative Goodwill\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rTotal Liabilities\r\r47164000\r\r45898000\r\r39449000\r\r36216000\r\r106452000\r\r107631000\r\r99078000\r\r96071000\r\r257266000\r\r292356000\r\r284667000\r\r389961000\r\r220474000\r\r222792000\r\r208668000\r\r196174000\r\r\r\rMisc. Stocks Options Warrants\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rRedeemable Preferred Stock\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rPreferred Stock\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rCommon Stock\r\r464000\r\r484000\r\r484000\r\r484000\r\r55151000\r\r54566000\r\r53935000\r\r53262000\r\r702000\r\r702000\r\r702000\r\r702000\r\r41000\r\r41000\r\r41000\r\r41000\r\r\r\rRetained Earnings\r\r26265000\r\r26648000\r\r23179000\r\r22619000\r\r159206000\r\r153126000\r\r152759000\r\r146124000\r\r93109000\r\r117245000\r\r139532000\r\r140020000\r\r22668000\r\r21906000\r\r15634000\r\r14414000\r\r\r\rTreasury Stock\r\r-15286000\r\r-13633000\r\r-7443000\r\r-7816000\r\r-197561000\r\r-190098000\r\r-188448000\r\r-185124000\r\r-62836000\r\r-61923000\r\r-64412000\r\r-42454000\r\r-8783000\r\r-8212000\r\r-8135000\r\r-7234000\r\r\r\rCapital Surplus\r\r129000\r\r130000\r\r134000\r\r152000\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r22006000\r\r21843000\r\r21630000\r\r21421000\r\r\r\rOther Stockholder Equity\r\r-5105000\r\r-4425000\r\r-3279000\r\r-3697000\r\r-29490000\r\r-26591000\r\r-29398000\r\r-29606000\r\r21089000\r\r22979000\r\r18626000\r\r21085000\r\r-7366000\r\r-6959000\r\r-7013000\r\r-6257000\r\r\r\rTotal stockholders’ equity\r\r11572000\r\r13629000\r\r16354000\r\r15439000\r\r16796000\r\r17594000\r\r18246000\r\r14262000\r\r30975000\r\r56024000\r\r75822000\r\r98268000\r\r35932000\r\r35578000\r\r29170000\r\r28642000\r\r\r\rNet Tangible Assets\r\r-17921000\r\r-14772000\r\r-11079000\r\r-9620000\r\r-22556000\r\r-22936000\r\r-22641000\r\r-21246000\r\r-46798000\r\r-48217000\r\r-11052000\r\r14945000\r\r35932000\r\r35290000\r\r28922000\r\r28512000\r\r\r\r\r\rHow the Cash Flow Statement looks:\rTable 3: Cash Flow Statements\r\r\r\r\rUN.f.12.31.2018\r\rUN.f.12.31.2017\r\rUN.f.12.31.2016\r\rUN.f.12.31.2015\r\rIBM.f.12.31.2018\r\rIBM.f.12.31.2017\r\rIBM.f.12.31.2016\r\rIBM.f.12.31.2015\r\rGE.f.12.31.2018\r\rGE.f.12.31.2017\r\rGE.f.12.31.2016\r\rGE.f.12.31.2015\r\rF.f.12.31.2018\r\rF.f.12.31.2017\r\rF.f.12.31.2016\r\rF.f.12.31.2015\r\r\r\r\r\rNet Income\r\r9389000\r\r6053000\r\r5184000\r\r4909000\r\r8728000\r\r5753000\r\r11872000\r\r13190000\r\r-22355000\r\r-8484000\r\r7500000\r\r-6126000\r\r3677000\r\r7731000\r\r4589000\r\r7373000\r\r\r\rDepreciation\r\r1450000\r\r1214000\r\r1464000\r\r1370000\r\r4480000\r\r4541000\r\r4381000\r\r3855000\r\r7796000\r\r7429000\r\r7070000\r\r6509000\r\r8308000\r\r8453000\r\r8717000\r\r7966000\r\r\r\rAdjustments To Net Income\r\r-3590000\r\r-231000\r\r348000\r\r331000\r\r1485000\r\r-383000\r\r-526000\r\r2406000\r\r18532000\r\r9305000\r\r-14391000\r\r21411000\r\r-677000\r\r-910000\r\r3607000\r\r-2153000\r\r\r\rChanges In Accounts Receivables\r\r-1298000\r\r-506000\r\r142000\r\r2000\r\r1006000\r\r1297000\r\r712000\r\r812000\r\r-430000\r\r-2846000\r\r1460000\r\r-52000\r\r-2239000\r\r-2297000\r\r-2855000\r\r-3563000\r\r\r\rChanges In Liabilities\r\r976000\r\r542000\r\r-281000\r\r847000\r\r126000\r\r47000\r\r197000\r\r81000\r\r1697000\r\r1343000\r\r2953000\r\r-1537000\r\r6781000\r\r6089000\r\r6595000\r\r7758000\r\r\r\rChanges In Inventories\r\r-471000\r\r-104000\r\r190000\r\r-129000\r\r-127000\r\r18000\r\r-14000\r\r133000\r\r-902000\r\r1183000\r\r-815000\r\r-314000\r\r-828000\r\r-970000\r\r-803000\r\r-1155000\r\r\r\rChanges In Other Operating Activities\r\r-793000\r\r-68000\r\r-68000\r\r-68000\r\r-451000\r\r5451000\r\r462000\r\r-3222000\r\r-92000\r\r-1898000\r\r-2617000\r\r-2617000\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rTotal Cash Flow From Operating Activities\r\r6753000\r\r7292000\r\r7047000\r\r7330000\r\r15247000\r\r16724000\r\r17084000\r\r17255000\r\r4246000\r\r6032000\r\r1160000\r\r19891000\r\r15022000\r\r18096000\r\r19850000\r\r16226000\r\r\r\rCapital Expenditure\r\r-1329000\r\r-1509000\r\r-1804000\r\r-1867000\r\r-3395000\r\r-3229000\r\r-3567000\r\r-3579000\r\r-7695000\r\r-7371000\r\r-7199000\r\r-7309000\r\r-7785000\r\r-7049000\r\r-6992000\r\r-7196000\r\r\r\rInvestments\r\r47000\r\r-215000\r\r100000\r\r-62000\r\r-554000\r\r-1039000\r\r-161000\r\r-231000\r\rNA\r\rNA\r\rNA\r\rNA\r\r3387000\r\r2331000\r\r-2074000\r\r-513000\r\r\r\rOther Cash flows from Investing Activities\r\r264000\r\r292000\r\r291000\r\r295000\r\r-1000\r\r-1000\r\r-1000\r\r1000\r\r12953000\r\r10133000\r\r-10317000\r\r-5316000\r\r181000\r\r71000\r\r937000\r\r634000\r\r\r\rTotal Cash Flows From Investing Activities\r\r4644000\r\r-5879000\r\r-3188000\r\r-3539000\r\r-4913000\r\r-7081000\r\r-10928000\r\r-8159000\r\r18239000\r\r6564000\r\r49135000\r\r59488000\r\r-16261000\r\r-19360000\r\r-25302000\r\r-26162000\r\r\r\rDividends Paid\r\r-4066000\r\r-3916000\r\r-3609000\r\r-3331000\r\r-5666000\r\r-5506000\r\r-5256000\r\r-4897000\r\r-4474000\r\r-8650000\r\r-8806000\r\r-9295000\r\r-2705000\r\r-2384000\r\r-2383500\r\r-2380000\r\r\r\rSale Purchase of Stock\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Borrowings\r\r-35000\r\r8928000\r\r1771000\r\r1527000\r\r-301000\r\r3447000\r\r2763000\r\r19000\r\r-22401000\r\r-8952000\r\r-58411000\r\r-57546000\r\r3139000\r\r6260000\r\r11028000\r\r17148000\r\r\r\rOther Cash Flows from Financing Activities\r\r-1170000\r\r-1227000\r\r-978000\r\r-952000\r\r112000\r\r174000\r\r204000\r\r-1000\r\r-4141000\r\r1006000\r\r-1818000\r\r-8114000\r\r-192000\r\r-151000\r\r-107000\r\r-373000\r\r\r\rTotal Cash Flows From Financing Activities\r\r-11548000\r\r-1433000\r\r-3073000\r\r-3032000\r\r-10469000\r\r-6418000\r\r-5917000\r\r-9413000\r\r-31033000\r\r-19146000\r\r-90464000\r\r-76054000\r\r-122000\r\r3394000\r\r7400000\r\r14266000\r\r\r\rEffect Of Exchange Rate Changes\r\r72000\r\r-9000\r\r284000\r\r-541000\r\r-495000\r\r937000\r\r-51000\r\r-473000\r\r-628000\r\r891000\r\r-1146000\r\r-3464000\r\r-370000\r\r489000\r\r-265000\r\r-815000\r\r\r\rChange In Cash and Cash Equivalents\r\r-79000\r\r-29000\r\r1070000\r\r218000\r\r-630000\r\r4161000\r\r188000\r\r-790000\r\r-9176000\r\r-5660000\r\r-41315000\r\r-138000\r\r-1731000\r\r2619000\r\r1683000\r\r3515000\r\r\r\r\rAs in previous posts let’s clean the data up and put it into a better format which is easier for computations.\n############# Combine and clean the data ###############\rISBSCF \u0026lt;- rbind(IS, BS, CF)\rISBSCF \u0026lt;- ISBSCF %\u0026gt;%\rt() %\u0026gt;%\rdata.frame() %\u0026gt;%\rrownames_to_column(\u0026#39;rn\u0026#39;) %\u0026gt;%\rseparate(rn, into = c(\u0026quot;symbol\u0026quot;, \u0026quot;year\u0026quot;),\rsep = -4, convert = TRUE)\rISBSCF$symbol \u0026lt;- gsub(\u0026quot;(f).*\u0026quot;, \u0026quot;\u0026quot;, ISBSCF$symbol)\rISBSCF$symbol \u0026lt;- gsub(\u0026#39;.$\u0026#39;, \u0026#39;\u0026#39;, ISBSCF$symbol)\rISBSCF$symbol \u0026lt;- gsub(\u0026#39;^X\u0026#39;, \u0026#39;\u0026#39;, ISBSCF$symbol)\r\rHow the full data looks:\rTable 4: Income Statment - Balance Sheet - Cash Flow\r\r\r\rsymbol\r\ryear\r\rTotal.Revenue\r\rCost.of.Revenue\r\rGross.Profit\r\rResearch.Development\r\rSelling.General.and.Administrative\r\rNon.Recurring\r\rOthers\r\rTotal.Operating.Expenses\r\rOperating.Income.or.Loss\r\rTotal.Other.Income.Expenses.Net\r\rEarnings.Before.Interest.and.Taxes\r\rInterest.Expense\r\rIncome.Before.Tax\r\rIncome.Tax.Expense\r\rMinority.Interest\r\rNet.Income.From.Continuing.Ops\r\rDiscontinued.Operations\r\rExtraordinary.Items\r\rEffect.Of.Accounting.Changes\r\rOther.Items\r\rNet.Income\r\rPreferred.Stock.And.Other.Adjustments\r\rNet.Income.Applicable.To.Common.Shares\r\rCash.And.Cash.Equivalents\r\rShort.Term.Investments\r\rNet.Receivables\r\rInventory\r\rOther.Current.Assets\r\rTotal.Current.Assets\r\rLong.Term.Investments\r\rProperty..plant.and.equipment\r\rGoodwill\r\rIntangible.Assets\r\rAccumulated.Amortization\r\rOther.Assets\r\rDeferred.Long.Term.Asset.Charges\r\rTotal.Assets\r\rAccounts.Payable\r\rShort.Current.Long.Term.Debt\r\rOther.Current.Liabilities\r\rTotal.Current.Liabilities\r\rLong.Term.Debt\r\rOther.Liabilities\r\rDeferred.Long.Term.Liability.Charges\r\rMinority.Interest1\r\rNegative.Goodwill\r\rTotal.Liabilities\r\rMisc..Stocks.Options.Warrants\r\rRedeemable.Preferred.Stock\r\rPreferred.Stock\r\rCommon.Stock\r\rRetained.Earnings\r\rTreasury.Stock\r\rCapital.Surplus\r\rOther.Stockholder.Equity\r\rTotal.stockholders..equity\r\rNet.Tangible.Assets\r\rNet.Income1\r\rDepreciation\r\rAdjustments.To.Net.Income\r\rChanges.In.Accounts.Receivables\r\rChanges.In.Liabilities\r\rChanges.In.Inventories\r\rChanges.In.Other.Operating.Activities\r\rTotal.Cash.Flow.From.Operating.Activities\r\rCapital.Expenditure\r\rInvestments\r\rOther.Cash.flows.from.Investing.Activities\r\rTotal.Cash.Flows.From.Investing.Activities\r\rDividends.Paid\r\rSale.Purchase.of.Stock\r\rNet.Borrowings\r\rOther.Cash.Flows.from.Financing.Activities\r\rTotal.Cash.Flows.From.Financing.Activities\r\rEffect.Of.Exchange.Rate.Changes\r\rChange.In.Cash.and.Cash.Equivalents\r\r\r\r\r\rUN\r\r2018\r\r50982000\r\r28769000\r\r22213000\r\r900000\r\r8803000\r\rNA\r\r41427000\r\r38472000\r\r12510000\r\r-127000\r\r12510000\r\r-627000\r\r12383000\r\r2575000\r\r720000\r\r9808000\r\rNA\r\rNA\r\rNA\r\rNA\r\r9389000\r\rNA\r\r9389000\r\r3230000\r\r681000\r\r4822000\r\r4301000\r\r1387000\r\r15481000\r\r637000\r\r10347000\r\r17341000\r\r12152000\r\rNA\r\r3498000\r\r1117000\r\r59456000\r\r9121000\r\r2012000\r\r3194000\r\r19772000\r\r21535000\r\r5742000\r\rNA\r\r720000\r\rNA\r\r47164000\r\rNA\r\rNA\r\rNA\r\r464000\r\r26265000\r\r-15286000\r\r129000\r\r-5105000\r\r11572000\r\r-17921000\r\r9389000\r\r1450000\r\r-3590000\r\r-1298000\r\r976000\r\r-471000\r\r-793000\r\r6753000\r\r-1329000\r\r47000\r\r264000\r\r4644000\r\r-4066000\r\rNA\r\r-35000\r\r-1170000\r\r-11548000\r\r72000\r\r-79000\r\r\r\rUN\r\r2017\r\r53715000\r\r30547000\r\r23168000\r\r900000\r\r13507000\r\rNA\r\r44031000\r\r44954000\r\r8761000\r\r-608000\r\r8761000\r\r-608000\r\r8153000\r\r1667000\r\r758000\r\r6486000\r\rNA\r\rNA\r\rNA\r\rNA\r\r6053000\r\rNA\r\r6053000\r\r3317000\r\r521000\r\r4204000\r\r3962000\r\r4356000\r\r16983000\r\r565000\r\r10411000\r\r16881000\r\r11520000\r\rNA\r\r3925000\r\r1085000\r\r60285000\r\r8217000\r\r1537000\r\r2787000\r\r23177000\r\r16342000\r\r6259000\r\rNA\r\r758000\r\rNA\r\r45898000\r\rNA\r\rNA\r\rNA\r\r484000\r\r26648000\r\r-13633000\r\r130000\r\r-4425000\r\r13629000\r\r-14772000\r\r6053000\r\r1214000\r\r-231000\r\r-506000\r\r542000\r\r-104000\r\r-68000\r\r7292000\r\r-1509000\r\r-215000\r\r292000\r\r-5879000\r\r-3916000\r\rNA\r\r8928000\r\r-1227000\r\r-1433000\r\r-9000\r\r-29000\r\r\r\rUN\r\r2016\r\r52713000\r\r30229000\r\r22484000\r\r978000\r\r13799000\r\rNA\r\r44031000\r\r45006000\r\r7707000\r\r-238000\r\r7707000\r\r-572000\r\r7469000\r\r1922000\r\r626000\r\r5547000\r\rNA\r\rNA\r\rNA\r\rNA\r\r5184000\r\rNA\r\r5184000\r\r3382000\r\r565000\r\r3854000\r\r4278000\r\r1120000\r\r13884000\r\r491000\r\r11673000\r\r17624000\r\r9809000\r\rNA\r\r2948000\r\r1354000\r\r56429000\r\r8591000\r\r2173000\r\r2392000\r\r20556000\r\r11011000\r\r7748000\r\rNA\r\r626000\r\rNA\r\r39449000\r\rNA\r\rNA\r\rNA\r\r484000\r\r23179000\r\r-7443000\r\r134000\r\r-3279000\r\r16354000\r\r-11079000\r\r5184000\r\r1464000\r\r348000\r\r142000\r\r-281000\r\r190000\r\r-68000\r\r7047000\r\r-1804000\r\r100000\r\r291000\r\r-3188000\r\r-3609000\r\rNA\r\r1771000\r\r-978000\r\r-3073000\r\r284000\r\r1070000\r\r\r\rUN\r\r2015\r\r53272000\r\r30808000\r\r22464000\r\r1005000\r\r14065000\r\rNA\r\r44031000\r\r45878000\r\r7394000\r\r-174000\r\r7394000\r\r-552000\r\r7220000\r\r1961000\r\r643000\r\r5259000\r\rNA\r\rNA\r\rNA\r\rNA\r\r4909000\r\rNA\r\r4909000\r\r2302000\r\r596000\r\r3416000\r\r4335000\r\r1352000\r\r12686000\r\r592000\r\r11058000\r\r16213000\r\r8846000\r\rNA\r\r2903000\r\r1185000\r\r52298000\r\r8296000\r\r1495000\r\r2759000\r\r20019000\r\r9696000\r\r6343000\r\rNA\r\r643000\r\rNA\r\r36216000\r\rNA\r\rNA\r\rNA\r\r484000\r\r22619000\r\r-7816000\r\r152000\r\r-3697000\r\r15439000\r\r-9620000\r\r4909000\r\r1370000\r\r331000\r\r2000\r\r847000\r\r-129000\r\r-68000\r\r7330000\r\r-1867000\r\r-62000\r\r295000\r\r-3539000\r\r-3331000\r\rNA\r\r1527000\r\r-952000\r\r-3032000\r\r-541000\r\r218000\r\r\r\rIBM\r\r2018\r\r79591000\r\r42655000\r\r36936000\r\r5379000\r\r20325000\r\rNA\r\r-998000\r\r67361000\r\r12230000\r\r-888000\r\r12230000\r\r-723000\r\r11342000\r\r2619000\r\r134000\r\r8723000\r\r5000\r\rNA\r\rNA\r\rNA\r\r8728000\r\rNA\r\r8728000\r\r11379000\r\r618000\r\r8596000\r\r1682000\r\r2902000\r\r49146000\r\r439000\r\r10792000\r\r36265000\r\r3087000\r\rNA\r\r14505000\r\r5216000\r\r123382000\r\r6558000\r\r7055000\r\r14680000\r\r38227000\r\r35681000\r\r32544000\r\r2676000\r\r134000\r\rNA\r\r106452000\r\rNA\r\rNA\r\rNA\r\r55151000\r\r159206000\r\r-197561000\r\rNA\r\r-29490000\r\r16796000\r\r-22556000\r\r8728000\r\r4480000\r\r1485000\r\r1006000\r\r126000\r\r-127000\r\r-451000\r\r15247000\r\r-3395000\r\r-554000\r\r-1000\r\r-4913000\r\r-5666000\r\rNA\r\r-301000\r\r112000\r\r-10469000\r\r-495000\r\r-630000\r\r\r\rIBM\r\r2017\r\r79139000\r\r42196000\r\r36943000\r\r5590000\r\r20900000\r\rNA\r\r-1445000\r\r67241000\r\r11898000\r\r-498000\r\r11898000\r\r-615000\r\r11400000\r\r5642000\r\r131000\r\r5758000\r\r-5000\r\rNA\r\rNA\r\rNA\r\r5753000\r\rNA\r\r5753000\r\r11972000\r\r608000\r\r10380000\r\r1583000\r\r2266000\r\r49735000\r\r581000\r\r11116000\r\r36788000\r\r3742000\r\rNA\r\r13844000\r\r4862000\r\r125356000\r\r6451000\r\r5215000\r\r16451000\r\r37363000\r\r39871000\r\r30397000\r\r2136000\r\r131000\r\rNA\r\r107631000\r\rNA\r\rNA\r\rNA\r\r54566000\r\r153126000\r\r-190098000\r\rNA\r\r-26591000\r\r17594000\r\r-22936000\r\r5753000\r\r4541000\r\r-383000\r\r1297000\r\r47000\r\r18000\r\r5451000\r\r16724000\r\r-3229000\r\r-1039000\r\r-1000\r\r-7081000\r\r-5506000\r\rNA\r\r3447000\r\r174000\r\r-6418000\r\r937000\r\r4161000\r\r\r\rIBM\r\r2016\r\r79919000\r\r41402000\r\r38517000\r\r5726000\r\r20225000\r\rNA\r\r-1604000\r\r65749000\r\r14170000\r\r-1840000\r\r14170000\r\r-630000\r\r12330000\r\r449000\r\r146000\r\r11881000\r\r-9000\r\rNA\r\rNA\r\rNA\r\r11872000\r\rNA\r\r11872000\r\r7826000\r\r701000\r\r10239000\r\r1553000\r\r532000\r\r43889000\r\r659000\r\r10830000\r\r36199000\r\r4688000\r\rNA\r\r12184000\r\r5224000\r\r117470000\r\r6209000\r\r6239000\r\r14693000\r\r36275000\r\r34663000\r\r28140000\r\r1496000\r\r146000\r\rNA\r\r99078000\r\rNA\r\rNA\r\rNA\r\r53935000\r\r152759000\r\r-188448000\r\rNA\r\r-29398000\r\r18246000\r\r-22641000\r\r11872000\r\r4381000\r\r-526000\r\r712000\r\r197000\r\r-14000\r\r462000\r\r17084000\r\r-3567000\r\r-161000\r\r-1000\r\r-10928000\r\r-5256000\r\rNA\r\r2763000\r\r204000\r\r-5917000\r\r-51000\r\r188000\r\r\r\rIBM\r\r2015\r\r81741000\r\r41057000\r\r40684000\r\r5247000\r\r19589000\r\rNA\r\r-669000\r\r65224000\r\r16517000\r\r-572000\r\r16517000\r\r-468000\r\r15945000\r\r2581000\r\r162000\r\r13364000\r\r-174000\r\rNA\r\rNA\r\rNA\r\r13190000\r\rNA\r\r13190000\r\r7686000\r\r508000\r\r9534000\r\r1551000\r\r293000\r\r42504000\r\r1131000\r\r10727000\r\r32021000\r\r3487000\r\rNA\r\r10612000\r\r4822000\r\r110495000\r\r6028000\r\r5271000\r\r14281000\r\r34269000\r\r33431000\r\r28371000\r\r1626000\r\r162000\r\rNA\r\r96071000\r\rNA\r\rNA\r\rNA\r\r53262000\r\r146124000\r\r-185124000\r\rNA\r\r-29606000\r\r14262000\r\r-21246000\r\r13190000\r\r3855000\r\r2406000\r\r812000\r\r81000\r\r133000\r\r-3222000\r\r17255000\r\r-3579000\r\r-231000\r\r1000\r\r-8159000\r\r-4897000\r\rNA\r\r19000\r\r-1000\r\r-9413000\r\r-473000\r\r-790000\r\r\r\rGE\r\r2018\r\r121615000\r\r98396000\r\r23219000\r\rNA\r\r15134000\r\rNA\r\rNA\r\r113530000\r\r8085000\r\r-28220000\r\r8085000\r\r-2708000\r\r-20135000\r\r583000\r\r20882000\r\r-20718000\r\r-1726000\r\rNA\r\rNA\r\rNA\r\r-22355000\r\rNA\r\r-22809000\r\r16369000\r\rNA\r\r19874000\r\r19271000\r\r7441000\r\r95974000\r\r34920000\r\r50749000\r\r58710000\r\r18159000\r\rNA\r\r49713000\r\r12432000\r\r309129000\r\r17153000\r\rNA\r\r19710000\r\r49937000\r\r95234000\r\r74883000\r\r5739000\r\r20882000\r\rNA\r\r257266000\r\rNA\r\rNA\r\rNA\r\r702000\r\r93109000\r\r-62836000\r\rNA\r\r21089000\r\r30975000\r\r-46798000\r\r-22355000\r\r7796000\r\r18532000\r\r-430000\r\r1697000\r\r-902000\r\r-92000\r\r4246000\r\r-7695000\r\rNA\r\r12953000\r\r18239000\r\r-4474000\r\rNA\r\r-22401000\r\r-4141000\r\r-31033000\r\r-628000\r\r-9176000\r\r\r\rGE\r\r2017\r\r118243000\r\r106858000\r\r11385000\r\rNA\r\r15389000\r\rNA\r\rNA\r\r122247000\r\r-4004000\r\r-7147000\r\r-4004000\r\r-2753000\r\r-11151000\r\r-2611000\r\r20859000\r\r-8540000\r\r-309000\r\rNA\r\rNA\r\rNA\r\r-8484000\r\rNA\r\r-8944000\r\r18211000\r\rNA\r\r24209000\r\r19419000\r\r6720000\r\r116253000\r\r38696000\r\r53874000\r\r83968000\r\r20273000\r\rNA\r\r56181000\r\r8819000\r\r369245000\r\r15172000\r\rNA\r\r19531000\r\r60043000\r\r108575000\r\r84243000\r\r5484000\r\r20859000\r\rNA\r\r292356000\r\rNA\r\rNA\r\rNA\r\r702000\r\r117245000\r\r-61923000\r\rNA\r\r22979000\r\r56024000\r\r-48217000\r\r-8484000\r\r7429000\r\r9305000\r\r-2846000\r\r1343000\r\r1183000\r\r-1898000\r\r6032000\r\r-7371000\r\rNA\r\r10133000\r\r6564000\r\r-8650000\r\rNA\r\r-8952000\r\r1006000\r\r-19146000\r\r891000\r\r-5660000\r\r\r\rGE\r\r2016\r\r119468000\r\r94886000\r\r24582000\r\rNA\r\r14707000\r\rNA\r\rNA\r\r109593000\r\r9875000\r\r-2843000\r\r9875000\r\r-2026000\r\r7032000\r\r-1133000\r\r4688000\r\r8165000\r\r-954000\r\rNA\r\rNA\r\rNA\r\r7500000\r\rNA\r\r6829000\r\r10525000\r\rNA\r\r24076000\r\r22354000\r\r3885000\r\r131436000\r\r44313000\r\r50518000\r\r68070000\r\r16436000\r\rNA\r\r52042000\r\r1833000\r\r365183000\r\r14435000\r\rNA\r\r20772000\r\r70364000\r\r105080000\r\r83040000\r\r5534000\r\r4688000\r\rNA\r\r284667000\r\rNA\r\rNA\r\rNA\r\r702000\r\r139532000\r\r-64412000\r\rNA\r\r18626000\r\r75822000\r\r-11052000\r\r7500000\r\r7070000\r\r-14391000\r\r1460000\r\r2953000\r\r-815000\r\r-2617000\r\r1160000\r\r-7199000\r\rNA\r\r-10317000\r\r49135000\r\r-8806000\r\rNA\r\r-58411000\r\r-1818000\r\r-90464000\r\r-1146000\r\r-41315000\r\r\r\rGE\r\r2015\r\r115834000\r\r90111000\r\r25723000\r\rNA\r\r16327000\r\rNA\r\rNA\r\r106438000\r\r9396000\r\r-1211000\r\r9396000\r\r-1706000\r\r8185000\r\r6485000\r\r4836000\r\r1700000\r\r-7807000\r\rNA\r\rNA\r\rNA\r\r-6126000\r\rNA\r\r-6135000\r\r10372000\r\rNA\r\r43013000\r\r22515000\r\r5109000\r\r280896000\r\r31973000\r\r54095000\r\r65526000\r\r17797000\r\rNA\r\r42784000\r\r3105000\r\r493071000\r\r13680000\r\rNA\r\r27453000\r\r138270000\r\r144659000\r\r79175000\r\rNA\r\r4836000\r\rNA\r\r389961000\r\rNA\r\rNA\r\rNA\r\r702000\r\r140020000\r\r-42454000\r\rNA\r\r21085000\r\r98268000\r\r14945000\r\r-6126000\r\r6509000\r\r21411000\r\r-52000\r\r-1537000\r\r-314000\r\r-2617000\r\r19891000\r\r-7309000\r\rNA\r\r-5316000\r\r59488000\r\r-9295000\r\rNA\r\r-57546000\r\r-8114000\r\r-76054000\r\r-3464000\r\r-138000\r\r\r\rF\r\r2018\r\r160338000\r\r145459000\r\r14879000\r\rNA\r\r10460000\r\rNA\r\rNA\r\r155919000\r\r4419000\r\r-74000\r\r4419000\r\r-1228000\r\r4345000\r\r650000\r\r134000\r\r3695000\r\rNA\r\rNA\r\rNA\r\rNA\r\r3677000\r\rNA\r\r3677000\r\r7111000\r\r15925000\r\r3698000\r\r11220000\r\r2567000\r\r114649000\r\r2595000\r\r37883000\r\r264000\r\r178000\r\rNA\r\r16755000\r\r10412000\r\r256540000\r\r20426000\r\r1700000\r\r18868000\r\r95569000\r\r11833000\r\r23088000\r\rNA\r\r134000\r\rNA\r\r220474000\r\rNA\r\rNA\r\rNA\r\r41000\r\r22668000\r\r-8783000\r\r22006000\r\r-7366000\r\r35932000\r\r35932000\r\r3677000\r\r8308000\r\r-677000\r\r-2239000\r\r6781000\r\r-828000\r\rNA\r\r15022000\r\r-7785000\r\r3387000\r\r181000\r\r-16261000\r\r-2705000\r\rNA\r\r3139000\r\r-192000\r\r-122000\r\r-370000\r\r-1731000\r\r\r\rF\r\r2017\r\r156776000\r\r140218000\r\r16558000\r\rNA\r\r9676000\r\rNA\r\rNA\r\r149894000\r\r6882000\r\r1277000\r\r6882000\r\r-1190000\r\r8159000\r\r402000\r\r126000\r\r7757000\r\rNA\r\rNA\r\rNA\r\rNA\r\r7731000\r\rNA\r\r7731000\r\r8934000\r\r17554000\r\r10599000\r\r11176000\r\r3649000\r\r116801000\r\r3448000\r\r36901000\r\r75000\r\r213000\r\rNA\r\r18215000\r\r10762000\r\r258496000\r\r23282000\r\r1960000\r\r16402000\r\r94600000\r\r13174000\r\r25526000\r\r232000\r\r126000\r\rNA\r\r222792000\r\rNA\r\rNA\r\rNA\r\r41000\r\r21906000\r\r-8212000\r\r21843000\r\r-6959000\r\r35578000\r\r35290000\r\r7731000\r\r8453000\r\r-910000\r\r-2297000\r\r6089000\r\r-970000\r\rNA\r\r18096000\r\r-7049000\r\r2331000\r\r71000\r\r-19360000\r\r-2384000\r\rNA\r\r6260000\r\r-151000\r\r3394000\r\r489000\r\r2619000\r\r\r\rF\r\r2016\r\r151800000\r\r134933000\r\r16867000\r\rNA\r\r12504000\r\rNA\r\rNA\r\r147437000\r\r4363000\r\r2421000\r\r4363000\r\r-951000\r\r6784000\r\r2184000\r\r113000\r\r4600000\r\rNA\r\rNA\r\rNA\r\rNA\r\r4589000\r\rNA\r\r4589000\r\r7828000\r\r19642000\r\r11102000\r\r8898000\r\r3145000\r\r108461000\r\r3523000\r\r33692000\r\r50000\r\r198000\r\rNA\r\r14894000\r\r9705000\r\r237951000\r\r21296000\r\r1361000\r\r16277000\r\r90281000\r\r13222000\r\r25086000\r\rNA\r\r113000\r\rNA\r\r208668000\r\rNA\r\rNA\r\rNA\r\r41000\r\r15634000\r\r-8135000\r\r21630000\r\r-7013000\r\r29170000\r\r28922000\r\r4589000\r\r8717000\r\r3607000\r\r-2855000\r\r6595000\r\r-803000\r\rNA\r\r19850000\r\r-6992000\r\r-2074000\r\r937000\r\r-25302000\r\r-2383500\r\rNA\r\r11028000\r\r-107000\r\r7400000\r\r-265000\r\r1683000\r\r\r\rF\r\r2015\r\r149558000\r\r131410000\r\r18148000\r\rNA\r\r10097000\r\rNA\r\rNA\r\r141507000\r\r8051000\r\r2201000\r\r8051000\r\r-773000\r\r10252000\r\r2881000\r\r109000\r\r7371000\r\rNA\r\rNA\r\rNA\r\rNA\r\r7373000\r\rNA\r\r7373000\r\r5386000\r\r18181000\r\r11042000\r\r8319000\r\r2704000\r\r102587000\r\r3244000\r\r32177000\r\r6000\r\r124000\r\rNA\r\r16154000\r\r11509000\r\r224925000\r\r20272000\r\r961000\r\r16084000\r\r82336000\r\r11060000\r\r23959000\r\rNA\r\r109000\r\rNA\r\r196174000\r\rNA\r\rNA\r\rNA\r\r41000\r\r14414000\r\r-7234000\r\r21421000\r\r-6257000\r\r28642000\r\r28512000\r\r7373000\r\r7966000\r\r-2153000\r\r-3563000\r\r7758000\r\r-1155000\r\rNA\r\r16226000\r\r-7196000\r\r-513000\r\r634000\r\r-26162000\r\r-2380000\r\rNA\r\r17148000\r\r-373000\r\r14266000\r\r-815000\r\r3515000\r\r\r\r\rNow that we have the full data, we can perform any number of calculations across different financial statements. Now the companies are in the “rows” and the “columns” consist of thefinancial entires.\nSome calculations are necessary for computing the NFO.\n\rCompute the Cash Flow Cycle\r########## Create the Cash Cycle Calculations #############\r#Set CashCycle data.frame up\rCashCycle \u0026lt;- data.frame(matrix(\u0026quot;\u0026quot;, nrow = nrow(ISBSCF)))\rCashCycle[,1] \u0026lt;- NULL\rCashCycle$Ticker \u0026lt;- ISBSCF$symbol\rCashCycle$Date \u0026lt;- ISBSCF$year\r#CashCycle excluding accured expense Calculations\rCashCycle$CollectionPeriod \u0026lt;- (ISBSCF$Net.Receivables / ISBSCF$Total.Revenue) * 365\rCashCycle$DaysofInventory \u0026lt;- (ISBSCF$Inventory / ISBSCF$Cost.of.Revenue) * 365\rCashCycle$DaysofPayable \u0026lt;- (ISBSCF$Accounts.Payable / ISBSCF$Cost.of.Revenue) * 365\rCashCycle$CashCollectionCycle \u0026lt;- CashCycle$CollectionPeriod + CashCycle$DaysofInventory - CashCycle$DaysofPayable\r#CashCycle including accured expense Calculations\rCashCycle$DaysofPayableAccExp \u0026lt;- ((ISBSCF$Accounts.Payable + ISBSCF$Total.Current.Liabilities) / ISBSCF$Cost.of.Revenue) * 365\rCashCycle$CashCollectionCycleAccExp \u0026lt;- CashCycle$CollectionPeriod + CashCycle$DaysofInventory - CashCycle$DaysofPayableAccExp\rCashCycle \u0026lt;- CashCycle[Reduce(`\u0026amp;`, lapply(CashCycle, function(x) !is.nan(x) \u0026amp; !is.infinite(x))),]\rTable 5: Cash Flow Cycle\r\r\r\rTicker\r\rDate\r\rCollectionPeriod\r\rDaysofInventory\r\rDaysofPayable\r\rCashCollectionCycle\r\rDaysofPayableAccExp\r\rCashCollectionCycleAccExp\r\r\r\r\r\rUN\r\r2018\r\r34.522577\r\r54.56794\r\r115.72057\r\r-26.630053\r\r366.5732\r\r-277.4827\r\r\r\rUN\r\r2017\r\r28.566695\r\r47.34115\r\r98.18329\r\r-22.275450\r\r375.1206\r\r-299.2128\r\r\r\rUN\r\r2016\r\r26.686206\r\r51.65470\r\r103.73201\r\r-25.391103\r\r351.9354\r\r-273.5945\r\r\r\rUN\r\r2015\r\r23.405166\r\r51.35922\r\r98.28746\r\r-23.523067\r\r335.4640\r\r-260.6996\r\r\r\rIBM\r\r2018\r\r39.420789\r\r14.39292\r\r56.11699\r\r-2.303276\r\r383.2265\r\r-329.4128\r\r\r\rIBM\r\r2017\r\r47.873994\r\r13.69312\r\r55.80185\r\r5.765263\r\r378.9959\r\r-317.4288\r\r\r\rIBM\r\r2016\r\r46.762785\r\r13.69125\r\r54.73854\r\r5.715492\r\r374.5389\r\r-314.0849\r\r\r\rIBM\r\r2015\r\r42.572393\r\r13.78851\r\r53.58940\r\r2.771507\r\r358.2435\r\r-301.8826\r\r\r\rGE\r\r2018\r\r59.647330\r\r71.48578\r\r63.62906\r\r67.504052\r\r248.8704\r\r-117.7373\r\r\r\rGE\r\r2017\r\r74.729878\r\r66.33041\r\r51.82373\r\r89.236560\r\r256.9155\r\r-115.8552\r\r\r\rGE\r\r2016\r\r73.557271\r\r85.98961\r\r55.52742\r\r104.019457\r\r326.1981\r\r-166.6512\r\r\r\rGE\r\r2015\r\r135.536587\r\r91.19836\r\r55.41166\r\r171.323283\r\r615.4826\r\r-388.7476\r\r\r\rF\r\r2018\r\r8.418279\r\r28.15433\r\r51.25492\r\r-14.682320\r\r291.0660\r\r-254.4934\r\r\r\rF\r\r2017\r\r24.676194\r\r29.09213\r\r60.60513\r\r-6.836807\r\r306.8574\r\r-253.0891\r\r\r\rF\r\r2016\r\r26.694532\r\r24.06950\r\r57.60666\r\r-6.842631\r\r301.8209\r\r-251.0569\r\r\r\rF\r\r2015\r\r26.948274\r\r23.10657\r\r56.30683\r\r-6.251977\r\r285.0005\r\r-234.9457\r\r\r\r\rWhere all the results are in days. So Unilever 2018, CollectionPeriod was 34.5 days, up from their 2017, CollectionPeriod and up annually since 2015. Wheras Ford has been decreasing their CollectionPeriod over the sample period.\nLet us continue with some DuPont analysis…\n########## Create the DuPont Calculations #############\r#DuPont Analysis\r#Set CashCycle data.frame up\rDuPontAnalysis \u0026lt;- data.frame(matrix(\u0026quot;\u0026quot;, nrow = nrow(ISBSCF)))\rDuPontAnalysis[,1] \u0026lt;- NULL\rDuPontAnalysis$Ticker \u0026lt;- ISBSCF$symbol\rDuPontAnalysis$Date \u0026lt;- ISBSCF$year\r#DuPont Analysis Calculations\rDuPontAnalysis$ROE \u0026lt;- ISBSCF$Net.Income / ISBSCF$Total.stockholders..equity\rDuPontAnalysis$ROS \u0026lt;- ISBSCF$Net.Income / ISBSCF$Total.Revenue\rDuPontAnalysis$Turnover \u0026lt;- ISBSCF$Total.Revenue / ISBSCF$Total.Assets\rDuPontAnalysis$Leverage \u0026lt;- ISBSCF$Total.Assets / ISBSCF$Total.stockholders..equity\rDuPontAnalysis \u0026lt;- DuPontAnalysis[Reduce(`\u0026amp;`, lapply(DuPontAnalysis, function(x) !is.nan(x) \u0026amp; !is.infinite(x))),]\rTable 6: DuPont Calculations\r\r\r\rTicker\r\rDate\r\rROE\r\rROS\r\rTurnover\r\rLeverage\r\r\r\r\r\rUN\r\r2018\r\r0.8113550\r\r0.1841630\r\r0.8574744\r\r5.137919\r\r\r\rUN\r\r2017\r\r0.4441265\r\r0.1126873\r\r0.8910177\r\r4.423289\r\r\r\rUN\r\r2016\r\r0.3169867\r\r0.0983439\r\r0.9341473\r\r3.450471\r\r\r\rUN\r\r2015\r\r0.3179610\r\r0.0921497\r\r1.0186240\r\r3.387396\r\r\r\rIBM\r\r2018\r\r0.5196475\r\r0.1096606\r\r0.6450779\r\r7.345916\r\r\r\rIBM\r\r2017\r\r0.3269865\r\r0.0726949\r\r0.6313140\r\r7.124929\r\r\r\rIBM\r\r2016\r\r0.6506632\r\r0.1485504\r\r0.6803354\r\r6.438123\r\r\r\rIBM\r\r2015\r\r0.9248352\r\r0.1613633\r\r0.7397710\r\r7.747511\r\r\r\rGE\r\r2018\r\r-0.7217111\r\r-0.1838178\r\r0.3934118\r\r9.979952\r\r\r\rGE\r\r2017\r\r-0.1514351\r\r-0.0717505\r\r0.3202291\r\r6.590836\r\r\r\rGE\r\r2016\r\r0.0989159\r\r0.0627783\r\r0.3271456\r\r4.816320\r\r\r\rGE\r\r2015\r\r-0.0623397\r\r-0.0528860\r\r0.2349236\r\r5.017615\r\r\r\rF\r\r2018\r\r0.1023322\r\r0.0229328\r\r0.6250019\r\r7.139597\r\r\r\rF\r\r2017\r\r0.2172972\r\r0.0493124\r\r0.6064929\r\r7.265614\r\r\r\rF\r\r2016\r\r0.1573192\r\r0.0302306\r\r0.6379465\r\r8.157388\r\r\r\rF\r\r2015\r\r0.2574192\r\r0.0492986\r\r0.6649239\r\r7.852978\r\r\r\r\r\rCompute the Need for Funds and Working Capital calculations\r########## Create the NFO \u0026amp; WC Calculations #############\r#NFO-WC Analysis\rNFO_WCAnalysis \u0026lt;- data.frame(matrix(\u0026quot;\u0026quot;, nrow = nrow(ISBSCF)))\rNFO_WCAnalysis[,1] \u0026lt;- NULL\rNFO_WCAnalysis$Ticker \u0026lt;- ISBSCF$symbol\rNFO_WCAnalysis$Date \u0026lt;- ISBSCF$year\r#NFO_WC Analysis Calculations\rNFO_WCAnalysis$REC \u0026lt;- ISBSCF$Net.Receivables\rNFO_WCAnalysis$INV \u0026lt;- ISBSCF$Inventory\rNFO_WCAnalysis$OtherCurrentAssetsNotCash \u0026lt;- ISBSCF$Other.Current.Assets\rNFO_WCAnalysis$Payables \u0026lt;- ISBSCF$Accounts.Payable\rNFO_WCAnalysis$SpontaneousFunsIncDeftaxes \u0026lt;- ISBSCF$Total.Current.Liabilities + ISBSCF$Other.Current.Liabilities + ISBSCF$Income.Tax.Expense\r####\rNFO_WCAnalysis$NFO \u0026lt;- NFO_WCAnalysis$REC + NFO_WCAnalysis$INV + NFO_WCAnalysis$OtherCurrentAssetsNotCash - NFO_WCAnalysis$Payables - NFO_WCAnalysis$SpontaneousFunsIncDeftaxes\rNFO_WCAnalysis$LTD \u0026lt;- ISBSCF$Long.Term.Debt\rNFO_WCAnalysis$EQ \u0026lt;- ISBSCF$Total.stockholders..equity\rNFO_WCAnalysis$OtherLongTermLiabilities \u0026lt;- ISBSCF$Minority.Interest + ISBSCF$Other.Liabilities\rNFO_WCAnalysis$FA \u0026lt;- ISBSCF$Total.Assets - ISBSCF$Total.Current.Assets\r###\rNFO_WCAnalysis$WC \u0026lt;- NFO_WCAnalysis$LTD + NFO_WCAnalysis$EQ + NFO_WCAnalysis$OtherLongTermLiabilities - NFO_WCAnalysis$FA\rNFO_WCAnalysis$CreditPlusCashMinus \u0026lt;- NFO_WCAnalysis$NFO - NFO_WCAnalysis$WC\rNFO_WCAnalysis \u0026lt;- NFO_WCAnalysis[Reduce(`\u0026amp;`, lapply(NFO_WCAnalysis, function(x) !is.nan(x) \u0026amp; !is.infinite(x))),]\rLets inspect the result.\nTable 7: NFO WC Analysis\r\r\r\rTicker\r\rDate\r\rREC\r\rINV\r\rOtherCurrentAssetsNotCash\r\rPayables\r\rSpontaneousFunsIncDeftaxes\r\rNFO\r\rLTD\r\rEQ\r\rOtherLongTermLiabilities\r\rFA\r\rWC\r\rCreditPlusCashMinus\r\r\r\r\r\rUN\r\r2018\r\r4822000\r\r4301000\r\r1387000\r\r9121000\r\r25541000\r\r-24152000\r\r21535000\r\r11572000\r\r6462000\r\r43975000\r\r-4406000\r\r-19746000\r\r\r\rUN\r\r2017\r\r4204000\r\r3962000\r\r4356000\r\r8217000\r\r27631000\r\r-23326000\r\r16342000\r\r13629000\r\r7017000\r\r43302000\r\r-6314000\r\r-17012000\r\r\r\rUN\r\r2016\r\r3854000\r\r4278000\r\r1120000\r\r8591000\r\r24870000\r\r-24209000\r\r11011000\r\r16354000\r\r8374000\r\r42545000\r\r-6806000\r\r-17403000\r\r\r\rUN\r\r2015\r\r3416000\r\r4335000\r\r1352000\r\r8296000\r\r24739000\r\r-23932000\r\r9696000\r\r15439000\r\r6986000\r\r39612000\r\r-7491000\r\r-16441000\r\r\r\rIBM\r\r2018\r\r8596000\r\r1682000\r\r2902000\r\r6558000\r\r55526000\r\r-48904000\r\r35681000\r\r16796000\r\r32678000\r\r74236000\r\r10919000\r\r-59823000\r\r\r\rIBM\r\r2017\r\r10380000\r\r1583000\r\r2266000\r\r6451000\r\r59456000\r\r-51678000\r\r39871000\r\r17594000\r\r30528000\r\r75621000\r\r12372000\r\r-64050000\r\r\r\rIBM\r\r2016\r\r10239000\r\r1553000\r\r532000\r\r6209000\r\r51417000\r\r-45302000\r\r34663000\r\r18246000\r\r28286000\r\r73581000\r\r7614000\r\r-52916000\r\r\r\rIBM\r\r2015\r\r9534000\r\r1551000\r\r293000\r\r6028000\r\r51131000\r\r-45781000\r\r33431000\r\r14262000\r\r28533000\r\r67991000\r\r8235000\r\r-54016000\r\r\r\rGE\r\r2018\r\r19874000\r\r19271000\r\r7441000\r\r17153000\r\r70230000\r\r-40797000\r\r95234000\r\r30975000\r\r95765000\r\r213155000\r\r8819000\r\r-49616000\r\r\r\rGE\r\r2017\r\r24209000\r\r19419000\r\r6720000\r\r15172000\r\r76963000\r\r-41787000\r\r108575000\r\r56024000\r\r105102000\r\r252992000\r\r16709000\r\r-58496000\r\r\r\rGE\r\r2016\r\r24076000\r\r22354000\r\r3885000\r\r14435000\r\r90003000\r\r-54123000\r\r105080000\r\r75822000\r\r87728000\r\r233747000\r\r34883000\r\r-89006000\r\r\r\rGE\r\r2015\r\r43013000\r\r22515000\r\r5109000\r\r13680000\r\r172208000\r\r-115251000\r\r144659000\r\r98268000\r\r84011000\r\r212175000\r\r114763000\r\r-230014000\r\r\r\rF\r\r2018\r\r3698000\r\r11220000\r\r2567000\r\r20426000\r\r115087000\r\r-118028000\r\r11833000\r\r35932000\r\r23222000\r\r141891000\r\r-70904000\r\r-47124000\r\r\r\rF\r\r2017\r\r10599000\r\r11176000\r\r3649000\r\r23282000\r\r111404000\r\r-109262000\r\r13174000\r\r35578000\r\r25652000\r\r141695000\r\r-67291000\r\r-41971000\r\r\r\rF\r\r2016\r\r11102000\r\r8898000\r\r3145000\r\r21296000\r\r108742000\r\r-106893000\r\r13222000\r\r29170000\r\r25199000\r\r129490000\r\r-61899000\r\r-44994000\r\r\r\rF\r\r2015\r\r11042000\r\r8319000\r\r2704000\r\r20272000\r\r101301000\r\r-99508000\r\r11060000\r\r28642000\r\r24068000\r\r122338000\r\r-58568000\r\r-40940000\r\r\r\r\rAccording to Miguel Antón:\n*If NFO \u0026gt; WC - ask for credit\n*If NFO \u0026lt; WC - surplus cash\nLets plot the results and analyse them further:\n########## Plot the NFO \u0026amp; WC #############\rsymbol \u0026lt;- NULL\rsymbols \u0026lt;- unique(NFO_WCAnalysis$Ticker)\r# Create the plots for NFO and WC for all symbols\rplotList \u0026lt;- list()\rfor(symbol in symbols){\rplotList[[symbol]] \u0026lt;- ggplot(subset(NFO_WCAnalysis, Ticker %in% symbol)) +\rgeom_line(aes(Date, NFO, group = Ticker, colour = \u0026quot;Blue\u0026quot;)) +\rgeom_line(aes(Date, WC, group = Ticker, colour = \u0026quot;Red\u0026quot;)) +\rlabs(title=paste0(\u0026quot;NFO and WC plot \u0026quot;, symbol), x=\u0026quot;Year\u0026quot;, y=\u0026quot;NFO / WC\u0026quot;) +\rscale_color_manual(labels = c(\u0026quot;NFO\u0026quot;, \u0026quot;WC\u0026quot;), values = c(\u0026quot;Blue\u0026quot;, \u0026quot;Red\u0026quot;)) +\rguides(color=guide_legend(\u0026quot;Legend\u0026quot;)) +\rtheme_tq() +\rtheme(legend.position = \u0026quot;right\u0026quot;)\r}\r# Change the symbols to view the NFO WC plots\rplotList[1]\r## $UN\rplotList[2]\r## $IBM\rplotList[3]\r## $GE\rplotList[4]\r## $F\r# Print the results to a PDF document\r#pdf(\u0026quot;PlotsNFO_WC.pdf\u0026quot;, onefile = TRUE, paper = \u0026quot;USr\u0026quot;) #Uncomment this if you want to save to .pdf\r#plotList\r#dev.off()\r\rPlotting the collection period, inventory days and days of payabales\rWe can also analyse the collection periods for each firm. mm here simply means melted data - which is a way of reshaping a data frame in R, check out the melt functon from the reshape2 package in R if interested.\n########## Collection Period, Days of Inventory and Days of Payable #############\r# Create the plots for Collection Period, Days of Inventory and Days of Payable\rmm \u0026lt;- melt(CashCycle, id = c(\u0026#39;Ticker\u0026#39;, \u0026#39;Date\u0026#39;))\rmm \u0026lt;- mm[mm$variable == \u0026quot;CollectionPeriod\u0026quot; | mm$variable == \u0026quot;DaysofInventory\u0026quot; | mm$variable == \u0026quot;DaysofPayable\u0026quot;,]\rmm$value \u0026lt;- with(mm, ifelse(variable == \u0026quot;DaysofPayable\u0026quot;, -value, value))\rTable 8: Collection Period - Days of Inventory - Days of Payable\r\r\r\rTicker\r\rDate\r\rvariable\r\rvalue\r\r\r\r\r\rUN\r\r2018\r\rCollectionPeriod\r\r34.52258\r\r\r\rUN\r\r2017\r\rCollectionPeriod\r\r28.56669\r\r\r\rUN\r\r2016\r\rCollectionPeriod\r\r26.68621\r\r\r\rUN\r\r2015\r\rCollectionPeriod\r\r23.40517\r\r\r\rIBM\r\r2018\r\rCollectionPeriod\r\r39.42079\r\r\r\rIBM\r\r2017\r\rCollectionPeriod\r\r47.87399\r\r\r\r\r\rPlot the results\r########## Plot the Collection Period, Days of Inventory and Days of Payable #############\rsymbol \u0026lt;- NULL\rsymbols \u0026lt;- unique(mm$Ticker)\rplotListBar \u0026lt;- list()\rfor(symbol in symbols){\rplotListBar[[symbol]] \u0026lt;- ggplot(mm[mm$Ticker == symbol,], aes(Date, value, fill = variable)) + facet_wrap(~ Ticker) +\rgeom_bar(stat=\u0026quot;identity\u0026quot;, position = \u0026quot;dodge\u0026quot;) +\rtheme_tq() +\rtheme(legend.position = \u0026quot;right\u0026quot;)\r}\rplotListBar[1]\r## $UN\rplotListBar[2]\r## $IBM\rplotListBar[3]\r## $GE\rplotListBar[4]\r## $F\r# Print the results to a PDF document\r#pdf(\u0026quot;Plots_OperationalRatios.pdf\u0026quot;, onefile = TRUE, paper = \u0026quot;USr\u0026quot;) #Uncomment if you want to save to .pdf\r#plotListBar\r#dev.off()\r\rAny errors are my own!\rYou can save the results using:\n# library(openxlsx)\r# if(devtools::find_rtools()) Sys.setenv(R_ZIPCMD= file.path(devtools:::get_rtools_path(),\u0026quot;zip\u0026quot;))\r# write.xlsx(CashCycle, \u0026#39;CashCycle.xlsx\u0026#39;)\r# write.xlsx(DuPontAnalysis, \u0026#39;DuPontAnalysis.xlsx\u0026#39;)\r# write.xlsx(NFO_WCAnalysis, \u0026#39;NFO_WCAnalysis.xlsx\u0026#39;)\r# write.xlsx(df, \u0026#39;FinancialsAllCompanies.xlsx\u0026#39;)\r\r","date":1569369600,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1569369600,"objectID":"4043688b5bf365976e9afee6c34ed00f","permalink":"/post/nfo-wc-calculations/nfo-wc-calculations-plots/","publishdate":"2019-09-25T00:00:00Z","relpermalink":"/post/nfo-wc-calculations/nfo-wc-calculations-plots/","section":"post","summary":"I use managerial finance and corporate finance methods to scape and analyse fundamental data from yhaoo and analyse companies DuPont, NFO and WC","tags":["finance","yahoo finance","corporate finance","managerial finance","dupont"],"title":"Need for Funds (NFO) and Working Capital (WC) Calculations","type":"post"},{"authors":null,"categories":["Hackerrank"],"content":"\r\rlibrary(knitr)\rlibrary(kableExtra)\rlibrary(ggplot2)\rlibrary(tidyquant)\rlibrary(dplyr)\rProblem 1: Battery Life Prediction Problem\rThe first problem was to predict how long a laptop would last given the number of hours it was charged. The problem is here\nWe can read in the data directly from the hackerrank website using the following:\nBatteryData \u0026lt;- read.table(file = url(\u0026quot;https://s3.amazonaws.com/hr-testcases/399/assets/trainingdata.txt\u0026quot;), strip.white = TRUE, sep = \u0026#39;,\u0026#39;, header = FALSE, skip = 0)\rTable 1: Battery Life Data\r\r\r\rV1\r\rV2\r\r\r\r\r\r2.81\r\r5.62\r\r\r\r7.14\r\r8.00\r\r\r\r2.72\r\r5.44\r\r\r\r3.87\r\r7.74\r\r\r\r1.90\r\r3.80\r\r\r\r7.82\r\r8.00\r\r\r\r\rAt first thought I applied a simple time series model to the data and obtained poor predictions. I then took a closer look at the actual data by plotting it and it told a different story.\nBatteryData %\u0026gt;%\rggplot(aes(x = V1, y = V2)) + geom_point() +\rstat_smooth(method = \u0026quot;lm\u0026quot;, col = \u0026quot;red\u0026quot;) +\rgeom_vline(xintercept = 4) +\rtheme_tq()\rI drew a horizontal line at 4 hours of battery life and plotted a linear regression line - quite clearly it performs badely and I needed to find a different model or better yet set a threshold and predict all observations whose battery had been charging for 4 or more hours to be fully charged.\nThe model:\nLinearPredictionModel \u0026lt;- function(TestData){\rTrainData \u0026lt;- read.table(file = url(\u0026quot;https://s3.amazonaws.com/hr-testcases/399/assets/trainingdata.txt\u0026quot;), strip.white = TRUE, sep = \u0026#39;,\u0026#39;, header = FALSE, skip = 0)\rTrainData$LessThanFour \u0026lt;- ifelse(TrainData[, 2] \u0026lt; 4, 1, 0)\rLMData \u0026lt;- TrainData %\u0026gt;%\rfilter(LessThanFour == 1)\rLinearModel \u0026lt;- lm(V1 ~ V2, data = LMData) TestData \u0026lt;- data.frame(V2 = TestData)\rSTDOUT \u0026lt;- ifelse(TestData \u0026lt; 4, predict(LinearModel, newdata = TestData), 8)\rreturn(cat(STDOUT))\r}\rThe model basically tells us that if the data is less than 4, then fit a simple linear regression model if it is greater or equal to 4 then just apply an 8 prediction.\nWe can input some new data as follows:\nTestData \u0026lt;- c(5, 8, 1, 0.2, 3.5, 5.6, 4.32)\rLinearPredictionModel(TestData)\r## 8 8 0.5 0.1 1.75 8 8\r\rProblem 2: House Price Prediction Problem using XGBoost\rIn this problem I want to train an XGBoost (Extreme Gradient Boosting) model to predict what a house is going to be based on some characteristics. There is a house price prediction problem on Hackerrank here but I used the pre-installed base R house prices data.\nlibrary(AER)\rlibrary(car)\rlibrary(dplyr)\rlibrary(xgboost)\rlibrary(tidyquant)\rlibrary(Metrics)\rLoad in the data and set factors to numeric for easier pre-processing.\ndata(\u0026quot;HousePrices\u0026quot;)\rdata \u0026lt;- HousePrices %\u0026gt;%\rmutate_if(is.factor, as.numeric)\rTable 2: House Price Data\r\r\r\rprice\r\rlotsize\r\rbedrooms\r\rbathrooms\r\rstories\r\rdriveway\r\rrecreation\r\rfullbase\r\rgasheat\r\raircon\r\rgarage\r\rprefer\r\r\r\r\r\r42000\r\r5850\r\r3\r\r1\r\r2\r\r2\r\r1\r\r2\r\r1\r\r1\r\r1\r\r1\r\r\r\r38500\r\r4000\r\r2\r\r1\r\r1\r\r2\r\r1\r\r1\r\r1\r\r1\r\r0\r\r1\r\r\r\r49500\r\r3060\r\r3\r\r1\r\r1\r\r2\r\r1\r\r1\r\r1\r\r1\r\r0\r\r1\r\r\r\r60500\r\r6650\r\r3\r\r1\r\r2\r\r2\r\r2\r\r1\r\r1\r\r1\r\r0\r\r1\r\r\r\r61000\r\r6360\r\r2\r\r1\r\r1\r\r2\r\r1\r\r1\r\r1\r\r1\r\r0\r\r1\r\r\r\r66000\r\r4160\r\r3\r\r1\r\r1\r\r2\r\r2\r\r2\r\r1\r\r2\r\r0\r\r1\r\r\r\r\rSplit the data between 80% train and 20% testing.\n####################################################################################\r# For this example split between train and test\rsmp_size \u0026lt;- floor(nrow(data) * 0.80)\rtrain_ind \u0026lt;- sample(seq_len(nrow(data)), size = smp_size)\rtrain \u0026lt;- data[train_ind, ]\rtest \u0026lt;- data[-train_ind, ]\rpaste(\u0026quot;Train Dimensions\u0026quot;); dim(train)\r## [1] \u0026quot;Train Dimensions\u0026quot;\r## [1] 436 12\rpaste(\u0026quot;Test Dimensions\u0026quot;); dim(test)\r## [1] \u0026quot;Test Dimensions\u0026quot;\r## [1] 110 12\rI create the function to take the training and testing data, train a model and output the predictions. I omit the cross-validation and hype-parameter tuning here but I will write a post detailing how I use a grid search to find the optimal parameters of an XGBoost model soon, (it takes some explaining of the functions I create).\n####################################################################################\rpredictHouseSales \u0026lt;- function(train_data, test_data){\rx_train \u0026lt;- subset(train_data, select = c(-price))\ry_train \u0026lt;- subset(train_data, select = c(price)) %\u0026gt;% pull(price)\rx_test \u0026lt;- subset(test_data, select = c(-price))\ry_test \u0026lt;- subset(test_data, select = c(price)) %\u0026gt;% pull(price)\rdtrain \u0026lt;- xgb.DMatrix(data = as.matrix(x_train), label = y_train, missing = \u0026quot;NaN\u0026quot;)\rdtest \u0026lt;- xgb.DMatrix(data = as.matrix(x_test), missing = \u0026quot;NaN\u0026quot;)\rparams \u0026lt;- list(\r\u0026quot;eta\u0026quot; = 0.1, \u0026quot;max_depth\u0026quot; = 5, \u0026quot;objective\u0026quot; = \u0026quot;reg:linear\u0026quot;,\r\u0026quot;eval_metric\u0026quot;= \u0026quot;rmse\u0026quot;\r)\rxgb.model \u0026lt;- xgb.train(params, dtrain, nrounds = 100)\rreturn(predict(xgb.model, newdata = dtest))\r}\rmyPredictions \u0026lt;- predictHouseSales(train, test)\rWe can inspect some of the predictions and compare them to the actual preditions below:\n####################################################################################\rmyPredictions %\u0026gt;%\rdata.frame() %\u0026gt;%\rsetNames(c(\u0026quot;myPreds\u0026quot;)) %\u0026gt;%\rmutate(myPreds = round(myPreds, 0)) %\u0026gt;%\rbind_cols(test) %\u0026gt;%\rselect(myPreds, price) %\u0026gt;%\rsample_n(5) %\u0026gt;%\rkable(caption = \u0026quot;Compare predictions to the observed\u0026quot;) %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;), font_size = 12)\rTable 3: Compare predictions to the observed\r\r\r\rmyPreds\r\rprice\r\r\r\r\r\r49942\r\r39000\r\r\r\r117177\r\r115442\r\r\r\r65904\r\r34000\r\r\r\r65651\r\r42000\r\r\r\r48866\r\r65000\r\r\r\r\rCompute the Root Mean Square Error:\n####################################################################################\rmyPredictions %\u0026gt;%\rdata.frame() %\u0026gt;%\rsetNames(c(\u0026quot;myPreds\u0026quot;)) %\u0026gt;%\rmutate(myPreds = round(myPreds, 0)) %\u0026gt;%\rbind_cols(test) %\u0026gt;%\rselect(myPreds, price) %\u0026gt;%\rsummarise(rmse(myPreds, price)) %\u0026gt;%\rkable(caption = \u0026quot;Compute the RMSE\u0026quot;) %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;), font_size = 12)\rTable 4: Compute the RMSE\r\r\r\rrmse(myPreds, price)\r\r\r\r\r\r16266.12\r\r\r\r\rWe can also plot the predictions against the observed using ggplot2:\n####################################################################################\rmyPredictions %\u0026gt;%\rdata.frame() %\u0026gt;%\rsetNames(c(\u0026quot;myPreds\u0026quot;)) %\u0026gt;%\rmutate(myPreds = round(myPreds, 0)) %\u0026gt;%\rbind_cols(test) %\u0026gt;%\rselect(myPreds, price) %\u0026gt;%\rggplot(aes(x = price, y = myPreds)) +\rgeom_point() +\rgeom_smooth(method = \u0026#39;lm\u0026#39;) +\rggtitle(\u0026quot;My predictions vs Actual Price\u0026quot;) +\rtheme_tq()\rThe model does okay without any feature engineering or parameter optimisation using a grid search method.\n\rProblem 3: Imputing missing values - cross section\rFor simplicity I load in the iris dataset and I create some random missing values since the iris data doesn’t have any.\n# Load in the data\rlibrary(missForest)\rdata(iris)\rdata \u0026lt;- iris\rTable 5: Iris dataset\r\r\r\rSepal.Length\r\rSepal.Width\r\rPetal.Length\r\rPetal.Width\r\rSpecies\r\r\r\r\r\r5.1\r\r3.5\r\r1.4\r\r0.2\r\rsetosa\r\r\r\r4.9\r\r3.0\r\r1.4\r\r0.2\r\rsetosa\r\r\r\r4.7\r\r3.2\r\r1.3\r\r0.2\r\rsetosa\r\r\r\r4.6\r\r3.1\r\r1.5\r\r0.2\r\rsetosa\r\r\r\r5.0\r\r3.6\r\r1.4\r\r0.2\r\rsetosa\r\r\r\r5.4\r\r3.9\r\r1.7\r\r0.4\r\rsetosa\r\r\r\r\rI generate some random missing data, i.e. 20% of the data is missing at random (MaR) or Missing Completely at Random (MCaR). This is an important issue for economists since much of the data we collect contains missing values, due to surveys not being filled correctly, or simply data not being very well colelcted. The below model allows us to impute the missing values using machine learning, avoiding simple averaging or simply removing the values all together.\n## [1] \u0026quot;Create some random missing data\u0026quot;\rTable 6: Iris dataset with random missing values\r\r\r\rSepal.Length\r\rSepal.Width\r\rPetal.Length\r\rPetal.Width\r\rSpecies\r\r\r\r\r\r5.1\r\r3.5\r\r1.4\r\r0.2\r\rsetosa\r\r\r\r4.9\r\r3.0\r\r1.4\r\rNA\r\rsetosa\r\r\r\rNA\r\r3.2\r\r1.3\r\r0.2\r\rsetosa\r\r\r\r4.6\r\r3.1\r\rNA\r\r0.2\r\rsetosa\r\r\r\r5.0\r\r3.6\r\rNA\r\r0.2\r\rsetosa\r\r\r\r5.4\r\r3.9\r\rNA\r\r0.4\r\rsetosa\r\r\r\r\rOkay now we can train a series of simple missing value imputation models on the data.\n\rModel 1: randomForest Imputation:\rI won’t discuss the models here but random forests uses a collection of decision trees and averages the results across all trees, which results it some powerful predictions.\n## missForest iteration 1 in progress...done!\r## missForest iteration 2 in progress...done!\r## missForest iteration 3 in progress...done!\r## missForest iteration 4 in progress...done!\r## missForest iteration 5 in progress...done!\r## missForest iteration 6 in progress...done!\r## missForest iteration 7 in progress...done!\rTable 7: Iris dataset\r\r\r\rSepal.Length\r\rSepal.Width\r\rPetal.Length\r\rPetal.Width\r\rSpecies\r\r\r\r\r\r5.100000\r\r3.5\r\r1.400000\r\r0.2000000\r\rsetosa\r\r\r\r4.900000\r\r3.0\r\r1.400000\r\r0.1415167\r\rsetosa\r\r\r\r4.722635\r\r3.2\r\r1.300000\r\r0.2000000\r\rsetosa\r\r\r\r4.600000\r\r3.1\r\r1.197250\r\r0.2000000\r\rsetosa\r\r\r\r5.000000\r\r3.6\r\r1.409930\r\r0.2000000\r\rsetosa\r\r\r\r5.400000\r\r3.9\r\r1.419667\r\r0.4000000\r\rsetosa\r\r\r\r\rLets combine all the data together, filter it down to the actual data, the missing data and the predicted data.\nFor the Sepal.Length data\rTable 8: Compare Sepal Observations\r\r\r\rPredicted_Sepal\r\rActual_Sepal\r\r\r\r\r\r6.3\r\r6.9\r\r\r\r5.1\r\r5.0\r\r\r\r7.0\r\r6.3\r\r\r\r5.7\r\r5.6\r\r\r\r5.1\r\r5.1\r\r\r\r6.2\r\r6.5\r\r\r\r4.7\r\r4.8\r\r\r\r6.0\r\r5.8\r\r\r\r6.0\r\r6.9\r\r\r\r5.6\r\r5.8\r\r\r\r\rWhich isn’t bad! given that we only had 436 observations to train on and only 110 observations to test on. Using randomForest models to impute the data is better than averaging the data on some datasets, of course we have errors the actual observations are somewhat close to the predicted data. I only analyse the Sepal.Length data but substitute the values to find the missing values for the Sepal.Width, Petal.Length, Petal.Width and Species values since missorest imputes categorical variables as well.\n\r\r","date":1569283200,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1569283200,"objectID":"63b2b567c8b113d83d5ce08bc1f2f0d6","permalink":"/post/hackerrank-competitions/hackerrank-compeitions/","publishdate":"2019-09-24T00:00:00Z","relpermalink":"/post/hackerrank-competitions/hackerrank-compeitions/","section":"post","summary":"I show my solutions to a few Hackerrank competitions/problems I had completed and discuss the models and solutions.","tags":["machine learning","hackerrank","time series","xgboost"],"title":"Series of Hackerrank Competitions","type":"post"},{"authors":null,"categories":["Yahoo Finance"],"content":"\r\rlibrary(knitr)\rlibrary(kableExtra)\rlibrary(tidyquant)\rlibrary(directlabels)\rlibrary(tibble)\rlibrary(tidyr)\rlibrary(quantmod)\rI developed a model to collect financial information from Yahoo Finance, I wanted to use this model to understand a little better how to analyse comanies, what ratios are important and to see how companies performances differ from each other.\n# A function to collect fundamental data from Yahoo finance (Income Statement, Balance Sheet and Cash Flow statements, just skip past this part.)\rgetFin \u0026lt;- function(stock){\rif (\u0026quot;rvest\u0026quot; %in% installed.packages()) {\rlibrary(rvest)\r}else{\rinstall.packages(\u0026quot;rvest\u0026quot;)\rlibrary(rvest)\r}\rfor (i in 1:length(stock)) {\rtryCatch(\r{\r# Collect the Income Statement data\rlink \u0026lt;- \u0026quot;https://finance.yahoo.com/quote/\u0026quot;\rlink \u0026lt;- paste0(link, stock[i], \u0026quot;/financials?p=\u0026quot;, stock[i])\rwahis.session \u0026lt;- html_session(link)\rp \u0026lt;- wahis.session %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;Col1-1-Financials-Proxy\u0026quot;]/section/div[3]/table\u0026#39;)%\u0026gt;%\rhtml_table(fill = TRUE)\rIncomeStatement \u0026lt;- p[[1]]\rcolnames(IncomeStatement) \u0026lt;- paste(IncomeStatement[1,])\rIncomeStatement \u0026lt;- IncomeStatement[-c(1,5,12,20,25),]\rnames_row \u0026lt;- paste(IncomeStatement[,1])\rIncomeStatement \u0026lt;- IncomeStatement[,-1]\rIncomeStatement \u0026lt;- apply(IncomeStatement, 2, function(x){gsub(\u0026quot;,\u0026quot;,\u0026quot;\u0026quot;,x)})\rIncomeStatement \u0026lt;- as.data.frame(apply(IncomeStatement, 2, as.numeric))\rrownames(IncomeStatement) \u0026lt;- paste(names_row)\rtemp1 \u0026lt;- IncomeStatement\r# Collect the Balance Sheet data\rlink \u0026lt;- \u0026quot;https://finance.yahoo.com/quote/\u0026quot;\rlink \u0026lt;- paste0(link, stock[i],\u0026quot;/balance-sheet?p=\u0026quot;, stock[i])\rwahis.session \u0026lt;- html_session(link)\rp \u0026lt;- wahis.session %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;Col1-1-Financials-Proxy\u0026quot;]/section/div[3]/table\u0026#39;)%\u0026gt;%\rhtml_table(fill = TRUE)\rBalanceSheet \u0026lt;- p[[1]]\rcolnames(BalanceSheet) \u0026lt;- BalanceSheet[1,]\rBalanceSheet \u0026lt;- BalanceSheet[-c(1,2,17,28),]\rnames_row \u0026lt;- BalanceSheet[,1]\rBalanceSheet \u0026lt;- BalanceSheet[,-1]\rBalanceSheet \u0026lt;- apply(BalanceSheet, 2, function(x){gsub(\u0026quot;,\u0026quot;,\u0026quot;\u0026quot;,x)})\rBalanceSheet \u0026lt;- as.data.frame(apply(BalanceSheet, 2, as.numeric))\rrownames(BalanceSheet) \u0026lt;- paste(names_row)\rtemp2 \u0026lt;- BalanceSheet\r# Collect the Cash Flow data\rlink \u0026lt;- \u0026quot;https://finance.yahoo.com/quote/\u0026quot;\rlink \u0026lt;- paste0(link, stock[i], \u0026quot;/cash-flow?p=\u0026quot;, stock[i])\rwahis.session \u0026lt;- html_session(link)\rp \u0026lt;- wahis.session %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;Col1-1-Financials-Proxy\u0026quot;]/section/div[3]/table\u0026#39;)%\u0026gt;%\rhtml_table(fill = TRUE)\rCashFlow \u0026lt;- p[[1]]\rcolnames(CashFlow) \u0026lt;- CashFlow[1,]\rCashFlow \u0026lt;- CashFlow[-c(1,3,11,16),]\rnames_row \u0026lt;- CashFlow[,1]\rCashFlow \u0026lt;- CashFlow[,-1]\rCashFlow \u0026lt;- apply(CashFlow, 2, function(x){gsub(\u0026quot;,\u0026quot;,\u0026quot;\u0026quot;,x)})\rCashFlow \u0026lt;- as.data.frame(apply(CashFlow, 2, as.numeric))\rrownames(CashFlow) \u0026lt;- paste(names_row)\rtemp3 \u0026lt;- CashFlow\rassign(paste0(stock[i],\u0026#39;.f\u0026#39;),value = list(IncomeStatement = temp1, BalanceSheet = temp2, CashFlow = temp3), envir = parent.frame())\r},\rerror = function(cond){\rmessage(stock[i], \u0026quot;Give error \u0026quot;,cond)\r}\r)\r}\r}\rI firstly scrape the Yahoo Finance website and collect fundamental data for the Income Statement, Balance Sheet, and Cash Flows. I will analyse some well known comparable tech stocks Apple, Amazon, Google, Microsoft and Baidu and see how they all compare.\nsymbols \u0026lt;- c(\u0026quot;AAPL\u0026quot;, \u0026quot;AMZN\u0026quot;, \u0026quot;GOOG\u0026quot;, \u0026quot;MSFT\u0026quot;, \u0026quot;BIDU\u0026quot;)\rgetFin(symbols)\rsymbols.f \u0026lt;- sapply(symbols, function(x) { paste0(x, \u0026quot;.f\u0026quot;) })\rtickers \u0026lt;- list2env(mget(symbols.f))\rIS \u0026lt;- lapply(tickers, \u0026quot;[[\u0026quot;, \u0026quot;IncomeStatement\u0026quot;)\rBS \u0026lt;- lapply(tickers, \u0026quot;[[\u0026quot;, \u0026quot;BalanceSheet\u0026quot;)\rCF \u0026lt;- lapply(tickers, \u0026quot;[[\u0026quot;, \u0026quot;CashFlow\u0026quot;)\rIS \u0026lt;- as.data.frame(IS)\rBS \u0026lt;- as.data.frame(BS)\rCF \u0026lt;- as.data.frame(CF)\rHow the Income Statement looks:\rTable 1: Income Statement\r\r\r\r\rBIDU.f.12.31.2018\r\rBIDU.f.12.31.2017\r\rBIDU.f.12.31.2016\r\rBIDU.f.12.31.2015\r\rMSFT.f.6.30.2019\r\rMSFT.f.6.30.2018\r\rMSFT.f.6.30.2017\r\rMSFT.f.6.30.2016\r\rGOOG.f.12.31.2018\r\rGOOG.f.12.31.2017\r\rGOOG.f.12.31.2016\r\rGOOG.f.12.31.2015\r\rAMZN.f.12.31.2018\r\rAMZN.f.12.31.2017\r\rAMZN.f.12.31.2016\r\rAMZN.f.12.31.2015\r\rAAPL.f.9.29.2018\r\rAAPL.f.9.30.2017\r\rAAPL.f.9.24.2016\r\rAAPL.f.9.26.2015\r\r\r\r\r\rTotal Revenue\r\r103877000\r\r86709000\r\r70549000\r\r66382000\r\r125843000\r\r110360000\r\r96571000\r\r91154000\r\r136819000\r\r110855000\r\r90272000\r\r74989000\r\r232887000\r\r177866000\r\r135987000\r\r107006000\r\r265595000\r\r229234000\r\r215639000\r\r233715000\r\r\r\rCost of Revenue\r\r51744000\r\r38294000\r\r31358000\r\r22814000\r\r42910000\r\r38353000\r\r34261000\r\r32780000\r\r59549000\r\r45583000\r\r35138000\r\r28164000\r\r139156000\r\r111934000\r\r88265000\r\r71651000\r\r163756000\r\r141048000\r\r131376000\r\r140089000\r\r\r\rGross Profit\r\r52133000\r\r48415000\r\r39191000\r\r43568000\r\r82933000\r\r72007000\r\r62310000\r\r58374000\r\r77270000\r\r65272000\r\r55134000\r\r46825000\r\r93731000\r\r65932000\r\r47722000\r\r35355000\r\r101839000\r\r88186000\r\r84263000\r\r93626000\r\r\r\rResearch Development\r\r15772000\r\r12928000\r\r10151000\r\r10176000\r\r16876000\r\r14726000\r\r13037000\r\r11988000\r\r21419000\r\r16625000\r\r13948000\r\r12282000\r\r28837000\r\r22620000\r\r16085000\r\r12540000\r\r14236000\r\r11581000\r\r10045000\r\r8067000\r\r\r\rSelling General and Administrative\r\r19231000\r\r13128000\r\r15071000\r\r17076000\r\r23098000\r\r22223000\r\r19942000\r\r19198000\r\r24459000\r\r19765000\r\r17470000\r\r15183000\r\r52177000\r\r38992000\r\r27284000\r\r20411000\r\r16705000\r\r15261000\r\r14194000\r\r14329000\r\r\r\rNon Recurring\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rOthers\r\rNA\r\r4768000\r\r3920000\r\r4644000\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r296000\r\r214000\r\r167000\r\r171000\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rTotal Operating Expenses\r\r86747000\r\r69118000\r\r60500000\r\r54710000\r\r82884000\r\r75302000\r\r67240000\r\r63966000\r\r105427000\r\r81973000\r\r66556000\r\r55629000\r\r220466000\r\r173760000\r\r131801000\r\r104773000\r\r194697000\r\r167890000\r\r155615000\r\r162485000\r\r\r\rOperating Income or Loss\r\r17130000\r\r17591000\r\r10049000\r\r11672000\r\r42959000\r\r35058000\r\r29331000\r\r27188000\r\r31392000\r\r28882000\r\r23716000\r\r19360000\r\r12421000\r\r4106000\r\r4186000\r\r2233000\r\r70898000\r\r61344000\r\r60024000\r\r71230000\r\r\r\rTotal Other Income/Expenses Net\r\r10195000\r\r3692000\r\r4460000\r\r26235000\r\r729000\r\r1416000\r\r570000\r\r-1549000\r\r3521000\r\r-1689000\r\r434000\r\r291000\r\r-1151000\r\r-304000\r\r-390000\r\r-687000\r\r2005000\r\r2745000\r\r1348000\r\r1285000\r\r\r\rEarnings Before Interest and Taxes\r\r17130000\r\r17591000\r\r10049000\r\r11672000\r\r42959000\r\r35058000\r\r29331000\r\r27188000\r\r31392000\r\r28882000\r\r23716000\r\r19360000\r\r12421000\r\r4106000\r\r4186000\r\r2233000\r\r70898000\r\r61344000\r\r60024000\r\r71230000\r\r\r\rInterest Expense\r\r-3483000\r\r-3515000\r\r-1158000\r\r-1041000\r\r-2686000\r\r-2733000\r\r-2222000\r\r-1243000\r\r-114000\r\r-109000\r\r-124000\r\r-104000\r\r-1417000\r\r-848000\r\r-484000\r\r-459000\r\r-3240000\r\r-2323000\r\r-1456000\r\r-733000\r\r\r\rIncome Before Tax\r\r27325000\r\r21283000\r\r14509000\r\r37907000\r\r43688000\r\r36474000\r\r29901000\r\r25639000\r\r34913000\r\r27193000\r\r24150000\r\r19651000\r\r11270000\r\r3802000\r\r3796000\r\r1546000\r\r72903000\r\r64089000\r\r61372000\r\r72515000\r\r\r\rIncome Tax Expense\r\r4743000\r\r2995000\r\r2913000\r\r5475000\r\r4448000\r\r19903000\r\r4412000\r\r5100000\r\r4177000\r\r14531000\r\r4672000\r\r3303000\r\r1197000\r\r769000\r\r1425000\r\r950000\r\r13372000\r\r15738000\r\r15685000\r\r19121000\r\r\r\rMinority Interest\r\r12855000\r\r15026000\r\r5469000\r\r3960053\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Income From Continuing Ops\r\r22582000\r\r18288000\r\r11596000\r\r32432000\r\r39240000\r\r16571000\r\r25489000\r\r20539000\r\r30736000\r\r12662000\r\r19478000\r\r16348000\r\r10073000\r\r3033000\r\r2371000\r\r596000\r\r59531000\r\r48351000\r\r45687000\r\r53394000\r\r\r\rDiscontinued Operations\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rExtraordinary Items\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rEffect Of Accounting Changes\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rOther Items\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Income\r\r27573000\r\r18301000\r\r11632000\r\r33664000\r\r39240000\r\r16571000\r\r25489000\r\r20539000\r\r30736000\r\r12662000\r\r19478000\r\r16348000\r\r10073000\r\r3033000\r\r2371000\r\r596000\r\r59531000\r\r48351000\r\r45687000\r\r53394000\r\r\r\rPreferred Stock And Other Adjustments\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Income Applicable To Common Shares\r\r27443000\r\r18318000\r\r11075000\r\r33335000\r\r39240000\r\r16571000\r\r25489000\r\r20539000\r\r30736000\r\r12662000\r\r19478000\r\r16348000\r\r10073000\r\r3033000\r\r2371000\r\r596000\r\r59531000\r\r48351000\r\r45687000\r\r53394000\r\r\r\r\r\rHow the Balance Sheet looks:\rTable 2: Balance Sheet\r\r\r\r\rBIDU.f.12.31.2018\r\rBIDU.f.12.31.2017\r\rBIDU.f.12.31.2016\r\rBIDU.f.12.31.2015\r\rMSFT.f.6.30.2019\r\rMSFT.f.6.30.2018\r\rMSFT.f.6.30.2017\r\rMSFT.f.6.30.2016\r\rGOOG.f.12.31.2018\r\rGOOG.f.12.31.2017\r\rGOOG.f.12.31.2016\r\rGOOG.f.12.31.2015\r\rAMZN.f.12.31.2018\r\rAMZN.f.12.31.2017\r\rAMZN.f.12.31.2016\r\rAMZN.f.12.31.2015\r\rAAPL.f.9.29.2018\r\rAAPL.f.9.30.2017\r\rAAPL.f.9.24.2016\r\rAAPL.f.9.26.2015\r\r\r\r\r\rCash And Cash Equivalents\r\r27638000\r\r11084000\r\r10898000\r\r9959932\r\r11356000\r\r11946000\r\r7663000\r\r6510000\r\r16701000\r\r10715000\r\r12918000\r\r15409000\r\r31750000\r\r20522000\r\r19334000\r\r15890000\r\r25913000\r\r20289000\r\r20484000\r\r21120000\r\r\r\rShort Term Investments\r\r111873000\r\r107935000\r\r79183000\r\r58349394\r\r122476000\r\r121718000\r\r125238000\r\r106531000\r\r92439000\r\r91156000\r\r73415000\r\r56517000\r\r9500000\r\r10464000\r\r6647000\r\r3918000\r\r40388000\r\r53892000\r\r46671000\r\r20481000\r\r\r\rNet Receivables\r\r9107000\r\r28989000\r\r6665000\r\r6413180\r\r29524000\r\r26481000\r\r22431000\r\r18277000\r\r21193000\r\r18705000\r\r15632000\r\r13459000\r\r16259000\r\r11835000\r\r8339000\r\r5654000\r\r48995000\r\r35673000\r\r29299000\r\r30343000\r\r\r\rInventory\r\rNA\r\rNA\r\rNA\r\rNA\r\r2063000\r\r2662000\r\r2181000\r\r2251000\r\r1107000\r\r749000\r\r268000\r\r491000\r\r17174000\r\r16047000\r\r11461000\r\r10243000\r\r3956000\r\r4855000\r\r2132000\r\r2349000\r\r\r\rOther Current Assets\r\r5818000\r\r2763000\r\r2625000\r\r3168819\r\r10133000\r\r6855000\r\r5183000\r\r6091000\r\r4236000\r\r2983000\r\r3175000\r\r1590000\r\r418000\r\r1329000\r\rNA\r\rNA\r\r12087000\r\r13936000\r\r8283000\r\r14691000\r\r\r\rTotal Current Assets\r\r155094000\r\r151169000\r\r99760000\r\r78233663\r\r175552000\r\r169662000\r\r162696000\r\r139660000\r\r135676000\r\r124308000\r\r105408000\r\r90114000\r\r75101000\r\r60197000\r\r45781000\r\r35705000\r\r131339000\r\r128645000\r\r106869000\r\r89378000\r\r\r\rLong Term Investments\r\r80647000\r\r56451000\r\r45690000\r\r37958591\r\r2649000\r\r1862000\r\r6023000\r\r10438000\r\r13859000\r\r7813000\r\r5878000\r\r5183000\r\r440000\r\r441000\r\r223000\r\r16000\r\r170799000\r\r194714000\r\r170430000\r\r164065000\r\r\r\rProperty, plant and equipment\r\r17903000\r\r12475000\r\r11294000\r\r10627127\r\r43856000\r\r36146000\r\r30289000\r\r18356000\r\r59719000\r\r42383000\r\r34234000\r\r29016000\r\r61797000\r\r48866000\r\r29114000\r\r21838000\r\r41304000\r\r33783000\r\r27010000\r\r22471000\r\r\r\rGoodwill\r\r18536000\r\r15806000\r\r15342000\r\r15395573\r\r42026000\r\r35683000\r\r35122000\r\r17872000\r\r17888000\r\r16747000\r\r16468000\r\r15869000\r\r14548000\r\r13350000\r\r3784000\r\r3759000\r\rNA\r\rNA\r\r5414000\r\r5116000\r\r\r\rIntangible Assets\r\r9181000\r\r5467000\r\r3872000\r\r3334619\r\r7750000\r\r8053000\r\r10106000\r\r3733000\r\r2220000\r\r2692000\r\r3307000\r\r3847000\r\r4110000\r\r3371000\r\r854000\r\r992000\r\rNA\r\rNA\r\r3206000\r\r3893000\r\r\r\rAccumulated Amortization\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rOther Assets\r\r16205000\r\r10360000\r\r6039000\r\r2303735\r\r14723000\r\r7442000\r\r6076000\r\r3409000\r\r3430000\r\r3352000\r\r2202000\r\r3432000\r\r6652000\r\r5085000\r\r3646000\r\r2437000\r\r22283000\r\r18177000\r\r8757000\r\r5422000\r\r\r\rDeferred Long Term Asset Charges\r\r2324000\r\r1532000\r\r1100000\r\r1008174\r\r7536000\r\r1369000\r\r248000\r\r219000\r\r737000\r\r680000\r\r383000\r\r251000\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rTotal Assets\r\r297566000\r\r251728000\r\r181997000\r\r147853308\r\r286556000\r\r258848000\r\r250312000\r\r193468000\r\r232792000\r\r197295000\r\r167497000\r\r147461000\r\r162648000\r\r131310000\r\r83402000\r\r64747000\r\r365725000\r\r375319000\r\r321686000\r\r290345000\r\r\r\rAccounts Payable\r\r2966000\r\r2300000\r\r2184000\r\r1054936\r\r9382000\r\r8617000\r\r7390000\r\r6898000\r\r4378000\r\r3137000\r\r2041000\r\r1931000\r\r38192000\r\r34616000\r\r25309000\r\r20397000\r\r55888000\r\r44242000\r\r37294000\r\r35490000\r\r\r\rShort/Current Long Term Debt\r\r6955000\r\r6510000\r\r8671000\r\r974820\r\r5516000\r\r3998000\r\r1049000\r\rNA\r\rNA\r\rNA\r\rNA\r\r1000000\r\r1371000\r\r100000\r\r1056000\r\r238000\r\r8784000\r\r6496000\r\r3500000\r\r2513000\r\r\r\rOther Current Liabilities\r\r28841000\r\r60413000\r\r24742000\r\r15975724\r\r45860000\r\r38195000\r\r30879000\r\r33972000\r\r16009000\r\r10651000\r\r5851000\r\r4327000\r\r9959000\r\r8565000\r\r7168000\r\r5118000\r\r40230000\r\r38099000\r\r8243000\r\r10939000\r\r\r\rTotal Current Liabilities\r\r56853000\r\r82057000\r\r46102000\r\r26102802\r\r69420000\r\r58488000\r\r55745000\r\r59357000\r\r34620000\r\r24183000\r\r16756000\r\r19310000\r\r68391000\r\r57883000\r\r43816000\r\r33887000\r\r116866000\r\r100814000\r\r79006000\r\r80610000\r\r\r\rLong Term Debt\r\r54903000\r\r35812000\r\r34470000\r\r33941792\r\r66662000\r\r72242000\r\r76073000\r\r40557000\r\r3950000\r\r3943000\r\r3935000\r\r1995000\r\r23495000\r\r24743000\r\r7694000\r\r8227000\r\r93735000\r\r97207000\r\r75427000\r\r53329000\r\r\r\rOther Liabilities\r\r10058000\r\r3487000\r\r3682000\r\r3584563\r\r35699000\r\r35707000\r\r22986000\r\r20796000\r\r16532000\r\r16641000\r\r7770000\r\r5825000\r\r10921000\r\r7792000\r\r5088000\r\r3301000\r\r47977000\r\r43251000\r\r39004000\r\r37051000\r\r\r\rDeferred Long Term Liability Charges\r\r3700000\r\r1600000\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rMinority Interest\r\r12855000\r\r15026000\r\r5469000\r\r3960053\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNegative Goodwill\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rTotal Liabilities\r\r121814000\r\r121356000\r\r84254000\r\r63637592\r\r184226000\r\r176130000\r\r162601000\r\r121471000\r\r55164000\r\r44793000\r\r28461000\r\r27130000\r\r119099000\r\r103601000\r\r64117000\r\r51363000\r\r258578000\r\r241272000\r\r193437000\r\r170990000\r\r\r\rMisc. Stocks Options Warrants\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rRedeemable Preferred Stock\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rPreferred Stock\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rCommon Stock\r\rNA\r\rNA\r\rNA\r\r15\r\r78520000\r\r71223000\r\r69315000\r\r68178000\r\r45049000\r\r40247000\r\r36307000\r\r32982000\r\r5000\r\r5000\r\r5000\r\r5000\r\r40201000\r\r35867000\r\r31251000\r\r27416000\r\r\r\rRetained Earnings\r\r129246000\r\r102328000\r\r85734000\r\r74659355\r\r24150000\r\r13682000\r\r17769000\r\r2282000\r\r134885000\r\r113247000\r\r105131000\r\r89223000\r\r19625000\r\r8636000\r\r4916000\r\r2545000\r\r70400000\r\r98330000\r\r96364000\r\r92284000\r\r\r\rTreasury Stock\r\r210000\r\r930000\r\r-1783000\r\r-806056\r\r-340000\r\r-2187000\r\r627000\r\r1537000\r\r-2306000\r\r-992000\r\r-2402000\r\r-1874000\r\r-2872000\r\r-2321000\r\r-2822000\r\r-2560000\r\r-3454000\r\r-150000\r\r634000\r\r-345000\r\r\r\rCapital Surplus\r\r33441000\r\r12088000\r\r8323000\r\r6402349\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r26791000\r\r21389000\r\r17186000\r\r13394000\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rOther Stockholder Equity\r\r210000\r\r930000\r\r-1783000\r\r-806056\r\r-340000\r\r-2187000\r\r627000\r\r1537000\r\r-2306000\r\r-992000\r\r-2402000\r\r-1874000\r\r-1035000\r\r-484000\r\r-985000\r\r-723000\r\r-3454000\r\r-150000\r\r634000\r\r-345000\r\r\r\rTotal stockholders’ equity\r\r162897000\r\r115346000\r\r92274000\r\r80255663\r\r102330000\r\r82718000\r\r87711000\r\r71997000\r\r177628000\r\r152502000\r\r139036000\r\r120331000\r\r43549000\r\r27709000\r\r19285000\r\r13384000\r\r107147000\r\r134047000\r\r128249000\r\r119355000\r\r\r\rNet Tangible Assets\r\r135180000\r\r94073000\r\r73060000\r\r61525471\r\r52554000\r\r38982000\r\r42483000\r\r50392000\r\r157520000\r\r133063000\r\r119261000\r\r100615000\r\r24891000\r\r10988000\r\r14647000\r\r8633000\r\r107147000\r\r134047000\r\r119629000\r\r110346000\r\r\r\r\r\rHow the Cash Flow Statement looks:\rTable 3: Cash Flow Statements\r\r\r\r\rBIDU.f.12.31.2018\r\rBIDU.f.12.31.2017\r\rBIDU.f.12.31.2016\r\rBIDU.f.12.31.2015\r\rMSFT.f.6.30.2019\r\rMSFT.f.6.30.2018\r\rMSFT.f.6.30.2017\r\rMSFT.f.6.30.2016\r\rGOOG.f.12.31.2018\r\rGOOG.f.12.31.2017\r\rGOOG.f.12.31.2016\r\rGOOG.f.12.31.2015\r\rAMZN.f.12.31.2018\r\rAMZN.f.12.31.2017\r\rAMZN.f.12.31.2016\r\rAMZN.f.12.31.2015\r\rAAPL.f.9.29.2018\r\rAAPL.f.9.30.2017\r\rAAPL.f.9.24.2016\r\rAAPL.f.9.26.2015\r\r\r\r\r\rNet Income\r\r27573000\r\r18301000\r\r11632000\r\r33664000\r\r39240000\r\r16571000\r\r25489000\r\r20539000\r\r30736000\r\r12662000\r\r19478000\r\r16348000\r\r10073000\r\r3033000\r\r2371000\r\r596000\r\r59531000\r\r48351000\r\r45687000\r\r53394000\r\r\r\rDepreciation\r\r16187000\r\r11748000\r\r8327000\r\r5848000\r\r11600000\r\r9900000\r\r7800000\r\r5878000\r\r9029000\r\r6899000\r\r6100000\r\r5024000\r\r15341000\r\r11478000\r\r8116000\r\r5646000\r\r10903000\r\r10157000\r\r10505000\r\r11257000\r\r\r\rAdjustments To Net Income\r\r-11074000\r\r-3744000\r\r-3721000\r\r-24690000\r\r-2521000\r\r-3054000\r\r1342000\r\r6229000\r\r3298000\r\r8284000\r\r7158000\r\r5609000\r\r6352000\r\r4096000\r\r2869000\r\r2605000\r\r-27694000\r\r10640000\r\r9634000\r\r5353000\r\r\r\rChanges In Accounts Receivables\r\r-1611000\r\r-721000\r\r-238000\r\r-869000\r\r-2812000\r\r-3862000\r\r-1216000\r\r562000\r\r-2169000\r\r-3768000\r\r-2578000\r\r-2094000\r\r-4615000\r\r-4780000\r\r-3436000\r\r-1755000\r\r-5322000\r\r-2093000\r\r527000\r\r417000\r\r\r\rChanges In Liabilities\r\r4942000\r\r6113000\r\r4976000\r\r9228000\r\r4694000\r\r7070000\r\r3901000\r\r2653000\r\r1438000\r\r1121000\r\r333000\r\r246000\r\r4414000\r\r7838000\r\r6985000\r\r5586000\r\r9131000\r\r8340000\r\r563000\r\r6043000\r\r\r\rChanges In Inventories\r\rNA\r\rNA\r\rNA\r\rNA\r\r597000\r\r-465000\r\r50000\r\r600000\r\rNA\r\rNA\r\rNA\r\rNA\r\r-1314000\r\r-3583000\r\r-1426000\r\r-2187000\r\r828000\r\r-2723000\r\r217000\r\r-238000\r\r\r\rChanges In Other Operating Activities\r\r-50000\r\r1131000\r\r1504000\r\r-3423000\r\r-1542000\r\r-459000\r\r349000\r\r-2907000\r\r7890000\r\r3682000\r\r2420000\r\r1618000\r\r472000\r\r283000\r\r1724000\r\r913000\r\r30057000\r\r-8447000\r\r-902000\r\r5040000\r\r\r\rTotal Cash Flow From Operating Activities\r\r35967000\r\r32828000\r\r22480000\r\r19771000\r\r52185000\r\r43884000\r\r39507000\r\r33325000\r\r47971000\r\r37091000\r\r36036000\r\r26572000\r\r30723000\r\r18365000\r\r17203000\r\r12039000\r\r77434000\r\r64225000\r\r66231000\r\r81266000\r\r\r\rCapital Expenditure\r\r-8861000\r\r-4829000\r\r-4215000\r\r-5251000\r\r-13925000\r\r-11632000\r\r-8129000\r\r-8343000\r\r-25139000\r\r-13184000\r\r-10212000\r\r-9950000\r\r-13427000\r\r-11955000\r\r-7804000\r\r-5387000\r\r-13313000\r\r-12451000\r\r-12734000\r\r-11247000\r\r\r\rInvestments\r\r-21668000\r\r-40411000\r\r-21371000\r\r-19665000\r\r540000\r\r6557000\r\r-12511000\r\r-14417000\r\r-1972000\r\r-19448000\r\r-18229000\r\r-13635000\r\r1140000\r\r-3054000\r\r-2663000\r\r-1066000\r\r30845000\r\r-33542000\r\r-32022000\r\r-44417000\r\r\r\rOther Cash flows from Investing Activities\r\r3685000\r\r13000\r\r5000\r\r8000\r\rNA\r\r-98000\r\r-197000\r\r203000\r\rNA\r\r1419000\r\r-1978000\r\r75000\r\r2104000\r\r1897000\r\r1067000\r\r798000\r\r-745000\r\r-124000\r\r-924000\r\r-26000\r\r\r\rTotal Cash Flows From Investing Activities\r\r-34460000\r\r-76949000\r\r-35911000\r\r-31621000\r\r-15773000\r\r-6061000\r\r-46781000\r\r-23950000\r\r-28504000\r\r-31401000\r\r-31165000\r\r-23711000\r\r-12369000\r\r-27084000\r\r-9516000\r\r-6450000\r\r16066000\r\r-46446000\r\r-45977000\r\r-56274000\r\r\r\rDividends Paid\r\rNA\r\rNA\r\rNA\r\rNA\r\r-13811000\r\r-12699000\r\r-11845000\r\r-11006000\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r-13712000\r\r-12769000\r\r-12150000\r\r-11561000\r\r\r\rSale Purchase of Stock\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Borrowings\r\r20727000\r\r23579000\r\r6850000\r\r10352000\r\r-4000000\r\r-10201000\r\r31459000\r\r18283000\r\r-61000\r\r-86000\r\r-1335000\r\r-23000\r\r-7686000\r\r9928000\r\r-3716000\r\r-3882000\r\r432000\r\r29014000\r\r22057000\r\r29305000\r\r\r\rOther Cash Flows from Financing Activities\r\r-3009000\r\r22248000\r\r7421000\r\r3578000\r\r-675000\r\r-971000\r\r-190000\r\r-369000\r\r-4043000\r\r-3366000\r\r-3304000\r\r-2422000\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\rNA\r\r749000\r\r\r\rTotal Cash Flows From Financing Activities\r\r15082000\r\r44557000\r\r14447000\r\r7778000\r\r-36887000\r\r-33590000\r\r8408000\r\r-8393000\r\r-13179000\r\r-8298000\r\r-8332000\r\r-4225000\r\r-7686000\r\r9928000\r\r-3716000\r\r-3882000\r\r-87876000\r\r-17974000\r\r-20890000\r\r-17716000\r\r\r\rEffect Of Exchange Rate Changes\r\r1902000\r\r-316000\r\r144000\r\r179000\r\r-115000\r\r50000\r\r19000\r\r-67000\r\r-302000\r\r405000\r\r-170000\r\r-434000\r\r-351000\r\r713000\r\r-212000\r\r-374000\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rChange In Cash and Cash Equivalents\r\r18491000\r\r120000\r\r1160000\r\r-3893000\r\r-590000\r\r4283000\r\r1153000\r\r915000\r\r5986000\r\r-2203000\r\r-3631000\r\r-1798000\r\r10317000\r\r1922000\r\r3759000\r\r1333000\r\r5624000\r\r-195000\r\r-636000\r\r7276000\r\r\r\r\rThe data still looks a little messy and unreadable and in order to do the calculations we should have the data in a different shape. That is, I find it easier to program calculations column wise instead of rowwise. It’s also easier to combine the data instead of calculating the ratios across different data frames as we have currently.\n\rClean the data up a little bit\rISBSCF \u0026lt;- rbind(IS, BS, CF)\rISBSCF \u0026lt;- ISBSCF %\u0026gt;%\rt() %\u0026gt;%\rdata.frame() %\u0026gt;%\rrownames_to_column(\u0026#39;rn\u0026#39;) %\u0026gt;%\rseparate(rn, into = c(\u0026quot;symbol\u0026quot;, \u0026quot;year\u0026quot;),\rsep = -4, convert = TRUE)\rISBSCF$symbol \u0026lt;- gsub(\u0026quot;(f).*\u0026quot;, \u0026quot;\u0026quot;, ISBSCF$symbol)\rISBSCF$symbol \u0026lt;- gsub(\u0026#39;.$\u0026#39;, \u0026#39;\u0026#39;, ISBSCF$symbol)\rISBSCF$symbol \u0026lt;- gsub(\u0026#39;^X\u0026#39;, \u0026#39;\u0026#39;, ISBSCF$symbol)\r\rHow all the fundamentals look now:\rTable 4: Income Statement - Balance Sheet - Cash Flow\r\r\r\rsymbol\r\ryear\r\rTotal.Revenue\r\rCost.of.Revenue\r\rGross.Profit\r\rResearch.Development\r\rSelling.General.and.Administrative\r\rNon.Recurring\r\rOthers\r\rTotal.Operating.Expenses\r\rOperating.Income.or.Loss\r\rTotal.Other.Income.Expenses.Net\r\rEarnings.Before.Interest.and.Taxes\r\rInterest.Expense\r\rIncome.Before.Tax\r\rIncome.Tax.Expense\r\rMinority.Interest\r\rNet.Income.From.Continuing.Ops\r\rDiscontinued.Operations\r\rExtraordinary.Items\r\rEffect.Of.Accounting.Changes\r\rOther.Items\r\rNet.Income\r\rPreferred.Stock.And.Other.Adjustments\r\rNet.Income.Applicable.To.Common.Shares\r\rCash.And.Cash.Equivalents\r\rShort.Term.Investments\r\rNet.Receivables\r\rInventory\r\rOther.Current.Assets\r\rTotal.Current.Assets\r\rLong.Term.Investments\r\rProperty..plant.and.equipment\r\rGoodwill\r\rIntangible.Assets\r\rAccumulated.Amortization\r\rOther.Assets\r\rDeferred.Long.Term.Asset.Charges\r\rTotal.Assets\r\rAccounts.Payable\r\rShort.Current.Long.Term.Debt\r\rOther.Current.Liabilities\r\rTotal.Current.Liabilities\r\rLong.Term.Debt\r\rOther.Liabilities\r\rDeferred.Long.Term.Liability.Charges\r\rMinority.Interest1\r\rNegative.Goodwill\r\rTotal.Liabilities\r\rMisc..Stocks.Options.Warrants\r\rRedeemable.Preferred.Stock\r\rPreferred.Stock\r\rCommon.Stock\r\rRetained.Earnings\r\rTreasury.Stock\r\rCapital.Surplus\r\rOther.Stockholder.Equity\r\rTotal.stockholders..equity\r\rNet.Tangible.Assets\r\rNet.Income1\r\rDepreciation\r\rAdjustments.To.Net.Income\r\rChanges.In.Accounts.Receivables\r\rChanges.In.Liabilities\r\rChanges.In.Inventories\r\rChanges.In.Other.Operating.Activities\r\rTotal.Cash.Flow.From.Operating.Activities\r\rCapital.Expenditure\r\rInvestments\r\rOther.Cash.flows.from.Investing.Activities\r\rTotal.Cash.Flows.From.Investing.Activities\r\rDividends.Paid\r\rSale.Purchase.of.Stock\r\rNet.Borrowings\r\rOther.Cash.Flows.from.Financing.Activities\r\rTotal.Cash.Flows.From.Financing.Activities\r\rEffect.Of.Exchange.Rate.Changes\r\rChange.In.Cash.and.Cash.Equivalents\r\r\r\r\r\rBIDU\r\r2018\r\r103877000\r\r51744000\r\r52133000\r\r15772000\r\r19231000\r\rNA\r\rNA\r\r86747000\r\r17130000\r\r10195000\r\r17130000\r\r-3483000\r\r27325000\r\r4743000\r\r12855000\r\r22582000\r\rNA\r\rNA\r\rNA\r\rNA\r\r27573000\r\rNA\r\r27443000\r\r27638000\r\r111873000\r\r9107000\r\rNA\r\r5818000\r\r155094000\r\r80647000\r\r17903000\r\r18536000\r\r9181000\r\rNA\r\r16205000\r\r2324000\r\r297566000\r\r2966000\r\r6955000\r\r28841000\r\r56853000\r\r54903000\r\r10058000\r\r3700000\r\r12855000\r\rNA\r\r121814000\r\rNA\r\rNA\r\rNA\r\rNA\r\r129246000\r\r210000\r\r33441000\r\r210000\r\r162897000\r\r135180000\r\r27573000\r\r16187000\r\r-11074000\r\r-1611000\r\r4942000\r\rNA\r\r-50000\r\r35967000\r\r-8861000\r\r-21668000\r\r3685000\r\r-34460000\r\rNA\r\rNA\r\r20727000\r\r-3009000\r\r15082000\r\r1902000\r\r18491000\r\r\r\rBIDU\r\r2017\r\r86709000\r\r38294000\r\r48415000\r\r12928000\r\r13128000\r\rNA\r\r4768000\r\r69118000\r\r17591000\r\r3692000\r\r17591000\r\r-3515000\r\r21283000\r\r2995000\r\r15026000\r\r18288000\r\rNA\r\rNA\r\rNA\r\rNA\r\r18301000\r\rNA\r\r18318000\r\r11084000\r\r107935000\r\r28989000\r\rNA\r\r2763000\r\r151169000\r\r56451000\r\r12475000\r\r15806000\r\r5467000\r\rNA\r\r10360000\r\r1532000\r\r251728000\r\r2300000\r\r6510000\r\r60413000\r\r82057000\r\r35812000\r\r3487000\r\r1600000\r\r15026000\r\rNA\r\r121356000\r\rNA\r\rNA\r\rNA\r\rNA\r\r102328000\r\r930000\r\r12088000\r\r930000\r\r115346000\r\r94073000\r\r18301000\r\r11748000\r\r-3744000\r\r-721000\r\r6113000\r\rNA\r\r1131000\r\r32828000\r\r-4829000\r\r-40411000\r\r13000\r\r-76949000\r\rNA\r\rNA\r\r23579000\r\r22248000\r\r44557000\r\r-316000\r\r120000\r\r\r\rBIDU\r\r2016\r\r70549000\r\r31358000\r\r39191000\r\r10151000\r\r15071000\r\rNA\r\r3920000\r\r60500000\r\r10049000\r\r4460000\r\r10049000\r\r-1158000\r\r14509000\r\r2913000\r\r5469000\r\r11596000\r\rNA\r\rNA\r\rNA\r\rNA\r\r11632000\r\rNA\r\r11075000\r\r10898000\r\r79183000\r\r6665000\r\rNA\r\r2625000\r\r99760000\r\r45690000\r\r11294000\r\r15342000\r\r3872000\r\rNA\r\r6039000\r\r1100000\r\r181997000\r\r2184000\r\r8671000\r\r24742000\r\r46102000\r\r34470000\r\r3682000\r\rNA\r\r5469000\r\rNA\r\r84254000\r\rNA\r\rNA\r\rNA\r\rNA\r\r85734000\r\r-1783000\r\r8323000\r\r-1783000\r\r92274000\r\r73060000\r\r11632000\r\r8327000\r\r-3721000\r\r-238000\r\r4976000\r\rNA\r\r1504000\r\r22480000\r\r-4215000\r\r-21371000\r\r5000\r\r-35911000\r\rNA\r\rNA\r\r6850000\r\r7421000\r\r14447000\r\r144000\r\r1160000\r\r\r\rBIDU\r\r2015\r\r66382000\r\r22814000\r\r43568000\r\r10176000\r\r17076000\r\rNA\r\r4644000\r\r54710000\r\r11672000\r\r26235000\r\r11672000\r\r-1041000\r\r37907000\r\r5475000\r\r3960053\r\r32432000\r\rNA\r\rNA\r\rNA\r\rNA\r\r33664000\r\rNA\r\r33335000\r\r9959932\r\r58349394\r\r6413180\r\rNA\r\r3168819\r\r78233663\r\r37958591\r\r10627127\r\r15395573\r\r3334619\r\rNA\r\r2303735\r\r1008174\r\r147853308\r\r1054936\r\r974820\r\r15975724\r\r26102802\r\r33941792\r\r3584563\r\rNA\r\r3960053\r\rNA\r\r63637592\r\rNA\r\rNA\r\rNA\r\r15\r\r74659355\r\r-806056\r\r6402349\r\r-806056\r\r80255663\r\r61525471\r\r33664000\r\r5848000\r\r-24690000\r\r-869000\r\r9228000\r\rNA\r\r-3423000\r\r19771000\r\r-5251000\r\r-19665000\r\r8000\r\r-31621000\r\rNA\r\rNA\r\r10352000\r\r3578000\r\r7778000\r\r179000\r\r-3893000\r\r\r\rMSFT\r\r2019\r\r125843000\r\r42910000\r\r82933000\r\r16876000\r\r23098000\r\rNA\r\rNA\r\r82884000\r\r42959000\r\r729000\r\r42959000\r\r-2686000\r\r43688000\r\r4448000\r\rNA\r\r39240000\r\rNA\r\rNA\r\rNA\r\rNA\r\r39240000\r\rNA\r\r39240000\r\r11356000\r\r122476000\r\r29524000\r\r2063000\r\r10133000\r\r175552000\r\r2649000\r\r43856000\r\r42026000\r\r7750000\r\rNA\r\r14723000\r\r7536000\r\r286556000\r\r9382000\r\r5516000\r\r45860000\r\r69420000\r\r66662000\r\r35699000\r\rNA\r\rNA\r\rNA\r\r184226000\r\rNA\r\rNA\r\rNA\r\r78520000\r\r24150000\r\r-340000\r\rNA\r\r-340000\r\r102330000\r\r52554000\r\r39240000\r\r11600000\r\r-2521000\r\r-2812000\r\r4694000\r\r597000\r\r-1542000\r\r52185000\r\r-13925000\r\r540000\r\rNA\r\r-15773000\r\r-13811000\r\rNA\r\r-4000000\r\r-675000\r\r-36887000\r\r-115000\r\r-590000\r\r\r\rMSFT\r\r2018\r\r110360000\r\r38353000\r\r72007000\r\r14726000\r\r22223000\r\rNA\r\rNA\r\r75302000\r\r35058000\r\r1416000\r\r35058000\r\r-2733000\r\r36474000\r\r19903000\r\rNA\r\r16571000\r\rNA\r\rNA\r\rNA\r\rNA\r\r16571000\r\rNA\r\r16571000\r\r11946000\r\r121718000\r\r26481000\r\r2662000\r\r6855000\r\r169662000\r\r1862000\r\r36146000\r\r35683000\r\r8053000\r\rNA\r\r7442000\r\r1369000\r\r258848000\r\r8617000\r\r3998000\r\r38195000\r\r58488000\r\r72242000\r\r35707000\r\rNA\r\rNA\r\rNA\r\r176130000\r\rNA\r\rNA\r\rNA\r\r71223000\r\r13682000\r\r-2187000\r\rNA\r\r-2187000\r\r82718000\r\r38982000\r\r16571000\r\r9900000\r\r-3054000\r\r-3862000\r\r7070000\r\r-465000\r\r-459000\r\r43884000\r\r-11632000\r\r6557000\r\r-98000\r\r-6061000\r\r-12699000\r\rNA\r\r-10201000\r\r-971000\r\r-33590000\r\r50000\r\r4283000\r\r\r\rMSFT\r\r2017\r\r96571000\r\r34261000\r\r62310000\r\r13037000\r\r19942000\r\rNA\r\rNA\r\r67240000\r\r29331000\r\r570000\r\r29331000\r\r-2222000\r\r29901000\r\r4412000\r\rNA\r\r25489000\r\rNA\r\rNA\r\rNA\r\rNA\r\r25489000\r\rNA\r\r25489000\r\r7663000\r\r125238000\r\r22431000\r\r2181000\r\r5183000\r\r162696000\r\r6023000\r\r30289000\r\r35122000\r\r10106000\r\rNA\r\r6076000\r\r248000\r\r250312000\r\r7390000\r\r1049000\r\r30879000\r\r55745000\r\r76073000\r\r22986000\r\rNA\r\rNA\r\rNA\r\r162601000\r\rNA\r\rNA\r\rNA\r\r69315000\r\r17769000\r\r627000\r\rNA\r\r627000\r\r87711000\r\r42483000\r\r25489000\r\r7800000\r\r1342000\r\r-1216000\r\r3901000\r\r50000\r\r349000\r\r39507000\r\r-8129000\r\r-12511000\r\r-197000\r\r-46781000\r\r-11845000\r\rNA\r\r31459000\r\r-190000\r\r8408000\r\r19000\r\r1153000\r\r\r\rMSFT\r\r2016\r\r91154000\r\r32780000\r\r58374000\r\r11988000\r\r19198000\r\rNA\r\rNA\r\r63966000\r\r27188000\r\r-1549000\r\r27188000\r\r-1243000\r\r25639000\r\r5100000\r\rNA\r\r20539000\r\rNA\r\rNA\r\rNA\r\rNA\r\r20539000\r\rNA\r\r20539000\r\r6510000\r\r106531000\r\r18277000\r\r2251000\r\r6091000\r\r139660000\r\r10438000\r\r18356000\r\r17872000\r\r3733000\r\rNA\r\r3409000\r\r219000\r\r193468000\r\r6898000\r\rNA\r\r33972000\r\r59357000\r\r40557000\r\r20796000\r\rNA\r\rNA\r\rNA\r\r121471000\r\rNA\r\rNA\r\rNA\r\r68178000\r\r2282000\r\r1537000\r\rNA\r\r1537000\r\r71997000\r\r50392000\r\r20539000\r\r5878000\r\r6229000\r\r562000\r\r2653000\r\r600000\r\r-2907000\r\r33325000\r\r-8343000\r\r-14417000\r\r203000\r\r-23950000\r\r-11006000\r\rNA\r\r18283000\r\r-369000\r\r-8393000\r\r-67000\r\r915000\r\r\r\rGOOG\r\r2018\r\r136819000\r\r59549000\r\r77270000\r\r21419000\r\r24459000\r\rNA\r\rNA\r\r105427000\r\r31392000\r\r3521000\r\r31392000\r\r-114000\r\r34913000\r\r4177000\r\rNA\r\r30736000\r\rNA\r\rNA\r\rNA\r\rNA\r\r30736000\r\rNA\r\r30736000\r\r16701000\r\r92439000\r\r21193000\r\r1107000\r\r4236000\r\r135676000\r\r13859000\r\r59719000\r\r17888000\r\r2220000\r\rNA\r\r3430000\r\r737000\r\r232792000\r\r4378000\r\rNA\r\r16009000\r\r34620000\r\r3950000\r\r16532000\r\rNA\r\rNA\r\rNA\r\r55164000\r\rNA\r\rNA\r\rNA\r\r45049000\r\r134885000\r\r-2306000\r\rNA\r\r-2306000\r\r177628000\r\r157520000\r\r30736000\r\r9029000\r\r3298000\r\r-2169000\r\r1438000\r\rNA\r\r7890000\r\r47971000\r\r-25139000\r\r-1972000\r\rNA\r\r-28504000\r\rNA\r\rNA\r\r-61000\r\r-4043000\r\r-13179000\r\r-302000\r\r5986000\r\r\r\rGOOG\r\r2017\r\r110855000\r\r45583000\r\r65272000\r\r16625000\r\r19765000\r\rNA\r\rNA\r\r81973000\r\r28882000\r\r-1689000\r\r28882000\r\r-109000\r\r27193000\r\r14531000\r\rNA\r\r12662000\r\rNA\r\rNA\r\rNA\r\rNA\r\r12662000\r\rNA\r\r12662000\r\r10715000\r\r91156000\r\r18705000\r\r749000\r\r2983000\r\r124308000\r\r7813000\r\r42383000\r\r16747000\r\r2692000\r\rNA\r\r3352000\r\r680000\r\r197295000\r\r3137000\r\rNA\r\r10651000\r\r24183000\r\r3943000\r\r16641000\r\rNA\r\rNA\r\rNA\r\r44793000\r\rNA\r\rNA\r\rNA\r\r40247000\r\r113247000\r\r-992000\r\rNA\r\r-992000\r\r152502000\r\r133063000\r\r12662000\r\r6899000\r\r8284000\r\r-3768000\r\r1121000\r\rNA\r\r3682000\r\r37091000\r\r-13184000\r\r-19448000\r\r1419000\r\r-31401000\r\rNA\r\rNA\r\r-86000\r\r-3366000\r\r-8298000\r\r405000\r\r-2203000\r\r\r\rGOOG\r\r2016\r\r90272000\r\r35138000\r\r55134000\r\r13948000\r\r17470000\r\rNA\r\rNA\r\r66556000\r\r23716000\r\r434000\r\r23716000\r\r-124000\r\r24150000\r\r4672000\r\rNA\r\r19478000\r\rNA\r\rNA\r\rNA\r\rNA\r\r19478000\r\rNA\r\r19478000\r\r12918000\r\r73415000\r\r15632000\r\r268000\r\r3175000\r\r105408000\r\r5878000\r\r34234000\r\r16468000\r\r3307000\r\rNA\r\r2202000\r\r383000\r\r167497000\r\r2041000\r\rNA\r\r5851000\r\r16756000\r\r3935000\r\r7770000\r\rNA\r\rNA\r\rNA\r\r28461000\r\rNA\r\rNA\r\rNA\r\r36307000\r\r105131000\r\r-2402000\r\rNA\r\r-2402000\r\r139036000\r\r119261000\r\r19478000\r\r6100000\r\r7158000\r\r-2578000\r\r333000\r\rNA\r\r2420000\r\r36036000\r\r-10212000\r\r-18229000\r\r-1978000\r\r-31165000\r\rNA\r\rNA\r\r-1335000\r\r-3304000\r\r-8332000\r\r-170000\r\r-3631000\r\r\r\rGOOG\r\r2015\r\r74989000\r\r28164000\r\r46825000\r\r12282000\r\r15183000\r\rNA\r\rNA\r\r55629000\r\r19360000\r\r291000\r\r19360000\r\r-104000\r\r19651000\r\r3303000\r\rNA\r\r16348000\r\rNA\r\rNA\r\rNA\r\rNA\r\r16348000\r\rNA\r\r16348000\r\r15409000\r\r56517000\r\r13459000\r\r491000\r\r1590000\r\r90114000\r\r5183000\r\r29016000\r\r15869000\r\r3847000\r\rNA\r\r3432000\r\r251000\r\r147461000\r\r1931000\r\r1000000\r\r4327000\r\r19310000\r\r1995000\r\r5825000\r\rNA\r\rNA\r\rNA\r\r27130000\r\rNA\r\rNA\r\rNA\r\r32982000\r\r89223000\r\r-1874000\r\rNA\r\r-1874000\r\r120331000\r\r100615000\r\r16348000\r\r5024000\r\r5609000\r\r-2094000\r\r246000\r\rNA\r\r1618000\r\r26572000\r\r-9950000\r\r-13635000\r\r75000\r\r-23711000\r\rNA\r\rNA\r\r-23000\r\r-2422000\r\r-4225000\r\r-434000\r\r-1798000\r\r\r\rAMZN\r\r2018\r\r232887000\r\r139156000\r\r93731000\r\r28837000\r\r52177000\r\rNA\r\r296000\r\r220466000\r\r12421000\r\r-1151000\r\r12421000\r\r-1417000\r\r11270000\r\r1197000\r\rNA\r\r10073000\r\rNA\r\rNA\r\rNA\r\rNA\r\r10073000\r\rNA\r\r10073000\r\r31750000\r\r9500000\r\r16259000\r\r17174000\r\r418000\r\r75101000\r\r440000\r\r61797000\r\r14548000\r\r4110000\r\rNA\r\r6652000\r\rNA\r\r162648000\r\r38192000\r\r1371000\r\r9959000\r\r68391000\r\r23495000\r\r10921000\r\rNA\r\rNA\r\rNA\r\r119099000\r\rNA\r\rNA\r\rNA\r\r5000\r\r19625000\r\r-2872000\r\r26791000\r\r-1035000\r\r43549000\r\r24891000\r\r10073000\r\r15341000\r\r6352000\r\r-4615000\r\r4414000\r\r-1314000\r\r472000\r\r30723000\r\r-13427000\r\r1140000\r\r2104000\r\r-12369000\r\rNA\r\rNA\r\r-7686000\r\rNA\r\r-7686000\r\r-351000\r\r10317000\r\r\r\rAMZN\r\r2017\r\r177866000\r\r111934000\r\r65932000\r\r22620000\r\r38992000\r\rNA\r\r214000\r\r173760000\r\r4106000\r\r-304000\r\r4106000\r\r-848000\r\r3802000\r\r769000\r\rNA\r\r3033000\r\rNA\r\rNA\r\rNA\r\rNA\r\r3033000\r\rNA\r\r3033000\r\r20522000\r\r10464000\r\r11835000\r\r16047000\r\r1329000\r\r60197000\r\r441000\r\r48866000\r\r13350000\r\r3371000\r\rNA\r\r5085000\r\rNA\r\r131310000\r\r34616000\r\r100000\r\r8565000\r\r57883000\r\r24743000\r\r7792000\r\rNA\r\rNA\r\rNA\r\r103601000\r\rNA\r\rNA\r\rNA\r\r5000\r\r8636000\r\r-2321000\r\r21389000\r\r-484000\r\r27709000\r\r10988000\r\r3033000\r\r11478000\r\r4096000\r\r-4780000\r\r7838000\r\r-3583000\r\r283000\r\r18365000\r\r-11955000\r\r-3054000\r\r1897000\r\r-27084000\r\rNA\r\rNA\r\r9928000\r\rNA\r\r9928000\r\r713000\r\r1922000\r\r\r\rAMZN\r\r2016\r\r135987000\r\r88265000\r\r47722000\r\r16085000\r\r27284000\r\rNA\r\r167000\r\r131801000\r\r4186000\r\r-390000\r\r4186000\r\r-484000\r\r3796000\r\r1425000\r\rNA\r\r2371000\r\rNA\r\rNA\r\rNA\r\rNA\r\r2371000\r\rNA\r\r2371000\r\r19334000\r\r6647000\r\r8339000\r\r11461000\r\rNA\r\r45781000\r\r223000\r\r29114000\r\r3784000\r\r854000\r\rNA\r\r3646000\r\rNA\r\r83402000\r\r25309000\r\r1056000\r\r7168000\r\r43816000\r\r7694000\r\r5088000\r\rNA\r\rNA\r\rNA\r\r64117000\r\rNA\r\rNA\r\rNA\r\r5000\r\r4916000\r\r-2822000\r\r17186000\r\r-985000\r\r19285000\r\r14647000\r\r2371000\r\r8116000\r\r2869000\r\r-3436000\r\r6985000\r\r-1426000\r\r1724000\r\r17203000\r\r-7804000\r\r-2663000\r\r1067000\r\r-9516000\r\rNA\r\rNA\r\r-3716000\r\rNA\r\r-3716000\r\r-212000\r\r3759000\r\r\r\rAMZN\r\r2015\r\r107006000\r\r71651000\r\r35355000\r\r12540000\r\r20411000\r\rNA\r\r171000\r\r104773000\r\r2233000\r\r-687000\r\r2233000\r\r-459000\r\r1546000\r\r950000\r\rNA\r\r596000\r\rNA\r\rNA\r\rNA\r\rNA\r\r596000\r\rNA\r\r596000\r\r15890000\r\r3918000\r\r5654000\r\r10243000\r\rNA\r\r35705000\r\r16000\r\r21838000\r\r3759000\r\r992000\r\rNA\r\r2437000\r\rNA\r\r64747000\r\r20397000\r\r238000\r\r5118000\r\r33887000\r\r8227000\r\r3301000\r\rNA\r\rNA\r\rNA\r\r51363000\r\rNA\r\rNA\r\rNA\r\r5000\r\r2545000\r\r-2560000\r\r13394000\r\r-723000\r\r13384000\r\r8633000\r\r596000\r\r5646000\r\r2605000\r\r-1755000\r\r5586000\r\r-2187000\r\r913000\r\r12039000\r\r-5387000\r\r-1066000\r\r798000\r\r-6450000\r\rNA\r\rNA\r\r-3882000\r\rNA\r\r-3882000\r\r-374000\r\r1333000\r\r\r\rAAPL\r\r2018\r\r265595000\r\r163756000\r\r101839000\r\r14236000\r\r16705000\r\rNA\r\rNA\r\r194697000\r\r70898000\r\r2005000\r\r70898000\r\r-3240000\r\r72903000\r\r13372000\r\rNA\r\r59531000\r\rNA\r\rNA\r\rNA\r\rNA\r\r59531000\r\rNA\r\r59531000\r\r25913000\r\r40388000\r\r48995000\r\r3956000\r\r12087000\r\r131339000\r\r170799000\r\r41304000\r\rNA\r\rNA\r\rNA\r\r22283000\r\rNA\r\r365725000\r\r55888000\r\r8784000\r\r40230000\r\r116866000\r\r93735000\r\r47977000\r\rNA\r\rNA\r\rNA\r\r258578000\r\rNA\r\rNA\r\rNA\r\r40201000\r\r70400000\r\r-3454000\r\rNA\r\r-3454000\r\r107147000\r\r107147000\r\r59531000\r\r10903000\r\r-27694000\r\r-5322000\r\r9131000\r\r828000\r\r30057000\r\r77434000\r\r-13313000\r\r30845000\r\r-745000\r\r16066000\r\r-13712000\r\rNA\r\r432000\r\rNA\r\r-87876000\r\rNA\r\r5624000\r\r\r\rAAPL\r\r2017\r\r229234000\r\r141048000\r\r88186000\r\r11581000\r\r15261000\r\rNA\r\rNA\r\r167890000\r\r61344000\r\r2745000\r\r61344000\r\r-2323000\r\r64089000\r\r15738000\r\rNA\r\r48351000\r\rNA\r\rNA\r\rNA\r\rNA\r\r48351000\r\rNA\r\r48351000\r\r20289000\r\r53892000\r\r35673000\r\r4855000\r\r13936000\r\r128645000\r\r194714000\r\r33783000\r\rNA\r\rNA\r\rNA\r\r18177000\r\rNA\r\r375319000\r\r44242000\r\r6496000\r\r38099000\r\r100814000\r\r97207000\r\r43251000\r\rNA\r\rNA\r\rNA\r\r241272000\r\rNA\r\rNA\r\rNA\r\r35867000\r\r98330000\r\r-150000\r\rNA\r\r-150000\r\r134047000\r\r134047000\r\r48351000\r\r10157000\r\r10640000\r\r-2093000\r\r8340000\r\r-2723000\r\r-8447000\r\r64225000\r\r-12451000\r\r-33542000\r\r-124000\r\r-46446000\r\r-12769000\r\rNA\r\r29014000\r\rNA\r\r-17974000\r\rNA\r\r-195000\r\r\r\rAAPL\r\r2016\r\r215639000\r\r131376000\r\r84263000\r\r10045000\r\r14194000\r\rNA\r\rNA\r\r155615000\r\r60024000\r\r1348000\r\r60024000\r\r-1456000\r\r61372000\r\r15685000\r\rNA\r\r45687000\r\rNA\r\rNA\r\rNA\r\rNA\r\r45687000\r\rNA\r\r45687000\r\r20484000\r\r46671000\r\r29299000\r\r2132000\r\r8283000\r\r106869000\r\r170430000\r\r27010000\r\r5414000\r\r3206000\r\rNA\r\r8757000\r\rNA\r\r321686000\r\r37294000\r\r3500000\r\r8243000\r\r79006000\r\r75427000\r\r39004000\r\rNA\r\rNA\r\rNA\r\r193437000\r\rNA\r\rNA\r\rNA\r\r31251000\r\r96364000\r\r634000\r\rNA\r\r634000\r\r128249000\r\r119629000\r\r45687000\r\r10505000\r\r9634000\r\r527000\r\r563000\r\r217000\r\r-902000\r\r66231000\r\r-12734000\r\r-32022000\r\r-924000\r\r-45977000\r\r-12150000\r\rNA\r\r22057000\r\rNA\r\r-20890000\r\rNA\r\r-636000\r\r\r\rAAPL\r\r2015\r\r233715000\r\r140089000\r\r93626000\r\r8067000\r\r14329000\r\rNA\r\rNA\r\r162485000\r\r71230000\r\r1285000\r\r71230000\r\r-733000\r\r72515000\r\r19121000\r\rNA\r\r53394000\r\rNA\r\rNA\r\rNA\r\rNA\r\r53394000\r\rNA\r\r53394000\r\r21120000\r\r20481000\r\r30343000\r\r2349000\r\r14691000\r\r89378000\r\r164065000\r\r22471000\r\r5116000\r\r3893000\r\rNA\r\r5422000\r\rNA\r\r290345000\r\r35490000\r\r2513000\r\r10939000\r\r80610000\r\r53329000\r\r37051000\r\rNA\r\rNA\r\rNA\r\r170990000\r\rNA\r\rNA\r\rNA\r\r27416000\r\r92284000\r\r-345000\r\rNA\r\r-345000\r\r119355000\r\r110346000\r\r53394000\r\r11257000\r\r5353000\r\r417000\r\r6043000\r\r-238000\r\r5040000\r\r81266000\r\r-11247000\r\r-44417000\r\r-26000\r\r-56274000\r\r-11561000\r\rNA\r\r29305000\r\r749000\r\r-17716000\r\rNA\r\r7276000\r\r\r\r\rThis looks much cleaner. The data we currently have at the moment is just the Income Statement, Balance Sheet, and Cash Flow statements, but in order to make better comparisons across firms other information is needed such as Shares Outstanding which will be used in the Market Capitalisation calculation. We can use the quantmod package to pull some statistics from the Yahoo Finance statistics page.\n############################## Get stats data ##################################\rmetrics \u0026lt;- yahooQF(c(\u0026quot;Name\u0026quot;, \u0026quot;Enterprise Value\u0026quot;, \u0026quot;Enterprise Value/Revenue\u0026quot;, \u0026quot;Enterprise Value/EBITDA\u0026quot;, \u0026quot;Total Cash Per Share (mrq)\u0026quot;, \u0026quot;EBITDA\u0026quot;, \u0026quot;Volume\u0026quot;, \u0026quot;P/E Ratio\u0026quot;, \u0026quot;Dividend Yield\u0026quot;, \u0026quot;Shares Outstanding\u0026quot;, \u0026quot;Price/Book\u0026quot;))\rstats \u0026lt;- getQuote(symbols, what = metrics) %\u0026gt;%\rrownames_to_column(\u0026quot;symbol\u0026quot;)\rcolnames(stats) \u0026lt;- gsub(\u0026quot; \u0026quot;, \u0026quot;.\u0026quot;, colnames(stats))\rcolnames(stats) \u0026lt;- gsub(\u0026quot;/\u0026quot;, \u0026quot;.\u0026quot;, colnames(stats))\r\rHow the company statistics look:\rTable 5: Company Statistics\r\r\r\rsymbol\r\rTrade.Time\r\rName\r\rVolume\r\rP.E.Ratio\r\rDividend.Yield\r\rShares.Outstanding\r\rPrice.Book\r\r\r\r\r\rAAPL\r\r2019-09-25 16:00:01\r\rApple Inc. \r19675563\r\r18.767937\r\r0.0135979\r\r4519179776\r\r10.383821\r\r\r\rAMZN\r\r2019-09-25 16:00:01\r\rAmazon.com, Inc. \r3217392\r\r73.362510\r\rNA\r\r494656000\r\r16.463211\r\r\r\rGOOG\r\r2019-09-25 16:00:01\r\rAlphabet Inc. \r1345323\r\r25.164429\r\rNA\r\r347344992\r\r4.501470\r\r\r\rMSFT\r\r2019-09-25 16:00:01\r\rMicrosoft Corporation\r\r20835063\r\r27.541502\r\r0.0133935\r\r7635409920\r\r10.408545\r\r\r\rBIDU\r\r2019-09-25 16:00:01\r\rBaidu, Inc. \r3734534\r\r8.009974\r\rNA\r\r348540992\r\r1.476227\r\r\r\r\rYou can play around with downloading other statistics directly from the Yahoo Statistics pages, for instance, heres the statistics page for GOOG here. Already we have quite a bit of useful information, however not all of the statistics are able to be scraped from the Yahoo Finance statistics pages, therefore we will have to try and compute some ourselves. Moreover, we have some of the important statistics - Shares Outstanding and we can use the PE.Ratio, Dividend.Yield and Price.Book ratios to check the accuracy of our calculations later on.\nWe also need to collect the stock price data since we need the Closing Price today to compute per share statistics.\n############################## Get latest stock price data ######################\rstocks \u0026lt;- symbols %\u0026gt;%\rtq_get(get = \u0026quot;stock.prices\u0026quot;,\rfrom = \u0026quot;2018-01-01\u0026quot;,\rto = Sys.Date()) %\u0026gt;%\rselect(symbol, date, adjusted) %\u0026gt;%\rgroup_by(symbol) %\u0026gt;%\rarrange(desc(date)) %\u0026gt;%\rslice(1)\r\rHow the stock price data looks:\rTable 6: Most Recent Stock Prices\r\r\r\rsymbol\r\rdate\r\radjusted\r\r\r\r\r\rAAPL\r\r2019-09-25\r\r221.03\r\r\r\rAMZN\r\r2019-09-25\r\r1768.33\r\r\r\rBIDU\r\r2019-09-25\r\r102.80\r\r\r\rGOOG\r\r2019-09-25\r\r1246.52\r\r\r\rMSFT\r\r2019-09-25\r\r139.36\r\r\r\r\rWe have three different data sets now ISBSCF, which is our combined Income Statement, Balance Sheet and Cash Flow statements, stats which is our Yahoo Finance company statistics data and finally stock which is todays closing price of our companies.\nNow I join all the data together (we are only interested in 2018 values but we could extend it to more years).\n############################## Join all 3 datasets together ######################\rfinancials \u0026lt;- ISBSCF %\u0026gt;%\rfilter(year == 2018) %\u0026gt;%\rinner_join(stats, by = \u0026quot;symbol\u0026quot;) %\u0026gt;%\rinner_join(stocks, by = \u0026quot;symbol\u0026quot;)\r\rHow all the data looks after joining the fundamentals, stats and latest share price data:\rTable 7: All Data\r\r\r\rsymbol\r\ryear\r\rTotal.Revenue\r\rCost.of.Revenue\r\rGross.Profit\r\rResearch.Development\r\rSelling.General.and.Administrative\r\rNon.Recurring\r\rOthers\r\rTotal.Operating.Expenses\r\rOperating.Income.or.Loss\r\rTotal.Other.Income.Expenses.Net\r\rEarnings.Before.Interest.and.Taxes\r\rInterest.Expense\r\rIncome.Before.Tax\r\rIncome.Tax.Expense\r\rMinority.Interest\r\rNet.Income.From.Continuing.Ops\r\rDiscontinued.Operations\r\rExtraordinary.Items\r\rEffect.Of.Accounting.Changes\r\rOther.Items\r\rNet.Income\r\rPreferred.Stock.And.Other.Adjustments\r\rNet.Income.Applicable.To.Common.Shares\r\rCash.And.Cash.Equivalents\r\rShort.Term.Investments\r\rNet.Receivables\r\rInventory\r\rOther.Current.Assets\r\rTotal.Current.Assets\r\rLong.Term.Investments\r\rProperty..plant.and.equipment\r\rGoodwill\r\rIntangible.Assets\r\rAccumulated.Amortization\r\rOther.Assets\r\rDeferred.Long.Term.Asset.Charges\r\rTotal.Assets\r\rAccounts.Payable\r\rShort.Current.Long.Term.Debt\r\rOther.Current.Liabilities\r\rTotal.Current.Liabilities\r\rLong.Term.Debt\r\rOther.Liabilities\r\rDeferred.Long.Term.Liability.Charges\r\rMinority.Interest1\r\rNegative.Goodwill\r\rTotal.Liabilities\r\rMisc..Stocks.Options.Warrants\r\rRedeemable.Preferred.Stock\r\rPreferred.Stock\r\rCommon.Stock\r\rRetained.Earnings\r\rTreasury.Stock\r\rCapital.Surplus\r\rOther.Stockholder.Equity\r\rTotal.stockholders..equity\r\rNet.Tangible.Assets\r\rNet.Income1\r\rDepreciation\r\rAdjustments.To.Net.Income\r\rChanges.In.Accounts.Receivables\r\rChanges.In.Liabilities\r\rChanges.In.Inventories\r\rChanges.In.Other.Operating.Activities\r\rTotal.Cash.Flow.From.Operating.Activities\r\rCapital.Expenditure\r\rInvestments\r\rOther.Cash.flows.from.Investing.Activities\r\rTotal.Cash.Flows.From.Investing.Activities\r\rDividends.Paid\r\rSale.Purchase.of.Stock\r\rNet.Borrowings\r\rOther.Cash.Flows.from.Financing.Activities\r\rTotal.Cash.Flows.From.Financing.Activities\r\rEffect.Of.Exchange.Rate.Changes\r\rChange.In.Cash.and.Cash.Equivalents\r\rTrade.Time\r\rName\r\rVolume\r\rP.E.Ratio\r\rDividend.Yield\r\rShares.Outstanding\r\rPrice.Book\r\rdate\r\radjusted\r\r\r\r\r\rBIDU\r\r2018\r\r103877000\r\r51744000\r\r52133000\r\r15772000\r\r19231000\r\rNA\r\rNA\r\r86747000\r\r17130000\r\r10195000\r\r17130000\r\r-3483000\r\r27325000\r\r4743000\r\r12855000\r\r22582000\r\rNA\r\rNA\r\rNA\r\rNA\r\r27573000\r\rNA\r\r27443000\r\r27638000\r\r111873000\r\r9107000\r\rNA\r\r5818000\r\r155094000\r\r80647000\r\r17903000\r\r18536000\r\r9181000\r\rNA\r\r16205000\r\r2324000\r\r297566000\r\r2966000\r\r6955000\r\r28841000\r\r56853000\r\r54903000\r\r10058000\r\r3700000\r\r12855000\r\rNA\r\r121814000\r\rNA\r\rNA\r\rNA\r\rNA\r\r129246000\r\r210000\r\r33441000\r\r210000\r\r162897000\r\r135180000\r\r27573000\r\r16187000\r\r-11074000\r\r-1611000\r\r4942000\r\rNA\r\r-50000\r\r35967000\r\r-8861000\r\r-21668000\r\r3685000\r\r-34460000\r\rNA\r\rNA\r\r20727000\r\r-3009000\r\r15082000\r\r1902000\r\r18491000\r\r2019-09-25 16:00:01\r\rBaidu, Inc. \r3734534\r\r8.009974\r\rNA\r\r348540992\r\r1.476227\r\r2019-09-25\r\r102.80\r\r\r\rMSFT\r\r2018\r\r110360000\r\r38353000\r\r72007000\r\r14726000\r\r22223000\r\rNA\r\rNA\r\r75302000\r\r35058000\r\r1416000\r\r35058000\r\r-2733000\r\r36474000\r\r19903000\r\rNA\r\r16571000\r\rNA\r\rNA\r\rNA\r\rNA\r\r16571000\r\rNA\r\r16571000\r\r11946000\r\r121718000\r\r26481000\r\r2662000\r\r6855000\r\r169662000\r\r1862000\r\r36146000\r\r35683000\r\r8053000\r\rNA\r\r7442000\r\r1369000\r\r258848000\r\r8617000\r\r3998000\r\r38195000\r\r58488000\r\r72242000\r\r35707000\r\rNA\r\rNA\r\rNA\r\r176130000\r\rNA\r\rNA\r\rNA\r\r71223000\r\r13682000\r\r-2187000\r\rNA\r\r-2187000\r\r82718000\r\r38982000\r\r16571000\r\r9900000\r\r-3054000\r\r-3862000\r\r7070000\r\r-465000\r\r-459000\r\r43884000\r\r-11632000\r\r6557000\r\r-98000\r\r-6061000\r\r-12699000\r\rNA\r\r-10201000\r\r-971000\r\r-33590000\r\r50000\r\r4283000\r\r2019-09-25 16:00:01\r\rMicrosoft Corporation\r\r20835063\r\r27.541502\r\r0.0133935\r\r7635409920\r\r10.408545\r\r2019-09-25\r\r139.36\r\r\r\rGOOG\r\r2018\r\r136819000\r\r59549000\r\r77270000\r\r21419000\r\r24459000\r\rNA\r\rNA\r\r105427000\r\r31392000\r\r3521000\r\r31392000\r\r-114000\r\r34913000\r\r4177000\r\rNA\r\r30736000\r\rNA\r\rNA\r\rNA\r\rNA\r\r30736000\r\rNA\r\r30736000\r\r16701000\r\r92439000\r\r21193000\r\r1107000\r\r4236000\r\r135676000\r\r13859000\r\r59719000\r\r17888000\r\r2220000\r\rNA\r\r3430000\r\r737000\r\r232792000\r\r4378000\r\rNA\r\r16009000\r\r34620000\r\r3950000\r\r16532000\r\rNA\r\rNA\r\rNA\r\r55164000\r\rNA\r\rNA\r\rNA\r\r45049000\r\r134885000\r\r-2306000\r\rNA\r\r-2306000\r\r177628000\r\r157520000\r\r30736000\r\r9029000\r\r3298000\r\r-2169000\r\r1438000\r\rNA\r\r7890000\r\r47971000\r\r-25139000\r\r-1972000\r\rNA\r\r-28504000\r\rNA\r\rNA\r\r-61000\r\r-4043000\r\r-13179000\r\r-302000\r\r5986000\r\r2019-09-25 16:00:01\r\rAlphabet Inc. \r1345323\r\r25.164429\r\rNA\r\r347344992\r\r4.501470\r\r2019-09-25\r\r1246.52\r\r\r\rAMZN\r\r2018\r\r232887000\r\r139156000\r\r93731000\r\r28837000\r\r52177000\r\rNA\r\r296000\r\r220466000\r\r12421000\r\r-1151000\r\r12421000\r\r-1417000\r\r11270000\r\r1197000\r\rNA\r\r10073000\r\rNA\r\rNA\r\rNA\r\rNA\r\r10073000\r\rNA\r\r10073000\r\r31750000\r\r9500000\r\r16259000\r\r17174000\r\r418000\r\r75101000\r\r440000\r\r61797000\r\r14548000\r\r4110000\r\rNA\r\r6652000\r\rNA\r\r162648000\r\r38192000\r\r1371000\r\r9959000\r\r68391000\r\r23495000\r\r10921000\r\rNA\r\rNA\r\rNA\r\r119099000\r\rNA\r\rNA\r\rNA\r\r5000\r\r19625000\r\r-2872000\r\r26791000\r\r-1035000\r\r43549000\r\r24891000\r\r10073000\r\r15341000\r\r6352000\r\r-4615000\r\r4414000\r\r-1314000\r\r472000\r\r30723000\r\r-13427000\r\r1140000\r\r2104000\r\r-12369000\r\rNA\r\rNA\r\r-7686000\r\rNA\r\r-7686000\r\r-351000\r\r10317000\r\r2019-09-25 16:00:01\r\rAmazon.com, Inc. \r3217392\r\r73.362510\r\rNA\r\r494656000\r\r16.463211\r\r2019-09-25\r\r1768.33\r\r\r\rAAPL\r\r2018\r\r265595000\r\r163756000\r\r101839000\r\r14236000\r\r16705000\r\rNA\r\rNA\r\r194697000\r\r70898000\r\r2005000\r\r70898000\r\r-3240000\r\r72903000\r\r13372000\r\rNA\r\r59531000\r\rNA\r\rNA\r\rNA\r\rNA\r\r59531000\r\rNA\r\r59531000\r\r25913000\r\r40388000\r\r48995000\r\r3956000\r\r12087000\r\r131339000\r\r170799000\r\r41304000\r\rNA\r\rNA\r\rNA\r\r22283000\r\rNA\r\r365725000\r\r55888000\r\r8784000\r\r40230000\r\r116866000\r\r93735000\r\r47977000\r\rNA\r\rNA\r\rNA\r\r258578000\r\rNA\r\rNA\r\rNA\r\r40201000\r\r70400000\r\r-3454000\r\rNA\r\r-3454000\r\r107147000\r\r107147000\r\r59531000\r\r10903000\r\r-27694000\r\r-5322000\r\r9131000\r\r828000\r\r30057000\r\r77434000\r\r-13313000\r\r30845000\r\r-745000\r\r16066000\r\r-13712000\r\rNA\r\r432000\r\rNA\r\r-87876000\r\rNA\r\r5624000\r\r2019-09-25 16:00:01\r\rApple Inc. \r19675563\r\r18.767937\r\r0.0135979\r\r4519179776\r\r10.383821\r\r2019-09-25\r\r221.03\r\r\r\r\rNow I think we have enough information to calculate some financial ratios based on company statistics and their respective financial data. The variables we have are:\n\rWhat variables we have in the data:\rcolnames(financials) %\u0026gt;%\rdata.frame() %\u0026gt;%\rsetNames(c(\u0026quot;Fundamentals\u0026quot;)) %\u0026gt;%\rsplit(as.integer(gl(nrow(.), 14, nrow(.)))) %\u0026gt;%\rkable(caption = \u0026quot;Company Variables\u0026quot;) %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;), font_size = 12)\rTable 8: Company Variables\r\r\r\r\r\r\r\rFundamentals\r\r\r\r\r\rsymbol\r\r\r\ryear\r\r\r\rTotal.Revenue\r\r\r\rCost.of.Revenue\r\r\r\rGross.Profit\r\r\r\rResearch.Development\r\r\r\rSelling.General.and.Administrative\r\r\r\rNon.Recurring\r\r\r\rOthers\r\r\r\rTotal.Operating.Expenses\r\r\r\rOperating.Income.or.Loss\r\r\r\rTotal.Other.Income.Expenses.Net\r\r\r\rEarnings.Before.Interest.and.Taxes\r\r\r\rInterest.Expense\r\r\r\r\r\r\r\r\r\r\rFundamentals\r\r\r\r\r\r15\r\rIncome.Before.Tax\r\r\r\r16\r\rIncome.Tax.Expense\r\r\r\r17\r\rMinority.Interest\r\r\r\r18\r\rNet.Income.From.Continuing.Ops\r\r\r\r19\r\rDiscontinued.Operations\r\r\r\r20\r\rExtraordinary.Items\r\r\r\r21\r\rEffect.Of.Accounting.Changes\r\r\r\r22\r\rOther.Items\r\r\r\r23\r\rNet.Income\r\r\r\r24\r\rPreferred.Stock.And.Other.Adjustments\r\r\r\r25\r\rNet.Income.Applicable.To.Common.Shares\r\r\r\r26\r\rCash.And.Cash.Equivalents\r\r\r\r27\r\rShort.Term.Investments\r\r\r\r28\r\rNet.Receivables\r\r\r\r\r\r\r\r\r\r\rFundamentals\r\r\r\r\r\r29\r\rInventory\r\r\r\r30\r\rOther.Current.Assets\r\r\r\r31\r\rTotal.Current.Assets\r\r\r\r32\r\rLong.Term.Investments\r\r\r\r33\r\rProperty..plant.and.equipment\r\r\r\r34\r\rGoodwill\r\r\r\r35\r\rIntangible.Assets\r\r\r\r36\r\rAccumulated.Amortization\r\r\r\r37\r\rOther.Assets\r\r\r\r38\r\rDeferred.Long.Term.Asset.Charges\r\r\r\r39\r\rTotal.Assets\r\r\r\r40\r\rAccounts.Payable\r\r\r\r41\r\rShort.Current.Long.Term.Debt\r\r\r\r42\r\rOther.Current.Liabilities\r\r\r\r\r\r\r\r\r\r\rFundamentals\r\r\r\r\r\r43\r\rTotal.Current.Liabilities\r\r\r\r44\r\rLong.Term.Debt\r\r\r\r45\r\rOther.Liabilities\r\r\r\r46\r\rDeferred.Long.Term.Liability.Charges\r\r\r\r47\r\rMinority.Interest1\r\r\r\r48\r\rNegative.Goodwill\r\r\r\r49\r\rTotal.Liabilities\r\r\r\r50\r\rMisc..Stocks.Options.Warrants\r\r\r\r51\r\rRedeemable.Preferred.Stock\r\r\r\r52\r\rPreferred.Stock\r\r\r\r53\r\rCommon.Stock\r\r\r\r54\r\rRetained.Earnings\r\r\r\r55\r\rTreasury.Stock\r\r\r\r56\r\rCapital.Surplus\r\r\r\r\r\r\r\r\r\r\rFundamentals\r\r\r\r\r\r57\r\rOther.Stockholder.Equity\r\r\r\r58\r\rTotal.stockholders..equity\r\r\r\r59\r\rNet.Tangible.Assets\r\r\r\r60\r\rNet.Income1\r\r\r\r61\r\rDepreciation\r\r\r\r62\r\rAdjustments.To.Net.Income\r\r\r\r63\r\rChanges.In.Accounts.Receivables\r\r\r\r64\r\rChanges.In.Liabilities\r\r\r\r65\r\rChanges.In.Inventories\r\r\r\r66\r\rChanges.In.Other.Operating.Activities\r\r\r\r67\r\rTotal.Cash.Flow.From.Operating.Activities\r\r\r\r68\r\rCapital.Expenditure\r\r\r\r69\r\rInvestments\r\r\r\r70\r\rOther.Cash.flows.from.Investing.Activities\r\r\r\r\r\r\r\r\r\r\rFundamentals\r\r\r\r\r\r71\r\rTotal.Cash.Flows.From.Investing.Activities\r\r\r\r72\r\rDividends.Paid\r\r\r\r73\r\rSale.Purchase.of.Stock\r\r\r\r74\r\rNet.Borrowings\r\r\r\r75\r\rOther.Cash.Flows.from.Financing.Activities\r\r\r\r76\r\rTotal.Cash.Flows.From.Financing.Activities\r\r\r\r77\r\rEffect.Of.Exchange.Rate.Changes\r\r\r\r78\r\rChange.In.Cash.and.Cash.Equivalents\r\r\r\r79\r\rTrade.Time\r\r\r\r80\r\rName\r\r\r\r81\r\rVolume\r\r\r\r82\r\rP.E.Ratio\r\r\r\r83\r\rDividend.Yield\r\r\r\r84\r\rShares.Outstanding\r\r\r\r\r\r\r\r\r\r\rFundamentals\r\r\r\r\r\r85\r\rPrice.Book\r\r\r\r86\r\rdate\r\r\r\r87\r\radjusted\r\r\r\r\r\r\r\r\rWhich is quite a lot of information. I like this method of calculating financial data since dplyr and the pipe function makes it intuitive to read and we can see what we are calculating.\n\rSome basic financial ratios:\r############################## Create some financial ratios ######################\rratios \u0026lt;- financials %\u0026gt;%\rmutate(BvE = Total.Assets - Total.Liabilities,\rBvE_per_share = BvE / (Shares.Outstanding / 1000),\rEBITDA = Earnings.Before.Interest.and.Taxes + Depreciation,\rMarket_Cap = adjusted * (Shares.Outstanding / 1000), #¡Cuidado!\rEV = (Market_Cap + Total.Liabilities) - Cash.And.Cash.Equivalents,\rMkt_Book = EV /(Total.Assets - Cash.And.Cash.Equivalents),\rPrice_Book = Market_Cap / Total.stockholders..equity,\rPrice_Sales = Market_Cap / Total.Revenue,\rPE_Ratio = Market_Cap / Net.Income,\rEV_EBITDA = EV / EBITDA,\rNI_REV = Net.Income / Total.Revenue,\rRev_TA = Total.Revenue / Total.Assets,\rTA_BvE = Total.Assets / BvE,\rROE = NI_REV * Rev_TA * TA_BvE * 100) %\u0026gt;%\rselect(symbol, date, BvE, BvE_per_share, EBITDA, Market_Cap, EV, Mkt_Book, Price_Book, Price_Sales,\rPE_Ratio, EV_EBITDA, NI_REV, Rev_TA, TA_BvE, ROE)\rTable 9: Financial Ratios\r\r\r\rsymbol\r\rdate\r\rBvE\r\rBvE_per_share\r\rEBITDA\r\rMarket_Cap\r\rEV\r\rMkt_Book\r\rPrice_Book\r\rPrice_Sales\r\rPE_Ratio\r\rEV_EBITDA\r\rNI_REV\r\rRev_TA\r\rTA_BvE\r\rROE\r\r\r\r\r\rBIDU\r\r2019-09-25\r\r175752000\r\r504.25059\r\r33317000\r\r35830015\r\r130006015\r\r0.4816322\r\r0.219955\r\r0.3449273\r\r1.29946\r\r3.902093\r\r0.2654389\r\r0.3490889\r\r1.693102\r\r15.68858\r\r\r\rMSFT\r\r2019-09-25\r\r82718000\r\r10.83347\r\r44958000\r\r1064070734\r\r1228254734\r\r4.9746650\r\r12.863835\r\r9.6418153\r\r64.21283\r\r27.320048\r\r0.1501540\r\r0.4263506\r\r3.129283\r\r20.03312\r\r\r\rGOOG\r\r2019-09-25\r\r177628000\r\r511.38783\r\r40421000\r\r432972486\r\r471435486\r\r2.1816526\r\r2.437524\r\r3.1645640\r\r14.08682\r\r11.663133\r\r0.2246472\r\r0.5877307\r\r1.310559\r\r17.30358\r\r\r\rAMZN\r\r2019-09-25\r\r43549000\r\r88.03896\r\r27762000\r\r874715023\r\r962064023\r\r7.3497229\r\r20.085766\r\r3.7559633\r\r86.83759\r\r34.653988\r\r0.0432527\r\r1.4318467\r\r3.734827\r\r23.13027\r\r\r\rAAPL\r\r2019-09-25\r\r107147000\r\r23.70939\r\r81801000\r\r998874301\r\r1231539301\r\r3.6241784\r\r9.322466\r\r3.7608927\r\r16.77906\r\r15.055309\r\r0.2241420\r\r0.7262151\r\r3.413301\r\r55.56012\r\r\r\r\rWe can check if the calculations are somewhat correct by comparing them to Yahoo Finance statistics. I select only a few ratios which we were able to get from the Yahoo statistics page.\nstats %\u0026gt;%\rleft_join(ratios, by = c(\u0026quot;symbol\u0026quot;)) %\u0026gt;%\rselect(symbol, Name, P.E.Ratio, PE_Ratio, Price.Book, Price_Book) %\u0026gt;%\rkable(caption = \u0026quot;Price Earnings, Price Book ratios\u0026quot;) %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;), font_size = 12)\rTable 10: Price Earnings, Price Book ratios\r\r\r\rsymbol\r\rName\r\rP.E.Ratio\r\rPE_Ratio\r\rPrice.Book\r\rPrice_Book\r\r\r\r\r\rAAPL\r\rApple Inc. \r18.767937\r\r16.77906\r\r10.383821\r\r9.322466\r\r\r\rAMZN\r\rAmazon.com, Inc. \r73.362510\r\r86.83759\r\r16.463211\r\r20.085766\r\r\r\rGOOG\r\rAlphabet Inc. \r25.164429\r\r14.08682\r\r4.501470\r\r2.437524\r\r\r\rMSFT\r\rMicrosoft Corporation\r\r27.541502\r\r64.21283\r\r10.408545\r\r12.863835\r\r\r\rBIDU\r\rBaidu, Inc. \r8.009974\r\r1.29946\r\r1.476227\r\r0.219955\r\r\r\r\rThe ratios seem somewhat similar. However GOOG, MSFT and BIDU PE Ratio looks a little off. The same for BIDU’s Price_Book ratio. The problem here is that the adjusted stock price for BIDU is in USD however the financials are in CNY, so we have to be careful with foreign companies. I did develop a model which scrapes the currency information also and makes the conversion and we can better compare companies in different markets, which I will leave for another post.\nTwo things here:\nYahoo uses a number of different sources for their statistics, just check out their Footnotes side bar for Google here. They use Morningstar, Thomson Reuters, EDGAR and CapitalIQ.\n\rThe Shares Outstanding information will not be the same to the one we use. Yahoo published the more recent Shares Outstanding values but their PE ratios might use December 2018 - Net Income along with December 2018 - Market Cap, taking the Shares Outstanding and adjusted prices from December 2018. However we use September 2019 values! Historical Shares Outstanding information can be found here for Google\n\r\rWe can plot the performance of each stock to see how they did over the past year.\nsymbols %\u0026gt;%\rtq_get(get = \u0026quot;stock.prices\u0026quot;,\rfrom = \u0026quot;2018-12-31\u0026quot;,\rto = Sys.Date()) %\u0026gt;%\rselect(symbol, date, adjusted) %\u0026gt;%\rgroup_by(symbol) %\u0026gt;%\rarrange(desc(date)) %\u0026gt;%\rggplot(aes(x = date, y = adjusted))+\rgeom_line() +\rfacet_wrap(~ symbol, ncol = 2, scales = \u0026quot;free\u0026quot;) +\rtheme_tq() +\rggtitle(\u0026quot;Stock Prices since December 2018\u0026quot;)\r\rAlso using fundamental data:\rfinancials %\u0026gt;%\rggplot(aes(x = symbol)) +\rgeom_col(aes(y = Total.Assets, color = \u0026quot;blue\u0026quot;, fill = \u0026quot;blue\u0026quot;, alpha = 0.5)) +\rgeom_col(aes(y = Total.Liabilities, color = \u0026quot;red\u0026quot;, fill = \u0026quot;red\u0026quot;, alpha = 0.5)) +\rggtitle(\u0026quot;Total Assets \u0026amp; Total Liabilities\u0026quot;) +\rxlab(\u0026quot;Symbols\u0026quot;) +\rylab(\u0026quot;Total Assets \u0026amp; Total Liabilities\u0026quot;) +\rtheme_tq() +\rtheme(legend.position = \u0026quot;none\u0026quot;)\rAny errors are my own, if you find any please let me know!\n\r","date":1569110400,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1569110400,"objectID":"3fb03d3147a7c5a1c6d2d1f2b444e766","permalink":"/post/financial-ratios-in-r/fundamental-financial-ratios-in-r/","publishdate":"2019-09-22T00:00:00Z","relpermalink":"/post/financial-ratios-in-r/fundamental-financial-ratios-in-r/","section":"post","summary":"An analysis of company financial statements: Book-Value-Equity, EBITDA, Enterprise Value, Market-Book, DuPont anaysis. ","tags":["yahoo finance","asset pricing","fundamental analysis","ratios"],"title":"Fundamental Financial Ratios in R","type":"post"},{"authors":["Matthew Smith"],"categories":["Statistics"],"content":"\r\rI was recently given a task to impute some time series missing values for a prediction problem. Python has the TSFRESH package which is pretty well documented but I wanted to apply something using R. I opted for a model from statistics and control theory, called Kalman Smoothing which is available in the imputeTS package in R.\nI went with smoothing over filtering since the Kalman filter takes a forward pass through the data and uses all the data upto the current time point and can be done in real time. Kalman smoothing adds a backward pass through the data and thus uses all the data. I guess it can be considered an extention to filtering.\nNote: I use stock prices here only for easy time series data collection and to just apply Kalman Smoothing to a time series problem, you cannot build a trading strategy using smoothing for the reason given. You can check out a Kalman Filtering Pairs Trading Strategy here.\nDownload some data:\rI just collect some simple data for Google and Walmart. I end up with 3 parts, the actual observations, the predicted observation and the randomly generated missing time series.\nlibrary(knitr)\rlibrary(kableExtra)\rlibrary(quantmod)\rlibrary(imputeTS)\rlibrary(Metrics)\rsymbols \u0026lt;- c(\u0026quot;GOOG\u0026quot;, \u0026quot;WMT\u0026quot;)\rmyenv \u0026lt;- new.env()\rsymnames \u0026lt;- getSymbols(symbols, env = myenv)\rli \u0026lt;- eapply(myenv, function(x) x) ts \u0026lt;- do.call(merge, eapply(myenv, Ad)[symnames])\ractual \u0026lt;-as.data.frame(ts)\rnames(actual) \u0026lt;- paste(symbols, \u0026quot;actual\u0026quot;, sep = \u0026quot;_\u0026quot;)\r\rActual observations:\rTable 1: Actual Observations\r\r\r\r\rGOOG_actual\r\rWMT_actual\r\r\r\r\r\r2007-01-03\r\r232.9220\r\r35.17886\r\r\r\r2007-01-04\r\r240.7277\r\r35.34902\r\r\r\r2007-01-05\r\r242.6853\r\r35.06050\r\r\r\r2007-01-08\r\r240.8871\r\r34.77196\r\r\r\r2007-01-09\r\r241.8435\r\r35.06050\r\r\r\r2007-01-10\r\r243.8161\r\r34.97911\r\r\r\r\rHere I create the 100 random missing values that we want to predcit /impute.\n\rCreate some NA values:\rts[sample(nrow(ts), 100), ] \u0026lt;- NA\rnames(ts) \u0026lt;- paste(symbols, \u0026quot;missing\u0026quot;, sep = \u0026quot;_\u0026quot;)\rTable 2: Data with random missing observations\r\r\r\rGOOG_missing\r\rWMT_missing\r\r\r\r\r\r232.9220\r\r35.17886\r\r\r\r240.7277\r\r35.34902\r\r\r\r242.6853\r\r35.06050\r\r\r\r240.8871\r\r34.77196\r\r\r\rNA\r\rNA\r\r\r\r243.8161\r\r34.97911\r\r\r\r\rI wrap the na_kalman into a function to apply lapply which is useful should I want to apply the model to multivariate time series data. That is you might have a data set with many explanatory variables for each time stamp and one or more variables will have missing values. The function should impute across the columns of your data frame.\nI use a state space representation of an ARIMA model here but I suggest taking a look at the auto.arima model from the forecast package for the best model.There is also a model available for a strucutred model fitted by maximum likelihood. I just use a simple ARIMA model for this example.\n\rRun the model\r# Model 1:\r# Kalman Smoothing missing value imputation in a state space representation of an ARIMA model\rKalmanSmoothing \u0026lt;- function(data){\rdf \u0026lt;- data\rarima_model \u0026lt;- arima(df[, ], order = c(1, 0, 1))$model\rKalmanImputation \u0026lt;- na_kalman(df[, ], model = arima_model)\rreturn(KalmanImputation)\r}\rresults \u0026lt;- lapply(ts, KalmanSmoothing)\rresults \u0026lt;- as.data.frame(results)\rnames(results) \u0026lt;- paste(symbols, \u0026quot;predictions\u0026quot;, sep = \u0026quot;_\u0026quot;)\rts \u0026lt;- as.data.frame(ts)\r\rCompute the RMSE for both time series:\rI subset the first 10 predictions for each observation but we will have 100 predictions (one for each NA value we randomly generated earlier).\nfinal \u0026lt;- cbind(ts, results, actual)\rGOOG_error \u0026lt;- subset(final, is.na(GOOG_missing), select = c(\u0026quot;GOOG_predictions\u0026quot;, \u0026quot;GOOG_actual\u0026quot;))\rTable 3: Predictions vs Observed\r\r\r\r\rGOOG_predictions\r\rGOOG_actual\r\r\r\r\r\r2007-01-09\r\r242.2819\r\r241.8435\r\r\r\r2007-01-29\r\r246.6176\r\r245.3155\r\r\r\r2007-03-09\r\r226.5736\r\r225.6343\r\r\r\r2007-04-23\r\r239.1593\r\r238.6455\r\r\r\r2007-05-03\r\r233.3537\r\r235.7314\r\r\r\r2007-09-17\r\r264.9737\r\r261.6692\r\r\r\r2007-10-05\r\r296.0007\r\r295.9158\r\r\r\r2007-10-22\r\r328.9113\r\r324.1600\r\r\r\r2007-11-01\r\r353.2276\r\r350.2920\r\r\r\r2008-06-05\r\r283.8127\r\r292.0553\r\r\r\r\r\rPrint the RMSE for Google\rrmse(GOOG_error$GOOG_actual, GOOG_error$GOOG_predictions)\r## [1] 7.889578\r\rApply the same to the Walmart predictions:\rWMT_error \u0026lt;- subset(final, is.na(WMT_missing), select = c(\u0026quot;WMT_predictions\u0026quot;, \u0026quot;WMT_actual\u0026quot;))\rTable 4: Predictions vs Observed\r\r\r\r\rWMT_predictions\r\rWMT_actual\r\r\r\r\r\r2007-01-09\r\r34.88928\r\r35.06050\r\r\r\r2007-01-29\r\r35.14012\r\r35.23806\r\r\r\r2007-03-09\r\r35.17471\r\r35.08268\r\r\r\r2007-04-23\r\r36.56807\r\r36.37310\r\r\r\r2007-05-03\r\r35.89254\r\r35.94939\r\r\r\r2007-09-17\r\r32.93606\r\r32.51551\r\r\r\r2007-10-05\r\r33.87928\r\r34.05422\r\r\r\r2007-10-22\r\r33.38332\r\r33.96415\r\r\r\r2007-11-01\r\r33.55119\r\r33.04843\r\r\r\r2008-06-05\r\r44.16592\r\r45.49237\r\r\r\r\r\rPrint the RMSE for Walmart\rrmse(WMT_error$WMT_actual, WMT_error$WMT_predictions)\r## [1] 0.6258724\r\r","date":1569110400,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1569110400,"objectID":"451fa9157ae4bcc04640e62c92c43568","permalink":"/post/kalman-smoothing/kalman-smoothing-time-series-imputation/","publishdate":"2019-09-22T00:00:00Z","relpermalink":"/post/kalman-smoothing/kalman-smoothing-time-series-imputation/","section":"post","summary":"I use the na_kalman function from the imputeTS package to impute randomly generate missing stock prices.","tags":["time-series","missing value imputation","stock prices"],"title":"Kalman Smoothing for Time Series Missing Value Imputation","type":"post"},{"authors":["Matthew Smith"],"categories":["AWS"],"content":"\rNote: Skip to Step 5 if you want the “quick fix”.\nI will briefly document how I setup RStudio server on an Amazon AWS cloud instance. Once you have an AWS account you should be able to follow these instructions to set everything up. I suggest you follow some tutorial such as here in order to setup the Amazon ec2 instance, it’s not difficult but it is a separate topic. I am using the “Ubuntu Server 18.04 LTS (HVM), SSD Volume Type” on a “free eligible tier t2.micro” - The free version has 1GB of memory which is fine for getting to know the environment/Amazon AWS but I strongly recomend investing in a paid instance once your are familiar.\nOnce the instance is setup, you might want to follow these instructions here to set up PuTTY (for Windows users) and obtain a .pem key. Once we are logged into PuTTY we can run the following commands into the terminal:\n\r\rStep 1: Install R\nsudo apt update\rsudo apt-get install -y r-base r-base-dev\rStep 2: Download and isntall RStudio\nFind the latest RStudio version link from here and replace the link below after the wget.\nsudo apt install gdebi-core\rwget https://download2.rstudio.org/server/bionic/amd64/rstudio-server-1.2.1335-amd64.deb\rsudo gdebi rstudio-server-1.2.1335-amd64.deb\rStep 3: We can add a user to the system to log into RStudio server\nsudo chmod 777 -R /usr/local/lib/R/site-library\rsudo adduser YOURUSERNAME\rThat should be it. I was using this code a little while back. I will update the post when I install an AWS instance again in the coming months.\nStep 4: Updating R to later versions\necho \u0026quot;deb https://cloud.r-project.org/bin/linux/ubuntu bionic-cran35/\u0026quot; | sudo tee -a /etc/apt/sources.list\rsudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9\rsudo apt-get update\rsudo apt-get upgrade -y\rStep 5: Quick version\nYou can install RStudio directly as an Amazon AWS instance by using Louis Aslett’s RStudio Amazon Machine Image (AMI) here. There is also a short video here on how you can set it up painlessly!\nI recommend Louis Aslett’s AMI especially if you are not familiar with Bash or Shell commands however I was running into some compatibility problems with package versions and R versions which is why I sought a way to manually install R and have full control.\nBelow are a few additional commands, mostly for myself since I kept all these commands in a notepad and there was a reason they were kept!\nStep 6: Upgrade R\necho \u0026quot;deb https://cloud.r-project.org/bin/linux/ubuntu bionic-cran35/\u0026quot; | sudo tee -a /etc/apt/sources.list\rsudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9\rsudo apt-get update\rsudo apt-get upgrade -y\rsudo apt-get install -y r-base r-recommended r-base-dev\rStep 7: Change password for the root user\nsudo passwd root\rsu root\rStep 8: Additional\napt-get -y build-dep libcurl4-gnutls-dev\r","date":1569024000,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1569024000,"objectID":"107a25f45ae12d4007cc08516c53dca8","permalink":"/post/rstudio-amazonaws/","publishdate":"2019-09-21T00:00:00Z","relpermalink":"/post/rstudio-amazonaws/","section":"post","summary":"A short read on how to install RStudio using bash commands on an Amazon AWS instance.","tags":["AWS","RStudio"],"title":"RStudio Server on Amazon Web Services","type":"post"},{"authors":["Matthew Smith"],"categories":["Yahoo Finance"],"content":"\r\rI wrote a script a while back when I was working on a project which required the analysis of IPO data, of course I used the IPO data from the bloomberg terminal but I wanted a free source also. Yahoo Finance collects IPO data for a number of worldwide markets, its not clean data but it goes as far back as the year 2000.\nI wanted to follow on from some research by J.R.Ritter here. The goal is to try and compute the money left on the table from IPO’s and extend the research up until 2018.\nQuote: In the 1980s, the average first-day return on initial public offerings (IPOs) was 7%. The average first-day return doubled to almost 15% during 1990-1998, before jumping to 65% during the internet bubble years of 1999-2000 and then reverting to 12% during 2001-2003.\nThe code is not clean and if I had to re-write it today I would do so very differently but it works. I just re-download a small sample of the data as it takes some time to process all years but changing from to the year 2000 should get you all the data.\nlibrary(rvest)\rlibrary(naniar)\rlibrary(tidyverse)\rlibrary(tidyquant)\rlibrary(lubridate)\rlibrary(knitr)\rlibrary(kableExtra)\rfrom = \u0026quot;2019-09-01\u0026quot;\rto = \u0026quot;2019-09-19\u0026quot;\rs \u0026lt;- seq(as.Date(from), as.Date(to), \u0026quot;days\u0026quot;)\rurl \u0026lt;- \u0026quot;https://finance.yahoo.com/calendar/ipo?from=\u0026quot;\rlinks \u0026lt;- gsub(\u0026quot; \u0026quot;, \u0026quot;\u0026quot;, paste(url,from,\u0026quot;\u0026amp;to=\u0026quot;,to,\u0026quot;\u0026amp;day=\u0026quot;,format(s, \u0026quot;%Y-%m-%d\u0026quot;)))\rstore \u0026lt;- NULL\rtbl \u0026lt;- NULL\rfor(i in links){\rstore[[i]] = read_html(i)\rtbl[[i]] = html_table(store[[i]])\r}\rlist \u0026lt;- unlist(tbl, recursive = FALSE)\rdf \u0026lt;- do.call(\u0026quot;rbind\u0026quot;, list)\rdf \u0026lt;- df %\u0026gt;%\rreplace_with_na_all(condition = ~.x == \u0026quot;-\u0026quot;)\rdata \u0026lt;- df[!is.na(df$Price), ]\rI get a nice data frame which looks like:\ndata %\u0026gt;%\rhead() %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rSymbol\r\rCompany\r\rExchange\r\rDate\r\rPrice Range\r\rPrice\r\rCurrency\r\rShares\r\rActions\r\r\r\r\r\rVG8.AX\r\rVGI Partners Asian Invests Ltd\r\rASX\r\rAug 04, 2019\r\rN/A\r\rN/A\r\rAUD\r\rN/A\r\rAmended\r\r\r\rVG8.AX\r\rVGI Partners Asian Invests Ltd\r\rASX\r\rAug 04, 2019\r\rN/A\r\rN/A\r\rAUD\r\rN/A\r\rAmended\r\r\r\rVG8.AX\r\rVGI Partners Asian Invests Ltd\r\rASX\r\rAug 04, 2019\r\rN/A\r\rN/A\r\rAUD\r\rN/A\r\rAmended\r\r\r\r\rChina Merchants Coml Reit\r\rHKSE\r\rSep 02, 2019\r\rN/A\r\rN/A\r\rUSD\r\rN/A\r\rAmended\r\r\r\r\rImmunotech Biopharm Ltd\r\rHKSE\r\rSep 02, 2019\r\rN/A\r\rN/A\r\rUSD\r\rN/A\r\rAmended\r\r\r\r\rNusantara Almazia PT\r\rJakarta\r\rAug 12, 2019\r\rN/A\r\rN/A\r\rIDR\r\r461530000\r\rAmended\r\r\r\r\rTheres lot of missing IPO price data and many duplicate results since this is just a calendar and thus reports on any news about an IPO.\nI next get the stock price information: - which can take some time so I suggest saving the results.\nsymbols \u0026lt;- df$Symbol\rsymbols \u0026lt;- symbols[symbols != \u0026quot;\u0026quot;] stocks \u0026lt;- symbols %\u0026gt;%\rtq_get(\u0026quot;stock.prices\u0026quot;,\rfrom = from,\rto = to)\rstocks %\u0026gt;%\rhead() %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rsymbol\r\rdate\r\ropen\r\rhigh\r\rlow\r\rclose\r\rvolume\r\radjusted\r\r\r\r\r\rSDC\r\r2019-09-12\r\r20.59\r\r21.10\r\r16.28\r\r16.67\r\r55416800\r\r16.67\r\r\r\rSDC\r\r2019-09-13\r\r16.81\r\r18.71\r\r16.81\r\r18.68\r\r19119100\r\r18.68\r\r\r\rSDC\r\r2019-09-16\r\r18.46\r\r19.00\r\r17.81\r\r18.90\r\r5573000\r\r18.90\r\r\r\rSDC\r\r2019-09-17\r\r19.00\r\r19.30\r\r18.65\r\r19.07\r\r4415200\r\r19.07\r\r\r\rSDC\r\r2019-09-18\r\r19.17\r\r19.70\r\r18.90\r\r19.48\r\r10533900\r\r19.48\r\r\r\rTXG\r\r2019-09-12\r\r54.00\r\r58.00\r\r51.00\r\r52.75\r\r7326300\r\r52.75\r\r\r\r\rNext I join the daily stock price data with the IPO data, clean it up a little and compute the returns. I also split the data into different markets such as NYSE, LSE, Frankfurt etc. and compute the average daily returns. You can find everything along with the excel file collecting IPOs since 2000 here.\nHeres how the final data looks with the calculated one day price returns:\nread.csv(\u0026quot;https://raw.githubusercontent.com/msmith01/IPO_Web_Scraping_Yahoo/master/yahoo_finance_IPOs_2000_2018.csv\u0026quot;, nrows = 10) %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rX\r\rsymbol\r\rcompany\r\rexchange\r\rdate.x\r\rprice\r\rcurrency\r\ractions\r\rdate.y\r\ropen\r\rclose\r\radjusted\r\rreturns\r\ryear\r\r\r\r\r\r1\r\rEVD.F\r\rCTS Eventim AG\r\rFrankfurt\r\r2000-01-31\r\r21.50\r\rEUR\r\rPriced\r\r2000-02-01\r\r6.37500\r\r6.30000\r\r4.990930\r\r-0.7069767\r\r2000\r\r\r\r2\r\rSLAB\r\rSilicon Laboratories Inc\r\rNasdaqGM\r\r2000-03-24\r\r31.00\r\rUSD\r\rPriced\r\r2000-03-24\r\r63.00000\r\r69.37500\r\r69.375000\r\r1.2379032\r\r2000\r\r\r\r3\r\r0764.HK\r\rOcean Shores Group Ltd\r\rHKSE\r\r2000-02-10\r\r1.33\r\rHKD\r\rPriced\r\r2005-09-29\r\r9984.20996\r\r9984.20996\r\r9946.558594\r\r7505.9247827\r\r2000\r\r\r\r4\r\rMTB.V\r\rMountain Boy Minerals Ltd\r\rTSXV\r\r2000-07-12\r\r0.35\r\rCAD\r\rPriced\r\r2000-07-12\r\r0.35000\r\r0.35000\r\r0.350000\r\r0.0000000\r\r2000\r\r\r\r5\r\rIAG.TO\r\rIndustrial-Alliance Life\r\rToronto\r\r2000-02-10\r\r15.75\r\rCAD\r\rPriced\r\r2000-02-10\r\r8.50000\r\r8.70000\r\r5.096976\r\r-0.4476190\r\r2000\r\r\r\r6\r\r2457.TW\r\rPhihong Enterprises Co Ltd\r\rTaiwan\r\r2000-02-15\r\r111.00\r\rTWD\r\rPriced\r\r2000-02-16\r\r55.19920\r\r55.19920\r\r28.781498\r\r-0.5027099\r\r2000\r\r\r\r7\r\rIFX.F\r\rInfineon Technologies AG\r\rFrankfurt\r\r2000-03-14\r\r35.00\r\rEUR\r\rPriced\r\r2000-03-14\r\r71.50000\r\r79.00000\r\r69.923615\r\r1.2571429\r\r2000\r\r\r\r8\r\rBRC.V\r\rBRC Development Corp\r\rTSXV\r\r2000-02-24\r\r0.50\r\rCAD\r\rPriced\r\r2000-07-20\r\r0.35000\r\r0.40000\r\r0.400000\r\r-0.2000000\r\r2000\r\r\r\r9\r\rPTR\r\rPetroChina Co Ltd\r\rNYSE\r\r2000-04-07\r\r16.44\r\rUSD\r\rPriced\r\r2000-04-06\r\r16.43750\r\r16.43750\r\r7.569896\r\r-0.0001521\r\r2000\r\r\r\r10\r\r0643.HK\r\rCarry Wealth Holdings Ltd\r\rHKSE\r\r2000-03-09\r\r1.00\r\rHKD\r\rPriced\r\r2000-03-14\r\r0.78389\r\r0.70833\r\r0.332258\r\r-0.2916700\r\r2000\r\r\r\r\rI try to recreate some of the plots on J.R.Ritters website for each of the countries.\nknitr::include_graphics(\u0026quot;Monthly_bloomberg_graphs.png\u0026quot;)\rknitr::include_graphics(\u0026quot;Monthly_bloomberg_graphs2.png\u0026quot;)\rknitr::include_graphics(\u0026quot;Monthly_bloomberg_graphs3.png\u0026quot;)\rThe returns seem reasonable given some exchanges are growth exchanges and others are mature exchanges. I would take caution here however since Yahoo is somewhat unreliable (at least in my experience of getting stock prices and fundamental data).\nReferences\rSee J.R.Ritter for other IPO data.\rSee Tim Loughran and Jay Ritter IPO returns:\n","date":1569024000,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1569024000,"objectID":"ac15b304c847262db77fda90ccc3678a","permalink":"/post/yahoo-finance-ipo/","publishdate":"2019-09-21T00:00:00Z","relpermalink":"/post/yahoo-finance-ipo/","section":"post","summary":"I compute the money left on the table for companies listed on the yahoo finance IPO calendar.","tags":["time-series","finance","ipo","yahoo-finance"],"title":"Scraping Yahoo Finance IPO Data","type":"post"},{"authors":["Matthew Smith"],"categories":["AWS"],"content":"\rThere are times when I am connected remotely to an RStudio server and I want to run a time-consuming script which might take a few hours or days. As part of my PhD I had to calculate a number of large distance matrices which took considerable time since the data was quite large. Another script I developed was to download and parse 150,000 documents. It took a week to download and parse them and during this time I lost connection to the server a few times causing the code to break.\nThe free version of RStudio only allows one session open at any time and leaving the script running for a week meant that I couldn’t keep coding in R! Many of the problems I faced actually didn’t require RStudio since the models were either downloading and storing data or calculating matrices so just an R connection would be sufficient. So, I wanted to find a way to run an R file without logging off or without any interruption. I come across the nohup command in Unix operating systems.\nThe nohup or no hang-up command can execute a script and tell the system to continue running it even if the session is disconnected.\rI use it in the following way, once I have developed a model myRFile.R using RStudio, verified it works on a sample of the data etc. and saved it into a folder called myFolder. I can go to the terminal (which I usually connect to using PuTTY) and run the following:\nnohup Rscript ./myFolder/myRFile.R \u0026lt;/dev/null\u0026gt;myRFile_Output.out 2\u0026gt;myRFile_ErrorMessages.err \u0026amp;\rThis will run the .R file and store any output usually printed to the console to a text file myRFile_Ouput.out and any error messages to another text file myRFile_ErrorMessages.err where we can check on the progress whilst the script is running. I usually add progress messages in side the function such as:\nfoo \u0026lt;- function(x){\rprint(paste(\u0026quot;Year\u0026quot;, x, \u0026quot;has started \u0026quot;, Sys.time()))\rdo.something\rprint(paste(\u0026quot;Year\u0026quot;, x, \u0026quot;has ended \u0026quot;, Sys.time()))\rreturn(x)\r}\ryears \u0026lt;- seq(from = \u0026quot;2005\u0026quot;, to = \u0026quot;2018\u0026quot;)\rsapply(years, foo) \rWhich prints out the progress of the function to myRFile_Output.out, i.e. if I needed to apply a function across years.\nBy running nohup commands from the terminal allows me to free up my RStudio for other tasks also.\n","date":1569024000,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1569024000,"objectID":"f0176721d0dd4612f46a19685022f0d3","permalink":"/post/nohup-r-connect/","publishdate":"2019-09-21T00:00:00Z","relpermalink":"/post/nohup-r-connect/","section":"post","summary":"I briefly discuss how I use nohup commands to run R files, save the errors and outputs to file","tags":["AWS","RStudio","nohup"],"title":"Sending nohup commands to R scripts","type":"post"},{"authors":["Matthew Smith"],"categories":["Yahoo Finance"],"content":"\r\rI had been tracking the performance of Nvidia for a while since they were reporting impressive earnings and share price growth over recent years. I conducted a study (DCF analysis) to see if Nvidia was fairly priced at this time. I had it marked down as a $141 fair value per share based on the DCF I constructed, however it was trading between a high of $280 to a low of $130 from September and to December of 2018.\nLet’s download some fundamental data for Nvida and compare it’s performance to it’s industry peers.\n# A function to collect fundamental data from Yahoo finance (Income Statement, Balance Sheet and Cash Flow statements, just skip past this part.)\rgetFin \u0026lt;- function(stock){\rif (\u0026quot;rvest\u0026quot; %in% installed.packages()) {\rlibrary(rvest)\r}else{\rinstall.packages(\u0026quot;rvest\u0026quot;)\rlibrary(rvest)\r}\rfor (i in 1:length(stock)) {\rtryCatch(\r{\r# Collect the Income Statement data\rlink \u0026lt;- \u0026quot;https://finance.yahoo.com/quote/\u0026quot;\rlink \u0026lt;- paste0(link, stock[i], \u0026quot;/financials?p=\u0026quot;, stock[i])\rwahis.session \u0026lt;- html_session(link)\rp \u0026lt;- wahis.session %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;Col1-1-Financials-Proxy\u0026quot;]/section/div[3]/table\u0026#39;)%\u0026gt;%\rhtml_table(fill = TRUE)\rIncomeStatement \u0026lt;- p[[1]]\rcolnames(IncomeStatement) \u0026lt;- paste(IncomeStatement[1,])\rIncomeStatement \u0026lt;- IncomeStatement[-c(1,5,12,20,25),]\rnames_row \u0026lt;- paste(IncomeStatement[,1])\rIncomeStatement \u0026lt;- IncomeStatement[,-1]\rIncomeStatement \u0026lt;- apply(IncomeStatement, 2, function(x){gsub(\u0026quot;,\u0026quot;,\u0026quot;\u0026quot;,x)})\rIncomeStatement \u0026lt;- as.data.frame(apply(IncomeStatement, 2, as.numeric))\rrownames(IncomeStatement) \u0026lt;- paste(names_row)\rtemp1 \u0026lt;- IncomeStatement\r# Collect the Balance Sheet data\rlink \u0026lt;- \u0026quot;https://finance.yahoo.com/quote/\u0026quot;\rlink \u0026lt;- paste0(link, stock[i],\u0026quot;/balance-sheet?p=\u0026quot;, stock[i])\rwahis.session \u0026lt;- html_session(link)\rp \u0026lt;- wahis.session %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;Col1-1-Financials-Proxy\u0026quot;]/section/div[3]/table\u0026#39;)%\u0026gt;%\rhtml_table(fill = TRUE)\rBalanceSheet \u0026lt;- p[[1]]\rcolnames(BalanceSheet) \u0026lt;- BalanceSheet[1,]\rBalanceSheet \u0026lt;- BalanceSheet[-c(1,2,17,28),]\rnames_row \u0026lt;- BalanceSheet[,1]\rBalanceSheet \u0026lt;- BalanceSheet[,-1]\rBalanceSheet \u0026lt;- apply(BalanceSheet, 2, function(x){gsub(\u0026quot;,\u0026quot;,\u0026quot;\u0026quot;,x)})\rBalanceSheet \u0026lt;- as.data.frame(apply(BalanceSheet, 2, as.numeric))\rrownames(BalanceSheet) \u0026lt;- paste(names_row)\rtemp2 \u0026lt;- BalanceSheet\r# Collect the Cash Flow data\rlink \u0026lt;- \u0026quot;https://finance.yahoo.com/quote/\u0026quot;\rlink \u0026lt;- paste0(link, stock[i], \u0026quot;/cash-flow?p=\u0026quot;, stock[i])\rwahis.session \u0026lt;- html_session(link)\rp \u0026lt;- wahis.session %\u0026gt;%\rhtml_nodes(xpath = \u0026#39;//*[@id=\u0026quot;Col1-1-Financials-Proxy\u0026quot;]/section/div[3]/table\u0026#39;)%\u0026gt;%\rhtml_table(fill = TRUE)\rCashFlow \u0026lt;- p[[1]]\rcolnames(CashFlow) \u0026lt;- CashFlow[1,]\rCashFlow \u0026lt;- CashFlow[-c(1,3,11,16),]\rnames_row \u0026lt;- CashFlow[,1]\rCashFlow \u0026lt;- CashFlow[,-1]\rCashFlow \u0026lt;- apply(CashFlow, 2, function(x){gsub(\u0026quot;,\u0026quot;,\u0026quot;\u0026quot;,x)})\rCashFlow \u0026lt;- as.data.frame(apply(CashFlow, 2, as.numeric))\rrownames(CashFlow) \u0026lt;- paste(names_row)\rtemp3 \u0026lt;- CashFlow\rassign(paste0(stock[i],\u0026#39;.f\u0026#39;),value = list(IncomeStatement = temp1, BalanceSheet = temp2, CashFlow = temp3), envir = parent.frame())\r},\rerror = function(cond){\rmessage(stock[i], \u0026quot;Give error \u0026quot;,cond)\r}\r)\r}\r}\rWe can inspect Nvidia’s recent performance by scraping Yahoo finance. The original getFinancials option from the package quantmod became defunct a little while ago, however I have been using this function without problems ever since. You can just add tickers to the symbols object to download more company financial accounts.\nsymbols \u0026lt;- c(\u0026quot;NVDA\u0026quot;)\rgetFin(symbols)\rsymbols.f \u0026lt;- sapply(symbols, function(x) { paste0(x, \u0026quot;.f\u0026quot;) })\rtickers \u0026lt;- list2env(mget(symbols.f))\rIS \u0026lt;- lapply(tickers, \u0026quot;[[\u0026quot;, \u0026quot;IncomeStatement\u0026quot;)\rBS \u0026lt;- lapply(tickers, \u0026quot;[[\u0026quot;, \u0026quot;BalanceSheet\u0026quot;)\rCF \u0026lt;- lapply(tickers, \u0026quot;[[\u0026quot;, \u0026quot;CashFlow\u0026quot;)\rIS \u0026lt;- as.data.frame(IS)\rBS \u0026lt;- as.data.frame(BS)\rCF \u0026lt;- as.data.frame(CF)\rNvidia’s Income Statement data.\rIS %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\r\rNVDA.f.1.27.2019\r\rNVDA.f.1.28.2018\r\rNVDA.f.1.29.2017\r\rNVDA.f.1.31.2016\r\r\r\r\r\rTotal Revenue\r\r11716000\r\r9714000\r\r6910000\r\r5010000\r\r\r\rCost of Revenue\r\r4545000\r\r3892000\r\r2847000\r\r2199000\r\r\r\rGross Profit\r\r7171000\r\r5822000\r\r4063000\r\r2811000\r\r\r\rResearch Development\r\r2376000\r\r1797000\r\r1463000\r\r1331000\r\r\r\rSelling General and Administrative\r\r991000\r\r815000\r\r663000\r\r602000\r\r\r\rNon Recurring\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rOthers\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rTotal Operating Expenses\r\r7912000\r\r6504000\r\r4973000\r\r4132000\r\r\r\rOperating Income or Loss\r\r3804000\r\r3210000\r\r1937000\r\r878000\r\r\r\rTotal Other Income/Expenses Net\r\r92000\r\r-14000\r\r-32000\r\r-135000\r\r\r\rEarnings Before Interest and Taxes\r\r3804000\r\r3210000\r\r1937000\r\r878000\r\r\r\rInterest Expense\r\r-58000\r\r-61000\r\r-58000\r\r-47000\r\r\r\rIncome Before Tax\r\r3896000\r\r3196000\r\r1905000\r\r743000\r\r\r\rIncome Tax Expense\r\r-245000\r\r149000\r\r239000\r\r129000\r\r\r\rMinority Interest\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Income From Continuing Ops\r\r4141000\r\r3047000\r\r1666000\r\r614000\r\r\r\rDiscontinued Operations\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rExtraordinary Items\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rEffect Of Accounting Changes\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rOther Items\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Income\r\r4141000\r\r3047000\r\r1666000\r\r614000\r\r\r\rPreferred Stock And Other Adjustments\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Income Applicable To Common Shares\r\r4141000\r\r3047000\r\r1666000\r\r614000\r\r\r\r\r\rNvidia’s Balance Sheet Information.\rBS %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\r\rNVDA.f.1.27.2019\r\rNVDA.f.1.28.2018\r\rNVDA.f.1.29.2017\r\rNVDA.f.1.31.2016\r\r\r\r\r\rCash And Cash Equivalents\r\r782000\r\r4002000\r\r1766000\r\r596000\r\r\r\rShort Term Investments\r\r6640000\r\r3106000\r\r5032000\r\r4441000\r\r\r\rNet Receivables\r\r1424000\r\r1265000\r\r826000\r\r505000\r\r\r\rInventory\r\r1575000\r\r796000\r\r794000\r\r418000\r\r\r\rOther Current Assets\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rTotal Current Assets\r\r10557000\r\r9255000\r\r8536000\r\r6053000\r\r\r\rLong Term Investments\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rProperty, plant and equipment\r\r1404000\r\r997000\r\r521000\r\r466000\r\r\r\rGoodwill\r\r618000\r\r618000\r\r618000\r\r618000\r\r\r\rIntangible Assets\r\r45000\r\r52000\r\r104000\r\r166000\r\r\r\rAccumulated Amortization\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rOther Assets\r\r668000\r\r319000\r\r62000\r\r67000\r\r\r\rDeferred Long Term Asset Charges\r\r560000\r\r245000\r\rNA\r\rNA\r\r\r\rTotal Assets\r\r13292000\r\r11241000\r\r9841000\r\r7370000\r\r\r\rAccounts Payable\r\r511000\r\r596000\r\r485000\r\r296000\r\r\r\rShort/Current Long Term Debt\r\rNA\r\r15000\r\r796000\r\r1413000\r\r\r\rOther Current Liabilities\r\r588000\r\r318000\r\r325000\r\r532000\r\r\r\rTotal Current Liabilities\r\r1329000\r\r1153000\r\r1788000\r\r2351000\r\r\r\rLong Term Debt\r\r1988000\r\r1985000\r\r1983000\r\r7000\r\r\r\rOther Liabilities\r\r633000\r\r632000\r\r308000\r\r533000\r\r\r\rDeferred Long Term Liability Charges\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rMinority Interest\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNegative Goodwill\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rTotal Liabilities\r\r3950000\r\r3770000\r\r4079000\r\r2901000\r\r\r\rMisc. Stocks Options Warrants\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rRedeemable Preferred Stock\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rPreferred Stock\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rCommon Stock\r\r1000\r\r1000\r\r1000\r\r1000\r\r\r\rRetained Earnings\r\r12565000\r\r8787000\r\r6108000\r\r4350000\r\r\r\rTreasury Stock\r\r-9275000\r\r-6668000\r\r-5055000\r\r-4052000\r\r\r\rCapital Surplus\r\r6051000\r\r5351000\r\r4708000\r\r4170000\r\r\r\rOther Stockholder Equity\r\r-12000\r\r-18000\r\r-16000\r\r-4000\r\r\r\rTotal stockholders’ equity\r\r9342000\r\r7471000\r\r5762000\r\r4469000\r\r\r\rNet Tangible Assets\r\r8679000\r\r6801000\r\r5040000\r\r3685000\r\r\r\r\r\rNvidia’s Cash Flow Statements\rCF %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\r\rNVDA.f.1.27.2019\r\rNVDA.f.1.28.2018\r\rNVDA.f.1.29.2017\r\rNVDA.f.1.31.2016\r\r\r\r\r\rNet Income\r\r4141000\r\r3047000\r\r1666000\r\r614000\r\r\r\rDepreciation\r\r262000\r\r199000\r\r187000\r\r197000\r\r\r\rAdjustments To Net Income\r\r197000\r\r71000\r\r498000\r\r386000\r\r\r\rChanges In Accounts Receivables\r\r-149000\r\r-440000\r\r-321000\r\r-32000\r\r\r\rChanges In Liabilities\r\r-135000\r\r90000\r\r184000\r\r-11000\r\r\r\rChanges In Inventories\r\r-776000\r\r-776000\r\r-375000\r\r66000\r\r\r\rChanges In Other Operating Activities\r\r203000\r\r535000\r\r-167000\r\r-74000\r\r\r\rTotal Cash Flow From Operating Activities\r\r3743000\r\r3502000\r\r1672000\r\r1175000\r\r\r\rCapital Expenditure\r\r-600000\r\r-593000\r\r-176000\r\r-86000\r\r\r\rInvestments\r\r-3497000\r\r1869000\r\r-624000\r\r-345000\r\r\r\rOther Cash flows from Investing Activities\r\rNA\r\rNA\r\r-5000\r\r24000\r\r\r\rTotal Cash Flows From Investing Activities\r\r-4097000\r\r1278000\r\r-793000\r\r-400000\r\r\r\rDividends Paid\r\r-371000\r\r-341000\r\r-261000\r\r-213000\r\r\r\rSale Purchase of Stock\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rNet Borrowings\r\r-16000\r\r-812000\r\r1315000\r\r1315000\r\r\r\rOther Cash Flows from Financing Activities\r\r-5000\r\r-9000\r\r-15000\r\r4000\r\r\r\rTotal Cash Flows From Financing Activities\r\r-2866000\r\r-2544000\r\r291000\r\r-676000\r\r\r\rEffect Of Exchange Rate Changes\r\rNA\r\rNA\r\rNA\r\rNA\r\r\r\rChange In Cash and Cash Equivalents\r\r-3220000\r\r2236000\r\r1170000\r\r99000\r\r\r\r\rNvidia’s fundamentals looked solid after some analysis, but taking into account per share ratios, I changed my opinion. Their share price seemed overvalued compared to their business performance.\nI wanted to track their performance and compare it to Nvidia’s competitors. I downloaded price data using the tidyquant package.\n############### Collect the stock price and benchmark data #############\rnvda \u0026lt;- \u0026quot;NVDA\u0026quot; %\u0026gt;%\rtq_get(get = \u0026quot;stock.prices\u0026quot;,\rfrom = \u0026quot;2017-01-01\u0026quot;,\rto = Sys.Date())\ramd \u0026lt;- \u0026quot;AMD\u0026quot; %\u0026gt;%\rtq_get(get = \u0026quot;stock.prices\u0026quot;,\rfrom = \u0026quot;2017-01-01\u0026quot;,\rto = Sys.Date())\rtxn \u0026lt;- \u0026quot;TXN\u0026quot; %\u0026gt;%\rtq_get(get = \u0026quot;stock.prices\u0026quot;,\rfrom = \u0026quot;2017-01-01\u0026quot;,\rto = Sys.Date())\rintc \u0026lt;- \u0026quot;INTC\u0026quot; %\u0026gt;%\rtq_get(get = \u0026quot;stock.prices\u0026quot;,\rfrom = \u0026quot;2017-01-01\u0026quot;,\rto = Sys.Date())\rnasdaq \u0026lt;- \u0026quot;^IXIC\u0026quot; %\u0026gt;%\rtq_get(get = \u0026quot;stock.prices\u0026quot;,\rfrom = \u0026quot;2017-01-01\u0026quot;,\rto = Sys.Date())\rJoining all the stock price data together along with a benchmark NASDAQ:\n\rStock Price Data\r########## Join the data together ###########\r# Ra is the asset price\r# Rb is the benchmark price (NASDAQ)\rRaRb \u0026lt;- nvda %\u0026gt;%\rfull_join(., amd, by = \u0026quot;date\u0026quot;) %\u0026gt;%\rfull_join(., intc, by = \u0026quot;date\u0026quot;) %\u0026gt;%\rfull_join(., nasdaq, by = \u0026quot;date\u0026quot;) %\u0026gt;%\rselect(date, adjusted.x, adjusted.y, adjusted.x.x, adjusted.y.y) %\u0026gt;%\rsetNames(c(\u0026quot;date\u0026quot;, \u0026quot;NVDA\u0026quot;, \u0026quot;AMD\u0026quot;, \u0026quot;INTC\u0026quot;, \u0026quot;NASDAQ\u0026quot;))\rRaRb %\u0026gt;%\rhead(6) %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rdate\r\rNVDA\r\rAMD\r\rINTC\r\rNASDAQ\r\r\r\r\r\r2017-01-03\r\r101.0116\r\r11.43\r\r34.06019\r\r5429.08\r\r\r\r2017-01-04\r\r103.3683\r\r11.43\r\r33.88338\r\r5477.00\r\r\r\r2017-01-05\r\r100.7443\r\r11.24\r\r33.82755\r\r5487.94\r\r\r\r2017-01-06\r\r102.0910\r\r11.32\r\r33.94852\r\r5521.06\r\r\r\r2017-01-09\r\r106.2301\r\r11.49\r\r34.06950\r\r5531.82\r\r\r\r2017-01-10\r\r105.4280\r\r11.44\r\r34.00436\r\r5551.82\r\r\r\r\rIt’s still quite difficult to compare Nvidia’s performance based on the raw stock price data, so I normalise the data.\n############# Normalise the data ################## normalise_series \u0026lt;- function(xdat) xdat / coredata(xdat)[1]\rnormalised_RaRb \u0026lt;- RaRb %\u0026gt;%\rmutate(NVDA = normalise_series(NVDA),\rAMD = normalise_series(AMD),\rINTC = normalise_series(INTC),\rNASDAQ = normalise_series(NASDAQ))\rThe first few observations normalised\rnormalised_RaRb %\u0026gt;%\rhead() %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rdate\r\rNVDA\r\rAMD\r\rINTC\r\rNASDAQ\r\r\r\r\r\r2017-01-03\r\r1.0000000\r\r1.0000000\r\r1.0000000\r\r1.000000\r\r\r\r2017-01-04\r\r1.0233309\r\r1.0000000\r\r0.9948089\r\r1.008827\r\r\r\r2017-01-05\r\r0.9973533\r\r0.9833771\r\r0.9931697\r\r1.010842\r\r\r\r2017-01-06\r\r1.0106853\r\r0.9903762\r\r0.9967214\r\r1.016942\r\r\r\r2017-01-09\r\r1.0516616\r\r1.0052493\r\r1.0002734\r\r1.018924\r\r\r\r2017-01-10\r\r1.0437212\r\r1.0008749\r\r0.9983608\r\r1.022608\r\r\r\r\r\rThe last few observations normalised\rnormalised_RaRb %\u0026gt;%\rtail() %\u0026gt;%\rkable() %\u0026gt;%\rkable_styling(bootstrap_options = c(\u0026quot;striped\u0026quot;, \u0026quot;hover\u0026quot;, \u0026quot;condensed\u0026quot;, \u0026quot;responsive\u0026quot;))\r\r\rdate\r\rNVDA\r\rAMD\r\rINTC\r\rNASDAQ\r\r\r\r\r\r2019-09-18\r\r1.781775\r\r2.661417\r\r1.519076\r\r1.506220\r\r\r\r2019-09-19\r\r1.751679\r\r2.650044\r\r1.514084\r\r1.507231\r\r\r\r2019-09-20\r\r1.709605\r\r2.629046\r\r1.489129\r\r1.495220\r\r\r\r2019-09-23\r\r1.730890\r\r2.680665\r\r1.494413\r\r1.494260\r\r\r\r2019-09-24\r\r1.708021\r\r2.582677\r\r1.462705\r\r1.472373\r\r\r\r2019-09-25\r\r1.764450\r\r2.584427\r\r1.497936\r\r1.487800\r\r\r\r\rThe data looks a lot more comparable. I plot the results in ggplot2\nnormalised_RaRb %\u0026gt;%\rmelt(id = \u0026quot;date\u0026quot;) %\u0026gt;%\rggplot(aes(x = date, y = value, color = variable)) +\rgeom_line(aes(linetype = variable)) +\r#scale_color_manual(values=c(\u0026quot;red\u0026quot;, \u0026quot;black\u0026quot;, \u0026quot;darkblue\u0026quot;, \u0026quot;yellow\u0026quot;, \u0026quot;green\u0026quot;)) +\rlabs(title = \u0026quot;Normalised NVDA, AMD, INTC and NASDAQ Benchmark\u0026quot;,\rx = \u0026quot;\u0026quot;, subtitle = \u0026quot;From January 2017 - to Sys.Date()\u0026quot;, y = \u0026quot;Normalised Price US$\u0026quot;, color = \u0026quot;\u0026quot;) +\rscale_y_continuous(labels = scales::dollar) +\rtheme_tq(base_size = 8) +\rgeom_dl(aes(label = variable), method = list(dl.combine(\u0026quot;last.points\u0026quot;), cex = 1)) +\rscale_color_manual(values = c(NASDAQ = \u0026#39;black\u0026#39;,\rNVDA = \u0026#39;darkgreen\u0026#39;,\rAMD = \u0026#39;red\u0026#39;,\rINTC = \u0026#39;blue\u0026#39;)) +\rtheme(legend.position = \u0026quot;none\u0026quot;)\rSo $1 invested in Nvidia back in Jan 2017 would have given you aprox $2.75 return if you sold at the back end of 2018, however the price today would be around $1.60. Compare that with AMD you would have got the same return of $2.75 if you sold at the same time as Nvidia but today your return would be more or less the same at aprox $2.75 despite a drop in AMD’s share price at the same time as NVDA.\n\r\r","date":1569024000,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1569024000,"objectID":"c2aa200a1e4f62d114380c7ef46581d6","permalink":"/post/nvidia-share-price/","publishdate":"2019-09-21T00:00:00Z","relpermalink":"/post/nvidia-share-price/","section":"post","summary":"Nvidia's stock was outperforming it's industry peers during 2017 - 2019. I analyse their performance.","tags":["fundamentals","finance","yahoo-finance"],"title":"Tracking NVDA's share price","type":"post"},{"authors":[],"categories":[],"content":" Welcome to Slides Academic\nFeatures  Efficiently write slides in Markdown 3-in-1: Create, Present, and Publish your slides Supports speaker notes Mobile friendly slides  Controls  Next: Right Arrow or Space Previous: Left Arrow Start: Home Finish: End Overview: Esc Speaker notes: S Fullscreen: F Zoom: Alt + Click PDF Export: E  Code Highlighting Inline code: variable\nCode block:\nporridge = \u0026quot;blueberry\u0026quot; if porridge == \u0026quot;blueberry\u0026quot;: print(\u0026quot;Eating...\u0026quot;)  Math In-line math: $x + y = z$\nBlock math:\n$$ f\\left( x \\right) = \\;\\frac{{2\\left( {x + 4} \\right)\\left( {x - 4} \\right)}}{{\\left( {x + 4} \\right)\\left( {x + 1} \\right)}} $$\nFragments Make content appear incrementally\n{{% fragment %}} One {{% /fragment %}} {{% fragment %}} **Two** {{% /fragment %}} {{% fragment %}} Three {{% /fragment %}}  Press Space to play!\nOne  Two  Three \nA fragment can accept two optional parameters:\n class: use a custom style (requires definition in custom CSS) weight: sets the order in which a fragment appears  Speaker Notes Add speaker notes to your presentation\n{{% speaker_note %}} - Only the speaker can read these notes - Press `S` key to view {{% /speaker_note %}}  Press the S key to view the speaker notes!\n Only the speaker can read these notes Press S key to view   Themes  black: Black background, white text, blue links (default) white: White background, black text, blue links league: Gray background, white text, blue links beige: Beige background, dark text, brown links sky: Blue background, thin dark text, blue links   night: Black background, thick white text, orange links serif: Cappuccino background, gray text, brown links simple: White background, black text, blue links solarized: Cream-colored background, dark green text, blue links  Custom Slide Customize the slide style and background\n{{\u0026lt; slide background-image=\u0026quot;/img/boards.jpg\u0026quot; \u0026gt;}} {{\u0026lt; slide background-color=\u0026quot;#0000FF\u0026quot; \u0026gt;}} {{\u0026lt; slide class=\u0026quot;my-style\u0026quot; \u0026gt;}}  Custom CSS Example Let\u0026rsquo;s make headers navy colored.\nCreate assets/css/reveal_custom.css with:\n.reveal section h1, .reveal section h2, .reveal section h3 { color: navy; }  Questions? Ask\nDocumentation\n","date":1549324800,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1549324800,"objectID":"0e6de1a61aa83269ff13324f3167c1a9","permalink":"/slides/example/","publishdate":"2019-02-05T00:00:00Z","relpermalink":"/slides/example/","section":"slides","summary":"An introduction to using Academic's Slides feature.","tags":[],"title":"Slides","type":"slides"},{"authors":null,"categories":null,"content":"","date":1461715200,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1461715200,"objectID":"d1311ddf745551c9e117aa4bb7e28516","permalink":"/project/external-project/","publishdate":"2016-04-27T00:00:00Z","relpermalink":"/project/external-project/","section":"project","summary":"An example of linking directly to an external project website using `external_link`.","tags":["Demo"],"title":"External Project","type":"project"},{"authors":null,"categories":null,"content":"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis posuere tellus ac convallis placerat. Proin tincidunt magna sed ex sollicitudin condimentum. Sed ac faucibus dolor, scelerisque sollicitudin nisi. Cras purus urna, suscipit quis sapien eu, pulvinar tempor diam. Quisque risus orci, mollis id ante sit amet, gravida egestas nisl. Sed ac tempus magna. Proin in dui enim. Donec condimentum, sem id dapibus fringilla, tellus enim condimentum arcu, nec volutpat est felis vel metus. Vestibulum sit amet erat at nulla eleifend gravida.\nNullam vel molestie justo. Curabitur vitae efficitur leo. In hac habitasse platea dictumst. Sed pulvinar mauris dui, eget varius purus congue ac. Nulla euismod, lorem vel elementum dapibus, nunc justo porta mi, sed tempus est est vel tellus. Nam et enim eleifend, laoreet sem sit amet, elementum sem. Morbi ut leo congue, maximus velit ut, finibus arcu. In et libero cursus, rutrum risus non, molestie leo. Nullam congue quam et volutpat malesuada. Sed risus tortor, pulvinar et dictum nec, sodales non mi. Phasellus lacinia commodo laoreet. Nam mollis, erat in feugiat consectetur, purus eros egestas tellus, in auctor urna odio at nibh. Mauris imperdiet nisi ac magna convallis, at rhoncus ligula cursus.\nCras aliquam rhoncus ipsum, in hendrerit nunc mattis vitae. Duis vitae efficitur metus, ac tempus leo. Cras nec fringilla lacus. Quisque sit amet risus at ipsum pharetra commodo. Sed aliquam mauris at consequat eleifend. Praesent porta, augue sed viverra bibendum, neque ante euismod ante, in vehicula justo lorem ac eros. Suspendisse augue libero, venenatis eget tincidunt ut, malesuada at lorem. Donec vitae bibendum arcu. Aenean maximus nulla non pretium iaculis. Quisque imperdiet, nulla in pulvinar aliquet, velit quam ultrices quam, sit amet fringilla leo sem vel nunc. Mauris in lacinia lacus.\nSuspendisse a tincidunt lacus. Curabitur at urna sagittis, dictum ante sit amet, euismod magna. Sed rutrum massa id tortor commodo, vitae elementum turpis tempus. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean purus turpis, venenatis a ullamcorper nec, tincidunt et massa. Integer posuere quam rutrum arcu vehicula imperdiet. Mauris ullamcorper quam vitae purus congue, quis euismod magna eleifend. Vestibulum semper vel augue eget tincidunt. Fusce eget justo sodales, dapibus odio eu, ultrices lorem. Duis condimentum lorem id eros commodo, in facilisis mauris scelerisque. Morbi sed auctor leo. Nullam volutpat a lacus quis pharetra. Nulla congue rutrum magna a ornare.\nAliquam in turpis accumsan, malesuada nibh ut, hendrerit justo. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Quisque sed erat nec justo posuere suscipit. Donec ut efficitur arcu, in malesuada neque. Nunc dignissim nisl massa, id vulputate nunc pretium nec. Quisque eget urna in risus suscipit ultricies. Pellentesque odio odio, tincidunt in eleifend sed, posuere a diam. Nam gravida nisl convallis semper elementum. Morbi vitae felis faucibus, vulputate orci placerat, aliquet nisi. Aliquam erat volutpat. Maecenas sagittis pulvinar purus, sed porta quam laoreet at.\n","date":1461715200,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1461715200,"objectID":"8f66d660a9a2edc2d08e68cc30f701f7","permalink":"/project/internal-project/","publishdate":"2016-04-27T00:00:00Z","relpermalink":"/project/internal-project/","section":"project","summary":"An example of using the in-built project page.","tags":["Deep Learning"],"title":"Internal Project","type":"project"}]