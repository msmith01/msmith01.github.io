<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>quantstrat | Matthew Smith R Shenanigans</title>
    <link>/tags/quantstrat/</link>
      <atom:link href="/tags/quantstrat/index.xml" rel="self" type="application/rss+xml" />
    <description>quantstrat</description>
    <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator><language>en-us</language><lastBuildDate>Mon, 27 Jan 2020 00:00:00 +0000</lastBuildDate>
    <image>
      <url>/img/icon-192.png</url>
      <title>quantstrat</title>
      <link>/tags/quantstrat/</link>
    </image>
    
    <item>
      <title>Quantitative Analytics: Optimal Portfolio Allocation</title>
      <link>/post/portfolio-optimisation-model/portfolio-optimisation-r/</link>
      <pubDate>Mon, 27 Jan 2020 00:00:00 +0000</pubDate>
      <guid>/post/portfolio-optimisation-model/portfolio-optimisation-r/</guid>
      <description>
&lt;script src=&#34;/rmarkdown-libs/kePrint/kePrint.js&#34;&gt;&lt;/script&gt;


&lt;div id=&#34;introduction&#34; class=&#34;section level1 tabset tabset-fade tabset-pills&#34;&gt;
&lt;h1&gt;Introduction:&lt;/h1&gt;
&lt;p&gt;The literature in portfolio optimisation has been around for decades. In this post I cover a number of traditional portfolio optimisation models. The general aim is to select a portfolio of assets out of a set of all possible portfolios being considered with a defined objective function.&lt;/p&gt;
&lt;div id=&#34;the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;The data:&lt;/h2&gt;
&lt;p&gt;The data is collected using the &lt;code&gt;tidyquant()&lt;/code&gt; package’s &lt;code&gt;tq_get()&lt;/code&gt; function. I then convert the daily asset prices to daily log returns using the &lt;code&gt;periodReturn&lt;/code&gt; function from the &lt;code&gt;quantmod()&lt;/code&gt; package. Next I construct &lt;code&gt;lists&lt;/code&gt; of 6 months worth of daily returns using the &lt;code&gt;rolling_origin()&lt;/code&gt; function from the &lt;code&gt;rsample()&lt;/code&gt; package. The objective is to compute on a rolling basis the 6 month mean returns &lt;code&gt;mus&lt;/code&gt; and the 6 month covariance matrices &lt;code&gt;Sigmas&lt;/code&gt; on the training sets (i.e. 6 months) and apply them on the test sets (i.e. 1 month later) - monthly rebalancing.&lt;/p&gt;
&lt;p&gt;Just as with the returns data, the same is applied to the monthly prices data.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;start_date &amp;lt;- &amp;quot;2013-01-01&amp;quot;
end_date &amp;lt;- &amp;quot;2017-08-31&amp;quot;
symbols &amp;lt;- c(&amp;quot;AAPL&amp;quot;, &amp;quot;ABBV&amp;quot;, &amp;quot;A&amp;quot;,  &amp;quot;APD&amp;quot;, &amp;quot;AA&amp;quot;, &amp;quot;CF&amp;quot;, &amp;quot;NVDA&amp;quot;, &amp;quot;HOG&amp;quot;, &amp;quot;WMT&amp;quot;, &amp;quot;AMZN&amp;quot;
            #,&amp;quot;MSFT&amp;quot;, &amp;quot;F&amp;quot;, &amp;quot;INTC&amp;quot;, &amp;quot;ADBE&amp;quot;, &amp;quot;AMG&amp;quot;, &amp;quot;AKAM&amp;quot;, &amp;quot;ALB&amp;quot;, &amp;quot;ALK&amp;quot;
            )

portfolio_prices &amp;lt;- tq_get(
  symbols,
  from = start_date,
  to = end_date,
) %&amp;gt;% 
  select(symbol, date, adjusted)


portfolio_monthly_returns &amp;lt;- portfolio_prices %&amp;gt;% 
  group_by(symbol) %&amp;gt;% 
  tq_transmute(
    select = adjusted,
    mutate_fun = periodReturn,
    period = &amp;quot;daily&amp;quot;,                              
    type = &amp;quot;log&amp;quot;,
  ) %&amp;gt;% 
  pivot_wider(names_from = symbol, values_from = daily.returns) %&amp;gt;% 
  mutate(year_month = yearmonth(date)) %&amp;gt;% 
  nest(-year_month) %&amp;gt;% 
  rolling_origin(
    initial = 6,
    assess = 1,
    skip = 0,
    cumulative = FALSE)


portfolio_monthly_prices &amp;lt;- portfolio_prices %&amp;gt;%
  pivot_wider(names_from = symbol, values_from = adjusted) %&amp;gt;% 
  mutate(year_month = yearmonth(date)) %&amp;gt;% 
  nest(-year_month) %&amp;gt;% 
  rolling_origin(
    initial = 6,
    assess = 1,
    skip = 0,
    cumulative = FALSE)

ListNamesDates &amp;lt;- map(portfolio_monthly_returns$splits, ~assessment(.x) %&amp;gt;%
                        select(year_month)) %&amp;gt;%
  plyr::ldply(., data.frame) %&amp;gt;% 
  pull(year_month)

#########

# Goal is to define the mean and covariance matrix on the training sets and apply them on the test sets - monthly rebalancing

mus &amp;lt;- map(portfolio_monthly_returns$splits, ~ analysis(.x) %&amp;gt;% 
             unnest(data) %&amp;gt;%
             select(-year_month, -date) %&amp;gt;%
             colMeans) %&amp;gt;%
  setNames(c(ListNamesDates))

Sigmas &amp;lt;- map(portfolio_monthly_returns$splits, ~ analysis(.x) %&amp;gt;%
                unnest() %&amp;gt;%
                tk_xts(., date_var = date) %&amp;gt;%
                cov(.)) %&amp;gt;% 
  setNames(c(ListNamesDates))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;price-and-returns-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Price and Returns data&lt;/h2&gt;
&lt;p&gt;The returns data for the first &lt;code&gt;split&lt;/code&gt; looks like the following:&lt;/p&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AAPL
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
ABBV
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
A
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
APD
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
CF
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
NVDA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
HOG
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
WMT
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AMZN
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000000
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.012702708
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.008291331
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.003575412
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0035002417
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.008859253
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.004740086
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0007860485
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.020819530
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0063746748
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0045367882
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.028249939
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.012713395
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.019555411
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0133515376
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.020731797
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.022151612
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0324601827
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.005529864
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0037720098
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0025886574
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.005899428
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.002033327
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.007259372
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0009230752
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.017429792
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.003753198
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0293228286
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.006958715
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0096029606
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0352948721
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.002687379
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.022004791
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.008022622
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0018451781
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.014768451
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0221704307
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.003063936
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0027737202
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0077780140
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.015752246
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.005620792
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.026649604
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0133906716
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.002200109
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.034376015
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0226730363
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.038724890
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0002916231
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0001126237
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div id=&#34;the-statistics&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;The statistics&lt;/h2&gt;
&lt;p&gt;The &lt;code&gt;Mus&lt;/code&gt; (mean returns) data looks like:&lt;/p&gt;
&lt;table class=&#34;kable_wrapper table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
x
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
AAPL
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0025241
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
ABBV
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0014847
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
A
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0002314
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
APD
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0006546
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
AA
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0010700
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
CF
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0013681
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
NVDA
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0008864
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
HOG
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0008061
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
WMT
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0006895
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
AMZN
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0006147
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;The &lt;code&gt;Sigmas&lt;/code&gt; (covariance matrix) data looks like:&lt;/p&gt;
&lt;table class=&#34;kable_wrapper table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AAPL
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
ABBV
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
A
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
APD
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
CF
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
NVDA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
HOG
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
WMT
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AMZN
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
AAPL
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0004166
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000220
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000112
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000388
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000528
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000277
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000408
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000116
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000038
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000366
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
ABBV
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000220
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0003128
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000490
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000393
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000137
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000472
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000511
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000732
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000258
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000295
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
A
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000112
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000490
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0002061
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000720
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000741
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000885
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000930
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0001175
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000371
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0001139
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
APD
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000388
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000393
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000720
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000993
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000523
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000687
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000578
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000744
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000107
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000511
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
AA
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000528
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000137
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000741
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000523
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0001485
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000874
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000685
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000674
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000012
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000383
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
CF
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000277
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000472
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000885
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000687
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000874
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0002271
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000706
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000900
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000112
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000606
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
NVDA
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000408
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000511
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000930
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000578
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000685
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000706
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0002092
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000706
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000127
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000853
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
HOG
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000116
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000732
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0001175
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000744
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000674
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000900
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000706
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0002393
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000214
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000895
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
WMT
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000038
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000258
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000371
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000107
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000012
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000112
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000127
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000214
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000682
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000236
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
AMZN
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000366
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000295
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0001139
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000511
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000383
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000606
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000853
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000895
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000236
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0003118
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;comparing-portfolio-optimisation&#34; class=&#34;section level1 tabset tabset-fade tabset-pills&#34;&gt;
&lt;h1&gt;Comparing Portfolio Optimisation&lt;/h1&gt;
&lt;div id=&#34;global-minimum-variance-portfolio&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Global Minimum Variance Portfolio&lt;/h2&gt;
&lt;p&gt;The global minimum-variance portfolio &lt;span class=&#34;math inline&#34;&gt;\(w^{gmv}\)&lt;/span&gt; is a portfolio of assets with gives us the lowest possible return variance or portfolio volatility. Volatility here is used as a replacement for risk, thus with less variance in volatility correlates to less risk in an asset. The portfolio focuses only on risk and ignores expected returns.&lt;/p&gt;
&lt;p&gt;The objective function is;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[\begin{eqnarray} \min_{w} w^{T} \Sigma w \\
\text{subject to } 1^{T}w = 1 \\
w \ge 0 \end{eqnarray}\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Since &lt;span class=&#34;math inline&#34;&gt;\(\Sigma\)&lt;/span&gt; is unknown we can estimate it as &lt;span class=&#34;math inline&#34;&gt;\(\hat{\Sigma}\)&lt;/span&gt; with the covariance matrix. In which the convex solution becomes:&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[W = \dfrac{1}{1^{T}\hat{\Sigma}^{-1}1}\hat{\Sigma}^{-1}1\]&lt;/span&gt;
The objective is that we want to find the optimial weights from the model such that our risk is minimised.&lt;/p&gt;
&lt;p&gt;The below problem consists of our &lt;span class=&#34;math inline&#34;&gt;\(Minimisation\)&lt;/span&gt; problem &lt;span class=&#34;math inline&#34;&gt;\(\min_{w} w^{T} \Sigma w\)&lt;/span&gt;. The &lt;code&gt;quad_form&lt;/code&gt; function takes the quadratic form &lt;span class=&#34;math inline&#34;&gt;\(x^T Px\)&lt;/span&gt; where &lt;span class=&#34;math inline&#34;&gt;\(x\)&lt;/span&gt; is a vector and &lt;span class=&#34;math inline&#34;&gt;\(P\)&lt;/span&gt; is a matrix or in our case &lt;span class=&#34;math inline&#34;&gt;\(w\)&lt;/span&gt; is our weights vector and &lt;span class=&#34;math inline&#34;&gt;\(\Sigma\)&lt;/span&gt; is the covariance matrix for &lt;span class=&#34;math inline&#34;&gt;\(A_{1}, \dots, A_{5}\)&lt;/span&gt;. The &lt;code&gt;constraints&lt;/code&gt; correspond to &lt;span class=&#34;math inline&#34;&gt;\(1^{T}w = 1\)&lt;/span&gt; in which we cannot assign negative weights to our assets and that we invest all our capital in the portfolio.&lt;/p&gt;
&lt;p&gt;We can use the Disciplined Convex Programming (&lt;code&gt;CVXR&lt;/code&gt;) package in R, which;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Analyses the problem,&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Verifies the convexity,&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Converts the problem into canonical form,&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Solves the problem.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;We want to find the optimial weights from the model such that our risk is minimised. We can do this by solving the optimisation problem, bind the lists into a single data frame and use &lt;code&gt;ggplot2&lt;/code&gt; to plot the rolling one month out of sample optimal portfolio weights - based on the previous 6 months rolled &lt;code&gt;mus&lt;/code&gt; and &lt;code&gt;Sigmas&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 1) Function: Global Minimum Variance Portfolio
GMVPportolioFunction &amp;lt;- function(Sigma) {
  w &amp;lt;- Variable(nrow(Sigma))
  problem &amp;lt;- Problem(               # Initialise the problem
    Minimize(                       # minimse or maximise objective function
      quad_form(
        w, Sigma                    # Model inputs, the number of weights to consider and the covariance matrix
        )
      ), 
    constraints = list(
      w &amp;gt;= 0,                       # First model constraint
      sum(w) == 1))                 # Second model constrain
  Solution &amp;lt;- solve(problem, solver=&amp;quot;SCS&amp;quot;)        # Solves the problem
  return(as.vector(Solution$getValue(w)))
}

# 1a) Portfolio GMVP
GMVPPortfolio &amp;lt;- map(
  .x = Sigmas,
  GMVPportolioFunction)

# 1b) Portfolio GMVP
GMVPPortfolioWeights &amp;lt;- setNames(GMVPPortfolio, ListNamesDates) %&amp;gt;% 
  map(.,  ~setNames(., c(symbols))) %&amp;gt;% 
  map_dfr(., ~bind_rows(.), .id = &amp;quot;date&amp;quot;) %&amp;gt;% 
  mutate(date = as.Date(paste(date, &amp;quot;01&amp;quot;), format = &amp;quot;%Y %b %d&amp;quot;))

GMVPPortfolioWeights %&amp;gt;%
  head() %&amp;gt;% 
  kable() %&amp;gt;%
  kable_styling(bootstrap_options = c(&amp;quot;striped&amp;quot;, &amp;quot;hover&amp;quot;, &amp;quot;condensed&amp;quot;, &amp;quot;responsive&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
date
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AAPL
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
ABBV
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
A
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
APD
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
CF
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
NVDA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
HOG
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
WMT
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AMZN
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-07-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0600839
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0335474
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1487696
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1258907
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0727920
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0095631
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.5208891
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0284642
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-08-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1046817
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0404000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000009
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0917765
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1592918
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0299729
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0364528
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.5374240
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000007
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-09-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1183896
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000005
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000006
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0844454
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1683526
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0246106
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0635569
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000002
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.5406430
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000004
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-10-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0975699
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0024139
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0742437
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1166939
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0431297
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0968248
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.5691241
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-11-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1480922
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000003
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0620407
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0449223
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000003
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0279869
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1613035
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0376022
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.5014187
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0166323
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-12-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1135468
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000007
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0678773
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0560224
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000005
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0062812
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1195510
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0779063
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.5588149
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000001
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 1c) Portfolio GMVP
GMVPPortfolioWeights %&amp;gt;% 
  select(date, everything()) %&amp;gt;% 
  pivot_longer(cols = 2:ncol(.), values_to = &amp;quot;weights&amp;quot;) %&amp;gt;% 
  ggplot(aes(fill = name, y = weights, x = date)) + 
  geom_bar(position = &amp;quot;stack&amp;quot;, stat = &amp;quot;identity&amp;quot;, width = 100) +
  scale_fill_viridis(option = &amp;quot;magma&amp;quot;, discrete = TRUE, name = &amp;quot;Asset&amp;quot;) +
  theme_bw() +
  ggtitle(&amp;quot;GMVP Rolling Portfolio Adjustments&amp;quot;) +
  xlab(&amp;quot;Date&amp;quot;) +
  ylab(&amp;quot;Weights&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/portfolio-optimisation-model/portfolio-optimisation-R_files/figure-html/unnamed-chunk-7-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;markowitz-portfolio&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Markowitz Portfolio&lt;/h2&gt;
&lt;p&gt;The Markowitz Mean-Variance Portfolio is constructed as follows:&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[\begin{eqnarray} \max_{w} \mu^{T}w - \lambda w^{T}\Sigma w \\
\text{subject to } 1^{T}w = 1 \\
w \ge 0 \end{eqnarray}\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;We can set different risk parameters by adjusting &lt;span class=&#34;math inline&#34;&gt;\(\lambda\)&lt;/span&gt; and see how the returns are affected. This can be done by running multiple optimisation problems on the data with different &lt;span class=&#34;math inline&#34;&gt;\(\lambda\)&lt;/span&gt; values. Higher &lt;span class=&#34;math inline&#34;&gt;\(\lambda\)&lt;/span&gt; values places emphasis on the right hand side of the equation and thus the more risk adverse the investor is.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 2) Function: Markowitz Portfolio
MarkowitzportolioFunction &amp;lt;- function(mu, Sigma, lmd) {
  w &amp;lt;- Variable(nrow(Sigma))
  problem &amp;lt;- Problem(
    Maximize(t(mu) %*% w - lmd*quad_form(w, Sigma)),
    constraints = list(
      w &amp;gt;= 0, 
      sum(w) == 1)
  )
  Solution &amp;lt;- solve(problem)
  return(as.vector(Solution$getValue(w)))
}

# 2a) Portfolio Markowitz
lmd &amp;lt;- c(0.25, 0.5, 0.75)
MarkowitzPortfolio &amp;lt;- map(lmd,
                          ~map2(
                            .x = mus,
                            .y = Sigmas,
                            MarkowitzportolioFunction, lmd = .x))

# 2b) Portfolio Markowitz
MarkowitzPortfolioWeights &amp;lt;- setNames(MarkowitzPortfolio, lmd) %&amp;gt;% 
  map(., ~setNames(., c(ListNamesDates))) %&amp;gt;% 
  map(., ~map(., ~setNames(., c(symbols)))) %&amp;gt;% 
  map(., ~map_dfr(., ~bind_rows(.), .id = &amp;quot;date&amp;quot;)) %&amp;gt;% 
  map_dfr(., ~bind_rows(.), .id = &amp;quot;lambda&amp;quot;) %&amp;gt;% 
  mutate(date = as.Date(paste(date, &amp;quot;01&amp;quot;), format = &amp;quot;%Y %b %d&amp;quot;))

MarkowitzPortfolioWeights %&amp;gt;%
  head() %&amp;gt;% 
  kable() %&amp;gt;%
  kable_styling(bootstrap_options = c(&amp;quot;striped&amp;quot;, &amp;quot;hover&amp;quot;, &amp;quot;condensed&amp;quot;, &amp;quot;responsive&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
lambda
&lt;/th&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
date
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AAPL
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
ABBV
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
A
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
APD
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
CF
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
NVDA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
HOG
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
WMT
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AMZN
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-07-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-08-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2938168
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7061832
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-09-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-10-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000001
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.9999984
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000004
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000001
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-11-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-12-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;We can see how the risk and return is affected by the changes in the &lt;span class=&#34;math inline&#34;&gt;\(\lambda\)&lt;/span&gt; values in the following plot. As the &lt;span class=&#34;math inline&#34;&gt;\(\lambda\)&lt;/span&gt; values increase the less risk we take on but also we assume less returns. Low values of &lt;span class=&#34;math inline&#34;&gt;\(\lambda\)&lt;/span&gt; makes us invest in a signle asset with the weight on asset &lt;span class=&#34;math inline&#34;&gt;\(A_{5}\)&lt;/span&gt;, increasing the &lt;span class=&#34;math inline&#34;&gt;\(\lambda\)&lt;/span&gt; values increases the weights in other assets &lt;span class=&#34;math inline&#34;&gt;\(A_{i}\)&lt;/span&gt; spreading our risk.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 2c) Portfolio Markowitz
MarkowitzPortfolioWeights %&amp;gt;% 
  select(date, lambda, everything()) %&amp;gt;% 
  pivot_longer(cols = 3:ncol(.), values_to = &amp;quot;weights&amp;quot;) %&amp;gt;% 
  ggplot(aes(fill = name, y = weights, x = date)) + 
  geom_bar(position = &amp;quot;stack&amp;quot;, stat = &amp;quot;identity&amp;quot;, width = 100) +
  facet_wrap(~lambda, ncol = 1) +
  scale_fill_viridis(option = &amp;quot;magma&amp;quot;, discrete = TRUE, name = &amp;quot;Asset&amp;quot;) +
  theme_bw() +
  ggtitle(&amp;quot;Markowitz Rolling Portfolio Adjustments&amp;quot;,
          subtitle = &amp;quot;For different Lambda Risk Values&amp;quot;) +
  xlab(&amp;quot;Date&amp;quot;) +
  ylab(&amp;quot;Weights&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/portfolio-optimisation-model/portfolio-optimisation-R_files/figure-html/unnamed-chunk-9-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;max-sharpe-ratio&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Max Sharpe Ratio&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; I originally made this post a few months back and when I went back to it some of the parts for the Max-Sharpe Ratio portfolio did not work as before - I think this is due to the recent update in the &lt;code&gt;tidyr&lt;/code&gt; package. I made some minor adjustments, however this part of the post is incorrect (just look at the portfolio weights plot). I hightlight in the code when I made the minor adjustments - when I have the opportunity to go back through the code more carefully I will -&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 2) Function: Max Sharpe Ratio 
#NOTE::: When we have all negative mus for a given month we obtain an NA value - the function 
# cannot find a maximum when all mus are negative compare the MaxSharpePortfolio$`2015 Sep` and
# MaxSharpePortfolio$`2015 Oct` along with the mus$`2015 Sep` and mus$`2015 Oct` we invests 99% of the portfolio
# in Sept in ABBV since its positive. In Oct ABBV mu is negative and we cannot invest at all.
# Increasing the universe of Assets may overcome this problem.
MaxSharpeportolioFunction &amp;lt;- function(mu, Sigma) {
  w &amp;lt;- Variable(nrow(Sigma))
  problem &amp;lt;- Problem(
    Minimize(quad_form(w, Sigma)),
    constraints = list(
      w &amp;gt;= 0, t(mu) %*% w == 1)
  )
  Solution &amp;lt;- solve(problem, solver=&amp;quot;SCS&amp;quot;)
  return(as.vector(Solution$getValue(w)/sum(Solution$getValue(w))))
}

# 3a) Portfolio Max Sharpe Ratio                                 
MaxSharpePortfolio &amp;lt;- purrr::map2(.x = mus,
                                  .y = Sigmas,
                                  .f = ~MaxSharpeportolioFunction(.x, .y))

# 3b) Portfolio Max Sharpe Ratio
  MaxSharpePortfolioWeights &amp;lt;- setNames(MaxSharpePortfolio, ListNamesDates) %&amp;gt;%
    as_tibble(.) %&amp;gt;%               # Made an adjustment here
    map(.,  ~setNames(., c(symbols))) %&amp;gt;% 
    map_dfr(., ~bind_rows(.), .id = &amp;quot;date&amp;quot;) %&amp;gt;% 
    mutate(date = as.Date(paste(date, &amp;quot;01&amp;quot;), format = &amp;quot;%Y %b %d&amp;quot;))

MaxSharpePortfolioWeights %&amp;gt;%
  head() %&amp;gt;% 
  kable() %&amp;gt;%
  kable_styling(bootstrap_options = c(&amp;quot;striped&amp;quot;, &amp;quot;hover&amp;quot;, &amp;quot;condensed&amp;quot;, &amp;quot;responsive&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
date
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AAPL
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
ABBV
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
A
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
APD
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
CF
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
NVDA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
HOG
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
WMT
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AMZN
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-07-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0149061
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2114414
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0113890
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2432642
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0390656
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0398034
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1473514
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0177759
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.4853595
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-0.0000282
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-08-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1376876
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.3329830
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1197141
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.4096154
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-09-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1217206
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1246626
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0087004
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.3421645
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2414533
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0002820
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1610166
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-10-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0270424
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2268393
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.3427932
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2653166
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1283026
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0097059
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-11-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2061378
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1890217
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2234738
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0533257
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.3280410
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-12-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2252115
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0306324
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0724210
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0325000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0000000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1907157
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1192396
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.3292797
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 3c) Portfolio Max Sharpe Ratio
MaxSharpePortfolioWeights %&amp;gt;% 
  select(date, everything()) %&amp;gt;%      # Made an adjustment here
  pivot_longer(cols = 2:ncol(.), values_to = &amp;quot;weights&amp;quot;) %&amp;gt;% 
  ggplot(aes(fill = name, y = weights, x = date)) + 
  geom_bar(position = &amp;quot;stack&amp;quot;, stat = &amp;quot;identity&amp;quot;, width = 100) +
  scale_fill_viridis(option = &amp;quot;magma&amp;quot;, discrete = TRUE, name = &amp;quot;Asset&amp;quot;) +
  theme_bw() +
  ggtitle(&amp;quot;Maximum Sharpe Ratio Rolling Portfolio Adjustments&amp;quot;) +
  xlab(&amp;quot;Date&amp;quot;) +
  ylab(&amp;quot;Weights&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/portfolio-optimisation-model/portfolio-optimisation-R_files/figure-html/unnamed-chunk-11-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;mu-quintile-portfolio&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Mu Quintile Portfolio&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 1a)
mu_quintiles &amp;lt;- map(mus, ~ntile(., 5) %&amp;gt;% 
                      setNames(c(symbols))) %&amp;gt;% 
  map(., ~sort(., decreasing = TRUE))

# 2)       
mu_diag_sigma &amp;lt;- map2(
  .x = mus,
  .y = Sigmas,
  ~.x / diag(.y)) 

mu_diag_sigma_quintiles &amp;lt;- mu_diag_sigma %&amp;gt;% 
  map(., ~ntile(., 5)) %&amp;gt;% 
  map(., ~setNames(., c(symbols))) %&amp;gt;% 
  map(., ~sort(., decreasing = TRUE))

# 1b) rank the quintiles by mu
quintiles_mu &amp;lt;- map2(
  .x = mus,
  .y = mu_quintiles,
  ~bind_rows(.x, .y))

quintiles_mu_weights &amp;lt;- map(quintiles_mu, ~ .x %&amp;gt;%
                              mutate_all(~ case_when(. %in% c(5, 1) ~ .5, 
                                                     TRUE ~ 0)) %&amp;gt;%
                              pmap_dfr(., ~ 
                                         {v1 &amp;lt;- c(...)
                                         v2 &amp;lt;- if(sum(v1) &amp;gt; 1) replace(v1, v1 != 0, 1/sum(v1!=0)) else v1
                                         as.list(v2)}))


quintiles_mu_weights &amp;lt;- map(quintiles_mu_weights, ~.x[-1,]) %&amp;gt;% 
  map2(.x = quintiles_mu, .y = ., ~bind_rows(.x, .y))

QuintileMuWeights &amp;lt;- map(quintiles_mu_weights, ~.x[3, ]) %&amp;gt;%  # The weights are stored in row 3.
  map_dfr(., ~bind_rows(.), .id = &amp;quot;date&amp;quot;) %&amp;gt;% 
  mutate(date = as.Date(paste(date, &amp;quot;01&amp;quot;), format = &amp;quot;%Y %b %d&amp;quot;))

QuintileMuWeights %&amp;gt;%
  head() %&amp;gt;% 
  kable() %&amp;gt;%
  kable_styling(bootstrap_options = c(&amp;quot;striped&amp;quot;, &amp;quot;hover&amp;quot;, &amp;quot;condensed&amp;quot;, &amp;quot;responsive&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
date
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AAPL
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
ABBV
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
A
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
APD
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
CF
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
NVDA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
HOG
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
WMT
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AMZN
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-07-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-08-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-09-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-10-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-11-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-12-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;QuintileMuWeights %&amp;gt;% 
    select(date, everything()) %&amp;gt;%
  pivot_longer(cols = 2:ncol(.), values_to = &amp;quot;weights&amp;quot;) %&amp;gt;% 
  ggplot(aes(fill = name, y = weights, x = date)) + 
  geom_bar(position = &amp;quot;stack&amp;quot;, stat = &amp;quot;identity&amp;quot;, width = 100) +
  scale_fill_viridis(option = &amp;quot;magma&amp;quot;, discrete = TRUE, name = &amp;quot;Asset&amp;quot;) +
  theme_bw() +
  ggtitle(&amp;quot;Quintile MU Rolling Portfolio Adjustments&amp;quot;) +
  xlab(&amp;quot;Date&amp;quot;) +
  ylab(&amp;quot;Weights&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/portfolio-optimisation-model/portfolio-optimisation-R_files/figure-html/unnamed-chunk-13-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;mu-diagsigma-portfolio&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Mu / Diag(Sigma) Portfolio&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 2a) 
mu_diag_sigma &amp;lt;- map2(
  .x = mus,
  .y = Sigmas,
  ~.x / diag(.y)) 

mu_diag_sigma_quintiles &amp;lt;- mu_diag_sigma %&amp;gt;% 
  map(., ~ntile(., 5)) %&amp;gt;% 
  map(., ~setNames(., c(symbols))) %&amp;gt;% 
  map(., ~sort(., decreasing = TRUE))

# 2b) rank the quintiles by mu / diag(Sigma)
quintiles_mu_diag_sigma &amp;lt;- map2(
  .x = mu_diag_sigma,
  .y = mu_diag_sigma_quintiles,
  ~bind_rows(.x, .y))

quintiles_mu_diag_sigma_weights &amp;lt;- map(quintiles_mu_diag_sigma, ~ .x %&amp;gt;%
                                         mutate_all(~ case_when(. %in% c(5, 1) ~ .5, 
                                                                TRUE ~ 0)) %&amp;gt;%
                                         pmap_dfr(., ~ 
                                                    {v1 &amp;lt;- c(...)
                                                    v2 &amp;lt;- if(sum(v1) &amp;gt; 1) replace(v1, v1 != 0, 1/sum(v1!=0)) else v1
                                                    as.list(v2)}))

quintiles_mu_diag_sigma_weights &amp;lt;- map(quintiles_mu_diag_sigma_weights, ~.x[-1,]) %&amp;gt;% 
  map2(.x = quintiles_mu_diag_sigma, .y = ., ~bind_rows(.x, .y))

QuintileMuDiagSigmaWeights &amp;lt;- map(quintiles_mu_diag_sigma_weights, ~.x[3, ]) %&amp;gt;% # The weights are stored in row 3.
  map_dfr(., ~bind_rows(.), .id = &amp;quot;date&amp;quot;) %&amp;gt;% 
  mutate(date = as.Date(paste(date, &amp;quot;01&amp;quot;), format = &amp;quot;%Y %b %d&amp;quot;))

QuintileMuDiagSigmaWeights %&amp;gt;%
  head() %&amp;gt;% 
  kable() %&amp;gt;%
  kable_styling(bootstrap_options = c(&amp;quot;striped&amp;quot;, &amp;quot;hover&amp;quot;, &amp;quot;condensed&amp;quot;, &amp;quot;responsive&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
date
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AAPL
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
ABBV
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
A
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
APD
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
CF
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
NVDA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
HOG
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
WMT
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AMZN
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-07-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-08-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-09-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-10-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-11-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-12-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;QuintileMuDiagSigmaWeights %&amp;gt;% 
  select(date, everything()) %&amp;gt;%
  pivot_longer(cols = 2:ncol(.), values_to = &amp;quot;weights&amp;quot;) %&amp;gt;% 
  ggplot(aes(fill = name, y = weights, x = date)) + 
  geom_bar(position = &amp;quot;stack&amp;quot;, stat = &amp;quot;identity&amp;quot;, width = 100) +
  scale_fill_viridis(option = &amp;quot;magma&amp;quot;, discrete = TRUE, name = &amp;quot;Asset&amp;quot;) +
  theme_bw() +
  ggtitle(&amp;quot;Quintile MU Diag Sigma Rolling Portfolio Adjustments&amp;quot;) +
  xlab(&amp;quot;Date&amp;quot;) +
  ylab(&amp;quot;Weights&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/portfolio-optimisation-model/portfolio-optimisation-R_files/figure-html/unnamed-chunk-15-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;mu-diagsqrtsigma-portfolio&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Mu / Diag(sqrt(Sigma)) Portfolio&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 3a)
mu_diag_sqrt_sigma &amp;lt;- map2(
  .x = mus,
  .y = Sigmas,
  ~.x / sqrt(diag(.y)))  

mu_diag_sqrt_sigma_quintiles &amp;lt;- mu_diag_sqrt_sigma %&amp;gt;% 
  map(., ~ntile(., 5)) %&amp;gt;% 
  map(., ~setNames(., c(symbols))) %&amp;gt;% 
  map(., ~sort(., decreasing = TRUE))

# 3b) rank the quintiles by mu / sqrt(diag(sigma))

quintiles_mu_diag_sqrt_sigma &amp;lt;- map2(
  .x = mu_diag_sqrt_sigma,
  .y = mu_diag_sqrt_sigma_quintiles,
  ~bind_rows(.x, .y))

quintiles_mu_diag_sqrt_sigma_weights &amp;lt;- map(quintiles_mu_diag_sqrt_sigma, ~ .x %&amp;gt;%
                                         mutate_all(~ case_when(. %in% c(5, 1) ~ .5, 
                                                                TRUE ~ 0)) %&amp;gt;%
                                         pmap_dfr(., ~ 
                                                    {v1 &amp;lt;- c(...)
                                                    v2 &amp;lt;- if(sum(v1) &amp;gt; 1) replace(v1, v1 != 0, 1/sum(v1!=0)) else v1
                                                    as.list(v2)}))

quintiles_mu_diag_sqrt_sigma_weights &amp;lt;- map(quintiles_mu_diag_sqrt_sigma_weights, ~.x[-1,]) %&amp;gt;% 
  map2(.x = quintiles_mu_diag_sqrt_sigma, .y = ., ~bind_rows(.x, .y))

QuintileMuDiagSqrtSigmaWeights &amp;lt;- map(quintiles_mu_diag_sqrt_sigma_weights, ~.x[3, ]) %&amp;gt;% # The weights are stored in row 3.
  map_dfr(., ~bind_rows(.), .id = &amp;quot;date&amp;quot;) %&amp;gt;% 
  mutate(date = as.Date(paste(date, &amp;quot;01&amp;quot;), format = &amp;quot;%Y %b %d&amp;quot;))

QuintileMuDiagSqrtSigmaWeights %&amp;gt;%
  head() %&amp;gt;% 
  kable() %&amp;gt;%
  kable_styling(bootstrap_options = c(&amp;quot;striped&amp;quot;, &amp;quot;hover&amp;quot;, &amp;quot;condensed&amp;quot;, &amp;quot;responsive&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
date
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AAPL
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
ABBV
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
A
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
APD
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
CF
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
NVDA
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
HOG
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
WMT
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
AMZN
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-07-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-08-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-09-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-10-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-11-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2013-12-01
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.00
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.25
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;QuintileMuDiagSqrtSigmaWeights %&amp;gt;% 
  select(date, everything()) %&amp;gt;%
  pivot_longer(cols = 2:ncol(.), values_to = &amp;quot;weights&amp;quot;) %&amp;gt;% 
  ggplot(aes(fill = name, y = weights, x = date)) + 
  geom_bar(position = &amp;quot;stack&amp;quot;, stat = &amp;quot;identity&amp;quot;, width = 100) +
  scale_fill_viridis(option = &amp;quot;magma&amp;quot;, discrete = TRUE, name = &amp;quot;Asset&amp;quot;) +
  theme_bw() +
  ggtitle(&amp;quot;Quintile MU Diag Sqrt(Sigma) Rolling Portfolio Adjustments&amp;quot;) +
  xlab(&amp;quot;Date&amp;quot;) +
  ylab(&amp;quot;Weights&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/portfolio-optimisation-model/portfolio-optimisation-R_files/figure-html/unnamed-chunk-17-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;analysis-of-results&#34; class=&#34;section level1 tabset tabset-fade tabset-pills&#34;&gt;
&lt;h1&gt;Analysis of Results&lt;/h1&gt;
&lt;p&gt;There are 8 different portfolio optimisation models. Putting all the data together, it’s easier to inspect the results.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;############################# Assess the Returns ##################################
MonthlyReturns &amp;lt;- map(portfolio_monthly_prices$splits, ~assessment(.x)) %&amp;gt;% 
  map(., ~unnest(.x, data) %&amp;gt;% 
        select(-year_month) %&amp;gt;% 
        tk_xts(date_var = date) %&amp;gt;% 
        lapply(., periodReturn, period = &amp;quot;monthly&amp;quot;)) %&amp;gt;% 
  setNames(., ListNamesDates) %&amp;gt;% 
  map(., ~data.frame(.)) %&amp;gt;% 
  bind_rows(., .id = &amp;quot;date&amp;quot;) %&amp;gt;% 
  mutate(date = as.Date(paste(date, &amp;quot;01&amp;quot;), format = &amp;quot;%Y %b %d&amp;quot;)) %&amp;gt;% 
  tk_xts(., date_var = date)

############# Assess the Monthly Portfolio Returns Depeninding on Weights #########

# 1d)
TS_GMVPPortfolioWeights &amp;lt;- GMVPPortfolioWeights %&amp;gt;% 
  tk_xts(., date_var = date)

PortRets_GMVP &amp;lt;- Return.portfolio(MonthlyReturns, weights = TS_GMVPPortfolioWeights) %&amp;gt;% 
  setNames(c(&amp;quot;GMVP&amp;quot;))


# 2d)
TS_MarkowitzPortfolioWeights &amp;lt;- MarkowitzPortfolioWeights %&amp;gt;% 
  group_split(lambda) %&amp;gt;% 
  setNames(c(lmd)) %&amp;gt;% 
  map(., ~tk_xts(., select = -lambda, date_var = date))

MarkowitzWeightedPortfolioReturnsFunction &amp;lt;- function(lmd){
  WeightedReturns = Return.portfolio(MonthlyReturns, weights = TS_MarkowitzPortfolioWeights[[lmd]])
  return(fortify.zoo(WeightedReturns))
}

PortRets_Markowitz &amp;lt;- lapply(seq(1:length(lmd)), MarkowitzWeightedPortfolioReturnsFunction) %&amp;gt;% 
  setNames(c(lmd)) %&amp;gt;%
  bind_rows(., .id = &amp;quot;lmd&amp;quot;) %&amp;gt;% 
  #column_to_rownames(&amp;quot;Index&amp;quot;) %&amp;gt;% 
  #select(-matches(&amp;quot;Index&amp;quot;)) %&amp;gt;% 
  #rownames_to_column(&amp;quot;Index&amp;quot;) %&amp;gt;% 
  mutate(Index = as.Date(Index),
         lmd = as.numeric(lmd)) %&amp;gt;% 
  pivot_wider(names_from = lmd, values_from = portfolio.returns) %&amp;gt;% 
  tk_xts(date_var = Index) %&amp;gt;% 
  setNames(c(paste(&amp;quot;Markowitz Lambda&amp;quot;, lmd)))

# 3d)
TS_MaxSharpePortfolioWeights &amp;lt;- MaxSharpePortfolioWeights %&amp;gt;% 
  tk_xts(., date_var = date)

PortRets_MaxSharpe &amp;lt;- Return.portfolio(MonthlyReturns, weights = TS_MaxSharpePortfolioWeights) %&amp;gt;% 
  setNames(c(&amp;quot;MaxSharpe&amp;quot;))


# 4) quintile mu

TS_QuintileMuWeights &amp;lt;- QuintileMuWeights %&amp;gt;% 
  tk_xts(., date_var = date)

PortRets_Mu_Quintiles &amp;lt;- Return.portfolio(MonthlyReturns, weights = TS_QuintileMuWeights) %&amp;gt;% 
  setNames(c(&amp;quot;Mu_Quintiles&amp;quot;))

# 4) quintile mu diag sigma

TS_QuintileMuDiagSigmaWeights &amp;lt;- QuintileMuDiagSigmaWeights %&amp;gt;% 
  tk_xts(., date_var = date)

PortRets_MuDiagSigma_Quintiles &amp;lt;- Return.portfolio(MonthlyReturns, weights = TS_QuintileMuDiagSigmaWeights) %&amp;gt;% 
  setNames(c(&amp;quot;MuDiagSigma_Quintiles&amp;quot;))

# 4) Quintile mu diga sqrt sigma

TS_QuintileMuDiagSqrtSigmaWeights &amp;lt;- QuintileMuDiagSqrtSigmaWeights %&amp;gt;% 
  tk_xts(., date_var = date)

PortRets_MuDiagSqrtSigma_Quintiles &amp;lt;- Return.portfolio(MonthlyReturns, weights = TS_QuintileMuDiagSqrtSigmaWeights) %&amp;gt;% 
  setNames(c(&amp;quot;MuDiagSqrtSigma_Quintiles&amp;quot;))

#####################################################################################&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Looking at the plots the Global Minimum Variance Portfolio shows the lowest volatility in the portfolio returns. The Max Sharpe portfolio is clearly wrong here (see, previous point on Max Sharpe Ratio section). The annaulised performance metrics are also displayed at the bottom for each portfolio over the period.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;########## Assess the Annualised Returns based on portfolio weights ##################
AllReturns &amp;lt;- cbind(PortRets_GMVP, PortRets_Markowitz, PortRets_MaxSharpe, PortRets_Mu_Quintiles,
                    PortRets_MuDiagSigma_Quintiles, PortRets_MuDiagSqrtSigma_Quintiles)
                    
library(data.table)
AllReturns %&amp;gt;%
  data.table(keep.rownames = TRUE) %&amp;gt;%
  as_tibble() %&amp;gt;% 
  pivot_longer(cols = 2:ncol(.)) %&amp;gt;% 
  ggplot(aes(x = index, y = value, color = name)) +
  geom_line() +
  facet_wrap(~name, ncol = 2) +
  ggtitle(&amp;quot;Portfolio Returns&amp;quot;, subtitle = &amp;quot;With portfolio optimised weights&amp;quot;) +
  xlab(&amp;quot;Returns&amp;quot;) +
  ylab(&amp;quot;Date&amp;quot;) +
  theme_tq()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/portfolio-optimisation-model/portfolio-optimisation-R_files/figure-html/unnamed-chunk-19-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;AnnualMetrics &amp;lt;- bind_cols(table.AnnualizedReturns(PortRets_GMVP) %&amp;gt;% 
                          rownames_to_column(&amp;quot;Metric&amp;quot;),
                        table.AnnualizedReturns(PortRets_Markowitz),
                        table.AnnualizedReturns(PortRets_MaxSharpe),
                        table.AnnualizedReturns(PortRets_Mu_Quintiles),
                        table.AnnualizedReturns(PortRets_MuDiagSigma_Quintiles),
                        table.AnnualizedReturns(PortRets_MuDiagSqrtSigma_Quintiles)
                        )

AnnualMetrics %&amp;gt;%
  kable() %&amp;gt;%
  kable_styling(bootstrap_options = c(&amp;quot;striped&amp;quot;, &amp;quot;hover&amp;quot;, &amp;quot;condensed&amp;quot;, &amp;quot;responsive&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
Metric
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
GMVP
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
Markowitz Lambda 0.25
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
Markowitz Lambda 0.5
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
Markowitz Lambda 0.75
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MaxSharpe
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
Mu_Quintiles
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MuDiagSigma_Quintiles
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MuDiagSqrtSigma_Quintiles
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
Annualized Return
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1009
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.8441
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.8142
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7712
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0944
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1948
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2599
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.2700
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
Annualized Std Dev
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1127
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.3617
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.3516
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.3353
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1364
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1806
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1492
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1541
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
Annualized Sharpe (Rf=0%)
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.8953
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
2.3340
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
2.3157
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
2.2999
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.6922
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1.0787
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1.7420
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1.7515
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Plotting the cumulative returns shows that the Markowitz lambda portfolios have the highest returns over the period, however they also have the highest standard deviation over the same period.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;chart.CumReturns(AllReturns, main = &amp;quot;Weighted Returns by Objective Function and Risk Tolerance&amp;quot;,
                 wealth.index = TRUE, legend.loc = &amp;quot;topleft&amp;quot;, colorset = rich6equal)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/portfolio-optimisation-model/portfolio-optimisation-R_files/figure-html/unnamed-chunk-20-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;charts.PerformanceSummary(AllReturns, main = &amp;quot;Performance for Different Weighted Assets&amp;quot;, 
                          wealth.index = TRUE, colorset = rich6equal)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/portfolio-optimisation-model/portfolio-optimisation-R_files/figure-html/unnamed-chunk-20-2.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;div id=&#34;additional&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Additional&lt;/h3&gt;
&lt;p&gt;(Some additional test data I leave here for future reference)&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;data &amp;lt;- data.frame(
  A_1 = c(2.3, 0.93, 0.62, 0.74, -0.23),
  A_2 = c(0.93, 1.40, 0.2, 0.56, 0.26),
  A_3 = c(0.62, 0.2, 1.80, 0.78, -0.27),
  A_4 = c(0.74, 0.56, 0.78, 3.4, -0.56),
  A_5 = c(-0.23, 0.26, -0.27, -0.56, 2.60),
  Security = c(1, 2, 3, 4, 5),
  R_i = c(15.1, 12.5, 14.7, 9.02, 17.68)
)

Sigma &amp;lt;- data[, 1:5]
w &amp;lt;- Variable(nrow(data))
mu &amp;lt;- data[, 7]
n_samples = 10
lambdas &amp;lt;- 10^seq(-2, 3, length.out = n_samples)

ret_data &amp;lt;- rep(0, n_samples)
risk_data &amp;lt;- rep(0, n_samples)
w_data &amp;lt;- matrix(0, nrow = n_samples, ncol = nrow(data))

for(i in seq_along(lambdas)) {
  lambda &amp;lt;- lambdas[i]
  problem &amp;lt;- Problem(
    Maximize(
      t(mu) %*% w - lambda*quad_form(w, Sigma)
    ),
    constraints = list(w &amp;gt;= 0, sum(w) == 1))
  solution &amp;lt;- solve(problem)
  w_data[i,] &amp;lt;- solution$getValue(w)
  risk_data[i] &amp;lt;- solution$getValue(sqrt(quad_form(w, Sigma)))
  ret_data[i] &amp;lt;- solution$getValue(t(mu) %*% w)
}

ggplot() +
  geom_line(mapping = aes(x = risk_data, y = ret_data), color = &amp;quot;blue&amp;quot;) +
  geom_point(mapping = aes(x = sqrt(diag(as.matrix(Sigma))), y = mu), color = &amp;quot;red&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/portfolio-optimisation-model/portfolio-optimisation-R_files/figure-html/unnamed-chunk-21-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Learning the Quantstrat and Blotter packages</title>
      <link>/post/quantstrat-rolling-logistic/quantstrat/</link>
      <pubDate>Sun, 29 Sep 2019 00:00:00 +0000</pubDate>
      <guid>/post/quantstrat-rolling-logistic/quantstrat/</guid>
      <description>
&lt;script src=&#34;/rmarkdown-libs/kePrint/kePrint.js&#34;&gt;&lt;/script&gt;


&lt;p&gt;Load packages:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(knitr)
library(kableExtra)
library(dplyr)
library(ggplot2)
library(quantstrat)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;::: Note :::&lt;/strong&gt; This post is mostly for my future reference/documentation for learning the &lt;code&gt;quantstrat&lt;/code&gt; package. An example of a strategy I developed can be found below in which it uses a naive rolling logistic regression model trained on &lt;code&gt;t&lt;/code&gt; days to predict &lt;code&gt;t+1&lt;/code&gt; market movement. &lt;strong&gt;::: END Note :::&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I have been playing around with backtesting trading models using the &lt;code&gt;quantstrat&lt;/code&gt; package for a while but the most difficult thing about it was understanding the syntax of &lt;code&gt;blotter&lt;/code&gt; and &lt;code&gt;quantstrat&lt;/code&gt;, it didn’t seem very intuitive to me at first and there does not seem to be &lt;em&gt;much&lt;/em&gt; detailed information online, despite the package being around since 2010. In this post I will give my comments and observations what certain functions do, I will update this post over time.&lt;/p&gt;
&lt;div id=&#34;backgorund&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Backgorund&lt;/h3&gt;
&lt;p&gt;The &lt;code&gt;quantstrat&lt;/code&gt; package is built on the &lt;code&gt;blotter&lt;/code&gt; package which was developed in 2008. It works best with time series &lt;code&gt;xts&lt;/code&gt; objects which can be easily collected using the &lt;code&gt;quantmod&lt;/code&gt; package. The &lt;code&gt;blotter&lt;/code&gt; package is the accounting package behind the &lt;code&gt;quantstrat&lt;/code&gt; system, it can support multiple accounts or multiple portfolios and computes the P&amp;amp;L of trading systems.&lt;/p&gt;
&lt;p&gt;The main blotter functions are the following:&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;initialisation&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Initialisation&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;initPortf&lt;/code&gt; - which initialises a portfolio&lt;/li&gt;
&lt;li&gt;&lt;code&gt;initAcct&lt;/code&gt; - which initialises an account&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div id=&#34;performance&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Performance&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;addTxn&lt;/code&gt; - which adds transactions to the portfolio&lt;/li&gt;
&lt;li&gt;&lt;code&gt;updatePortf&lt;/code&gt; - which computes the P&amp;amp;L for each symbol in a given period&lt;/li&gt;
&lt;li&gt;&lt;code&gt;updateAcct&lt;/code&gt; - which computes the equity from the assets&lt;/li&gt;
&lt;li&gt;&lt;code&gt;updateEndEq&lt;/code&gt; - which updates the final equity for an account&lt;/li&gt;
&lt;li&gt;&lt;code&gt;getEndEq&lt;/code&gt; - which provides us with the latest value of our account&lt;/li&gt;
&lt;li&gt;&lt;code&gt;getPosQty&lt;/code&gt; - which gets a position at a given date.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;chart.Posn&lt;/code&gt;- which plots a chart of the position size, and cumulative P&amp;amp;L&lt;/li&gt;
&lt;li&gt;&lt;code&gt;PortfReturns&lt;/code&gt;- which calcualtes the portfolio returns&lt;/li&gt;
&lt;li&gt;&lt;code&gt;getAccount&lt;/code&gt; - which gets our account info!&lt;/li&gt;
&lt;li&gt;&lt;code&gt;getPortfolio&lt;/code&gt; - &#34;&#34;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;getTxns&lt;/code&gt; - &#34;&#34;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;tradeStats&lt;/code&gt; - which collects trade statistics&lt;/li&gt;
&lt;li&gt;&lt;code&gt;perTradeStats&lt;/code&gt; - which calculates per trade statistics&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The &lt;code&gt;blotter&lt;/code&gt; package loads in a number of additional packages as we can see by running the below.&lt;/p&gt;
&lt;p&gt;The packages are: &lt;code&gt;xts&lt;/code&gt; and &lt;code&gt;zoo&lt;/code&gt; for time series, &lt;code&gt;FinancialInstrument&lt;/code&gt;, &lt;code&gt;quantmod&lt;/code&gt;, &lt;code&gt;TTR&lt;/code&gt;, &lt;code&gt;PerformanceAnalytics&lt;/code&gt; for finance, where &lt;code&gt;TTR&lt;/code&gt; stands for Technical Trading Rules.&lt;/p&gt;
&lt;p&gt;The blotter package creates a new environment &lt;code&gt;.blotter&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;download-financial-data&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Download Financial Data&lt;/h3&gt;
&lt;p&gt;Lets first download some data for the S&amp;amp;P500 from 2018 to 2019 in order to gather some data. For the &lt;code&gt;quantstrat&lt;/code&gt; package its quite usual to find the initiation date, start date, end date set outside the parameters of the model. Therefore I first set these parameters as &lt;code&gt;initDate&lt;/code&gt;, &lt;code&gt;startDate&lt;/code&gt; and &lt;code&gt;endDate&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;initDate &amp;lt;- &amp;#39;2010-01-01&amp;#39; # this is used for later but is must be before the startDate
startDate &amp;lt;- &amp;#39;2018-01-01&amp;#39;
endDate &amp;lt;- &amp;#39;2019-01-01&amp;#39;
symbols &amp;lt;- c(&amp;#39;SPY&amp;#39;)
getSymbols(symbols, from = startDate, to = endDate, src = &amp;quot;yahoo&amp;quot;, adjust=TRUE) &lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;SPY&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;font-size: 12px; margin-left: auto; margin-right: auto;&#34;&gt;
&lt;caption style=&#34;font-size: initial !important;&#34;&gt;
&lt;span id=&#34;tab:unnamed-chunk-3&#34;&gt;Table 1: &lt;/span&gt;SPY stocks
&lt;/caption&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
SPY.Open
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
SPY.High
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
SPY.Low
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
SPY.Close
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
SPY.Volume
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
SPY.Adjusted
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-01-02
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
262.8473
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
263.7992
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
262.4155
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
263.7599
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
86655700
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
260.1310
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-01-03
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
263.9464
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
265.5951
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
263.9464
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
265.4283
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
90070400
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
261.7763
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-01-04
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
266.1447
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
267.0868
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
265.4970
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
266.5470
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
80636400
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
262.8796
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-01-05
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
267.4302
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
268.4606
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
266.8807
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
268.3233
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
83524000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
264.6314
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-01-08
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
268.2153
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
268.9906
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
267.8915
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
268.8140
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
57319200
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
265.1154
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-01-09
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
269.2850
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
270.1191
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
268.9709
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
269.4224
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
57254000
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
265.7154
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div id=&#34;plot-the-data&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Plot the data&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;chartSeries(SPY, name = &amp;quot;Daily time series for SPY&amp;quot;, type = &amp;quot;candlesticks&amp;quot;, theme = chartTheme(&amp;quot;white&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/quantstrat-rolling-logistic/quantstrat_files/figure-html/unnamed-chunk-4-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Once we have the data and after loading the &lt;code&gt;blotter&lt;/code&gt; package we must define a few initialisation parameters, namely the &lt;code&gt;currency()&lt;/code&gt; and &lt;code&gt;stocks&lt;/code&gt; parameter from the &lt;code&gt;FinancialInstrument&lt;/code&gt; package.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;currency(&amp;quot;USD&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;USD&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;stock(&amp;quot;SPY&amp;quot;, currency = &amp;quot;USD&amp;quot;, multiplier = 1)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;SPY&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ls(all = TRUE)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;.blotter&amp;quot;     &amp;quot;.getSymbols&amp;quot;  &amp;quot;.Random.seed&amp;quot; &amp;quot;.strategy&amp;quot;   
## [5] &amp;quot;endDate&amp;quot;      &amp;quot;initDate&amp;quot;     &amp;quot;SPY&amp;quot;          &amp;quot;startDate&amp;quot;   
## [9] &amp;quot;symbols&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ls(envir = FinancialInstrument:::.instrument)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;SPY&amp;quot; &amp;quot;USD&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can see that we have the SPY index and the USD currency set. We can convert the data from daily time series to monthly time series using the &lt;code&gt;to.period&lt;/code&gt; fucntion.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;SPY_monthly &amp;lt;- to.period(SPY, period = &amp;quot;months&amp;quot;)
chartSeries(SPY_monthly, name = &amp;quot;Monthly time series for SPY&amp;quot;, type = &amp;quot;candlesticks&amp;quot;, theme = chartTheme(&amp;quot;white&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/quantstrat-rolling-logistic/quantstrat_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;head(SPY_monthly)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##            SPY.Open SPY.High  SPY.Low SPY.Close SPY.Volume SPY.Adjusted
## 2018-01-31 262.8473 281.2870 262.4155  276.6452 1985506700     272.8389
## 2018-02-28 275.8307 277.7836 248.2054  266.5862 2923722000     262.9184
## 2018-03-29 266.3507 275.1830 254.0372  259.2790 2323561800     255.7117
## 2018-04-30 258.6878 267.3091 250.9237  260.6190 1998466500     257.0332
## 2018-05-31 259.9884 270.2157 255.2393  266.9544 1606397200     263.2814
## 2018-06-29 268.4028 275.3688 265.7283  268.4896 1599001000     264.7955&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;portfolio-parameters&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Portfolio parameters&lt;/h3&gt;
&lt;p&gt;Now that we have our data we should initialise the portfolio with &lt;code&gt;initPortf&lt;/code&gt;, which will consist of the transactions over the period of analysis.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;name&lt;/code&gt; - “MyFirstPortfolio” - the initial name of the portfolio&lt;/li&gt;
&lt;li&gt;&lt;code&gt;symbols&lt;/code&gt; - “SPY” - since we are using the SPY500&lt;/li&gt;
&lt;li&gt;&lt;code&gt;initPosQty&lt;/code&gt; - 100 - the initial quantity of our position&lt;/li&gt;
&lt;li&gt;&lt;code&gt;initDate&lt;/code&gt; - “initDate” - the initial account equity and position (prior to the closing price of our first position)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;currency&lt;/code&gt; the currency we are using&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;initDate &amp;lt;- &amp;#39;2010-01-01&amp;#39; # NOTE: We already created this parameter --&amp;gt; which was quoted as &amp;quot;this is used for later but is must be before the startDate&amp;quot;
initPortf(&amp;quot;MyFirstPortfolio&amp;quot;, &amp;quot;SPY&amp;quot;, initDate = initDate)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;MyFirstPortfolio&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;account-parameters&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Account parameters&lt;/h3&gt;
&lt;p&gt;We also need to initialise the account using &lt;code&gt;initAcct&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;name&lt;/code&gt; - “MyFirstPortfolio” - the initial name of the portfolio&lt;/li&gt;
&lt;li&gt;&lt;code&gt;portfolios&lt;/code&gt; - the name of our previous portfolio created&lt;/li&gt;
&lt;li&gt;&lt;code&gt;initDate&lt;/code&gt; - “initDate” - the initial account equity and position (prior to the closing price of our first position)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;initEq&lt;/code&gt; - the initial equity we began with&lt;/li&gt;
&lt;li&gt;&lt;code&gt;currency&lt;/code&gt; the currency we are using&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;initEq = 1000000
initAcct(&amp;quot;MyFirstPortfolio&amp;quot;, portfolios = &amp;quot;MyFirstPortfolio&amp;quot;, initDate = initDate, initEQ = initEq)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;MyFirstPortfolio&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;first(SPY) # print the first observation in our data&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##            SPY.Open SPY.High  SPY.Low SPY.Close SPY.Volume SPY.Adjusted
## 2018-01-02 262.8473 263.7992 262.4155  263.7599   86655700      260.131&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;last(SPY) # print the last observation in our data&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##            SPY.Open SPY.High SPY.Low SPY.Close SPY.Volume SPY.Adjusted
## 2018-12-31   249.56   250.19  247.47    249.92  144299400     246.4814&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;a-simple-strategy&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;A simple Strategy&lt;/h1&gt;
&lt;p&gt;A trading strategy can be broken down into the following blocks:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Assets&lt;/em&gt; - which are the stocks we want to trade, &lt;code&gt;SPY&lt;/code&gt;, &lt;code&gt;MSFT&lt;/code&gt;, &lt;code&gt;AAPL&lt;/code&gt;, &lt;code&gt;MSFT&lt;/code&gt; etc.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Indicators&lt;/em&gt; - which are the variables, Open, High, Low, Close, SMA, EMA, RSI, Momentum etc.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Signals&lt;/em&gt; - we can create signals based on the interaction between the &lt;em&gt;indicators&lt;/em&gt; and the time-series data.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Rules&lt;/em&gt; - Create &lt;em&gt;buy&lt;/em&gt; and &lt;em&gt;sell&lt;/em&gt; rules based on the &lt;em&gt;signals&lt;/em&gt; created.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Orders&lt;/em&gt; - Once a &lt;em&gt;rule&lt;/em&gt; is activated, push an &lt;em&gt;order&lt;/em&gt; through.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Analysis&lt;/em&gt; - Analyse the performance of the strategy.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I wanted to test a basic backtesting concept. What happens if I trained a machine learning model each day on the last 100 days of data to predict the next days stock market direction but test this over many periods?. That is to continuously train a machine learning model at every step to predict the next price. One method is to use the &lt;code&gt;rolling_origin&lt;/code&gt; fucntion from the &lt;code&gt;rsample&lt;/code&gt; package but I write a more simple function for this.&lt;/p&gt;
&lt;p&gt;I load in the parameters of the model and download data for MSFT.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(quantstrat)
library(PerformanceAnalytics)
library(e1071)

initDate = &amp;quot;2010-01-01&amp;quot;
from &amp;lt;- &amp;quot;2018-01-01&amp;quot;
to &amp;lt;- &amp;quot;2019-09-20&amp;quot;

init_equity &amp;lt;- 1000
adjustment &amp;lt;- TRUE

.orderqty &amp;lt;- 10                  # The profitability of the strategy depends heavily on this value
.txnfees &amp;lt;- -10
.stoploss &amp;lt;- 3e-3 # 0.003 or 0.3%

currency(&amp;#39;USD&amp;#39;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;USD&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;Sys.setenv(TZ=&amp;quot;UTC&amp;quot;)

symbols &amp;lt;- c(&amp;#39;MSFT&amp;#39;)

getSymbols(symbols, from = from, to = to, src = &amp;quot;yahoo&amp;quot;, adjust = TRUE) &lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;MSFT&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I created a simple time series pre-processing function to clean up the data, create some features and set the data to &lt;code&gt;xts&lt;/code&gt;. Ignore the &lt;code&gt;Scale_Me&lt;/code&gt; function.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;Scale_Me &amp;lt;- function(x){
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}


TS_preprocess &amp;lt;- function(dat){
  dat = data.frame(dat)
  colnames(dat) = c(&amp;quot;open&amp;quot;, &amp;quot;high&amp;quot;, &amp;quot;low&amp;quot;, &amp;quot;close&amp;quot;, &amp;quot;volume&amp;quot;, &amp;quot;adjusted&amp;quot;)
  dat$Y = with(dat, ifelse(close &amp;gt;= open, 1, 0))
  dat$X1 = SMA(lag(dat$close), n = 10)
  dat$X2 = RSI(lag(dat$close), nFast = 14, nSlow = 26, nSig = 9, maType = SMA)
  dat$X3 = momentum(lag(dat$close), n = 12)
  dat = dat[complete.cases(dat), ]
  #dat = cbind(dat[, &amp;#39;Y&amp;#39;], apply(dat[, 8:ncol(dat)], 2, Scale_Me))
  #colnames(dat)[1] = &amp;quot;Y&amp;quot; 
  dat = dat[, c(&amp;quot;Y&amp;quot;, &amp;quot;X1&amp;quot;, &amp;quot;X2&amp;quot;, &amp;quot;X3&amp;quot;)]
  dat = as.xts(dat)
  return(dat)
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I next set the training period &lt;code&gt;n_train&lt;/code&gt; = 100 periods and &lt;code&gt;n_test&lt;/code&gt; = 1 period, or train on &lt;code&gt;t&lt;/code&gt; days of data and test of &lt;code&gt;t+1&lt;/code&gt; days of data. This can be quite computationally expensive depending on the machine learning model you input but for a simple binary logistic regression classifier its relatively fast. I create the logistic function which returns the predicted probabilities.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;RollingBacktest&lt;/code&gt; function, runs the model on &lt;code&gt;n_train&lt;/code&gt; periods of data and makes a prediction on &lt;code&gt;n_test&lt;/code&gt;. That is, say we have 1000 days of data, the model will train on the first 100 days and predict on day 101, then retrain on days 2 to 101 days and predict on day 102 and so on, continuing until all 1000 days have passed.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df &amp;lt;- TS_preprocess(MSFT)

n_train &amp;lt;- 100
n_test &amp;lt;- 1

LogistFun &amp;lt;- function(frm, dat, trainIndex, testIndex){
  LogitModel &amp;lt;- glm(frm, data = dat[trainIndex, ])
  pred &amp;lt;- predict(LogitModel, newdata = dat[testIndex, ], type = &amp;#39;response&amp;#39;)
  return(pred)
}

RollingBacktest &amp;lt;- function(dat, ntrain = n_train, ntest = n_test){
  stopifnot(&amp;#39;Y&amp;#39; %in% names(dat))
  frm_ &amp;lt;- formula(reformulate(paste0(&amp;quot;X&amp;quot;, seq(2:ncol(dat))), &amp;quot;Y&amp;quot;))
  
  stride &amp;lt;- ntrain + ntest
  startPosn &amp;lt;- seq(1, dim(dat)[1] - stride)
  
  train_index_list &amp;lt;- lapply(startPosn, function(i) seq(i, i + ntrain))
  test_index_list &amp;lt;- lapply(startPosn, function(i) seq((i + ntrain + 1), (i + ntrain + ntest))) 
  
  mapply(LogistFun, trainIndex = train_index_list, testIndex = test_index_list, MoreArgs = list(frm = frm_, dat = dat), SIMPLIFY = FALSE
  )
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now that I have the &lt;em&gt;pre-process function&lt;/em&gt;, the &lt;em&gt;logistic function&lt;/em&gt; and the &lt;em&gt;backtest function&lt;/em&gt;, we can run the model through the &lt;code&gt;TS_postprocess&lt;/code&gt; function, which applies everything.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;TS_postprocess &amp;lt;- function(dat, ntrain){
  results = tail(dat, -(ntrain + 1))
  results$probs &amp;lt;- RollingBacktest(dat)
  results$predictions &amp;lt;- ifelse(results$probs &amp;gt; 0.6, 1, 0)
  print(paste0(&amp;quot;Model Accuracy at the 0.60 prob cut-off &amp;quot;, mean(results$Y == results$predictions)))
  return(results)
}

out &amp;lt;- TS_postprocess(df, ntrain = n_train)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;Model Accuracy at the 0.60 prob cut-off 0.518987341772152&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;out &amp;lt;- na.omit(cbind(MSFT, out))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The model is not very accurate…&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;na.omit&lt;/code&gt; removes the &lt;code&gt;NA&lt;/code&gt; values which were created from the &lt;code&gt;SMA&lt;/code&gt;, &lt;code&gt;RSI&lt;/code&gt; and &lt;code&gt;momentum&lt;/code&gt; calculations which are the first few observations of the time series data.&lt;/p&gt;
&lt;p&gt;The data looks like:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;out %&amp;gt;%
  head() %&amp;gt;%
  kable() %&amp;gt;%
  kable_styling(bootstrap_options = c(&amp;quot;striped&amp;quot;, &amp;quot;hover&amp;quot;, &amp;quot;condensed&amp;quot;, &amp;quot;responsive&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.Open
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.High
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.Low
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.Close
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.Volume
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.Adjusted
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
Y
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
X1
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
X2
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
X3
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
probs
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
predictions
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.73225
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.05627
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.58513
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.91896
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
28653100
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.91896
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.33186
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
63.01370
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1.98113024
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.6709360
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.41915
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
100.54701
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.17396
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.90953
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
26180800
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.90952
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.20142
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
59.54048
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.06865286
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7426882
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
100.11548
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
100.48817
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.93857
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.19357
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
23198200
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.19357
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.14061
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
63.88638
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.19615593
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7523711
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.47763
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.83069
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.71263
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.47763
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
38923100
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.47763
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.16611
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
51.80598
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-1.02979581
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7586200
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.07551
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.18340
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
95.42748
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.49649
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
35433300
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.49649
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.04646
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
43.39626
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-2.03996476
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7851164
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.91822
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.15397
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.84957
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.17322
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
26897200
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.17323
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.78558
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
32.78984
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-2.44207828
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.6282847
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;We can see that the model outputs predicted probabilities, I simply set the &lt;code&gt;predictions&lt;/code&gt; column to give a &lt;code&gt;1&lt;/code&gt; if the models predicted probability is &lt;code&gt;&amp;gt; 0.5&lt;/code&gt; or a &lt;code&gt;0&lt;/code&gt; if it is &lt;code&gt;&amp;lt; 0.5&lt;/code&gt;. The &lt;code&gt;Y&lt;/code&gt; variable is the observed and the &lt;code&gt;X1&lt;/code&gt;, &lt;code&gt;X2&lt;/code&gt; and &lt;code&gt;X3&lt;/code&gt; variables are the &lt;code&gt;SMA&lt;/code&gt;, &lt;code&gt;RSI&lt;/code&gt; and &lt;code&gt;momentum&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;We can now use the &lt;code&gt;quantstrat&lt;/code&gt; package to backtest the model and see how the performance went.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;MSFT &amp;lt;- out

stock(&amp;quot;MSFT&amp;quot;, currency = &amp;quot;USD&amp;quot;, multiplier = 1)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;MSFT&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;strategy.st &amp;lt;- portfolio.st &amp;lt;- account.st &amp;lt;- &amp;quot;RollingLogitStrategy&amp;quot;

rm.strat(strategy.st)
rm.strat(portfolio.st)
rm.strat(account.st)


initPortf(name = portfolio.st,
          symbols = symbols,
          initDate = initDate,
          currency = &amp;#39;USD&amp;#39;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;RollingLogitStrategy&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;initAcct(name = account.st,
         portfolios = portfolio.st,
         initDate = initDate,
         currency = &amp;#39;USD&amp;#39;,
         initEq = init_equity)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;RollingLogitStrategy&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;initOrders(portfolio.st,
           symbols = symbols,
           initDate = initDate)

strategy(strategy.st, store = TRUE)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I add the signals to the strategy and give it some rules.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1a)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The signal is that the first time the Logistic model produces a probability greater than &lt;code&gt;0.6&lt;/code&gt; then assign the signal. The &lt;code&gt;sigThreshold&lt;/code&gt; is a &lt;code&gt;quantstrat&lt;/code&gt; function, the others are &lt;code&gt;sigComparison&lt;/code&gt;, &lt;code&gt;sigCrossover&lt;/code&gt; and &lt;code&gt;sigFormula&lt;/code&gt;. It calls upon the &lt;code&gt;threshold&lt;/code&gt; value in the &lt;code&gt;list&lt;/code&gt; of &lt;code&gt;arguments&lt;/code&gt;, the column it looks for is the &lt;code&gt;probs&lt;/code&gt; column which the predicted probabilities are output to, &lt;code&gt;gt&lt;/code&gt; means greater than. It basically creates a new column called &lt;code&gt;logSig&lt;/code&gt; and it would be similar to &lt;code&gt;ifelse(df$probs &amp;gt; 0.6, 1, 0)&lt;/code&gt; as far as I understand.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1b)
The rule for the strategy is to take &lt;code&gt;sigcol&lt;/code&gt; which is the &lt;code&gt;label&lt;/code&gt; we gave our signal in the previous lines which is called &lt;code&gt;longSig&lt;/code&gt;. If &lt;code&gt;longSig = 1&lt;/code&gt;, execute a market order going long, buying at the next days open price, the transaction fees were set at the start of the strategy. We call this &lt;code&gt;rule&lt;/code&gt;, &lt;code&gt;EnterLONG&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;nMult_orderqty &amp;lt;- 2
addPosLimit(portfolio.st, symbol = &amp;quot;MSFT&amp;quot;, timestamp = initDate, maxpos = nMult_orderqty * .orderqty)

# Objective: Buy when the probability is gt 0.60, using cross = TRUE

# 1.a)
add.signal(strategy = strategy.st,
           name = &amp;quot;sigThreshold&amp;quot;,
           arguments = list(threshold = 0.6,
                            column = &amp;quot;probs&amp;quot;,
                            relationship = &amp;quot;gt&amp;quot;,
                            cross = TRUE),
           label = &amp;quot;longSig&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;RollingLogitStrategy&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 1.b)
# # Adding the rules, enter at the open price when prob &amp;gt; 0.60 for the first time, taking transaction fees into account
add.rule(strategy = strategy.st,
         name = &amp;quot;ruleSignal&amp;quot;,
         arguments = list(sigcol = &amp;quot;longSig&amp;quot;,   # check the ifelse predictions statement
                          sigval = 1,
                          orderqty = .orderqty,
                          ordertype = &amp;quot;market&amp;quot;,
                          orderside = &amp;quot;long&amp;quot;,
                          osFUN = osMaxPos,
                          prefer = &amp;quot;Open&amp;quot;,
                          replace = TRUE,
                          TxnFees = .txnfees),
         type = &amp;quot;enter&amp;quot;,
         label = &amp;quot;EnterLONG&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;RollingLogitStrategy&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;From the Logistic model we have added our signal to buy when the probability of the next days price is greater than &lt;code&gt;0.60&lt;/code&gt;. So far we just keep buying when the probability of the logistic model passes over &lt;code&gt;0.60&lt;/code&gt; but we have no position to sell when the model predicts something different.&lt;/p&gt;
&lt;p&gt;I thought it might be interesting to exit the strategy when the model is undecided or makes a very low predicted probability. I set this threshold to be less than 0.4 based on the probability density plot below. So we are making trades at the tail ends of the distribution, buying when the model is &lt;em&gt;confident&lt;/em&gt; and selling when it is &lt;em&gt;unsure&lt;/em&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;plot(density(out$probs))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/quantstrat-rolling-logistic/quantstrat_files/figure-html/unnamed-chunk-16-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Add the signals and rules for exiting the strategy. Using a similar principle as before, I create a &lt;code&gt;signal&lt;/code&gt; when the probability is less than 0.4 and call it &lt;code&gt;exitlongSig&lt;/code&gt;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Careful here when setting &lt;code&gt;type = &#34;exit&#34;&lt;/code&gt; and &lt;code&gt;orderside = &#34;long&#34;&lt;/code&gt;. Previously had it set to &lt;code&gt;type = exit&lt;/code&gt; and &lt;code&gt;orderside = short&lt;/code&gt;! which is completely wrong.&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 2.a) # create the signal of when we should be looking to exit
# #exit when prob drops below 0.4 for the first time
add.signal(strategy = strategy.st,
           name = &amp;quot;sigThreshold&amp;quot;,
           arguments = list(threshold = 0.4,
                            column = &amp;quot;probs&amp;quot;,
                            relationship = &amp;quot;lt&amp;quot;,
                            cross = TRUE),
           label = &amp;quot;exitlongSig&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;RollingLogitStrategy&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 2.b) # Add that signal to the rule of exiting
add.rule(strategy.st,
         name = &amp;quot;ruleSignal&amp;quot;,
         arguments = list(sigcol = &amp;quot;exitlongSig&amp;quot;,
                          sigval = 1,
                          orderqty = &amp;quot;all&amp;quot;,
                          ordertype = &amp;quot;market&amp;quot;,
                          orderside = &amp;quot;long&amp;quot;,
                          osFUN = osMaxPos,
                          prefer = &amp;quot;Open&amp;quot;,
                          replace = TRUE,
                          TxnFees = .txnfees),
         type = &amp;quot;exit&amp;quot;,
         label = &amp;quot;ExitLong&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;RollingLogitStrategy&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can finally apply the strategy and see how it performs. It doesn’t make many transactions due to the backtesting being quite restrictive.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;applyStrategy(strategy.st, portfolios = portfolio.st)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;2018-07-05 00:00:00 MSFT 10 @ 97.5851340312762&amp;quot;
## [1] &amp;quot;2018-07-11 00:00:00 MSFT 10 @ 99.2033819340086&amp;quot;
## [1] &amp;quot;2018-12-06 00:00:00 MSFT -20 @ 104.632969498356&amp;quot;
## [1] &amp;quot;2018-12-19 00:00:00 MSFT 10 @ 102.487313341245&amp;quot;
## [1] &amp;quot;2019-01-09 00:00:00 MSFT 10 @ 102.694956688076&amp;quot;
## [1] &amp;quot;2019-02-21 00:00:00 MSFT -20 @ 106.15227613615&amp;quot;
## [1] &amp;quot;2019-04-11 00:00:00 MSFT 10 @ 119.69686840234&amp;quot;
## [1] &amp;quot;2019-04-24 00:00:00 MSFT 10 @ 124.91014659961&amp;quot;
## [1] &amp;quot;2019-06-13 00:00:00 MSFT -20 @ 131.541967172209&amp;quot;
## [1] &amp;quot;2019-06-27 00:00:00 MSFT 10 @ 133.694801331394&amp;quot;
## [1] &amp;quot;2019-07-09 00:00:00 MSFT 10 @ 135.548629168169&amp;quot;
## [1] &amp;quot;2019-08-23 00:00:00 MSFT -20 @ 137.190002&amp;quot;
## [1] &amp;quot;2019-08-28 00:00:00 MSFT 10 @ 134.880005&amp;quot;
## [1] &amp;quot;2019-09-05 00:00:00 MSFT -10 @ 139.110001&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;updatePortf(portfolio.st)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;RollingLogitStrategy&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;updateAcct(account.st)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;RollingLogitStrategy&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;updateEndEq(account.st)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;RollingLogitStrategy&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;chart.Posn(portfolio.st, Symbol = &amp;quot;MSFT&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/quantstrat-rolling-logistic/quantstrat_files/figure-html/unnamed-chunk-18-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;           #TA=&amp;quot;add_SMA(n = 10, col = 2); add_SMA(n = 30, col = 4)&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Look at the &lt;code&gt;mktdata&lt;/code&gt; which is where our &lt;code&gt;signals&lt;/code&gt; and &lt;code&gt;predictions&lt;/code&gt; are stored.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;mktdata %&amp;gt;%
  data.frame() %&amp;gt;%
  head(10) %&amp;gt;%
  kable() %&amp;gt;%
  kable_styling(bootstrap_options = c(&amp;quot;striped&amp;quot;, &amp;quot;hover&amp;quot;, &amp;quot;condensed&amp;quot;, &amp;quot;responsive&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;table class=&#34;table table-striped table-hover table-condensed table-responsive&#34; style=&#34;margin-left: auto; margin-right: auto;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left;&#34;&gt;
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.Open
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.High
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.Low
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.Close
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.Volume
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
MSFT.Adjusted
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
Y
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
X1
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
X2
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
X3
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
probs
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
predictions
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
longSig
&lt;/th&gt;
&lt;th style=&#34;text-align:right;&#34;&gt;
exitlongSig
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-06-19
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.73225
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.05627
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.58513
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.91896
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
28653100
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.91896
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.33186
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
63.01370
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1.9811302
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.6709360
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
NA
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
NA
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-06-20
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.41915
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
100.54701
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.17396
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.90953
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
26180800
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.90952
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.20142
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
59.54048
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.0686529
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7426882
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-06-21
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
100.11548
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
100.48817
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.93857
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.19357
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
23198200
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.19357
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.14061
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
63.88638
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.1961559
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7523711
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-06-22
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.47763
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.83069
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.71263
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.47763
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
38923100
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.47763
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.16611
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
51.80598
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-1.0297958
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7586200
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-06-25
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.07551
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.18340
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
95.42748
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.49649
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
35433300
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.49649
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
99.04646
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
43.39626
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-2.0399648
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7851164
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-06-26
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.91822
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.15397
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.84957
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.17322
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
26897200
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.17323
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.78558
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
32.78984
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-2.4420783
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.6282847
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-06-27
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.66360
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.09512
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
95.52555
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
95.66285
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
31298400
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
95.66285
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.56687
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
35.08314
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-2.5009206
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.7361390
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-06-28
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
95.50593
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.20264
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
95.38824
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.73187
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
26650700
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.73187
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.24224
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
35.29932
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-3.4424524
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.6387378
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-06-29
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.02610
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.98725
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.43765
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.71226
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
28053200
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.71226
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.96861
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
37.17949
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-2.6284247
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.6327528
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left;&#34;&gt;
2018-07-02
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.21207
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.13435
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
96.11400
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.08532
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
19564500
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
98.08531
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
1
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
97.81954
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
39.04847
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
-2.1968885
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0.5659825
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;td style=&#34;text-align:right;&#34;&gt;
0
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;So if we trained a simple logistic model on 100 days of data to give us the next days prediction everyday since June 2018 and only invest if the logistic models prediction is greater than 0.60 and only sell if the logistic models prediction is less than 0.40 then out cumulative P&amp;amp;L would be $334 with a max drawdown of $61.&lt;/p&gt;
&lt;p&gt;I have probably (almost certainly) gone wrong at somepoint using the &lt;code&gt;quantstrat&lt;/code&gt; package so the results will probably not generalise well to other assets, especially using a logistic model with 3 regressors! But it was a fun exercise using the &lt;code&gt;quantstrat&lt;/code&gt; package.&lt;/p&gt;
&lt;p&gt;I will revist and modify this markdown file.&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>
