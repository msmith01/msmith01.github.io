<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.5.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Matthew Smith">

  
  
  
    
  
  <meta name="description" content="I generate a rolling logistic backtesting function which outputs predicted probabilities, based on these probabilities I construct investment criteria and test whether positive returns can be made (lots of work still to do)">

  
  <link rel="alternate" hreflang="en-us" href="/post/quantstrat-rolling-logistic/quantstrat/">

  


  
  
  
  <meta name="theme-color" content="#3f51b5">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="anonymous">
    

    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.5949897e171a43c4edc8bc03336e8676.css">

  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-151949400-1', 'auto');
      
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon-32.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/post/quantstrat-rolling-logistic/quantstrat/">

  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@MatthewSmith786">
  <meta property="twitter:creator" content="@MatthewSmith786">
  
  <meta property="og:site_name" content="Matthew Smith R Shenanigans">
  <meta property="og:url" content="/post/quantstrat-rolling-logistic/quantstrat/">
  <meta property="og:title" content="Learning the Quantstrat and Blotter packages | Matthew Smith R Shenanigans">
  <meta property="og:description" content="I generate a rolling logistic backtesting function which outputs predicted probabilities, based on these probabilities I construct investment criteria and test whether positive returns can be made (lots of work still to do)"><meta property="og:image" content="/img/icon-192.png">
  <meta property="twitter:image" content="/img/icon-192.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2019-09-29T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2019-09-29T00:00:00&#43;00:00">
  

  


    






  






<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/quantstrat-rolling-logistic/quantstrat/"
  },
  "headline": "Learning the Quantstrat and Blotter packages",
  
  "datePublished": "2019-09-29T00:00:00Z",
  "dateModified": "2019-09-29T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Matthew Smith"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Matthew Smith R Shenanigans",
    "logo": {
      "@type": "ImageObject",
      "url": "/img/icon-512.png"
    }
  },
  "description": "I generate a rolling logistic backtesting function which outputs predicted probabilities, based on these probabilities I construct investment criteria and test whether positive returns can be made (lots of work still to do)"
}
</script>

  

  


  


  





  <title>Learning the Quantstrat and Blotter packages | Matthew Smith R Shenanigans</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">Matthew Smith R Shenanigans</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/courses/"><span>Courses</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>Learning the Quantstrat and Blotter packages</h1>

  
  <p class="page-subtitle">A small tutorial (mostly for myself) to understand the functionality of blotter and quantstrat</p>
  

  
    



<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Sep 29, 2019
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    14 min read
  </span>
  

  
  
  
  <span class="middot-divider"></span>
  <a href="/post/quantstrat-rolling-logistic/quantstrat/#disqus_thread"></a>
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/categories/trading/">Trading</a></span>
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=/post/quantstrat-rolling-logistic/quantstrat/&amp;text=Learning%20the%20Quantstrat%20and%20Blotter%20packages" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/post/quantstrat-rolling-logistic/quantstrat/&amp;t=Learning%20the%20Quantstrat%20and%20Blotter%20packages" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Learning%20the%20Quantstrat%20and%20Blotter%20packages&amp;body=/post/quantstrat-rolling-logistic/quantstrat/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=/post/quantstrat-rolling-logistic/quantstrat/&amp;title=Learning%20the%20Quantstrat%20and%20Blotter%20packages" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Learning%20the%20Quantstrat%20and%20Blotter%20packages%20/post/quantstrat-rolling-logistic/quantstrat/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=/post/quantstrat-rolling-logistic/quantstrat/&amp;title=Learning%20the%20Quantstrat%20and%20Blotter%20packages" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

    













<div class="btn-links mb-3">
  
  








  









  
    
  











</div>


  
</div>



  <div class="article-container">

    <div class="article-style">
      
<script src="/rmarkdown-libs/kePrint/kePrint.js"></script>


<p>Load packages:</p>
<pre class="r"><code>library(knitr)
library(kableExtra)
library(dplyr)
library(ggplot2)
library(quantstrat)</code></pre>
<p><strong>::: Note :::</strong> This post is mostly for my future reference/documentation for learning the <code>quantstrat</code> package. An example of a strategy I developed can be found below in which it uses a naive rolling logistic regression model trained on <code>t</code> days to predict <code>t+1</code> market movement. <strong>::: END Note :::</strong></p>
<p>I have been playing around with backtesting trading models using the <code>quantstrat</code> package for a while but the most difficult thing about it was understanding the syntax of <code>blotter</code> and <code>quantstrat</code>, it didn’t seem very intuitive to me at first and there does not seem to be <em>much</em> detailed information online, despite the package being around since 2010. In this post I will give my comments and observations what certain functions do, I will update this post over time.</p>
<div id="backgorund" class="section level3">
<h3>Backgorund</h3>
<p>The <code>quantstrat</code> package is built on the <code>blotter</code> package which was developed in 2008. It works best with time series <code>xts</code> objects which can be easily collected using the <code>quantmod</code> package. The <code>blotter</code> package is the accounting package behind the <code>quantstrat</code> system, it can support multiple accounts or multiple portfolios and computes the P&amp;L of trading systems.</p>
<p>The main blotter functions are the following:</p>
</div>
<div id="initialisation" class="section level3">
<h3>Initialisation</h3>
<ul>
<li><code>initPortf</code> - which initialises a portfolio</li>
<li><code>initAcct</code> - which initialises an account</li>
</ul>
</div>
<div id="performance" class="section level3">
<h3>Performance</h3>
<ul>
<li><code>addTxn</code> - which adds transactions to the portfolio</li>
<li><code>updatePortf</code> - which computes the P&amp;L for each symbol in a given period</li>
<li><code>updateAcct</code> - which computes the equity from the assets</li>
<li><code>updateEndEq</code> - which updates the final equity for an account</li>
<li><code>getEndEq</code> - which provides us with the latest value of our account</li>
<li><code>getPosQty</code> - which gets a position at a given date.</li>
<li><code>chart.Posn</code>- which plots a chart of the position size, and cumulative P&amp;L</li>
<li><code>PortfReturns</code>- which calcualtes the portfolio returns</li>
<li><code>getAccount</code> - which gets our account info!</li>
<li><code>getPortfolio</code> - ""</li>
<li><code>getTxns</code> - ""</li>
<li><code>tradeStats</code> - which collects trade statistics</li>
<li><code>perTradeStats</code> - which calculates per trade statistics</li>
</ul>
<p>The <code>blotter</code> package loads in a number of additional packages as we can see by running the below.</p>
<p>The packages are: <code>xts</code> and <code>zoo</code> for time series, <code>FinancialInstrument</code>, <code>quantmod</code>, <code>TTR</code>, <code>PerformanceAnalytics</code> for finance, where <code>TTR</code> stands for Technical Trading Rules.</p>
<p>The blotter package creates a new environment <code>.blotter</code>.</p>
</div>
<div id="download-financial-data" class="section level3">
<h3>Download Financial Data</h3>
<p>Lets first download some data for the S&amp;P500 from 2018 to 2019 in order to gather some data. For the <code>quantstrat</code> package its quite usual to find the initiation date, start date, end date set outside the parameters of the model. Therefore I first set these parameters as <code>initDate</code>, <code>startDate</code> and <code>endDate</code>.</p>
<pre class="r"><code>initDate &lt;- &#39;2010-01-01&#39; # this is used for later but is must be before the startDate
startDate &lt;- &#39;2018-01-01&#39;
endDate &lt;- &#39;2019-01-01&#39;
symbols &lt;- c(&#39;SPY&#39;)
getSymbols(symbols, from = startDate, to = endDate, src = &quot;yahoo&quot;, adjust=TRUE) </code></pre>
<pre><code>## [1] &quot;SPY&quot;</code></pre>
<table class="table table-striped table-hover table-condensed table-responsive" style="font-size: 12px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-3">Table 1: </span>SPY stocks
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
SPY.Open
</th>
<th style="text-align:right;">
SPY.High
</th>
<th style="text-align:right;">
SPY.Low
</th>
<th style="text-align:right;">
SPY.Close
</th>
<th style="text-align:right;">
SPY.Volume
</th>
<th style="text-align:right;">
SPY.Adjusted
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2018-01-02
</td>
<td style="text-align:right;">
262.8473
</td>
<td style="text-align:right;">
263.7992
</td>
<td style="text-align:right;">
262.4155
</td>
<td style="text-align:right;">
263.7599
</td>
<td style="text-align:right;">
86655700
</td>
<td style="text-align:right;">
260.1310
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-01-03
</td>
<td style="text-align:right;">
263.9464
</td>
<td style="text-align:right;">
265.5951
</td>
<td style="text-align:right;">
263.9464
</td>
<td style="text-align:right;">
265.4283
</td>
<td style="text-align:right;">
90070400
</td>
<td style="text-align:right;">
261.7763
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-01-04
</td>
<td style="text-align:right;">
266.1447
</td>
<td style="text-align:right;">
267.0868
</td>
<td style="text-align:right;">
265.4970
</td>
<td style="text-align:right;">
266.5470
</td>
<td style="text-align:right;">
80636400
</td>
<td style="text-align:right;">
262.8796
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-01-05
</td>
<td style="text-align:right;">
267.4302
</td>
<td style="text-align:right;">
268.4606
</td>
<td style="text-align:right;">
266.8807
</td>
<td style="text-align:right;">
268.3233
</td>
<td style="text-align:right;">
83524000
</td>
<td style="text-align:right;">
264.6314
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-01-08
</td>
<td style="text-align:right;">
268.2153
</td>
<td style="text-align:right;">
268.9906
</td>
<td style="text-align:right;">
267.8915
</td>
<td style="text-align:right;">
268.8140
</td>
<td style="text-align:right;">
57319200
</td>
<td style="text-align:right;">
265.1154
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-01-09
</td>
<td style="text-align:right;">
269.2850
</td>
<td style="text-align:right;">
270.1191
</td>
<td style="text-align:right;">
268.9709
</td>
<td style="text-align:right;">
269.4224
</td>
<td style="text-align:right;">
57254000
</td>
<td style="text-align:right;">
265.7154
</td>
</tr>
</tbody>
</table>
</div>
<div id="plot-the-data" class="section level3">
<h3>Plot the data</h3>
<pre class="r"><code>chartSeries(SPY, name = &quot;Daily time series for SPY&quot;, type = &quot;candlesticks&quot;, theme = chartTheme(&quot;white&quot;))</code></pre>
<p><img src="/post/quantstrat-rolling-logistic/quantstrat_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Once we have the data and after loading the <code>blotter</code> package we must define a few initialisation parameters, namely the <code>currency()</code> and <code>stocks</code> parameter from the <code>FinancialInstrument</code> package.</p>
<pre class="r"><code>currency(&quot;USD&quot;)</code></pre>
<pre><code>## [1] &quot;USD&quot;</code></pre>
<pre class="r"><code>stock(&quot;SPY&quot;, currency = &quot;USD&quot;, multiplier = 1)</code></pre>
<pre><code>## [1] &quot;SPY&quot;</code></pre>
<pre class="r"><code>ls(all = TRUE)</code></pre>
<pre><code>## [1] &quot;.blotter&quot;     &quot;.getSymbols&quot;  &quot;.Random.seed&quot; &quot;.strategy&quot;   
## [5] &quot;endDate&quot;      &quot;initDate&quot;     &quot;SPY&quot;          &quot;startDate&quot;   
## [9] &quot;symbols&quot;</code></pre>
<pre class="r"><code>ls(envir = FinancialInstrument:::.instrument)</code></pre>
<pre><code>## [1] &quot;SPY&quot; &quot;USD&quot;</code></pre>
<p>We can see that we have the SPY index and the USD currency set. We can convert the data from daily time series to monthly time series using the <code>to.period</code> fucntion.</p>
<pre class="r"><code>SPY_monthly &lt;- to.period(SPY, period = &quot;months&quot;)
chartSeries(SPY_monthly, name = &quot;Monthly time series for SPY&quot;, type = &quot;candlesticks&quot;, theme = chartTheme(&quot;white&quot;))</code></pre>
<p><img src="/post/quantstrat-rolling-logistic/quantstrat_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<pre class="r"><code>head(SPY_monthly)</code></pre>
<pre><code>##            SPY.Open SPY.High  SPY.Low SPY.Close SPY.Volume SPY.Adjusted
## 2018-01-31 262.8473 281.2870 262.4155  276.6452 1985506700     272.8389
## 2018-02-28 275.8307 277.7836 248.2054  266.5862 2923722000     262.9184
## 2018-03-29 266.3507 275.1830 254.0372  259.2790 2323561800     255.7117
## 2018-04-30 258.6878 267.3091 250.9237  260.6190 1998466500     257.0332
## 2018-05-31 259.9884 270.2157 255.2393  266.9544 1606397200     263.2814
## 2018-06-29 268.4028 275.3688 265.7283  268.4896 1599001000     264.7955</code></pre>
</div>
<div id="portfolio-parameters" class="section level3">
<h3>Portfolio parameters</h3>
<p>Now that we have our data we should initialise the portfolio with <code>initPortf</code>, which will consist of the transactions over the period of analysis.</p>
<ul>
<li><code>name</code> - “MyFirstPortfolio” - the initial name of the portfolio</li>
<li><code>symbols</code> - “SPY” - since we are using the SPY500</li>
<li><code>initPosQty</code> - 100 - the initial quantity of our position</li>
<li><code>initDate</code> - “initDate” - the initial account equity and position (prior to the closing price of our first position)</li>
<li><code>currency</code> the currency we are using</li>
</ul>
<pre class="r"><code>initDate &lt;- &#39;2010-01-01&#39; # NOTE: We already created this parameter --&gt; which was quoted as &quot;this is used for later but is must be before the startDate&quot;
initPortf(&quot;MyFirstPortfolio&quot;, &quot;SPY&quot;, initDate = initDate)</code></pre>
<pre><code>## [1] &quot;MyFirstPortfolio&quot;</code></pre>
</div>
<div id="account-parameters" class="section level3">
<h3>Account parameters</h3>
<p>We also need to initialise the account using <code>initAcct</code></p>
<ul>
<li><code>name</code> - “MyFirstPortfolio” - the initial name of the portfolio</li>
<li><code>portfolios</code> - the name of our previous portfolio created</li>
<li><code>initDate</code> - “initDate” - the initial account equity and position (prior to the closing price of our first position)</li>
<li><code>initEq</code> - the initial equity we began with</li>
<li><code>currency</code> the currency we are using</li>
</ul>
<pre class="r"><code>initEq = 1000000
initAcct(&quot;MyFirstPortfolio&quot;, portfolios = &quot;MyFirstPortfolio&quot;, initDate = initDate, initEQ = initEq)</code></pre>
<pre><code>## [1] &quot;MyFirstPortfolio&quot;</code></pre>
<pre class="r"><code>first(SPY) # print the first observation in our data</code></pre>
<pre><code>##            SPY.Open SPY.High  SPY.Low SPY.Close SPY.Volume SPY.Adjusted
## 2018-01-02 262.8473 263.7992 262.4155  263.7599   86655700      260.131</code></pre>
<pre class="r"><code>last(SPY) # print the last observation in our data</code></pre>
<pre><code>##            SPY.Open SPY.High SPY.Low SPY.Close SPY.Volume SPY.Adjusted
## 2018-12-31   249.56   250.19  247.47    249.92  144299400     246.4814</code></pre>
</div>
<div id="a-simple-strategy" class="section level1">
<h1>A simple Strategy</h1>
<p>A trading strategy can be broken down into the following blocks:</p>
<ul>
<li><em>Assets</em> - which are the stocks we want to trade, <code>SPY</code>, <code>MSFT</code>, <code>AAPL</code>, <code>MSFT</code> etc.</li>
<li><em>Indicators</em> - which are the variables, Open, High, Low, Close, SMA, EMA, RSI, Momentum etc.</li>
<li><em>Signals</em> - we can create signals based on the interaction between the <em>indicators</em> and the time-series data.</li>
<li><em>Rules</em> - Create <em>buy</em> and <em>sell</em> rules based on the <em>signals</em> created.</li>
<li><em>Orders</em> - Once a <em>rule</em> is activated, push an <em>order</em> through.</li>
<li><em>Analysis</em> - Analyse the performance of the strategy.</li>
</ul>
<p>I wanted to test a basic backtesting concept. What happens if I trained a machine learning model each day on the last 100 days of data to predict the next days stock market direction but test this over many periods?. That is to continuously train a machine learning model at every step to predict the next price. One method is to use the <code>rolling_origin</code> fucntion from the <code>rsample</code> package but I write a more simple function for this.</p>
<p>I load in the parameters of the model and download data for MSFT.</p>
<pre class="r"><code>library(quantstrat)
library(PerformanceAnalytics)
library(e1071)

initDate = &quot;2010-01-01&quot;
from &lt;- &quot;2018-01-01&quot;
to &lt;- &quot;2019-09-20&quot;

init_equity &lt;- 1000
adjustment &lt;- TRUE

.orderqty &lt;- 10                  # The profitability of the strategy depends heavily on this value
.txnfees &lt;- -10
.stoploss &lt;- 3e-3 # 0.003 or 0.3%

currency(&#39;USD&#39;)</code></pre>
<pre><code>## [1] &quot;USD&quot;</code></pre>
<pre class="r"><code>Sys.setenv(TZ=&quot;UTC&quot;)

symbols &lt;- c(&#39;MSFT&#39;)

getSymbols(symbols, from = from, to = to, src = &quot;yahoo&quot;, adjust = TRUE) </code></pre>
<pre><code>## [1] &quot;MSFT&quot;</code></pre>
<p>I created a simple time series pre-processing function to clean up the data, create some features and set the data to <code>xts</code>. Ignore the <code>Scale_Me</code> function.</p>
<pre class="r"><code>Scale_Me &lt;- function(x){
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}


TS_preprocess &lt;- function(dat){
  dat = data.frame(dat)
  colnames(dat) = c(&quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;, &quot;adjusted&quot;)
  dat$Y = with(dat, ifelse(close &gt;= open, 1, 0))
  dat$X1 = SMA(lag(dat$close), n = 10)
  dat$X2 = RSI(lag(dat$close), nFast = 14, nSlow = 26, nSig = 9, maType = SMA)
  dat$X3 = momentum(lag(dat$close), n = 12)
  dat = dat[complete.cases(dat), ]
  #dat = cbind(dat[, &#39;Y&#39;], apply(dat[, 8:ncol(dat)], 2, Scale_Me))
  #colnames(dat)[1] = &quot;Y&quot; 
  dat = dat[, c(&quot;Y&quot;, &quot;X1&quot;, &quot;X2&quot;, &quot;X3&quot;)]
  dat = as.xts(dat)
  return(dat)
}</code></pre>
<p>I next set the training period <code>n_train</code> = 100 periods and <code>n_test</code> = 1 period, or train on <code>t</code> days of data and test of <code>t+1</code> days of data. This can be quite computationally expensive depending on the machine learning model you input but for a simple binary logistic regression classifier its relatively fast. I create the logistic function which returns the predicted probabilities.</p>
<p>The <code>RollingBacktest</code> function, runs the model on <code>n_train</code> periods of data and makes a prediction on <code>n_test</code>. That is, say we have 1000 days of data, the model will train on the first 100 days and predict on day 101, then retrain on days 2 to 101 days and predict on day 102 and so on, continuing until all 1000 days have passed.</p>
<pre class="r"><code>df &lt;- TS_preprocess(MSFT)

n_train &lt;- 100
n_test &lt;- 1

LogistFun &lt;- function(frm, dat, trainIndex, testIndex){
  LogitModel &lt;- glm(frm, data = dat[trainIndex, ])
  pred &lt;- predict(LogitModel, newdata = dat[testIndex, ], type = &#39;response&#39;)
  return(pred)
}

RollingBacktest &lt;- function(dat, ntrain = n_train, ntest = n_test){
  stopifnot(&#39;Y&#39; %in% names(dat))
  frm_ &lt;- formula(reformulate(paste0(&quot;X&quot;, seq(2:ncol(dat))), &quot;Y&quot;))
  
  stride &lt;- ntrain + ntest
  startPosn &lt;- seq(1, dim(dat)[1] - stride)
  
  train_index_list &lt;- lapply(startPosn, function(i) seq(i, i + ntrain))
  test_index_list &lt;- lapply(startPosn, function(i) seq((i + ntrain + 1), (i + ntrain + ntest))) 
  
  mapply(LogistFun, trainIndex = train_index_list, testIndex = test_index_list, MoreArgs = list(frm = frm_, dat = dat), SIMPLIFY = FALSE
  )
}</code></pre>
<p>Now that I have the <em>pre-process function</em>, the <em>logistic function</em> and the <em>backtest function</em>, we can run the model through the <code>TS_postprocess</code> function, which applies everything.</p>
<pre class="r"><code>TS_postprocess &lt;- function(dat, ntrain){
  results = tail(dat, -(ntrain + 1))
  results$probs &lt;- RollingBacktest(dat)
  results$predictions &lt;- ifelse(results$probs &gt; 0.6, 1, 0)
  print(paste0(&quot;Model Accuracy at the 0.60 prob cut-off &quot;, mean(results$Y == results$predictions)))
  return(results)
}

out &lt;- TS_postprocess(df, ntrain = n_train)</code></pre>
<pre><code>## [1] &quot;Model Accuracy at the 0.60 prob cut-off 0.518987341772152&quot;</code></pre>
<pre class="r"><code>out &lt;- na.omit(cbind(MSFT, out))</code></pre>
<p>The model is not very accurate…</p>
<p>The <code>na.omit</code> removes the <code>NA</code> values which were created from the <code>SMA</code>, <code>RSI</code> and <code>momentum</code> calculations which are the first few observations of the time series data.</p>
<p>The data looks like:</p>
<pre class="r"><code>out %&gt;%
  head() %&gt;%
  kable() %&gt;%
  kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;, &quot;responsive&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
MSFT.Open
</th>
<th style="text-align:right;">
MSFT.High
</th>
<th style="text-align:right;">
MSFT.Low
</th>
<th style="text-align:right;">
MSFT.Close
</th>
<th style="text-align:right;">
MSFT.Volume
</th>
<th style="text-align:right;">
MSFT.Adjusted
</th>
<th style="text-align:right;">
Y
</th>
<th style="text-align:right;">
X1
</th>
<th style="text-align:right;">
X2
</th>
<th style="text-align:right;">
X3
</th>
<th style="text-align:right;">
probs
</th>
<th style="text-align:right;">
predictions
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
97.73225
</td>
<td style="text-align:right;">
99.05627
</td>
<td style="text-align:right;">
97.58513
</td>
<td style="text-align:right;">
98.91896
</td>
<td style="text-align:right;">
28653100
</td>
<td style="text-align:right;">
98.91896
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
99.33186
</td>
<td style="text-align:right;">
63.01370
</td>
<td style="text-align:right;">
1.98113024
</td>
<td style="text-align:right;">
0.6709360
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
99.41915
</td>
<td style="text-align:right;">
100.54701
</td>
<td style="text-align:right;">
99.17396
</td>
<td style="text-align:right;">
99.90953
</td>
<td style="text-align:right;">
26180800
</td>
<td style="text-align:right;">
99.90952
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
99.20142
</td>
<td style="text-align:right;">
59.54048
</td>
<td style="text-align:right;">
0.06865286
</td>
<td style="text-align:right;">
0.7426882
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
100.11548
</td>
<td style="text-align:right;">
100.48817
</td>
<td style="text-align:right;">
98.93857
</td>
<td style="text-align:right;">
99.19357
</td>
<td style="text-align:right;">
23198200
</td>
<td style="text-align:right;">
99.19357
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
99.14061
</td>
<td style="text-align:right;">
63.88638
</td>
<td style="text-align:right;">
0.19615593
</td>
<td style="text-align:right;">
0.7523711
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
98.47763
</td>
<td style="text-align:right;">
98.83069
</td>
<td style="text-align:right;">
97.71263
</td>
<td style="text-align:right;">
98.47763
</td>
<td style="text-align:right;">
38923100
</td>
<td style="text-align:right;">
98.47763
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
99.16611
</td>
<td style="text-align:right;">
51.80598
</td>
<td style="text-align:right;">
-1.02979581
</td>
<td style="text-align:right;">
0.7586200
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
98.07551
</td>
<td style="text-align:right;">
98.18340
</td>
<td style="text-align:right;">
95.42748
</td>
<td style="text-align:right;">
96.49649
</td>
<td style="text-align:right;">
35433300
</td>
<td style="text-align:right;">
96.49649
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
99.04646
</td>
<td style="text-align:right;">
43.39626
</td>
<td style="text-align:right;">
-2.03996476
</td>
<td style="text-align:right;">
0.7851164
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
96.91822
</td>
<td style="text-align:right;">
98.15397
</td>
<td style="text-align:right;">
96.84957
</td>
<td style="text-align:right;">
97.17322
</td>
<td style="text-align:right;">
26897200
</td>
<td style="text-align:right;">
97.17323
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
98.78558
</td>
<td style="text-align:right;">
32.78984
</td>
<td style="text-align:right;">
-2.44207828
</td>
<td style="text-align:right;">
0.6282847
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<p>We can see that the model outputs predicted probabilities, I simply set the <code>predictions</code> column to give a <code>1</code> if the models predicted probability is <code>&gt; 0.5</code> or a <code>0</code> if it is <code>&lt; 0.5</code>. The <code>Y</code> variable is the observed and the <code>X1</code>, <code>X2</code> and <code>X3</code> variables are the <code>SMA</code>, <code>RSI</code> and <code>momentum</code>.</p>
<p>We can now use the <code>quantstrat</code> package to backtest the model and see how the performance went.</p>
<pre class="r"><code>MSFT &lt;- out

stock(&quot;MSFT&quot;, currency = &quot;USD&quot;, multiplier = 1)</code></pre>
<pre><code>## [1] &quot;MSFT&quot;</code></pre>
<pre class="r"><code>strategy.st &lt;- portfolio.st &lt;- account.st &lt;- &quot;RollingLogitStrategy&quot;

rm.strat(strategy.st)
rm.strat(portfolio.st)
rm.strat(account.st)


initPortf(name = portfolio.st,
          symbols = symbols,
          initDate = initDate,
          currency = &#39;USD&#39;)</code></pre>
<pre><code>## [1] &quot;RollingLogitStrategy&quot;</code></pre>
<pre class="r"><code>initAcct(name = account.st,
         portfolios = portfolio.st,
         initDate = initDate,
         currency = &#39;USD&#39;,
         initEq = init_equity)</code></pre>
<pre><code>## [1] &quot;RollingLogitStrategy&quot;</code></pre>
<pre class="r"><code>initOrders(portfolio.st,
           symbols = symbols,
           initDate = initDate)

strategy(strategy.st, store = TRUE)</code></pre>
<p>I add the signals to the strategy and give it some rules.</p>
<ul>
<li>1a)</li>
</ul>
<p>The signal is that the first time the Logistic model produces a probability greater than <code>0.6</code> then assign the signal. The <code>sigThreshold</code> is a <code>quantstrat</code> function, the others are <code>sigComparison</code>, <code>sigCrossover</code> and <code>sigFormula</code>. It calls upon the <code>threshold</code> value in the <code>list</code> of <code>arguments</code>, the column it looks for is the <code>probs</code> column which the predicted probabilities are output to, <code>gt</code> means greater than. It basically creates a new column called <code>logSig</code> and it would be similar to <code>ifelse(df$probs &gt; 0.6, 1, 0)</code> as far as I understand.</p>
<ul>
<li>1b)
The rule for the strategy is to take <code>sigcol</code> which is the <code>label</code> we gave our signal in the previous lines which is called <code>longSig</code>. If <code>longSig = 1</code>, execute a market order going long, buying at the next days open price, the transaction fees were set at the start of the strategy. We call this <code>rule</code>, <code>EnterLONG</code>.</li>
</ul>
<pre class="r"><code>nMult_orderqty &lt;- 2
addPosLimit(portfolio.st, symbol = &quot;MSFT&quot;, timestamp = initDate, maxpos = nMult_orderqty * .orderqty)

# Objective: Buy when the probability is gt 0.60, using cross = TRUE

# 1.a)
add.signal(strategy = strategy.st,
           name = &quot;sigThreshold&quot;,
           arguments = list(threshold = 0.6,
                            column = &quot;probs&quot;,
                            relationship = &quot;gt&quot;,
                            cross = TRUE),
           label = &quot;longSig&quot;)</code></pre>
<pre><code>## [1] &quot;RollingLogitStrategy&quot;</code></pre>
<pre class="r"><code># 1.b)
# # Adding the rules, enter at the open price when prob &gt; 0.60 for the first time, taking transaction fees into account
add.rule(strategy = strategy.st,
         name = &quot;ruleSignal&quot;,
         arguments = list(sigcol = &quot;longSig&quot;,   # check the ifelse predictions statement
                          sigval = 1,
                          orderqty = .orderqty,
                          ordertype = &quot;market&quot;,
                          orderside = &quot;long&quot;,
                          osFUN = osMaxPos,
                          prefer = &quot;Open&quot;,
                          replace = TRUE,
                          TxnFees = .txnfees),
         type = &quot;enter&quot;,
         label = &quot;EnterLONG&quot;)</code></pre>
<pre><code>## [1] &quot;RollingLogitStrategy&quot;</code></pre>
<p>From the Logistic model we have added our signal to buy when the probability of the next days price is greater than <code>0.60</code>. So far we just keep buying when the probability of the logistic model passes over <code>0.60</code> but we have no position to sell when the model predicts something different.</p>
<p>I thought it might be interesting to exit the strategy when the model is undecided or makes a very low predicted probability. I set this threshold to be less than 0.4 based on the probability density plot below. So we are making trades at the tail ends of the distribution, buying when the model is <em>confident</em> and selling when it is <em>unsure</em>.</p>
<pre class="r"><code>plot(density(out$probs))</code></pre>
<p><img src="/post/quantstrat-rolling-logistic/quantstrat_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p>Add the signals and rules for exiting the strategy. Using a similar principle as before, I create a <code>signal</code> when the probability is less than 0.4 and call it <code>exitlongSig</code>.</p>
<ul>
<li>Careful here when setting <code>type = "exit"</code> and <code>orderside = "long"</code>. Previously had it set to <code>type = exit</code> and <code>orderside = short</code>! which is completely wrong.</li>
</ul>
<pre class="r"><code># 2.a) # create the signal of when we should be looking to exit
# #exit when prob drops below 0.4 for the first time
add.signal(strategy = strategy.st,
           name = &quot;sigThreshold&quot;,
           arguments = list(threshold = 0.4,
                            column = &quot;probs&quot;,
                            relationship = &quot;lt&quot;,
                            cross = TRUE),
           label = &quot;exitlongSig&quot;)</code></pre>
<pre><code>## [1] &quot;RollingLogitStrategy&quot;</code></pre>
<pre class="r"><code># 2.b) # Add that signal to the rule of exiting
add.rule(strategy.st,
         name = &quot;ruleSignal&quot;,
         arguments = list(sigcol = &quot;exitlongSig&quot;,
                          sigval = 1,
                          orderqty = &quot;all&quot;,
                          ordertype = &quot;market&quot;,
                          orderside = &quot;long&quot;,
                          osFUN = osMaxPos,
                          prefer = &quot;Open&quot;,
                          replace = TRUE,
                          TxnFees = .txnfees),
         type = &quot;exit&quot;,
         label = &quot;ExitLong&quot;)</code></pre>
<pre><code>## [1] &quot;RollingLogitStrategy&quot;</code></pre>
<p>We can finally apply the strategy and see how it performs. It doesn’t make many transactions due to the backtesting being quite restrictive.</p>
<pre class="r"><code>applyStrategy(strategy.st, portfolios = portfolio.st)</code></pre>
<pre><code>## [1] &quot;2018-07-05 00:00:00 MSFT 10 @ 97.5851340312762&quot;
## [1] &quot;2018-07-11 00:00:00 MSFT 10 @ 99.2033819340086&quot;
## [1] &quot;2018-12-06 00:00:00 MSFT -20 @ 104.632969498356&quot;
## [1] &quot;2018-12-19 00:00:00 MSFT 10 @ 102.487313341245&quot;
## [1] &quot;2019-01-09 00:00:00 MSFT 10 @ 102.694956688076&quot;
## [1] &quot;2019-02-21 00:00:00 MSFT -20 @ 106.15227613615&quot;
## [1] &quot;2019-04-11 00:00:00 MSFT 10 @ 119.69686840234&quot;
## [1] &quot;2019-04-24 00:00:00 MSFT 10 @ 124.91014659961&quot;
## [1] &quot;2019-06-13 00:00:00 MSFT -20 @ 131.541967172209&quot;
## [1] &quot;2019-06-27 00:00:00 MSFT 10 @ 133.694801331394&quot;
## [1] &quot;2019-07-09 00:00:00 MSFT 10 @ 135.548629168169&quot;
## [1] &quot;2019-08-23 00:00:00 MSFT -20 @ 137.190002&quot;
## [1] &quot;2019-08-28 00:00:00 MSFT 10 @ 134.880005&quot;
## [1] &quot;2019-09-05 00:00:00 MSFT -10 @ 139.110001&quot;</code></pre>
<pre class="r"><code>updatePortf(portfolio.st)</code></pre>
<pre><code>## [1] &quot;RollingLogitStrategy&quot;</code></pre>
<pre class="r"><code>updateAcct(account.st)</code></pre>
<pre><code>## [1] &quot;RollingLogitStrategy&quot;</code></pre>
<pre class="r"><code>updateEndEq(account.st)</code></pre>
<pre><code>## [1] &quot;RollingLogitStrategy&quot;</code></pre>
<pre class="r"><code>chart.Posn(portfolio.st, Symbol = &quot;MSFT&quot;)</code></pre>
<p><img src="/post/quantstrat-rolling-logistic/quantstrat_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<pre class="r"><code>           #TA=&quot;add_SMA(n = 10, col = 2); add_SMA(n = 30, col = 4)&quot;)</code></pre>
<p>Look at the <code>mktdata</code> which is where our <code>signals</code> and <code>predictions</code> are stored.</p>
<pre class="r"><code>mktdata %&gt;%
  data.frame() %&gt;%
  head(10) %&gt;%
  kable() %&gt;%
  kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;, &quot;responsive&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
MSFT.Open
</th>
<th style="text-align:right;">
MSFT.High
</th>
<th style="text-align:right;">
MSFT.Low
</th>
<th style="text-align:right;">
MSFT.Close
</th>
<th style="text-align:right;">
MSFT.Volume
</th>
<th style="text-align:right;">
MSFT.Adjusted
</th>
<th style="text-align:right;">
Y
</th>
<th style="text-align:right;">
X1
</th>
<th style="text-align:right;">
X2
</th>
<th style="text-align:right;">
X3
</th>
<th style="text-align:right;">
probs
</th>
<th style="text-align:right;">
predictions
</th>
<th style="text-align:right;">
longSig
</th>
<th style="text-align:right;">
exitlongSig
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2018-06-19
</td>
<td style="text-align:right;">
97.73225
</td>
<td style="text-align:right;">
99.05627
</td>
<td style="text-align:right;">
97.58513
</td>
<td style="text-align:right;">
98.91896
</td>
<td style="text-align:right;">
28653100
</td>
<td style="text-align:right;">
98.91896
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
99.33186
</td>
<td style="text-align:right;">
63.01370
</td>
<td style="text-align:right;">
1.9811302
</td>
<td style="text-align:right;">
0.6709360
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-06-20
</td>
<td style="text-align:right;">
99.41915
</td>
<td style="text-align:right;">
100.54701
</td>
<td style="text-align:right;">
99.17396
</td>
<td style="text-align:right;">
99.90953
</td>
<td style="text-align:right;">
26180800
</td>
<td style="text-align:right;">
99.90952
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
99.20142
</td>
<td style="text-align:right;">
59.54048
</td>
<td style="text-align:right;">
0.0686529
</td>
<td style="text-align:right;">
0.7426882
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-06-21
</td>
<td style="text-align:right;">
100.11548
</td>
<td style="text-align:right;">
100.48817
</td>
<td style="text-align:right;">
98.93857
</td>
<td style="text-align:right;">
99.19357
</td>
<td style="text-align:right;">
23198200
</td>
<td style="text-align:right;">
99.19357
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
99.14061
</td>
<td style="text-align:right;">
63.88638
</td>
<td style="text-align:right;">
0.1961559
</td>
<td style="text-align:right;">
0.7523711
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-06-22
</td>
<td style="text-align:right;">
98.47763
</td>
<td style="text-align:right;">
98.83069
</td>
<td style="text-align:right;">
97.71263
</td>
<td style="text-align:right;">
98.47763
</td>
<td style="text-align:right;">
38923100
</td>
<td style="text-align:right;">
98.47763
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
99.16611
</td>
<td style="text-align:right;">
51.80598
</td>
<td style="text-align:right;">
-1.0297958
</td>
<td style="text-align:right;">
0.7586200
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-06-25
</td>
<td style="text-align:right;">
98.07551
</td>
<td style="text-align:right;">
98.18340
</td>
<td style="text-align:right;">
95.42748
</td>
<td style="text-align:right;">
96.49649
</td>
<td style="text-align:right;">
35433300
</td>
<td style="text-align:right;">
96.49649
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
99.04646
</td>
<td style="text-align:right;">
43.39626
</td>
<td style="text-align:right;">
-2.0399648
</td>
<td style="text-align:right;">
0.7851164
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-06-26
</td>
<td style="text-align:right;">
96.91822
</td>
<td style="text-align:right;">
98.15397
</td>
<td style="text-align:right;">
96.84957
</td>
<td style="text-align:right;">
97.17322
</td>
<td style="text-align:right;">
26897200
</td>
<td style="text-align:right;">
97.17323
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
98.78558
</td>
<td style="text-align:right;">
32.78984
</td>
<td style="text-align:right;">
-2.4420783
</td>
<td style="text-align:right;">
0.6282847
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-06-27
</td>
<td style="text-align:right;">
97.66360
</td>
<td style="text-align:right;">
98.09512
</td>
<td style="text-align:right;">
95.52555
</td>
<td style="text-align:right;">
95.66285
</td>
<td style="text-align:right;">
31298400
</td>
<td style="text-align:right;">
95.66285
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
98.56687
</td>
<td style="text-align:right;">
35.08314
</td>
<td style="text-align:right;">
-2.5009206
</td>
<td style="text-align:right;">
0.7361390
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-06-28
</td>
<td style="text-align:right;">
95.50593
</td>
<td style="text-align:right;">
97.20264
</td>
<td style="text-align:right;">
95.38824
</td>
<td style="text-align:right;">
96.73187
</td>
<td style="text-align:right;">
26650700
</td>
<td style="text-align:right;">
96.73187
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
98.24224
</td>
<td style="text-align:right;">
35.29932
</td>
<td style="text-align:right;">
-3.4424524
</td>
<td style="text-align:right;">
0.6387378
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-06-29
</td>
<td style="text-align:right;">
97.02610
</td>
<td style="text-align:right;">
97.98725
</td>
<td style="text-align:right;">
96.43765
</td>
<td style="text-align:right;">
96.71226
</td>
<td style="text-align:right;">
28053200
</td>
<td style="text-align:right;">
96.71226
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
97.96861
</td>
<td style="text-align:right;">
37.17949
</td>
<td style="text-align:right;">
-2.6284247
</td>
<td style="text-align:right;">
0.6327528
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-07-02
</td>
<td style="text-align:right;">
96.21207
</td>
<td style="text-align:right;">
98.13435
</td>
<td style="text-align:right;">
96.11400
</td>
<td style="text-align:right;">
98.08532
</td>
<td style="text-align:right;">
19564500
</td>
<td style="text-align:right;">
98.08531
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
97.81954
</td>
<td style="text-align:right;">
39.04847
</td>
<td style="text-align:right;">
-2.1968885
</td>
<td style="text-align:right;">
0.5659825
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
<p>So if we trained a simple logistic model on 100 days of data to give us the next days prediction everyday since June 2018 and only invest if the logistic models prediction is greater than 0.60 and only sell if the logistic models prediction is less than 0.40 then out cumulative P&amp;L would be $334 with a max drawdown of $61.</p>
<p>I have probably (almost certainly) gone wrong at somepoint using the <code>quantstrat</code> package so the results will probably not generalise well to other assets, especially using a logistic model with 3 regressors! But it was a fun exercise using the <code>quantstrat</code> package.</p>
<p>I will revist and modify this markdown file.</p>
</div>

    </div>

    


    

<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/trading/">trading</a>
  
  <a class="badge badge-light" href="/tags/finance/">finance</a>
  
  <a class="badge badge-light" href="/tags/yahoo-finance/">yahoo finance</a>
  
  <a class="badge badge-light" href="/tags/quantstrat/">quantstrat</a>
  
  <a class="badge badge-light" href="/tags/technical-analysis/">technical analysis</a>
  
  <a class="badge badge-light" href="/tags/backtesting/">backtesting</a>
  
</div>



    
      








  






  
  
  
    
  
  
  <div class="media author-card">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hu88685f9f250f5c15d78dab2d9552b11c_15179_250x250_fill_q90_lanczos_center.jpg" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title"><a href="/">Matthew Smith</a></h5>
      <h6 class="card-subtitle">Researcher</h6>
      <p class="card-text">I am a researcher with a focus on Machine Learning methods applied to economics and finance.</p>
      <ul class="network-icon" aria-hidden="true">
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a href="/#contact" >
              <i class="fas fa-envelope"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a href="https://twitter.com/MatthewSmith786" target="_blank" rel="noopener">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a href="https://scholar.google.co.uk/" target="_blank" rel="noopener">
              <i class="ai ai-google-scholar"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a href="https://github.com/msmith01" target="_blank" rel="noopener">
              <i class="fab fa-github"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>



      
      
      <div class="article-widget">
        <div class="hr-light"></div>
        <h3>Related</h3>
        <ul>
          
          <li><a href="/post/nfo-wc-calculations/nfo-wc-calculations-plots/">Need for Funds (NFO) and Working Capital (WC) Calculations</a></li>
          
          <li><a href="/post/financial-ratios-in-r/fundamental-financial-ratios-in-r/">Fundamental Financial Ratios in R</a></li>
          
          <li><a href="/post/yahoo-finance-ipo/">Scraping Yahoo Finance IPO Data</a></li>
          
          <li><a href="/post/nvidia-share-price/">Tracking NVDA&#39;s share price</a></li>
          
        </ul>
      </div>
      
    

    

    
<section id="comments">
  
    
<div id="disqus_thread"></div>
<script>
  let disqus_config = function () {
    
    
    
  };
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
      return;
    }
    var d = document, s = d.createElement('script'); s.async = true;
    s.src = 'https://' + "lf0-com" + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  
</section>



  </div>
</article>

      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/r.min.js"></script>
        
      

      
      
    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin="anonymous"></script>
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    <script id="dsq-count-scr" src="https://lf0-com.disqus.com/count.js" async></script>
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.130521ecfc6f534c52c158217bbff718.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
        
  </p>
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
