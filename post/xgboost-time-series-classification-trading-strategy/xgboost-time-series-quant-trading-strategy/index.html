<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.5.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Matthew Smith">

  
  
  
    
  
  <meta name="description" content="I construct a series of time-series features from the literature and apply a novel XGBoost model to predict the next days price of a number of assets. The concept is simple and can be expanded to many variables, incorporate many assets and be applied to different Machine Learning models.">

  
  <link rel="alternate" hreflang="en-us" href="/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/">

  


  
  
  
  <meta name="theme-color" content="#3f51b5">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="anonymous">
    

    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.5949897e171a43c4edc8bc03336e8676.css">

  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-151949400-1', 'auto');
      
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon-32.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/">

  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@MatthewSmith786">
  <meta property="twitter:creator" content="@MatthewSmith786">
  
  <meta property="og:site_name" content="Matthew Smith R Shenanigans">
  <meta property="og:url" content="/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/">
  <meta property="og:title" content="Machine Learning (XGBoost) Time-Series Classification Trading Strategy | Matthew Smith R Shenanigans">
  <meta property="og:description" content="I construct a series of time-series features from the literature and apply a novel XGBoost model to predict the next days price of a number of assets. The concept is simple and can be expanded to many variables, incorporate many assets and be applied to different Machine Learning models."><meta property="og:image" content="/img/icon-192.png">
  <meta property="twitter:image" content="/img/icon-192.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-02-02T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2020-02-02T00:00:00&#43;00:00">
  

  


    






  






<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/"
  },
  "headline": "Machine Learning (XGBoost) Time-Series Classification Trading Strategy",
  
  "datePublished": "2020-02-02T00:00:00Z",
  "dateModified": "2020-02-02T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Matthew Smith"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Matthew Smith R Shenanigans",
    "logo": {
      "@type": "ImageObject",
      "url": "/img/icon-512.png"
    }
  },
  "description": "I construct a series of time-series features from the literature and apply a novel XGBoost model to predict the next days price of a number of assets. The concept is simple and can be expanded to many variables, incorporate many assets and be applied to different Machine Learning models."
}
</script>

  

  


  


  





  <title>Machine Learning (XGBoost) Time-Series Classification Trading Strategy | Matthew Smith R Shenanigans</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">Matthew Smith R Shenanigans</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/courses/"><span>Courses</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

        
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Blogroll</span><span class="caret"></span>
          </a>
          <ul class="dropdown-menu">
            
            <li class="dropdown-item my-0 py-0 mx-0 px-0">
              <a href="https://www.linkedin.com/in/msmithsm14/"><span>LinkedIn</span></a>
            </li>
            
            <li class="dropdown-item my-0 py-0 mx-0 px-0">
              <a href="https://www.r-bloggers.com"><span>R-bloggers</span></a>
            </li>
            
            <li class="dropdown-item my-0 py-0 mx-0 px-0">
              <a href="https://quantocracy.com/"><span>Quantocracy</span></a>
            </li>
            
            <li class="dropdown-item my-0 py-0 mx-0 px-0">
              <a href="https://blog.feedspot.com/r_programming_blogs/"><span>Top 40 R Blogs</span></a>
            </li>
            
            <li class="dropdown-item my-0 py-0 mx-0 px-0">
              <a href="https://rweekly.org/"><span>R Weekly</span></a>
            </li>
            
            <li class="dropdown-item my-0 py-0 mx-0 px-0">
              <a href="https://quantpedia.com/blog/"><span>Quantpedia</span></a>
            </li>
            
          </ul>
        </li>

        
        

      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>Machine Learning (XGBoost) Time-Series Classification Trading Strategy</h1>

  
  <p class="page-subtitle">A simple quantitative trading strategy using time series features</p>
  

  
    



<div class="article-metadata">

  
  
  
  
  <div>
    



  <span><a href="/authors/admin/">Matthew Smith</a></span>

  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    Feb 2, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    14 min read
  </span>
  

  
  
  
  <span class="middot-divider"></span>
  <a href="/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/#disqus_thread"></a>
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/categories/quantitative-finance/">Quantitative Finance</a>, <a href="/categories/machine-learning/">Machine Learning</a>, <a href="/categories/time-series/">Time Series</a>, <a href="/categories/algo-trading/">Algo Trading</a></span>
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/&amp;text=Machine%20Learning%20%28XGBoost%29%20Time-Series%20Classification%20Trading%20Strategy" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/&amp;t=Machine%20Learning%20%28XGBoost%29%20Time-Series%20Classification%20Trading%20Strategy" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Machine%20Learning%20%28XGBoost%29%20Time-Series%20Classification%20Trading%20Strategy&amp;body=/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/&amp;title=Machine%20Learning%20%28XGBoost%29%20Time-Series%20Classification%20Trading%20Strategy" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Machine%20Learning%20%28XGBoost%29%20Time-Series%20Classification%20Trading%20Strategy%20/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=/post/xgboost-time-series-classification-trading-strategy/xgboost-time-series-quant-trading-strategy/&amp;title=Machine%20Learning%20%28XGBoost%29%20Time-Series%20Classification%20Trading%20Strategy" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

    













<div class="btn-links mb-3">
  
  








  









  
    
  











</div>


  
</div>



  <div class="article-container">

    <div class="article-style">
      
<script src="/rmarkdown-libs/kePrint/kePrint.js"></script>


<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Using Machine Learning (ML) and past price data to predict the next periods price or direction in the stock market is not new, neither does it produce any meaningful predictions. In this post I <em>collapse</em> down a series of asset time series data into a simple classification problem and see if a Machine Learning model can do a better job at predicting the next periods direction. I apply a similar method here <a href="https://lf0.com/post/synth-real-time-series/financial-time-series/">Time Series Classification Synthetic vs Real Financial Time Series</a>. The <strong>objective</strong> and <strong>strategy</strong> is to invest in a single asset each day. The asset we invest in will be the asset which the Machine Learning model is most <em>confident</em> will go up in share value in the next period <span class="math inline">\(t+1\)</span>. Alternatively speaking, we invest in the asset in which the Machine Learning model gives the highest predicted probability that, a given asset will go up in value tomorrow. That is, if the model predicts on day <span class="math inline">\(t\)</span> that asset GOOG was going to be higher than it’s previous close with a predicted probability of 0.78 and it also predicts that AMZN would go up with 0.53 probability then we would invest in GOOG today. -<em>we only invest in one asset each day</em>- . The model can be expanded to short selling and multi-asset purchasing and multi-periods.</p>
<div id="load-in-the-packages." class="section level2">
<h2>Load in the packages.</h2>
<pre class="r"><code>require(PerformanceAnalytics)
library(data.table)
library(dplyr)
library(tibble)
library(TTR)
library(tidyr)
library(tidyquant)
library(tsfeatures)
library(rsample)
library(purrr)
library(stringr)
library(tibbletime) # tsibble clashes with the base R index() function
library(xgboost)
library(rvest)</code></pre>
<p>Pre-define a few intialisation objects and set the ticker symbols of the companies we want to download. For this task I am not really interested in which companies I apply the strategy to. For this reason, I scrape the Wikipedia page for the S&amp;P 500 and take a random sample of 30 tickers.</p>
<pre class="r"><code>set.seed(1234)
###################### Pre-define functions for later ##########################

Scale_Me &lt;- function(x){
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}                                  # Note: I don&#39;t actually use this function but I leave it in here.

#################################################################################

start_date &lt;- &quot;2017-01-01&quot;
end_date &lt;- &quot;2020-01-01&quot;

url &lt;- &quot;https://en.wikipedia.org/wiki/List_of_S%26P_500_companies&quot;
symbols &lt;- url %&gt;%
  read_html() %&gt;%
  html_nodes(xpath = &#39;//*[@id=&quot;constituents&quot;]&#39;) %&gt;% 
  html_table() %&gt;% 
  .[[1]] %&gt;% 
  filter(!str_detect(Security, &quot;Class A|Class B|Class C&quot;)) %&gt;%     # Removes firms with Class A, B &amp; C shares
  sample_n(30) %&gt;% 
  pull(Symbol)


#symbols &lt;- c(
  #&#39;GOOG&#39;, &#39;MSFT&#39;, &#39;HOG&#39;, &#39;AAPL&#39;, &#39;FB&#39; 
  #&#39;AMZN&#39;, &#39;EBAY&#39;, &#39;IBM&#39;, &#39;NFLX&#39;, &#39;NVDA&#39;,
  #&#39;TWTR&#39;, &#39;WMT&#39;, &#39;XRX&#39;, &#39;INTC&#39;, &#39;HPE&#39;
# )</code></pre>
</div>
<div id="the-data" class="section level2">
<h2>The data</h2>
<p>Download the data and store it into a new environment.</p>
<pre class="r"><code>dataEnv &lt;- new.env()
getSymbols(symbols, 
           from = start_date, 
           to = end_date, 
           #src = &quot;yahoo&quot;, 
           #adjust = TRUE, 
           env = dataEnv)</code></pre>
<pre><code>##  [1] &quot;LEG&quot;  &quot;NLSN&quot; &quot;SLB&quot;  &quot;CHTR&quot; &quot;C&quot;    &quot;REGN&quot; &quot;CCI&quot;  &quot;SYK&quot;  &quot;ROP&quot;  &quot;RL&quot;  
## [11] &quot;CERN&quot; &quot;CMG&quot;  &quot;GS&quot;   &quot;CAT&quot;  &quot;MSI&quot;  &quot;BR&quot;   &quot;VRSK&quot; &quot;PNC&quot;  &quot;KEYS&quot; &quot;PHM&quot; 
## [21] &quot;FB&quot;   &quot;BKR&quot;  &quot;ABMD&quot; &quot;WYNN&quot; &quot;DG&quot;   &quot;ADI&quot;  &quot;GL&quot;   &quot;TSCO&quot; &quot;FLS&quot;  &quot;CDW&quot;</code></pre>
<p>Once the data has been downloaded and stored into a new environment I clean the data up a little, put all the lists into a single data frame, compute the daily returns for each asset and create the <em>up</em> or <em>down</em> direction which will be what the classification model will try to predict.</p>
<pre class="r"><code>df &lt;- eapply(dataEnv, function(x){
  as.data.frame(x) %&gt;% 
    rename_all(function(n){
      gsub(&quot;^(\\w+)\\.&quot;, &quot;&quot;, n, perl = TRUE)
    }
    ) %&gt;%
    rownames_to_column(&quot;date&quot;)  
}) %&gt;% 
  rbindlist(idcol = TRUE) %&gt;% 
  mutate(date = as.Date(date)) %&gt;% 
  group_by(.id) %&gt;% 
  tq_mutate(
    select = Adjusted,
    mutate_fun = periodReturn,
    period = &quot;daily&quot;,
    type = &quot;arithmetic&quot;
  ) %&gt;% 
  mutate(
    Adj_lag = lag(Adjusted),
    chng_Adj = ifelse(Adjusted &gt; Adj_lag, 1, 0) # more simply we could have just done if ret were pos/neg
  ) %&gt;% 
  select(&quot;date&quot;, &quot;.id&quot;, &quot;Adjusted&quot;, &quot;daily.returns&quot;, &quot;chng_Adj&quot;, &quot;Open&quot;, &quot;High&quot;, &quot;Low&quot;, &quot;Close&quot;) %&gt;% 
  as_tibble() %&gt;% 
  as_tbl_time(index = date) %&gt;% 
  setNames(c(&quot;date&quot;, &quot;ID&quot;, &quot;prc&quot;, &quot;ret&quot;, &quot;chng&quot;, &quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;)) %&gt;% 
  drop_na(chng)</code></pre>
<p>The first few observations of the data looks like:</p>
<table class="table table-striped table-hover table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
date
</th>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
prc
</th>
<th style="text-align:right;">
ret
</th>
<th style="text-align:right;">
chng
</th>
<th style="text-align:right;">
open
</th>
<th style="text-align:right;">
high
</th>
<th style="text-align:right;">
low
</th>
<th style="text-align:right;">
close
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2017-01-04
</td>
<td style="text-align:left;">
CDW
</td>
<td style="text-align:right;">
50.63446
</td>
<td style="text-align:right;">
0.0162981
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
51.79
</td>
<td style="text-align:right;">
52.60
</td>
<td style="text-align:right;">
51.79
</td>
<td style="text-align:right;">
52.38
</td>
</tr>
<tr>
<td style="text-align:left;">
2017-01-05
</td>
<td style="text-align:left;">
CDW
</td>
<td style="text-align:right;">
50.14147
</td>
<td style="text-align:right;">
-0.0097364
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
52.10
</td>
<td style="text-align:right;">
52.66
</td>
<td style="text-align:right;">
51.84
</td>
<td style="text-align:right;">
51.87
</td>
</tr>
<tr>
<td style="text-align:left;">
2017-01-06
</td>
<td style="text-align:left;">
CDW
</td>
<td style="text-align:right;">
49.96746
</td>
<td style="text-align:right;">
-0.0034704
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
51.89
</td>
<td style="text-align:right;">
51.95
</td>
<td style="text-align:right;">
51.46
</td>
<td style="text-align:right;">
51.69
</td>
</tr>
</tbody>
</table>
<p>We can use the <code>nest()</code> function to put the data into convenient nested tibbles that we can simply <code>map()</code> over and apply the <code>rolling_origin()</code> function from the <code>rsample</code> package such that, each of our assets will have their own <code>rolling_origin()</code> function applied to it without any overlap or mixing of the asset classes, I do this in order to create the time series features for each period.</p>
<pre class="r"><code>nested_df &lt;- df %&gt;%
  mutate(duplicate_ID = ID) %&gt;% 
  nest(-ID)</code></pre>
<p>I split the time series data into a number of lists such that the <code>analysis()</code> list contains 100 observations in each list and has a corresponding <code>assessment()</code> list which contains 1 observation. Usually the <code>analysis()</code> will become our training data set and the <code>assessment()</code> will become our testing data set, however, here I am using the <code>rolling_origin()</code> function to help create the time series features.</p>
<pre class="r"><code># First we set the number of days we want to construct the ts features
rolled_df &lt;- map(nested_df$data, ~ rolling_origin(.,
                                                  initial = 100,
                                                  assess = 1,
                                                  cumulative = FALSE,
                                                  skip = 0))</code></pre>
</div>
<div id="time-series-functions" class="section level2">
<h2>Time-Series Functions</h2>
<p>In order to create the time series variables I use the <code>tsfeatures</code> package but there is also the <code>feasts</code> packages <a href="http://feasts.tidyverts.org/">here</a>. For this model I simply select a few functions of interest from the <code>tsfeatures</code> package.</p>
<pre class="r"><code>functions &lt;- c(
  &quot;entropy&quot;,                   # Measures the &quot;forecastability&quot; of a series - low values = high sig-to-noise, large vals = difficult to forecast
  &quot;stability&quot;,                 # means/variances are computed for all tiled windows - stability is the variance of the means
  &quot;lumpiness&quot;,                 # Lumpiness is the variance of the variances
  &quot;max_level_shift&quot;,           # Finds the largest mean shift between two consecutive windows (returns two values, size of shift and time index of shift)
  &quot;max_var_shift&quot;,             # Finds the max variance shift between two consecutive windows (returns two values, size of shift and time index of shift)
  &quot;max_kl_shift&quot;,              # Finds the largest shift in the Kulback-Leibler divergence between two consecutive windows (returns two values, size of shift and time index of shift)
  &quot;crossing_points&quot;            # Number of times a series crosses the mean line
)</code></pre>
<p>I wrote this code a little while ago and at the time I wrapped the model into a function. I think it would be more fun to exclusively stick to using just <code>map()</code> functions instead of <code>function(SYMB)</code>. The function does the following for each asset in our data:</p>
<p>Using the out-of-sample <code>t+1</code> (<code>assessment</code>) data, bind these lists together into a single data frame. Next apply the <code>functions</code> character string to call the functions from the <code>tsfeatures</code> package, apply these functions to the in-sample (<code>analysis</code>) data (which consists of 100 observations each), such that, we obtain a single <em>collapsed</em> down observation that we can just bind together. Finally we bind the columns of these two data sets together using <code>bind_cols()</code>. After this I rename the <code>chng</code> variable and rename the time series feature variables to something more dynamic using <code>~str_c("X", seq_along(.))</code> so we can just add functions to the <code>functions</code> character string and not have to worry about renaming the variables individually in order for the model to work.</p>
<p>Once this is done, I create the Machine Learning data set again using the <code>rolling_origin()</code> function. The first <code>rolling_origin()</code> function was used to help <em>collapse</em> the time series data down on a rolling basis by taking the previous 100 days of data and calculating the <code>tsfeatures</code> function on it - <em>a similar method to calculating a rolling mean/sd using the <code>rollapply()</code> function from the <code>zoo</code> package</em>.</p>
<p>I next split the data into <code>X</code> variables with <code>X_train</code> and <code>X_test</code> and the corresponding <code>Y</code> variable with <code>Y_train</code> and <code>Y_test</code>. The package <code>xgboost</code> expects a certain type of <code>xgb.DMatrix()</code> which is what <code>dtrain</code> and <code>dtest</code> are doing.</p>
<p>Then, I set the XGBoost parameters and apply the XGBoost model. - <em>Suitable cross validation should be performed at this point, however I will leave this for another post since time series cross validation is quite tricky and there is no function in R which helps with this type of cross validation (that I have found as of 2020-02-02)</em> -</p>
<p>Once the model has been trained, I make the predictions.</p>
</div>
<div id="apply-the-model" class="section level2">
<h2>Apply the model</h2>
<p>The function to compute all this is the following:</p>
<pre class="r"><code>Prediction_Model &lt;- function(SYMB){
  data &lt;- bind_cols(
    map(rolled_df[[SYMB]]$splits, ~ assessment(.x)) %&gt;%
      bind_rows(),
    map(rolled_df[[SYMB]]$splits, ~ analysis(.x)) %&gt;%
      map(., ~tsfeatures(.x[[&quot;ret&quot;]], functions)) %&gt;%          # Compute the TSFeatures
      bind_rows()
  ) %&gt;%
    rename(Y = chng) %&gt;%
    rename_at(vars(-c(1:9)), ~str_c(&quot;X&quot;, seq_along(.)))        
  
  ml_data &lt;- data %&gt;% 
    as_tibble() %&gt;% 
    rolling_origin(
      initial    = 200,
      assess     = 1,
      cumulative = FALSE,
      skip       = 0)
  
  X_train &lt;- map(
    ml_data$splits, ~ analysis(.x) %&gt;%
      as_tibble(., .name_repair = &quot;universal&quot;) %&gt;%
      select(starts_with(&quot;X&quot;)) %&gt;% 
      as.matrix()
  )
  
  Y_train &lt;- map(
    ml_data$splits, ~ analysis(.x) %&gt;%
      as_tibble(., .name_repair = &quot;universal&quot;) %&gt;%
      select(starts_with(&quot;Y&quot;)) %&gt;% 
      as.matrix()
  )
  
  X_test &lt;- map(
    ml_data$splits, ~ assessment(.x) %&gt;%
      as_tibble(., .name_repair = &quot;universal&quot;) %&gt;%
      select(starts_with(&quot;X&quot;)) %&gt;% 
      as.matrix()
  )
  
  Y_test &lt;- map(
    ml_data$splits, ~ assessment(.x) %&gt;%
      as_tibble(., .name_repair = &quot;universal&quot;) %&gt;%
      select(starts_with(&quot;Y&quot;)) %&gt;% 
      as.matrix()
  )
  
  #############################################################
  
  dtrain &lt;- map2(
    X_train, Y_train, ~ xgb.DMatrix(data = .x, label = .y, missing = &quot;NaN&quot;)
  )
  
  dtest &lt;- map(
    X_test, ~ xgb.DMatrix(data = .x, missing = &quot;NaN&quot;)
  )
  
  # Parameters:
  watchlist &lt;- list(&quot;train&quot; = dtrain)
  params &lt;- list(&quot;eta&quot; = 0.1, &quot;max_depth&quot; = 5, &quot;colsample_bytree&quot; = 1, &quot;min_child_weight&quot; = 1, &quot;subsample&quot;= 1,
                 &quot;objective&quot;=&quot;binary:logistic&quot;, &quot;gamma&quot; = 1, &quot;lambda&quot; = 1, &quot;alpha&quot; = 0, &quot;max_delta_step&quot; = 0,
                 &quot;colsample_bylevel&quot; = 1, &quot;eval_metric&quot;= &quot;auc&quot;,
                 &quot;set.seed&quot; = 176)
  
  # Train the XGBoost model
  xgb.model &lt;- map(
    dtrain, ~ xgboost(params = params, data = .x, nrounds = 10, watchlist)
  )
  
  xgb.pred &lt;- map2(
    .x = xgb.model, 
    .y = dtest, 
    .f = ~ predict(.x, newdata = .y, type = &#39;prob&#39;)
  )
  
  preds &lt;- cbind(plyr::ldply(xgb.pred, data.frame),
                 plyr::ldply(Y_test, data.frame)) %&gt;% 
    setNames(c(&quot;pred_probs&quot;, &quot;actual&quot;)) %&gt;% 
    bind_cols(plyr::ldply(map(ml_data$splits, ~assessment(.x)))) %&gt;% 
    rename(ID = duplicate_ID) %&gt;% 
    #select(pred_probs, actual, date, ID, prc, ret) %&gt;% 
    as_tibble()
  return(preds)
}</code></pre>
<p>We can apply the above model to create the time series features, train and test on each of our assets by running the following.</p>
<pre class="r"><code>Sys_t_start &lt;- Sys.time()
Resultados &lt;- lapply(seq(1:length(rolled_df)), Prediction_Model)
Sys_t_end &lt;- Sys.time()
round(Sys_t_end - Sys_t_start, 2)</code></pre>
<p>The <code>Resultados</code> output will give us a list the length of the number of assets we have in our data. The first few observations of the first asset in the list looks like:</p>
<table class="table table-striped table-hover table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
pred_probs
</th>
<th style="text-align:right;">
actual
</th>
<th style="text-align:left;">
date
</th>
<th style="text-align:right;">
prc
</th>
<th style="text-align:right;">
ret
</th>
<th style="text-align:right;">
Y
</th>
<th style="text-align:right;">
open
</th>
<th style="text-align:right;">
high
</th>
<th style="text-align:right;">
low
</th>
<th style="text-align:right;">
close
</th>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
X1
</th>
<th style="text-align:right;">
X2
</th>
<th style="text-align:right;">
X3
</th>
<th style="text-align:right;">
X4
</th>
<th style="text-align:right;">
X5
</th>
<th style="text-align:right;">
X6
</th>
<th style="text-align:right;">
X7
</th>
<th style="text-align:right;">
X8
</th>
<th style="text-align:right;">
X9
</th>
<th style="text-align:right;">
X10
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
0.7304490
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
2018-03-15
</td>
<td style="text-align:right;">
73.17622
</td>
<td style="text-align:right;">
-0.0106061
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
75.36
</td>
<td style="text-align:right;">
75.51
</td>
<td style="text-align:right;">
74.18
</td>
<td style="text-align:right;">
74.63
</td>
<td style="text-align:left;">
CDW
</td>
<td style="text-align:right;">
0.9870653
</td>
<td style="text-align:right;">
0.1149955
</td>
<td style="text-align:right;">
0.7047308
</td>
<td style="text-align:right;">
1.277064
</td>
<td style="text-align:right;">
71
</td>
<td style="text-align:right;">
3.161538
</td>
<td style="text-align:right;">
63
</td>
<td style="text-align:right;">
3.245055
</td>
<td style="text-align:right;">
76
</td>
<td style="text-align:right;">
56
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5149571
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
2018-03-16
</td>
<td style="text-align:right;">
74.35286
</td>
<td style="text-align:right;">
0.0160795
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
74.78
</td>
<td style="text-align:right;">
75.99
</td>
<td style="text-align:right;">
73.04
</td>
<td style="text-align:right;">
75.83
</td>
<td style="text-align:left;">
CDW
</td>
<td style="text-align:right;">
0.9886519
</td>
<td style="text-align:right;">
0.0745409
</td>
<td style="text-align:right;">
0.8408280
</td>
<td style="text-align:right;">
1.273320
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
3.143027
</td>
<td style="text-align:right;">
62
</td>
<td style="text-align:right;">
3.227452
</td>
<td style="text-align:right;">
75
</td>
<td style="text-align:right;">
55
</td>
</tr>
<tr>
<td style="text-align:right;">
0.6207952
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
2018-03-19
</td>
<td style="text-align:right;">
72.53889
</td>
<td style="text-align:right;">
-0.0243967
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
75.35
</td>
<td style="text-align:right;">
75.35
</td>
<td style="text-align:right;">
73.45
</td>
<td style="text-align:right;">
73.98
</td>
<td style="text-align:left;">
CDW
</td>
<td style="text-align:right;">
0.9902178
</td>
<td style="text-align:right;">
0.0901013
</td>
<td style="text-align:right;">
0.7192391
</td>
<td style="text-align:right;">
1.275344
</td>
<td style="text-align:right;">
69
</td>
<td style="text-align:right;">
3.153024
</td>
<td style="text-align:right;">
61
</td>
<td style="text-align:right;">
3.227452
</td>
<td style="text-align:right;">
74
</td>
<td style="text-align:right;">
55
</td>
</tr>
</tbody>
</table>
<p>Which consist of the XGBoost predicted probabilities, the actual observed result, the date of the result (of the out-of-sample testing data), the observed share price, the calculated daily returns, (a duplicate of the observed result), the OHLC data we collected from Yahoo and finally the time series features we constructed and then reneamed to <span class="math inline">\(X_{n}\)</span></p>
<p>The <strong>objective</strong> of this strategy was to invest every day in the asset which obtained the highest predicted probability that the market was going to go up. That is, if the model predicts on day <span class="math inline">\(t\)</span> that asset <code>GOOG</code> was going to be higher than it’s previous close with a predicted probability of 0.78 and it also predicts that <code>AMZN</code> would go up with 0.53 probability then we would invest in <code>GOOG</code> today. That is, we only invest in the asset with the highest predicted probability that the market is going to go up.</p>
<p>Therefore, I create a new data frame called <code>top_assets</code> which basically gives me the highest predicted probability across all assets each day.</p>
<pre class="r"><code>top_assets &lt;- plyr::ldply(Resultados) %&gt;% 
  #select(pred_probs, actual, date, open, high, low, close, prc, ret) %&gt;% 
  group_by(date) %&gt;%
  arrange(desc(pred_probs)) %&gt;%
  dplyr::slice(1) %&gt;% 
  ungroup() %&gt;% 
  select(date, everything()) %&gt;% 
  rename(score = pred_probs) %&gt;% 
  select(-actual)</code></pre>
</div>
<div id="strategy-assessment" class="section level2">
<h2>Strategy Assessment</h2>
<p>The first 10 days of the strategy investments look like:</p>
<table class="table table-striped table-hover table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
date
</th>
<th style="text-align:right;">
score
</th>
<th style="text-align:right;">
prc
</th>
<th style="text-align:right;">
ret
</th>
<th style="text-align:right;">
Y
</th>
<th style="text-align:right;">
open
</th>
<th style="text-align:right;">
high
</th>
<th style="text-align:right;">
low
</th>
<th style="text-align:right;">
close
</th>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
X1
</th>
<th style="text-align:right;">
X2
</th>
<th style="text-align:right;">
X3
</th>
<th style="text-align:right;">
X4
</th>
<th style="text-align:right;">
X5
</th>
<th style="text-align:right;">
X6
</th>
<th style="text-align:right;">
X7
</th>
<th style="text-align:right;">
X8
</th>
<th style="text-align:right;">
X9
</th>
<th style="text-align:right;">
X10
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2018-03-15
</td>
<td style="text-align:right;">
0.7304490
</td>
<td style="text-align:right;">
73.17622
</td>
<td style="text-align:right;">
-0.0106061
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
75.36
</td>
<td style="text-align:right;">
75.51
</td>
<td style="text-align:right;">
74.18
</td>
<td style="text-align:right;">
74.63
</td>
<td style="text-align:left;">
CDW
</td>
<td style="text-align:right;">
0.9870653
</td>
<td style="text-align:right;">
0.1149955
</td>
<td style="text-align:right;">
0.7047308
</td>
<td style="text-align:right;">
1.2770644
</td>
<td style="text-align:right;">
71
</td>
<td style="text-align:right;">
3.161538
</td>
<td style="text-align:right;">
63
</td>
<td style="text-align:right;">
3.245055
</td>
<td style="text-align:right;">
76
</td>
<td style="text-align:right;">
56
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-03-16
</td>
<td style="text-align:right;">
0.6899720
</td>
<td style="text-align:right;">
293.04999
</td>
<td style="text-align:right;">
-0.0051601
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
295.13
</td>
<td style="text-align:right;">
297.61
</td>
<td style="text-align:right;">
289.27
</td>
<td style="text-align:right;">
293.05
</td>
<td style="text-align:left;">
ABMD
</td>
<td style="text-align:right;">
0.9918187
</td>
<td style="text-align:right;">
0.0769474
</td>
<td style="text-align:right;">
2.4417643
</td>
<td style="text-align:right;">
1.0584676
</td>
<td style="text-align:right;">
69
</td>
<td style="text-align:right;">
4.917599
</td>
<td style="text-align:right;">
62
</td>
<td style="text-align:right;">
7.861935
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
39
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-03-19
</td>
<td style="text-align:right;">
0.7299674
</td>
<td style="text-align:right;">
101.46883
</td>
<td style="text-align:right;">
-0.0081591
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
108.98
</td>
<td style="text-align:right;">
109.06
</td>
<td style="text-align:right;">
107.40
</td>
<td style="text-align:right;">
108.19
</td>
<td style="text-align:left;">
CCI
</td>
<td style="text-align:right;">
0.9894902
</td>
<td style="text-align:right;">
0.0705445
</td>
<td style="text-align:right;">
0.3788407
</td>
<td style="text-align:right;">
0.9924987
</td>
<td style="text-align:right;">
68
</td>
<td style="text-align:right;">
1.786445
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
1.402126
</td>
<td style="text-align:right;">
89
</td>
<td style="text-align:right;">
46
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-03-20
</td>
<td style="text-align:right;">
0.7370850
</td>
<td style="text-align:right;">
60.44966
</td>
<td style="text-align:right;">
0.0132920
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
65.13
</td>
<td style="text-align:right;">
66.10
</td>
<td style="text-align:right;">
65.13
</td>
<td style="text-align:right;">
65.56
</td>
<td style="text-align:left;">
SLB
</td>
<td style="text-align:right;">
0.9830999
</td>
<td style="text-align:right;">
0.1717591
</td>
<td style="text-align:right;">
0.1725298
</td>
<td style="text-align:right;">
1.1379607
</td>
<td style="text-align:right;">
53
</td>
<td style="text-align:right;">
1.853699
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
1.739650
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
47
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-03-21
</td>
<td style="text-align:right;">
0.7003193
</td>
<td style="text-align:right;">
334.51999
</td>
<td style="text-align:right;">
0.0448199
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
320.94
</td>
<td style="text-align:right;">
339.20
</td>
<td style="text-align:right;">
320.32
</td>
<td style="text-align:right;">
334.52
</td>
<td style="text-align:left;">
CMG
</td>
<td style="text-align:right;">
0.9532525
</td>
<td style="text-align:right;">
0.0669860
</td>
<td style="text-align:right;">
2.4899030
</td>
<td style="text-align:right;">
1.6249110
</td>
<td style="text-align:right;">
67
</td>
<td style="text-align:right;">
4.775679
</td>
<td style="text-align:right;">
73
</td>
<td style="text-align:right;">
12.454513
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
57
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-03-22
</td>
<td style="text-align:right;">
0.7438304
</td>
<td style="text-align:right;">
87.40306
</td>
<td style="text-align:right;">
-0.0243534
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
91.53
</td>
<td style="text-align:right;">
92.43
</td>
<td style="text-align:right;">
90.48
</td>
<td style="text-align:right;">
90.54
</td>
<td style="text-align:left;">
ADI
</td>
<td style="text-align:right;">
0.9796797
</td>
<td style="text-align:right;">
0.0855250
</td>
<td style="text-align:right;">
0.8606480
</td>
<td style="text-align:right;">
1.4206984
</td>
<td style="text-align:right;">
65
</td>
<td style="text-align:right;">
2.718067
</td>
<td style="text-align:right;">
64
</td>
<td style="text-align:right;">
8.589078
</td>
<td style="text-align:right;">
72
</td>
<td style="text-align:right;">
49
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-03-23
</td>
<td style="text-align:right;">
0.6494384
</td>
<td style="text-align:right;">
237.70613
</td>
<td style="text-align:right;">
-0.0290578
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
253.63
</td>
<td style="text-align:right;">
253.99
</td>
<td style="text-align:right;">
244.93
</td>
<td style="text-align:right;">
245.26
</td>
<td style="text-align:left;">
GS
</td>
<td style="text-align:right;">
0.9685330
</td>
<td style="text-align:right;">
0.0615987
</td>
<td style="text-align:right;">
0.7610257
</td>
<td style="text-align:right;">
1.1137175
</td>
<td style="text-align:right;">
63
</td>
<td style="text-align:right;">
3.588928
</td>
<td style="text-align:right;">
58
</td>
<td style="text-align:right;">
4.667287
</td>
<td style="text-align:right;">
71
</td>
<td style="text-align:right;">
50
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-03-26
</td>
<td style="text-align:right;">
0.6868502
</td>
<td style="text-align:right;">
70.18565
</td>
<td style="text-align:right;">
0.0238877
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
70.74
</td>
<td style="text-align:right;">
71.71
</td>
<td style="text-align:right;">
69.71
</td>
<td style="text-align:right;">
71.58
</td>
<td style="text-align:left;">
CDW
</td>
<td style="text-align:right;">
0.9885363
</td>
<td style="text-align:right;">
0.1109430
</td>
<td style="text-align:right;">
0.5278402
</td>
<td style="text-align:right;">
1.1776141
</td>
<td style="text-align:right;">
64
</td>
<td style="text-align:right;">
2.688307
</td>
<td style="text-align:right;">
56
</td>
<td style="text-align:right;">
3.038961
</td>
<td style="text-align:right;">
69
</td>
<td style="text-align:right;">
56
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-03-27
</td>
<td style="text-align:right;">
0.7274348
</td>
<td style="text-align:right;">
57.21453
</td>
<td style="text-align:right;">
-0.0020772
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
58.13
</td>
<td style="text-align:right;">
58.41
</td>
<td style="text-align:right;">
57.16
</td>
<td style="text-align:right;">
57.65
</td>
<td style="text-align:left;">
CERN
</td>
<td style="text-align:right;">
0.9787359
</td>
<td style="text-align:right;">
0.1971365
</td>
<td style="text-align:right;">
0.2600627
</td>
<td style="text-align:right;">
1.0608221
</td>
<td style="text-align:right;">
62
</td>
<td style="text-align:right;">
2.325379
</td>
<td style="text-align:right;">
56
</td>
<td style="text-align:right;">
2.115355
</td>
<td style="text-align:right;">
69
</td>
<td style="text-align:right;">
52
</td>
</tr>
<tr>
<td style="text-align:left;">
2018-03-28
</td>
<td style="text-align:right;">
0.7031060
</td>
<td style="text-align:right;">
68.56778
</td>
<td style="text-align:right;">
-0.0039882
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
70.36
</td>
<td style="text-align:right;">
70.39
</td>
<td style="text-align:right;">
69.26
</td>
<td style="text-align:right;">
69.93
</td>
<td style="text-align:left;">
CDW
</td>
<td style="text-align:right;">
0.9869206
</td>
<td style="text-align:right;">
0.1328377
</td>
<td style="text-align:right;">
0.5033828
</td>
<td style="text-align:right;">
1.1567020
</td>
<td style="text-align:right;">
62
</td>
<td style="text-align:right;">
2.593677
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:right;">
3.010604
</td>
<td style="text-align:right;">
67
</td>
<td style="text-align:right;">
56
</td>
</tr>
</tbody>
</table>
<p>We can see that the column <code>score</code> is the probability for the asset with the highest predicted probability that it’s price was going to be greater than it’s previous close. The <code>ID</code> column gives us the asset ticker we invest in.</p>
<p>Next I want to analyse the strategy of picking the <em>best</em> predicted winners against the S&amp;P500 bench mark and therefore download the S&amp;P 500 index.</p>
<pre class="r"><code>top_assets &lt;- xts(top_assets[,c(2:ncol(top_assets))], order.by = top_assets$date) # put top_assets into xts format

# Analyse strategy
getSymbols(&quot;SPY&quot;, 
           from = start_date, 
           to = end_date, 
           src = &quot;yahoo&quot;) </code></pre>
<pre><code>## [1] &quot;SPY&quot;</code></pre>
<pre class="r"><code>#detach(&quot;package:tsibble&quot;, unload = TRUE) # tsibble clashes with the base R index() function
SPY$ret_Rb &lt;- Delt(SPY$SPY.Adjusted)
SPY &lt;- SPY[index(SPY) &gt;= min(index(top_assets))]

RaRb &lt;- cbind(top_assets, SPY)</code></pre>
<p>From here we can see how the strategy compares with the S&amp;P 500. I show a number of statistics for analysing asset returns from the <code>PerformanceAnalytics</code> package. I have not expanded the model to include short selling or construct multi-asset portfolios of the top <span class="math inline">\(N\)</span> assets.</p>
<p>We can plot the performance of our strategy:</p>
<pre class="r"><code>charts.PerformanceSummary(RaRb[, c(&quot;ret&quot;, &quot;ret_Rb&quot;)], geometric = FALSE, wealth.index = FALSE, 
                          main = &quot;Strategy vs. Market&quot;)</code></pre>
<p><img src="/post/xgboost-time-series-classification-trading-strategy/XGBoost-time-series-quant-trading-strategy_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>Take a look at the drawdown and risk metrics.</p>
<pre><code>##                             ret ret_Rb
## Sterling ratio           0.1870 0.3879
## Calmar ratio             0.2551 0.5884
## Burke ratio              0.2251 0.5344
## Pain index               0.0955 0.0283
## Ulcer index              0.1189 0.0455
## Pain ratio               0.7337 4.0290
## Martin ratio             0.5891 2.5027
## daily downside risk      0.0111 0.0066
## Annualised downside risk 0.1768 0.1044
## Downside potential       0.0054 0.0029
## Omega                    1.0722 1.1601
## Sortino ratio            0.0351 0.0714
## Upside potential         0.0058 0.0034
## Upside potential ratio   0.7027 0.6124
## Omega-sharpe ratio       0.0722 0.1601</code></pre>
<p>Take a closer look at the drawdown information.</p>
<pre><code>## $ret
##         From     Trough         To   Depth Length To Trough Recovery
## 1 2018-08-31 2019-01-03 2019-09-16 -0.2746    261        85      176
## 2 2019-11-06 2019-12-03       &lt;NA&gt; -0.1300     39        19       NA
## 3 2019-10-01 2019-10-18 2019-10-29 -0.0810     21        14        7
## 4 2018-03-22 2018-04-20 2018-05-09 -0.0773     34        21       13
## 5 2018-08-10 2018-08-15 2018-08-20 -0.0474      7         4        3
## 
## $ret_Rb
##         From     Trough         To   Depth Length To Trough Recovery
## 1 2018-09-21 2018-12-24 2019-04-12 -0.1935    140        65       75
## 2 2019-05-06 2019-06-03 2019-06-20 -0.0662     33        20       13
## 3 2018-03-15 2018-04-02 2018-06-04 -0.0610     56        12       44
## 4 2019-07-29 2019-08-05 2019-10-25 -0.0602     64         6       58
## 5 2018-06-13 2018-06-27 2018-07-09 -0.0300     18        11        7</code></pre>
<p>Compare the returns.</p>
<pre class="r"><code>chart.Boxplot(RaRb[,c(&quot;ret&quot;, &quot;ret_Rb&quot;)],  main = &quot;Returns&quot;)</code></pre>
<p><img src="/post/xgboost-time-series-classification-trading-strategy/XGBoost-time-series-quant-trading-strategy_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>Compare return statistics.</p>
<pre class="r"><code>table.Stats(RaRb[, c(&quot;ret&quot;, &quot;ret_Rb&quot;)]) %&gt;% 
  t() %&gt;% 
  kable() %&gt;%
  kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;, &quot;responsive&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Observations
</th>
<th style="text-align:right;">
NAs
</th>
<th style="text-align:right;">
Minimum
</th>
<th style="text-align:right;">
Quartile 1
</th>
<th style="text-align:right;">
Median
</th>
<th style="text-align:right;">
Arithmetic Mean
</th>
<th style="text-align:right;">
Geometric Mean
</th>
<th style="text-align:right;">
Quartile 3
</th>
<th style="text-align:right;">
Maximum
</th>
<th style="text-align:right;">
SE Mean
</th>
<th style="text-align:right;">
LCL Mean (0.95)
</th>
<th style="text-align:right;">
UCL Mean (0.95)
</th>
<th style="text-align:right;">
Variance
</th>
<th style="text-align:right;">
Stdev
</th>
<th style="text-align:right;">
Skewness
</th>
<th style="text-align:right;">
Kurtosis
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ret
</td>
<td style="text-align:right;">
453
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-0.0669
</td>
<td style="text-align:right;">
-0.0068
</td>
<td style="text-align:right;">
0.0006
</td>
<td style="text-align:right;">
0.0004
</td>
<td style="text-align:right;">
0.0003
</td>
<td style="text-align:right;">
0.0087
</td>
<td style="text-align:right;">
0.0642
</td>
<td style="text-align:right;">
0.0007
</td>
<td style="text-align:right;">
-0.0011
</td>
<td style="text-align:right;">
0.0018
</td>
<td style="text-align:right;">
0.0002
</td>
<td style="text-align:right;">
0.0156
</td>
<td style="text-align:right;">
-0.2542
</td>
<td style="text-align:right;">
2.8842
</td>
</tr>
<tr>
<td style="text-align:left;">
ret_Rb
</td>
<td style="text-align:right;">
453
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-0.0324
</td>
<td style="text-align:right;">
-0.0030
</td>
<td style="text-align:right;">
0.0006
</td>
<td style="text-align:right;">
0.0005
</td>
<td style="text-align:right;">
0.0004
</td>
<td style="text-align:right;">
0.0054
</td>
<td style="text-align:right;">
0.0505
</td>
<td style="text-align:right;">
0.0004
</td>
<td style="text-align:right;">
-0.0004
</td>
<td style="text-align:right;">
0.0013
</td>
<td style="text-align:right;">
0.0001
</td>
<td style="text-align:right;">
0.0091
</td>
<td style="text-align:right;">
-0.2949
</td>
<td style="text-align:right;">
3.6264
</td>
</tr>
</tbody>
</table>
<p>Compare Sharpe Information.</p>
<pre class="r"><code>lapply(RaRb[, c(&quot;ret&quot;, &quot;ret_Rb&quot;)], function(x){SharpeRatio(x)})</code></pre>
<pre><code>## $ret
##                                       ret
## StdDev Sharpe (Rf=0%, p=95%): 0.025027498
## VaR Sharpe (Rf=0%, p=95%):    0.015346462
## ES Sharpe (Rf=0%, p=95%):     0.009618405
## 
## $ret_Rb
##                                   ret_Rb
## StdDev Sharpe (Rf=0%, p=95%): 0.05152014
## VaR Sharpe (Rf=0%, p=95%):    0.03218952
## ES Sharpe (Rf=0%, p=95%):     0.01913213</code></pre>
<p>Plot the Risk - Return scatter plot.</p>
<pre class="r"><code>chart.RiskReturnScatter(RaRb[, c(&quot;ret&quot;, &quot;ret_Rb&quot;)],  # check this plot a little more
                        Rf=.03/252, scale = 252, # for daily data
                        main = &quot;Risk - Return over the period&quot;)</code></pre>
<p><img src="/post/xgboost-time-series-classification-trading-strategy/XGBoost-time-series-quant-trading-strategy_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<p>Plot the rolling return, risk and Sharpe performance.</p>
<pre class="r"><code>charts.RollingPerformance(RaRb[, c(&quot;ret&quot;, &quot;ret_Rb&quot;)],      
                          Rf=.03/12, 
                          colorset = c(&quot;red&quot;, rep(&quot;darkgray&quot;,5), &quot;orange&quot;, &quot;green&quot;), lwd = 2)</code></pre>
<p><img src="/post/xgboost-time-series-classification-trading-strategy/XGBoost-time-series-quant-trading-strategy_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>Compute the yearly returns.</p>
<pre class="r"><code>lapply(RaRb[, c(&quot;ret&quot;)],function(x){periodReturn(
  x, period = &#39;yearly&#39;, type = &#39;arithmetic&#39;)})        # change type to log for continuous</code></pre>
<pre><code>## $ret
##            yearly.returns
## 2018-12-31      -1.855083
## 2019-12-31      -1.475181</code></pre>
<pre class="r"><code>lapply(RaRb[, c(&quot;ret_Rb&quot;)],function(x){periodReturn(
  x, period = &#39;yearly&#39;, type = &#39;arithmetic&#39;)})</code></pre>
<pre><code>## $ret_Rb
##            yearly.returns
## 2018-12-31     -9.0376638
## 2019-12-31     -0.7226497</code></pre>
</div>
</div>

    </div>

    


    

<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/time-series/">time-series</a>
  
  <a class="badge badge-light" href="/tags/machine-learning/">machine learning</a>
  
  <a class="badge badge-light" href="/tags/financial-markets/">financial markets</a>
  
  <a class="badge badge-light" href="/tags/quant-finance/">quant finance</a>
  
  <a class="badge badge-light" href="/tags/algo-trading/">algo trading</a>
  
  <a class="badge badge-light" href="/tags/quant-analytics/">quant analytics</a>
  
</div>



    
      








  
  
    
  
  






  
  
  
    
  
  
  <div class="media author-card">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hu88685f9f250f5c15d78dab2d9552b11c_15179_250x250_fill_q90_lanczos_center.jpg" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title"><a href="/">Matthew Smith</a></h5>
      <h6 class="card-subtitle">Researcher in Dept Finance</h6>
      <p class="card-text">I am a researcher with a focus on Machine Learning methods applied to economics and finance.</p>
      <ul class="network-icon" aria-hidden="true">
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a href="/#contact" >
              <i class="fas fa-envelope"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a href="https://twitter.com/MatthewSmith786" target="_blank" rel="noopener">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a href="https://scholar.google.co.uk/" target="_blank" rel="noopener">
              <i class="ai ai-google-scholar"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a href="https://github.com/msmith01" target="_blank" rel="noopener">
              <i class="fab fa-github"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>



      
      
      <div class="article-widget">
        <div class="hr-light"></div>
        <h3>Related</h3>
        <ul>
          
          <li><a href="/post/understanding-ttr-package/technical-trading-rules/">Quantitative Trading Strategies using quantmod</a></li>
          
          <li><a href="/post/factor-modeling-for-portfolio-optimisation/factor-modeling-portfolio-optimisation/">Factor Modeling in R</a></li>
          
          <li><a href="/post/portfolio-optimisation-model/portfolio-optimisation-r/">Quantitative Analytics: Optimal Portfolio Allocation</a></li>
          
          <li><a href="/post/hackerrank-competitions/hackerrank-compeitions/">Series of Hackerrank Competitions</a></li>
          
          <li><a href="/post/kalman-smoothing/kalman-smoothing-time-series-imputation/">Kalman Smoothing for Time Series Missing Value Imputation</a></li>
          
        </ul>
      </div>
      
    

    

    
<section id="comments">
  
    
<div id="disqus_thread"></div>
<script>
  let disqus_config = function () {
    
    
    
  };
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
      return;
    }
    var d = document, s = d.createElement('script'); s.async = true;
    s.src = 'https://' + "lf0-com" + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  
</section>



  </div>
</article>

      

    
    
    
    <script src="/js/mathjax-config.js"></script>
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/r.min.js"></script>
        
      

      
      
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML-full" integrity="sha256-GhM+5JHb6QUzOQPXSJLEWP7R73CbkisjzK5Eyij4U9w=" crossorigin="anonymous" async></script>
      
    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin="anonymous"></script>
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    <script id="dsq-count-scr" src="https://lf0-com.disqus.com/count.js" async></script>
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.130521ecfc6f534c52c158217bbff718.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
        
  </p>
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
